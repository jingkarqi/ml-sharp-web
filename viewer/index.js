let t=class{constructor(t,e,s){this.owner=t,this.name=e,this.fn=s}unbind(){this.owner&&(this.owner.unbind(this.name,this.fn),this.owner=null,this.name=null,this.fn=null)}call(t,...e){this.fn&&this.fn.call(this.owner,arguments[0],arguments[1],arguments[2],arguments[3],arguments[4],arguments[5],arguments[6],arguments[7])}on(t,e){return this.owner.on(t,e)}};class e{constructor(){this._suspendEvents=!1,this._additionalEmitters=[],this._events={},Object.defineProperty(this,"_events",{enumerable:!1,configurable:!1,writable:!0,value:{}})}set suspendEvents(t){this._suspendEvents=!!t}get suspendEvents(){return this._suspendEvents}on(e,s){const n=this._events[e];return void 0===n?this._events[e]=[s]:-1===n.indexOf(s)&&n.push(s),new t(this,e,s)}once(t,e){const s=this.on(t,(t,n,i,r,a,o,l,h)=>{e.call(this,t,n,i,r,a,o,l,h),s.unbind()});return s}emit(t,e,s,n,i,r,a,o,l){if(this._suspendEvents)return this;let h=this._events[t];if(h&&h.length){h=h.slice(0);for(let c=0;c<h.length;c++)if(h[c])try{h[c].call(this,e,s,n,i,r,a,o,l)}catch(e){console.info("%c%s %c(event error)","color: #06f",t,"color: #f00"),console.log(e.stack)}}if(this._additionalEmitters.length){this._additionalEmitters.slice().forEach(h=>{h.emit(t,e,s,n,i,r,a,o,l)})}return this}unbind(t,e){if(t){const s=this._events[t];if(!s)return this;if(e){const n=s.indexOf(e);-1!==n&&(1===s.length?delete this._events[t]:s.splice(n,1))}else delete this._events[t]}else this._events={};return this}addEmitter(t){this._additionalEmitters.includes(t)||this._additionalEmitters.push(t)}removeEmitter(t){const e=this._additionalEmitters.indexOf(t);-1!==e&&this._additionalEmitters.splice(e,1)}}const s=(t,e)=>{if(!t||!e)return!1;const n=t.length;if(n!==e.length)return!1;for(let i=0;i<n;i++)if(t[i]instanceof Array&&e[i]instanceof Array){if(!s(t[i],e[i]))return!1}else if(t[i]!==e[i])return!1;return!0};class n extends e{constructor(t,e={}){if(super(),this._destroyed=!1,this._path="",this._keys=[],this._data={},this._pathsWithDuplicates=null,this._parent=null,this._parentPath="",this._parentField=null,this._parentKey=null,this._latestFn=null,this._silent=!1,this._pathsWithDuplicates=null,e.pathsWithDuplicates){this._pathsWithDuplicates={};for(let t=0;t<e.pathsWithDuplicates.length;t++)this._pathsWithDuplicates[e.pathsWithDuplicates[t]]=!0}this.patch(t),this._parent=e.parent||null,this._parentPath=e.parentPath||"",this._parentField=e.parentField||null,this._parentKey=e.parentKey||null,this._latestFn=e.latestFn||null,this._silent=!1;const s=function(t){return function(e,s,n,i){if(!this._parent)return;let r,a=this._parentKey;!a&&this._parentField instanceof Array&&(a=this._parentField.indexOf(this),-1===a)||(e=`${this._parentPath}.${a}.${e}`,this._silent&&(r=this._parent.silence()),this._parent.emit(`${e}:${t}`,s,n,i),this._parent.emit(`*:${t}`,e,s,n,i),this._silent&&this._parent.silenceRestore(r))}};this.on("*:set",s("set")),this.on("*:unset",s("unset")),this.on("*:insert",s("insert")),this.on("*:remove",s("remove")),this.on("*:move",s("move"))}static _splitPath(t){const e=n._splitPathsCache;let s=e[t];return s?s=s.slice():(s=t.split("."),e[t]=s),s}silence(){this._silent=!0;const t=this.history&&this.history.enabled;t&&(this.history.enabled=!1);const e=this.sync&&this.sync.enabled;return e&&(this.sync.enabled=!1),[t,e]}silenceRestore(t){this._silent=!1,t[0]&&(this.history.enabled=!0),t[1]&&(this.sync.enabled=!0)}_prepare(t,e,s,i=!1,r=!1){let a,o;const l=(t._path?`${t._path}.`:"")+e,h=typeof s;if(t._keys.push(e),"object"===h&&s instanceof Array){for(t._data[e]=s.slice(0),a=0;a<t._data[e].length;a++)"object"==typeof t._data[e][a]&&null!==t._data[e][a]?t._data[e][a]instanceof Array?t._data[e][a].slice(0):t._data[e][a]=new n(t._data[e][a],{parent:this,parentPath:l,parentField:t._data[e],parentKey:null}):(o=this.silence(),this.emit(`${l}.${a}:set`,t._data[e][a],null,r),this.emit("*:set",`${l}.${a}`,t._data[e][a],null,r),this.silenceRestore(o));i&&(o=this.silence()),this.emit(`${l}:set`,t._data[e],null,r),this.emit("*:set",l,t._data[e],null,r),i&&this.silenceRestore(o)}else if("object"===h&&s instanceof Object){for(a in"object"!=typeof t._data[e]&&(t._data[e]={_path:l,_keys:[],_data:{}}),s)"object"==typeof s[a]?this._prepare(t._data[e],a,s[a],!0,r):(o=this.silence(),t._data[e]._data[a]=s[a],t._data[e]._keys.push(a),this.emit(`${l}.${a}:set`,s[a],null,r),this.emit("*:set",`${l}.${a}`,s[a],null,r),this.silenceRestore(o));i&&(o=this.silence()),this.emit(`${l}:set`,s,void 0,r),this.emit("*:set",l,s,void 0,r),i&&this.silenceRestore(o)}else i&&(o=this.silence()),t._data[e]=s,this.emit(`${l}:set`,s,void 0,r),this.emit("*:set",l,s,void 0,r),i&&this.silenceRestore(o);return!0}set(t,e,i=!1,r=!1,a=!1){let o,l,h=n._splitPath(t);const c=h.length,d=h[c-1];let u,f,p=this,m="",g=this;for(o=0;o<c-1;o++)p instanceof Array?(p=p[h[o]],p instanceof n&&(t=h.slice(o+1).join("."),g=p)):(o<c&&"object"!=typeof p._data[h[o]]&&(p._data[h[o]]&&g.unset((p._path?`${p._path}.`:"")+h[o]),p._data[h[o]]={_path:t,_keys:[],_data:{}},p._keys.push(h[o])),o===c-1&&p._path&&(m=`${p._path}.${h[o]}`),p=p._data[h[o]]);if(p instanceof Array){const s=parseInt(d,10);return!(p[s]===e&&!a)&&(l=p[s],l=l instanceof n?l.json():g.json(l),p[s]=e,e instanceof n&&(e._parent=g,e._parentPath=m,e._parentField=p,e._parentKey=null),i&&(u=g.silence()),g.emit(`${t}:set`,e,l,r),g.emit("*:set",t,e,l,r),i&&g.silenceRestore(u),!0)}if(p._data&&!p._data.hasOwnProperty(d))return"object"==typeof e?g._prepare(p,d,e,!1,r):(p._data[d]=e,p._keys.push(d),i&&(u=g.silence()),g.emit(`${t}:set`,e,null,r),g.emit("*:set",t,e,null,r),i&&g.silenceRestore(u),!0);if("object"==typeof e&&e instanceof Array){if(s(e,p._data[d])&&!a)return!1;if(l=p._data[d],l instanceof n||(l=g.json(l)),p._data[d]&&p._data[d].length===e.length){for(u=g.silence(),0===e.length&&(p._data[d]=e),o=0;o<p._data[d].length;o++)p._data[d][o]instanceof n?p._data[d][o].patch(e[o],!0):p._data[d][o]!==e[o]&&(p._data[d][o]=e[o],g.emit(`${t}.${o}:set`,p._data[d][o],l&&l[o]||null,r),g.emit("*:set",`${t}.${o}`,p._data[d][o],l&&l[o]||null,r));g.silenceRestore(u)}else{for(p._data[d]=[],e.forEach(t=>{this._doInsert(p,d,t,void 0,!0)}),u=g.silence(),o=0;o<p._data[d].length;o++)g.emit(`${t}.${o}:set`,p._data[d][o],l&&l[o]||null,r),g.emit("*:set",`${t}.${o}`,p._data[d][o],l&&l[o]||null,r);g.silenceRestore(u)}return i&&(u=g.silence()),g.emit(`${t}:set`,e,l,r),g.emit("*:set",t,e,l,r),i&&g.silenceRestore(u),!0}if("object"==typeof e&&e instanceof Object){let s,a=!1;l=p._data[d],l instanceof n||(l=g.json(l)),h=Object.keys(e),p._data[d]&&p._data[d]._data||(p._data[d]?g.unset((p._path?`${p._path}.`:"")+d):a=!0,p._data[d]={_path:t,_keys:[],_data:{}});for(const n in p._data[d]._data)e.hasOwnProperty(n)?p._data[d]._data.hasOwnProperty(n)?g._equals(p._data[d]._data[n],e[n])||(s=g.set(`${t}.${n}`,e[n],!0),s&&(a=!0)):(s=g._prepare(p._data[d],n,e[n],!0,r),s&&(a=!0)):(s=g.unset(`${t}.${n}`,!0),s&&(a=!0));for(o=0;o<h.length;o++)void 0===e[h[o]]&&p._data[d]._data.hasOwnProperty(h[o])?(s=g.unset(`${t}.${h[o]}`,!0),s&&(a=!0)):"object"==typeof e[h[o]]?p._data[d]._data.hasOwnProperty(h[o])?(s=g.set(`${t}.${h[o]}`,e[h[o]],!0),s&&(a=!0)):(s=g._prepare(p._data[d],h[o],e[h[o]],!0,r),s&&(a=!0)):g._equals(p._data[d]._data[h[o]],e[h[o]])||("object"==typeof e[h[o]]?(s=g.set(`${p._data[d]._path}.${h[o]}`,e[h[o]],!0),s&&(a=!0)):p._data[d]._data[h[o]]!==e[h[o]]&&(a=!0,-1===p._data[d]._keys.indexOf(h[o])&&p._data[d]._keys.push(h[o]),p._data[d]._data[h[o]]=e[h[o]],u=g.silence(),g.emit(`${p._data[d]._path}.${h[o]}:set`,p._data[d]._data[h[o]],null,r),g.emit("*:set",`${p._data[d]._path}.${h[o]}`,p._data[d]._data[h[o]],null,r),g.silenceRestore(u)));if(a){i&&(u=g.silence());const t=g.json(p._data[d]);return g.emit(`${p._data[d]._path}:set`,t,l,r),g.emit("*:set",p._data[d]._path,t,l,r),i&&g.silenceRestore(u),!0}return!1}return f=!p.hasOwnProperty("_data")&&p.hasOwnProperty(d)?p:p._data,!(f[d]===e&&!a)&&(i&&(u=g.silence()),l=f[d],l instanceof n||(l=g.json(l)),f[d]=e,g.emit(`${t}:set`,e,l,r),g.emit("*:set",t,e,l,r),i&&g.silenceRestore(u),!0)}has(t){const e=n._splitPath(t);let s=this;for(let t=0,n=e.length;t<n;t++){if(null==s)return;s=s._data?s._data[e[t]]:s[e[t]]}return void 0!==s}get(t,e=!1){const s=n._splitPath(t);let i=this;for(let t=0;t<s.length;t++){if(null==i)return;i=i._data?i._data[s[t]]:i[s[t]]}return e?i:null==i?null:this.json(i)}getRaw(t){return this.get(t,!0)}_equals(t,e){return t===e||!!(t instanceof Array&&e instanceof Array&&s(t,e))}unset(t,e=!1,s=!1){let i;const r=n._splitPath(t),a=r[r.length-1];let o=this,l=this;for(i=0;i<r.length-1;i++)o instanceof Array?(o=o[r[i]],o instanceof n&&(t=r.slice(i+1).join("."),l=o)):o=o._data[r[i]];if(!o._data||!o._data.hasOwnProperty(a))return!1;let h,c=o._data[a];if(c instanceof n||(c=l.json(c)),o._data[a]&&o._data[a]._data)for(i=o._data[a]._keys.length-1;i>=0;i--)l.unset(`${t}.${o._data[a]._keys[i]}`,!0);return o._keys.splice(o._keys.indexOf(a),1),delete o._data[a],e&&(h=l.silence()),l.emit(`${t}:unset`,c,s),l.emit("*:unset",t,c,s),e&&l.silenceRestore(h),!0}remove(t,e,s=!1,i=!1){const r=n._splitPath(t),a=r[r.length-1];let o=this,l=this;for(let e=0;e<r.length-1;e++)if(o instanceof Array)o=o[parseInt(r[e],10)],o instanceof n&&(t=r.slice(e+1).join("."),l=o);else{if(!o._data||!o._data.hasOwnProperty(r[e]))return!1;o=o._data[r[e]]}if(!(o._data&&o._data.hasOwnProperty(a)&&o._data[a]instanceof Array))return!1;const h=o._data[a];if(h.length<e)return!1;let c,d=h[e];return d instanceof n?d._parent=null:d=l.json(d),h.splice(e,1),s&&(c=l.silence()),l.emit(`${t}:remove`,d,e,i),l.emit("*:remove",t,d,e,i),s&&l.silenceRestore(c),!0}removeValue(t,e,s=!1,i=!1){const r=n._splitPath(t),a=r[r.length-1];let o=this,l=this;for(let e=0;e<r.length-1;e++)if(o instanceof Array)o=o[parseInt(r[e],10)],o instanceof n&&(t=r.slice(e+1).join("."),l=o);else{if(!o._data||!o._data.hasOwnProperty(r[e]))return;o=o._data[r[e]]}if(!(o._data&&o._data.hasOwnProperty(a)&&o._data[a]instanceof Array))return;const h=o._data[a],c=h.indexOf(e);if(-1===c)return;if(h.length<c)return;let d;return(e=h[c])instanceof n?e._parent=null:e=l.json(e),h.splice(c,1),s&&(d=l.silence()),l.emit(`${t}:remove`,e,c,i),l.emit("*:remove",t,e,c,i),s&&l.silenceRestore(d),!0}insert(t,e,s,i=!1,r=!1){const a=n._splitPath(t),o=a[a.length-1];let l=this,h=this;for(let e=0;e<a.length-1;e++)if(l instanceof Array)l=l[parseInt(a[e],10)],l instanceof n&&(t=a.slice(e+1).join("."),h=l);else{if(!l._data||!l._data.hasOwnProperty(a[e]))return;l=l._data[a[e]]}if(!(l._data&&l._data.hasOwnProperty(o)&&l._data[o]instanceof Array))return;const c=l._data[o];let d;return e=h._doInsert(l,o,e,s),void 0===s&&(s=c.length-1),i&&(d=h.silence()),h.emit(`${t}:insert`,e,s,r),h.emit("*:insert",t,e,s,r),i&&h.silenceRestore(d),!0}_doInsert(t,e,s,i,r=!1){const a=t._data[e];"object"!=typeof s||s instanceof n||null===s||(s=s instanceof Array?s.slice(0):new n(s));const o=t._path?`${t._path}.${e}`:e;if(null===s||r||this._pathsWithDuplicates&&this._pathsWithDuplicates[o]||-1===a.indexOf(s))return void 0===i?a.push(s):a.splice(i,0,s),s instanceof n?(s._parent=this,s._parentPath=o,s._parentField=a,s._parentKey=null):s=this.json(s),s}move(t,e,s,i=!1,r=!1){const a=n._splitPath(t),o=a[a.length-1];let l=this,h=this;for(let e=0;e<a.length-1;e++)if(l instanceof Array)l=l[parseInt(a[e],10)],l instanceof n&&(t=a.slice(e+1).join("."),h=l);else{if(!l._data||!l._data.hasOwnProperty(a[e]))return;l=l._data[a[e]]}if(!(l._data&&l._data.hasOwnProperty(o)&&l._data[o]instanceof Array))return;const c=l._data[o];if(c.length<e||c.length<s||e===s)return;let d,u=c[e];return c.splice(e,1),-1===s&&(s=c.length),c.splice(s,0,u),u instanceof n||(u=h.json(u)),i&&(d=h.silence()),h.emit(`${t}:move`,u,s,e,r),h.emit("*:move",t,u,s,e,r),i&&h.silenceRestore(d),!0}patch(t,e=!1){if("object"==typeof t){for(const e in t)"object"!=typeof t[e]||this._data.hasOwnProperty(e)?this._data[e]!==t[e]&&this.set(e,t[e]):this._prepare(this,e,t[e]);if(e)for(const e in this._data)t.hasOwnProperty(e)||this.unset(e)}}json(t){let e,s,n={};const i=void 0===t?this:t;let r,a;if(i instanceof Object&&i._keys){r=i._keys.length;for(let t=0;t<r;t++){e=i._keys[t];const r=i._data[e],o=typeof r;if("object"===o&&r instanceof Array)for(n[e]=r.slice(0),a=n[e].length,s=0;s<a;s++)"object"==typeof n[e][s]&&(n[e][s]=this.json(n[e][s]));else n[e]="object"===o&&r instanceof Object?this.json(r):r}}else{if(null===i)return null;if("object"==typeof i&&i instanceof Array)for(n=i.slice(0),r=n.length,s=0;s<r;s++)n[s]=this.json(n[s]);else if("object"==typeof i)for(e in i)i.hasOwnProperty(e)&&(n[e]=i[e]);else n=i}return n}forEach(t,e,s=""){const n=e||this;for(let e=0;e<n._keys.length;e++){const i=n._keys[e],r=n._data[i],a=this.schema&&this.schema.has(s+i)&&this.schema.get(s+i).type.name.toLowerCase()||typeof r;"object"===a&&r instanceof Array?t(s+i,"array",r,i):"object"===a&&r instanceof Object?(t(s+i,"object",r,i),this.forEach(t,r,`${s+i}.`)):t(s+i,a,r,i)}}latest(){return this._latestFn?this._latestFn():this}destroy(){this._destroyed||(this._destroyed=!0,this.emit("destroy"),this.unbind())}set latestFn(t){this._latestFn=t}get latestFn(){return this._latestFn}}function i(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}n._splitPathsCache={};var r,a,o={exports:{}},l={};function h(){if(r)return l;r=1;var t=Symbol.for("react.transitional.element"),e=Symbol.for("react.portal"),s=Symbol.for("react.fragment"),n=Symbol.for("react.strict_mode"),i=Symbol.for("react.profiler"),a=Symbol.for("react.consumer"),o=Symbol.for("react.context"),h=Symbol.for("react.forward_ref"),c=Symbol.for("react.suspense"),d=Symbol.for("react.memo"),u=Symbol.for("react.lazy"),f=Symbol.for("react.activity"),p=Symbol.iterator;var m={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},g=Object.assign,_={};function v(t,e,s){this.props=t,this.context=e,this.refs=_,this.updater=s||m}function y(){}function b(t,e,s){this.props=t,this.context=e,this.refs=_,this.updater=s||m}v.prototype.isReactComponent={},v.prototype.setState=function(t,e){if("object"!=typeof t&&"function"!=typeof t&&null!=t)throw Error("takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,t,e,"setState")},v.prototype.forceUpdate=function(t){this.updater.enqueueForceUpdate(this,t,"forceUpdate")},y.prototype=v.prototype;var S=b.prototype=new y;S.constructor=b,g(S,v.prototype),S.isPureReactComponent=!0;var x=Array.isArray;function w(){}var T={H:null,A:null,T:null,S:null},C=Object.prototype.hasOwnProperty;function E(e,s,n){var i=n.ref;return{$$typeof:t,type:e,key:s,ref:void 0!==i?i:null,props:n}}function A(e){return"object"==typeof e&&null!==e&&e.$$typeof===t}var D=/\/+/g;function P(t,e){return"object"==typeof t&&null!==t&&null!=t.key?(s=""+t.key,n={"=":"=0",":":"=2"},"$"+s.replace(/[=:]/g,function(t){return n[t]})):e.toString(36);var s,n}function L(s,n,i,r,a){var o=typeof s;"undefined"!==o&&"boolean"!==o||(s=null);var l,h,c=!1;if(null===s)c=!0;else switch(o){case"bigint":case"string":case"number":c=!0;break;case"object":switch(s.$$typeof){case t:case e:c=!0;break;case u:return L((c=s._init)(s._payload),n,i,r,a)}}if(c)return a=a(s),c=""===r?"."+P(s,0):r,x(a)?(i="",null!=c&&(i=c.replace(D,"$&/")+"/"),L(a,n,i,"",function(t){return t})):null!=a&&(A(a)&&(l=a,h=i+(null==a.key||s&&s.key===a.key?"":(""+a.key).replace(D,"$&/")+"/")+c,a=E(l.type,h,l.props)),n.push(a)),1;c=0;var d,f=""===r?".":r+":";if(x(s))for(var m=0;m<s.length;m++)c+=L(r=s[m],n,i,o=f+P(r,m),a);else if("function"==typeof(m=null===(d=s)||"object"!=typeof d?null:"function"==typeof(d=p&&d[p]||d["@@iterator"])?d:null))for(s=m.call(s),m=0;!(r=s.next()).done;)c+=L(r=r.value,n,i,o=f+P(r,m++),a);else if("object"===o){if("function"==typeof s.then)return L(function(t){switch(t.status){case"fulfilled":return t.value;case"rejected":throw t.reason;default:switch("string"==typeof t.status?t.then(w,w):(t.status="pending",t.then(function(e){"pending"===t.status&&(t.status="fulfilled",t.value=e)},function(e){"pending"===t.status&&(t.status="rejected",t.reason=e)})),t.status){case"fulfilled":return t.value;case"rejected":throw t.reason}}throw t}(s),n,i,r,a);throw n=String(s),Error("Objects are not valid as a React child (found: "+("[object Object]"===n?"object with keys {"+Object.keys(s).join(", ")+"}":n)+"). If you meant to render a collection of children, use an array instead.")}return c}function I(t,e,s){if(null==t)return t;var n=[],i=0;return L(t,n,"","",function(t){return e.call(s,t,i++)}),n}function R(t){if(-1===t._status){var e=t._result;(e=e()).then(function(e){0!==t._status&&-1!==t._status||(t._status=1,t._result=e)},function(e){0!==t._status&&-1!==t._status||(t._status=2,t._result=e)}),-1===t._status&&(t._status=0,t._result=e)}if(1===t._status)return t._result.default;throw t._result}var M="function"==typeof reportError?reportError:function(t){if("object"==typeof window&&"function"==typeof window.ErrorEvent){var e=new window.ErrorEvent("error",{bubbles:!0,cancelable:!0,message:"object"==typeof t&&null!==t&&"string"==typeof t.message?String(t.message):String(t),error:t});if(!window.dispatchEvent(e))return}else if("object"==typeof process&&"function"==typeof process.emit)return void process.emit("uncaughtException",t);console.error(t)},k={map:I,forEach:function(t,e,s){I(t,function(){e.apply(this,arguments)},s)},count:function(t){var e=0;return I(t,function(){e++}),e},toArray:function(t){return I(t,function(t){return t})||[]},only:function(t){if(!A(t))throw Error("React.Children.only expected to receive a single React element child.");return t}};return l.Activity=f,l.Children=k,l.Component=v,l.Fragment=s,l.Profiler=i,l.PureComponent=b,l.StrictMode=n,l.Suspense=c,l.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE=T,l.__COMPILER_RUNTIME={__proto__:null,c:function(t){return T.H.useMemoCache(t)}},l.cache=function(t){return function(){return t.apply(null,arguments)}},l.cacheSignal=function(){return null},l.cloneElement=function(t,e,s){if(null==t)throw Error("The argument must be a React element, but you passed "+t+".");var n=g({},t.props),i=t.key;if(null!=e)for(r in void 0!==e.key&&(i=""+e.key),e)!C.call(e,r)||"key"===r||"__self"===r||"__source"===r||"ref"===r&&void 0===e.ref||(n[r]=e[r]);var r=arguments.length-2;if(1===r)n.children=s;else if(1<r){for(var a=Array(r),o=0;o<r;o++)a[o]=arguments[o+2];n.children=a}return E(t.type,i,n)},l.createContext=function(t){return(t={$$typeof:o,_currentValue:t,_currentValue2:t,_threadCount:0,Provider:null,Consumer:null}).Provider=t,t.Consumer={$$typeof:a,_context:t},t},l.createElement=function(t,e,s){var n,i={},r=null;if(null!=e)for(n in void 0!==e.key&&(r=""+e.key),e)C.call(e,n)&&"key"!==n&&"__self"!==n&&"__source"!==n&&(i[n]=e[n]);var a=arguments.length-2;if(1===a)i.children=s;else if(1<a){for(var o=Array(a),l=0;l<a;l++)o[l]=arguments[l+2];i.children=o}if(t&&t.defaultProps)for(n in a=t.defaultProps)void 0===i[n]&&(i[n]=a[n]);return E(t,r,i)},l.createRef=function(){return{current:null}},l.forwardRef=function(t){return{$$typeof:h,render:t}},l.isValidElement=A,l.lazy=function(t){return{$$typeof:u,_payload:{_status:-1,_result:t},_init:R}},l.memo=function(t,e){return{$$typeof:d,type:t,compare:void 0===e?null:e}},l.startTransition=function(t){var e=T.T,s={};T.T=s;try{var n=t(),i=T.S;null!==i&&i(s,n),"object"==typeof n&&null!==n&&"function"==typeof n.then&&n.then(w,M)}catch(t){M(t)}finally{null!==e&&null!==s.types&&(e.types=s.types),T.T=e}},l.unstable_useCacheRefresh=function(){return T.H.useCacheRefresh()},l.use=function(t){return T.H.use(t)},l.useActionState=function(t,e,s){return T.H.useActionState(t,e,s)},l.useCallback=function(t,e){return T.H.useCallback(t,e)},l.useContext=function(t){return T.H.useContext(t)},l.useDebugValue=function(){},l.useDeferredValue=function(t,e){return T.H.useDeferredValue(t,e)},l.useEffect=function(t,e){return T.H.useEffect(t,e)},l.useEffectEvent=function(t){return T.H.useEffectEvent(t)},l.useId=function(){return T.H.useId()},l.useImperativeHandle=function(t,e,s){return T.H.useImperativeHandle(t,e,s)},l.useInsertionEffect=function(t,e){return T.H.useInsertionEffect(t,e)},l.useLayoutEffect=function(t,e){return T.H.useLayoutEffect(t,e)},l.useMemo=function(t,e){return T.H.useMemo(t,e)},l.useOptimistic=function(t,e){return T.H.useOptimistic(t,e)},l.useReducer=function(t,e,s){return T.H.useReducer(t,e,s)},l.useRef=function(t){return T.H.useRef(t)},l.useState=function(t){return T.H.useState(t)},l.useSyncExternalStore=function(t,e,s){return T.H.useSyncExternalStore(t,e,s)},l.useTransition=function(){return T.H.useTransition()},l.version="19.2.3",l}function c(){return a||(a=1,o.exports=h()),o.exports}var d=c(),u=i(d);let f=class extends d.Component{constructor(t){super(t),this.attachElement=(t,e)=>{if(!t)return;this.element=new this.elementClass({...this.props,dom:t,content:e,parent:void 0});const s=this.props.class;this.class=new Set(s?Array.isArray(s)?s.slice():[s]:void 0),this.onClick&&this.element.on("click",this.onClick),this.onRemove&&this.element.on("click:remove",this.onRemove),this.onChange&&this.element.on("change",this.onChange),this.props.parent&&(this.element.parent=this.props.parent),this.onAttach&&this.onAttach()},this.getPropertyDescriptor=(t,e)=>{let s;do{s=Object.getOwnPropertyDescriptor(t,e)}while(!s&&(t=Object.getPrototypeOf(t)));return s},this.elementClass=this.constructor.ctor,t.onClick&&(this.onClick=t.onClick),t.onRemove&&(this.onRemove=t.onRemove),t.onChange&&(this.onChange=t.onChange),t.link&&(this.link=t.link)}componentDidMount(){this.link&&this.element.link(this.link.observer,this.link.path)}componentDidUpdate(t){Object.keys(this.props).forEach(t=>{const e=this.getPropertyDescriptor(this.element,t);if(e&&e.set)"value"===t?(this.element._suppressChange=!0,this.element[t]=this.props[t],this.element._suppressChange=!1):this.element[t]=this.props[t];else if("class"===t){const e=this.props[t],s=new Set(e?Array.isArray(e)?e.slice():[e]:void 0);s.forEach(t=>{this.class.has(t)||(this.element.class.add(t),this.class.add(t))}),this.class.forEach(t=>{s.has(t)||(this.element.class.remove(t),this.class.delete(t))})}}),t.link!==this.props.link&&this.props.link&&this.element.link(this.props.link.observer,this.props.link.path)}render(){return d.createElement("div",{ref:this.attachElement})}};const p="pcui-collapsed",m="pcui-collapsible",g="pcui-disabled",_="pcui-error",v="flash",y="pcui-flex",b="pcui-focus",S="font-regular",x="font-bold",w="pcui-grid",T="pcui-hidden",C="pcui-multiple-values",E="pcui-not-flexible",A="pcui-readonly",D="pcui-resizable",P="pcui-scrollable",L=["flexDirection","flexGrow","flexBasis","flexShrink","flexWrap","alignItems","alignSelf","justifyContent","justifySelf"];let I=class t extends e{constructor(t={}){if(super(),this._destroyed=!1,this._parent=null,this._eventsParent=[],this._flashTimeout=null,this._suppressChange=!1,this._onMouseOver=t=>{this.emit("hover",t)},this._onMouseOut=t=>{this.emit("hoverend",t)},"string"==typeof t.dom?this._dom=document.createElement(t.dom):t.dom instanceof Node?this._dom=t.dom:this._dom=document.createElement("div"),void 0!==t.id&&(this._dom.id=t.id),this._dom.ui=this,this._onClickEvt=this._onClick.bind(this),this._dom.addEventListener("click",this._onClickEvt),this._dom.addEventListener("mouseover",this._onMouseOver),this._dom.addEventListener("mouseout",this._onMouseOut),this._dom.classList.add("pcui-element",S),t.class){const e=Array.isArray(t.class)?t.class:[t.class];for(const t of e)this._dom.classList.add(t)}this.enabled=t.enabled??!0,this._hiddenParents=!t.isRoot,this.hidden=t.hidden??!1,this.readOnly=t.readOnly??!1,this.ignoreParent=t.ignoreParent??!1,void 0!==t.width&&(this.width=t.width),void 0!==t.height&&(this.height=t.height),void 0!==t.tabIndex&&(this.tabIndex=t.tabIndex);for(const e in t)void 0!==t[e]&&-1!==L.indexOf(e)&&(this[e]=t[e]);t.binding&&(this.binding=t.binding)}destroy(){if(this._destroyed)return;if(this._destroyed=!0,this.binding?this.binding=null:this.unlink(),this.parent){const t=this.parent;for(const t of this._eventsParent)t.unbind();this._eventsParent.length=0,t.remove&&!t._destroyed&&t.remove(this),this._parent=null,!t._destroyed&&this._dom&&this._dom.parentElement&&this._dom.parentElement.removeChild(this._dom)}const t=this._dom;t&&(t.removeEventListener("click",this._onClickEvt),t.removeEventListener("mouseover",this._onMouseOver),t.removeEventListener("mouseout",this._onMouseOut),delete t.ui,this._dom=null),this._flashTimeout&&window.clearTimeout(this._flashTimeout),this.emit("destroy",t,this),this.unbind()}link(t,e){this._binding&&this._binding.link(t,e)}unlink(){this._binding&&this._binding.unlink()}flash(){this._flashTimeout||(this.class.add(v),this._flashTimeout=window.setTimeout(()=>{this._flashTimeout=null,this.class.remove(v)},200))}_onClick(t){this.enabled&&this.emit("click",t)}_onHiddenToRootChange(t){this.emit(t?"hideToRoot":"showToRoot")}_onEnabledChange(t){t?this.class.remove(g):this.class.add(g),this.emit(t?"enable":"disable")}_onParentDestroy(){this.destroy()}_onParentDisable(){this._ignoreParent||this._enabled&&this._onEnabledChange(!1)}_onParentEnable(){this._ignoreParent||this._enabled&&this._onEnabledChange(!0)}_onParentShowToRoot(){const t=this.hiddenToRoot;this._hiddenParents=!1,t!==this.hiddenToRoot&&this._onHiddenToRootChange(this.hiddenToRoot)}_onParentHideToRoot(){const t=this.hiddenToRoot;this._hiddenParents=!0,t!==this.hiddenToRoot&&this._onHiddenToRootChange(this.hiddenToRoot)}_onReadOnlyChange(t){t?this.class.add(A):this.class.remove(A),this.emit("readOnly",t)}_onParentReadOnlyChange(t){this._ignoreParent||(t?this._readOnly||this._onReadOnlyChange(!0):this._readOnly||this._onReadOnlyChange(!1))}static register(e,s,n){t.registry.set(e,{cls:s,defaultArguments:n})}static unregister(e){t.registry.delete(e)}static create(e,s){const n=t.registry.get(e);if(!n)return void console.error("Invalid type passed to Element.create:",e);return new(0,n.cls)({...n.defaultArguments,...s})}set enabled(t){if(this._enabled===t)return;const e=this.enabled;this._enabled=t,e!==t&&this._onEnabledChange(t)}get enabled(){return this._ignoreParent?this._enabled:this._enabled&&(!this._parent||this._parent.enabled)}set ignoreParent(t){this._ignoreParent=t,this._onEnabledChange(this.enabled),this._onReadOnlyChange(this.readOnly)}get ignoreParent(){return this._ignoreParent}get dom(){return this._dom}set parent(t){if(t===this._parent)return;const e=this.enabled,s=this.readOnly,n=this.hiddenToRoot;if(this._parent){for(let t=0;t<this._eventsParent.length;t++)this._eventsParent[t].unbind();this._eventsParent.length=0}this._parent=t,this._parent?(this._eventsParent.push(this._parent.once("destroy",this._onParentDestroy.bind(this))),this._eventsParent.push(this._parent.on("disable",this._onParentDisable.bind(this))),this._eventsParent.push(this._parent.on("enable",this._onParentEnable.bind(this))),this._eventsParent.push(this._parent.on("readOnly",this._onParentReadOnlyChange.bind(this))),this._eventsParent.push(this._parent.on("showToRoot",this._onParentShowToRoot.bind(this))),this._eventsParent.push(this._parent.on("hideToRoot",this._onParentHideToRoot.bind(this))),this._hiddenParents=this._parent.hiddenToRoot):this._hiddenParents=!0,this.emit("parent",this._parent);const i=this.enabled;i!==e&&this._onEnabledChange(i);const r=this.readOnly;r!==s&&this._onReadOnlyChange(r);const a=this.hiddenToRoot;a!==n&&this._onHiddenToRootChange(a)}get parent(){return this._parent}set hidden(t){if(t===this._hidden)return;const e=this.hiddenToRoot;this._hidden=t,t?this.class.add(T):this.class.remove(T),this.emit(t?"hide":"show"),this.hiddenToRoot!==e&&this._onHiddenToRootChange(this.hiddenToRoot)}get hidden(){return this._hidden}get hiddenToRoot(){return this._hidden||this._hiddenParents}set readOnly(t){this._readOnly!==t&&(this._readOnly=t,this._onReadOnlyChange(t))}get readOnly(){return this._ignoreParent?this._readOnly:this._readOnly||!(!this._parent||!this._parent.readOnly)}set error(t){this._hasError!==t&&(this._hasError=t,t?this.class.add(_):this.class.remove(_))}get error(){return this._hasError}get style(){return this._dom.style}get class(){return this._dom.classList}set width(t){this.style.width="number"==typeof t?`${t}px`:t}get width(){return this._dom.clientWidth}set height(t){this.style.height="number"==typeof t?`${t}px`:t}get height(){return this._dom.clientHeight}set tabIndex(t){this._dom.tabIndex=t}get tabIndex(){return this._dom.tabIndex}set binding(t){if(this._binding===t)return;let e,s;this._binding&&(e=this._binding.observers,s=this._binding.paths,this.unlink(),this._binding.element=null,this._binding=null),this._binding=t,this._binding&&(this._binding.element=this,e&&s&&this.link(e,s))}get binding(){return this._binding}get destroyed(){return this._destroyed}set flexDirection(t){this.style.flexDirection=t}get flexDirection(){return this.style.flexDirection}set flexGrow(t){this.style.flexGrow=t}get flexGrow(){return this.style.flexGrow}set flexBasis(t){this.style.flexBasis=t}get flexBasis(){return this.style.flexBasis}set flexShrink(t){this.style.flexShrink=t}get flexShrink(){return this.style.flexShrink}set flexWrap(t){this.style.flexWrap=t}get flexWrap(){return this.style.flexWrap}set alignItems(t){this.style.alignItems=t}get alignItems(){return this.style.alignItems}set alignSelf(t){this.style.alignSelf=t}get alignSelf(){return this.style.alignSelf}set justifyContent(t){this.style.justifyContent=t}get justifyContent(){return this.style.justifyContent}set justifySelf(t){this.style.justifySelf=t}get justifySelf(){return this.style.justifySelf}set disabled(t){this.enabled=!t}get disabled(){return!this.enabled}set element(t){this._dom=t}get element(){return this.dom}set innerElement(t){this._domContent=t}get innerElement(){return this._domContent}};I.EVENT_ENABLE="enable",I.EVENT_DISABLE="disable",I.EVENT_HIDE="hide",I.EVENT_HIDE_TO_ROOT="hideToRoot",I.EVENT_SHOW="show",I.EVENT_SHOW_TO_ROOT="showToRoot",I.EVENT_READ_ONLY="readOnly",I.EVENT_PARENT="parent",I.EVENT_CLICK="click",I.EVENT_HOVER="hover",I.EVENT_HOVER_END="hoverend",I.EVENT_DESTROY="destroy",I.registry=new Map;let R=class extends I{constructor(t={}){super({dom:"button",...t}),this._onKeyDown=t=>{"Escape"===t.key?this.blur():"Enter"===t.key&&this._onClick(t)},this.class.add("pcui-button"),this._unsafe=t.unsafe,this.text=t.text,this.size=t.size,this.icon=t.icon,this.dom.addEventListener("keydown",this._onKeyDown)}destroy(){this._destroyed||(this.dom.removeEventListener("keydown",this._onKeyDown),super.destroy())}_onClick(t){this.blur(),this.readOnly||super._onClick(t)}focus(){this.dom.focus()}blur(){this.dom.blur()}set text(t){this._text!==t&&(this._text=t,this._unsafe?this.dom.innerHTML=t:this.dom.textContent=t)}get text(){return this._text}set icon(t){this._icon!==t&&t.match(/^E\d{0,4}$/)&&(this._icon=t,t?this.dom.setAttribute("data-icon",String.fromCodePoint(parseInt(t,16))):this.dom.removeAttribute("data-icon"))}get icon(){return this._icon}set size(t){this._size!==t&&(this._size&&(this.class.remove(`pcui-${this._size}`),this._size=null),this._size=t,this._size&&this.class.add(`pcui-${this._size}`))}get size(){return this._size}};I.register("button",R);const M=[null,"top","right","bottom","left"],k=`${D}-resizing`,O="pcui-container",F=`${O}-dragged`,N=`${F}-child`;let B=class extends I{constructor(t={}){super(t),this._scrollable=!1,this._flex=!1,this._grid=!1,this._domResizeHandle=null,this._resizePointerId=null,this._resizeData=null,this._resizeHorizontally=!0,this._resizeMin=100,this._resizeMax=300,this._draggedStartIndex=-1,this._onScroll=t=>{this.emit("scroll",t)},this._onResizeStart=t=>{null===this._resizePointerId&&(t.preventDefault(),t.stopPropagation(),this._domResizeHandle.setPointerCapture(t.pointerId),this._resizePointerId=t.pointerId,this._resizeStart())},this._onResizeMove=t=>{this._resizePointerId===t.pointerId&&(t.preventDefault(),t.stopPropagation(),this._resizeMove(t.clientX,t.clientY))},this._onResizeEnd=t=>{this._resizePointerId===t.pointerId&&(t.preventDefault(),t.stopPropagation(),this._resizeEnd(),this._domResizeHandle.releasePointerCapture(t.pointerId),this._resizePointerId=null)},this.class.add(O),this.domContent=this._dom,t.scrollable&&(this.scrollable=!0),this.flex=!!t.flex;let e=!!t.grid;e&&this.flex&&(console.error('Invalid Container arguments: "grid" and "flex" cannot both be true.'),e=!1),this.grid=e,this.resizable=t.resizable??null,void 0!==t.resizeMin&&(this.resizeMin=t.resizeMin),void 0!==t.resizeMax&&(this.resizeMax=t.resizeMax)}destroy(){this._destroyed||(this.domContent=null,this._domResizeHandle&&(this._domResizeHandle.removeEventListener("pointerdown",this._onResizeStart),this._domResizeHandle.removeEventListener("pointermove",this._onResizeMove),this._domResizeHandle.removeEventListener("pointerup",this._onResizeEnd)),super.destroy())}append(t){const e=this._getDomFromElement(t);this._domContent.appendChild(e),this._onAppendChild(t)}appendBefore(t,e){const s=this._getDomFromElement(t);this._domContent.appendChild(s);const n=e&&this._getDomFromElement(e);this._domContent.insertBefore(s,n),this._onAppendChild(t)}appendAfter(t,e){const s=this._getDomFromElement(t),n=e&&this._getDomFromElement(e),i=n?n.nextSibling:null;i?this._domContent.insertBefore(s,i):this._domContent.appendChild(s),this._onAppendChild(t)}prepend(t){const e=this._getDomFromElement(t),s=this._domContent.firstChild;s?this._domContent.insertBefore(e,s):this._domContent.appendChild(e),this._onAppendChild(t)}remove(t){if(t.parent!==this)return;const e=this._getDomFromElement(t);this._domContent.removeChild(e),this._onRemoveChild(t)}move(t,e){const s=Array.prototype.indexOf.call(this.dom.childNodes,t.dom);-1===s?this.appendBefore(t,this.dom.childNodes[e]):e!==s&&(this.remove(t),e<s?this.appendBefore(t,this.dom.childNodes[e]):this.appendAfter(t,this.dom.childNodes[e-1]))}clear(){let t=this._domContent.childNodes.length;for(;t--;){const e=this._domContent.childNodes[t];e.ui&&e.ui!==this&&e.ui.destroy()}this._domResizeHandle&&(this._domResizeHandle.removeEventListener("pointerdown",this._onResizeStart),this._domResizeHandle.removeEventListener("pointermove",this._onResizeMove),this._domResizeHandle.removeEventListener("pointerup",this._onResizeEnd),this._domResizeHandle=null),this._domContent.innerHTML="",this.resizable&&(this._createResizeHandle(),this._dom.appendChild(this._domResizeHandle))}_getDomFromElement(t){return t.dom?t.dom:t.element?t.element:t}_onAppendChild(t){t.parent=this,this.emit("append",t)}_onRemoveChild(t){t.parent=null,this.emit("remove",t)}_createResizeHandle(){const t=document.createElement("div");t.classList.add("pcui-resizable-handle"),t.ui=this,t.addEventListener("pointerdown",this._onResizeStart),t.addEventListener("pointermove",this._onResizeMove),t.addEventListener("pointerup",this._onResizeEnd),this._domResizeHandle=t}_resizeStart(){this.class.add(k)}_resizeMove(t,e){if(this._resizeData){if(this._resizeHorizontally){let e=this._resizeData.x-t;"right"===this._resizable&&(e=-e),this.width=4+Math.max(this._resizeMin,Math.min(this._resizeMax,this._resizeData.width+e))}else{let t=this._resizeData.y-e;"bottom"===this._resizable&&(t=-t),this.height=Math.max(this._resizeMin,Math.min(this._resizeMax,this._resizeData.height+t))}this.emit("resize")}else this._resizeData={x:t,y:e,width:this.dom.clientWidth,height:this.dom.clientHeight}}_resizeEnd(){this._resizeData=null,this.class.remove(k)}resize(t=0,e=0){this._resizeStart(),this._resizeMove(0,0),this._resizeMove(4-t,-e),this._resizeEnd()}_getDraggedChildIndex(t){for(let e=0;e<this.dom.childNodes.length;e++)if(this.dom.childNodes[e].ui===t)return e;return-1}_onChildDragStart(t,e){this.class.add(N),this._draggedStartIndex=this._getDraggedChildIndex(e),e.class.add(F),this.emit("child:dragstart",e,this._draggedStartIndex)}_onChildDragMove(t,e){const s=this.dom.getBoundingClientRect(),n=t.clientX<s.left||t.clientX>s.right||t.clientY<s.top||t.clientY>s.bottom,i=this._getDraggedChildIndex(e);if(n)return e.class.remove(F),void(this._draggedStartIndex!==i&&(this.remove(e),this._draggedStartIndex<i?this.appendBefore(e,this.dom.childNodes[this._draggedStartIndex]):this.appendAfter(e,this.dom.childNodes[this._draggedStartIndex-1])));e.class.add(F);const r=t.clientY-s.top;let a=null;for(let t=0;t<this.dom.childNodes.length;t++){const s=this.dom.childNodes[t].ui,n=s.dom.offsetTop;if(t<i){if(r<=n+s.header.height){a=t;break}}else if(t>i&&r+e.height>=n+s.height){a=t;break}}null!==a&&i!==a&&(this.remove(e),a<i?this.appendBefore(e,this.dom.childNodes[a]):this.appendAfter(e,this.dom.childNodes[a-1]))}_onChildDragEnd(t,e){this.class.remove(N),e.class.remove(F);const s=this._getDraggedChildIndex(e);this.emit("child:dragend",e,s,this._draggedStartIndex),this._draggedStartIndex=-1}forEachChild(t){for(let e=0;e<this.dom.childNodes.length;e++){const s=this.dom.childNodes[e].ui;if(s){if(!1===t(s,e))break}}}_buildDomNode(t){const e=Object.keys(t);let s;return e.includes("root")?(s=this._buildDomNode(t.root),t.children.forEach(t=>{const e=this._buildDomNode(t);null!==e&&s.append(e)})):(s=t[e[0]],this[`_${e[0]}`]=s),s}buildDom(t){t.forEach(t=>{const e=this._buildDomNode(t);this.append(e)})}set flex(t){t!==this._flex&&(this._flex=t,t?this.class.add(y):this.class.remove(y))}get flex(){return this._flex}set grid(t){t!==this._grid&&(this._grid=t,t?this.class.add(w):this.class.remove(w))}get grid(){return this._grid}set scrollable(t){this._scrollable!==t&&(this._scrollable=t,t?this.class.add(P):this.class.remove(P))}get scrollable(){return this._scrollable}set resizable(t){t!==this._resizable&&(-1!==M.indexOf(t)?(this._resizable&&this.class.remove(`${D}-${this._resizable}`),this._resizable=t,this._resizeHorizontally="right"===t||"left"===t,t?(this.class.add(D),this.class.add(`${D}-${t}`),this._domResizeHandle||this._createResizeHandle(),this._dom.appendChild(this._domResizeHandle)):(this.class.remove(D),this._domResizeHandle&&this._dom.removeChild(this._domResizeHandle))):console.error(`Invalid resizable value: must be one of ${M.join(",")}`))}get resizable(){return this._resizable}set resizeMin(t){this._resizeMin=Math.max(0,Math.min(t,this._resizeMax))}get resizeMin(){return this._resizeMin}set resizeMax(t){this._resizeMax=Math.max(this._resizeMin,t)}get resizeMax(){return this._resizeMax}set domContent(t){this._domContent!==t&&(this._domContent&&this._domContent.removeEventListener("scroll",this._onScroll),this._domContent=t,this._domContent&&this._domContent.addEventListener("scroll",this._onScroll))}get domContent(){return this._domContent}};B.EVENT_APPEND="append",B.EVENT_REMOVE="remove",B.EVENT_SCROLL="scroll",B.EVENT_RESIZE="resize",I.register("container",B);class z extends I{constructor(t={}){super(t),this.blurOnEnter=!0,this.blurOnEscape=!0,this._onInputFocus=t=>{this.class.add(b),this.emit("focus",t),this._prevValue=this._domInput.value},this._onInputBlur=t=>{this.class.remove(b),this.emit("blur",t)},this._onInputKeyUp=t=>{"Escape"!==t.key&&this._onInputChange(t),this.emit("keyup",t)},this._onInputCtxMenu=t=>{this._domInput.select()},this._updateInputReadOnly=()=>{!this.enabled||this.readOnly?this._domInput.setAttribute("readonly","true"):this._domInput.removeAttribute("readonly")},this.class.add("pcui-input-element");let e=t.input;e||(e=document.createElement("input"),e.type="text"),e.ui=this,e.tabIndex=0,e.autocomplete="off",this._onInputKeyDownEvt=this._onInputKeyDown.bind(this),this._onInputChangeEvt=this._onInputChange.bind(this),e.addEventListener("change",this._onInputChangeEvt),e.addEventListener("keydown",this._onInputKeyDownEvt),e.addEventListener("focus",this._onInputFocus),e.addEventListener("blur",this._onInputBlur),e.addEventListener("contextmenu",this._onInputCtxMenu,!1),this.dom.appendChild(e),this._domInput=e,this._suspendInputChangeEvt=!1,void 0!==t.value&&(this._domInput.value=t.value),this.placeholder=t.placeholder??"",this.renderChanges=t.renderChanges??!1,this.blurOnEnter=t.blurOnEnter??!0,this.blurOnEscape=t.blurOnEscape??!0,this.keyChange=t.keyChange??!1,this._prevValue=null,this.on("change",()=>{this.renderChanges&&this.flash()}),this.on("disable",this._updateInputReadOnly),this.on("enable",this._updateInputReadOnly),this.on("readOnly",this._updateInputReadOnly),this._updateInputReadOnly()}destroy(){if(this._destroyed)return;const t=this._domInput;t.removeEventListener("change",this._onInputChangeEvt),t.removeEventListener("keydown",this._onInputKeyDownEvt),t.removeEventListener("focus",this._onInputFocus),t.removeEventListener("blur",this._onInputBlur),t.removeEventListener("keyup",this._onInputKeyUp),t.removeEventListener("contextmenu",this._onInputCtxMenu),super.destroy()}_onInputKeyDown(t){if("Enter"===t.key&&this.blurOnEnter)this._suspendInputChangeEvt=this.keyChange,this._domInput.blur(),this._suspendInputChangeEvt=!1;else if("Escape"===t.key){this._suspendInputChangeEvt=!0;const e=this._domInput.value;this._domInput.value=this._prevValue,this._suspendInputChangeEvt=!1,this.keyChange&&e!==this._prevValue&&this._onInputChange(t),this.blurOnEscape&&this._domInput.blur()}this.emit("keydown",t)}_onInputChange(t){}focus(t){this._domInput.focus(),t&&this._domInput.select()}blur(){this._domInput.blur()}set placeholder(t){t?this.dom.setAttribute("placeholder",t):this.dom.removeAttribute("placeholder")}get placeholder(){return this.dom.getAttribute("placeholder")??""}set keyChange(t){this._keyChange!==t&&(this._keyChange=t,t?this._domInput.addEventListener("keyup",this._onInputKeyUp):this._domInput.removeEventListener("keyup",this._onInputKeyUp))}get keyChange(){return this._keyChange}get input(){return this._domInput}set renderChanges(t){this._renderChanges=t}get renderChanges(){return this._renderChanges}}const U="pcui-numeric-input",V=`${U}-slider-control`,H=`${V}-active`,G=`${V}-hidden`,W=/,/g;let j=class extends z{constructor(t={}){const e={...t};delete e.value,delete e.renderChanges,super(e),this._sliderUsed=!1,this._onSliderMouseWheel=t=>{this._updatePosition(t.deltaY,t.shiftKey)},this._onSliderMouseMove=t=>{this._updatePosition(t.movementX,t.shiftKey)},this._onSliderMouseDown=t=>{this._sliderControl.dom.requestPointerLock(),this._sliderMovement=0,this._sliderPrevValue=this.value,this._sliderUsed=!0,this.binding&&(this._historyCombine=this.binding.historyCombine,this._historyPostfix=this.binding.historyPostfix,this.binding.historyCombine=!0,this.binding.historyPostfix=`(${Date.now()})`),this.emit("slider:mousedown",t)},this._onSliderMouseUp=()=>{document.exitPointerLock(),this._sliderUsed&&(this._sliderUsed=!1,this.value=this._sliderPrevValue+this._sliderMovement,this.binding&&(this.binding.historyCombine=this._historyCombine,this.binding.historyPostfix=this._historyPostfix,this._historyCombine=!1,this._historyPostfix=null),this.focus(),this.emit("slider:mouseup"))},this._onPointerLockChange=()=>{this._isScrolling()?(this._sliderControl.dom.addEventListener("mousemove",this._onSliderMouseMove,!1),this._sliderControl.dom.addEventListener("wheel",this._onSliderMouseWheel,{passive:!0}),this._sliderControl.class.add(H)):(this._sliderControl.dom.removeEventListener("mousemove",this._onSliderMouseMove,!1),this._sliderControl.dom.removeEventListener("wheel",this._onSliderMouseWheel),this._sliderControl.class.remove(H))},this.class.add(U),this._min=t.min??null,this._max=t.max??null,this._allowNull=t.allowNull??!1,this._precision=t.precision??7,Number.isFinite(t.step)?this._step=t.step:t.precision?this._step=10/Math.pow(10,t.precision):this._step=1,Number.isFinite(t.stepPrecision)?this._stepPrecision=t.stepPrecision:this._stepPrecision=.1*this._step,this._oldValue=void 0,Number.isFinite(t.value)?this.value=t.value:this._allowNull||(this.value=0),this._historyCombine=!1,this._historyPostfix=null,this._sliderPrevValue=0,this.renderChanges=t.renderChanges??!1,t.hideSlider||(this._sliderControl=new I,this._sliderControl.class.add(V),this.dom.append(this._sliderControl.dom),this._sliderControl.dom.addEventListener("mousedown",this._onSliderMouseDown),this._sliderControl.dom.addEventListener("mouseup",this._onSliderMouseUp),document.addEventListener("pointerlockchange",this._onPointerLockChange,!1))}destroy(){this.destroyed||(this._sliderControl&&(this._sliderControl.dom.removeEventListener("mousedown",this._onSliderMouseDown),this._sliderControl.dom.removeEventListener("mouseup",this._onSliderMouseUp),this._sliderControl.dom.removeEventListener("mousemove",this._onSliderMouseMove,!1),this._sliderControl.dom.removeEventListener("wheel",this._onSliderMouseWheel),document.removeEventListener("pointerlockchange",this._onPointerLockChange,!1)),super.destroy())}_updatePosition(t,e){this._sliderMovement+=t/100*(e?this._stepPrecision:this._step),this.value=this._sliderPrevValue+this._sliderMovement}_onInputChange(t){this.value=this._normalizeValue(this._domInput.value)}_onInputKeyDown(t){if(this.enabled&&!this.readOnly){if("ArrowUp"===t.key||"ArrowDown"===t.key){const e="ArrowDown"===t.key?-1:1;this.value+=(t.shiftKey?this._stepPrecision:this._step)*e}super._onInputKeyDown(t)}}_getPointerLockElementByShadowRoot(t){const e=t.shadowRoot;if(e){const t=e.pointerLockElement;return this._getPointerLockElementByShadowRoot(t)}return t===this._sliderControl.dom}_isScrolling(){return!!this._sliderControl&&(document.pointerLockElement&&document.pointerLockElement.shadowRoot?this._getPointerLockElementByShadowRoot(document.pointerLockElement):document.pointerLockElement===this._sliderControl.dom)}_normalizeValue(t){try{if("string"==typeof t){if("0"===t)return 0;if(null!==(t=(t=(t=t.replace(W,".")).replace(/\s/g,"")).match(/^[*/+\-0-9().]+$/))&&t[0].length<20){let e=t[0];["+","-","/","*"].forEach(t=>{const s=e.split(t);s.forEach((t,e)=>{s[e]=s[e].replace(/^0+/,"")}),e=s.join(t)}),t=Function(`"use strict";return (${e})`)()}}if(null==t||""===t){if(this._allowNull)return null;t=0}if(t=Number(t),isNaN(t)){if(this._allowNull)return null;t=0}return null!==this.min&&t<this.min&&(t=this.min),null!==this.max&&t>this.max&&(t=this.max),null!==this.precision&&(t=parseFloat(Number(t).toFixed(this.precision))),t}catch(t){return this._allowNull?null:0}}_updateValue(t,e){const s=t!==this._oldValue||e;return this._oldValue=t,this._domInput.value=null===t?"":String(t),this.class.remove(C),s&&this.emit("change",t),s}set value(t){t=this._normalizeValue(t);const e=this.class.contains(C)&&null===t&&this._allowNull;this._updateValue(t,e)&&this.binding&&this.binding.setValue(t),this._sliderControl&&this._sliderControl.class.remove(G)}get value(){const t=this._domInput.value;return""!==t?parseFloat(t):null}set values(t){const e=t.map(t=>this._normalizeValue(t)),s=e.some(t=>t!==e[0]);s?(this._updateValue(null),this.class.add(C),this._sliderControl&&this._sliderControl.class.add(G)):(this._updateValue(e[0]),this._sliderControl&&this._sliderControl.class.remove(G))}set min(t){this._min!==t&&(this._min=t,null!==this._min&&(this.value=this.value))}get min(){return this._min}set max(t){this._max!==t&&(this._max=t,null!==this._max&&(this.value=this.value))}get max(){return this._max}set precision(t){this._precision!==t&&(this._precision=t,null!==this._precision&&(this.value=this.value))}get precision(){return this._precision}set step(t){this._step=t}get step(){return this._step}};I.register("number",j,{renderChanges:!0});let $=class extends I{constructor(t={}){super({dom:"span",...t}),this.class.add("pcui-label"),this._unsafe=t.unsafe??!1,this.text=t.text??t.value??"",t.allowTextSelection&&this.class.add("pcui-default-mousedown"),t.nativeTooltip&&(this.dom.title=this.text),this.placeholder=t.placeholder,this.renderChanges=t.renderChanges??!1,this.on("change",()=>{this.renderChanges&&this.flash()})}_updateText(t){return this.class.remove(C),this._text!==t&&(this._text=t,this._unsafe?this._dom.innerHTML=t:this._dom.textContent=t,this.emit("change",t),!0)}set text(t){null==t&&(t="");this._updateText(t)&&this._binding&&this._binding.setValue(t)}get text(){return this._text}set value(t){this.text=t}get value(){return this.text}set values(t){const e=t.some(e=>e!==t[0]);e?(this._updateText(""),this.class.add(C)):this._updateText(t[0])}set placeholder(t){t?this.dom.setAttribute("placeholder",t):this.dom.removeAttribute("placeholder")}get placeholder(){return this.dom.getAttribute("placeholder")}set renderChanges(t){this._renderChanges=t}get renderChanges(){return this._renderChanges}};I.register("label",$);const X="pcui-panel",q=`${X}-header`,K=`${q}-title`,Y=`${X}-content`,Q=`${X}-horizontal`,Z=`${X}-sortable-icon`,J=`${X}-remove`;let tt=class extends B{constructor(t={}){const e={...t,flex:!0};delete e.grid,delete e.flexDirection,delete e.scrollable,super(e),this._reflowTimeout=null,this._widthBeforeCollapse=null,this._heightBeforeCollapse=null,this._iconSort=null,this._btnRemove=null,this._onHeaderClick=t=>{this._collapsible&&(t.target!==this.header.dom&&t.target!==this._labelTitle.dom||(this.collapsed=!this.collapsed))},this._onDragStart=t=>{this.enabled&&!this.readOnly&&(t.stopPropagation(),t.preventDefault(),window.addEventListener("mouseup",this._onDragEndEvt),window.addEventListener("mouseleave",this._onDragEndEvt),window.addEventListener("mousemove",this._onDragMove),this.emit("dragstart"),this.parent&&this.parent._onChildDragStart&&this.parent._onChildDragStart(t,this))},this._onDragMove=t=>{this.emit("dragmove"),this.parent&&this.parent._onChildDragStart&&this.parent._onChildDragMove(t,this)},this.class.add(X),t.panelType&&this.class.add(`${X}-${t.panelType}`),this._suspendReflow=!0,this._initializeHeader(t),this._initializeContent(t),this.headerSize=t.headerSize??32,this.collapsible=t.collapsible??!1,this.collapsed=t.collapsed??!1,this.collapseHorizontally=t.collapseHorizontally??!1,this.sortable=t.sortable??!1,this.removable=t.removable||!!t.onRemove||!1,this.domContent=this._containerContent.dom,this._suspendReflow=!1,this._reflow(),this._onDragEndEvt=this._onDragEnd.bind(this)}destroy(){this._destroyed||(this._reflowTimeout&&(cancelAnimationFrame(this._reflowTimeout),this._reflowTimeout=null),window.removeEventListener("mouseup",this._onDragEndEvt),window.removeEventListener("mouseleave",this._onDragEndEvt),window.removeEventListener("mousemove",this._onDragMove),super.destroy())}_initializeHeader(t){this._containerHeader=new B({flex:!0,flexDirection:"row",class:[q,x]}),this._labelTitle=new $({text:t.headerText,class:[K,x]}),this._containerHeader.append(this._labelTitle),this._containerHeader.dom.addEventListener("click",this._onHeaderClick),this.append(this._containerHeader)}_onClickRemove(t){t.preventDefault(),t.stopPropagation(),this.emit("click:remove")}_initializeContent(t){this._containerContent=new B({class:Y,grid:t.grid,flex:t.flex,flexDirection:t.flexDirection,scrollable:t.scrollable,dom:t.content}),this.append(this._containerContent)}_reflow(){this._suspendReflow||(this._reflowTimeout&&(cancelAnimationFrame(this._reflowTimeout),this._reflowTimeout=null),!this.hidden&&this.collapsible&&(this.collapsed&&this.collapseHorizontally?this._containerHeader.style.top=-this.headerSize+"px":this._containerHeader.style.top="",this._reflowTimeout=requestAnimationFrame(()=>{this._reflowTimeout=null,this.collapsed?(this._widthBeforeCollapse||(this._widthBeforeCollapse=this.style.width),this._heightBeforeCollapse||(this._heightBeforeCollapse=this.style.height),this._collapseHorizontally?(this.height="",this.width=this.headerSize):this.height=this.headerSize,this.class.add(p)):(this.class.remove(p),this._collapseHorizontally?(this.height="",null!==this._widthBeforeCollapse&&(this.width=this._widthBeforeCollapse)):null!==this._heightBeforeCollapse&&(this.height=this._heightBeforeCollapse),this._widthBeforeCollapse=null,this._heightBeforeCollapse=null)})))}_onDragEnd(t){window.removeEventListener("mouseup",this._onDragEndEvt),window.removeEventListener("mouseleave",this._onDragEndEvt),window.removeEventListener("mousemove",this._onDragMove),this._draggedChild===this&&(this._draggedChild=null),this.emit("dragend"),this.parent&&this.parent._onChildDragStart&&this.parent._onChildDragEnd(t,this)}set collapsible(t){t!==this._collapsible&&(this._collapsible=t,t?this.class.add(m):this.class.remove(m),this._reflow(),this.collapsed&&this.emit(t?"collapse":"expand"))}get collapsible(){return this._collapsible}set collapsed(t){this._collapsed!==t&&(this._collapsed=t,this._reflow(),this.collapsible&&this.emit(t?"collapse":"expand"))}get collapsed(){return this._collapsed}set sortable(t){this._sortable!==t&&(this._sortable=t,t?(this._iconSort=new $({class:Z}),this._iconSort.dom.addEventListener("mousedown",this._onDragStart),this.header.prepend(this._iconSort)):this._iconSort&&(this._iconSort.destroy(),this._iconSort=null))}get sortable(){return this._sortable}set removable(t){this.removable!==t&&(t?(this._btnRemove=new R({icon:"E289",class:J}),this._btnRemove.on("click",this._onClickRemove.bind(this)),this.header.append(this._btnRemove)):(this._btnRemove.destroy(),this._btnRemove=null))}get removable(){return!!this._btnRemove}set collapseHorizontally(t){this._collapseHorizontally!==t&&(this._collapseHorizontally=t,t?this.class.add(Q):this.class.remove(Q),this._reflow())}get collapseHorizontally(){return this._collapseHorizontally}get content(){return this._containerContent}get header(){return this._containerHeader}set headerText(t){this._labelTitle.text=t}get headerText(){return this._labelTitle.text}set headerSize(t){this._headerSize=t;const e=this._containerHeader.dom.style;e.height=`${Math.max(0,t)}px`,e.lineHeight=e.height,this._reflow()}get headerSize(){return this._headerSize}};tt.EVENT_COLLAPSE="collapse",tt.EVENT_EXPAND="expand",I.register("panel",tt);const et="pcui-boolean-input",st=`${et}-ticked`,nt=`${et}-toggle`;let it=class extends I{constructor(t={}){super({tabIndex:0,...t}),this._onKeyDown=t=>{"Escape"!==t.key?this.enabled&&!this.readOnly&&" "===t.key&&(t.stopPropagation(),t.preventDefault(),this.value=!this.value):this.blur()},this._onFocus=()=>{this.emit("focus")},this._onBlur=()=>{this.emit("blur")},"toggle"===t.type?this.class.add(nt):this.class.add(et),this.class.add(E),this.dom.addEventListener("keydown",this._onKeyDown),this.dom.addEventListener("focus",this._onFocus),this.dom.addEventListener("blur",this._onBlur),this._value=null,void 0!==t.value&&(this.value=t.value),this.renderChanges=t.renderChanges??!1}destroy(){this._destroyed||(this.dom.removeEventListener("keydown",this._onKeyDown),this.dom.removeEventListener("focus",this._onFocus),this.dom.removeEventListener("blur",this._onBlur),super.destroy())}_onClick(t){return this.enabled&&this.focus(),this.enabled&&!this.readOnly&&(this.value=!this.value),super._onClick(t)}_updateValue(t){return this.class.remove(C),t!==this.value&&(this._value=t,t?this.class.add(st):this.class.remove(st),this.renderChanges&&this.flash(),this.emit("change",t),!0)}focus(){this.dom.focus()}blur(){this.dom.blur()}set value(t){this._updateValue(t)&&this._binding&&this._binding.setValue(t)}get value(){return this._value}set values(t){const e=t.some(e=>e!==t[0]);e?(this._updateValue(null),this.class.add(C)):this._updateValue(t[0])}set renderChanges(t){this._renderChanges=t}get renderChanges(){return this._renderChanges}};I.register("boolean",it,{renderChanges:!0});class rt extends f{}rt.ctor=it;class at extends f{render(){return d.createElement("button",{ref:this.attachElement})}}function ot(t){const e=t[0]/255,s=t[1]/255,n=t[2]/255;let i,r;const a=Math.max(e,s,n),o=a-Math.min(e,s,n),l=t=>(a-t)/6/o+.5;if(0===o)return i=r=0,[i,r,a];r=o/a;const h=l(e),c=l(s),d=l(n);return e===a?i=d-c:s===a?i=1/3+h-d:n===a&&(i=2/3+c-h),i<0?i+=1:i>1&&(i-=1),[i,r,a]}function lt(t){const e=t[0],s=t[1],n=t[2];let i,r,a;const o=Math.floor(6*e),l=6*e-o,h=n*(1-s),c=n*(1-l*s),d=n*(1-(1-l)*s);switch(o%6){case 0:i=n,r=d,a=h;break;case 1:i=c,r=n,a=h;break;case 2:i=h,r=n,a=d;break;case 3:i=h,r=c,a=n;break;case 4:i=d,r=h,a=n;break;case 5:i=n,r=h,a=c}return[Math.round(255*i),Math.round(255*r),Math.round(255*a)]}at.ctor=R;const ht="pcui-overlay",ct=`${ht}-inner`,dt=`${ht}-clickable`,ut=`${ht}-transparent`,ft=`${ht}-content`;class pt extends B{constructor(t={}){super(t),this._onPointerDown=t=>{this.clickable&&!this.domContent.contains(t.target)&&(document.body.blur(),requestAnimationFrame(()=>{this.hidden=!0}),t.preventDefault(),t.stopPropagation())},this.class.add(ht),this._domClickableOverlay=document.createElement("div"),this._domClickableOverlay.ui=this,this._domClickableOverlay.classList.add(ct),this.dom.appendChild(this._domClickableOverlay),this.on("show",()=>{document.body.addEventListener("pointerdown",this._onPointerDown,!0)}),this.on("hide",()=>{document.body.removeEventListener("pointerdown",this._onPointerDown,!0)}),this.domContent=document.createElement("div"),this.domContent.ui=this,this.domContent.classList.add(ft),this.dom.appendChild(this.domContent),this.clickable=t.clickable??!1,this.transparent=t.transparent??!1}destroy(){this._destroyed||super.destroy()}position(t,e){const s=this._domClickableOverlay.getBoundingClientRect(),n=this.domContent.getBoundingClientRect();t=Math.max(0,Math.min(s.width-n.width,t)),e=Math.max(0,Math.min(s.height-n.height,e)),this.domContent.style.position="absolute",this.domContent.style.left=`${t}px`,this.domContent.style.top=`${e}px`}set clickable(t){t?this.class.add(dt):this.class.remove(dt)}get clickable(){return this.class.contains(dt)}set transparent(t){t?this.class.add(ut):this.class.remove(ut)}get transparent(){return this.class.contains(ut)}}I.register("overlay",pt);let mt=class extends z{constructor(t={}){super(t),this.class.add("pcui-text-input"),t.onValidate&&(this.onValidate=t.onValidate)}_onInputChange(t){if(!this._suspendInputChangeEvt){if(this.onValidate){const t=!this.onValidate(this.value);if(this.error=t,t)return}else this.error=!1;this.emit("change",this.value),this._binding&&this._binding.setValue(this.value)}}_updateValue(t){if(this.class.remove(C),t&&"object"==typeof t)if(Array.isArray(t)){let e=!1;for(let s=0;s<t.length;s++)if(t[s]&&"object"==typeof t[s]){e=!0;break}t=e?"[Not available]":t.map(t=>null===t?"null":t).join(",")}else t="[Not available]";return t!==this.value&&(this._suspendInputChangeEvt=!0,this._domInput.value=null==t?"":String(t),this._suspendInputChangeEvt=!1,this.emit("change",t),!0)}set value(t){const e=this._updateValue(t);e&&(this.error=!1),e&&this._binding&&this._binding.setValue(t)}get value(){return this._domInput.value}set values(t){const e=t.some(e=>e!==t[0]);e?(this._updateValue(null),this.class.add(C)):this._updateValue(t[0])}};I.register("string",mt,{renderChanges:!0});let gt=class extends I{constructor(t={}){super(t),this._historyCombine=!1,this._historyPostfix=null,this._size=144,this._directInput=!0,this._colorHSV=[0,0,0],this._pickerChannels=[],this._channelsNumber=4,this._changing=!1,this._dragging=!1,this._callingCallback=!1,this._pickRectPointerId=null,this._pickHuePointerId=null,this._pickOpacityPointerId=null,this._evtColorPick=null,this._evtColorToPicker=null,this._evtColorPickStart=null,this._evtColorPickEnd=null,this._onKeyDown=t=>{"Escape"===t.key&&this.blur(),"Enter"===t.key&&this.enabled&&!this.readOnly&&(t.stopPropagation(),t.preventDefault())},this._onFocus=t=>{this.emit("focus")},this._onBlur=t=>{this.emit("blur")},this._pickRectPointerDown=t=>{null===this._pickRectPointerId&&(this._pickRect.setPointerCapture(t.pointerId),this._pickRectPointerId=t.pointerId,t.preventDefault(),t.stopPropagation(),this.emit("picker:color:start"),this._pickRectPointerMove(t))},this._pickRectPointerMove=t=>{if(this._pickRectPointerId!==t.pointerId)return;this._changing=!0;const e=this._pickRect.getBoundingClientRect(),s=Math.max(0,Math.min(this._size,Math.floor(t.clientX-e.left))),n=Math.max(0,Math.min(this._size,Math.floor(t.clientY-e.top)));this._colorHSV[1]=s/this._size,this._colorHSV[2]=1-n/this._size,this._directInput=!1;const i=lt(this._colorHSV);for(let t=0;t<3;t++)this._pickerChannels[t].value=i[t];this._fieldHex.value=this._getHex(),this._directInput=!0,this._pickRectHandle.style.left=`${Math.max(4,Math.min(this._size-4,s))}px`,this._pickRectHandle.style.top=`${Math.max(4,Math.min(this._size-4,n))}px`,this._changing=!1},this._pickRectPointerUp=t=>{this._pickRectPointerId===t.pointerId&&(this.emit("picker:color:end"),this._pickRect.releasePointerCapture(t.pointerId),this._pickRectPointerId=null)},this._pickHuePointerDown=t=>{null===this._pickHuePointerId&&(this._pickHue.setPointerCapture(t.pointerId),this._pickHuePointerId=t.pointerId,t.preventDefault(),t.stopPropagation(),this.emit("picker:color:start"),this._pickHuePointerMove(t))},this._pickHuePointerMove=t=>{if(this._pickHuePointerId!==t.pointerId)return;this._changing=!0;const e=this._pickHue.getBoundingClientRect(),s=Math.max(0,Math.min(this._size,Math.floor(t.clientY-e.top)))/this._size,n=lt([s,this._colorHSV[1],this._colorHSV[2]]);this._colorHSV[0]=s,this._directInput=!1;for(let t=0;t<3;t++)this._pickerChannels[t].value=n[t];this._fieldHex.value=this._getHex(),this._onChangeRgb(),this._directInput=!0,this._changing=!1},this._pickHuePointerUp=t=>{this._pickHuePointerId===t.pointerId&&(this.emit("picker:color:end"),this._pickHue.releasePointerCapture(t.pointerId),this._pickHuePointerId=null)},this._pickOpacityPointerDown=t=>{null===this._pickOpacityPointerId&&(this._pickOpacity.setPointerCapture(t.pointerId),this._pickOpacityPointerId=t.pointerId,t.preventDefault(),t.stopPropagation(),this.emit("picker:color:start"),this._pickOpacityPointerMove(t))},this._pickOpacityPointerMove=t=>{if(this._pickOpacityPointerId!==t.pointerId)return;this._changing=!0;const e=this._pickOpacity.getBoundingClientRect(),s=1-Math.max(0,Math.min(this._size,Math.floor(t.clientY-e.top)))/this._size;this._directInput=!1,this._pickerChannels[3].value=Math.max(0,Math.min(255,Math.round(255*s))),this._fieldHex.value=this._getHex(),this._directInput=!0,this._changing=!1},this._pickOpacityPointerUp=t=>{this._pickOpacityPointerId===t.pointerId&&(this.emit("picker:color:end"),this._pickOpacity.releasePointerCapture(t.pointerId),this._pickOpacityPointerId=null)},this.class.add("pcui-color-input",E),this._domColor=document.createElement("div"),this.dom.appendChild(this._domColor),this.dom.addEventListener("keydown",this._onKeyDown),this.dom.addEventListener("focus",this._onFocus),this.dom.addEventListener("blur",this._onBlur),this.dom.addEventListener("pointerdown",t=>{this.enabled&&!this.readOnly&&this._overlay.hidden&&(this._openColorPicker(),t.stopPropagation(),t.preventDefault())}),this._value=t.value??[0,0,255,1],this._channels=t.channels??3,this._setValue(this._value),this.renderChanges=t.renderChanges??!1,this.on("change",()=>{this.renderChanges&&this.flash()}),this._overlay=new pt({class:"picker-color",clickable:!0,hidden:!0,transparent:!0}),this.dom.appendChild(this._overlay.dom),this._pickRect=document.createElement("div"),this._pickRect.classList.add("pick-rect"),this._overlay.append(this._pickRect),this._pickRect.addEventListener("pointerdown",this._pickRectPointerDown),this._pickRect.addEventListener("pointermove",this._pickRectPointerMove),this._pickRect.addEventListener("pointerup",this._pickRectPointerUp),this._pickRectWhite=document.createElement("div"),this._pickRectWhite.classList.add("white"),this._pickRect.appendChild(this._pickRectWhite),this._pickRectBlack=document.createElement("div"),this._pickRectBlack.classList.add("black"),this._pickRect.appendChild(this._pickRectBlack),this._pickRectHandle=document.createElement("div"),this._pickRectHandle.classList.add("handle"),this._pickRect.appendChild(this._pickRectHandle),this._pickHue=document.createElement("div"),this._pickHue.classList.add("pick-hue"),this._overlay.append(this._pickHue),this._pickHue.addEventListener("pointerdown",this._pickHuePointerDown),this._pickHue.addEventListener("pointermove",this._pickHuePointerMove),this._pickHue.addEventListener("pointerup",this._pickHuePointerUp),this._pickHueHandle=document.createElement("div"),this._pickHueHandle.classList.add("handle"),this._pickHue.appendChild(this._pickHueHandle),this._pickOpacity=document.createElement("div"),this._pickOpacity.classList.add("pick-opacity"),this._overlay.append(this._pickOpacity),this._pickOpacity.addEventListener("pointerdown",this._pickOpacityPointerDown),this._pickOpacity.addEventListener("pointermove",this._pickOpacityPointerMove),this._pickOpacity.addEventListener("pointerup",this._pickOpacityPointerUp),this._pickOpacityHandle=document.createElement("div"),this._pickOpacityHandle.classList.add("handle"),this._pickOpacity.appendChild(this._pickOpacityHandle),this._panelFields=document.createElement("div"),this._panelFields.classList.add("fields"),this._overlay.append(this._panelFields),this._overlay.on("hide",()=>{this._evtColorPick.unbind(),this._evtColorPick=null,this._evtColorToPicker.unbind(),this._evtColorToPicker=null,this._evtColorPickStart.unbind(),this._evtColorPickStart=null,this._evtColorPickEnd.unbind(),this._evtColorPickEnd=null});const e=t=>new j({class:["field",`field-${t}`],precision:0,step:1,min:0,max:255,placeholder:t}),s=e("r");s.on("change",()=>{this._onChangeRgb()}),this._pickerChannels.push(s),this._panelFields.appendChild(s.dom);const n=e("g");n.on("change",()=>{this._onChangeRgb()}),this._pickerChannels.push(n),this._panelFields.appendChild(n.dom);const i=e("b");i.on("change",()=>{this._onChangeRgb()}),this._pickerChannels.push(i),this._panelFields.appendChild(i.dom);const r=e("a");r.on("change",t=>{this._onChangeAlpha(t)}),this._pickerChannels.push(r),this._panelFields.appendChild(r.dom),this._fieldHex=new mt({class:["field","field-hex"],placeholder:"#"}),this._fieldHex.on("change",()=>{this._onChangeHex()}),this._panelFields.appendChild(this._fieldHex.dom),this._directInput=!1,this._onChangeRgb(),this._directInput=!0}destroy(){this._destroyed||(this.dom.removeEventListener("keydown",this._onKeyDown),this.dom.removeEventListener("focus",this._onFocus),this.dom.removeEventListener("blur",this._onBlur),this._pickRect.removeEventListener("pointerdown",this._pickRectPointerDown),this._pickRect.removeEventListener("pointermove",this._pickRectPointerMove),this._pickRect.removeEventListener("pointerup",this._pickRectPointerUp),this._pickHue.removeEventListener("pointerdown",this._pickHuePointerDown),this._pickHue.removeEventListener("pointermove",this._pickHuePointerMove),this._pickHue.removeEventListener("pointerup",this._pickHuePointerUp),this._pickOpacity.removeEventListener("pointerdown",this._pickOpacityPointerDown),this._pickOpacity.removeEventListener("pointermove",this._pickOpacityPointerMove),this._pickOpacity.removeEventListener("pointerup",this._pickOpacityPointerUp),super.destroy())}focus(){this.dom.focus()}blur(){this.dom.blur()}_setColorPickerPosition(t,e){this._overlay.position(t,e)}_setPickerColor(t){if(!this._changing&&!this._dragging){if(this._channelsNumber>=3){const e=ot(t);this._colorHSV[0]=e[0],this._colorHSV[1]=e[1],this._colorHSV[2]=e[2]}this._directInput=!1;for(let e=0;e<t.length;e++)this._pickerChannels[e].value=t[e];this._fieldHex.value=this._getHex(),this._directInput=!0}}_openColorPicker(){this._callPicker(this.value.map(t=>Math.floor(255*t))),this._evtColorPick=this.on("picker:color",t=>{this.value=t.map(t=>t/255)}),this._evtColorPickStart=this.on("picker:color:start",()=>{this.binding?(this._historyCombine=this.binding.historyCombine,this._historyPostfix=this.binding.historyPostfix,this.binding.historyCombine=!0,this._binding.historyPostfix=`(${Date.now()})`):(this._historyCombine=!1,this._historyPostfix=null)}),this._evtColorPickEnd=this.on("picker:color:end",()=>{this.binding&&(this.binding.historyCombine=this._historyCombine,this.binding.historyPostfix=this._historyPostfix)});const t=this._overlay.dom.getBoundingClientRect(),e=this.dom.getBoundingClientRect();this._setColorPickerPosition(e.left-t.left,e.bottom-t.top+1),this._evtColorToPicker=this.on("change",()=>{this._setPickerColor(this.value.map(t=>Math.floor(255*t)))})}_callPicker(t){for(let e=0;e<4;e++)t.length-1<e?this._overlay.class.remove(`c-${e+1}`):this._overlay.class.add(`c-${e+1}`);if(this._channelsNumber=t.length,this._channelsNumber>=3){const e=ot(t);this._colorHSV[0]=e[0],this._colorHSV[1]=e[1],this._colorHSV[2]=e[2]}this._directInput=!1;for(let e=0;e<t.length;e++)this._pickerChannels[e].value=t[e];this._fieldHex.value=this._getHex(),this._directInput=!0,this._overlay.hidden=!1,this._fieldHex.dom.focus(),window.setTimeout(()=>{this._fieldHex.dom.focus()},100)}_valueToColor(t){return t=Math.floor(255*t),Math.max(0,Math.min(t,255))}_setValue(t){const e=this._valueToColor(t[0]),s=this._valueToColor(t[1]),n=this._valueToColor(t[2]),i=t[3];1===this._channels?this._domColor.style.backgroundColor=`rgb(${e}, ${e}, ${e})`:3===this._channels?this._domColor.style.backgroundColor=`rgb(${e}, ${s}, ${n})`:4===this._channels&&(this._domColor.style.backgroundColor=`rgba(${e}, ${s}, ${n}, ${i})`)}_updateValue(t){let e=!1;for(let s=0;s<t.length;s++)this._value[s]!==t[s]&&(e=!0,this._value[s]=t[s]);return this.class.remove(C),e&&(this._setValue(t),this.emit("change",t)),e}_getHex(){let t="";for(let e=0;e<this._channelsNumber;e++)t+=`00${this._pickerChannels[e].value.toString(16)}`.slice(-2).toUpperCase();return t}_onChangeHex(){if(!this._directInput)return;this._changing=!0;const t=this._fieldHex.value.trim().toLowerCase();if(/^([0-9a-f]{2}){3,4}$/.test(t))for(let e=0;e<this._channelsNumber;e++)this._pickerChannels[e].value=parseInt(t.slice(2*e,2*e+2),16);this._changing=!1}_onChangeRgb(){const t=this._pickerChannels.map(t=>t.value||0).slice(0,this._channelsNumber),e=ot(t);if(this._directInput){const s=t[0]+t[1]+t[2];765!==s&&0!==s&&(this._colorHSV[0]=e[0]),this._colorHSV[1]=e[1],this._colorHSV[2]=e[2],this._dragging=!0,this.emit("picker:color:start"),this._fieldHex.value=this._getHex()}if(this._pickHueHandle.style.top=`${Math.floor(this._size*this._colorHSV[0])}px`,this._pickRectHandle.style.left=`${Math.max(4,Math.min(this._size-4,this._size*this._colorHSV[1]))}px`,this._pickRectHandle.style.top=`${Math.max(4,Math.min(this._size-4,this._size*(1-this._colorHSV[2])))}px`,this._channelsNumber>=3){const e=lt([this._colorHSV[0],1,1]).join(",");this._pickRect.style.backgroundColor=`rgb(${e})`,this._pickRectHandle.style.backgroundColor=`rgb(${t.slice(0,3).join(",")})`,this._pickHueHandle.style.backgroundColor=`rgb(${e})`}this.callCallback()}_onChangeAlpha(t){4===this._channelsNumber&&(this._pickOpacityHandle.style.top=`${Math.floor(this._size*(1-Math.max(0,Math.min(255,t))/255))}px`,this._pickOpacityHandle.style.backgroundColor=`rgb(${t}, ${t}, ${t})`,this.callCallback())}callbackHandle(){this._callingCallback=!1,this.emit("picker:color",this._pickerChannels.map(t=>t.value||0).slice(0,this._channelsNumber))}callCallback(){this._callingCallback||(this._callingCallback=!0,window.setTimeout(()=>{this.callbackHandle()},1e3/60))}set value(t){t=t||[0,0,0,0];this._updateValue(t)&&this._binding&&this._binding.setValue(t)}get value(){return this._value.slice(0,this._channels)}set values(t){let e=!1;const s=t[0];for(let n=1;n<t.length;n++)if(Array.isArray(s)){if(!s.equals(t[n])){e=!0;break}}else if(s!==t[n]){e=!0;break}e?(this.value=null,this.class.add(C)):this.value=t[0]}set channels(t){this._channels!==t&&(this._channels=Math.max(0,Math.min(t,4)),this._setValue(this.value))}get channels(){return this._channels}set renderChanges(t){this._renderChanges=t}get renderChanges(){return this._renderChanges}};I.register("rgb",gt),I.register("rgba",gt,{channels:4});class _t extends f{render(){return d.createElement("div",{ref:this.attachElement})}}_t.ctor=gt;class vt extends f{constructor(){super(...arguments),this.getParent=()=>this}componentDidMount(){this.props.onResize&&this.element.on("resize",this.props.onResize)}render(){const t=Array.from(d.Children.toArray(this.props.children));let e;return 1===t.length?e=d.cloneElement(t[0],{parent:this.element}):t.length>0&&(e=t.map(t=>d.cloneElement(t,{parent:this.element}))),d.createElement("div",{ref:this.attachElement},e)}}vt.ctor=B;const yt=(t,e)=>{if(0===t.length)return e.length;if(0===e.length)return t.length;if(t===e)return 0;const s=[];for(let t=0;t<=e.length;t++)s[t]=[t];for(let e=0;e<=t.length;e++)s[0][e]=e;for(let n=1;n<=e.length;n++)for(let i=1;i<=t.length;i++)e.charAt(n-1)===t.charAt(i-1)?s[n][i]=s[n-1][i-1]:s[n][i]=Math.min(s[n-1][i-1]+1,Math.min(s[n][i-1]+1,s[n-1][i]+1));return s[e.length][t.length]},bt=(t,e)=>{if(t===e)return t.length;let s=0;const n=new Set;for(let t=0;t<e.length;t++)n.add(e.charAt(t));for(let e=0;e<t.length;e++)n.has(t.charAt(e))&&s++;return s},St=t=>{const e=[],s=t.replace(/([^A-Z])([A-Z][^A-Z])/g,"$1 $2").replace(/([A-Z0-9]{2,})/g," $1").split(/([\s\-_])/);for(let t=0;t<s.length;t++)s[t]=s[t].toLowerCase().trim(),s[t]&&"-"!==s[t]&&"_"!==s[t]&&e.push(s[t]);return e},xt=(t,e,s)=>{const n=[];for(const i of t){if(i.subFull!==1/0){n.push(i),i.edits===1/0&&(i.edits=0),i.sub===1/0&&(i.sub=i.subFull);continue}if(i.name===e||0===i.name.indexOf(e)){n.push(i),i.edits===1/0&&(i.edits=0),i.sub===1/0&&(i.sub=0);continue}if(bt(e,i.name)/e.length<s.containsCharsTolerance)continue;let t=1/0,r=1/0;for(let n=0;n<i.tokens.length;n++){if(i.tokens[n]===e){t=0,r=n;break}const a=yt(e,i.tokens[n]);(r===1/0||a<t)&&-1!==i.tokens[n].indexOf(e)?(r=n,t=a):r===1/0&&a<t&&a/Math.max(e.length,i.tokens[n].length)<=s.editsDistanceTolerance&&(t=a)}t!==1/0&&(n.push(i),i.edits=i.edits===1/0?t:i.edits+t,i.sub=i.sub===1/0?r:i.sub+r)}return n},wt=(t,e,s="",n={})=>{if(!(s=s.toLowerCase().trim()))return[];const i=St(s);if(!i.length)return[];n.containsCharsTolerance=n.containsCharsTolerance??.5,n.editsDistanceTolerance=n.editsDistanceTolerance??.5;let r=t.map(t=>{const n=t[e].toLowerCase().trim().indexOf(s);return{name:t[e],item:t,tokens:St(t[e]),edits:1/0,subFull:-1!==n?n:1/0,sub:1/0}});for(let t=0;t<i.length;t++)r=xt(r,i[t],n);r.sort((t,e)=>t.subFull!==e.subFull?t.subFull-e.subFull:t.sub!==e.sub?t.sub-e.sub:t.edits!==e.edits?t.edits-e.edits:t.name.length-e.name.length);let a=r.map(t=>t.item);return n.hasOwnProperty("limitResults")&&a.length>n.limitResults&&(a=a.slice(0,n.limitResults)),a},Tt="pcui-select-input",Ct=`${Tt}-container-value`,Et=`${Tt}-multi`,At=`${Tt}-disabled-value`,Dt=`${Tt}-has-disabled-value`,Pt=`${Tt}-value`,Lt=`${Tt}-icon`,It=`${Tt}-textinput`,Rt=`${Tt}-list`,Mt=`${Tt}-tags`,kt=`${Tt}-tags-empty`,Ot=`${Tt}-tag`,Ft=`${Tt}-tag-not-everywhere`,Nt=`${Tt}-shadow`,Bt=`${Tt}-fit-height`,zt="pcui-selected",Ut=`${Tt}-label-highlighted`,Vt=`${Tt}-create-new`,Ht="pcui-open";let Gt=class extends I{constructor(t={}){const e=new B({dom:t.dom});super({...t,dom:e.dom}),this._timeoutLabelValueTabIndex=null,this._valueToText={},this._valueToLabel={},this._labelToValue=new Map,this._labelHighlighted=null,this._disabledOptions={},this._prefix="",this._onInputChange=t=>{this._suspendInputChange||this._lastInputValue!==t&&(this.open(),this._lastInputValue=t,this._filterOptions(t))},this._onInputKeyDown=t=>{if("Enter"===t.key&&this.enabled&&!this.readOnly){let e;if(t.stopPropagation(),t.preventDefault(),e=this._labelHighlighted&&this._labelToValue.has(this._labelHighlighted)?this._labelToValue.get(this._labelHighlighted):this._input.value,void 0!==e){if(this._allowCreate&&"string"==typeof e&&""===e.trim())return;return this.focus(),this.close(),void(this._valueToText[e]?this._onSelectValue(e):this._allowCreate&&(this._createFn?this._createFn(e):this._onSelectValue(e)))}}this._onKeyDown(t)},this._onDocumentPointerDown=t=>{this.dom.contains(t.composedPath()[0])||this.close()},this._onKeyDown=t=>{if("Escape"!==t.key)if("Tab"!==t.key){if(this.enabled&&!this.readOnly)if("Enter"!==t.key||this._allowInput){if("ArrowUp"===t.key||"ArrowDown"===t.key)if(t.stopPropagation(),t.preventDefault(),(this._allowInput||this.multiSelect)&&this._containerOptions.hidden)this.open();else if(this._containerOptions.hidden){if(!this._options.length)return;let e=-1;for(let t=0;t<this._options.length;t++)if(this._options[t].v===this.value){e=t;break}"ArrowUp"===t.key?e--:"ArrowDown"===t.key&&e++,e>=0&&e<this._options.length&&this._onSelectValue(this._options[e].v)}else{if(!this._containerOptions.dom.childNodes.length)return;if(this._labelHighlighted){let e=this._labelHighlighted.dom;do{"ArrowUp"===t.key?e=e.previousSibling:"ArrowDown"===t.key&&(e=e.nextSibling)}while(e&&e.ui.hidden);e&&this._highlightLabel(e.ui)}else this._highlightLabel(this._containerOptions.dom.childNodes[0].ui)}}else this._labelHighlighted&&this._labelToValue.has(this._labelHighlighted)&&(this._onSelectValue(this._labelToValue.get(this._labelHighlighted)),this.close())}else this.close();else this.close()},this._onPointerDown=()=>{this._allowInput||this.focus()},this._onFocus=()=>{this.class.add(b),this.emit("focus"),this._input.hidden||this.open()},this._onBlur=()=>{this.class.remove(b),this.emit("blur")},this._onWheel=t=>{t.stopPropagation()},this._container=e,this._container.parent=this,this.class.add(Tt),this._containerValue=new B({class:Ct}),this._container.append(this._containerValue),this._domShadow=document.createElement("div"),this._domShadow.classList.add(Nt),this._containerValue.append(this._domShadow),this._allowInput=t.allowInput,this._allowInput&&this.class.add("pcui-select-input-allow-input"),this._allowCreate=t.allowCreate,this._createFn=t.createFn,this._createLabelText=t.createLabelText,this._labelValue=new $({class:Pt,tabIndex:0}),this._labelValue.on("click",()=>{this.enabled&&!this.readOnly&&this.toggle()}),this._containerValue.append(this._labelValue),this._labelIcon=new $({class:Lt,hidden:t.allowInput&&t.multiSelect}),this._containerValue.append(this._labelIcon),this._input=new mt({class:It,blurOnEnter:!1,keyChange:!0}),this._containerValue.append(this._input),this._lastInputValue="",this._suspendInputChange=!1,this._input.on("change",this._onInputChange),this._input.on("keydown",this._onInputKeyDown),this._input.on("focus",this._onFocus),this._input.on("blur",this._onBlur),t.placeholder&&(this.placeholder=t.placeholder),this._containerOptions=new B({class:Rt,hidden:!0}),this._containerValue.append(this._containerOptions),this._containerTags=new B({class:Mt,flex:!0,flexDirection:"row",hidden:!0}),this._container.append(this._containerTags),t.multiSelect&&(this.class.add(Et),this._containerTags.hidden=!1),this._labelValue.dom.addEventListener("keydown",this._onKeyDown),this._labelValue.dom.addEventListener("focus",this._onFocus),this._labelValue.dom.addEventListener("blur",this._onBlur),this._labelValue.dom.addEventListener("pointerdown",this._onPointerDown),this._containerOptions.dom.addEventListener("wheel",this._onWheel,{passive:!0}),this.on("hide",()=>{this.close()}),this._type=t.type??"string",this.invalidOptions=t.invalidOptions??[],this.options=t.options??[],this._optionsFn=t.optionsFn,this._allowNull=t.allowNull,this._values=null,void 0!==t.value?this.value=t.value:t.defaultValue?this.value=t.defaultValue:this.value=null,this._renderChanges=t.renderChanges??!1,this.on("change",()=>{this._updateInputFieldsVisibility(),this.renderChanges&&!this.multiSelect&&this._labelValue.flash()}),this._updateInputFieldsVisibility(!1),this._onSelect=t.onSelect,this.fallbackOrder=t.fallbackOrder,this.disabledOptions=t.disabledOptions,this._prefix=t.prefix??""}destroy(){this._destroyed||(this._labelValue.dom.removeEventListener("keydown",this._onKeyDown),this._labelValue.dom.removeEventListener("pointerdown",this._onPointerDown),this._labelValue.dom.removeEventListener("focus",this._onFocus),this._labelValue.dom.removeEventListener("blur",this._onBlur),this._containerOptions.dom.removeEventListener("wheel",this._onWheel),window.removeEventListener("keydown",this._onKeyDown),document.removeEventListener("pointerdown",this._onDocumentPointerDown),this._timeoutLabelValueTabIndex&&(cancelAnimationFrame(this._timeoutLabelValueTabIndex),this._timeoutLabelValueTabIndex=null),super.destroy())}_initializeCreateLabel(){const t=new B({class:Vt,flex:!0,flexDirection:"row"}),e=new $({text:this._input.value,tabIndex:-1});t.append(e);let s=this._input.on("change",s=>{if(e.destroyed)return;e.text=s;this.invalidOptions&&-1!==this.invalidOptions.indexOf(s)||!s||""===s.trim()?t.hidden||(t.hidden=!0,this._resizeShadow()):t.hidden&&(t.hidden=!1,this._resizeShadow())});t.on("click",t=>{t.stopPropagation();const s=e.text;s&&""!==s.trim()&&(this.focus(),this.close(),this._createFn?this._createFn(s):this._onSelectValue(s))}),e.on("destroy",()=>{s.unbind(),s=null});const n=new $({text:this._createLabelText});return t.append(n),this._containerOptions.append(t),t}_convertSingleValue(t){if(null===t&&this._allowNull)return t;if("string"===this._type)t=t?t.toString():"";else if("number"===this._type)t=t?parseInt(t,10):0;else if("boolean"===this._type)return!!t;return t}_convertValue(t){return null===t&&this._allowNull?t:this.multiSelect?Array.isArray(t)?t.map(t=>this._convertSingleValue(t)):t:this._convertSingleValue(t)}_onSelectValue(t){if(t=this._convertSingleValue(t),this.multiSelect)if(this._values){let e=!1;this._values.forEach(s=>{s?-1===s.indexOf(t)&&(s.push(t),e=!0):(s=[t],e=!0)}),e&&(this._onMultipleValuesChange(this._values),this.emit("change",this.value),this._binding&&this._binding.addValues([t]))}else this._value&&Array.isArray(this._value)?-1===this._value.indexOf(t)&&(this._value.push(t),this._addTag(t),this.emit("change",this.value),this._binding&&this._binding.addValues([t])):this.value=[t];else this.value=t}_highlightLabel(t){if(this._labelHighlighted!==t&&(this._labelHighlighted&&this._labelHighlighted.class.remove(Ut),this._labelHighlighted=t,this._labelHighlighted)){this._labelHighlighted.class.add(Ut);const t=this._labelHighlighted.dom.offsetTop,e=this._containerOptions.dom.scrollTop;t<e?this._containerOptions.dom.scrollTop=t:t+this._labelHighlighted.height>this._containerOptions.height+e&&(this._containerOptions.dom.scrollTop=t+this._labelHighlighted.height-this._containerOptions.height)}}_onValueChange(t){if(this.multiSelect){if(this._labelValue.value="",this._containerTags.clear(),this._containerTags.class.add(kt),t&&Array.isArray(t)){for(const e of t){this._addTag(e);const t=this._valueToLabel[String(e)];t&&t.class.add(zt)}for(const e in this._valueToLabel){const s=this._valueToLabel[e];-1!==t.indexOf(this._convertSingleValue(e))?s.class.add(zt):s.class.remove(zt)}}}else{this._labelValue.value=this._prefix+(this._valueToText[String(t)]||""),t=String(t);for(const e in this._valueToLabel){const s=this._valueToLabel[e];e===t?s.class.add(zt):s.class.remove(zt)}}}_onMultipleValuesChange(t){this._labelValue.value="",this._containerTags.clear(),this._containerTags.class.add(kt);const e={},s={};t.forEach(t=>{t&&t.forEach(t=>{e[t]?s[t]++:(e[t]=this._addTag(t),s[t]=1)})});for(const n in s)if(s[n]!==t.length){e[n].class.add(Ft);const t=this._valueToLabel[String(n)];t&&t.class.remove(zt)}}_addTag(t){const e=new B({flex:!0,flexDirection:"row",class:Ot});e.append(new $({text:this._valueToText[String(t)]||String(t)}));const s=new R({size:"small",icon:"E132",tabIndex:-1});e.append(s),s.on("click",()=>this._removeTag(e,t)),this._containerTags.append(e),this._containerTags.class.remove(kt);const n=this._valueToLabel[String(t)];return n&&n.class.add(zt),e.value=t,e}_removeTag(t,e){t.destroy();const s=this._valueToLabel[String(e)];if(s&&s.class.remove(zt),this._values)this._values.forEach(t=>{if(!t)return;const s=t.indexOf(e);-1!==s&&t.splice(s,1)});else if(this._value&&Array.isArray(this._value)){const t=this._value.indexOf(e);-1!==t&&this._value.splice(t,1)}this.emit("change",this.value),this._binding&&this._binding.removeValues([e])}_filterOptions(t){const e=this._containerOptions.dom;for(;e.firstChild;)e.removeChild(e.lastChild);if(t){wt(this._options,"t",t).forEach(t=>{const s=this._valueToLabel[String(t.v)];e.appendChild(s.dom)})}else for(const t of this._options){const s=this._valueToLabel[String(t.v)];e.appendChild(s.dom)}this._createLabelContainer&&e.appendChild(this._createLabelContainer.dom),e.firstChild&&this._highlightLabel(e.firstChild.ui),this._resizeShadow()}_resizeShadow(){this._domShadow.style.height=`${this._containerValue.height+this._containerOptions.height}px`}_updateInputFieldsVisibility(t){let e=!1,s=!1;this._allowInput&&(t?(e=!0,s=!0):e=this.multiSelect||!this._valueToLabel[this.value]),this._labelValue.hidden=e,this._labelIcon.hidden=e,this._input.hidden=!e,s&&this._input.focus(),this._labelValue.hidden||(this._labelValue.tabIndex=-1,this._timeoutLabelValueTabIndex||(this._timeoutLabelValueTabIndex=requestAnimationFrame(()=>{this._timeoutLabelValueTabIndex=null,this._labelValue.tabIndex=0})))}focus(){this._input.hidden?this._labelValue.dom.focus():this._input.focus()}blur(){this._allowInput?this._input.blur():this._labelValue.dom.blur()}open(){if(!this._containerOptions.hidden||!this.enabled||this.readOnly)return;if(this._updateInputFieldsVisibility(!0),this._optionsFn&&(this.options=this._optionsFn()),0===this._containerOptions.dom.childNodes.length)return;this._containerOptions.forEachChild(t=>{const e=t;e.hidden=!1,this._labelToValue.get(e)===this.value&&this._highlightLabel(e)}),this._labelHighlighted||this._highlightLabel(this._containerOptions.dom.childNodes[0].ui),this._containerOptions.hidden=!1,this.class.add(Ht),window.addEventListener("keydown",this._onKeyDown),document.addEventListener("pointerdown",this._onDocumentPointerDown);const t=(this._allowInput?this._input.dom:this._labelValue.dom).getBoundingClientRect();let e=t.bottom+this._containerOptions.height+25>=window.innerHeight;e&&t.top-this._containerOptions.height<0&&(e=!1,this._containerOptions.style.maxHeight=window.innerHeight-t.bottom-25+"px"),e?this.class.add(Bt):this.class.remove(Bt),this._resizeShadow()}close(){this._containerOptions.style.maxHeight="",this._highlightLabel(null),this._updateInputFieldsVisibility(!1),this._suspendInputChange=!0,this._input.value="",this._lastInputValue&&(this._lastInputValue="",this._filterOptions(null)),this._suspendInputChange=!1,this._containerOptions.hidden||(this._containerOptions.hidden=!0,this._domShadow.style.height="",this.class.remove(Ht),window.removeEventListener("keydown",this._onKeyDown),document.removeEventListener("pointerdown",this._onDocumentPointerDown))}toggle(){this._containerOptions.hidden?this.open():this.close()}unlink(){super.unlink(),this._containerOptions.hidden||this.close()}_updateValue(t){t!==this._value&&(this._value=t,this._onValueChange(t),this._suppressChange||this.emit("change",t),this._binding&&this._binding.setValue(t))}_updateDisabledValue(t){const e={};this._containerOptions.forEachChild(t=>{const s=t;e[s.dom.id]=s,this._disabledOptions[s.dom.id]?(s.enabled=!1,s.text=this._disabledOptions[s.dom.id]):(s.enabled=!0,s.text=this._valueToText[s.dom.id]),s.class.remove(At)});const s=this._disabledOptions[t]?t:null;let n=null;if(s){if(this._fallbackOrder)for(let e=0;e<this._fallbackOrder.length;e++)if(this._fallbackOrder[e]!==t){n=this._fallbackOrder[e];break}this.disabledValue=s,e[s].class.add(At)}else this._disabledValue?(n=this._disabledValue,this.disabledValue=null):(n=t,this.disabledValue=null);return n}set options(t){if(!this._options||JSON.stringify(this._options)!==JSON.stringify(t)){this._containerOptions.clear(),this._labelHighlighted=null,this._valueToText={},this._valueToLabel={},this._options=t;for(const t of this._options){if(this._valueToText[String(t.v)]=t.t,""===t.v)return;const e=new $({text:t.t,tabIndex:-1,id:String(t.v)});this._labelToValue.set(e,t.v),this._valueToLabel[String(t.v)]=e,e.on("click",e=>{e.stopPropagation(),this._onSelectValue(t.v),this.close(),this._onSelect&&this._onSelect(this.value)}),this._containerOptions.append(e)}this._createLabelContainer=null,this._createLabelText&&(this._createLabelContainer=this._initializeCreateLabel()),this.multiSelect&&this._values?this._onMultipleValuesChange(this._values):this._onValueChange(this.value),this._lastInputValue&&this._filterOptions(this._lastInputValue)}}get options(){return this._options.slice()}set invalidOptions(t){this._invalidOptions=t||null}get invalidOptions(){return this._invalidOptions}set disabledValue(t){this._disabledValue=t,null!==this._disabledValue?this.class.add(Dt):this.class.remove(Dt)}set disabledOptions(t){if(JSON.stringify(this._disabledOptions)===JSON.stringify(t))return;this._disabledOptions=t||{};const e=this._updateDisabledValue(this._value);this._updateValue(e)}set fallbackOrder(t){this._fallbackOrder=t||null}get multiSelect(){return this.class.contains(Et)}set value(t){this._values=null,this._suspendInputChange=!0,this._input.value="",this._lastInputValue&&(this._lastInputValue="",this._filterOptions(null)),this._suspendInputChange=!1,this.class.remove(C),t=this._convertValue(t),(!(this._value===t||this.multiSelect&&this._value&&this._value.equals(t))||null===t&&this._allowNull&&this.class.contains(C))&&(this.disabledValue=null,this._updateValue(t))}get value(){if(!this.multiSelect)return this._value;const t=[];return this._containerTags.dom.childNodes.forEach(e=>{t.push(e.ui.value)}),t}set values(t){t=t.map(t=>this._convertValue(t));let e=!1;const s=t[0],n=this.multiSelect;this._values=null;for(let i=1;i<t.length;i++)if(!(t[i]===s||n&&t[i]&&t[i].equals(s))){e=!0;break}e?(this._labelValue.values=t,n?(this._values=t,this._value=null,this._onMultipleValuesChange(this._values),this.emit("change",this.value)):null!==this._value&&(this._value=null,this.emit("change",null)),this.class.add(C)):this.value=t[0]}set placeholder(t){this._input.placeholder=t}get placeholder(){return this._input.placeholder}set renderChanges(t){this._renderChanges=t}get renderChanges(){return this._renderChanges}};I.register("select",Gt,{renderChanges:!0}),I.register("multiselect",Gt,{multiSelect:!0,renderChanges:!0}),I.register("tags",Gt,{allowInput:!0,allowCreate:!0,multiSelect:!0,renderChanges:!0});let Wt=class extends B{constructor(t={}){super(t),this._titleElement=new I,this._textElement=new I,this.class.add("pcui-infobox"),this.append(this._titleElement),this.append(this._textElement),this._unsafe=t.unsafe??!1,this.icon=t.icon??"",this.title=t.title??"",this.text=t.text??""}set icon(t){this._icon!==t&&(this._icon=t,t?this.dom.setAttribute("data-icon",String.fromCodePoint(parseInt(t,16))):this.dom.removeAttribute("data-icon"))}get icon(){return this._icon}set title(t){this._title!==t&&(this._title=t,this._unsafe?this._titleElement.dom.innerHTML=t:this._titleElement.dom.textContent=t)}get title(){return this._title}set text(t){this._text!==t&&(this._text=t,this._unsafe?this._textElement.dom.innerHTML=t:this._textElement.dom.textContent=t)}get text(){return this._text}};I.register("infobox",Wt);class jt extends f{render(){return d.createElement("span",{ref:this.attachElement})}}jt.ctor=Wt;class $t extends f{render(){return d.createElement("span",{ref:this.attachElement})}}$t.ctor=$;class Xt extends f{}Xt.ctor=j;class qt extends f{componentDidMount(){this.attachElement(this.nodeElement,this.containerElement)}render(){let t=d.Children.toArray(this.props.children);return 1===t.length?t=d.cloneElement(t[0],{parent:this.element}):t.length>0&&(t=t.map(t=>d.cloneElement(t,{parent:this.element}))),d.createElement("div",{ref:t=>{this.nodeElement=t}},d.createElement("div",{ref:t=>{this.containerElement=t}},t))}}qt.ctor=tt;class Kt extends f{constructor(t){super(t),this.onSelect=t.onSelect,this.onAttach=this.onAttachFn.bind(this)}onAttachFn(){this.props.onSelect&&this.element.on("select",this.onSelect)}}Kt.ctor=Gt;const Yt="pcui-slider",Qt=`${Yt}-container`,Zt=`${Yt}-bar`,Jt=`${Yt}-handle`,te=`${Yt}-active`,ee=/Chrome\//.test(globalThis.navigator?.userAgent);let se=class extends I{constructor(t={}){super(t),this._historyCombine=!1,this._historyPostfix=null,this._cursorHandleOffset=0,this._pointerId=null,this._onPointerDown=t=>{"mouse"===t.pointerType&&0!==t.button||!this.enabled||this.readOnly||null!==this._pointerId||(t.stopPropagation(),this._domSlider.setPointerCapture(t.pointerId),this._pointerId=t.pointerId,this._onSlideStart(t.pageX))},this._onPointerMove=t=>{t.pointerId===this._pointerId&&(t.stopPropagation(),t.preventDefault(),this._onSlideMove(t.pageX))},this._onPointerUp=t=>{t.pointerId===this._pointerId&&null!==this._pointerId&&(t.stopPropagation(),this._domSlider.releasePointerCapture(t.pointerId),this._onSlideEnd(t.pageX),this._pointerId=null)},this._onKeyDown=t=>{if("Escape"===t.key)return void this.blur();if(!this.enabled||this.readOnly)return;if("ArrowLeft"!==t.key&&"ArrowRight"!==t.key)return;t.stopPropagation(),t.preventDefault();let e="ArrowLeft"===t.key?-1:1;t.shiftKey&&(e*=10),this.value+=e*this.step},this.class.add(Yt);const e=new j({allowNull:t.allowNull,hideSlider:!0,min:t.min,max:t.max,keyChange:t.keyChange,placeholder:t.placeholder,precision:t.precision??2,renderChanges:t.renderChanges,step:t.step});e.on("change",t=>{this._onValueChange(t)}),e.on("focus",()=>{this.emit("focus")}),e.on("blur",()=>{this.emit("blur")}),e.parent=this,this.dom.appendChild(e.dom),this._numericInput=e,this._sliderMin=t.sliderMin??t.min??0,this._sliderMax=t.sliderMax??t.max??1,this._domSlider=document.createElement("div"),this._domSlider.classList.add(Qt),this.dom.appendChild(this._domSlider),this._domBar=document.createElement("div"),this._domBar.classList.add(Zt),this._domBar.ui=this,this._domSlider.appendChild(this._domBar),this._domHandle=document.createElement("div"),this._domHandle.ui=this,this._domHandle.tabIndex=0,this._domHandle.classList.add(Jt),this._domBar.appendChild(this._domHandle),this._domSlider.addEventListener("pointerdown",this._onPointerDown),this._domHandle.addEventListener("keydown",this._onKeyDown),void 0!==t.value&&(this.value=t.value),void 0!==t.values&&(this.values=t.values),0===this.value&&this._updateHandle(0)}destroy(){this._destroyed||(this._domSlider.removeEventListener("pointerdown",this._onPointerDown),this._domHandle.removeEventListener("keydown",this._onKeyDown),super.destroy())}_updateHandle(t){const e=100*Math.max(0,Math.min(1,((t||0)-this._sliderMin)/(this._sliderMax-this._sliderMin))),s=this._domHandle.getBoundingClientRect().width;this._domHandle.style.left=`calc(${e}% + ${s/2}px)`}_onValueChange(t){this._updateHandle(t),this._suppressChange||this.emit("change",t),this._binding&&this._binding.setValue(t)}_calculateCursorHandleOffset(t){const e=ee?2:0,s=this._domHandle.getBoundingClientRect(),n=s.left-e,i=s.right;return this._cursorHandleOffset=t>=n&&t<=i?t-(n+(i-n)/2):0,this._cursorHandleOffset}_onSlideStart(t){this._domHandle.focus(),this._domSlider.addEventListener("pointermove",this._onPointerMove),this._domSlider.addEventListener("pointerup",this._onPointerUp),this.class.add(te),this._calculateCursorHandleOffset(t)||this._onSlideMove(t),this.binding&&(this._historyCombine=this.binding.historyCombine,this._historyPostfix=this.binding.historyPostfix,this.binding.historyCombine=!0,this.binding.historyPostfix=`(${Date.now()})`)}_onSlideMove(t){const e=this._domBar.getBoundingClientRect();t-=this._cursorHandleOffset;let s=Math.max(0,Math.min(1,(t-e.left)/e.width))*(this._sliderMax-this._sliderMin)+this._sliderMin;s=parseFloat(s.toFixed(this.precision)),this.value=s}_onSlideEnd(t){this._calculateCursorHandleOffset(t)||this._onSlideMove(t),this.class.remove(te),this._domSlider.removeEventListener("pointermove",this._onPointerMove),this._domSlider.removeEventListener("pointerup",this._onPointerUp),this.binding&&(this.binding.historyCombine=this._historyCombine,this.binding.historyPostfix=this._historyPostfix,this._historyCombine=!1,this._historyPostfix=null)}focus(){this._numericInput.focus()}blur(){this._domHandle.blur(),this._numericInput.blur()}set sliderMin(t){this._sliderMin!==t&&(this._sliderMin=t,this._updateHandle(this.value))}get sliderMin(){return this._sliderMin}set sliderMax(t){this._sliderMax!==t&&(this._sliderMax=t,this._updateHandle(this.value))}get sliderMax(){return this._sliderMax}set value(t){this._numericInput.value=t,this._numericInput.class.contains(C)?this.class.add(C):this.class.remove(C)}get value(){return this._numericInput.value}set values(t){this._numericInput.values=t,this._numericInput.class.contains(C)?this.class.add(C):this.class.remove(C)}set renderChanges(t){this._numericInput.renderChanges=t}get renderChanges(){return this._numericInput.renderChanges}set min(t){this._numericInput.min=t}get min(){return this._numericInput.min}set max(t){this._numericInput.max=t}get max(){return this._numericInput.max}set step(t){this._numericInput.step=t}get step(){return this._numericInput.step}set precision(t){this._numericInput.precision=t}get precision(){return this._numericInput.precision}set keyChange(t){this._numericInput.keyChange=t}get keyChange(){return this._numericInput.keyChange}set placeholder(t){this._numericInput.placeholder=t}get placeholder(){return this._numericInput.placeholder}};I.register("slider",se,{renderChanges:!0});class ne extends f{}ne.ctor=se;let ie=class t extends I{constructor(e={}){if((e.type??"small-thick")===t.TYPE_SMALL_THICK){const t=function(t,e){const s=e||document.createElementNS("http://www.w3.org/2000/svg","svg");return s.classList.add("spin"),s.setAttribute("width",t),s.setAttribute("height",t),s.setAttribute("viewBox","0 0 14 14"),s.setAttribute("fill","none"),s.innerHTML='<path d="M7 14C3.13871 14 0 10.8613 0 7C0 3.13871 3.13871 0 7 0C10.8613 0 14 3.13871 14 7C14 10.8613 10.8613 14 7 14ZM7 2.25806C4.38064 2.25806 2.25806 4.38064 2.25806 7C2.25806 9.61935 4.38064 11.7419 7 11.7419C9.61935 11.7419 11.7419 9.61935 11.7419 7C11.7419 4.38064 9.61935 2.25806 7 2.25806Z" fill="#773417"/><path class="pcui-spinner-highlight" d="M7 14V11.7419C9.61935 11.7419 11.7419 9.61935 11.7419 7H14C14 10.8613 10.8613 14 7 14Z" fill="#FF6600"/>',s}(e.size??12,e.dom);e={...e,dom:t}}super(e),this.class.add("pcui-spinner")}};ie.TYPE_SMALL_THICK="small-thick";class re extends f{render(){return d.createElement("svg",{ref:this.attachElement})}}re.ctor=ie;class ae extends f{constructor(t={}){super(t),t.onValidate&&(this.onValidate=t.onValidate),this.onAttach=this.onAttachFn.bind(this)}onAttachFn(){this.onValidate&&(this.element.onValidate=this.onValidate)}}ae.ctor=mt;const oe="pcui-treeview-item",le=`${oe}-icon`,he=`${oe}-text`,ce=`${oe}-selected`,de=`${oe}-open`,ue=`${oe}-contents`,fe=`${oe}-empty`,pe=`${oe}-rename`;let me=class t extends B{constructor(t={}){super(t),this.allowDrop=!0,this.allowDrag=!0,this.allowSelect=!0,this._numChildren=0,this._open=!1,this._onContentKeyDown=t=>{"INPUT"!==t.target.tagName&&this.allowSelect&&this._treeView&&this._treeView._onChildKeyDown(t,this)},this._onContentMouseDown=t=>{this._treeView&&this._treeView.allowDrag&&this.allowDrag&&(this._treeView._updateModifierKeys(t),t.stopPropagation())},this._onContentMouseUp=t=>{t.stopPropagation(),t.preventDefault(),window.removeEventListener("mouseup",this._onContentMouseUp),this._treeView&&this._treeView._onChildDragEnd(t,this)},this._onContentMouseOver=t=>{t.stopPropagation(),this._treeView&&this._treeView._onChildDragOver(t,this),this.emit("hover",t)},this._onContentDragStart=t=>{t.stopPropagation(),t.preventDefault(),this._treeView&&this._treeView.allowDrag&&(this.class.contains(pe)||(this._treeView._onChildDragStart(t,this),window.addEventListener("mouseup",this._onContentMouseUp)))},this._onContentClick=t=>{if(!this.allowSelect||0!==t.button)return;if("INPUT"===t.target.tagName)return;t.stopPropagation();const e=this._containerContents.dom.getBoundingClientRect();this._numChildren>0&&t.clientX-e.left<0?(this.open=!this.open,t.altKey&&this._dfs(t=>{t.open=this.open}),this.focus()):this._treeView&&this._treeView._onChildClick(t,this)},this._onContentDblClick=t=>{if(!this._treeView||!this._treeView.allowRenaming||0!==t.button)return;if("INPUT"===t.target.tagName)return;t.stopPropagation();const e=this._containerContents.dom.getBoundingClientRect();this.numChildren&&t.clientX-e.left<0||(this.allowSelect&&(this._treeView.deselect(),this._treeView._onChildClick(t,this)),this.rename())},this._onContentContextMenu=t=>{this._treeView&&this._treeView._onContextMenu&&this._treeView._onContextMenu(t,this)},this._onContentFocus=t=>{this.emit("focus")},this._onContentBlur=t=>{this.emit("blur")},this.class.add(oe,fe),this._containerContents=new B({class:ue,flex:!0,flexDirection:"row",tabIndex:0}),this.append(this._containerContents),this._containerContents.dom.draggable=!0,this._labelIcon=new $({class:le}),this._containerContents.append(this._labelIcon),this.icon=t.icon??"E360",this._labelText=new $({class:he}),this._containerContents.append(this._labelText),this.allowSelect=t.allowSelect??!0,this.allowDrop=t.allowDrop??!0,this.allowDrag=t.allowDrag??!0,t.text&&(this.text=t.text),t.selected&&(this.selected=t.selected),this._open=t.open??!1;const e=this._containerContents.dom;e.addEventListener("focus",this._onContentFocus),e.addEventListener("blur",this._onContentBlur),e.addEventListener("keydown",this._onContentKeyDown),e.addEventListener("dragstart",this._onContentDragStart),e.addEventListener("mousedown",this._onContentMouseDown),e.addEventListener("mouseover",this._onContentMouseOver),e.addEventListener("click",this._onContentClick),e.addEventListener("dblclick",this._onContentDblClick),e.addEventListener("contextmenu",this._onContentContextMenu)}destroy(){if(this._destroyed)return;const t=this._containerContents.dom;t.removeEventListener("focus",this._onContentFocus),t.removeEventListener("blur",this._onContentBlur),t.removeEventListener("keydown",this._onContentKeyDown),t.removeEventListener("dragstart",this._onContentDragStart),t.removeEventListener("mousedown",this._onContentMouseDown),t.removeEventListener("mouseover",this._onContentMouseOver),t.removeEventListener("click",this._onContentClick),t.removeEventListener("dblclick",this._onContentDblClick),t.removeEventListener("contextmenu",this._onContentContextMenu),window.removeEventListener("mouseup",this._onContentMouseUp),super.destroy()}_onAppendChild(e){super._onAppendChild(e),e instanceof t&&(this._numChildren++,this.class.remove(fe),this._open&&this.class.add(de),this._treeView&&this._treeView._onAppendTreeViewItem(e))}_onRemoveChild(e){e instanceof t&&(this._numChildren--,0===this._numChildren&&this.class.add(fe),this._treeView&&this._treeView._onRemoveTreeViewItem(e)),super._onRemoveChild(e)}_dfs(t){t(this);let e=this.firstChild;for(;e;)e._dfs(t),e=e.nextSibling}rename(){this.class.add(pe);const t=new mt({renderChanges:!1,value:this.text,class:S});t.on("blur",()=>{t.destroy()}),t.on("destroy",()=>{this.class.remove(pe),this.focus()}),t.on("change",e=>{(e=e.trim())&&(this.text=e,t.destroy())}),t.on("disable",()=>{t.input.removeAttribute("readonly")}),this._containerContents.append(t),t.focus(!0)}focus(){this._containerContents.dom.focus()}blur(){this._containerContents.dom.blur()}set selected(t){t!==this.selected?t?(this._containerContents.class.add(ce),this.emit("select",this),this._treeView&&this._treeView._onChildSelected(this),this.focus()):(this._containerContents.class.remove(ce),this.blur(),this.emit("deselect",this),this._treeView&&this._treeView._onChildDeselected(this)):t&&this.focus()}get selected(){return this._containerContents.class.contains(ce)}set text(t){this._labelText.value!==t&&(this._labelText.value=t,this._treeView&&this._treeView._onChildRename(this,t))}get text(){return this._labelText.value}get textLabel(){return this._labelText}get iconLabel(){return this._labelIcon}set open(t){if(this._open!==t)if(this._open=t,t){if(!this.numChildren)return;this.class.add(de),this.emit("open",this)}else this.class.remove(de),this.emit("close",this)}get open(){return this._open}set parentsOpen(e){let s=this.parent;for(;s&&s instanceof t;)s.open=e,s=s.parent}get parentsOpen(){let e=this.parent;for(;e&&e instanceof t;){if(!e.open)return!1;e=e.parent}return!0}set treeView(t){this._treeView=t}get treeView(){return this._treeView}get numChildren(){return this._numChildren}get firstChild(){if(this._numChildren)for(const e of this.dom.childNodes)if(e.ui instanceof t)return e.ui;return null}get lastChild(){if(this._numChildren)for(let e=this.dom.childNodes.length-1;e>=0;e--)if(this.dom.childNodes[e].ui instanceof t)return this.dom.childNodes[e].ui;return null}get nextSibling(){let e=this.dom.nextSibling;for(;e&&!(e.ui instanceof t);)e=e.nextSibling;return e&&e.ui}get previousSibling(){let e=this.dom.previousSibling;for(;e&&!(e.ui instanceof t);)e=e.previousSibling;return e&&e.ui}set icon(t){this._icon!==t&&t.match(/^E\d{0,4}$/)&&(this._icon=t,t?this._labelIcon.dom.setAttribute("data-icon",String.fromCodePoint(parseInt(t,16))):this._labelIcon.dom.removeAttribute("data-icon"))}get icon(){return this._icon}};me.EVENT_SELECT="select",me.EVENT_DESELECT="deselect",me.EVENT_OPEN="open",me.EVENT_CLOSE="close";const ge="pcui-treeview",_e=`${ge}-item-dragged`,ve=`${ge}-drag-handle`,ye=`${ge}-filtering`,be=`${ye}-result`,Se="inside",xe="before",we="after";let Te=class extends B{constructor(t={}){super(t),this.allowReordering=!0,this.allowRenaming=!1,this._selectedItems=[],this._dragItems=[],this._dragging=!1,this._dragOverItem=null,this._dragArea=Se,this._dragScroll=0,this._dragScrollInterval=null,this._pressedCtrl=!1,this._pressedShift=!1,this._filter=null,this._filterResults=[],this._updateModifierKeys=t=>{this._pressedCtrl=t.ctrlKey||t.metaKey,this._pressedShift=t.shiftKey},this._onMouseLeave=t=>{this._allowDrag&&this._dragging&&(this._dragOverItem=null,this._updateDragHandle())},this._onMouseMove=t=>{if(!this._dragging)return;const e=this.dom.getBoundingClientRect();this._dragScroll=0;let s=e.top,n=e.bottom;if(this._dragScrollElement!==this){const t=this._dragScrollElement.dom.getBoundingClientRect();s=Math.max(s+this._dragScrollElement.dom.scrollTop,t.top),n=Math.min(n+this._dragScrollElement.dom.scrollTop,t.bottom)}s=Math.max(0,s),n=Math.min(n,document.body.clientHeight),t.pageY<s+32&&this._dragScrollElement.dom.scrollTop>0?this._dragScroll=-1:t.pageY>n-32&&this._dragScrollElement.dom.scrollHeight>this._dragScrollElement.height+this._dragScrollElement.dom.scrollTop&&(this._dragScroll=1)},this._onDragMove=t=>{if(t.preventDefault(),t.stopPropagation(),!this._allowDrag||!this._dragOverItem)return;const e=this._dragHandle.dom.getBoundingClientRect(),s=Math.floor((t.clientY-e.top)/e.height*5),n=this._dragArea,i=this._dragOverItem;if(this._dragOverItem.parent===this){let t=!1;for(let e=0;e<this._dragItems.length;e++)if(this._dragItems[e].parent===this._dragOverItem){t=!0,this._dragOverItem=null;break}t||(this._dragArea=Se)}else{let t=!1;for(let e=0;e<this._dragItems.length;e++)if(this._dragItems[e].dom.contains(this._dragOverItem.dom)){t=!0;break}if(t)this._dragOverItem=null;else if(this.allowReordering&&s<=1&&-1===this._dragItems.indexOf(this._dragOverItem.previousSibling))this._dragArea=xe;else if(this.allowReordering&&s>=4&&-1===this._dragItems.indexOf(this._dragOverItem.nextSibling)&&(0===this._dragOverItem.numChildren||!this._dragOverItem.open))this._dragArea=we;else{let t=!1;if(this.allowReordering&&this._dragOverItem.open)for(let e=0;e<this._dragItems.length;e++)if(this._dragItems[e].parent===this._dragOverItem){t=!0,this._dragArea=xe;break}t||(this._dragArea=Se)}}n===this._dragArea&&i===this._dragOverItem||this._updateDragHandle()},this.class.add(ge),this._allowDrag=t.allowDrag??!0,this.allowReordering=t.allowReordering??!0,this.allowRenaming=t.allowRenaming??!1,this._dragHandle=new I({class:ve,hidden:!0}),this._dragScrollElement=t.dragScrollElement??this,this.append(this._dragHandle),this._onContextMenu=t.onContextMenu,this._onReparentFn=t.onReparent,this._wasDraggingAllowedBeforeFiltering=this._allowDrag,window.addEventListener("keydown",this._updateModifierKeys),window.addEventListener("keyup",this._updateModifierKeys),window.addEventListener("mousedown",this._updateModifierKeys),this.dom.addEventListener("mouseleave",this._onMouseLeave),this._dragHandle.dom.addEventListener("mousemove",this._onDragMove),this._dragHandle.on("destroy",t=>{t.removeEventListener("mousemove",this._onDragMove)})}destroy(){this._destroyed||(window.removeEventListener("keydown",this._updateModifierKeys),window.removeEventListener("keyup",this._updateModifierKeys),window.removeEventListener("mousedown",this._updateModifierKeys),window.removeEventListener("mousemove",this._onMouseMove),this.dom.removeEventListener("mouseleave",this._onMouseLeave),this._dragScrollInterval&&(window.clearInterval(this._dragScrollInterval),this._dragScrollInterval=null),super.destroy())}_findNextVisibleTreeItem(t){if(t.numChildren>0&&t.open)return t.firstChild;const e=t.nextSibling;if(e)return e;let s=t.parent;if(!(s instanceof me))return null;let n=s.nextSibling;for(;!n&&(s=s.parent,s instanceof me);)n=s.nextSibling;return n}_findLastVisibleChildTreeItem(t){if(!t.numChildren||!t.open)return null;let e=t.lastChild;for(;e&&e.numChildren&&e.open;)e=e.lastChild;return e}_findPreviousVisibleTreeItem(t){const e=t.previousSibling;if(e)return e.numChildren>0&&e.open?this._findLastVisibleChildTreeItem(e):e;const s=t.parent;return s instanceof me?s:null}_getChildrenRange(t,e){const s=[];if(this._filterResults.length){const n=this.dom.querySelectorAll(`.${ge}-item.${be}`);let i=-1,r=-1;for(let a=0;a<n.length;a++){const o=n[a].ui;if(o===t?i=a:o===e&&(r=a),-1!==i&&-1!==r){const t=i<r?r:i;for(let e=i<r?i:r;e<=t;e++)s.push(n[e].ui);break}}}else{let n=t;const i=t.dom.getBoundingClientRect(),r=e.dom.getBoundingClientRect();if(i.top<r.top)for(;n&&n!==e;)n=this._findNextVisibleTreeItem(n),n&&n!==e&&s.push(n);else for(;n&&n!==e;)n=this._findPreviousVisibleTreeItem(n),n&&n!==e&&s.push(n);s.push(e)}return s}_onAppendChild(t){super._onAppendChild(t),t instanceof me&&this._onAppendTreeViewItem(t)}_onRemoveChild(t){t instanceof me&&this._onRemoveTreeViewItem(t),super._onRemoveChild(t)}_onAppendTreeViewItem(t){t.treeView=this,this._filter&&this._searchItems([t],this._filter),t.forEachChild(t=>{t instanceof me&&this._onAppendTreeViewItem(t)})}_onRemoveTreeViewItem(t){t.selected=!1,t.forEachChild(t=>{t instanceof me&&this._onRemoveTreeViewItem(t)})}_onChildKeyDown(t,e){if(-1!==["Tab","ArrowLeft","ArrowRight","ArrowUp","ArrowDown"].indexOf(t.key))switch(t.preventDefault(),t.stopPropagation(),t.key){case"ArrowLeft":if(e.numChildren>0&&e.open)e.open=!1;else{const t=e.parent;t instanceof me&&this._selectSingleItem(t)}break;case"ArrowRight":if(e.numChildren>0)if(e.open){const t=e.firstChild;t instanceof me&&this._selectSingleItem(t)}else e.open=!0;break;case"ArrowDown":if(this._selectedItems.length){const t=this._findNextVisibleTreeItem(e);t&&(this._pressedShift||this._pressedCtrl?t.selected=!0:this._selectSingleItem(t))}break;case"ArrowUp":if(this._selectedItems.length){const t=this._findPreviousVisibleTreeItem(e);t&&(this._pressedShift||this._pressedCtrl?t.selected=!0:this._selectSingleItem(t))}}}_onChildClick(t,e){if(0===t.button&&e.allowSelect)if(this._pressedCtrl)e.selected=!e.selected;else if(this._pressedShift){if(!this._selectedItems.length||1===this._selectedItems.length&&this._selectedItems[0]===e)return void(e.selected=!0);const t=this._selectedItems[this._selectedItems.length-1];this._openHierarchy(t);this._getChildrenRange(t,e).forEach(t=>{t.allowSelect&&(t.selected=!0)})}else this._selectSingleItem(e)}_traverseDepthFirst(t){function e(s){if(s&&s instanceof me&&(t(s),s.numChildren))for(const t of s.dom.childNodes)e(t.ui)}for(const t of this.dom.childNodes)e(t.ui)}_getTreeOrder(){const t=new Map;let e=0;return this._traverseDepthFirst(s=>{t.set(s,e++)}),t}_getChildIndex(t,e){return Array.prototype.indexOf.call(e.dom.childNodes,t.dom)-1}_onChildDragStart(t,e){if(this.allowDrag&&!this._dragging){if(this._dragItems=[],-1!==this._selectedItems.indexOf(e)){const t=[];let e=-1;for(let s=0;s<this._selectedItems.length;s++){let n=this._selectedItems[s].parent,i=0,r=!1;for(;n&&n instanceof me;){if(-1!==this._selectedItems.indexOf(n)){r=!0;break}i++,n=n.parent}if(!r){if(-1===e)e=i;else if(e!==i)return;t.push(this._selectedItems[s])}}this._dragItems=t}else e.class.add(_e),this._dragItems.push(e);this._dragItems.length&&(this._dragItems.forEach(t=>{t.class.add(_e)}),this.isDragging=!0,this.emit("dragstart",this._dragItems.slice()))}}_onChildDragEnd(t,e){if(!this.allowDrag||!this._dragging)return;this._dragItems.forEach(t=>t.class.remove(_e));let s=!1;for(let t=0;t<this._dragItems.length;t++)if(this._dragItems[t].parent===this){s=!0;break}if(!s&&this._dragOverItem){if(this._dragItems.length>1){const t=this._getTreeOrder();this._dragItems.sort((e,s)=>t.get(e)-t.get(s))}if(this._dragItems.length){const t=[];if(this._onReparentFn){const e=[],s=t=>{let s=e.findIndex(e=>e.parent===t);return-1===s&&(e.push({parent:t,children:[...t.dom.childNodes]}),s=e.length-1),e[s].children};this._dragItems.forEach(e=>{if(e.parent===this._dragOverItem&&this._dragArea===Se)return;t.push({item:e,oldParent:e.parent});const n=s(e.parent),i=n.indexOf(e.dom);n.splice(i,1)}),t.forEach((e,n)=>{if(this._dragArea===xe){e.newParent=this._dragOverItem.parent;const t=s(this._dragOverItem.parent),n=t.indexOf(this._dragOverItem.dom);t.splice(n,0,e.item.dom),e.newChildIndex=n}else if(this._dragArea===Se){e.newParent=this._dragOverItem;const t=s(this._dragOverItem);t.push(e.item.dom),e.newChildIndex=t.length-1}else if(this._dragArea===we){e.newParent=this._dragOverItem.parent;const i=s(this._dragOverItem.parent),r=n>0?t[n-1].item:this._dragOverItem,a=i.indexOf(r.dom);i.splice(a+1,0,e.item.dom),e.newChildIndex=a+1}e.newChildIndex--})}else this._dragItems.forEach(e=>{e.parent===this._dragOverItem&&this._dragArea===Se||(t.push({item:e,oldParent:e.parent}),e.parent.remove(e))}),t.forEach((e,s)=>{this._dragArea===xe?(e.newParent=this._dragOverItem.parent,e.newParent.appendBefore(e.item,this._dragOverItem),e.newChildIndex=this._getChildIndex(e.item,e.newParent)):this._dragArea===Se?(e.newParent=this._dragOverItem,e.newParent.append(e.item),e.newParent.open=!0,e.newChildIndex=this._getChildIndex(e.item,e.newParent)):this._dragArea===we&&(e.newParent=this._dragOverItem.parent,e.newParent.appendAfter(e.item,s>0?t[s-1].item:this._dragOverItem),e.newChildIndex=this._getChildIndex(e.item,e.newParent))});t.length&&(this._onReparentFn&&this._onReparentFn(t),this.emit("reparent",t))}}this._dragItems=[],this.isDragging=!1,this.emit("dragend")}_onChildDragOver(t,e){this._allowDrag&&this._dragging&&(e.allowDrop&&-1===this._dragItems.indexOf(e)?this._dragOverItem=e:this._dragOverItem=null,this._updateDragHandle(),this._onDragMove(t))}_scrollWhileDragging(){this._dragging&&0!==this._dragScroll&&(this._dragScrollElement.dom.scrollTop+=8*this._dragScroll,this._dragOverItem=null,this._updateDragHandle())}_updateDragHandle(t,e){if(e||this._allowDrag&&this._dragging)if(t||(t=this._dragOverItem),t&&!t.hidden&&t.parentsOpen){const e=t._containerContents.dom.getBoundingClientRect();this._dragHandle.hidden=!1,this._dragHandle.class.remove(we,xe,Se),this._dragHandle.class.add(this._dragArea);const s=e.top;let n=e.left,i=e.width;if(this.dom.parentElement){const t=this.dom.parentElement.getBoundingClientRect();n=Math.max(n,t.left),i=Math.min(i,this.dom.parentElement.clientWidth-n+t.left)}this._dragHandle.style.top=`${s}px`,this._dragHandle.style.left=`${n}px`,this._dragHandle.style.width=i-7+"px"}else this._dragHandle.hidden=!0}_openHierarchy(t){t.parentsOpen=!0}_selectSingleItem(t){let e=this._selectedItems.length,s=!1;for(;e--;)this._selectedItems[e]&&this._selectedItems[e]!==t&&(this._selectedItems[e].selected=!1,s=!0);t.selected=!!s||!t.selected}_onChildSelected(t){this._selectedItems.push(t),this._openHierarchy(t),this.emit("select",t)}_onChildDeselected(t){const e=this._selectedItems.indexOf(t);-1!==e&&(this._selectedItems.splice(e,1),this.emit("deselect",t))}_onChildRename(t,e){if(this._filter){t.class.remove(be);const e=this._filterResults.indexOf(t);-1!==e&&this._filterResults.splice(e,1),this._searchItems([t],this._filter)}this.emit("rename",t,e)}_searchItems(t,e){const s=wt(t,"text",e);s.length&&s.forEach(t=>{this._filterResults.push(t),t.class.add(be)})}_applyFilter(t){this._clearFilter(),this._wasDraggingAllowedBeforeFiltering=this._allowDrag,this._allowDrag=!1,this.class.add(ye);const e=[];this._traverseDepthFirst(t=>{e.push(t)}),this._searchItems(e,t)}_clearFilter(){this._filterResults.forEach(t=>{t.destroyed||t.class.remove(be)}),this._filterResults.length=0,this.class.remove(ye),this._allowDrag=this._wasDraggingAllowedBeforeFiltering}showDragHandle(t){this._updateDragHandle(t,!0)}deselect(){let t=this._selectedItems.length;for(;t--;)this._selectedItems[t]&&(this._selectedItems[t].selected=!1)}clearTreeItems(){let t=this.dom.childNodes.length;for(;t--;){const e=this.dom.childNodes[t];if(!e)continue;const s=e.ui;s instanceof me&&s.destroy()}this._selectedItems=[],this._dragItems=[],this._allowDrag=this._wasDraggingAllowedBeforeFiltering}set allowDrag(t){this._allowDrag=t,this._filter&&(this._wasDraggingAllowedBeforeFiltering=t)}get allowDrag(){return this._allowDrag}set isDragging(t){this._dragging!==t&&(t?(this._dragging=!0,this._updateDragHandle(),(this.scrollable||this._dragScrollElement!==this)&&(window.removeEventListener("mousemove",this._onMouseMove),window.addEventListener("mousemove",this._onMouseMove),this._dragScrollInterval||(this._dragScrollInterval=window.setInterval(()=>{this._scrollWhileDragging()},1e3/60)))):(this._dragOverItem=null,this._updateDragHandle(),this._dragging=!1,window.removeEventListener("mousemove",this._onMouseMove),this._dragScrollInterval&&(window.clearInterval(this._dragScrollInterval),this._dragScrollInterval=null)))}get isDragging(){return this._dragging}get selected(){return this._selectedItems.slice()}set filter(t){this._filter!==t&&(this._filter=t,t?this._applyFilter(t):this._clearFilter())}get filter(){return this._filter}get pressedCtrl(){return this._pressedCtrl}get pressedShift(){return this._pressedShift}};Te.EVENT_DRAGSTART="dragstart",Te.EVENT_DRAGEND="dragend",Te.EVENT_REPARENT="reparent",Te.EVENT_SELECT="select",Te.EVENT_DESELECT="deselect",Te.EVENT_RENAME="rename";class Ce extends f{constructor(t){super(t),this.element=new Te({...t}),this.loadChildren(this.props.children,this.element)}loadChildren(t,e){t&&(Array.isArray(t)||(t=[t]),t.forEach(t=>{const s=new me({text:t.props.text,icon:t.props.icon,open:!1});t.props.onSelect&&s.on("select",t.props.onSelect),t.props.onDeselect&&s.on("deselect",t.props.onDeselect),e.append(s),this.loadChildren(t.props.children,s)}))}componentDidUpdate(){this.parentElement.removeChild(this.element.dom),this.element=new Te({...this.props}),this.loadChildren(this.props.children,this.element),this.parentElement.appendChild(this.element.dom)}parentElementRendered(t){t&&(this.parentElement=t,this.parentElement.appendChild(this.element.dom))}render(){return d.createElement("div",{ref:this.parentElementRendered.bind(this)})}}Ce.ctor=Te;class Ee extends f{constructor(t){super(t),this.onSelect=()=>{t.onSelect&&t.onSelect(()=>{this.element.selected=!1})},t.onDeselect&&(this.onDeselect=t.onDeselect),this.onAttach=this.onAttachFn.bind(this)}onAttachFn(){this.props.onSelect&&this.element.on("select",this.onSelect),this.props.onDeselect&&this.element.on("deselect",this.onDeselect)}}Ee.ctor=me;let Ae=class extends I{constructor(t={}){const e={...t};delete e.binding,super(e),this._inputs=[],this._applyingChange=!1,this._bindAllInputs=!1,this.class.add("pcui-vector-input");const s=Math.max(2,Math.min(4,t.dimensions??3));for(let e=0;e<s;e++){const s=new j({min:t.min,max:t.max,precision:t.precision??7,step:t.step??1,stepPrecision:t.stepPrecision,renderChanges:t.renderChanges,placeholder:t.placeholder?Array.isArray(t.placeholder)?t.placeholder[e]:t.placeholder:null});s.on("slider:mousedown",t=>{if(this._bindAllInputs=!!t.altKey,this._bindAllInputs){s.focus();for(let t=0;t<this._inputs.length;t++)this._inputs[t].class.add(b);this.binding&&(this.binding.historyCombine=!0)}}),s.on("slider:mouseup",()=>{this._onInputChange(s),this._bindAllInputs=!1;for(let t=0;t<this._inputs.length;t++)this._inputs[t].class.remove(b);s.blur(),this.binding&&(this.binding.historyCombine=!1)}),s.on("change",()=>{this._onInputChange(s)}),s.on("focus",()=>{this.emit("focus")}),s.on("blur",()=>{this.emit("blur")}),this.dom.appendChild(s.dom),s.parent=this,this._inputs.push(s)}t.binding&&(this.binding=t.binding),void 0!==t.value&&(this.value=t.value)}_onInputChange(t){if(this._applyingChange)return;const e=this._inputs.some(t=>t.class.contains(C));if(e?this.class.add(C):this.class.remove(C),this._bindAllInputs){const e=Array(this._inputs.length).fill(t.value);this._updateValue(e)&&this._binding&&this._binding.setValue(e)}else this.emit("change",this.value)}_updateValue(t){return this.class.remove(C),JSON.stringify(this.value)!==JSON.stringify(t)&&(this._applyingChange=!0,this._inputs.forEach((e,s)=>{const n=e.binding;let i=!1;n&&(i=n.applyingChange,n.applyingChange=!0),e.value=t&&void 0!==t[s]?t[s]:null,n&&(n.applyingChange=i)}),this.emit("change",this.value),this._applyingChange=!1,!0)}link(t,e){super.link(t,e),t=Array.isArray(t)?t:[t];if(1===(e=Array.isArray(e)?e:[e]).length||t.length!==e.length)for(let s=0;s<this._inputs.length;s++)this._inputs[s].link(t,`${e[0]}.${s}`);else for(let s=0;s<this._inputs.length;s++)this._inputs[s].link(t,e.map(t=>`${t}.${s}`))}unlink(){super.unlink();for(const t of this._inputs)t.unlink()}focus(){this._inputs[0].focus()}blur(){for(const t of this._inputs)t.blur()}set value(t){if("string"==typeof t)try{if(t=JSON.parse(t),Array.isArray(t)&&t.some(t=>!Number.isFinite(t)))throw new Error("VectorInput value set to string which doesn't contain an array of numbers")}catch(e){console.error(e),t=[]}Array.isArray(t)||(t=[]);this._updateValue(t)&&this._binding&&this._binding.setValue(t)}get value(){return this._inputs.map(t=>t.value)}set values(t){t=this._inputs.map((e,s)=>t.map(t=>t?t[s]:void 0)),this._inputs.forEach((e,s)=>{e.values=t[s]})}set binding(t){super.binding=t;for(const e of this._inputs)e.binding=t?t.clone():null}get binding(){return super.binding}set placeholder(t){for(let e=0;e<this._inputs.length;e++)this._inputs[e].placeholder=(Array.isArray(t)?t[e]:t)||null}get placeholder(){return this._inputs.map(t=>t.placeholder)}get inputs(){return this._inputs.slice()}set renderChanges(t){for(const e of this._inputs)e.renderChanges=t}get renderChanges(){return this._inputs[0].renderChanges}set min(t){for(const e of this._inputs)e.min=t}get min(){return this._inputs[0].min}set max(t){for(const e of this._inputs)e.max=t}get max(){return this._inputs[0].max}set precision(t){for(const e of this._inputs)e.precision=t}get precision(){return this._inputs[0].precision}set step(t){for(const e of this._inputs)e.step=t}get step(){return this._inputs[0].step}};I.register("vec2",Ae,{dimensions:2,renderChanges:!0}),I.register("vec3",Ae,{dimensions:3,renderChanges:!0}),I.register("vec4",Ae,{dimensions:4,renderChanges:!0});class De extends f{}De.ctor=Ae;const Pe="2.14.4",Le="a8e9f39";function Ie(t,e){for(const s in e){const n=e[s];Array.isArray(n)?t[s]=Ie([],n):t[s]=n&&"object"==typeof n?Ie({},n):n}return t}const Re={create:()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,t=>{const e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)})},Me={delimiter:"/",join(...t){let e=t[0];for(let s=0;s<t.length-1;s++){const n=t[s],i=t[s+1];i[0]!==Me.delimiter?n&&i&&n[n.length-1]!==Me.delimiter&&i[0]!==Me.delimiter?e+=Me.delimiter+i:e+=i:e=i}return e},normalize(t){const e=t.startsWith(Me.delimiter),s=t.endsWith(Me.delimiter),n=t.split("/");let i="",r=[];for(let t=0;t<n.length;t++)""!==n[t]&&"."!==n[t]&&(".."===n[t]&&r.length>0?r=r.slice(0,r.length-2):(t>0&&r.push(Me.delimiter),r.push(n[t])));return i=r.join(""),e||i[0]!==Me.delimiter||(i=i.slice(1)),s&&i[i.length-1]!==Me.delimiter&&(i+=Me.delimiter),i},split(t){const e=t.lastIndexOf(Me.delimiter);return-1!==e?[t.substring(0,e),t.substring(e+1)]:["",t]},getBasename:t=>Me.split(t)[1],getDirectory:t=>Me.split(t)[0],getExtension(t){const e=t.split("?")[0].split(".").pop();return e!==t?`.${e}`:""},isRelativePath:t=>"/"!==t.charAt(0)&&null===t.match(/:\/\//),extractPath(t){let e="";const s=t.split("/");let n=0;if(s.length>1)if(Me.isRelativePath(t))if("."===s[0])for(n=0;n<s.length-1;++n)e+=0===n?s[n]:`/${s[n]}`;else if(".."===s[0])for(n=0;n<s.length-1;++n)e+=0===n?s[n]:`/${s[n]}`;else for(e=".",n=0;n<s.length-1;++n)e+=`/${s[n]}`;else for(n=0;n<s.length-1;++n)e+=0===n?s[n]:`/${s[n]}`;return e}},ke="undefined"!=typeof navigator?navigator.userAgent:"",Oe="undefined"!=typeof window?"browser":"undefined"!=typeof global?"node":"worker",Fe=/android/i.test(ke)?"android":/ip(?:[ao]d|hone)/i.test(ke)?"ios":/windows/i.test(ke)?"windows":/mac os/i.test(ke)?"osx":/linux/i.test(ke)?"linux":/cros/i.test(ke)?"cros":null,Ne="browser"!==Oe?null:/Chrome\/|Chromium\/|Edg.*\//.test(ke)?"chrome":/Safari\//.test(ke)?"safari":/Firefox\//.test(ke)?"firefox":"other",Be=(()=>{let t=!1;try{const e=Object.defineProperty({},"passive",{get:function(){return t=!0,!1}});window.addEventListener("testpassive",null,e),window.removeEventListener("testpassive",null,e)}catch(t){}return t})(),ze={name:Fe,environment:Oe,browser:"browser"===Oe,worker:"worker"===Oe,desktop:["windows","osx","linux","cros"].includes(Fe),mobile:["android","ios"].includes(Fe),ios:"ios"===Fe,android:"android"===Fe,passiveEvents:Be,browserName:Ne};class Ue{constructor(t,e,s,n,i=!1){this._removed=!1,this.handler=t,this.name=e,this.callback=s,this.scope=n,this._once=i}off(){this._removed||this.handler.offByHandle(this)}on(t,e,s=this){return this.handler._addCallback(t,e,s,!1)}once(t,e,s=this){return this.handler._addCallback(t,e,s,!0)}set removed(t){t&&(this._removed=!0)}get removed(){return this._removed}toJSON(t){}}class Ve{initEventHandler(){this._callbacks=new Map,this._callbackActive=new Map}_addCallback(t,e,s,n){if(this._callbacks.has(t)||this._callbacks.set(t,[]),this._callbackActive.has(t)){const e=this._callbackActive.get(t);e&&e===this._callbacks.get(t)&&this._callbackActive.set(t,e.slice())}const i=new Ue(this,t,e,s,n);return this._callbacks.get(t).push(i),i}on(t,e,s=this){return this._addCallback(t,e,s,!1)}once(t,e,s=this){return this._addCallback(t,e,s,!0)}off(t,e,s){if(t)this._callbackActive.has(t)&&this._callbackActive.get(t)===this._callbacks.get(t)&&this._callbackActive.set(t,this._callbackActive.get(t).slice());else for(const[t,e]of this._callbackActive)this._callbacks.has(t)&&this._callbacks.get(t)===e&&this._callbackActive.set(t,e.slice());if(t)if(e){const n=this._callbacks.get(t);if(!n)return this;for(let t=0;t<n.length;t++)n[t].callback===e&&(s&&n[t].scope!==s||(n[t].removed=!0,n.splice(t,1),t--));0===n.length&&this._callbacks.delete(t)}else{const e=this._callbacks.get(t);if(e){for(let t=0;t<e.length;t++)e[t].removed=!0;this._callbacks.delete(t)}}else{for(const t of this._callbacks.values())for(let e=0;e<t.length;e++)t[e].removed=!0;this._callbacks.clear()}return this}offByHandle(t){const e=t.name;t.removed=!0,this._callbackActive.has(e)&&this._callbackActive.get(e)===this._callbacks.get(e)&&this._callbackActive.set(e,this._callbackActive.get(e).slice());const s=this._callbacks.get(e);if(!s)return this;const n=s.indexOf(t);return-1!==n&&(s.splice(n,1),0===s.length&&this._callbacks.delete(e)),this}fire(t,e,s,n,i,r,a,o,l){if(!t)return this;const h=this._callbacks.get(t);if(!h)return this;let c;this._callbackActive.has(t)?this._callbackActive.get(t)!==h&&(c=h.slice()):this._callbackActive.set(t,h);for(let h=0;(c||this._callbackActive.get(t))&&h<(c||this._callbackActive.get(t)).length;h++){const d=(c||this._callbackActive.get(t))[h];if(d.callback&&(d.callback.call(d.scope,e,s,n,i,r,a,o,l),d._once)){const e=this._callbacks.get(t),s=e?e.indexOf(d):-1;if(-1!==s){this._callbackActive.get(t)===e&&this._callbackActive.set(t,this._callbackActive.get(t).slice());const n=this._callbacks.get(t);if(!n)continue;n[s].removed=!0,n.splice(s,1),0===n.length&&this._callbacks.delete(t)}}}return c||this._callbackActive.delete(t),this}hasEvent(t){return!!this._callbacks.get(t)?.length}constructor(){this._callbacks=new Map,this._callbackActive=new Map}}class He{static{this.modules={}}static{this.wasmSupported=(t=>{const e={};let s=e;return()=>(s===e&&(s=t()),s)})(()=>{try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){const t=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(t instanceof WebAssembly.Module)return new WebAssembly.Instance(t)instanceof WebAssembly.Instance}}catch(t){}return!1})}static loadScript(t,e){const s=document.createElement("script");s.setAttribute("src",t),s.onload=()=>{e(null)},s.onerror=()=>{e(`Failed to load script='${t}'`)},document.body.appendChild(s)}static loadWasm(t,e,s){const n=He.wasmSupported()&&e.glueUrl&&e.wasmUrl?e.glueUrl:e.fallbackUrl;n?He.loadScript(n,n=>{if(n)s(n,null);else{const n=window[t];window[t]=void 0,n({locateFile:()=>e.wasmUrl,onAbort:()=>{s("wasm module aborted.")}}).then(t=>{s(null,t)})}}):s("No supported wasm modules found.",null)}static getModule(t){return He.modules.hasOwnProperty(t)||(He.modules[t]={config:null,initializing:!1,instance:null,callbacks:[]}),He.modules[t]}static initialize(t,e){if(e.initializing)return;const s=e.config;(s.glueUrl||s.wasmUrl||s.fallbackUrl)&&(e.initializing=!0,He.loadWasm(t,s,(n,i)=>{n?s.errorHandler?s.errorHandler(n):console.error(`failed to initialize module=${t} error=${n}`):(e.instance=i,e.callbacks.forEach(t=>{t(i)}))}))}}class Ge{static setConfig(t,e){const s=He.getModule(t);s.config=e,s.callbacks.length>0&&He.initialize(t,s)}static getConfig(t){return He.modules?.[t]?.config}static getInstance(t,e){const s=He.getModule(t);s.instance?e(s.instance):(s.callbacks.push(e),s.config&&He.initialize(t,s))}}class We{constructor(t){this.offset=0,this.arraybuffer=t,this.dataView=new DataView(t)}get remainingBytes(){return this.dataView.byteLength-this.offset}reset(t=0){this.offset=t}skip(t){this.offset+=t}align(t){this.offset=this.offset+t-1&~(t-1)}_inc(t){return this.offset+=t,this.offset-t}readChar(){return String.fromCharCode(this.dataView.getUint8(this.offset++))}readChars(t){let e="";for(let s=0;s<t;++s)e+=this.readChar();return e}readU8(){return this.dataView.getUint8(this.offset++)}readU16(){return this.dataView.getUint16(this._inc(2),!0)}readU32(){return this.dataView.getUint32(this._inc(4),!0)}readU64(){return this.readU32()+2**32*this.readU32()}readU32be(){return this.dataView.getUint32(this._inc(4),!1)}readArray(t){for(let e=0;e<t.length;++e)t[e]=this.readU8()}readLine(){const t=this.dataView;let e="";for(;!(this.offset>=t.byteLength);){const t=String.fromCharCode(this.readU8());if("\n"===t)break;e+=t}return e}}class je{constructor(t){this.items=[],this.length=0,this.loopIndex=-1,this._sortBy=t.sortBy,this._sortHandler=this._doSort.bind(this)}_binarySearch(t){let e=0,s=this.items.length-1;const n=t[this._sortBy];let i,r;for(;e<=s;)i=Math.floor((e+s)/2),r=this.items[i][this._sortBy],r<=n?e=i+1:r>n&&(s=i-1);return e}_doSort(t,e){const s=this._sortBy;return t[s]-e[s]}insert(t){const e=this._binarySearch(t);this.items.splice(e,0,t),this.length++,this.loopIndex>=e&&this.loopIndex++}append(t){this.items.push(t),this.length++}remove(t){const e=this.items.indexOf(t);e<0||(this.items.splice(e,1),this.length--,this.loopIndex>=e&&this.loopIndex--)}sort(){const t=this.loopIndex>=0?this.items[this.loopIndex]:null;this.items.sort(this._sortHandler),null!==t&&(this.loopIndex=this.items.indexOf(t))}}class $e extends Ve{static{this.EVENT_ADD="add"}static{this.EVENT_REMOVE="remove"}static{this.EVENT_CHANGE="change"}constructor(t){super(),this._index={},this._list=[],this._parent=t}add(...t){let e=!1;const s=this._processArguments(t,!0);if(!s.length)return e;for(let t=0;t<s.length;t++)this._index[s[t]]||(e=!0,this._index[s[t]]=!0,this._list.push(s[t]),this.fire("add",s[t],this._parent));return e&&this.fire("change",this._parent),e}remove(...t){let e=!1;if(!this._list.length)return e;const s=this._processArguments(t,!0);if(!s.length)return e;for(let t=0;t<s.length;t++)this._index[s[t]]&&(e=!0,delete this._index[s[t]],this._list.splice(this._list.indexOf(s[t]),1),this.fire("remove",s[t],this._parent));return e&&this.fire("change",this._parent),e}clear(){if(!this._list.length)return;const t=this._list.slice(0);this._list=[],this._index={};for(let e=0;e<t.length;e++)this.fire("remove",t[e],this._parent);this.fire("change",this._parent)}has(...t){return!!this._list.length&&this._has(this._processArguments(t))}_has(t){if(!this._list.length||!t.length)return!1;for(let e=0;e<t.length;e++)if(1===t[e].length){if(this._index[t[e][0]])return!0}else{let s=!0;for(let n=0;n<t[e].length;n++)if(!this._index[t[e][n]]){s=!1;break}if(s)return!0}return!1}list(){return this._list.slice(0)}_processArguments(t,e){const s=[];let n=[];if(!t||!t.length)return s;for(let i=0;i<t.length;i++)if(t[i]instanceof Array){e||(n=[]);for(let r=0;r<t[i].length;r++)"string"==typeof t[i][r]&&(e?s.push(t[i][r]):n.push(t[i][r]));!e&&n.length&&s.push(n)}else"string"==typeof t[i]&&(e?s.push(t[i]):s.push([t[i]]));return s}get size(){return this._list.length}}const Xe="undefined"!=typeof window&&window.performance&&window.performance.now?performance.now.bind(performance):Date.now,qe=/^(([^:/?#]+):)?(\/\/([^/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/;class Ke{constructor(t){const e=t.match(qe);this.scheme=e[2],this.authority=e[4],this.path=e[5],this.query=e[7],this.fragment=e[9]}toString(){let t="";return this.scheme&&(t+=`${this.scheme}:`),this.authority&&(t+=`//${this.authority}`),t+=this.path,this.query&&(t+=`?${this.query}`),this.fragment&&(t+=`#${this.fragment}`),t}getQuery(){const t={};if(this.query){const e=decodeURIComponent(this.query).split("&");for(const s of e){const e=s.split("=");t[e[0]]=e[1]}}return t}setQuery(t){let e="";for(const s in t)t.hasOwnProperty(s)&&(""!==e&&(e+="&"),e+=`${encodeURIComponent(s)}=${encodeURIComponent(t[s])}`);this.query=e}}class Ye{static{this._traceChannels=new Set}static{this.stack=!1}static set(t,e=!0){}static get(t){return Ye._traceChannels.has(t)}}const Qe={DEG_TO_RAD:Math.PI/180,RAD_TO_DEG:180/Math.PI,clamp:(t,e,s)=>t>=s?s:t<=e?e:t,intToBytes24:t=>[t>>16&255,t>>8&255,255&t],intToBytes32:t=>[t>>24&255,t>>16&255,t>>8&255,255&t],bytesToInt24:(t,e,s)=>(t.length&&(s=t[2],e=t[1],t=t[0]),t<<16|e<<8|s),bytesToInt32:(t,e,s,n)=>(t.length&&(n=t[3],s=t[2],e=t[1],t=t[0]),(t<<24|e<<16|s<<8|n)>>>0),lerp:(t,e,s)=>t+(e-t)*Qe.clamp(s,0,1),lerpAngle:(t,e,s)=>(e-t>180&&(e-=360),e-t<-180&&(e+=360),Qe.lerp(t,e,Qe.clamp(s,0,1))),powerOfTwo:t=>0!==t&&!(t&t-1),nextPowerOfTwo:t=>(t--,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,t|=t>>16,++t),nearestPowerOfTwo:t=>Math.pow(2,Math.round(Math.log2(t))),random(t,e){const s=e-t;return Math.random()*s+t},smoothstep:(t,e,s)=>s<=t?0:s>=e?1:(s=(s-t)/(e-t))*s*(3-2*s),smootherstep:(t,e,s)=>s<=t?0:s>=e?1:(s=(s-t)/(e-t))*s*s*(s*(6*s-15)+10),roundUp:(t,e)=>0===e?t:Math.ceil(t/e)*e,between(t,e,s,n){const i=Math.min(e,s),r=Math.max(e,s);return n?t>=i&&t<=r:t>i&&t<r}};class Ze{constructor(t=0,e=0,s=0,n=1){const i=t.length;3===i||4===i?(this.r=t[0],this.g=t[1],this.b=t[2],this.a=t[3]??1):(this.r=t,this.g=e,this.b=s,this.a=n)}clone(){return new(0,this.constructor)(this.r,this.g,this.b,this.a)}copy(t){return this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a,this}equals(t){return this.r===t.r&&this.g===t.g&&this.b===t.b&&this.a===t.a}set(t,e,s,n=1){return this.r=t,this.g=e,this.b=s,this.a=n,this}lerp(t,e,s){return this.r=t.r+s*(e.r-t.r),this.g=t.g+s*(e.g-t.g),this.b=t.b+s*(e.b-t.b),this.a=t.a+s*(e.a-t.a),this}linear(t=this){return this.r=Math.pow(t.r,2.2),this.g=Math.pow(t.g,2.2),this.b=Math.pow(t.b,2.2),this.a=t.a,this}gamma(t=this){return this.r=Math.pow(t.r,1/2.2),this.g=Math.pow(t.g,1/2.2),this.b=Math.pow(t.b,1/2.2),this.a=t.a,this}mulScalar(t){return this.r*=t,this.g*=t,this.b*=t,this}fromString(t){const e=parseInt(t.replace("#","0x"),16);let s;return t.length>7?s=Qe.intToBytes32(e):(s=Qe.intToBytes24(e),s[3]=255),this.set(s[0]/255,s[1]/255,s[2]/255,s[3]/255),this}fromArray(t,e=0){return this.r=t[e]??this.r,this.g=t[e+1]??this.g,this.b=t[e+2]??this.b,this.a=t[e+3]??this.a,this}toString(t,e){const{r:s,g:n,b:i,a:r}=this;if(e||s>1||n>1||i>1)return`${s.toFixed(3)}, ${n.toFixed(3)}, ${i.toFixed(3)}, ${r.toFixed(3)}`;let a=`#${((1<<24)+(Math.round(255*s)<<16)+(Math.round(255*n)<<8)+Math.round(255*i)).toString(16).slice(1)}`;if(!0===t){const t=Math.round(255*r).toString(16);this.a<16/255?a+=`0${t}`:a+=t}return a}toArray(t=[],e=0,s=!0){return t[e]=this.r,t[e+1]=this.g,t[e+2]=this.b,s&&(t[e+3]=this.a),t}static{this.BLACK=Object.freeze(new Ze(0,0,0,1))}static{this.BLUE=Object.freeze(new Ze(0,0,1,1))}static{this.CYAN=Object.freeze(new Ze(0,1,1,1))}static{this.GRAY=Object.freeze(new Ze(.5,.5,.5,1))}static{this.GREEN=Object.freeze(new Ze(0,1,0,1))}static{this.MAGENTA=Object.freeze(new Ze(1,0,1,1))}static{this.RED=Object.freeze(new Ze(1,0,0,1))}static{this.WHITE=Object.freeze(new Ze(1,1,1,1))}static{this.YELLOW=Object.freeze(new Ze(1,1,0,1))}}class Je{constructor(t,e=0){this._left=-1/0,this._right=1/0,this._recip=0,this._p0=0,this._p1=0,this._m0=0,this._m1=0,this._curve=t,this._reset(e)}evaluate(t,e=!1){let s;(e||t<this._left||t>=this._right)&&this._reset(t);const n=this._curve.type;if(5===n)s=this._p0;else{const e=0===this._recip?0:(t-this._left)*this._recip;s=0===n?Qe.lerp(this._p0,this._p1,e):1===n?Qe.lerp(this._p0,this._p1,e*e*(3-2*e)):this._evaluateHermite(this._p0,this._p1,this._m0,this._m1,e)}return s}_reset(t){const e=this._curve.keys,s=e.length;if(s)if(t<e[0][0])this._left=-1/0,this._right=e[0][0],this._recip=0,this._p0=this._p1=e[0][1],this._m0=this._m1=0;else if(t>=e[s-1][0])this._left=e[s-1][0],this._right=1/0,this._recip=0,this._p0=this._p1=e[s-1][1],this._m0=this._m1=0;else{let s=0;for(;t>=e[s+1][0];)s++;this._left=e[s][0],this._right=e[s+1][0];const n=1/(this._right-this._left);this._recip=isFinite(n)?n:0,this._p0=e[s][1],this._p1=e[s+1][1],4===this._curve.type&&this._calcTangents(e,s)}else this._left=-1/0,this._right=1/0,this._recip=0,this._p0=this._p1=this._m0=this._m1=0}_calcTangents(t,e){let s;const n=t[e],i=t[e+1];let r;if(s=0===e?[t[0][0]+(t[0][0]-t[1][0]),t[0][1]+(t[0][1]-t[1][1])]:t[e-1],r=e===t.length-2?[t[e+1][0]+(t[e+1][0]-t[e][0]),t[e+1][1]+(t[e+1][1]-t[e][1])]:t[e+2],4===this._curve.type){const t=2*(i[0]-n[0])/(i[0]-s[0]),e=2*(i[0]-n[0])/(r[0]-n[0]);this._m0=this._curve.tension*(isFinite(t)?t:0)*(i[1]-s[1]),this._m1=this._curve.tension*(isFinite(e)?e:0)*(r[1]-n[1])}else{const t=(i[0]-n[0])/(n[0]-s[0]),e=(i[0]-n[0])/(r[0]-i[0]),a=n[1]+(s[1]-n[1])*(isFinite(t)?t:0),o=i[1]+(r[1]-i[1])*(isFinite(e)?e:0),l=this._curve.tension;this._m0=l*(i[1]-a),this._m1=l*(o-n[1])}}_evaluateHermite(t,e,s,n,i){const r=i*i,a=i+i,o=1-i,l=o*o;return t*((1+a)*l)+s*(i*l)+e*(r*(3-a))+n*(r*(i-1))}}class ts{constructor(t){if(this.keys=[],this.type=1,this.tension=.5,this._eval=new Je(this),t)for(let e=0;e<t.length-1;e+=2)this.keys.push([t[e],t[e+1]]);this.sort()}get length(){return this.keys.length}add(t,e){const s=this.keys,n=s.length;let i=0;for(;i<n&&!(s[i][0]>t);i++);const r=[t,e];return this.keys.splice(i,0,r),r}get(t){return this.keys[t]}sort(){this.keys.sort((t,e)=>t[0]-e[0])}value(t){return this._eval.evaluate(t,!0)}closest(t){const e=this.keys,s=e.length;let n=2,i=null;for(let r=0;r<s;r++){const s=Math.abs(t-e[r][0]);if(!(n>=s))break;n=s,i=e[r]}return i}clone(){const t=new this.constructor;return t.keys=this.keys.map(t=>[...t]),t.type=this.type,t.tension=this.tension,t}quantize(t){t=Math.max(t,2);const e=new Float32Array(t),s=1/(t-1);e[0]=this._eval.evaluate(0,!0);for(let n=1;n<t;n++)e[n]=this._eval.evaluate(s*n);return e}quantizeClamped(t,e,s){const n=this.quantize(t);for(let t=0;t<n.length;++t)n[t]=Math.min(s,Math.max(e,n[t]));return n}}class es{constructor(...t){if(this.curves=[],this._type=1,t.length>1)for(let e=0;e<t.length;e++)this.curves.push(new ts(t[e]));else if(0===t.length)this.curves.push(new ts);else{const e=t[0];if("number"==typeof e)for(let t=0;t<e;t++)this.curves.push(new ts);else for(let t=0;t<e.length;t++)this.curves.push(new ts(e[t]))}}get length(){return this.curves.length}set type(t){this._type=t;for(let e=0;e<this.curves.length;e++)this.curves[e].type=t}get type(){return this._type}get(t){return this.curves[t]}value(t,e=[]){const s=this.curves.length;e.length=s;for(let n=0;n<s;n++)e[n]=this.curves[n].value(t);return e}clone(){const t=new this.constructor;t.curves=[];for(let e=0;e<this.curves.length;e++)t.curves.push(this.curves[e].clone());return t._type=this._type,t}quantize(t){t=Math.max(t,2);const e=this.curves.length,s=new Float32Array(t*e),n=1/(t-1);for(let i=0;i<e;i++){const r=new Je(this.curves[i]);for(let a=0;a<t;a++)s[a*e+i]=r.evaluate(n*a)}return s}quantizeClamped(t,e,s){const n=this.quantize(t);for(let t=0;t<n.length;++t)n[t]=Math.min(s,Math.max(e,n[t]));return n}}const ss=new Float32Array(1),ns=new Int32Array(ss.buffer);class is{static float2Half(t){ss[0]=t;const e=ns[0];let s=e>>16&32768,n=e>>12&2047;const i=e>>23&255;return i<103?s:i>142?(s|=31744,s|=(255===i?0:1)&&8388607&e,s):i<113?(n|=2048,s|=(n>>114-i)+(n>>113-i&1),s):(s|=i-112<<10|n>>1,s+=1&n,s)}static float2RGBA8(t,e){ss[0]=t;const s=ns[0];e.r=(s>>24&255)/255,e.g=(s>>16&255)/255,e.b=(s>>8&255)/255,e.a=(255&s)/255}}class rs{constructor(t=0,e=0,s=0){3===t.length?(this.x=t[0],this.y=t[1],this.z=t[2]):(this.x=t,this.y=e,this.z=s)}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}add2(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this}addScaled(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this}clone(){return new(0,this.constructor)(this.x,this.y,this.z)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}cross(t,e){const s=t.x,n=t.y,i=t.z,r=e.x,a=e.y,o=e.z;return this.x=n*o-a*i,this.y=i*r-o*s,this.z=s*a-r*n,this}distance(t){const e=this.x-t.x,s=this.y-t.y,n=this.z-t.z;return Math.sqrt(e*e+s*s+n*n)}div(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}div2(t,e){return this.x=t.x/e.x,this.y=t.y/e.y,this.z=t.z/e.z,this}divScalar(t){return this.x/=t,this.y/=t,this.z/=t,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}equals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z}equalsApprox(t,e=1e-6){return Math.abs(this.x-t.x)<e&&Math.abs(this.y-t.y)<e&&Math.abs(this.z-t.z)<e}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}lerp(t,e,s){return this.x=t.x+s*(e.x-t.x),this.y=t.y+s*(e.y-t.y),this.z=t.z+s*(e.z-t.z),this}mul(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}mul2(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this}mulScalar(t){return this.x*=t,this.y*=t,this.z*=t,this}normalize(t=this){const e=t.x*t.x+t.y*t.y+t.z*t.z;if(e>0){const s=1/Math.sqrt(e);this.x=t.x*s,this.y=t.y*s,this.z=t.z*s}return this}floor(t=this){return this.x=Math.floor(t.x),this.y=Math.floor(t.y),this.z=Math.floor(t.z),this}ceil(t=this){return this.x=Math.ceil(t.x),this.y=Math.ceil(t.y),this.z=Math.ceil(t.z),this}round(t=this){return this.x=Math.round(t.x),this.y=Math.round(t.y),this.z=Math.round(t.z),this}min(t){return t.x<this.x&&(this.x=t.x),t.y<this.y&&(this.y=t.y),t.z<this.z&&(this.z=t.z),this}max(t){return t.x>this.x&&(this.x=t.x),t.y>this.y&&(this.y=t.y),t.z>this.z&&(this.z=t.z),this}project(t){const e=(this.x*t.x+this.y*t.y+this.z*t.z)/(t.x*t.x+t.y*t.y+t.z*t.z);return this.x=t.x*e,this.y=t.y*e,this.z=t.z*e,this}set(t,e,s){return this.x=t,this.y=e,this.z=s,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}sub2(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this}fromArray(t,e=0){return this.x=t[e]??this.x,this.y=t[e+1]??this.y,this.z=t[e+2]??this.z,this}toString(){return`[${this.x}, ${this.y}, ${this.z}]`}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t}static{this.ZERO=Object.freeze(new rs(0,0,0))}static{this.HALF=Object.freeze(new rs(.5,.5,.5))}static{this.ONE=Object.freeze(new rs(1,1,1))}static{this.UP=Object.freeze(new rs(0,1,0))}static{this.DOWN=Object.freeze(new rs(0,-1,0))}static{this.RIGHT=Object.freeze(new rs(1,0,0))}static{this.LEFT=Object.freeze(new rs(-1,0,0))}static{this.FORWARD=Object.freeze(new rs(0,0,-1))}static{this.BACK=Object.freeze(new rs(0,0,1))}}class as{constructor(){this.data=new Float32Array(9),this.data[0]=this.data[4]=this.data[8]=1}clone(){return(new(0,this.constructor)).copy(this)}copy(t){const e=t.data,s=this.data;return s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=e[3],s[4]=e[4],s[5]=e[5],s[6]=e[6],s[7]=e[7],s[8]=e[8],this}set(t){const e=this.data;return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],this}getX(t=new rs){return t.set(this.data[0],this.data[1],this.data[2])}getY(t=new rs){return t.set(this.data[3],this.data[4],this.data[5])}getZ(t=new rs){return t.set(this.data[6],this.data[7],this.data[8])}equals(t){const e=this.data,s=t.data;return e[0]===s[0]&&e[1]===s[1]&&e[2]===s[2]&&e[3]===s[3]&&e[4]===s[4]&&e[5]===s[5]&&e[6]===s[6]&&e[7]===s[7]&&e[8]===s[8]}isIdentity(){const t=this.data;return 1===t[0]&&0===t[1]&&0===t[2]&&0===t[3]&&1===t[4]&&0===t[5]&&0===t[6]&&0===t[7]&&1===t[8]}setIdentity(){const t=this.data;return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,this}toString(){return`[${this.data.join(", ")}]`}transpose(t=this){const e=t.data,s=this.data;if(e===s){let t;t=e[1],s[1]=e[3],s[3]=t,t=e[2],s[2]=e[6],s[6]=t,t=e[5],s[5]=e[7],s[7]=t}else s[0]=e[0],s[1]=e[3],s[2]=e[6],s[3]=e[1],s[4]=e[4],s[5]=e[7],s[6]=e[2],s[7]=e[5],s[8]=e[8];return this}setFromMat4(t){const e=t.data,s=this.data;return s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=e[4],s[4]=e[5],s[5]=e[6],s[6]=e[8],s[7]=e[9],s[8]=e[10],this}setFromQuat(t){const e=t.x,s=t.y,n=t.z,i=t.w,r=e+e,a=s+s,o=n+n,l=e*r,h=e*a,c=e*o,d=s*a,u=s*o,f=n*o,p=i*r,m=i*a,g=i*o,_=this.data;return _[0]=1-(d+f),_[1]=h+g,_[2]=c-m,_[3]=h-g,_[4]=1-(l+f),_[5]=u+p,_[6]=c+m,_[7]=u-p,_[8]=1-(l+d),this}invertMat4(t){const e=t.data,s=e[0],n=e[1],i=e[2],r=e[4],a=e[5],o=e[6],l=e[8],h=e[9],c=e[10],d=c*a-o*h,u=-c*n+i*h,f=o*n-i*a,p=-c*r+o*l,m=c*s-i*l,g=-o*s+i*r,_=h*r-a*l,v=-h*s+n*l,y=a*s-n*r,b=s*d+n*p+i*_;if(0===b)this.setIdentity();else{const t=1/b,e=this.data;e[0]=d*t,e[1]=u*t,e[2]=f*t,e[3]=p*t,e[4]=m*t,e[5]=g*t,e[6]=_*t,e[7]=v*t,e[8]=y*t}return this}transformVector(t,e=new rs){const s=this.data,{x:n,y:i,z:r}=t;return e.x=n*s[0]+i*s[3]+r*s[6],e.y=n*s[1]+i*s[4]+r*s[7],e.z=n*s[2]+i*s[5]+r*s[8],e}static{this.IDENTITY=Object.freeze(new as)}static{this.ZERO=Object.freeze((new as).set([0,0,0,0,0,0,0,0,0]))}}class os{constructor(t=0,e=0){2===t.length?(this.x=t[0],this.y=t[1]):(this.x=t,this.y=e)}add(t){return this.x+=t.x,this.y+=t.y,this}add2(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this}addScalar(t){return this.x+=t,this.y+=t,this}addScaled(t,e){return this.x+=t.x*e,this.y+=t.y*e,this}clone(){return new(0,this.constructor)(this.x,this.y)}copy(t){return this.x=t.x,this.y=t.y,this}cross(t){return this.x*t.y-this.y*t.x}distance(t){const e=this.x-t.x,s=this.y-t.y;return Math.sqrt(e*e+s*s)}div(t){return this.x/=t.x,this.y/=t.y,this}div2(t,e){return this.x=t.x/e.x,this.y=t.y/e.y,this}divScalar(t){return this.x/=t,this.y/=t,this}dot(t){return this.x*t.x+this.y*t.y}equals(t){return this.x===t.x&&this.y===t.y}equalsApprox(t,e=1e-6){return Math.abs(this.x-t.x)<e&&Math.abs(this.y-t.y)<e}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSq(){return this.x*this.x+this.y*this.y}lerp(t,e,s){return this.x=t.x+s*(e.x-t.x),this.y=t.y+s*(e.y-t.y),this}mul(t){return this.x*=t.x,this.y*=t.y,this}mul2(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this}mulScalar(t){return this.x*=t,this.y*=t,this}normalize(t=this){const e=t.x*t.x+t.y*t.y;if(e>0){const s=1/Math.sqrt(e);this.x=t.x*s,this.y=t.y*s}return this}rotate(t){const e=Math.atan2(this.x,this.y)+t*Qe.DEG_TO_RAD,s=Math.sqrt(this.x*this.x+this.y*this.y);return this.x=Math.sin(e)*s,this.y=Math.cos(e)*s,this}angle(){return Math.atan2(this.x,this.y)*Qe.RAD_TO_DEG}angleTo(t){return Math.atan2(this.x*t.y+this.y*t.x,this.x*t.x+this.y*t.y)*Qe.RAD_TO_DEG}floor(t=this){return this.x=Math.floor(t.x),this.y=Math.floor(t.y),this}ceil(t=this){return this.x=Math.ceil(t.x),this.y=Math.ceil(t.y),this}round(t=this){return this.x=Math.round(t.x),this.y=Math.round(t.y),this}min(t){return t.x<this.x&&(this.x=t.x),t.y<this.y&&(this.y=t.y),this}max(t){return t.x>this.x&&(this.x=t.x),t.y>this.y&&(this.y=t.y),this}set(t,e){return this.x=t,this.y=e,this}sub(t){return this.x-=t.x,this.y-=t.y,this}sub2(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this}subScalar(t){return this.x-=t,this.y-=t,this}fromArray(t,e=0){return this.x=t[e]??this.x,this.y=t[e+1]??this.y,this}toString(){return`[${this.x}, ${this.y}]`}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t}static angleRad(t,e){return Math.atan2(t.x*e.y-t.y*e.x,t.x*e.x+t.y*e.y)}static{this.ZERO=Object.freeze(new os(0,0))}static{this.HALF=Object.freeze(new os(.5,.5))}static{this.ONE=Object.freeze(new os(1,1))}static{this.UP=Object.freeze(new os(0,1))}static{this.DOWN=Object.freeze(new os(0,-1))}static{this.RIGHT=Object.freeze(new os(1,0))}static{this.LEFT=Object.freeze(new os(-1,0))}}class ls{constructor(t=0,e=0,s=0,n=0){4===t.length?(this.x=t[0],this.y=t[1],this.z=t[2],this.w=t[3]):(this.x=t,this.y=e,this.z=s,this.w=n)}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this}add2(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this.w=t.w+e.w,this}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this.w+=t,this}addScaled(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this.w+=t.w*e,this}clone(){return new(0,this.constructor)(this.x,this.y,this.z,this.w)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this}div(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this.w/=t.w,this}div2(t,e){return this.x=t.x/e.x,this.y=t.y/e.y,this.z=t.z/e.z,this.w=t.w/e.w,this}divScalar(t){return this.x/=t,this.y/=t,this.z/=t,this.w/=t,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w}equals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w}equalsApprox(t,e=1e-6){return Math.abs(this.x-t.x)<e&&Math.abs(this.y-t.y)<e&&Math.abs(this.z-t.z)<e&&Math.abs(this.w-t.w)<e}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}lerp(t,e,s){return this.x=t.x+s*(e.x-t.x),this.y=t.y+s*(e.y-t.y),this.z=t.z+s*(e.z-t.z),this.w=t.w+s*(e.w-t.w),this}mul(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this.w*=t.w,this}mul2(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this.w=t.w*e.w,this}mulScalar(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this}normalize(t=this){const e=t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w;if(e>0){const s=1/Math.sqrt(e);this.x=t.x*s,this.y=t.y*s,this.z=t.z*s,this.w=t.w*s}return this}floor(t=this){return this.x=Math.floor(t.x),this.y=Math.floor(t.y),this.z=Math.floor(t.z),this.w=Math.floor(t.w),this}ceil(t=this){return this.x=Math.ceil(t.x),this.y=Math.ceil(t.y),this.z=Math.ceil(t.z),this.w=Math.ceil(t.w),this}round(t=this){return this.x=Math.round(t.x),this.y=Math.round(t.y),this.z=Math.round(t.z),this.w=Math.round(t.w),this}min(t){return t.x<this.x&&(this.x=t.x),t.y<this.y&&(this.y=t.y),t.z<this.z&&(this.z=t.z),t.w<this.w&&(this.w=t.w),this}max(t){return t.x>this.x&&(this.x=t.x),t.y>this.y&&(this.y=t.y),t.z>this.z&&(this.z=t.z),t.w>this.w&&(this.w=t.w),this}set(t,e,s,n){return this.x=t,this.y=e,this.z=s,this.w=n,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this}sub2(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this.w=t.w-e.w,this}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this.w-=t,this}fromArray(t,e=0){return this.x=t[e]??this.x,this.y=t[e+1]??this.y,this.z=t[e+2]??this.z,this.w=t[e+3]??this.w,this}toString(){return`[${this.x}, ${this.y}, ${this.z}, ${this.w}]`}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t[e+3]=this.w,t}static{this.ZERO=Object.freeze(new ls(0,0,0,0))}static{this.HALF=Object.freeze(new ls(.5,.5,.5,.5))}static{this.ONE=Object.freeze(new ls(1,1,1,1))}}const hs=new os,cs=new rs,ds=new rs,us=new rs,fs=new rs;class ps{constructor(){this.data=new Float32Array(16),this.data[0]=this.data[5]=this.data[10]=this.data[15]=1}static _getPerspectiveHalfSize(t,e,s,n,i){i?(t.x=n*Math.tan(e*Math.PI/360),t.y=t.x/s):(t.y=n*Math.tan(e*Math.PI/360),t.x=t.y*s)}add2(t,e){const s=t.data,n=e.data,i=this.data;return i[0]=s[0]+n[0],i[1]=s[1]+n[1],i[2]=s[2]+n[2],i[3]=s[3]+n[3],i[4]=s[4]+n[4],i[5]=s[5]+n[5],i[6]=s[6]+n[6],i[7]=s[7]+n[7],i[8]=s[8]+n[8],i[9]=s[9]+n[9],i[10]=s[10]+n[10],i[11]=s[11]+n[11],i[12]=s[12]+n[12],i[13]=s[13]+n[13],i[14]=s[14]+n[14],i[15]=s[15]+n[15],this}add(t){return this.add2(this,t)}clone(){return(new(0,this.constructor)).copy(this)}copy(t){const e=t.data,s=this.data;return s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=e[3],s[4]=e[4],s[5]=e[5],s[6]=e[6],s[7]=e[7],s[8]=e[8],s[9]=e[9],s[10]=e[10],s[11]=e[11],s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15],this}equals(t){const e=this.data,s=t.data;return e[0]===s[0]&&e[1]===s[1]&&e[2]===s[2]&&e[3]===s[3]&&e[4]===s[4]&&e[5]===s[5]&&e[6]===s[6]&&e[7]===s[7]&&e[8]===s[8]&&e[9]===s[9]&&e[10]===s[10]&&e[11]===s[11]&&e[12]===s[12]&&e[13]===s[13]&&e[14]===s[14]&&e[15]===s[15]}isIdentity(){const t=this.data;return 1===t[0]&&0===t[1]&&0===t[2]&&0===t[3]&&0===t[4]&&1===t[5]&&0===t[6]&&0===t[7]&&0===t[8]&&0===t[9]&&1===t[10]&&0===t[11]&&0===t[12]&&0===t[13]&&0===t[14]&&1===t[15]}mul2(t,e){const s=t.data,n=e.data,i=this.data,r=s[0],a=s[1],o=s[2],l=s[3],h=s[4],c=s[5],d=s[6],u=s[7],f=s[8],p=s[9],m=s[10],g=s[11],_=s[12],v=s[13],y=s[14],b=s[15];let S,x,w,T;return S=n[0],x=n[1],w=n[2],T=n[3],i[0]=r*S+h*x+f*w+_*T,i[1]=a*S+c*x+p*w+v*T,i[2]=o*S+d*x+m*w+y*T,i[3]=l*S+u*x+g*w+b*T,S=n[4],x=n[5],w=n[6],T=n[7],i[4]=r*S+h*x+f*w+_*T,i[5]=a*S+c*x+p*w+v*T,i[6]=o*S+d*x+m*w+y*T,i[7]=l*S+u*x+g*w+b*T,S=n[8],x=n[9],w=n[10],T=n[11],i[8]=r*S+h*x+f*w+_*T,i[9]=a*S+c*x+p*w+v*T,i[10]=o*S+d*x+m*w+y*T,i[11]=l*S+u*x+g*w+b*T,S=n[12],x=n[13],w=n[14],T=n[15],i[12]=r*S+h*x+f*w+_*T,i[13]=a*S+c*x+p*w+v*T,i[14]=o*S+d*x+m*w+y*T,i[15]=l*S+u*x+g*w+b*T,this}mulAffine2(t,e){const s=t.data,n=e.data,i=this.data,r=s[0],a=s[1],o=s[2],l=s[4],h=s[5],c=s[6],d=s[8],u=s[9],f=s[10],p=s[12],m=s[13],g=s[14];let _,v,y;return _=n[0],v=n[1],y=n[2],i[0]=r*_+l*v+d*y,i[1]=a*_+h*v+u*y,i[2]=o*_+c*v+f*y,i[3]=0,_=n[4],v=n[5],y=n[6],i[4]=r*_+l*v+d*y,i[5]=a*_+h*v+u*y,i[6]=o*_+c*v+f*y,i[7]=0,_=n[8],v=n[9],y=n[10],i[8]=r*_+l*v+d*y,i[9]=a*_+h*v+u*y,i[10]=o*_+c*v+f*y,i[11]=0,_=n[12],v=n[13],y=n[14],i[12]=r*_+l*v+d*y+p,i[13]=a*_+h*v+u*y+m,i[14]=o*_+c*v+f*y+g,i[15]=1,this}mul(t){return this.mul2(this,t)}transformPoint(t,e=new rs){const s=this.data,{x:n,y:i,z:r}=t;return e.x=n*s[0]+i*s[4]+r*s[8]+s[12],e.y=n*s[1]+i*s[5]+r*s[9]+s[13],e.z=n*s[2]+i*s[6]+r*s[10]+s[14],e}transformVector(t,e=new rs){const s=this.data,{x:n,y:i,z:r}=t;return e.x=n*s[0]+i*s[4]+r*s[8],e.y=n*s[1]+i*s[5]+r*s[9],e.z=n*s[2]+i*s[6]+r*s[10],e}transformVec4(t,e=new ls){const s=this.data,{x:n,y:i,z:r,w:a}=t;return e.x=n*s[0]+i*s[4]+r*s[8]+a*s[12],e.y=n*s[1]+i*s[5]+r*s[9]+a*s[13],e.z=n*s[2]+i*s[6]+r*s[10]+a*s[14],e.w=n*s[3]+i*s[7]+r*s[11]+a*s[15],e}setLookAt(t,e,s){us.sub2(t,e).normalize(),ds.copy(s).normalize(),cs.cross(ds,us).normalize(),ds.cross(us,cs);const n=this.data;return n[0]=cs.x,n[1]=cs.y,n[2]=cs.z,n[3]=0,n[4]=ds.x,n[5]=ds.y,n[6]=ds.z,n[7]=0,n[8]=us.x,n[9]=us.y,n[10]=us.z,n[11]=0,n[12]=t.x,n[13]=t.y,n[14]=t.z,n[15]=1,this}setFrustum(t,e,s,n,i,r){const a=2*i,o=e-t,l=n-s,h=r-i,c=this.data;return c[0]=a/o,c[1]=0,c[2]=0,c[3]=0,c[4]=0,c[5]=a/l,c[6]=0,c[7]=0,c[8]=(e+t)/o,c[9]=(n+s)/l,c[10]=(-r-i)/h,c[11]=-1,c[12]=0,c[13]=0,c[14]=-a*r/h,c[15]=0,this}setPerspective(t,e,s,n,i){return ps._getPerspectiveHalfSize(hs,t,e,s,i),this.setFrustum(-hs.x,hs.x,-hs.y,hs.y,s,n)}setOrtho(t,e,s,n,i,r){const a=this.data;return a[0]=2/(e-t),a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2/(n-s),a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=-2/(r-i),a[11]=0,a[12]=-(e+t)/(e-t),a[13]=-(n+s)/(n-s),a[14]=-(r+i)/(r-i),a[15]=1,this}setFromAxisAngle(t,e){e*=Qe.DEG_TO_RAD;const{x:s,y:n,z:i}=t,r=Math.cos(e),a=Math.sin(e),o=1-r,l=o*s,h=o*n,c=this.data;return c[0]=l*s+r,c[1]=l*n+a*i,c[2]=l*i-a*n,c[3]=0,c[4]=l*n-a*i,c[5]=h*n+r,c[6]=h*i+a*s,c[7]=0,c[8]=l*i+a*n,c[9]=h*i-s*a,c[10]=o*i*i+r,c[11]=0,c[12]=0,c[13]=0,c[14]=0,c[15]=1,this}setTranslate(t,e,s){const n=this.data;return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=t,n[13]=e,n[14]=s,n[15]=1,this}setScale(t,e,s){const n=this.data;return n[0]=t,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=e,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=s,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,this}setViewport(t,e,s,n){const i=this.data;return i[0]=.5*s,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=.5*n,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=.5,i[11]=0,i[12]=t+.5*s,i[13]=e+.5*n,i[14]=.5,i[15]=1,this}setReflection(t,e){const s=t.x,n=t.y,i=t.z,r=this.data;return r[0]=1-2*s*s,r[1]=-2*s*n,r[2]=-2*s*i,r[3]=0,r[4]=-2*s*n,r[5]=1-2*n*n,r[6]=-2*n*i,r[7]=0,r[8]=-2*s*i,r[9]=-2*n*i,r[10]=1-2*i*i,r[11]=0,r[12]=-2*s*e,r[13]=-2*n*e,r[14]=-2*i*e,r[15]=1,this}invert(t=this){const e=t.data,s=e[0],n=e[1],i=e[2],r=e[3],a=e[4],o=e[5],l=e[6],h=e[7],c=e[8],d=e[9],u=e[10],f=e[11],p=e[12],m=e[13],g=e[14],_=e[15],v=s*o-n*a,y=s*l-i*a,b=s*h-r*a,S=n*l-i*o,x=n*h-r*o,w=i*h-r*l,T=c*m-d*p,C=c*g-u*p,E=c*_-f*p,A=d*g-u*m,D=d*_-f*m,P=u*_-f*g,L=v*P-y*D+b*A+S*E-x*C+w*T;if(0===L)this.setIdentity();else{const t=1/L,e=this.data;e[0]=(o*P-l*D+h*A)*t,e[1]=(-n*P+i*D-r*A)*t,e[2]=(m*w-g*x+_*S)*t,e[3]=(-d*w+u*x-f*S)*t,e[4]=(-a*P+l*E-h*C)*t,e[5]=(s*P-i*E+r*C)*t,e[6]=(-p*w+g*b-_*y)*t,e[7]=(c*w-u*b+f*y)*t,e[8]=(a*D-o*E+h*T)*t,e[9]=(-s*D+n*E-r*T)*t,e[10]=(p*x-m*b+_*v)*t,e[11]=(-c*x+d*b-f*v)*t,e[12]=(-a*A+o*C-l*T)*t,e[13]=(s*A-n*C+i*T)*t,e[14]=(-p*S+m*y-g*v)*t,e[15]=(c*S-d*y+u*v)*t}return this}set(t){const e=this.data;return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],this}setIdentity(){const t=this.data;return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}setTRS(t,e,s){const n=e.x,i=e.y,r=e.z,a=e.w,o=s.x,l=s.y,h=s.z,c=n+n,d=i+i,u=r+r,f=n*c,p=n*d,m=n*u,g=i*d,_=i*u,v=r*u,y=a*c,b=a*d,S=a*u,x=this.data;return x[0]=(1-(g+v))*o,x[1]=(p+S)*o,x[2]=(m-b)*o,x[3]=0,x[4]=(p-S)*l,x[5]=(1-(f+v))*l,x[6]=(_+y)*l,x[7]=0,x[8]=(m+b)*h,x[9]=(_-y)*h,x[10]=(1-(f+g))*h,x[11]=0,x[12]=t.x,x[13]=t.y,x[14]=t.z,x[15]=1,this}transpose(t=this){const e=t.data,s=this.data;if(e===s){let t;t=e[1],s[1]=e[4],s[4]=t,t=e[2],s[2]=e[8],s[8]=t,t=e[3],s[3]=e[12],s[12]=t,t=e[6],s[6]=e[9],s[9]=t,t=e[7],s[7]=e[13],s[13]=t,t=e[11],s[11]=e[14],s[14]=t}else s[0]=e[0],s[1]=e[4],s[2]=e[8],s[3]=e[12],s[4]=e[1],s[5]=e[5],s[6]=e[9],s[7]=e[13],s[8]=e[2],s[9]=e[6],s[10]=e[10],s[11]=e[14],s[12]=e[3],s[13]=e[7],s[14]=e[11],s[15]=e[15];return this}getTranslation(t=new rs){return t.set(this.data[12],this.data[13],this.data[14])}getX(t=new rs){return t.set(this.data[0],this.data[1],this.data[2])}getY(t=new rs){return t.set(this.data[4],this.data[5],this.data[6])}getZ(t=new rs){return t.set(this.data[8],this.data[9],this.data[10])}getScale(t=new rs){return this.getX(cs),this.getY(ds),this.getZ(us),t.set(cs.length(),ds.length(),us.length()),t}get scaleSign(){return this.getX(cs),this.getY(ds),this.getZ(us),cs.cross(cs,ds),cs.dot(us)<0?-1:1}setFromEulerAngles(t,e,s){t*=Qe.DEG_TO_RAD,e*=Qe.DEG_TO_RAD,s*=Qe.DEG_TO_RAD;const n=Math.sin(-t),i=Math.cos(-t),r=Math.sin(-e),a=Math.cos(-e),o=Math.sin(-s),l=Math.cos(-s),h=this.data;return h[0]=a*l,h[1]=-a*o,h[2]=r,h[3]=0,h[4]=i*o+l*n*r,h[5]=i*l-n*r*o,h[6]=-a*n,h[7]=0,h[8]=n*o-i*l*r,h[9]=l*n+i*r*o,h[10]=i*a,h[11]=0,h[12]=0,h[13]=0,h[14]=0,h[15]=1,this}getEulerAngles(t=new rs){this.getScale(fs);const e=fs.x,s=fs.y,n=fs.z;if(0===e||0===s||0===n)return t.set(0,0,0);const i=this.data,r=Math.asin(-i[2]/e),a=.5*Math.PI;let o,l;return r<a?r>-a?(o=Math.atan2(i[6]/s,i[10]/n),l=Math.atan2(i[1]/e,i[0]/e)):(l=0,o=-Math.atan2(i[4]/s,i[5]/s)):(l=0,o=Math.atan2(i[4]/s,i[5]/s)),t.set(o,r,l).mulScalar(Qe.RAD_TO_DEG)}toString(){return`[${this.data.join(", ")}]`}static{this.IDENTITY=Object.freeze(new ps)}static{this.ZERO=Object.freeze((new ps).set([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]))}}class ms{constructor(t=0,e=0,s=0,n=1){4===t.length?(this.x=t[0],this.y=t[1],this.z=t[2],this.w=t[3]):(this.x=t,this.y=e,this.z=s,this.w=n)}clone(){return new(0,this.constructor)(this.x,this.y,this.z,this.w)}conjugate(t=this){return this.x=-1*t.x,this.y=-1*t.y,this.z=-1*t.z,this.w=t.w,this}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w}equals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w}equalsApprox(t,e=1e-6){return Math.abs(this.x-t.x)<e&&Math.abs(this.y-t.y)<e&&Math.abs(this.z-t.z)<e&&Math.abs(this.w-t.w)<e}getAxisAngle(t){let e=2*Math.acos(this.w);const s=Math.sin(e/2);return 0!==s?(t.x=this.x/s,t.y=this.y/s,t.z=this.z/s,(t.x<0||t.y<0||t.z<0)&&(t.x*=-1,t.y*=-1,t.z*=-1,e*=-1)):(t.x=1,t.y=0,t.z=0),e*Qe.RAD_TO_DEG}getEulerAngles(t=new rs){let e,s,n;const i=this.x,r=this.y,a=this.z,o=this.w,l=2*(o*r-i*a);return l<=-.99999?(e=2*Math.atan2(i,o),s=-Math.PI/2,n=0):l>=.99999?(e=2*Math.atan2(i,o),s=Math.PI/2,n=0):(e=Math.atan2(2*(o*i+r*a),1-2*(i*i+r*r)),s=Math.asin(l),n=Math.atan2(2*(o*a+i*r),1-2*(r*r+a*a))),t.set(e,s,n).mulScalar(Qe.RAD_TO_DEG)}invert(t=this){return this.conjugate(t).normalize()}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}lerp(t,e,s){const n=(1-s)*(t.dot(e)<0?-1:1);return this.x=t.x*n+e.x*s,this.y=t.y*n+e.y*s,this.z=t.z*n+e.z*s,this.w=t.w*n+e.w*s,this.normalize()}mul(t){const e=this.x,s=this.y,n=this.z,i=this.w,r=t.x,a=t.y,o=t.z,l=t.w;return this.x=i*r+e*l+s*o-n*a,this.y=i*a+s*l+n*r-e*o,this.z=i*o+n*l+e*a-s*r,this.w=i*l-e*r-s*a-n*o,this}mulScalar(t,e=this){return this.x=e.x*t,this.y=e.y*t,this.z=e.z*t,this.w=e.w*t,this}mul2(t,e){const s=t.x,n=t.y,i=t.z,r=t.w,a=e.x,o=e.y,l=e.z,h=e.w;return this.x=r*a+s*h+n*l-i*o,this.y=r*o+n*h+i*a-s*l,this.z=r*l+i*h+s*o-n*a,this.w=r*h-s*a-n*o-i*l,this}normalize(t=this){let e=t.length();return 0===e?(this.x=this.y=this.z=0,this.w=1):(e=1/e,this.x=t.x*e,this.y=t.y*e,this.z=t.z*e,this.w=t.w*e),this}set(t,e,s,n){return this.x=t,this.y=e,this.z=s,this.w=n,this}setFromAxisAngle(t,e){e*=.5*Qe.DEG_TO_RAD;const s=Math.sin(e),n=Math.cos(e);return this.x=s*t.x,this.y=s*t.y,this.z=s*t.z,this.w=n,this}setFromEulerAngles(t,e,s){if(t instanceof rs){const n=t;t=n.x,e=n.y,s=n.z}const n=.5*Qe.DEG_TO_RAD;t*=n,e*=n,s*=n;const i=Math.sin(t),r=Math.cos(t),a=Math.sin(e),o=Math.cos(e),l=Math.sin(s),h=Math.cos(s);return this.x=i*o*h-r*a*l,this.y=r*a*h+i*o*l,this.z=r*o*l-i*a*h,this.w=r*o*h+i*a*l,this}setFromMat4(t){const e=t.data;let s=e[0],n=e[1],i=e[2],r=e[4],a=e[5],o=e[6],l=e[8],h=e[9],c=e[10];let d;return s*(a*c-o*h)-n*(r*c-o*l)+i*(r*h-a*l)<0&&(s=-s,n=-n,i=-i),d=s*s+n*n+i*i,0===d?this.set(0,0,0,1):(d=1/Math.sqrt(d),s*=d,n*=d,i*=d,d=r*r+a*a+o*o,0===d?this.set(0,0,0,1):(d=1/Math.sqrt(d),r*=d,a*=d,o*=d,d=l*l+h*h+c*c,0===d?this.set(0,0,0,1):(d=1/Math.sqrt(d),l*=d,h*=d,c*=d,c<0?s>a?this.set(1+s-a-c,n+r,l+i,o-h):this.set(n+r,1-s+a-c,o+h,l-i):s<-a?this.set(l+i,o+h,1-s-a+c,n-r):this.set(o-h,l-i,n-r,1+s+a+c),this.mulScalar(1/this.length()))))}setFromDirections(t,e){const s=1+t.dot(e);return s<Number.EPSILON?Math.abs(t.x)>Math.abs(t.y)?(this.x=-t.z,this.y=0,this.z=t.x,this.w=0):(this.x=0,this.y=-t.z,this.z=t.y,this.w=0):(this.x=t.y*e.z-t.z*e.y,this.y=t.z*e.x-t.x*e.z,this.z=t.x*e.y-t.y*e.x,this.w=s),this.normalize()}slerp(t,e,s){const n=t.x,i=t.y,r=t.z,a=t.w;let o=e.x,l=e.y,h=e.z,c=e.w,d=a*c+n*o+i*l+r*h;if(d<0&&(c=-c,o=-o,l=-l,h=-h,d=-d),Math.abs(d)>=1)return this.w=a,this.x=n,this.y=i,this.z=r,this;const u=Math.acos(d),f=Math.sqrt(1-d*d);if(Math.abs(f)<.001)return this.w=.5*a+.5*c,this.x=.5*n+.5*o,this.y=.5*i+.5*l,this.z=.5*r+.5*h,this;const p=Math.sin((1-s)*u)/f,m=Math.sin(s*u)/f;return this.w=a*p+c*m,this.x=n*p+o*m,this.y=i*p+l*m,this.z=r*p+h*m,this}transformVector(t,e=new rs){const s=t.x,n=t.y,i=t.z,r=this.x,a=this.y,o=this.z,l=this.w,h=l*s+a*i-o*n,c=l*n+o*s-r*i,d=l*i+r*n-a*s,u=-r*s-a*n-o*i;return e.x=h*l+u*-r+c*-o-d*-a,e.y=c*l+u*-a+d*-r-h*-o,e.z=d*l+u*-o+h*-a-c*-r,e}fromArray(t,e=0){return this.x=t[e]??this.x,this.y=t[e+1]??this.y,this.z=t[e+2]??this.z,this.w=t[e+3]??this.w,this}toString(){return`[${this.x}, ${this.y}, ${this.z}, ${this.w}]`}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t[e+3]=this.w,t}static{this.IDENTITY=Object.freeze(new ms(0,0,0,1))}static{this.ZERO=Object.freeze(new ms(0,0,0,0))}}const gs=new rs,_s=new rs,vs=new rs,ys=new rs,bs=new rs;class Ss{constructor(t,e){this.center=new rs,this.halfExtents=new rs(.5,.5,.5),this._min=new rs,this._max=new rs,t&&this.center.copy(t),e&&this.halfExtents.copy(e)}add(t){const e=this.center,s=e.x,n=e.y,i=e.z,r=this.halfExtents,a=r.x,o=r.y,l=r.z;let h=s-a,c=s+a,d=n-o,u=n+o,f=i-l,p=i+l;const m=t.center,g=m.x,_=m.y,v=m.z,y=t.halfExtents,b=y.x,S=y.y,x=y.z,w=g-b,T=g+b,C=_-S,E=_+S,A=v-x,D=v+x;w<h&&(h=w),T>c&&(c=T),C<d&&(d=C),E>u&&(u=E),A<f&&(f=A),D>p&&(p=D),e.x=.5*(h+c),e.y=.5*(d+u),e.z=.5*(f+p),r.x=.5*(c-h),r.y=.5*(u-d),r.z=.5*(p-f)}copy(t){this.center.copy(t.center),this.halfExtents.copy(t.halfExtents)}clone(){return new Ss(this.center,this.halfExtents)}intersects(t){const e=this.getMax(),s=this.getMin(),n=t.getMax(),i=t.getMin();return s.x<=n.x&&e.x>=i.x&&s.y<=n.y&&e.y>=i.y&&s.z<=n.z&&e.z>=i.z}_intersectsRay(t,e){const s=gs.copy(this.getMin()).sub(t.origin),n=_s.copy(this.getMax()).sub(t.origin),i=t.direction;0===i.x?(s.x=s.x<0?-Number.MAX_VALUE:Number.MAX_VALUE,n.x=n.x<0?-Number.MAX_VALUE:Number.MAX_VALUE):(s.x/=i.x,n.x/=i.x),0===i.y?(s.y=s.y<0?-Number.MAX_VALUE:Number.MAX_VALUE,n.y=n.y<0?-Number.MAX_VALUE:Number.MAX_VALUE):(s.y/=i.y,n.y/=i.y),0===i.z?(s.z=s.z<0?-Number.MAX_VALUE:Number.MAX_VALUE,n.z=n.z<0?-Number.MAX_VALUE:Number.MAX_VALUE):(s.z/=i.z,n.z/=i.z);const r=vs.set(Math.min(s.x,n.x),Math.min(s.y,n.y),Math.min(s.z,n.z)),a=ys.set(Math.max(s.x,n.x),Math.max(s.y,n.y),Math.max(s.z,n.z)),o=Math.min(Math.min(a.x,a.y),a.z),l=Math.max(Math.max(r.x,r.y),r.z),h=o>=l&&l>=0;return h&&e.copy(t.direction).mulScalar(l).add(t.origin),h}_fastIntersectsRay(t){const e=gs,s=_s,n=vs,i=ys,r=bs,a=t.direction;return e.sub2(t.origin,this.center),i.set(Math.abs(e.x),Math.abs(e.y),Math.abs(e.z)),n.mul2(e,a),!(i.x>this.halfExtents.x&&n.x>=0)&&(!(i.y>this.halfExtents.y&&n.y>=0)&&(!(i.z>this.halfExtents.z&&n.z>=0)&&(r.set(Math.abs(a.x),Math.abs(a.y),Math.abs(a.z)),s.cross(a,e),s.set(Math.abs(s.x),Math.abs(s.y),Math.abs(s.z)),!(s.x>this.halfExtents.y*r.z+this.halfExtents.z*r.y)&&(!(s.y>this.halfExtents.x*r.z+this.halfExtents.z*r.x)&&!(s.z>this.halfExtents.x*r.y+this.halfExtents.y*r.x)))))}intersectsRay(t,e){return e?this._intersectsRay(t,e):this._fastIntersectsRay(t)}setMinMax(t,e){this.center.add2(e,t).mulScalar(.5),this.halfExtents.sub2(e,t).mulScalar(.5)}getMin(){return this._min.copy(this.center).sub(this.halfExtents)}getMax(){return this._max.copy(this.center).add(this.halfExtents)}containsPoint(t){const e=this.center,s=this.halfExtents;return!(t.x<e.x-s.x||t.x>e.x+s.x||t.y<e.y-s.y||t.y>e.y+s.y||t.z<e.z-s.z||t.z>e.z+s.z)}closestPoint(t,e=new rs){const s=this.center,n=this.halfExtents;return e.set(Math.max(s.x-n.x,Math.min(t.x,s.x+n.x)),Math.max(s.y-n.y,Math.min(t.y,s.y+n.y)),Math.max(s.z-n.z,Math.min(t.z,s.z+n.z)))}setFromTransformedAabb(t,e,s=!1){const n=t.center,i=t.halfExtents,r=e.data;let a=r[0],o=r[4],l=r[8],h=r[1],c=r[5],d=r[9],u=r[2],f=r[6],p=r[10];if(s){let t=a*a+o*o+l*l;if(t>0){const e=1/Math.sqrt(t);a*=e,o*=e,l*=e}if(t=h*h+c*c+d*d,t>0){const e=1/Math.sqrt(t);h*=e,c*=e,d*=e}if(t=u*u+f*f+p*p,t>0){const e=1/Math.sqrt(t);u*=e,f*=e,p*=e}}this.center.set(r[12]+a*n.x+o*n.y+l*n.z,r[13]+h*n.x+c*n.y+d*n.z,r[14]+u*n.x+f*n.y+p*n.z),this.halfExtents.set(Math.abs(a)*i.x+Math.abs(o)*i.y+Math.abs(l)*i.z,Math.abs(h)*i.x+Math.abs(c)*i.y+Math.abs(d)*i.z,Math.abs(u)*i.x+Math.abs(f)*i.y+Math.abs(p)*i.z)}static computeMinMax(t,e,s,n=t.length/3){if(n>0){let i=t[0],r=t[1],a=t[2],o=i,l=r,h=a;const c=3*n;for(let e=3;e<c;e+=3){const s=t[e],n=t[e+1],c=t[e+2];s<i&&(i=s),n<r&&(r=n),c<a&&(a=c),s>o&&(o=s),n>l&&(l=n),c>h&&(h=c)}e.set(i,r,a),s.set(o,l,h)}}compute(t,e){Ss.computeMinMax(t,gs,_s,e),this.setMinMax(gs,_s)}intersectsBoundingSphere(t){return this._distanceToBoundingSphereSq(t)<=t.radius*t.radius}_distanceToBoundingSphereSq(t){const e=this.getMin(),s=this.getMax();let n=0;const i=["x","y","z"];for(let r=0;r<3;++r){let a=0;const o=t.center[i[r]],l=e[i[r]],h=s[i[r]];let c=0;o<l&&(c=l-o,a+=c*c),o>h&&(c=o-h,a+=c*c),n+=a}return n}_expand(t,e){gs.add2(this.getMin(),t),_s.add2(this.getMax(),e),this.setMinMax(gs,_s)}}const xs=new rs,ws=new rs;class Ts{constructor(t=new rs,e=.5){this.center=t,this.radius=e}containsPoint(t){const e=xs.sub2(t,this.center).lengthSq(),s=this.radius;return e<s*s}intersectsRay(t,e){const s=xs.copy(t.origin).sub(this.center),n=s.dot(ws.copy(t.direction).normalize()),i=s.dot(s)-this.radius*this.radius;if(i>0&&n>0)return!1;const r=n*n-i;if(r<0)return!1;const a=Math.abs(-n-Math.sqrt(r));return e&&e.copy(t.direction).mulScalar(a).add(t.origin),!0}intersectsBoundingSphere(t){xs.sub2(t.center,this.center);const e=t.radius+this.radius;return xs.lengthSq()<=e*e}}class Cs{constructor(t=rs.UP,e=0){this.normal=new rs,this.normal.copy(t),this.distance=e}clone(){return(new(0,this.constructor)).copy(this)}copy(t){return this.normal.copy(t.normal),this.distance=t.distance,this}intersectsLine(t,e,s){const n=this.distance,i=this.normal.dot(t)+n,r=i/(i-(this.normal.dot(e)+n)),a=r>=0&&r<=1;return a&&s&&s.lerp(t,e,r),a}intersectsRay(t,e){const s=this.normal.dot(t.direction);if(0===s)return!1;const n=-(this.normal.dot(t.origin)+this.distance)/s;return n>=0&&e&&e.copy(t.direction).mulScalar(n).add(t.origin),n>=0}normalize(){const t=1/this.normal.length();return this.normal.mulScalar(t),this.distance*=t,this}set(t,e,s,n){return this.normal.set(t,e,s),this.distance=n,this}setFromPointNormal(t,e){return this.normal.copy(e),this.distance=-this.normal.dot(t),this}}class Es{constructor(){this.planes=[];for(let t=0;t<6;t++)this.planes[t]=new Cs}clone(){return(new(0,this.constructor)).copy(this)}copy(t){for(let e=0;e<6;e++)this.planes[e].copy(t.planes[e]);return this}setFromMat4(t){const[e,s,n,i,r,a,o,l,h,c,d,u,f,p,m,g]=t.data,_=this.planes;_[0].set(i-e,l-r,u-h,g-f).normalize(),_[1].set(i+e,l+r,u+h,g+f).normalize(),_[2].set(i+s,l+a,u+c,g+p).normalize(),_[3].set(i-s,l-a,u-c,g-p).normalize(),_[4].set(i-n,l-o,u-d,g-m).normalize(),_[5].set(i+n,l+o,u+d,g+m).normalize()}containsPoint(t){for(let e=0;e<6;e++){const{normal:s,distance:n}=this.planes[e];if(s.dot(t)+n<=0)return!1}return!0}containsSphere(t){const{center:e,radius:s}=t;let n=0;for(let t=0;t<6;t++){const{normal:i,distance:r}=this.planes[t],a=i.dot(e)+r;if(a<=-s)return 0;a>s&&n++}return 6===n?2:1}}class As{constructor(t,e){this.origin=new rs,this.direction=rs.FORWARD.clone(),t&&this.origin.copy(t),e&&this.direction.copy(e)}set(t,e){return this.origin.copy(t),this.direction.copy(e),this}copy(t){return this.set(t.origin,t.direction)}clone(){return new this.constructor(this.origin,this.direction)}}const Ds=[1,2,4],Ps=10,Ls=12,Is=14,Rs=15,Ms=16,ks=17,Os=18,Fs=20,Ns=24,Bs=25,zs=37,Us=43,Vs=47,Hs=49,Gs=69,Ws=new Map([[0,{name:"A8",size:1,ldr:!0}],[52,{name:"R8",size:1,ldr:!0}],[1,{name:"L8",size:1,ldr:!0}],[2,{name:"LA8",size:2,ldr:!0}],[53,{name:"RG8",size:2,ldr:!0}],[3,{name:"RGB565",size:2,ldr:!0}],[4,{name:"RGBA5551",size:2,ldr:!0}],[5,{name:"RGBA4",size:2,ldr:!0}],[6,{name:"RGB8",size:4,ldr:!0}],[7,{name:"RGBA8",size:4,ldr:!0,srgbFormat:Fs}],[50,{name:"R16F",size:2}],[51,{name:"RG16F",size:4}],[11,{name:"RGB16F",size:8}],[Ls,{name:"RGBA16F",size:8}],[13,{name:"RGB32F",size:16}],[Is,{name:"RGBA32F",size:16}],[Rs,{name:"R32F",size:4}],[Ms,{name:"DEPTH",size:4}],[Gs,{name:"DEPTH16",size:2}],[ks,{name:"DEPTHSTENCIL",size:4}],[Os,{name:"111110F",size:4}],[19,{name:"SRGB8",size:4,ldr:!0,srgb:!0}],[Fs,{name:"SRGBA8",size:4,ldr:!0,srgb:!0}],[31,{name:"BGRA8",size:4,ldr:!0}],[64,{name:"SBGRA8",size:4,ldr:!0,srgb:!0}],[8,{name:"DXT1",blockSize:8,ldr:!0,srgbFormat:54}],[9,{name:"DXT3",blockSize:16,ldr:!0,srgbFormat:55}],[Ps,{name:"DXT5",blockSize:16,ldr:!0,srgbFormat:56}],[21,{name:"ETC1",blockSize:8,ldr:!0}],[22,{name:"ETC2_RGB",blockSize:8,ldr:!0,srgbFormat:61}],[23,{name:"ETC2_RGBA",blockSize:16,ldr:!0,srgbFormat:62}],[Ns,{name:"PVRTC_2BPP_RGB_1",ldr:!0,blockSize:8}],[Bs,{name:"PVRTC_2BPP_RGBA_1",ldr:!0,blockSize:8}],[26,{name:"PVRTC_4BPP_RGB_1",ldr:!0,blockSize:8}],[27,{name:"PVRTC_4BPP_RGBA_1",ldr:!0,blockSize:8}],[28,{name:"ASTC_4x4",blockSize:16,ldr:!0,srgbFormat:63}],[29,{name:"ATC_RGB",blockSize:8,ldr:!0}],[30,{name:"ATC_RGBA",blockSize:16,ldr:!0}],[65,{name:"BC6H_RGBF",blockSize:16}],[66,{name:"BC6H_RGBUF",blockSize:16}],[67,{name:"BC7_RGBA",blockSize:16,ldr:!0,srgbFormat:68}],[54,{name:"DXT1_SRGB",blockSize:8,ldr:!0,srgb:!0}],[55,{name:"DXT3_SRGBA",blockSize:16,ldr:!0,srgb:!0}],[56,{name:"DXT5_SRGBA",blockSize:16,ldr:!0,srgb:!0}],[61,{name:"ETC2_SRGB",blockSize:8,ldr:!0,srgb:!0}],[62,{name:"ETC2_SRGBA",blockSize:16,ldr:!0,srgb:!0}],[63,{name:"ASTC_4x4_SRGB",blockSize:16,ldr:!0,srgb:!0}],[68,{name:"BC7_SRGBA",blockSize:16,ldr:!0,srgb:!0}],[32,{name:"R8I",size:1,isInt:!0}],[33,{name:"R8U",size:1,isInt:!0}],[34,{name:"R16I",size:2,isInt:!0}],[35,{name:"R16U",size:2,isInt:!0}],[36,{name:"R32I",size:4,isInt:!0}],[zs,{name:"R32U",size:4,isInt:!0}],[38,{name:"RG8I",size:2,isInt:!0}],[39,{name:"RG8U",size:2,isInt:!0}],[40,{name:"RG16I",size:4,isInt:!0}],[41,{name:"RG16U",size:4,isInt:!0}],[42,{name:"RG32I",size:8,isInt:!0}],[Us,{name:"RG32U",size:8,isInt:!0}],[44,{name:"RGBA8I",size:4,isInt:!0}],[45,{name:"RGBA8U",size:4,isInt:!0}],[46,{name:"RGBA16I",size:8,isInt:!0}],[Vs,{name:"RGBA16U",size:8,isInt:!0}],[48,{name:"RGBA32I",size:16,isInt:!0}],[Hs,{name:"RGBA32U",size:16,isInt:!0}]]),js=t=>void 0!==Ws.get(t)?.blockSize,$s=t=>!0===Ws.get(t)?.srgb,Xs=t=>!0===Ws.get(t)?.isInt,qs=t=>Ws.get(t)?.srgbFormat||t,Ks=t=>{switch(t){case Rs:case 13:case Is:return Float32Array;case 36:case 42:case 48:return Int32Array;case zs:case Us:case Hs:return Uint32Array;case 34:case 40:case 46:return Int16Array;case 53:case 35:case 41:case Vs:case 3:case 4:case 5:case 50:case 51:case 11:case Ls:return Uint16Array;case 32:case 38:case 44:return Int8Array;default:return Uint8Array}},Ys="POSITION",Qs="NORMAL",Zs="TANGENT",Js="BLENDWEIGHT",tn="BLENDINDICES",en="COLOR",sn="TEXCOORD",nn="TEXCOORD0",rn="TEXCOORD1",an="TEXCOORD2",on="TEXCOORD3",ln="TEXCOORD4",hn="TEXCOORD5",cn="TEXCOORD6",dn="TEXCOORD7",un="ATTR8",fn="ATTR9",pn="ATTR11",mn="ATTR12",gn="ATTR13",_n="ATTR14",vn="ATTR15",yn="default",bn="rgbm",Sn="rgbe",xn="rgbp",wn="swizzleGGGR",Tn="2d",Cn="2d-array",En="cube",An="cube-array",Dn="3d",Pn="cube",Ln="equirect",In="glsl",Rn="wgsl",Mn=13,kn=14,On=26,Fn=27,Nn=28,Bn=29,zn=30,Un=33,Vn=36,Hn=["bool","int","float","vec2","vec3","vec4","ivec2","ivec3","ivec4","bvec2","bvec3","bvec4","mat2","mat3","mat4","sampler2D","samplerCube","","sampler2DShadow","samplerCubeShadow","sampler3D","","","","","sampler2DArray","uint","uvec2","uvec3","uvec4","","","","","","","","","","","","","isampler2D","usampler2D","isamplerCube","usamplerCube","isampler3D","usampler3D","isampler2DArray","usampler2DArray"],Gn=[["bool"],["i32"],["f32"],["vec2f","vec2<f32>"],["vec3f","vec3<f32>"],["vec4f","vec4<f32>"],["vec2i","vec2<i32>"],["vec3i","vec3<i32>"],["vec4i","vec4<i32>"],["vec2<bool>"],["vec3<bool>"],["vec4<bool>"],["mat2x2f","mat2x2<f32>"],["mat3x3f","mat3x3<f32>"],["mat4x4f","mat4x4<f32>"],["texture_2d<f32>"],["texture_cube<f32>"],["array<f32>"],["texture_depth_2d"],["texture_depth_cube"],["texture_3d<f32>"],["array<vec2<f32>>"],["array<vec3<f32>>"],["array<vec4<f32>>"],["array<mat4x4<f32>>"],["texture_2d_array<f32>"],["u32"],["vec2u","vec2<u32>"],["vec3u","vec3<u32>"],["vec4u","vec4<u32>"],["array<i32>"],["array<u32>"],["array<bool>"],["array<vec2i>","array<vec2<i32>>"],["array<vec2u>","array<vec2<u32>>"],["array<vec2b>","array<vec2<bool>>"],["array<vec3i>","array<vec3<i32>>"],["array<vec3u>","array<vec3<u32>>"],["array<vec3b>","array<vec3<bool>>"],["array<vec4i>","array<vec4<i32>>"],["array<vec4u>","array<vec4<u32>>"],["array<vec4b>","array<vec4<bool>>"],["texture_2d<i32>"],["texture_2d<u32>"],["texture_cube<i32>"],["texture_cube<u32>"],["texture_3d<i32>"],["texture_3d<u32>"],["texture_2d_array<i32>"],["texture_2d_array<u32>"]],Wn=new Map;Gn.forEach((t,e)=>{t.forEach(t=>Wn.set(t,e))});const jn="webgl2",$n="webgpu",Xn="null",qn="ldr_srgb",Kn=["view","mesh","mesh_ub"],Yn="default",Qn="_unused_float_uniform",Zn=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Uint16Array],Jn=[1,1,2,2,4,4,4,2],ti=[Uint8Array,Uint16Array,Uint32Array],ei=[1,2,4],si=new Map([["float","f32"],["vec2","vec2f"],["vec3","vec3f"],["vec4","vec4f"],["int","i32"],["ivec2","vec2i"],["ivec3","vec3i"],["ivec4","vec4i"],["uint","u32"],["uvec2","vec2u"],["uvec3","vec3u"],["uvec4","vec4u"]]),ni={};ni[Ys]=0,ni[Qs]=1,ni[Js]=2,ni[tn]=3,ni[en]=4,ni[nn]=5,ni[rn]=6,ni[an]=7,ni[on]=8,ni[ln]=9,ni[hn]=10,ni[cn]=11,ni[dn]=12,ni[Zs]=13,ni.ATTR0=0,ni.ATTR1=1,ni.ATTR2=2,ni.ATTR3=3,ni.ATTR4=4,ni.ATTR5=5,ni.ATTR6=6,ni.ATTR7=7,ni[un]=8,ni[fn]=9,ni.ATTR10=10,ni[pn]=11,ni[mn]=12,ni[gn]=13,ni[_n]=14,ni[vn]=15;let ii=0;class ri{constructor(t,e){this.slot=-1,this.scopeId=null,this.name=t,this.visibility=e}}class ai extends ri{}class oi extends ri{constructor(t,e,s=!1){super(t,e),this.format="",this.readOnly=s}}class li extends ri{constructor(t,e,s=Tn,n=0,i=!0,r=null){super(t,e),this.textureDimension=s,this.sampleType=n,this.hasSampler=i,this.samplerName=r??`${t}_sampler`}}class hi extends ri{constructor(t,e=7,s=Tn,n=!0,i=!1){super(t,4),this.format=e,this.textureDimension=s,this.write=n,this.read=i}}class ci{constructor(t,e){this.uniformBufferFormats=[],this.textureFormats=[],this.storageTextureFormats=[],this.storageBufferFormats=[],this.id=ii++;let s=0;e.forEach(t=>{t.slot=s++,t instanceof li&&t.hasSampler&&s++,t instanceof ai?this.uniformBufferFormats.push(t):t instanceof li?this.textureFormats.push(t):t instanceof hi?this.storageTextureFormats.push(t):t instanceof oi&&this.storageBufferFormats.push(t)}),this.device=t;const n=t.scope;this.bufferFormatsMap=new Map,this.uniformBufferFormats.forEach((t,e)=>this.bufferFormatsMap.set(t.name,e)),this.textureFormatsMap=new Map,this.textureFormats.forEach((t,e)=>{this.textureFormatsMap.set(t.name,e),t.scopeId=n.resolve(t.name)}),this.storageTextureFormatsMap=new Map,this.storageTextureFormats.forEach((t,e)=>{this.storageTextureFormatsMap.set(t.name,e),t.scopeId=n.resolve(t.name)}),this.storageBufferFormatsMap=new Map,this.storageBufferFormats.forEach((t,e)=>{this.storageBufferFormatsMap.set(t.name,e),t.scopeId=n.resolve(t.name)}),this.impl=t.createBindGroupFormatImpl(this)}destroy(){this.impl.destroy()}getTexture(t){const e=this.textureFormatsMap.get(t);return void 0!==e?this.textureFormats[e]:null}getStorageTexture(t){const e=this.storageTextureFormatsMap.get(t);return void 0!==e?this.storageTextureFormats[e]:null}loseContext(){}}class di{get(t,e){return this._cache.has(t)||(this._cache.set(t,e()),t.on("destroy",()=>{this.remove(t)}),t.on("devicelost",()=>{this._cache.get(t)?.loseContext?.(t)})),this._cache.get(t)}remove(t){this._cache.get(t)?.destroy?.(t),this._cache.delete(t)}constructor(){this._cache=new Map}}class ui{static calcLevelDimension(t,e){return Math.max(t>>e,1)}static calcMipLevelsCount(t,e,s=1){return 1+Math.floor(Math.log2(Math.max(t,e,s)))}static calcLevelGpuSize(t,e,s,n){const i=Ws.get(n),r=Ws.get(n)?.size??0;if(r>0)return t*e*s*r;const a=i.blockSize??0;let o=Math.floor((t+3)/4);const l=Math.floor((e+3)/4),h=Math.floor((s+3)/4);return n!==Ns&&n!==Bs||(o=Math.max(Math.floor(o/2),1)),o*l*h*a}static calcGpuSize(t,e,s,n,i,r){let a=0;for(;a+=ui.calcLevelGpuSize(t,e,s,n),i&&(1!==t||1!==e||1!==s);)t=Math.max(t>>1,1),e=Math.max(e>>1,1),s=Math.max(s>>1,1);return a*(r?6:1)}}let fi=0;class pi{constructor(t,e={}){this._gpuSize=0,this.id=fi++,this._invalid=!1,this._lockedLevel=-1,this._lockedMode=0,this.renderVersionDirty=0,this._storage=!1,this._numLevels=0,this.device=t,this.name=e.name??"",this._width=Math.floor(e.width??4),this._height=Math.floor(e.height??4),this._format=e.format??7,this._compressed=js(this._format),this._integerFormat=Xs(this._format),this._integerFormat&&(e.minFilter=0,e.magFilter=0),this._volume=e.volume??!1,this._depth=Math.floor(e.depth??1),this._arrayLength=Math.floor(e.arrayLength??0),this._storage=e.storage??!1,this._cubemap=e.cubemap??!1,this._flipY=e.flipY??!1,this._premultiplyAlpha=e.premultiplyAlpha??!1,this._mipmaps=e.mipmaps??!0,this._numLevelsRequested=e.numLevels,void 0!==e.numLevels&&(this._numLevels=e.numLevels),this._updateNumLevel(),this._minFilter=e.minFilter??5,this._magFilter=e.magFilter??1,this._anisotropy=e.anisotropy??1,this._addressU=e.addressU??0,this._addressV=e.addressV??0,this._addressW=e.addressW??0,this._compareOnRead=e.compareOnRead??!1,this._compareFunc=e.compareFunc??1,this._type=e.type??yn,this.projection="none",this._cubemap?this.projection=Pn:e.projection&&e.projection!==Pn&&(this.projection=e.projection),this._levels=e.levels;const s=!!e.levels;this._levels||this._clearLevels(),this.recreateImpl(s),t.textures.push(this)}destroy(){const t=this.device;if(t){const e=t.textures.indexOf(this);-1!==e&&t.textures.splice(e,1),t.scope.removeValue(this),this.impl.destroy(t),this.adjustVramSizeTracking(t._vram,-this._gpuSize),this._levels=null,this.device=null}}recreateImpl(t=!0){const{device:e}=this;this.impl?.destroy(e),this.impl=null,this.impl=e.createTextureImpl(this),this.dirtyAll(),t&&this.upload()}_clearLevels(){this._levels=this._cubemap?[[null,null,null,null,null,null]]:[null]}resize(t,e,s=1){if(this.width!==t||this.height!==e||this.depth!==s){const n=this.device;this.adjustVramSizeTracking(n._vram,-this._gpuSize),this._gpuSize=0,this.impl.destroy(n),this._clearLevels(),this._width=Math.floor(t),this._height=Math.floor(e),this._depth=Math.floor(s),this._updateNumLevel(),this.impl=n.createTextureImpl(this),this.dirtyAll()}}loseContext(){this.impl.loseContext(),this.dirtyAll()}adjustVramSizeTracking(t,e){t.tex+=e}propertyChanged(t){this.impl.propertyChanged(t),this.renderVersionDirty=this.device.renderVersion}_updateNumLevel(){const t=this.mipmaps?ui.calcMipLevelsCount(this.width,this.height):1,e=this._numLevelsRequested;this._numLevels=Math.min(e??t,t),this._mipmaps=this._numLevels>1}get lockedMode(){return this._lockedMode}set minFilter(t){this._minFilter!==t&&(Xs(this._format)||(this._minFilter=t,this.propertyChanged(1)))}get minFilter(){return this._minFilter}set magFilter(t){this._magFilter!==t&&(Xs(this._format)||(this._magFilter=t,this.propertyChanged(2)))}get magFilter(){return this._magFilter}set addressU(t){this._addressU!==t&&(this._addressU=t,this.propertyChanged(4))}get addressU(){return this._addressU}set addressV(t){this._addressV!==t&&(this._addressV=t,this.propertyChanged(8))}get addressV(){return this._addressV}set addressW(t){this._volume&&t!==this._addressW&&(this._addressW=t,this.propertyChanged(16))}get addressW(){return this._addressW}set compareOnRead(t){this._compareOnRead!==t&&(this._compareOnRead=t,this.propertyChanged(32))}get compareOnRead(){return this._compareOnRead}set compareFunc(t){this._compareFunc!==t&&(this._compareFunc=t,this.propertyChanged(64))}get compareFunc(){return this._compareFunc}set anisotropy(t){this._anisotropy!==t&&(this._anisotropy=t,this.propertyChanged(128))}get anisotropy(){return this._anisotropy}set mipmaps(t){this._mipmaps!==t&&(this.device.isWebGPU||Xs(this._format)||(this._mipmaps=t),t&&(this._needsMipmapsUpload=!0))}get mipmaps(){return this._mipmaps}get numLevels(){return this._numLevels}get storage(){return this._storage}get width(){return this._width}get height(){return this._height}get depth(){return this._depth}get format(){return this._format}get cubemap(){return this._cubemap}get gpuSize(){const t=this.pot&&this._mipmaps&&!(this._compressed&&1===this._levels.length);return ui.calcGpuSize(this._width,this._height,this._depth,this._format,t,this._cubemap)}get array(){return this._arrayLength>0}get arrayLength(){return this._arrayLength}get volume(){return this._volume}set type(t){this._type!==t&&(this._type=t,this.device._shadersDirty=!0)}get type(){return this._type}set srgb(t){if(t!==$s(this.format))if(t){const t=qs(this.format);this._format!==t&&(this._format=t,this.recreateImpl(),this.device._shadersDirty=!0)}else{const t=(t=>{for(const[e,s]of Ws)if(s.srgbFormat===t)return e;return t})(this.format);this._format!==t&&(this._format=t,this.recreateImpl(),this.device._shadersDirty=!0)}}get srgb(){return $s(this.format)}set flipY(t){this._flipY!==t&&(this._flipY=t,this._needsUpload=!0)}get flipY(){return this._flipY}set premultiplyAlpha(t){this._premultiplyAlpha!==t&&(this._premultiplyAlpha=t,this._needsUpload=!0)}get premultiplyAlpha(){return this._premultiplyAlpha}get pot(){return Qe.powerOfTwo(this._width)&&Qe.powerOfTwo(this._height)}get encoding(){switch(this.type){case bn:return"rgbm";case Sn:return"rgbe";case xn:return"rgbp"}return(t=>{const e=Ws.get(t);return!(!e?.ldr||e?.srgb)})(this.format)?"srgb":"linear"}dirtyAll(){this._levelsUpdated=this._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0],this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps,this._mipmapsUploaded=!1,this.propertyChanged(255)}lock(t={}){t.level??=0,t.face??=0,t.mode??=2,this._lockedMode=t.mode,this._lockedLevel=t.level;const e=this.cubemap?this._levels[t.face]:this._levels;if(null===e[t.level]){const s=Math.max(1,this._width>>t.level),n=Math.max(1,this._height>>t.level),i=Math.max(1,this._depth>>t.level),r=new ArrayBuffer(ui.calcLevelGpuSize(s,n,i,this._format));e[t.level]=new(Ks(this._format))(r)}return e[t.level]}setSource(t,e=0){let s,n,i=!1;if(this._cubemap){if(t[0]){s=t[0].width||0,n=t[0].height||0;for(let e=0;e<6;e++){const r=t[e];if(!r||r.width!==s||r.height!==n||!this.device._isBrowserInterface(r)){i=!0;break}}}else i=!0;if(!i)for(let s=0;s<6;s++)this._levels[e][s]!==t[s]&&(this._levelsUpdated[e][s]=!0)}else this.device._isBrowserInterface(t)||(i=!0),i||(t!==this._levels[e]&&(this._levelsUpdated[e]=!0),t instanceof HTMLVideoElement?(s=t.videoWidth,n=t.videoHeight):(s=t.width,n=t.height));if(i)if(this._width=4,this._height=4,this._cubemap)for(let t=0;t<6;t++)this._levels[e][t]=null,this._levelsUpdated[e][t]=!0;else this._levels[e]=null,this._levelsUpdated[e]=!0;else 0===e&&(this._width=s,this._height=n),this._levels[e]=t;this._invalid===i&&i||(this._invalid=i,this.upload())}getSource(t=0){return this._levels[t]}unlock(){2===this._lockedMode&&this.upload(),this._lockedLevel=-1,this._lockedMode=0}upload(){this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps,this.impl.uploadImmediate?.(this.device,this)}read(t,e,s,n,i={}){return this.impl.read?.(t,e,s,n,i)}write(t,e,s,n,i){return this.impl.write?.(t,e,s,n,i)}}const mi={white:[255,255,255,255],gray:[128,128,128,255],black:[0,0,0,255],normal:[128,128,255,255],pink:[255,128,255,255]};class gi{destroy(){this.map.forEach(t=>{t.destroy()})}constructor(){this.map=new Map}}const _i=new di,vi=(t,e)=>{const s=_i.get(t,()=>new gi);if(!s.map.has(e)){const n=new pi(t,{name:`built-in-texture-${e}`,width:1,height:1,format:7}),i=n.lock(),r=mi[e];i.set(r),n.unlock(),s.map.set(e,n)}return s.map.get(e)};let yi=0;class bi{constructor(){this.offsets=[]}}class Si{constructor(t,e,s){this.renderVersionUpdated=-1,this.uniformBufferOffsets=[],this.id=yi++,this.device=t,this.format=e,this.dirty=!0,this.impl=t.createBindGroupImpl(this),this.textures=[],this.storageTextures=[],this.storageBuffers=[],this.uniformBuffers=[],this.defaultUniformBuffer=s,s&&this.setUniformBuffer(Yn,s)}destroy(){this.impl.destroy(),this.impl=null,this.format=null,this.defaultUniformBuffer=null}setUniformBuffer(t,e){const s=this.format.bufferFormatsMap.get(t);this.uniformBuffers[s]!==e&&(this.uniformBuffers[s]=e,this.dirty=!0)}setStorageBuffer(t,e){const s=this.format.storageBufferFormatsMap.get(t);this.storageBuffers[s]!==e&&(this.storageBuffers[s]=e,this.dirty=!0)}setTexture(t,e){const s=this.format.textureFormatsMap.get(t);this.textures[s]!==e?(this.textures[s]=e,this.dirty=!0):this.renderVersionUpdated<e.renderVersionDirty&&(this.dirty=!0)}setStorageTexture(t,e){const s=this.format.storageTextureFormatsMap.get(t);this.storageTextures[s]!==e?(this.storageTextures[s]=e,this.dirty=!0):this.renderVersionUpdated<e.renderVersionDirty&&(this.dirty=!0)}updateUniformBuffers(){for(let t=0;t<this.uniformBuffers.length;t++)this.uniformBuffers[t].update()}update(){const{textureFormats:t,storageTextureFormats:e,storageBufferFormats:s}=this.format;for(let e=0;e<t.length;e++){const s=t[e];let n=s.scopeId.value;n||("uSceneDepthMap"===s.name&&(n=vi(this.device,"white")),"uSceneColorMap"===s.name&&(n=vi(this.device,"pink")),n||(n=vi(this.device,"pink"))),this.setTexture(s.name,n)}for(let t=0;t<e.length;t++){const s=e[t],n=s.scopeId.value;this.setStorageTexture(s.name,n)}for(let t=0;t<s.length;t++){const e=s[t],n=e.scopeId.value;this.setStorageBuffer(e.name,n)}this.uniformBufferOffsets.length=this.uniformBuffers.length;for(let t=0;t<this.uniformBuffers.length;t++){const e=this.uniformBuffers[t];this.uniformBufferOffsets[t]=e.offset,this.renderVersionUpdated<e.renderVersionDirty&&(this.dirty=!0)}this.dirty&&(this.dirty=!1,this.renderVersionUpdated=this.device.renderVersion,this.impl.update(this))}}const xi={set:(t,e,s,n=1)=>t&~(n<<s)|e<<s,get:(t,e,s=1)=>t>>e&s,all(t,e,s=1){const n=s<<e;return(t&n)===n},any:(t,e,s=1)=>0!==(t&s<<e)},wi=15;class Ti{constructor(t=!1,e=0,s=1,n=0,i,r,a,o=!0,l=!0,h=!0,c=!0){this.target0=0,this.setColorBlend(e,s,n),this.setAlphaBlend(i??e,r??s,a??n),this.setColorWrite(o,l,h,c),this.blend=t}set blend(t){this.target0=xi.set(this.target0,t?1:0,26)}get blend(){return xi.all(this.target0,26)}setColorBlend(t,e,s){this.target0=xi.set(this.target0,t,0,7),this.target0=xi.set(this.target0,e,3,wi),this.target0=xi.set(this.target0,s,7,wi)}setAlphaBlend(t,e,s){this.target0=xi.set(this.target0,t,11,7),this.target0=xi.set(this.target0,e,14,wi),this.target0=xi.set(this.target0,s,18,wi)}setColorWrite(t,e,s,n){this.redWrite=t,this.greenWrite=e,this.blueWrite=s,this.alphaWrite=n}get colorOp(){return xi.get(this.target0,0,7)}get colorSrcFactor(){return xi.get(this.target0,3,wi)}get colorDstFactor(){return xi.get(this.target0,7,wi)}get alphaOp(){return xi.get(this.target0,11,7)}get alphaSrcFactor(){return xi.get(this.target0,14,wi)}get alphaDstFactor(){return xi.get(this.target0,18,wi)}set redWrite(t){this.target0=xi.set(this.target0,t?1:0,22)}get redWrite(){return xi.all(this.target0,22)}set greenWrite(t){this.target0=xi.set(this.target0,t?1:0,23)}get greenWrite(){return xi.all(this.target0,23)}set blueWrite(t){this.target0=xi.set(this.target0,t?1:0,24)}get blueWrite(){return xi.all(this.target0,24)}set alphaWrite(t){this.target0=xi.set(this.target0,t?1:0,25)}get alphaWrite(){return xi.all(this.target0,25)}get allWrite(){return xi.get(this.target0,22,15)}copy(t){return this.target0=t.target0,this}clone(){return(new this.constructor).copy(this)}get key(){return this.target0}equals(t){return this.target0===t.target0}static{this.NOBLEND=Object.freeze(new Ti)}static{this.NOWRITE=Object.freeze(new Ti(void 0,void 0,void 0,void 0,void 0,void 0,void 0,!1,!1,!1,!1))}static{this.ALPHABLEND=Object.freeze(new Ti(!0,0,6,8))}static{this.ADDBLEND=Object.freeze(new Ti(!0,0,1,1))}}class Ci{get(t){let e=this.map.get(t);return void 0===e&&(e=this.id++,this.map.set(t,e)),e}constructor(){this.map=new Map,this.id=0}}const Ei=new Ci;class Ai{constructor(t=3,e=!0){this.data=0,this._depthBias=0,this._depthBiasSlope=0,this.key=0,this.func=t,this.write=e}set test(t){this.func=t?3:7,this.updateKey()}get test(){return 7!==this.func}set write(t){this.data=xi.set(this.data,t?1:0,3),this.updateKey()}get write(){return xi.all(this.data,3)}set func(t){this.data=xi.set(this.data,t,0,7),this.updateKey()}get func(){return xi.get(this.data,0,7)}set depthBias(t){this._depthBias=t,this.updateKey()}get depthBias(){return this._depthBias}set depthBiasSlope(t){this._depthBiasSlope=t,this.updateKey()}get depthBiasSlope(){return this._depthBiasSlope}copy(t){return this.data=t.data,this._depthBias=t._depthBias,this._depthBiasSlope=t._depthBiasSlope,this.key=t.key,this}clone(){return(new this.constructor).copy(this)}updateKey(){const{data:t,_depthBias:e,_depthBiasSlope:s}=this,n=`${t}-${e}-${s}`;this.key=Ei.get(n)}equals(t){return this.key===t.key}static{this.DEFAULT=Object.freeze(new Ai)}static{this.NODEPTH=Object.freeze(new Ai(7,!1))}static{this.WRITEDEPTH=Object.freeze(new Ai(7,!0))}}class Di{equals(t){return this.globalId===t.globalId&&this.revision===t.revision}copy(t){this.globalId=t.globalId,this.revision=t.revision}reset(){this.globalId=0,this.revision=0}constructor(){this.globalId=0,this.revision=0}}let Pi=0;class Li{constructor(){Pi++,this.version=new Di,this.version.globalId=Pi}increment(){this.version.revision++}}class Ii{constructor(t){this.name=t,this.value=null,this.versionObject=new Li}toJSON(t){}setValue(t){this.value=t,this.versionObject.increment()}getValue(){return this.value}}class Ri{constructor(t){this.name=t,this.variables=new Map}resolve(t){return this.variables.has(t)||this.variables.set(t,new Ii(t)),this.variables.get(t)}removeValue(t){for(const e in this.variables){const s=this.variables[e];s.value===t&&(s.value=null)}}}let Mi=0;class ki{constructor(t,e,s,n){this.usage=0,this.usage=n?.usage??0,this.device=t,this.format=e,this.numVertices=s,this.id=Mi++,this.impl=t.createVertexBufferImpl(this,e,n),this.numBytes=e.verticesByteSize?e.verticesByteSize:e.size*s,this.adjustVramSizeTracking(t._vram,this.numBytes);const i=n?.data;i?this.setData(i):this.storage=new ArrayBuffer(this.numBytes),this.device.buffers.push(this)}destroy(){const t=this.device,e=t.buffers.indexOf(this);-1!==e&&t.buffers.splice(e,1),this.impl.initialized&&(this.impl.destroy(t),this.adjustVramSizeTracking(t._vram,-this.storage.byteLength))}adjustVramSizeTracking(t,e){t.vb+=e}loseContext(){this.impl.loseContext()}getFormat(){return this.format}getUsage(){return this.usage}getNumVertices(){return this.numVertices}lock(){return this.storage}unlock(){this.impl.unlock(this)}setData(t){return t.byteLength===this.numBytes&&(this.storage=t,this.unlock(),!0)}}function Oi(t){if(null==t)return 0;let e=0;for(let s=0,n=t.length;s<n;s++)e=(e<<5)-e+t.charCodeAt(s),e|=0;return e}function Fi(t){let e=2166136261;for(let s=0;s<t.length;s++)e^=t[s],e*=16777619;return e>>>0}const Ni=new Ci,Bi=[2,4,8,12,16],zi=new di;class Ui{constructor(t,e,s){this.device=t,this._elements=[],this.hasUv0=!1,this.hasUv1=!1,this.hasColor=!1,this.hasTangents=!1,this.verticesByteSize=0,this.vertexCount=s,this.interleaved=void 0===s,this.instancing=!1,this.size=e.reduce((t,e)=>t+4*Math.ceil(e.components*Jn[e.type]/4),0);let n,i=0;for(let t=0,r=e.length;t<r;t++){const r=e[t];n=r.components*Jn[r.type],s&&(i=Qe.roundUp(i,n));const a=r.asInt??!1,o=!a&&(r.normalize??!1),l={name:r.semantic,offset:s?i:r.hasOwnProperty("offset")?r.offset:i,stride:s?n:r.hasOwnProperty("stride")?r.stride:this.size,dataType:r.type,numComponents:r.components,normalize:o,size:n,asInt:a};this._elements.push(l),i+=s?n*s:4*Math.ceil(n/4),r.semantic===nn?this.hasUv0=!0:r.semantic===rn?this.hasUv1=!0:r.semantic===en?this.hasColor=!0:r.semantic===Zs&&(this.hasTangents=!0)}s&&(this.verticesByteSize=i),this._evaluateHash()}get elements(){return this._elements}static getDefaultInstancingFormat(t){return zi.get(t,()=>new Ui(t,[{semantic:pn,components:4,type:6},{semantic:mn,components:4,type:6},{semantic:_n,components:4,type:6},{semantic:vn,components:4,type:6}]))}static isElementValid(t,e){const s=e.components*Jn[e.type];return!(t.isWebGPU&&!Bi.includes(s))}update(){this._evaluateHash()}_evaluateHash(){const t=[],e=[],s=this._elements.length;for(let n=0;n<s;n++){const{name:s,dataType:i,numComponents:r,normalize:a,offset:o,stride:l,size:h,asInt:c}=this._elements[n],d=s+i+r+a+c;t.push(d);const u=d+o+l+h;e.push(u)}t.sort();const n=t.join();this.batchingHash=Oi(n),this.shaderProcessingHashString=n,this.renderingHashString=e.join("_"),this.renderingHash=Ni.get(this.renderingHashString)}}const Vi=new Ci;class Hi{set func(t){this._func=t,this._dirty=!0}get func(){return this._func}set ref(t){this._ref=t,this._dirty=!0}get ref(){return this._ref}set fail(t){this._fail=t,this._dirty=!0}get fail(){return this._fail}set zfail(t){this._zfail=t,this._dirty=!0}get zfail(){return this._zfail}set zpass(t){this._zpass=t,this._dirty=!0}get zpass(){return this._zpass}set readMask(t){this._readMask=t,this._dirty=!0}get readMask(){return this._readMask}set writeMask(t){this._writeMask=t,this._dirty=!0}get writeMask(){return this._writeMask}constructor(t={}){this._dirty=!0,this._func=t.func??7,this._ref=t.ref??0,this._readMask=t.readMask??255,this._writeMask=t.writeMask??255,this._fail=t.fail??0,this._zfail=t.zfail??0,this._zpass=t.zpass??0,this._evalKey()}_evalKey(){const{_func:t,_ref:e,_fail:s,_zfail:n,_zpass:i,_readMask:r,_writeMask:a}=this,o=`${t},${e},${s},${n},${i},${r},${a}`;this._key=Vi.get(o),this._dirty=!1}get key(){return this._dirty&&this._evalKey(),this._key}copy(t){return this._func=t._func,this._ref=t._ref,this._readMask=t._readMask,this._writeMask=t._writeMask,this._fail=t._fail,this._zfail=t._zfail,this._zpass=t._zpass,this._dirty=t._dirty,this._key=t._key,this}clone(){return(new this.constructor).copy(this)}static{this.DEFAULT=Object.freeze(new Hi)}}class Gi extends Ve{static{this.EVENT_RESIZE="resizecanvas"}constructor(t,e){super(),this.backBuffer=null,this.backBufferSize=new os,this.backBufferAntialias=!1,this.isWebGPU=!1,this.isWebGL2=!1,this.isNull=!1,this.isHdr=!1,this.maxIndirectDrawCount=1024,this.maxColorAttachments=1,this.maxSamples=1,this.supportsMultiDraw=!0,this.supportsCompute=!1,this.supportsStorageTextureRead=!1,this.renderTarget=null,this.shaders=[],this.textures=[],this.targets=new Set,this.renderVersion=0,this.insideRenderPass=!1,this.supportsUniformBuffers=!1,this.supportsClipDistances=!1,this.textureRG11B10Renderable=!1,this.textureFloatFilterable=!1,this.blendState=new Ti,this.depthState=new Ai,this.stencilEnabled=!1,this.stencilFront=new Hi,this.stencilBack=new Hi,this._destroyed=!1,this.defaultClearOptions={color:[0,0,0,1],depth:1,stencil:0,flags:3},this.clientRect={width:0,height:0},this._shadersDirty=!1,this.capsDefines=new Map,this.mapsToClear=new Set,this.canvas=t,"setAttribute"in t&&t.setAttribute("data-engine",`PlayCanvas ${Pe}`),this.initOptions={...e},this.initOptions.alpha??=!0,this.initOptions.depth??=!0,this.initOptions.stencil??=!0,this.initOptions.antialias??=!0,this.initOptions.powerPreference??="high-performance",this.initOptions.displayFormat??="ldr",this._maxPixelRatio=ze.browser?Math.min(1,window.devicePixelRatio):1,this.buffers=[],this._vram={tex:0,vb:0,ib:0,ub:0,sb:0},this._shaderStats={vsCompiled:0,fsCompiled:0,linked:0,materialShaders:0,compileTime:0},this.initializeContextCaches(),this._drawCallsPerFrame=0,this._shaderSwitchesPerFrame=0,this._primsPerFrame=[];for(let t=0;t<=6;t++)this._primsPerFrame[t]=0;this._renderTargetCreationTime=0,this.scope=new Ri("Device"),this.textureBias=this.scope.resolve("textureBias"),this.textureBias.setValue(0)}postInit(){const t=new Ui(this,[{semantic:Ys,components:2,type:6}]),e=new Float32Array([-1,-1,1,-1,-1,1,1,1]);this.quadVertexBuffer=new ki(this,t,4,{data:e})}initCapsDefines(){const{capsDefines:t}=this;t.clear(),this.textureFloatFilterable&&t.set("CAPS_TEXTURE_FLOAT_FILTERABLE",""),this.textureFloatRenderable&&t.set("CAPS_TEXTURE_FLOAT_RENDERABLE",""),this.supportsMultiDraw&&t.set("CAPS_MULTI_DRAW",""),ze.desktop&&t.set("PLATFORM_DESKTOP",""),ze.mobile&&t.set("PLATFORM_MOBILE",""),ze.android&&t.set("PLATFORM_ANDROID",""),ze.ios&&t.set("PLATFORM_IOS","")}destroy(){this.fire("destroy"),this.quadVertexBuffer?.destroy(),this.quadVertexBuffer=null,this.dynamicBuffers?.destroy(),this.dynamicBuffers=null,this.gpuProfiler?.destroy(),this.gpuProfiler=null,this._destroyed=!0}onDestroyShader(t){this.fire("destroy:shader",t);const e=this.shaders.indexOf(t);-1!==e&&this.shaders.splice(e,1)}postDestroy(){this.scope=null,this.canvas=null}loseContext(){this.contextLost=!0,this.backBufferSize.set(-1,-1);for(const t of this.textures)t.loseContext();for(const t of this.buffers)t.loseContext();for(const t of this.targets)t.loseContext();this.gpuProfiler?.loseContext()}restoreContext(){this.contextLost=!1,this.initializeRenderState(),this.initializeContextCaches();for(const t of this.buffers)t.unlock();this.gpuProfiler?.restoreContext?.()}toJSON(t){}initializeContextCaches(){this.vertexBuffers=[],this.shader=null,this.shaderValid=void 0,this.shaderAsyncCompile=!1,this.renderTarget=null}initializeRenderState(){this.blendState=new Ti,this.depthState=new Ai,this.cullMode=1,this.vx=this.vy=this.vw=this.vh=0,this.sx=this.sy=this.sw=this.sh=0,this.blendColor=new Ze(0,0,0,0)}setStencilState(t,e){}setBlendState(t){}setBlendColor(t,e,s,n){}setDepthState(t){}setCullMode(t){}setRenderTarget(t){this.renderTarget=t}setVertexBuffer(t){t&&this.vertexBuffers.push(t)}clearVertexBuffer(){this.vertexBuffers.length=0}getIndirectDrawSlot(t=1){return 0}get indirectDrawBuffer(){return null}getRenderTarget(){return this.renderTarget}initRenderTarget(t){t.initialized||(t.init(),this.targets.add(t))}draw(t,e,s,n,i=!0,r=!0){}_isBrowserInterface(t){return this._isImageBrowserInterface(t)||this._isImageCanvasInterface(t)||this._isImageVideoInterface(t)}_isImageBrowserInterface(t){return"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap||"undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement}_isImageCanvasInterface(t){return"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement}_isImageVideoInterface(t){return"undefined"!=typeof HTMLVideoElement&&t instanceof HTMLVideoElement}resizeCanvas(t,e){const s=Math.min(this._maxPixelRatio,ze.browser?window.devicePixelRatio:1),n=Math.floor(t*s),i=Math.floor(e*s);n===this.canvas.width&&i===this.canvas.height||this.setResolution(n,i)}setResolution(t,e){this.canvas.width=t,this.canvas.height=e,this.fire(Gi.EVENT_RESIZE,t,e)}update(){this.updateClientRect()}updateClientRect(){if(ze.worker)this.clientRect.width=this.canvas.width,this.clientRect.height=this.canvas.height;else{const t=this.canvas.getBoundingClientRect();this.clientRect.width=t.width,this.clientRect.height=t.height}}get width(){return this.canvas.width}get height(){return this.canvas.height}set fullscreen(t){}get fullscreen(){return!1}set maxPixelRatio(t){this._maxPixelRatio=t}get maxPixelRatio(){return this._maxPixelRatio}get deviceType(){return this._deviceType}startRenderPass(t){}endRenderPass(t){}startComputePass(t){}endComputePass(){}frameStart(){this.renderPassIndex=0,this.renderVersion++}frameEnd(){this.mapsToClear.forEach(t=>t.clear()),this.mapsToClear.clear()}computeDispatch(t,e="Unnamed"){}getRenderableHdrFormat(t=[Os,Ls,Is],e=!0,s=1){for(let n=0;n<t.length;n++){const i=t[n];switch(i){case Os:if(this.textureRG11B10Renderable)return i;break;case Ls:if(this.textureHalfFloatRenderable)return i;break;case Is:if(this.isWebGPU&&s>1)continue;if(this.textureFloatRenderable&&(!e||this.textureFloatFilterable))return i}}}validateAttributes(t,e,s){}}let Wi=0;class ji{constructor(t={}){this.id=Wi++;const e=t.colorBuffer?.device??t.colorBuffers?.[0].device??t.depthBuffer?.device??t.graphicsDevice;this._device=e;const{maxSamples:s}=this._device;if(this._samples=Math.min(t.samples??1,s),e.isWebGPU&&(this._samples=this._samples>1?s:1),this._colorBuffer=t.colorBuffer,t.colorBuffer&&(this._colorBuffers=[t.colorBuffer]),this._depthBuffer=t.depthBuffer,this._face=t.face??0,this._depthBuffer){const t=this._depthBuffer._format;t===Ms||t===Gs?(this._depth=!0,this._stencil=!1):t===ks?(this._depth=!0,this._stencil=!0):t===Rs&&this._depthBuffer.device.isWebGPU&&this._samples>1?(this._depth=!0,this._stencil=!1):(this._depth=!1,this._stencil=!1)}else this._depth=t.depth??!0,this._stencil=t.stencil??!1;t.colorBuffers&&(this._colorBuffers||(this._colorBuffers=[...t.colorBuffers],this._colorBuffer=t.colorBuffers[0])),this.autoResolve=t.autoResolve??!0,this.name=t.name,this.name||(this.name=this._colorBuffer?.name),this.name||(this.name=this._depthBuffer?.name),this.name||(this.name="Untitled"),this.flipY=t.flipY??!1,this._mipLevel=t.mipLevel??0,this._mipLevel>0&&this._depth&&(this._mipLevel=0),this._mipmaps=void 0===t.mipLevel,this.evaluateDimensions(),this.validateMrt(),this.impl=e.createRenderTargetImpl(this)}destroy(){const t=this._device;t&&(t.targets.delete(this),t.renderTarget===this&&t.setRenderTarget(null),this.destroyFrameBuffers())}destroyFrameBuffers(){const t=this._device;t&&this.impl.destroy(t)}destroyTextureBuffers(){this._depthBuffer?.destroy(),this._depthBuffer=null,this._colorBuffers?.forEach(t=>{t.destroy()}),this._colorBuffers=null,this._colorBuffer=null}resize(t,e){if(!(this.mipLevel>0)&&(this._depthBuffer?.resize(t,e),this._colorBuffers?.forEach(s=>{s.resize(t,e)}),this._width!==t||this._height!==e)){this.destroyFrameBuffers();const t=this._device;t.renderTarget===this&&t.setRenderTarget(null),this.evaluateDimensions(),this.validateMrt(),this.impl=t.createRenderTargetImpl(this)}}validateMrt(){}evaluateDimensions(){const t=this._colorBuffer??this._depthBuffer;t&&(this._width=t.width,this._height=t.height,this._mipLevel>0&&(this._width=ui.calcLevelDimension(this._width,this._mipLevel),this._height=ui.calcLevelDimension(this._height,this._mipLevel)))}init(){this.impl.init(this._device,this)}get initialized(){return this.impl.initialized}get device(){return this._device}loseContext(){this.impl.loseContext()}resolve(t=!0,e=!!this._depthBuffer){this._device&&this._samples>1&&this.impl.resolve(this._device,this,t,e)}copy(t,e,s){if(!this._device){if(!t._device)return!1;this._device=t._device}return this._device.copyRenderTarget(t,this,e,s)}get samples(){return this._samples}get depth(){return this._depth}get stencil(){return this._stencil}get colorBuffer(){return this._colorBuffer}getColorBuffer(t){return this._colorBuffers?.[t]}get depthBuffer(){return this._depthBuffer}get face(){return this._face}get mipLevel(){return this._mipLevel}get mipmaps(){return this._mipmaps}get width(){return this._width??this._device.width}get height(){return this._height??this._device.height}isColorBufferSrgb(t=0){if(this.device.backBuffer===this)return $s(this.device.backBufferFormat);const e=this.getColorBuffer(t);return!!e&&$s(e.format)}}class $i{update(t){this.destroy();const e=t.device,s=this.createDescriptor(e,t);this.bindGroup=e.wgpu.createBindGroup(s)}destroy(){this.bindGroup=null}createDescriptor(t,e){const s=[],n=e.format,i=e.format.uniformBufferFormats;e.uniformBuffers.forEach((t,e)=>{const n=i[e].slot,r=t.persistent?t.impl.buffer:t.allocation.gpuBuffer.buffer;s.push({binding:n,resource:{buffer:r,offset:0,size:t.format.byteSize}})});const r=e.format.textureFormats;e.textures.forEach((e,i)=>{const a=e.impl,o=n.textureFormats[i],l=r[i].slot,h=a.getView(t);if(s.push({binding:l,resource:h}),o.hasSampler){const e=a.getSampler(t,o.sampleType);s.push({binding:l+1,resource:e})}});const a=e.format.storageTextureFormats;e.storageTextures.forEach((e,n)=>{const i=e.impl,r=a[n].slot,o=i.getView(t);s.push({binding:r,resource:o})});const o=e.format.storageBufferFormats;e.storageBuffers.forEach((t,e)=>{const n=t.impl.buffer,i=o[e].slot;s.push({binding:i,resource:{buffer:n}})});return{layout:e.format.impl.bindGroupLayout,entries:s}}}class Xi{static shaderStage(t){let e=0;return 1&t&&(e|=GPUShaderStage.VERTEX),2&t&&(e|=GPUShaderStage.FRAGMENT),4&t&&(e|=GPUShaderStage.COMPUTE),e}}const qi=[];qi[0]="",qi[1]="",qi[2]="",qi[52]="r8unorm",qi[53]="rg8unorm",qi[3]="",qi[4]="",qi[5]="",qi[6]="rgba8unorm",qi[7]="rgba8unorm",qi[8]="bc1-rgba-unorm",qi[9]="bc2-rgba-unorm",qi[10]="bc3-rgba-unorm",qi[11]="",qi[12]="rgba16float",qi[50]="r16float",qi[51]="rg16float",qi[13]="",qi[14]="rgba32float",qi[15]="r32float",qi[16]="depth32float",qi[69]="depth16unorm",qi[17]="depth24plus-stencil8",qi[18]="rg11b10ufloat",qi[19]="",qi[20]="rgba8unorm-srgb",qi[21]="",qi[22]="etc2-rgb8unorm",qi[23]="etc2-rgba8unorm",qi[24]="",qi[25]="",qi[26]="",qi[27]="",qi[28]="astc-4x4-unorm",qi[29]="",qi[30]="",qi[31]="bgra8unorm",qi[64]="bgra8unorm-srgb",qi[32]="r8sint",qi[33]="r8uint",qi[34]="r16sint",qi[35]="r16uint",qi[36]="r32sint",qi[37]="r32uint",qi[38]="rg8sint",qi[39]="rg8uint",qi[40]="rg16sint",qi[41]="rg16uint",qi[42]="rg32sint",qi[43]="rg32uint",qi[44]="rgba8sint",qi[45]="rgba8uint",qi[46]="rgba16sint",qi[47]="rgba16uint",qi[48]="rgba32sint",qi[49]="rgba32uint",qi[65]="bc6h-rgb-float",qi[66]="bc6h-rgb-ufloat",qi[67]="bc7-rgba-unorm",qi[54]="bc1-rgba-unorm-srgb",qi[55]="bc2-rgba-unorm-srgb",qi[56]="bc3-rgba-unorm-srgb",qi[61]="etc2-rgb8unorm-srgb",qi[62]="etc2-rgba8unorm-srgb",qi[68]="bc7-rgba-unorm-srgb",qi[63]="astc-4x4-unorm-srgb";const Ki=[];Ki[0]="filtering",Ki[1]="non-filtering",Ki[2]="comparison",Ki[3]="comparison",Ki[4]="comparison";const Yi=[];Yi[0]="float",Yi[1]="unfilterable-float",Yi[2]="depth",Yi[3]="sint",Yi[4]="uint";const Qi=new Ci;class Zi{constructor(t){const e=t.device,{key:s,desc:n}=this.createDescriptor(t);this.key=Qi.get(s),this.bindGroupLayout=e.wgpu.createBindGroupLayout(n)}destroy(){this.bindGroupLayout=null}loseContext(){}createDescriptor(t){const e=[];let s="";t.uniformBufferFormats.forEach(t=>{const n=Xi.shaderStage(t.visibility);s+=`#${t.slot}U:${n}`,e.push({binding:t.slot,visibility:n,buffer:{type:"uniform",hasDynamicOffset:!0}})}),t.textureFormats.forEach(t=>{const n=Xi.shaderStage(t.visibility),i=t.sampleType,r=t.textureDimension,a=!1,o=Yi[i];if(s+=`#${t.slot}T:${n}-${o}-${r}-false`,e.push({binding:t.slot,visibility:n,texture:{sampleType:o,viewDimension:r,multisampled:a}}),t.hasSampler){const r=Ki[i];s+=`#${t.slot+1}S:${n}-${r}`,e.push({binding:t.slot+1,visibility:n,sampler:{type:r}})}}),t.storageTextureFormats.forEach(t=>{const{format:n,textureDimension:i}=t,{read:r,write:a}=t;s+=`#${t.slot}ST:${n}-${i}-${r?"r1":"r0"}-${a?"w1":"w0"}`,e.push({binding:t.slot,visibility:GPUShaderStage.COMPUTE,storageTexture:{access:r?a?"read-write":"read-only":"write-only",format:qi[n],viewDimension:i}})}),t.storageBufferFormats.forEach(t=>{const n=t.readOnly,i=Xi.shaderStage(t.visibility);s+=`#${t.slot}SB:${i}-${n?"ro":"rw"}`,e.push({binding:t.slot,visibility:i,buffer:{type:n?"read-only-storage":"storage"}})});return{key:s,desc:{entries:e}}}}class Ji{constructor(t=0){this.buffer=null,this.usageFlags=0,this.usageFlags=t}destroy(t){this.buffer&&(this.buffer.destroy(),this.buffer=null)}get initialized(){return!!this.buffer}loseContext(){}allocate(t,e){this.buffer=t.wgpu.createBuffer({size:e,usage:this.usageFlags})}unlock(t,e){const s=t.wgpu;if(!this.buffer){const s=e.byteLength+3&-4;this.usageFlags|=GPUBufferUsage.COPY_DST,this.allocate(t,s)}const n=e.byteOffset??0,i=new Uint8Array(e.buffer??e,n,e.byteLength),r=new Uint8Array(this.buffer.size);r.set(i),s.queue.writeBuffer(this.buffer,0,r,0,r.length)}read(t,e,s,n,i){return t.readStorageBuffer(this,e,s,n,i)}write(t,e,s,n,i){t.writeStorageBuffer(this,e,s,n,i)}clear(t,e,s){t.clearStorageBuffer(this,e,s)}}class tr extends Ji{constructor(t,e){super(16|(e?.storage?128:0)),this.format=null,this.format=1===t.format?"uint16":"uint32"}unlock(t){const e=t.device;super.unlock(e,t.storage)}}const er={equals(t,e){if(t.length!==e.length)return!1;for(let s=0;s<t.length;s++)if(t[s]!==e[s])return!1;return!0}},sr=[];sr[0]="sint8",sr[1]="uint8",sr[2]="sint16",sr[3]="uint16",sr[4]="sint32",sr[5]="uint32",sr[6]="float32",sr[7]="float16";const nr=[];nr[0]="snorm8",nr[1]="unorm8",nr[2]="snorm16",nr[3]="unorm16",nr[4]="sint32",nr[5]="uint32",nr[6]="float32",nr[7]="float16";class ir{get(t,e=null){const s=this.getKey(t,e);let n=this.cache.get(s);return n||(n=this.create(t,e),this.cache.set(s,n)),n}getKey(t,e=null){return`${t?.renderingHashString}-${e?.renderingHashString}`}create(t,e){const s=[],n=t=>{const e=t.interleaved,n=t.instancing?"instance":"vertex";let i=[];const r=t.elements.length;for(let a=0;a<r;a++){const o=t.elements[a],l=ni[o.name],h=o.normalize?nr:sr;i.push({shaderLocation:l,offset:e?o.offset:0,format:`${h[o.dataType]}${o.numComponents>1?`x${o.numComponents}`:""}`}),e&&a!==r-1||(s.push({attributes:i,arrayStride:o.stride,stepMode:n}),i=[])}};return t&&n(t),e&&n(e),s}constructor(){this.cache=new Map}}class rr{constructor(t){this.device=t}getPipelineLayout(t){const e=[];t.forEach(t=>{e.push(t.bindGroupLayout)});const s={bindGroupLayouts:e};return this.device.wgpu.createPipelineLayout(s)}}const ar=["point-list","line-list",void 0,"line-strip","triangle-list","triangle-strip",void 0],or=["add","subtract","reverse-subtract","min","max"],lr=["zero","one","src","one-minus-src","dst","one-minus-dst","src-alpha","src-alpha-saturated","one-minus-src-alpha","dst-alpha","one-minus-dst-alpha","constant","one-minus-constant"],hr=["never","less","equal","less-equal","greater","not-equal","greater-equal","always"],cr=["none","back","front"],dr=["keep","zero","replace","increment-clamp","increment-wrap","decrement-clamp","decrement-wrap","invert"],ur=["","uint16","uint32"];class fr{}class pr extends rr{constructor(t){super(t),this.lookupHashes=new Uint32Array(14),this.vertexBufferLayout=new ir,this.cache=new Map}get(t,e,s,n,i,r,a,o,l,h,c,d,u){const f=t.type;n&&3!==f&&5!==f&&(n=void 0);const p=this.lookupHashes;p[0]=f,p[1]=i.id,p[2]=h,p[3]=l.key,p[4]=o.key,p[5]=e?.renderingHash??0,p[6]=s?.renderingHash??0,p[7]=r.impl.key,p[8]=a[0]?.key??0,p[9]=a[1]?.key??0,p[10]=a[2]?.key??0,p[11]=c?d.key:0,p[12]=c?u.key:0,p[13]=n??0;const m=Fi(p);let g=this.cache.get(m);if(g)for(let t=0;t<g.length;t++){const e=g[t];if(er.equals(e.hashes,p))return e.pipeline}const _=ar[f],v=this.getPipelineLayout(a),y=this.vertexBufferLayout.get(e,s),b=new fr;return b.hashes=new Uint32Array(p),b.pipeline=this.create(_,n,i,r,v,o,l,y,h,c,d,u),g?g.push(b):g=[b],this.cache.set(m,g),b.pipeline}getBlend(t){let e;return t.blend&&(e={color:{operation:or[t.colorOp],srcFactor:lr[t.colorSrcFactor],dstFactor:lr[t.colorDstFactor]},alpha:{operation:or[t.alphaOp],srcFactor:lr[t.alphaSrcFactor],dstFactor:lr[t.alphaDstFactor]}}),e}getDepthStencil(t,e,s,n,i,r){let a;const{depth:o,stencil:l}=e;if(o||l){if(a={format:e.impl.depthAttachment.format},o){a.depthWriteEnabled=t.write,a.depthCompare=hr[t.func];const e="triangle-list"===r||"triangle-strip"===r;a.depthBias=e?t.depthBias:0,a.depthBiasSlopeScale=e?t.depthBiasSlope:0}else a.depthWriteEnabled=!1,a.depthCompare="always";l&&s&&(a.stencilReadMas=n.readMask,a.stencilWriteMask=n.writeMask,a.stencilFront={compare:hr[n.func],failOp:dr[n.fail],passOp:dr[n.zpass],depthFailOp:dr[n.zfail]},a.stencilBack={compare:hr[i.func],failOp:dr[i.fail],passOp:dr[i.zpass],depthFailOp:dr[i.zfail]})}return a}create(t,e,s,n,i,r,a,o,l,h,c,d){const u=this.device.wgpu,f=s.impl,p={vertex:{module:f.getVertexShaderModule(),entryPoint:f.vertexEntryPoint,buffers:o},primitive:{topology:t,frontFace:"ccw",cullMode:cr[l]},depthStencil:this.getDepthStencil(a,n,h,c,d,t),multisample:{count:n.samples},layout:i};e&&(p.primitive.stripIndexFormat=ur[e]),p.fragment={module:f.getFragmentShaderModule(),entryPoint:f.fragmentEntryPoint,targets:[]};const m=n.impl.colorAttachments;if(m.length>0){let t=0;r.redWrite&&(t|=GPUColorWrite.RED),r.greenWrite&&(t|=GPUColorWrite.GREEN),r.blueWrite&&(t|=GPUColorWrite.BLUE),r.alphaWrite&&(t|=GPUColorWrite.ALPHA);const e=this.getBlend(r);m.forEach(s=>{p.fragment.targets.push({format:s.format,writeMask:t,blend:e})})}return u.createRenderPipeline(p)}}class mr extends rr{get(t,e){const s=this.getPipelineLayout([e.impl]);return this.create(t,s)}create(t,e){const s=this.device.wgpu,n=t.impl,i={compute:{module:n.getComputeShaderModule(),entryPoint:n.computeEntryPoint},layout:e};return s.createComputePipeline(i)}}class gr{incRefCount(){this._refCount++}decRefCount(){this._refCount--}get refCount(){return this._refCount}constructor(){this._refCount=0}}class _r extends gr{constructor(t){super(),this.object=t,this.incRefCount()}}class vr{destroy(){this.cache.forEach(t=>{t.object?.destroy()}),this.cache.clear()}clear(){this.cache.clear()}get(t){const e=this.cache.get(t);return e?(e.incRefCount(),e.object):null}set(t,e){this.cache.set(t,new _r(e))}release(t){const e=this.cache.get(t);e&&(e.decRefCount(),0===e.refCount&&(this.cache.delete(t),e.object?.destroy()))}constructor(){this.cache=new Map}}class yr extends vr{loseContext(t){this.clear()}}const br=new di,Sr=t=>br.get(t,()=>new yr),xr=new Ci;class wr{destroy(){this.multisampledBuffer?.destroy(),this.multisampledBuffer=null}}class Tr{constructor(t){this.depthTexture=null,this.depthTextureInternal=!1,this.multisampledDepthBuffer=null,this.format=t,this.hasStencil="depth24plus-stencil8"===t}destroy(t){this.depthTextureInternal&&(this.depthTexture?.destroy(),this.depthTexture=null),this.multisampledDepthBuffer&&(this.multisampledDepthBuffer=null,Sr(t).release(this.multisampledDepthBufferKey))}}class Cr{constructor(t){this.initialized=!1,this.colorAttachments=[],this.depthAttachment=null,this.assignedColorTexture=null,this.renderPassDescriptor={},this.isBackbuffer=!1,this.renderTarget=t}destroy(t){this.initialized=!1,this.assignedColorTexture=null,this.colorAttachments.forEach(t=>{t.destroy()}),this.colorAttachments.length=0,this.depthAttachment?.destroy(t),this.depthAttachment=null}updateKey(){let t=`${this.renderTarget.samples}:${this.depthAttachment?this.depthAttachment.format:"nodepth"}`;this.colorAttachments.forEach(e=>{t+=`:${e.format}`}),this.key=xr.get(t)}assignColorTexture(t,e){this.assignedColorTexture=e;const s=e.createView({format:t.backBufferViewFormat}),n=this.renderPassDescriptor.colorAttachments[0];this.renderTarget.samples>1?n.resolveTarget=s:n.view=s,this.setColorAttachment(0,void 0,t.backBufferViewFormat),this.updateKey()}setColorAttachment(t,e,s){this.colorAttachments[t]||(this.colorAttachments[t]=new wr),e&&(this.colorAttachments[t].multisampledBuffer=e),s&&(this.colorAttachments[t].format=s)}init(t,e){const s=t.wgpu;this.initDepthStencil(t,s,e),e._colorBuffers&&e._colorBuffers.forEach((t,e)=>{this.setColorAttachment(e,void 0,t.impl.format)}),this.renderPassDescriptor.colorAttachments=[];const n=this.isBackbuffer?1:e._colorBuffers?.length??0;for(let i=0;i<n;++i){const n=this.initColor(t,s,e,i),r=0===i&&this.colorAttachments[0]?.format;(n.view||r)&&this.renderPassDescriptor.colorAttachments.push(n)}this.updateKey(),this.initialized=!0}initDepthStencil(t,e,s){const{samples:n,width:i,height:r,depth:a,depthBuffer:o}=s;if(a||o){let s;if(o)if(this.depthAttachment=new Tr(o.impl.format),n>1){const a="depth24plus-stencil8";this.depthAttachment.format=a,this.depthAttachment.hasStencil="depth24plus-stencil8"===a;const l=`${o.id}:${i}:${r}:${n}:${a}`,h=Sr(t);let c=h.get(l);if(!c){const t={size:[i,r,1],dimension:"2d",sampleCount:n,format:a,usage:GPUTextureUsage.RENDER_ATTACHMENT|(a!==o.impl.format?GPUTextureUsage.TEXTURE_BINDING:0)};c=e.createTexture(t),h.set(l,c)}this.depthAttachment.multisampledDepthBuffer=c,this.depthAttachment.multisampledDepthBufferKey=l,s=c.createView()}else{const t=o.impl.gpuTexture;this.depthAttachment.depthTexture=t,s=t.createView()}else{this.depthAttachment=new Tr("depth24plus-stencil8");const t={size:[i,r,1],dimension:"2d",sampleCount:n,format:this.depthAttachment.format,usage:GPUTextureUsage.RENDER_ATTACHMENT};t.usage|=n>1?GPUTextureUsage.TEXTURE_BINDING:GPUTextureUsage.COPY_SRC;const a=e.createTexture(t);this.depthAttachment.depthTexture=a,this.depthAttachment.depthTextureInternal=!0,s=a.createView()}this.renderPassDescriptor.depthStencilAttachment={view:s}}}initColor(t,e,s,n){const i={},{samples:r,width:a,height:o,mipLevel:l}=s,h=s.getColorBuffer(n);let c=null;if(h){const t=1;c=h.cubemap?h.impl.createView({dimension:"2d",baseArrayLayer:s.face,arrayLayerCount:1,mipLevelCount:t,baseMipLevel:l}):h.impl.createView({mipLevelCount:t,baseMipLevel:l})}if(r>1){const s={size:[a,o,1],dimension:"2d",sampleCount:r,format:this.isBackbuffer?t.backBufferViewFormat:h.impl.format,usage:GPUTextureUsage.RENDER_ATTACHMENT},l=e.createTexture(s);this.setColorAttachment(n,l,s.format),i.view=l.createView(),i.resolveTarget=c}else i.view=c;return i}setupForRenderPass(t,e){const s=this.renderPassDescriptor.colorAttachments?.length??0;for(let n=0;n<s;++n){const s=this.renderPassDescriptor.colorAttachments[n],i=t.colorArrayOps[n],r=e.isColorBufferSrgb(n);s.clearValue=r?i.clearValueLinear:i.clearValue,s.loadOp=i.clear?"clear":"load",s.storeOp=i.store?"store":"discard"}const n=this.renderPassDescriptor.depthStencilAttachment;n&&(n.depthClearValue=t.depthStencilOps.clearDepthValue,n.depthLoadOp=t.depthStencilOps.clearDepth?"clear":"load",n.depthStoreOp=t.depthStencilOps.storeDepth?"store":"discard",n.depthReadOnly=!1,this.depthAttachment.hasStencil&&(n.stencilClearValue=t.depthStencilOps.clearStencilValue,n.stencilLoadOp=t.depthStencilOps.clearStencil?"clear":"load",n.stencilStoreOp=t.depthStencilOps.storeStencil?"store":"discard",n.stencilReadOnly=!1))}loseContext(){this.initialized=!1}resolve(t,e,s,n){}}const Er=[];Er[2]=1,Er[3]=2,Er[4]=3,Er[5]=4,Er[1]=1,Er[6]=2,Er[7]=3,Er[8]=4,Er[0]=1,Er[9]=2,Er[10]=3,Er[11]=4,Er[12]=8,Er[13]=12,Er[14]=16,Er[26]=1,Er[27]=2,Er[28]=3,Er[29]=4;class Ar{get isArrayType(){return this.count>0}constructor(t,e,s=0){if(this.shortName=t,this.name=s?`${t}[0]`:t,this.type=e,this.numComponents=Er[e],this.updateType=e,s>0)switch(e){case 2:this.updateType=17;break;case 1:this.updateType=zn;break;case On:this.updateType=31;break;case 0:this.updateType=32;break;case 3:this.updateType=21;break;case 6:this.updateType=Un;break;case Fn:this.updateType=34;break;case 9:this.updateType=35;break;case 4:this.updateType=22;break;case 7:this.updateType=Vn;break;case Nn:this.updateType=37;break;case 10:this.updateType=38;break;case 5:this.updateType=23;break;case 8:this.updateType=39;break;case Bn:this.updateType=40;break;case 11:this.updateType=41;break;case kn:this.updateType=24}this.count=s;let n=this.numComponents;s&&(n=Qe.roundUp(n,4)),this.byteSize=4*n,s&&(this.byteSize*=s)}calculateOffset(t){let e=this.byteSize<=8?this.byteSize:16;this.count&&(e=16),t=Qe.roundUp(t,e),this.offset=t/4}}class Dr{constructor(t,e){this.byteSize=0,this.map=new Map,this.scope=t.scope,this.uniforms=e;let s=0;for(let t=0;t<e.length;t++){const n=e[t];n.calculateOffset(s),s=4*n.offset+n.byteSize,n.scopeId=this.scope.resolve(n.name),this.map.set(n.name,n)}this.byteSize=Qe.roundUp(s,16)}get(t){return this.map.get(t)}}const Pr=/[ \t]*(\battribute\b|\bvarying\b|\buniform\b)/g,Lr=/(\battribute\b|\bvarying\b|\bout\b|\buniform\b)[ \t]*([^;]+)(;+)/g,Ir="@@@",Rr=/([\w-]+)\[(.*?)\]/,Mr=new Set(["highp","mediump","lowp"]),kr=new Set(["sampler2DShadow","samplerCubeShadow","sampler2DArrayShadow"]),Or={sampler2D:Tn,sampler3D:Dn,samplerCube:En,samplerCubeShadow:En,sampler2DShadow:Tn,sampler2DArray:Cn,sampler2DArrayShadow:Cn,isampler2D:Tn,usampler2D:Tn,isampler3D:Dn,usampler3D:Dn,isamplerCube:En,usamplerCube:En,isampler2DArray:Cn,usampler2DArray:Cn},Fr={[Tn]:"texture2D",[En]:"textureCube",[Dn]:"texture3D",[Cn]:"texture2DArray"};let Nr=class{constructor(t,e){this.line=t;const s=t.trim().split(/\s+/);if(Mr.has(s[0])&&(this.precision=s.shift()),this.type=s.shift(),t.includes(","),t.includes("[")){const t=s.join(" "),n=Rr.exec(t);this.name=n[1],this.arraySize=Number(n[2]),isNaN(this.arraySize)&&(e.failed=!0)}else this.name=s.shift(),this.arraySize=0;this.isSampler=-1!==this.type.indexOf("sampler"),this.isSignedInt=-1!==this.type.indexOf("isampler"),this.isUnsignedInt=-1!==this.type.indexOf("usampler")}};class Br{static run(t,e,s){const n=new Map,i=Br.extract(e.vshader),r=Br.extract(e.fshader),a=new Map,o=Br.processAttributes(i.attributes,e.attributes,a,e.processingOptions),l=Br.processVaryings(i.varyings,n,!0),h=Br.processVaryings(r.varyings,n,!1),c=Br.processOuts(r.outs),d=i.uniforms.concat(r.uniforms),u=Array.from(new Set(d)).map(t=>new Nr(t,s)),f=Br.processUniforms(t,u,e.processingOptions,s),p=`${o}\n${l}\n${f.code}`,m=i.src.replace(Ir,p),g=`${h}\n${c}\n${f.code}`;return{vshader:m,fshader:r.src.replace(Ir,g),attributes:a,meshUniformBufferFormat:f.meshUniformBufferFormat,meshBindGroupFormat:f.meshBindGroupFormat}}static extract(t){const e=[],s=[],n=[],i=[];let r,a=`${Ir}\n`;for(;null!==(r=Pr.exec(t));){const o=r[1];switch(o){case"attribute":case"varying":case"uniform":case"out":{Lr.lastIndex=r.index;const l=Lr.exec(t);"attribute"===o?e.push(l[2]):"varying"===o?s.push(l[2]):"out"===o?n.push(l[2]):"uniform"===o&&i.push(l[2]),t=Br.cutOut(t,r.index,Lr.lastIndex,a),Pr.lastIndex=r.index+a.length,a="";break}}}return{src:t,attributes:e,varyings:s,outs:n,uniforms:i}}static processUniforms(t,e,s,n){const i=[],r=[];e.forEach(t=>{t.isSampler?i.push(t):r.push(t)});const a=[];r.forEach(t=>{if(!s.hasUniform(t.name)){const e=Hn.indexOf(t.type),s=new Ar(t.name,e,t.arraySize);a.push(s)}}),0===a.length&&a.push(new Ar(Qn,2));const o=a.length?new Dr(t,a):null,l=[];i.forEach(t=>{if(!s.hasTexture(t.name)){let e=0;t.isSignedInt?e=3:t.isUnsignedInt?e=4:("highp"===t.precision&&(e=1),kr.has(t.type)&&(e=2));const s=Or[t.type];l.push(new li(t.name,3,s,e))}});const h=new ci(t,l);let c="";return s.uniformFormats.forEach((t,e)=>{t&&(c+=Br.getUniformShaderDeclaration(t,e,0))}),o&&(c+=Br.getUniformShaderDeclaration(o,2,0)),s.bindGroupFormats.forEach((t,e)=>{t&&(c+=Br.getTexturesShaderDeclaration(t,e))}),c+=Br.getTexturesShaderDeclaration(h,1),{code:c,meshUniformBufferFormat:o,meshBindGroupFormat:h}}static processVaryings(t,e,s){let n="";const i=s?"out":"in";return t.forEach((t,r)=>{const a=Br.splitToWords(t),o=a.slice(0,-1).join(" "),l=a[a.length-1];s?e.set(l,r):r=e.get(l),n+=`layout(location = ${r}) ${i} ${o} ${l};\n`}),n}static processOuts(t){let e="";return t.forEach((t,s)=>{e+=`layout(location = ${s}) out ${t};\n`}),e}static getTypeCount(t){const e=t.substring(t.length-1),s=parseInt(e,10);return isNaN(s)?1:s}static processAttributes(t,e,s,n){let i="";return t.forEach(t=>{const r=Br.splitToWords(t);let a=r[0],o=r[1];if(e.hasOwnProperty(o)){const t=e[o],r=ni[t];let l;s.set(r,o);const h=n.getVertexElement(t);if(h){const t=h.dataType;if(6!==t&&7!==t&&!h.normalize&&!h.asInt){const e=Br.getTypeCount(a),s=`_private_${o}`;l=`vec${e} ${o} = vec${e}(${s});\n`,o=s;const n=0===t||2===t||4===t;a=1===e?n?"int":"uint":n?`ivec${e}`:`uvec${e}`}}i+=`layout(location = ${r}) in ${a} ${o};\n`,l&&(i+=l)}}),i}static splitToWords(t){return(t=t.replace(/\s+/g," ").trim()).split(" ")}static cutOut(t,e,s,n){return t.substring(0,e)+n+t.substring(s)}static getUniformShaderDeclaration(t,e,s){let n=`layout(set = ${e}, binding = ${s}, std140) uniform ub_${Kn[e]} {\n`;return t.uniforms.forEach(t=>{const e=Hn[t.type];n+=`    ${e} ${t.shortName}${t.count?`[${t.count}]`:""};\n`}),`${n}};\n`}static getTexturesShaderDeclaration(t,e){let s="";return t.textureFormats.forEach(t=>{let n=Fr[t.textureDimension];const i="texture2DArray"===n,r=4===t.sampleType?"u":3===t.sampleType?"i":"";n=`${r}${n}`;let a="",o="";i&&(a="_texture",o=`#define ${t.name} ${r}sampler2DArray(${t.name}${a}, ${t.name}_sampler)\n`),s+=`layout(set = ${e}, binding = ${t.slot}) uniform ${n} ${t.name}${a};\n`,t.hasSampler&&(s+=`layout(set = ${e}, binding = ${t.slot+1}) uniform sampler ${t.name}_sampler;\n`),s+=o}),s}}const zr=/^[ \t]*(attribute|varying|uniform)[\t ]+/gm,Ur=/^[ \t]*(attribute|varying|uniform)[ \t]*([^;]+)(;+)/gm,Vr=/^[ \t]*var\s*(?:(<storage,[^>]*>)\s*([\w\d_]+)\s*:\s*(.*?)\s*;|(<(?!storage,)[^>]*>)?\s*([\w\d_]+)\s*:\s*(texture_.*|storage_texture_.*|storage\w.*|external_texture|sampler(?:_comparison)?)\s*;)\s*$/gm,Hr=/(?:@interpolate\([^)]*\)\s*)?([\w]+)\s*:\s*([\w<>]+)/,Gr="@@@",Wr=/(@vertex|@fragment)\s*fn\s+\w+\s*\(\s*(\w+)\s*:[\s\S]*?\{/,jr={texture_1d:{viewDimension:"1d",baseSampleType:0},texture_2d:{viewDimension:Tn,baseSampleType:0},texture_2d_array:{viewDimension:Cn,baseSampleType:0},texture_3d:{viewDimension:Dn,baseSampleType:0},texture_cube:{viewDimension:En,baseSampleType:0},texture_cube_array:{viewDimension:An,baseSampleType:0},texture_multisampled_2d:{viewDimension:Tn,baseSampleType:0},texture_depth_2d:{viewDimension:Tn,baseSampleType:2},texture_depth_2d_array:{viewDimension:Cn,baseSampleType:2},texture_depth_cube:{viewDimension:En,baseSampleType:2},texture_depth_cube_array:{viewDimension:An,baseSampleType:2},texture_external:{viewDimension:Tn,baseSampleType:1}},$r={f32:"WrappedF32",i32:"WrappedI32",u32:"WrappedU32",vec2f:"WrappedVec2F",vec2i:"WrappedVec2I",vec2u:"WrappedVec2U"},Xr=t=>(t=t.replace(/\s+/g," ").trim()).split(/[\s:]+/),qr=/array<([^,]+),\s*([^>]+)>/;class Kr{constructor(t,e){this.ubName=null,this.arraySize=0,this.line=t;const s=Xr(t);if(s.length<2)e.failed=!0;else if(this.name=s[0],this.type=s.slice(1).join(" "),this.type.includes("array<")){const t=qr.exec(this.type);this.type=t[1].trim(),this.arraySize=Number(t[2]),isNaN(this.arraySize)&&(e.failed=!0)}}}const Yr=/^\s*var\s+(\w+)\s*:\s*(texture_\w+)(?:<(\w+)>)?;\s*$/,Qr=/^\s*var\s+([\w\d_]+)\s*:\s*(texture_storage_2d|texture_storage_2d_array)<([\w\d_]+),\s*(\w+)>\s*;\s*$/,Zr=/^\s*var\s*<storage,\s*(read|write)?>\s*([\w\d_]+)\s*:\s*(.*)\s*;\s*$/,Jr=/^\s*var\s+([\w\d_]+)\s*:\s*texture_external;\s*$/,ta=/^\s*var\s+([\w\d_]+)\s*:\s*(sampler|sampler_comparison)\s*;\s*$/;class ea{constructor(t,e){this.originalLine=t,this.line=t,this.isTexture=!1,this.isSampler=!1,this.isStorageTexture=!1,this.isStorageBuffer=!1,this.isExternalTexture=!1,this.type="",this.matchedElements=[];const s=this.line.match(Yr);if(s){this.name=s[1],this.type=s[2],this.textureFormat=s[3],this.isTexture=!0,this.matchedElements.push(...s);const t=((t,e)=>{const s=jr[t];let n=s.baseSampleType;if(0===s.baseSampleType&&"texture_multisampled_2d"!==t)switch(e){case"u32":n=4;break;case"i32":n=3;break;case"f32":n=0;break;case"uff":n=1}return{viewDimension:s.viewDimension,sampleType:n}})(this.type,this.textureFormat);this.textureDimension=t.viewDimension,this.sampleType=t.sampleType}const n=this.line.match(Qr);n&&(this.isStorageTexture=!0,this.name=n[1],this.textureType=n[2],this.format=n[3],this.access=n[4],this.matchedElements.push(...n));const i=this.line.match(Zr);i&&(this.isStorageBuffer=!0,this.accessMode=i[1]||"none",this.name=i[2],this.type=i[3],this.matchedElements.push(...i));const r=this.line.match(Jr);r&&(this.name=r[1],this.isExternalTexture=!0,this.matchedElements.push(...i));const a=this.line.match(ta);a&&(this.name=a[1],this.samplerType=a[2],this.isSampler=!0,this.matchedElements.push(...a)),0===this.matchedElements.length&&(e.failed=!0)}equals(t){return this.name===t.name&&(this.type===t.type&&(this.isTexture===t.isTexture&&(this.isSampler===t.isSampler&&(this.isStorageTexture===t.isStorageTexture&&(this.isStorageBuffer===t.isStorageBuffer&&(this.isExternalTexture===t.isExternalTexture&&(this.textureFormat===t.textureFormat&&(this.textureDimension===t.textureDimension&&(this.sampleType===t.sampleType&&(this.textureType===t.textureType&&(this.format===t.format&&(this.access===t.access&&(this.accessMode===t.accessMode&&this.samplerType===t.samplerType)))))))))))))}}class sa{static run(t,e,s){const n=new Map,i=sa.extract(e.vshader),r=sa.extract(e.fshader),a=new Map,o=sa.processAttributes(i.attributes,e.attributes,a,e.processingOptions,s),l=sa.processVaryings(i.varyings,n,!0),h=sa.processVaryings(r.varyings,n,!1),c=i.uniforms.concat(r.uniforms),d=Array.from(new Set(c)).map(t=>new Kr(t,s)),u=sa.processUniforms(t,d,e.processingOptions,s);i.src=sa.renameUniformAccess(i.src,d),r.src=sa.renameUniformAccess(r.src,d);const f=sa.mergeResources(i.resources,r.resources,s),p=sa.processResources(t,f,e.processingOptions,s),m=sa.generateFragmentOutputStruct(r.src,t.maxColorAttachments);i.src=sa.copyInputs(i.src,s),r.src=sa.copyInputs(r.src,s);const g=`${o}\n${l}\n${u.code}\n${p.code}\n`,_=i.src.replace(Gr,g),v=`${h}\n${m}\n${u.code}\n${p.code}\n`;return{vshader:_,fshader:r.src.replace(Gr,v),attributes:a,meshUniformBufferFormat:u.meshUniformBufferFormat,meshBindGroupFormat:p.meshBindGroupFormat}}static extract(t){const e=[],s=[],n=[],i=[];let r,a=`${Gr}\n`;for(;null!==(r=zr.exec(t));){const i=r[1];Ur.lastIndex=r.index;const o=Ur.exec(t);"attribute"===i?e.push(o[2]):"varying"===i?s.push(o[2]):"uniform"===i&&n.push(o[2]),t=sa.cutOut(t,r.index,Ur.lastIndex,a),zr.lastIndex=r.index+a.length,a=""}for(;null!==(r=Vr.exec(t));)i.push(r[0]),t=sa.cutOut(t,r.index,Vr.lastIndex,a),Vr.lastIndex=r.index+a.length,a="";return{src:t,attributes:e,varyings:s,uniforms:n,resources:i}}static processUniforms(t,e,s,n){const i=[];e.forEach(t=>{if(s.hasUniform(t.name))t.ubName="ub_view";else{t.ubName="ub_mesh_ub";const e=Wn.get(t.type),s=new Ar(t.name,e,t.arraySize);i.push(s)}}),0===i.length&&i.push(new Ar(Qn,2));const r=new Dr(t,i);let a="";return s.uniformFormats.forEach((t,e)=>{t&&(a+=sa.getUniformShaderDeclaration(t,e,0))}),r&&(a+=sa.getUniformShaderDeclaration(r,2,0)),{code:a,meshUniformBufferFormat:r}}static renameUniformAccess(t,e){return e.forEach(e=>{const s=`uniform.${e.name}`,n=`${e.ubName}.${e.name}`,i=new RegExp(`\\b${s}\\b`,"g");t=t.replace(i,n)}),t}static mergeResources(t,e,s){const n=t.map(t=>new ea(t,s));return e.map(t=>new ea(t,s)).forEach(t=>{const e=n.find(e=>e.name===t.name);e?e.equals(t)||(s.failed=!0):n.push(t)}),n}static processResources(t,e,s,n){const i=[];for(let t=0;t<e.length;t++){const s=e[t];if(s.isTexture){const n=e[t+1],r=n?.isSampler,a=s.sampleType,o=s.textureDimension;i.push(new li(s.name,3,o,a,r,r?n.name:null)),r&&t++}if(s.isStorageBuffer){const t="read_write"!==s.accessMode,e=new oi(s.name,3,t);e.format=s.type,i.push(e)}}const r=new ci(t,i);let a="";return s.bindGroupFormats.forEach((t,e)=>{t&&(a+=sa.getTextureShaderDeclaration(t,e))}),a+=sa.getTextureShaderDeclaration(r,1),{code:a,meshBindGroupFormat:r}}static getUniformShaderDeclaration(t,e,s){const n=Kn[e],i=`struct_ub_${n}`;let r=`struct ${i} {\n`;return t.uniforms.forEach(t=>{let e=Gn[t.type][0];t.count>0?($r.hasOwnProperty(e)&&(e=$r[e]),r+=`    ${t.shortName}: array<${e}, ${t.count}>,\n`):r+=`    ${t.shortName}: ${e},\n`}),r+="};\n",r+=`@group(${e}) @binding(${s}) var<uniform> ub_${n} : ${i};\n\n`,r}static getTextureShaderDeclaration(t,e){let s="";return t.textureFormats.forEach(t=>{const n=((t,e)=>{if(2===e)switch(t){case Tn:return"texture_depth_2d";case Cn:return"texture_depth_2d_array";case En:return"texture_depth_cube";case An:return"texture_depth_cube_array"}let s,n;switch(t){case"1d":s="texture_1d";break;case Tn:s="texture_2d";break;case Cn:s="texture_2d_array";break;case Dn:s="texture_3d";break;case En:s="texture_cube";break;case An:s="texture_cube_array"}switch(e){case 0:case 1:n="f32";break;case 4:n="u32";break;case 3:n="i32"}return`${s}<${n}>`})(t.textureDimension,t.sampleType);if(s+=`@group(${e}) @binding(${t.slot}) var ${t.name}: ${n};\n`,t.hasSampler){const n=2===t.sampleType?"sampler_comparison":"sampler";s+=`@group(${e}) @binding(${t.slot+1}) var ${t.samplerName}: ${n};\n`}}),t.storageBufferFormats.forEach(t=>{const n=t.readOnly?"read":"read_write";s+=`@group(${e}) @binding(${t.slot}) var<storage, ${n}> ${t.name} : ${t.format};\n`}),s}static processVaryings(t,e,s){let n="",i="",r="";t.forEach((t,a)=>{const o=t.match(Hr);if(o){const l=o[1],h=o[2];s?e.set(l,a):a=e.get(l),n+=`    @location(${a}) ${t},\n`,s||(i+=`    var<private> ${l}: ${h};\n`,r+=`    ${l} = input.${l};\n`)}}),s?n+="    @builtin(position) position : vec4f,\n":(n+="    @builtin(position) position : vec4f,\n",n+="    @builtin(front_facing) frontFacing : bool,\n",n+="    @builtin(sample_index) sampleIndex : u32\n");return`\n\t\t\t\t\t\tstruct ${s?"VertexOutput":"FragmentInput"} {\n\t\t\t\t\t\t\t\t${n}\n\t\t\t\t\t\t};\n\t\t\t\t\t\t${s?"":`\n\t\t\t\t\t\tvar<private> pcPosition: vec4f;\n\t\t\t\t\t\tvar<private> pcFrontFacing: bool;\n\t\t\t\t\t\tvar<private> pcSampleIndex: u32;\n\t\t\t\t\t\t${i}\n\t\t\t\t\t\t\n\t\t\t\t\t\t// function to copy inputs (varyings) to private global variables\n\t\t\t\t\t\tfn _pcCopyInputs(input: FragmentInput) {\n\t\t\t\t\t\t\t\t${r}\n\t\t\t\t\t\t\t\tpcPosition = input.position;\n\t\t\t\t\t\t\t\tpcFrontFacing = input.frontFacing;\n\t\t\t\t\t\t\t\tpcSampleIndex = input.sampleIndex;\n\t\t\t\t\t\t}\n\t\t\t\t`}\n\t\t\t\t`}static generateFragmentOutputStruct(t,e){let s="struct FragmentOutput {\n";for(let t=0;t<e;t++)s+=`    @location(${t}) color${t>0?t:""} : pcOutType${t},\n`;return-1!==t.search(/\.fragDepth\s*=/)&&(s+="    @builtin(frag_depth) fragDepth : f32\n"),`${s}};\n`}static floatAttributeToInt(t,e){return{f32:e?"i32":"u32",vec2f:e?"vec2i":"vec2u",vec3f:e?"vec3i":"vec3u",vec4f:e?"vec4i":"vec4u"}[{f32:"f32","vec2<f32>":"vec2f","vec3<f32>":"vec3f","vec4<f32>":"vec4f"}[t]||t]||null}static processAttributes(t,e={},s,n,i){let r="",a="",o="";return t.forEach(t=>{const i=Xr(t),l=i[0];let h=i[1];const c=h;if(e.hasOwnProperty(l)){const i=e[l],d=ni[i];s.set(d,l);const u=n.getVertexElement(i);if(u){const t=u.dataType;if(6!==t&&7!==t&&!u.normalize&&!u.asInt){const e=0===t||2===t||4===t;h=sa.floatAttributeToInt(h,e)}}r+=`    @location(${d}) ${l}: ${h},\n`,a+=`    var<private> ${t};\n`,o+=`    ${l} = ${c}(input.${l});\n`}}),`\n\t\t\t\t\t\tstruct VertexInput {\n\t\t\t\t\t\t\t\t${r}\n\t\t\t\t\t\t\t\t@builtin(vertex_index) vertexIndex : u32,       // built-in vertex index\n\t\t\t\t\t\t\t\t@builtin(instance_index) instanceIndex : u32    // built-in instance index\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\t${a}\n\t\t\t\t\t\tvar<private> pcVertexIndex: u32;\n\t\t\t\t\t\tvar<private> pcInstanceIndex: u32;\n\n\t\t\t\t\t\tfn _pcCopyInputs(input: VertexInput) {\n\t\t\t\t\t\t\t\t${o}\n\t\t\t\t\t\t\t\tpcVertexIndex = input.vertexIndex;\n\t\t\t\t\t\t\t\tpcInstanceIndex = input.instanceIndex;\n\t\t\t\t\t\t}\n\t\t\t\t`}static copyInputs(t,e){const s=t.match(Wr);if(!s||!s[2])return t;const n=s[2],i=s.index+s[0].length-1;return t.slice(0,i+1)+`\n    _pcCopyInputs(${n});`+t.slice(i+1)}static cutOut(t,e,s,n){return t.substring(0,e)+n+t.substring(s)}}class na{constructor(t){this._vertexCode=null,this._fragmentCode=null,this._computeCode=null,this.vertexEntryPoint="main",this.fragmentEntryPoint="main",this.computeEntryPoint="main",this.shader=t;const e=t.definition;e.shaderLanguage===Rn?(e.cshader?(this._computeCode=e.cshader??null,this.computeUniformBufferFormats=e.computeUniformBufferFormats,this.computeBindGroupFormat=e.computeBindGroupFormat):(this.vertexEntryPoint="vertexMain",this.fragmentEntryPoint="fragmentMain",e.processingOptions?this.processWGSL():(this._vertexCode=e.vshader??null,this._fragmentCode=e.fshader??null,t.meshUniformBufferFormat=e.meshUniformBufferFormat,t.meshBindGroupFormat=e.meshBindGroupFormat)),t.ready=!0):e.processingOptions&&this.processGLSL()}destroy(t){this._vertexCode=null,this._fragmentCode=null}createShaderModule(t,e){return this.shader.device.wgpu.createShaderModule({code:t})}getVertexShaderModule(){return this.createShaderModule(this._vertexCode,"Vertex")}getFragmentShaderModule(){return this.createShaderModule(this._fragmentCode,"Fragment")}getComputeShaderModule(){return this.createShaderModule(this._computeCode,"Compute")}processGLSL(){const t=this.shader,e=Br.run(t.device,t.definition,t);this._vertexCode=this.transpile(e.vshader,"vertex",t.definition.vshader),this._fragmentCode=this.transpile(e.fshader,"fragment",t.definition.fshader),this._vertexCode&&this._fragmentCode?t.ready=!0:t.failed=!0,t.meshUniformBufferFormat=e.meshUniformBufferFormat,t.meshBindGroupFormat=e.meshBindGroupFormat,t.attributes=e.attributes}processWGSL(){const t=this.shader,e=sa.run(t.device,t.definition,t);this._vertexCode=e.vshader,this._fragmentCode=e.fshader,t.meshUniformBufferFormat=e.meshUniformBufferFormat,t.meshBindGroupFormat=e.meshBindGroupFormat,t.attributes=e.attributes}transpile(t,e,s){const n=this.shader.device;if(!n.glslang||!n.twgsl)return console.error(`Cannot transpile shader [${this.shader.label}] - shader transpilers (glslang/twgsl) are not available. Make sure to provide glslangUrl and twgslUrl when creating the device.`,{shader:this.shader}),null;try{const s=n.glslang.compileGLSL(t,e);return n.twgsl.convertSpirV2WGSL(s)}catch(n){console.error(`Failed to transpile webgl ${e} shader [${this.shader.label}] to WebGPU while rendering undefined, error:\n [${n.stack}]`,{processed:t,original:s,shader:this.shader,error:n,stack:n.stack})}}get vertexCode(){return this._vertexCode}get fragmentCode(){return this._fragmentCode}loseContext(){}restoreContext(t,e){}}const ia=[];ia[0]="repeat",ia[1]="clamp-to-edge",ia[2]="mirror-repeat";const ra=[];ra[0]={level:"nearest",mip:"nearest"},ra[1]={level:"linear",mip:"nearest"},ra[2]={level:"nearest",mip:"nearest"},ra[3]={level:"nearest",mip:"linear"},ra[4]={level:"linear",mip:"nearest"},ra[5]={level:"linear",mip:"linear"};class aa{constructor(t){this.samplers=[],this.texture=t,this.format=qi[t.format],this.create(t.device)}create(t){const e=this.texture,s=t.wgpu,n=e.numLevels;let i;this.desc={size:{width:e.width,height:e.height,depthOrArrayLayers:e.cubemap?6:e.array?e.arrayLength:1},format:this.format,mipLevelCount:n,sampleCount:1,dimension:e.volume?"3d":"2d",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.COPY_SRC|(js(e.format)?0:GPUTextureUsage.RENDER_ATTACHMENT)|(e.storage?GPUTextureUsage.STORAGE_BINDING:0)},this.gpuTexture=s.createTexture(this.desc),this.texture.format===ks&&(i={format:"depth24plus",aspect:"depth-only"}),this.view=this.createView(i)}destroy(t){}propertyChanged(t){this.samplers.length=0}getView(t){return this.uploadImmediate(t,this.texture),this.view}createView(t){const e=t??{},s=this.desc,n=this.texture,i={format:e.format??s.format,dimension:e.dimension??(n.cubemap?"cube":n.volume?"3d":n.array?"2d-array":"2d"),aspect:e.aspect??"all",baseMipLevel:e.baseMipLevel??0,mipLevelCount:e.mipLevelCount??s.mipLevelCount,baseArrayLayer:e.baseArrayLayer??0,arrayLayerCount:e.arrayLayerCount??s.depthOrArrayLayers};return this.gpuTexture.createView(i)}getSampler(t,e){let s=this.samplers[e];if(!s){const n=this.texture,i={addressModeU:ia[n.addressU],addressModeV:ia[n.addressV],addressModeW:ia[n.addressW]};if(!e&&n.compareOnRead&&(e=2),2===e||3===e||4===e)i.compare="less",i.magFilter="linear",i.minFilter="linear";else if(1===e)i.magFilter="nearest",i.minFilter="nearest",i.mipmapFilter="nearest";else{!t.textureFloatFilterable&&(n.format===Is||n.format===Ls)||this.texture.format===ks||Xs(this.texture.format)?(i.magFilter="nearest",i.minFilter="nearest",i.mipmapFilter="nearest"):(i.magFilter=ra[n.magFilter].level,i.minFilter=ra[n.minFilter].level,i.mipmapFilter=ra[n.minFilter].mip)}const r="linear"===i.minFilter&&"linear"===i.magFilter&&"linear"===i.mipmapFilter;i.maxAnisotropy=r?Qe.clamp(Math.round(n._anisotropy),1,t.maxTextureAnisotropy):1,s=t.wgpu.createSampler(i),this.samplers[e]=s}return s}loseContext(){}uploadImmediate(t,e){(e._needsUpload||e._needsMipmapsUpload)&&(this.uploadData(t),e._needsUpload=!1,e._needsMipmapsUpload=!1)}uploadData(t){const e=this.texture;if(!this.desc||this.desc.size.width===e.width&&this.desc.size.height===e.height||(this.gpuTexture.destroy(),this.create(t),e.renderVersionDirty=t.renderVersion),e._levels){let s=!1,n=!1;const i=e.numLevels;for(let r=0;r<i;r++){const i=e._levels[r];if(i)if(e.cubemap)for(let e=0;e<6;e++){const a=i[e];a?this.isExternalImage(a)?(this.uploadExternalImage(t,a,r,e),s=!0):ArrayBuffer.isView(a)&&(this.uploadTypedArrayData(t,a,r,e),s=!0):n=!0}else if(e._volume);else if(e.array)if(e.arrayLength===i.length)for(let n=0;n<e._arrayLength;n++){const e=i[n];this.isExternalImage(e)?(this.uploadExternalImage(t,e,r,n),s=!0):ArrayBuffer.isView(e)&&(this.uploadTypedArrayData(t,e,r,n),s=!0)}else n=!0;else this.isExternalImage(i)?(this.uploadExternalImage(t,i,r,0),s=!0):ArrayBuffer.isView(i)&&(this.uploadTypedArrayData(t,i,r,0),s=!0);else n=!0}s&&n&&e.mipmaps&&!js(e.format)&&!Xs(e.format)&&t.mipmapRenderer.generate(this),e._gpuSize&&e.adjustVramSizeTracking(t._vram,-e._gpuSize),e._gpuSize=e.gpuSize,e.adjustVramSizeTracking(t._vram,e._gpuSize)}}isExternalImage(t){return"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap||"undefined"!=typeof HTMLVideoElement&&t instanceof HTMLVideoElement||"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof OffscreenCanvas&&t instanceof OffscreenCanvas}uploadExternalImage(t,e,s,n){const i={source:e,origin:[0,0],flipY:!1},r={texture:this.gpuTexture,mipLevel:s,origin:[0,0,n],aspect:"all",premultipliedAlpha:this.texture._premultiplyAlpha},a={width:this.desc.size.width,height:this.desc.size.height,depthOrArrayLayers:1};t.submit(),e instanceof HTMLCanvasElement&&e.getContext("2d"),t.wgpu.queue.copyExternalImageToTexture(i,r,a)}uploadTypedArrayData(t,e,s,n){const i=this.texture,r=t.wgpu,a={texture:this.gpuTexture,origin:[0,0,n],mipLevel:s},o=ui.calcLevelDimension(i.width,s),l=ui.calcLevelDimension(i.height,s);ui.calcLevelGpuSize(o,l,1,i.format);const h=Ws.get(i.format);let c,d;if(h.size)c={offset:0,bytesPerRow:h.size*o,rowsPerImage:l},d={width:o,height:l};else if(h.blockSize){const t=t=>Math.floor((t+3)/4);c={offset:0,bytesPerRow:h.blockSize*t(o),rowsPerImage:t(l)},d={width:Math.max(4,o),height:Math.max(4,l)}}t.submit(),r.queue.writeTexture(a,e,c,d)}read(t,e,s,n,i){const r=i.mipLevel??0,a=i.face??0,o=i.data??null,l=i.immediate??!1,h=this.texture,c=s*Ws.get(h.format).size,d=Qe.roundUp(c,256),u=d*n,f=h.device,p=f.createBufferImpl(9);p.allocate(f,u);const m={texture:this.gpuTexture,mipLevel:r,origin:[t,e,a]},g={buffer:p.buffer,offset:0,bytesPerRow:d},_={width:s,height:n,depthOrArrayLayers:1};return f.getCommandEncoder().copyTextureToBuffer(m,g,_),f.readBuffer(p,u,null,l).then(t=>{const e=Ks(h.format),s=o?.buffer??new ArrayBuffer(n*c),i=new Uint8Array(s,o?.byteOffset??0,n*c);for(let e=0;e<n;e++){const s=e*d,n=e*c;i.set(t.subarray(s,s+c),n)}return o??new e(s)})}}class oa extends Ji{constructor(t){super(64)}unlock(t){const e=t.device;super.unlock(e,t.storageInt32.buffer)}}class la extends Ji{constructor(t,e,s){super(32|(s?.storage?128:0))}unlock(t){const e=t.device;super.unlock(e,t.storage)}}const ha=/[ \t]*#(ifn?def|if|endif|else|elif|define|undef|extension|include)/g,ca=/define[ \t]+([^\n]+)\r?(?:\n|$)/g,da=/extension[ \t]+([\w-]+)[ \t]*:[ \t]*(enable|require)/g,ua=/undef[ \t]+([^\n]+)\r?(?:\n|$)/g,fa=/(ifdef|ifndef|if)[ \t]*([^\r\n]+)\r?\n/g,pa=/(endif|else|elif)(?:[ \t]+([^\r\n]*))?\r?\n?/g,ma=/\{?[\w-]+\}?/,ga=/(!|\s)?defined\(([\w-]+)\)/,_a=/!?defined\s*\([^)]*\)/g,va=/!?defined\s*$/,ya=/([a-z_]\w*)\s*(==|!=|<|<=|>|>=)\s*([\w"']+)/i,ba=/[+\-]/g,Sa=/include[ \t]+"([\w-]+)(?:\s*,\s*([\w-]+))?"/g,xa=/\{i\}/g,wa=/(pcFragColor[1-8])\b/g;class Ta{static run(t,e=new Map,s={}){Ta.sourceName=s.sourceName,t=(t=this.stripComments(t)).split(/\r?\n/).map(t=>t.trimEnd()).join("\n");const n=new Map,i=new Map;if(null===(t=this._preprocess(t,n,i,e,s.stripDefines)))return null;const r=new Map;return n.forEach((t,e)=>{Number.isInteger(parseFloat(t))&&!t.includes(".")&&r.set(e,t)}),t=this.stripComments(t),t=this.stripUnusedColorAttachments(t,s),t=this.RemoveEmptyLines(t),t=this.processArraySize(t,r),t=this.injectDefines(t,i)}static stripUnusedColorAttachments(t,e){if(e.stripUnusedColorAttachments){const e=new Map,s=t.match(wa);s?.forEach(t=>{const s=parseInt(t.charAt(t.length-1),10);e.set(s,(e.get(s)??0)+1)});if(Array.from(e.values()).some(t=>1===t)){const s=t.split("\n"),n=[];for(let t=0;t<s.length;t++){const i=s[t].match(wa);if(i){const t=parseInt(i[0].charAt(i[0].length-1),10);if(t>0&&1===e.get(t))continue}n.push(s[t])}t=n.join("\n")}}return t}static stripComments(t){return t.replace(/\/\*[\s\S]*?\*\/|([^\\:]|^)\/\/.*$/gm,"$1")}static processArraySize(t,e){return null!==t&&e.forEach((e,s)=>{t=t.replace(new RegExp(`\\[${s}\\]`,"g"),`[${e}]`)}),t}static injectDefines(t,e){if(null!==t&&e.size>0){const s=t.split("\n");e.forEach((t,e)=>{const n=new RegExp(e,"g");for(let e=0;e<s.length;e++)s[e].includes("#")||(s[e]=s[e].replace(n,t))}),t=s.join("\n")}return t}static RemoveEmptyLines(t){return null!==t&&(t=(t=t.split(/\r?\n/).map(t=>""===t.trim()?"":t).join("\n")).replace(/(\n\n){3,}/g,"\n\n")),t}static _preprocess(t,e=new Map,s,n,i){const r=t,a=[];let o,l=!1;for(;null!==(o=ha.exec(t))&&!l;){const h=o[1];switch(h){case"define":{ca.lastIndex=o.index;const n=ca.exec(t);l||=null===n;const r=n[1];ma.lastIndex=n.index;const h=ma.exec(r)[0];let c=r.substring(h.length).trim();""===c&&(c="true");let d=i;if(Ta._keep(a)){const i=h.startsWith("{")&&h.endsWith("}");i&&(d=!0),i?s.set(h,c):e.set(h,c),d&&(t=t.substring(0,n.index-1)+t.substring(ca.lastIndex),ha.lastIndex=n.index-1)}d||(ha.lastIndex=n.index+n[0].length);break}case"undef":{ua.lastIndex=o.index;const s=ua.exec(t),n=s[1].trim();Ta._keep(a)&&(e.delete(n),i&&(t=t.substring(0,s.index-1)+t.substring(ua.lastIndex),ha.lastIndex=s.index-1)),i||(ha.lastIndex=s.index+s[0].length);break}case"extension":{da.lastIndex=o.index;const s=da.exec(t);if(l||=null===s,s){const t=s[1];Ta._keep(a)&&e.set(t,"true")}ha.lastIndex=s.index+s[0].length;break}case"ifdef":case"ifndef":case"if":{fa.lastIndex=o.index;const s=fa.exec(t),n=s[2],i=Ta.evaluate(n,e);l||=i.error;let r=i.result;"ifndef"===h&&(r=!r),a.push({anyKeep:r,keep:r,start:o.index,end:fa.lastIndex}),ha.lastIndex=s.index+s[0].length;break}case"endif":case"else":case"elif":{pa.lastIndex=o.index;const s=pa.exec(t),n=a.pop();if(!n){console.error(`Shader preprocessing encountered "#${s[1]}" without a preceding #if #ifdef #ifndef while preprocessing ${Ta.sourceName} on line:\n ${t.substring(o.index,o.index+100)}...`,{source:r}),l=!0;continue}const i=n.keep?t.substring(n.end,o.index):"";t=t.substring(0,n.start)+i+t.substring(pa.lastIndex),ha.lastIndex=n.start+i.length;const h=s[1];if("else"===h||"elif"===h){let t=!1;if(!n.anyKeep)if("else"===h)t=!n.keep;else{const n=Ta.evaluate(s[2],e);t=n.result,l||=n.error}a.push({anyKeep:n.anyKeep||t,keep:t,start:ha.lastIndex,end:ha.lastIndex})}break}case"include":{Sa.lastIndex=o.index;const s=Sa.exec(t);if(l||=null===s,!s){l=!0;continue}const i=s[1].trim(),h=s[2]?.trim();if(Ta._keep(a)){let a=n?.get(i);if(void 0===a){console.error(`Include "${i}" not resolved while preprocessing ${Ta.sourceName}`,{originalSource:r,source:t}),l=!0;continue}if(a=this.stripComments(a),h){const s=e.get(h),n=parseFloat(s);if(Number.isInteger(n)){let t="";for(let e=0;e<n;e++)t+=a.replace(xa,String(e));a=t}else console.error(`Include Count identifier "${h}" not resolved while preprocessing ${Ta.sourceName} on line:\n ${t.substring(o.index,o.index+100)}...`,{originalSource:r,source:t}),l=!0}t=t.substring(0,s.index-1)+a+t.substring(Sa.lastIndex),ha.lastIndex=s.index-1}break}}}return a.length>0&&(console.error(`Shader preprocessing reached the end of the file without encountering the necessary #endif to close a preceding #if, #ifdef, or #ifndef block. ${Ta.sourceName}`),l=!0),l?(console.error("Failed to preprocess shader: ",{source:r}),null):t}static _keep(t){for(let e=0;e<t.length;e++)if(!t[e].keep)return!1;return!0}static evaluateAtomicExpression(t,e){let s=!1,n=!1;if("true"===(t=t.trim()))return{result:!0,error:s};if("false"===t)return{result:!1,error:s};const i=ga.exec(t);if(i){n="!"===i[1],t=i[2].trim();const r=e.has(t);return{result:n?!r:r,error:s}}const r=ya.exec(t);if(r){const t=e.get(r[1].trim())??r[1].trim(),n=e.get(r[3].trim())??r[3].trim();let i=!1;switch(r[2].trim()){case"==":i=t===n;break;case"!=":i=t!==n;break;case"<":i=t<n;break;case"<=":i=t<=n;break;case">":i=t>n;break;case">=":i=t>=n;break;default:s=!0}return{result:i,error:s}}return{result:e.has(t),error:s}}static processParentheses(t,e){let s=!1,n=t.trim();for(;n.startsWith("(")&&n.endsWith(")");){let t=0,e=!0;for(let s=0;s<n.length-1;s++)if("("===n[s])t++;else if(")"===n[s]&&(t--,0===t)){e=!1;break}if(!e)break;n=n.slice(1,-1).trim()}for(;;){let t=!1,i=0,r=0,a=-1,o=-1,l=0;for(let e=0;e<n.length;e++)if("("===n[e]){const s=n.substring(0,e);va.test(s)?l++:0===l&&(i++,i>r&&(r=i,a=e),t=!0)}else")"===n[e]&&(l>0?l--:i>0&&(i===r&&-1!==a&&(o=e),i--));if(!t||-1===a||-1===o)break;const h=n.substring(a+1,o),{result:c,error:d}=Ta.evaluate(h,e);s=s||d,n=n.substring(0,a)+(c?"true":"false")+n.substring(o+1)}return{expression:n,error:s}}static evaluate(t,e){const s=null===ba.exec(t);let n=t,i=!1;if(-1!==t.replace(_a,"").indexOf("(")){const s=Ta.processParentheses(t,e);n=s.expression,i=s.error}if(i)return{result:!1,error:!0};const r=n.split("||");for(const t of r){const n=t.split("&&");let i=!0;for(const t of n){const{result:s,error:n}=Ta.evaluateAtomicExpression(t.trim(),e);if(!s||n){i=!1;break}}if(i)return{result:!0,error:!s}}return{result:!1,error:!s}}}var Ca="\n#ifndef outType_0\n#define outType_0 vec4\n#endif\nlayout(location = 0) out highp outType_0 pcFragColor0;\n#if COLOR_ATTACHMENT_1\nlayout(location = 1) out highp outType_1 pcFragColor1;\n#endif\n#if COLOR_ATTACHMENT_2\nlayout(location = 2) out highp outType_2 pcFragColor2;\n#endif\n#if COLOR_ATTACHMENT_3\nlayout(location = 3) out highp outType_3 pcFragColor3;\n#endif\n#if COLOR_ATTACHMENT_4\nlayout(location = 4) out highp outType_4 pcFragColor4;\n#endif\n#if COLOR_ATTACHMENT_5\nlayout(location = 5) out highp outType_5 pcFragColor5;\n#endif\n#if COLOR_ATTACHMENT_6\nlayout(location = 6) out highp outType_6 pcFragColor6;\n#endif\n#if COLOR_ATTACHMENT_7\nlayout(location = 7) out highp outType_7 pcFragColor7;\n#endif\n#define gl_FragColor pcFragColor0\n#define varying in\n#define texture2D texture\n#define texture2DBias texture\n#define textureCube texture\n#define texture2DProj textureProj\n#define texture2DLod textureLod\n#define texture2DProjLod textureProjLod\n#define textureCubeLod textureLod\n#define texture2DGrad textureGrad\n#define texture2DProjGrad textureProjGrad\n#define textureCubeGrad textureGrad\n#define utexture2D texture\n#define itexture2D texture\n#define texture2DLodEXT texture2DLodEXT_is_no_longer_supported_use_texture2DLod_instead\n#define texture2DProjLodEXT texture2DProjLodEXT_is_no_longer_supported_use_texture2DProjLod\n#define textureCubeLodEXT textureCubeLodEXT_is_no_longer_supported_use_textureCubeLod_instead\n#define texture2DGradEXT texture2DGradEXT_is_no_longer_supported_use_texture2DGrad_instead\n#define texture2DProjGradEXT texture2DProjGradEXT_is_no_longer_supported_use_texture2DProjGrad_instead\n#define textureCubeGradEXT textureCubeGradEXT_is_no_longer_supported_use_textureCubeGrad_instead\n#define textureShadow(res, uv) textureGrad(res, uv, vec2(1, 1), vec2(1, 1))\n#define SHADOWMAP_PASS(name) name\n#define SHADOWMAP_ACCEPT(name) sampler2DShadow name\n#define TEXTURE_PASS(name) name\n#define TEXTURE_ACCEPT(name) sampler2D name\n#define TEXTURE_ACCEPT_HIGHP(name) highp sampler2D name\n#define GL2\n",Ea="\n#extension GL_ANGLE_multi_draw : enable\n#define attribute in\n#define varying out\n#define texture2D texture\n#define utexture2D texture\n#define itexture2D texture\n#define GL2\n#define VERTEXSHADER\n#define TEXTURE_PASS(name) name\n#define TEXTURE_ACCEPT(name) sampler2D name\n#define TEXTURE_ACCEPT_HIGHP(name) highp sampler2D name\n",Aa="\n#extension GL_EXT_samplerless_texture_functions : require\n#ifndef outType_0\n#define outType_0 vec4\n#endif\n#ifndef outType_1\n#define outType_1 vec4\n#endif\n#ifndef outType_2\n#define outType_2 vec4\n#endif\n#ifndef outType_3\n#define outType_3 vec4\n#endif\n#ifndef outType_4\n#define outType_4 vec4\n#endif\n#ifndef outType_5\n#define outType_5 vec4\n#endif\n#ifndef outType_6\n#define outType_6 vec4\n#endif\n#ifndef outType_7\n#define outType_7 vec4\n#endif\nlayout(location = 0) out highp outType_0 pcFragColor0;\nlayout(location = 1) out highp outType_1 pcFragColor1;\nlayout(location = 2) out highp outType_2 pcFragColor2;\nlayout(location = 3) out highp outType_3 pcFragColor3;\nlayout(location = 4) out highp outType_4 pcFragColor4;\nlayout(location = 5) out highp outType_5 pcFragColor5;\nlayout(location = 6) out highp outType_6 pcFragColor6;\nlayout(location = 7) out highp outType_7 pcFragColor7;\n#define gl_FragColor pcFragColor0\n#define texture2D(res, uv) texture(sampler2D(res, res ## _sampler), uv)\n#define texture2DBias(res, uv, bias) texture(sampler2D(res, res ## _sampler), uv, bias)\n#define texture2DLod(res, uv, lod) textureLod(sampler2D(res, res ## _sampler), uv, lod)\n#define textureCube(res, uv) texture(samplerCube(res, res ## _sampler), uv)\n#define textureCubeLod(res, uv, lod) textureLod(samplerCube(res, res ## _sampler), uv, lod)\n#define textureShadow(res, uv) textureLod(sampler2DShadow(res, res ## _sampler), uv, 0.0)\n#define itexture2D(res, uv) texture(isampler2D(res, res ## _sampler), uv)\n#define utexture2D(res, uv) texture(usampler2D(res, res ## _sampler), uv)\n#define texture2DLodEXT texture2DLodEXT_is_no_longer_supported_use_texture2DLod_instead\n#define texture2DProjLodEXT texture2DProjLodEXT_is_no_longer_supported_use_texture2DProjLod\n#define textureCubeLodEXT textureCubeLodEXT_is_no_longer_supported_use_textureCubeLod_instead\n#define texture2DGradEXT texture2DGradEXT_is_no_longer_supported_use_texture2DGrad_instead\n#define texture2DProjGradEXT texture2DProjGradEXT_is_no_longer_supported_use_texture2DProjGrad_instead\n#define textureCubeGradEXT textureCubeGradEXT_is_no_longer_supported_use_textureCubeGrad_instead\n#define SHADOWMAP_PASS(name) name, name ## _sampler\n#define SHADOWMAP_ACCEPT(name) texture2D name, sampler name ## _sampler\n#define TEXTURE_PASS(name) name, name ## _sampler\n#define TEXTURE_ACCEPT(name) texture2D name, sampler name ## _sampler\n#define TEXTURE_ACCEPT_HIGHP TEXTURE_ACCEPT\n#define GL2\n#define WEBGPU\n",Da="\n#extension GL_EXT_samplerless_texture_functions : require\n#define texture2D(res, uv) texture(sampler2D(res, res ## _sampler), uv)\n#define itexture2D(res, uv) texture(isampler2D(res, res ## _sampler), uv)\n#define utexture2D(res, uv) texture(usampler2D(res, res ## _sampler), uv)\n#define TEXTURE_PASS(name) name, name ## _sampler\n#define TEXTURE_ACCEPT(name) texture2D name, sampler name ## _sampler\n#define TEXTURE_ACCEPT_HIGHP TEXTURE_ACCEPT\n#define GL2\n#define WEBGPU\n#define VERTEXSHADER\n#define gl_VertexID gl_VertexIndex\n#define gl_InstanceID gl_InstanceIndex\n",Pa="\n#define VERTEXSHADER\n",La="\nvec2 getGrabScreenPos(vec4 clipPos) {\n\tvec2 uv = (clipPos.xy / clipPos.w) * 0.5 + 0.5;\n\t#ifdef WEBGPU\n\t\tuv.y = 1.0 - uv.y;\n\t#endif\n\treturn uv;\n}\nvec2 getImageEffectUV(vec2 uv) {\n\t#ifdef WEBGPU\n\t\tuv.y = 1.0 - uv.y;\n\t#endif\n\treturn uv;\n}\n",Ia="\n#define WEBGPU\nfn getGrabScreenPos(clipPos: vec4<f32>) -> vec2<f32> {\n\tvar uv: vec2<f32> = (clipPos.xy / clipPos.w) * 0.5 + vec2<f32>(0.5);\n\tuv.y = 1.0 - uv.y;\n\treturn uv;\n}\nfn getImageEffectUV(uv: vec2<f32>) -> vec2<f32> {\n\tvar modifiedUV: vec2<f32> = uv;\n\tmodifiedUV.y = 1.0 - modifiedUV.y;\n\treturn modifiedUV;\n}\nstruct WrappedF32 { @size(16) element: f32 }\nstruct WrappedI32 { @size(16) element: i32 }\nstruct WrappedU32 { @size(16) element: u32 }\nstruct WrappedVec2F { @size(16) element: vec2f }\nstruct WrappedVec2I { @size(16) element: vec2i }\nstruct WrappedVec2U { @size(16) element: vec2u }\n";const Ra={vertex_position:Ys,vertex_normal:Qs,vertex_tangent:Zs,vertex_texCoord0:nn,vertex_texCoord1:rn,vertex_texCoord2:an,vertex_texCoord3:on,vertex_texCoord4:ln,vertex_texCoord5:hn,vertex_texCoord6:cn,vertex_texCoord7:dn,vertex_color:en,vertex_boneIndices:tn,vertex_boneWeights:Js};class Ma{static createDefinition(t,e){const s=t=>{let e=t.fragmentOutputTypes??"vec4";return Array.isArray(e)||(e=[e]),e},n=(e,n,i,r)=>{const a=t.isWebGPU?e:n;let o="";if(!i){const e=s(r);for(let s=0;s<t.maxColorAttachments;s++){o+=`#define COLOR_ATTACHMENT_${s}\n`;o+=`#define outType_${s} ${e[s]??"vec4"}\n`}}return o+a},i=(e,n)=>{let i="";if(!e){const e=s(n);for(let s=0;s<t.maxColorAttachments;s++){const t=e[s]??"vec4";i+=`alias pcOutType${s} = ${si.get(t)};\n`}}return i},r=e.name??"Untitled";let a,o;const l=Ma.getDefinesCode(t,e.vertexDefines),h=Ma.getDefinesCode(t,e.fragmentDefines);return e.shaderLanguage===Rn?(a=`\n\t\t\t\t\t\t\t\t${i(!0,e)}\n\t\t\t\t\t\t\t\t${Pa}\n\t\t\t\t\t\t\t\t${Ia}\n\t\t\t\t\t\t\t\t${l}\n\t\t\t\t\t\t\t\t${e.vertexCode}\n\t\t\t\t\t\t`,o=`\n\t\t\t\t\t\t\t\t${i(!1,e)}\n\t\t\t\t\t\t\t\t\n\n\t\t\t\t\t\t\t\t${Ia}\n\t\t\t\t\t\t\t\t${h}\n\t\t\t\t\t\t\t\t${e.fragmentCode}\n\t\t\t\t\t\t`):(a=`${Ma.versionCode(t)+n(Da,Ea,!0,e)+l+Ma.precisionCode(t)}\n\t\t\t\t\t\t\t\t${La}\n\t\t\t\t\t\t\t\t${Ma.getShaderNameCode(r)}\n\t\t\t\t\t\t\t\t${e.vertexCode}`,o=`${(e.fragmentPreamble||"")+Ma.versionCode(t)+n(Aa,Ca,!1,e)+h+Ma.precisionCode(t)}\n\t\t\t\t\t\t\t\t${La}\n\t\t\t\t\t\t\t\t${Ma.getShaderNameCode(r)}\n\t\t\t\t\t\t\t\t${e.fragmentCode}`),{name:r,shaderLanguage:e.shaderLanguage??In,attributes:e.attributes,vshader:a,vincludes:e.vertexIncludes,fincludes:e.fragmentIncludes,fshader:o,feedbackVaryings:e.feedbackVaryings,useTransformFeedback:e.useTransformFeedback,meshUniformBufferFormat:e.meshUniformBufferFormat,meshBindGroupFormat:e.meshBindGroupFormat}}static getDefinesCode(t,e){let s="";return t.capsDefines.forEach((t,e)=>{s+=`#define ${e} ${t}\n`}),s+="\n",e?.forEach((t,e)=>{s+=`#define ${e} ${t}\n`}),s+="\n",s}static getShaderNameCode(t){return`#define SHADER_NAME ${t}\n`}static versionCode(t){return t.isWebGPU?"#version 450\n":"#version 300 es\n"}static precisionCode(t,e){e&&"highp"!==e&&"mediump"!==e&&"lowp"!==e&&(e=null),e&&("highp"===e&&"highp"!==t.maxPrecision&&(e="mediump"),"mediump"===e&&"lowp"===t.maxPrecision&&(e="lowp"));const s=e||t.precision;return`\n\t\t\t\t\t\tprecision ${s} float;\n\t\t\t\t\t\tprecision ${s} int;\n\t\t\t\t\t\tprecision ${s} usampler2D;\n\t\t\t\t\t\tprecision ${s} isampler2D;\n\t\t\t\t\t\tprecision ${s} sampler2DShadow;\n\t\t\t\t\t\tprecision ${s} samplerCubeShadow;\n\t\t\t\t\t\tprecision ${s} sampler2DArray;\n\t\t\t\t`}static collectAttributes(t){const e={};let s=0,n=t.indexOf("attribute");for(;n>=0&&!(n>0&&"/"===t[n-1]);){let i=!1;if(n>0){let e=t.lastIndexOf("\n",n);e=-1!==e?e+1:0;t.substring(e,n).includes("#")&&(i=!0)}if(!i){const i=t.indexOf(";",n),r=t.lastIndexOf(" ",i),a=t.substring(r+1,i);if(e[a]);else{const t=Ra[a];void 0!==t?e[a]=t:(e[a]=`ATTR${s}`,s++)}}n=t.indexOf("attribute",n+1)}return e}}let ka=0;class Oa{constructor(t,e){if(this.attributes=new Map,this.id=ka++,this.device=t,this.definition=e,this.name=e.name||"Untitled",this.init(),e.cshader)e.cshader=Ta.run(e.cshader,e.cincludes,{sourceName:`compute shader for ${this.label}`,stripDefines:!0});else{const s=e.shaderLanguage===Rn;e.vshader=Ta.run(e.vshader,e.vincludes,{sourceName:`vertex shader for ${this.label}`,stripDefines:s}),e.shaderLanguage===In&&(e.attributes??=Ma.collectAttributes(e.vshader));const n=t.isWebGL2&&("osx"===ze.name||"ios"===ze.name);if(e.fshader=Ta.run(e.fshader,e.fincludes,{stripUnusedColorAttachments:n,stripDefines:s,sourceName:`fragment shader for ${this.label}`}),!e.vshader||!e.fshader)return void(this.failed=!0)}this.impl=t.createShaderImpl(this)}init(){this.ready=!1,this.failed=!1}get label(){return`Shader Id ${this.id} (${this.definition.shaderLanguage===Rn?"WGSL":"GLSL"}) ${this.name}`}destroy(){this.device.onDestroyShader(this),this.impl.destroy(this)}loseContext(){this.init(),this.impl.loseContext()}restoreContext(){this.impl.restoreContext(this.device,this)}}class Fa{}class Na{}class Ba{constructor(t,e,s){this.gpuBuffers=[],this.stagingBuffers=[],this.usedBuffers=[],this.activeBuffer=null,this.device=t,this.bufferSize=e,this.bufferAlignment=s}destroy(){this.gpuBuffers.forEach(t=>{t.destroy(this.device)}),this.gpuBuffers=null,this.stagingBuffers.forEach(t=>{t.destroy(this.device)}),this.stagingBuffers=null,this.usedBuffers=null,this.activeBuffer=null}alloc(t,e){if(this.activeBuffer){const t=Qe.roundUp(this.activeBuffer.size,this.bufferAlignment);this.bufferSize-t<e&&this.scheduleSubmit()}if(!this.activeBuffer){let t=this.gpuBuffers.pop();t||(t=this.createBuffer(this.device,this.bufferSize,!1));let e=this.stagingBuffers.pop();e||(e=this.createBuffer(this.device,this.bufferSize,!0)),this.activeBuffer=new Fa,this.activeBuffer.stagingBuffer=e,this.activeBuffer.gpuBuffer=t,this.activeBuffer.offset=0,this.activeBuffer.size=0}const s=this.activeBuffer,n=Qe.roundUp(s.size,this.bufferAlignment);t.gpuBuffer=s.gpuBuffer,t.offset=n,t.storage=s.stagingBuffer.alloc(n,e),s.size=n+e}scheduleSubmit(){this.activeBuffer&&(this.usedBuffers.push(this.activeBuffer),this.activeBuffer=null)}submit(){this.scheduleSubmit()}}const za=[];za[2]=function(t,e,s){t.storageFloat32[s]=e},za[3]=(t,e,s)=>{const n=t.storageFloat32;n[s]=e[0],n[s+1]=e[1]},za[4]=(t,e,s)=>{const n=t.storageFloat32;n[s]=e[0],n[s+1]=e[1],n[s+2]=e[2]},za[5]=(t,e,s)=>{const n=t.storageFloat32;n[s]=e[0],n[s+1]=e[1],n[s+2]=e[2],n[s+3]=e[3]},za[1]=function(t,e,s){t.storageInt32[s]=e},za[6]=function(t,e,s){const n=t.storageInt32;n[s]=e[0],n[s+1]=e[1]},za[7]=function(t,e,s){const n=t.storageInt32;n[s]=e[0],n[s+1]=e[1],n[s+2]=e[2]},za[8]=function(t,e,s){const n=t.storageInt32;n[s]=e[0],n[s+1]=e[1],n[s+2]=e[2],n[s+3]=e[3]},za[12]=(t,e,s)=>{const n=t.storageFloat32;n[s]=e[0],n[s+1]=e[1],n[s+4]=e[2],n[s+5]=e[3],n[s+8]=e[4],n[s+9]=e[5]},za[13]=(t,e,s)=>{const n=t.storageFloat32;n[s]=e[0],n[s+1]=e[1],n[s+2]=e[2],n[s+4]=e[3],n[s+5]=e[4],n[s+6]=e[5],n[s+8]=e[6],n[s+9]=e[7],n[s+10]=e[8]},za[17]=function(t,e,s,n){const i=t.storageFloat32;for(let t=0;t<n;t++)i[s+4*t]=e[t]},za[21]=(t,e,s,n)=>{const i=t.storageFloat32;for(let t=0;t<n;t++)i[s+4*t]=e[2*t],i[s+4*t+1]=e[2*t+1]},za[22]=(t,e,s,n)=>{const i=t.storageFloat32;for(let t=0;t<n;t++)i[s+4*t]=e[3*t],i[s+4*t+1]=e[3*t+1],i[s+4*t+2]=e[3*t+2]},za[26]=(t,e,s,n)=>{t.storageUint32[s]=e},za[27]=(t,e,s,n)=>{const i=t.storageUint32;i[s]=e[0],i[s+1]=e[1]},za[28]=(t,e,s,n)=>{const i=t.storageUint32;i[s]=e[0],i[s+1]=e[1],i[s+2]=e[2]},za[29]=(t,e,s,n)=>{const i=t.storageUint32;i[s]=e[0],i[s+1]=e[1],i[s+2]=e[2],i[s+3]=e[3]},za[30]=function(t,e,s,n){const i=t.storageInt32;for(let t=0;t<n;t++)i[s+4*t]=e[t]},za[32]=za[30],za[31]=function(t,e,s,n){const i=t.storageUint32;for(let t=0;t<n;t++)i[s+4*t]=e[t]},za[33]=(t,e,s,n)=>{const i=t.storageInt32;for(let t=0;t<n;t++)i[s+4*t]=e[2*t],i[s+4*t+1]=e[2*t+1]},za[35]=za[33],za[34]=(t,e,s,n)=>{const i=t.storageUint32;for(let t=0;t<n;t++)i[s+4*t]=e[2*t],i[s+4*t+1]=e[2*t+1]},za[36]=(t,e,s,n)=>{const i=t.storageInt32;for(let t=0;t<n;t++)i[s+4*t]=e[3*t],i[s+4*t+1]=e[3*t+1],i[s+4*t+2]=e[3*t+2]},za[38]=za[36],za[37]=(t,e,s,n)=>{const i=t.storageUint32;for(let t=0;t<n;t++)i[s+4*t]=e[3*t],i[s+4*t+1]=e[3*t+1],i[s+4*t+2]=e[3*t+2]};class Ua{constructor(t,e,s=!0){if(this.renderVersionDirty=0,this.device=t,this.format=e,this.persistent=s,s){this.impl=t.createUniformBufferImpl(this);const s=new ArrayBuffer(e.byteSize);this.assignStorage(new Int32Array(s)),t._vram.ub+=this.format.byteSize}else this.allocation=new Na}destroy(){if(this.persistent){const t=this.device;this.impl.destroy(t),t._vram.ub-=this.format.byteSize}}get offset(){return this.persistent?0:this.allocation.offset}assignStorage(t){this.storageInt32=t,this.storageUint32=new Uint32Array(t.buffer,t.byteOffset,t.byteLength/4),this.storageFloat32=new Float32Array(t.buffer,t.byteOffset,t.byteLength/4)}loseContext(){this.impl?.loseContext()}setUniform(t,e){const s=t.offset;if(null!=e){const n=za[t.updateType];n?n(this,e,s,t.count):this.storageFloat32.set(e,s)}}set(t,e){const s=this.format.map.get(t);s&&this.setUniform(s,e)}startUpdate(t){if(!this.persistent){const e=this.allocation,s=e.gpuBuffer;this.device.dynamicBuffers.alloc(e,this.format.byteSize),this.assignStorage(e.storage),t&&(t.bindGroup=e.gpuBuffer.getBindGroup(this),t.offsets[0]=e.offset),s!==e.gpuBuffer&&(this.renderVersionDirty=this.device.renderVersion)}}endUpdate(){this.persistent?this.impl.unlock(this):(this.storageFloat32=null,this.storageInt32=null)}update(t){this.startUpdate(t);const e=this.format.uniforms;for(let t=0;t<e.length;t++){const s=e[t].scopeId.value;this.setUniform(e[t],s)}this.endUpdate()}}const Va={type:5,base:0,baseVertex:0,count:4,indexed:!1};class Ha{constructor(t){const e="\n\n\t\t\t\t\t\tstruct ub_mesh {\n\t\t\t\t\t\t\t\tcolor : vec4f,\n\t\t\t\t\t\t\t\tdepth: f32\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t@group(2) @binding(0) var<uniform> ubMesh : ub_mesh;\n\n\t\t\t\t\t\tvar<private> pos : array<vec2f, 4> = array<vec2f, 4>(\n\t\t\t\t\t\t\t\tvec2(-1.0, 1.0), vec2(1.0, 1.0),\n\t\t\t\t\t\t\t\tvec2(-1.0, -1.0), vec2(1.0, -1.0)\n\t\t\t\t\t\t);\n\n\t\t\t\t\t\tstruct VertexOutput {\n\t\t\t\t\t\t\t\t@builtin(position) position : vec4f\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t@vertex\n\t\t\t\t\t\tfn vertexMain(@builtin(vertex_index) vertexIndex : u32) -> VertexOutput {\n\t\t\t\t\t\t\t\tvar output : VertexOutput;\n\t\t\t\t\t\t\t\toutput.position = vec4(pos[vertexIndex], ubMesh.depth, 1.0);\n\t\t\t\t\t\t\t\treturn output;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t@fragment\n\t\t\t\t\t\tfn fragmentMain() -> @location(0) vec4f {\n\t\t\t\t\t\t\t\treturn ubMesh.color;\n\t\t\t\t\t\t}\n\t\t\t\t";this.shader=new Oa(t,{name:"WebGPUClearRendererShader",shaderLanguage:Rn,vshader:e,fshader:e}),this.uniformBuffer=new Ua(t,new Dr(t,[new Ar("color",5),new Ar("depth",2)]),!1),this.dynamicBindGroup=new bi,this.colorData=new Float32Array(4)}destroy(){this.shader.destroy(),this.shader=null,this.uniformBuffer.destroy(),this.uniformBuffer=null}clear(t,e,s,n){const i=(s=s||n).flags??n.flags;if(0!==i){const{uniformBuffer:r,dynamicBindGroup:a}=this;if(r.startUpdate(a),t.setBindGroup(2,a.bindGroup,a.offsets),t.setBindGroup(1,t.emptyBindGroup),1&i&&(e.colorBuffer||e.impl.assignedColorTexture)){const e=s.color??n.color;this.colorData.set(e),t.setBlendState(Ti.NOBLEND)}else t.setBlendState(Ti.NOWRITE);if(r.set("color",this.colorData),2&i&&e.depth){const e=s.depth??n.depth;r.set("depth",e),t.setDepthState(Ai.WRITEDEPTH)}else r.set("depth",1),t.setDepthState(Ai.NODEPTH);r.endUpdate(),t.setCullMode(0),t.setShader(this.shader),t.draw(Va)}}}class Ga{constructor(t){this.device=t;const e="\n \n\t\t\t\t\t\tvar<private> pos : array<vec2f, 4> = array<vec2f, 4>(\n\t\t\t\t\t\t\t\tvec2(-1.0, 1.0), vec2(1.0, 1.0),\n\t\t\t\t\t\t\t\tvec2(-1.0, -1.0), vec2(1.0, -1.0)\n\t\t\t\t\t\t);\n\n\t\t\t\t\t\tstruct VertexOutput {\n\t\t\t\t\t\t\t\t@builtin(position) position : vec4f,\n\t\t\t\t\t\t\t\t@location(0) texCoord : vec2f\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\t@vertex\n\t\t\t\t\t\tfn vertexMain(@builtin(vertex_index) vertexIndex : u32) -> VertexOutput {\n\t\t\t\t\t\t\tvar output : VertexOutput;\n\t\t\t\t\t\t\toutput.texCoord = pos[vertexIndex] * vec2f(0.5, -0.5) + vec2f(0.5);\n\t\t\t\t\t\t\toutput.position = vec4f(pos[vertexIndex], 0, 1);\n\t\t\t\t\t\t\treturn output;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t@group(0) @binding(0) var imgSampler : sampler;\n\t\t\t\t\t\t@group(0) @binding(1) var img : texture_2d<f32>;\n\n\t\t\t\t\t\t@fragment\n\t\t\t\t\t\tfn fragmentMain(@location(0) texCoord : vec2f) -> @location(0) vec4f {\n\t\t\t\t\t\t\treturn textureSample(img, imgSampler, texCoord);\n\t\t\t\t\t\t}\n\t\t\t\t";this.shader=new Oa(t,{name:"WebGPUMipmapRendererShader",shaderLanguage:Rn,vshader:e,fshader:e}),this.minSampler=t.wgpu.createSampler({minFilter:"linear"})}destroy(){this.shader.destroy(),this.shader=null}generate(t){const e=t.desc;if(e.mipLevelCount<=1)return;if(t.texture.volume)return;const s=this.device,n=s.wgpu,i=this.shader.impl,r=n.createRenderPipeline({layout:"auto",vertex:{module:i.getVertexShaderModule(),entryPoint:i.vertexEntryPoint},fragment:{module:i.getFragmentShaderModule(),entryPoint:i.fragmentEntryPoint,targets:[{format:e.format}]},primitive:{topology:"triangle-strip"}}),a=t.texture,o=a.cubemap?6:a.array?a.arrayLength:1,l=[];for(let e=0;e<o;e++)l.push(t.createView({dimension:"2d",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:e}));const h=s.getCommandEncoder();for(let s=1;s<e.mipLevelCount;s++)for(let e=0;e<o;e++){const i=t.createView({dimension:"2d",baseMipLevel:s,mipLevelCount:1,baseArrayLayer:e}),a=h.beginRenderPass({colorAttachments:[{view:i,loadOp:"clear",storeOp:"store"}]}),o=n.createBindGroup({layout:r.getBindGroupLayout(0),entries:[{binding:0,resource:this.minSampler},{binding:1,resource:l[e]}]});a.setPipeline(r),a.setBindGroup(0,o),a.draw(4),a.end(),l[e]=i}s.pipeline=null}}class Wa{constructor(t){this.bindGroupCache=new Map,this.device=t,this.bindGroupFormat=new ci(this.device,[new ai(Yn,3)])}getBindGroup(t){const e=t.format.byteSize;let s=this.bindGroupCache.get(e);return s||(s=new Si(this.device,this.bindGroupFormat,t),s.update(),this.bindGroupCache.set(e,s)),s}}class ja extends Wa{constructor(t,e,s){super(t),this.buffer=null,this.mappedRange=null,this.buffer=t.wgpu.createBuffer({size:e,usage:s?GPUBufferUsage.MAP_WRITE|GPUBufferUsage.COPY_SRC:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,mappedAtCreation:s}),s&&this.onAvailable(),t._vram.ub+=e}destroy(t){t._vram.ub-=this.buffer.size,this.buffer.destroy(),this.buffer=null}onAvailable(){this.mappedRange=this.buffer.getMappedRange()}alloc(t,e){return new Int32Array(this.mappedRange,t,e/4)}}class $a extends Ba{createBuffer(t,e,s){return new ja(t,e,s)}submit(){super.submit();const t=this.usedBuffers.length;if(t){const e=this.device,s=this.gpuBuffers,n=e.wgpu.createCommandEncoder();for(let e=t-1;e>=0;e--){const t=this.usedBuffers[e],{stagingBuffer:i,gpuBuffer:r,offset:a,size:o}=t,l=i.buffer;l.unmap(),n.copyBufferToBuffer(l,a,r.buffer,a,o),s.push(r)}const i=n.finish();e.addCommandBuffer(i,!0);for(let e=0;e<t;e++){const t=this.usedBuffers[e].stagingBuffer;this.pendingStagingBuffers.push(t)}this.usedBuffers.length=0}}onCommandBuffersSubmitted(){const t=this.pendingStagingBuffers.length;if(t){for(let e=0;e<t;e++){const t=this.pendingStagingBuffers[e];t.buffer.mapAsync(GPUMapMode.WRITE).then(()=>{this.stagingBuffers&&(t.onAvailable(),this.stagingBuffers.push(t))})}this.pendingStagingBuffers.length=0}}constructor(...t){super(...t),this.pendingStagingBuffers=[]}}class Xa{loseContext(){this.pastFrameAllocations.clear()}set enabled(t){this._enableRequest=t}get enabled(){return this._enableRequest}processEnableRequest(){this._enableRequest!==this._enabled&&(this._enabled=this._enableRequest,this._enabled||(this._frameTime=0))}request(t){this.pastFrameAllocations.set(t,this.frameAllocations),this.frameAllocations=[]}report(t,e){e&&(this.pastFrameAllocations.get(t),e.length>0&&(this._frameTime=e.reduce((t,e)=>t+e,0)),Ye.get("GpuTimings")),this.pastFrameAllocations.delete(t)}getSlot(t){if(this.frameAllocations.length>=this.maxCount)return-1;const e=this.frameAllocations.length;return this.frameAllocations.push(t),e}get slotCount(){return this.frameAllocations.length}constructor(){this.frameAllocations=[],this.pastFrameAllocations=new Map,this._enabled=!1,this._enableRequest=!1,this._frameTime=0,this.maxCount=9999}}class qa{constructor(t,e,s){this.stagingBuffers=[],this.activeStagingBuffer=null,this.device=t,this.capacity=s,this.bytesPerSlot=e?8:4;const n=t.wgpu;this.querySet=n.createQuerySet({type:e?"timestamp":"occlusion",count:s}),this.queryBuffer=n.createBuffer({size:this.bytesPerSlot*s,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST})}destroy(){this.querySet?.destroy(),this.querySet=null,this.queryBuffer?.destroy(),this.queryBuffer=null,this.activeStagingBuffer=null,this.stagingBuffers.forEach(t=>{t.destroy()}),this.stagingBuffers=null}getStagingBuffer(){let t=this.stagingBuffers.pop();return t||(t=this.device.wgpu.createBuffer({size:this.queryBuffer.size,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ})),t}resolve(t){const e=this.device.getCommandEncoder();e.resolveQuerySet(this.querySet,0,t,this.queryBuffer,0);const s=this.getStagingBuffer();this.activeStagingBuffer=s,e.copyBufferToBuffer(this.queryBuffer,0,s,0,this.bytesPerSlot*t)}request(t,e){const s=this.activeStagingBuffer;return this.activeStagingBuffer=null,s.mapAsync(GPUMapMode.READ).then(()=>{const n=new BigInt64Array(s.getMappedRange()),i=[];for(let e=0;e<t;e++)i.push(1e-6*Number(n[2*e+1]-n[2*e]));return s.unmap(),this.stagingBuffers?.push(s),{renderVersion:e,timings:i}})}}class Ka extends Xa{constructor(t){super(),this.device=t,this.maxCount=1024,this.timestampQueriesSet=t.supportsTimestampQuery?new qa(t,!0,2*this.maxCount):null}destroy(){this.timestampQueriesSet?.destroy(),this.timestampQueriesSet=null}frameStart(){this.processEnableRequest()}frameEnd(){this._enabled&&this.timestampQueriesSet?.resolve(2*this.slotCount)}request(){if(this._enabled){const t=this.device.renderVersion;this.timestampQueriesSet?.request(this.slotCount,t).then(t=>{this.report(t.renderVersion,t.timings)}),super.request(t)}}}class Ya{constructor(t){this.pipelineCache=new Map,this.device=t;const e="\n \n\t\t\t\t\t\tvar<private> pos : array<vec2f, 4> = array<vec2f, 4>(\n\t\t\t\t\t\t\t\tvec2(-1.0, 1.0), vec2(1.0, 1.0), vec2(-1.0, -1.0), vec2(1.0, -1.0)\n\t\t\t\t\t\t);\n\n\t\t\t\t\t\tstruct VertexOutput {\n\t\t\t\t\t\t\t\t@builtin(position) position : vec4f,\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\t@vertex\n\t\t\t\t\t\tfn vertexMain(@builtin(vertex_index) vertexIndex : u32) -> VertexOutput {\n\t\t\t\t\t\t\tvar output : VertexOutput;\n\t\t\t\t\t\t\toutput.position = vec4f(pos[vertexIndex], 0, 1);\n\t\t\t\t\t\t\treturn output;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t@group(0) @binding(0) var img : texture_depth_multisampled_2d;\n\n\t\t\t\t\t\t@fragment\n\t\t\t\t\t\tfn fragmentMain(@builtin(position) fragColor: vec4f) -> @location(0) vec4f {\n\t\t\t\t\t\t\t\t// load th depth value from sample index 0\n\t\t\t\t\t\t\t\tvar depth = textureLoad(img, vec2i(fragColor.xy), 0u);\n\t\t\t\t\t\t\t\treturn vec4f(depth, 0.0, 0.0, 0.0);\n\t\t\t\t\t\t}\n\t\t\t\t";this.shader=new Oa(t,{name:"WebGPUResolverDepthShader",shaderLanguage:Rn,vshader:e,fshader:e})}destroy(){this.shader.destroy(),this.shader=null,this.pipelineCache=null}getPipeline(t){let e=this.pipelineCache.get(t);return e||(e=this.createPipeline(t),this.pipelineCache.set(t,e)),e}createPipeline(t){const e=this.shader.impl;return this.device.wgpu.createRenderPipeline({layout:"auto",vertex:{module:e.getVertexShaderModule(),entryPoint:e.vertexEntryPoint},fragment:{module:e.getFragmentShaderModule(),entryPoint:e.fragmentEntryPoint,targets:[{format:t}]},primitive:{topology:"triangle-strip"}})}resolveDepth(t,e,s){const n=this.device,i=n.wgpu,r=this.getPipeline(s.format),a=e.depthOrArrayLayers;for(let n=0;n<a;n++){const a=e.createView({dimension:"2d",aspect:"depth-only",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:n}),o=s.createView({dimension:"2d",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:n}),l=t.beginRenderPass({colorAttachments:[{view:o,loadOp:"clear",storeOp:"store"}]}),h=i.createBindGroup({layout:r.getBindGroupLayout(0),entries:[{binding:0,resource:a}]});l.setPipeline(r),l.setBindGroup(0,h),l.draw(4),l.end()}n.pipeline=null}}class Qa{constructor(t){this.uniformBuffers=[],this.bindGroup=null,this.compute=t;const{device:e,shader:s}=t,{computeBindGroupFormat:n,computeUniformBufferFormats:i}=s.impl;if(this.bindGroup=new Si(e,n),i)for(const t in i)if(i.hasOwnProperty(t)){const s=new Ua(e,i[t],!0);this.uniformBuffers.push(s),this.bindGroup.setUniformBuffer(t,s)}this.pipeline=e.computePipeline.get(s,n)}destroy(){this.uniformBuffers.forEach(t=>t.destroy()),this.uniformBuffers.length=0,this.bindGroup.destroy(),this.bindGroup=null}updateBindGroup(){const{bindGroup:t}=this;t.updateUniformBuffers(),t.update()}dispatch(t,e,s){const n=this.compute.device;n.setBindGroup(0,this.bindGroup);const i=n.passEncoder;i.setPipeline(this.pipeline),i.dispatchWorkgroups(t,e,s)}}let Za=0;class Ja{constructor(t,e,s=0,n=!0){this.id=Za++,this.device=t,this.byteSize=e,this.bufferUsage=s;const i=n?128|s:s;this.impl=t.createBufferImpl(i),this.impl.allocate(t,e),this.device.buffers.push(this),this.adjustVramSizeTracking(t._vram,this.byteSize)}destroy(){const t=this.device,e=t.buffers.indexOf(this);-1!==e&&t.buffers.splice(e,1),this.adjustVramSizeTracking(t._vram,-this.byteSize),this.impl.destroy(t)}adjustVramSizeTracking(t,e){t.sb+=e}read(t=0,e=this.byteSize,s=null,n=!1){return this.impl.read(this.device,t,e,s,n)}write(t=0,e,s=0,n){this.impl.write(this.device,t,e,s,n)}clear(t=0,e=this.byteSize){this.impl.clear(this.device,t,e)}copy(t,e=0,s=0,n=t.byteSize-e){this.device.getCommandEncoder().copyBufferToBuffer(t.impl.buffer,e,this.impl.buffer,s,n)}}class to{constructor(t){this.gpuIndirect=null,this.gpuIndirectSigned=null,this.storage=null,this.device=t}allocate(t){this.gpuIndirect=new Uint32Array(5*t),this.gpuIndirectSigned=new Int32Array(this.gpuIndirect.buffer),this.storage=new Ja(this.device,this.gpuIndirect.byteLength,264)}add(t,e,s,n,i=0,r=0){const a=5*t;this.gpuIndirect[a+0]=e,this.gpuIndirect[a+1]=s,this.gpuIndirect[a+2]=n,this.gpuIndirectSigned[a+3]=i,this.gpuIndirect[a+4]=r}update(t){if(this.storage&&t>0){const e=5*t;this.storage.write(0,this.gpuIndirect,0,e)}}destroy(){this.storage?.destroy(),this.storage=null}}class eo{constructor(t){this.availableStagingBuffers=[],this.pendingStagingBuffers=[],this._destroyed=!1,this.uploadStream=t,this.useSingleBuffer=t.useSingleBuffer}_onDeviceLost(){}destroy(){this._destroyed=!0,this.availableStagingBuffers.forEach(t=>t.destroy()),this.pendingStagingBuffers.forEach(t=>t.destroy())}update(t){const e=this.pendingStagingBuffers;for(let t=0;t<e.length;t++){const s=e[t];s.mapAsync(GPUMapMode.WRITE).then(()=>{this._destroyed?s.destroy():this.availableStagingBuffers.push(s)})}e.length=0;const s=this.availableStagingBuffers;for(let e=s.length-1;e>=0;e--)s[e].size<t&&(s[e].destroy(),s.splice(e,1))}upload(t,e,s,n){this.useSingleBuffer?this.uploadDirect(t,e,s,n):this.uploadStaging(t,e,s,n)}uploadDirect(t,e,s,n){const i=s*t.BYTES_PER_ELEMENT;e.write(i,t,0,n)}uploadStaging(t,e,s,n){const i=this.uploadStream.device,r=s*t.BYTES_PER_ELEMENT,a=n*t.BYTES_PER_ELEMENT;this.update(a);const o=this.availableStagingBuffers.pop()??(()=>this.uploadStream.device.wgpu.createBuffer({size:a,usage:GPUBufferUsage.MAP_WRITE|GPUBufferUsage.COPY_SRC,mappedAtCreation:!0}))(),l=o.getMappedRange();new Uint8Array(l).set(new Uint8Array(t.buffer,t.byteOffset,a)),o.unmap(),i.getCommandEncoder().copyBufferToBuffer(o,0,e.impl.buffer,r,a),this.pendingStagingBuffers.push(o)}}const so=new Map;class no extends Gi{constructor(t,e={}){super(t,e),this.renderPipeline=new pr(this),this.computePipeline=new mr(this),this._indirectDrawBuffer=null,this._indirectDrawBufferCount=0,this._indirectDrawNextIndex=0,this.pipeline=null,this.bindGroupFormats=[],this.commandEncoder=null,this.commandBuffers=[],this.glslang=null,this.twgsl=null,(e=this.initOptions).alpha=e.alpha??!0,this.backBufferAntialias=e.antialias??!1,this.isWebGPU=!0,this._deviceType=$n,this.scope.resolve(Qn).setValue(0)}destroy(){this.clearRenderer.destroy(),this.clearRenderer=null,this.mipmapRenderer.destroy(),this.mipmapRenderer=null,this.resolver.destroy(),this.resolver=null,super.destroy()}initDeviceCaps(){const t=this.wgpu?.limits;this.limits=t,this.precision="highp",this.maxPrecision="highp",this.maxSamples=4,this.maxTextures=16,this.maxTextureSize=t.maxTextureDimension2D,this.maxCubeMapSize=t.maxTextureDimension2D,this.maxVolumeSize=t.maxTextureDimension3D,this.maxColorAttachments=t.maxColorAttachments,this.maxPixelRatio=1,this.maxAnisotropy=16,this.fragmentUniformsCount=t.maxUniformBufferBindingSize/16,this.vertexUniformsCount=t.maxUniformBufferBindingSize/16,this.supportsUniformBuffers=!0,this.supportsAreaLights=!0,this.supportsGpuParticles=!0,this.supportsCompute=!0,this.textureFloatRenderable=!0,this.textureHalfFloatRenderable=!0,this.supportsImageBitmap=!0,this.samples=this.backBufferAntialias?4:1;const e=window.navigator.gpu.wgslLanguageFeatures;this.supportsStorageTextureRead=e?.has("readonly_and_readwrite_storage_textures"),this.initCapsDefines()}async initWebGpu(t,e){if(!window.navigator.gpu)throw new Error("Unable to retrieve GPU. Ensure you are using a browser that supports WebGPU rendering.");if(t&&e){const s=t=>new URL(t,window.location.href).toString(),n=await Promise.all([import(`${s(e)}`).then(t=>twgsl(e.replace(".js",".wasm"))),import(`${s(t)}`).then(t=>t.default())]);this.twgsl=n[0],this.glslang=n[1]}return this.createDevice()}async createDevice(){const t={powerPreference:"default"!==this.initOptions.powerPreference?this.initOptions.powerPreference:void 0,xrCompatible:this.initOptions.xrCompatible};this.gpuAdapter=await window.navigator.gpu.requestAdapter(t);const e=[],s=t=>{const s=this.gpuAdapter.features.has(t);return s&&e.push(t),s};this.textureFloatFilterable=s("float32-filterable"),this.textureFloatBlendable=s("float32-blendable"),this.extCompressedTextureS3TC=s("texture-compression-bc"),this.extCompressedTextureS3TCSliced3D=s("texture-compression-bc-sliced-3d"),this.extCompressedTextureETC=s("texture-compression-etc2"),this.extCompressedTextureASTC=s("texture-compression-astc"),this.extCompressedTextureASTCSliced3D=s("texture-compression-astc-sliced-3d"),this.supportsTimestampQuery=s("timestamp-query"),this.supportsDepthClip=s("depth-clip-control"),this.supportsDepth32Stencil=s("depth32float-stencil8"),this.supportsIndirectFirstInstance=s("indirect-first-instance"),this.supportsShaderF16=s("shader-f16"),this.supportsStorageRGBA8=s("bgra8unorm-storage"),this.textureRG11B10Renderable=s("rg11b10ufloat-renderable"),this.supportsClipDistances=s("clip-distances");const n=this.gpuAdapter?.limits,i={};if(n)for(const t in n)"minSubgroupSize"!==t&&"maxSubgroupSize"!==t&&(i[t]=n[t]);const r={requiredFeatures:e,requiredLimits:i,defaultQueue:{label:"Default Queue"}};this.wgpu=await this.gpuAdapter.requestDevice(r),this.wgpu.lost?.then(this.handleDeviceLost.bind(this)),this.initDeviceCaps(),this.gpuContext=this.canvas.getContext("webgpu");let a="standard",o=window.navigator.gpu.getPreferredCanvasFormat();const l=this.initOptions.displayFormat;if(this.backBufferFormat="rgba8unorm"===o?l===qn?Fs:7:l===qn?64:31,this.backBufferViewFormat=l===qn?`${o}-srgb`:o,"hdr"===l&&this.textureFloatFilterable){const t=window.matchMedia("(dynamic-range: high)");t?.matches&&(this.backBufferFormat=Ls,this.backBufferViewFormat="rgba16float",o="rgba16float",this.isHdr=!0,a="extended")}return this.canvasConfig={device:this.wgpu,colorSpace:"srgb",alphaMode:this.initOptions.alpha?"premultiplied":"opaque",format:o,toneMapping:{mode:a},usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC|GPUTextureUsage.COPY_DST,viewFormats:l===qn?[this.backBufferViewFormat]:[]},this.gpuContext?.configure(this.canvasConfig),this.createBackbuffer(),this.clearRenderer=new Ha(this),this.mipmapRenderer=new Ga(this),this.resolver=new Ya(this),this.postInit(),this}async handleDeviceLost(t){"destroyed"!==t.reason&&(super.loseContext(),await this.createDevice(),super.restoreContext())}postInit(){super.postInit(),this.initializeRenderState(),this.setupPassEncoderDefaults(),this.gpuProfiler=new Ka(this),this.dynamicBuffers=new $a(this,102400,this.limits.minUniformBufferOffsetAlignment),this.emptyBindGroup=new Si(this,new ci(this,[])),this.emptyBindGroup.update()}createBackbuffer(){this.supportsStencil=this.initOptions.stencil,this.backBuffer=new ji({name:"WebgpuFramebuffer",graphicsDevice:this,depth:this.initOptions.depth,stencil:this.supportsStencil,samples:this.samples}),this.backBuffer.impl.isBackbuffer=!0}frameStart(){super.frameStart(),this.gpuProfiler.frameStart(),this.submit();const t=this.gpuContext?.getCurrentTexture?.()??this.externalBackbuffer?.impl.gpuTexture;this.backBufferSize.x===t.width&&this.backBufferSize.y===t.height||(this.backBufferSize.set(t.width,t.height),this.backBuffer.destroy(),this.backBuffer=null,this.createBackbuffer());const e=this.backBuffer,s=e.impl;s.setColorAttachment(0,void 0,this.backBufferViewFormat),this.initRenderTarget(e),s.assignColorTexture(this,t)}frameEnd(){super.frameEnd(),this.gpuProfiler.frameEnd(),this.submit(),this.contextLost||this.gpuProfiler.request(),this._indirectDrawNextIndex=0}createBufferImpl(t){return new Ji(t)}createUniformBufferImpl(t){return new oa(t)}createVertexBufferImpl(t,e,s){return new la(t,e,s)}createIndexBufferImpl(t,e){return new tr(t,e)}createShaderImpl(t){return new na(t)}createDrawCommandImpl(t){return new to(this)}createTextureImpl(t){return new aa(t)}createRenderTargetImpl(t){return new Cr(t)}createUploadStreamImpl(t){return new eo(t)}createBindGroupFormatImpl(t){return new Zi(t)}createBindGroupImpl(t){return new $i}createComputeImpl(t){return new Qa(t)}get indirectDrawBuffer(){return this.allocateIndirectDrawBuffer(),this._indirectDrawBuffer}allocateIndirectDrawBuffer(){0===this._indirectDrawNextIndex&&this._indirectDrawBufferCount<this.maxIndirectDrawCount&&(this._indirectDrawBuffer?.destroy(),this._indirectDrawBuffer=null),null===this._indirectDrawBuffer&&(this._indirectDrawBuffer=new Ja(this,20*this.maxIndirectDrawCount,264),this._indirectDrawBufferCount=this.maxIndirectDrawCount)}getIndirectDrawSlot(t=1){this.allocateIndirectDrawBuffer();const e=this._indirectDrawNextIndex,s=this._indirectDrawNextIndex+t;return this._indirectDrawNextIndex=s,e}setBindGroup(t,e,s){this.passEncoder&&(this.passEncoder.setBindGroup(t,e.impl.bindGroup,s??e.uniformBufferOffsets),this.bindGroupFormats[t]=e.format.impl)}submitVertexBuffer(t,e){const s=t.format,{interleaved:n,elements:i}=s,r=i.length,a=t.impl.buffer;if(n)return this.passEncoder.setVertexBuffer(e,a),1;for(let t=0;t<r;t++)this.passEncoder.setVertexBuffer(e+t,a,i[t].offset);return r}validateVBLocations(t,e){const s=t=>{const{elements:e}=t.format;for(let t=0;t<e.length;t++){const s=e[t].name,n=ni[s];so.has(n),so.set(n,s)}};s(t),s(e),so.clear()}draw(t,e,s=1,n,i=!0,r=!0){if(this.shader.ready&&!this.shader.failed){const r=this.passEncoder;let a=this.pipeline;const o=this.vertexBuffers[0],l=this.vertexBuffers[1];if(i){if(o){const t=this.submitVertexBuffer(o,0);l&&this.submitVertexBuffer(l,t)}a=this.renderPipeline.get(t,o?.format,l?.format,e?.format,this.shader,this.renderTarget,this.bindGroupFormats,this.blendState,this.depthState,this.cullMode,this.stencilEnabled,this.stencilFront,this.stencilBack),this.pipeline!==a&&(this.pipeline=a,r.setPipeline(a))}if(e&&r.setIndexBuffer(e.impl.buffer,e.impl.format),n){const t=(n.impl?.storage??this.indirectDrawBuffer).impl.buffer,s=n.count;for(let i=0;i<s;i++){const s=20*(n.slotIndex+i);e?r.drawIndexedIndirect(t,s):r.drawIndirect(t,s)}}else e?r.drawIndexed(t.count,s,t.base,t.baseVertex??0,0):r.draw(t.count,s,t.base,0)}r&&(this.clearVertexBuffer(),this.pipeline=null)}setShader(t,e=!1){t!==this.shader&&(this.shader=t)}setBlendState(t){this.blendState.copy(t)}setDepthState(t){this.depthState.copy(t)}setStencilState(t,e){if(t||e){this.stencilEnabled=!0,this.stencilFront.copy(t??Hi.DEFAULT),this.stencilBack.copy(e??Hi.DEFAULT);const s=this.stencilFront.ref;this.stencilRef!==s&&(this.stencilRef=s,this.passEncoder.setStencilReference(s))}else this.stencilEnabled=!1}setBlendColor(t,e,s,n){const i=this.blendColor;t===i.r&&e===i.g&&s===i.b&&n===i.a||(i.set(t,e,s,n),this.passEncoder.setBlendConstant(i))}setCullMode(t){this.cullMode=t}setAlphaToCoverage(t){}initializeContextCaches(){super.initializeContextCaches()}setupPassEncoderDefaults(){this.pipeline=null,this.stencilRef=0,this.blendColor.set(0,0,0,0)}_uploadDirtyTextures(){this.textures.forEach(t=>{(t._needsUpload||t._needsMipmaps)&&t.upload()})}setupTimeStampWrites(t,e){if(this.gpuProfiler._enabled&&this.gpuProfiler.timestampQueriesSet){const s=this.gpuProfiler.getSlot(e);-1===s||((t=t??{}).timestampWrites={querySet:this.gpuProfiler.timestampQueriesSet.querySet,beginningOfPassWriteIndex:2*s,endOfPassWriteIndex:2*s+1})}return t}startRenderPass(t){this._uploadDirtyTextures();const e=t.renderTarget||this.backBuffer;this.renderTarget=e;const s=e.impl;e!==this.backBuffer&&this.initRenderTarget(e),s.setupForRenderPass(t,e);const n=s.renderPassDescriptor;this.setupTimeStampWrites(n,t.name);const i=this.getCommandEncoder();this.passEncoder=i.beginRenderPass(n),this.passEncoder.label=`${t.name}-PassEncoder RT:${e.name}`,this.setupPassEncoderDefaults();const{width:r,height:a}=e;this.setViewport(0,0,r,a),this.setScissor(0,0,r,a),this.insideRenderPass=!0}endRenderPass(t){this.passEncoder.end(),this.passEncoder=null,this.insideRenderPass=!1,this.bindGroupFormats.length=0;const e=this.renderTarget;if(e&&e.depthBuffer&&t.depthStencilOps.resolveDepth&&t.samples>1&&e.autoResolve){const t=e.impl.depthAttachment,s=e.depthBuffer.impl.gpuTexture;t&&s&&this.resolver.resolveDepth(this.commandEncoder,t.multisampledDepthBuffer,s)}for(let e=0;e<t.colorArrayOps.length;e++){t.colorArrayOps[e].genMipmaps&&this.mipmapRenderer.generate(t.renderTarget._colorBuffers[e].impl)}}startComputePass(t){this.pipeline=null;const e=this.setupTimeStampWrites(void 0,t),s=this.getCommandEncoder();this.passEncoder=s.beginComputePass(e),this.insideRenderPass=!0}endComputePass(){this.passEncoder.end(),this.passEncoder=null,this.insideRenderPass=!1,this.bindGroupFormats.length=0}computeDispatch(t,e="Unnamed"){this.startComputePass(e);for(let e=0;e<t.length;e++){const s=t[e];s.applyParameters(),s.impl.updateBindGroup()}for(let e=0;e<t.length;e++){const s=t[e];s.impl.dispatch(s.countX,s.countY,s.countZ)}this.endComputePass()}getCommandEncoder(){let t=this.commandEncoder;return t||(t=this.wgpu.createCommandEncoder(),this.commandEncoder=t),t}endCommandEncoder(){const{commandEncoder:t}=this;if(t){const e=t.finish();this.addCommandBuffer(e),this.commandEncoder=null}}addCommandBuffer(t,e=!1){e?this.commandBuffers.unshift(t):this.commandBuffers.push(t)}submit(){this.endCommandEncoder(),this.commandBuffers.length>0&&(this.dynamicBuffers.submit(),this.wgpu.queue.submit(this.commandBuffers),this.commandBuffers.length=0,this.dynamicBuffers.onCommandBuffersSubmitted())}clear(t){t.flags&&this.clearRenderer.clear(this,this.renderTarget,t,this.defaultClearOptions)}setViewport(t,e,s,n){this.passEncoder&&(this.renderTarget.flipY||(e=this.renderTarget.height-e-n),this.vx=t,this.vy=e,this.vw=s,this.vh=n,this.passEncoder.setViewport(t,e,s,n,0,1))}setScissor(t,e,s,n){this.passEncoder&&(this.renderTarget.flipY||(e=this.renderTarget.height-e-n),this.sx=t,this.sy=e,this.sw=s,this.sh=n,this.passEncoder.setScissorRect(t,e,s,n))}clearStorageBuffer(t,e=0,s=t.byteSize){this.getCommandEncoder().clearBuffer(t.buffer,e,s)}readStorageBuffer(t,e=0,s=t.byteSize-e,n=null,i=!1){const r=this.createBufferImpl(9);r.allocate(this,s);const a=r.buffer;return this.getCommandEncoder().copyBufferToBuffer(t.buffer,e,a,0,s),this.readBuffer(r,s,n,i)}readBuffer(t,e,s=null,n=!1){const i=t.buffer;return new Promise((r,a)=>{const o=()=>{i?.mapAsync(GPUMapMode.READ).then(()=>{s??=new Uint8Array(e);const n=i.getMappedRange(0,e),a=s.constructor;s.set(new a(n)),i.unmap(),t.destroy(this),r(s)})};n?(this.submit(),o()):setTimeout(()=>{o()})})}writeStorageBuffer(t,e=0,s,n=0,i){this.wgpu.queue.writeBuffer(t.buffer,e,s,n,i)}copyRenderTarget(t,e,s,n){const i={width:t?t.width:e.width,height:t?t.height:e.height,depthOrArrayLayers:1},r=this.getCommandEncoder();if(s){const s={texture:t?t.colorBuffer.impl.gpuTexture:this.backBuffer.impl.assignedColorTexture,mipLevel:0},n={texture:e?e.colorBuffer.impl.gpuTexture:this.backBuffer.impl.assignedColorTexture,mipLevel:0};r.copyTextureToTexture(s,n,i)}if(n){const s=(t||this.renderTarget).impl.depthAttachment.depthTexture;if(t.samples>1){const t=e.colorBuffer.impl.gpuTexture;this.resolver.resolveDepth(r,s,t)}else{const t={texture:s,mipLevel:0},n={texture:e?e.depthBuffer.impl.gpuTexture:this.renderTarget.impl.depthAttachment.depthTexture,mipLevel:0};r.copyTextureToTexture(t,n,i)}}return!0}get hasTranspilers(){return this.glslang&&this.twgsl}}class io{destroy(t){this.bufferId&&(t.gl.deleteBuffer(this.bufferId),this.bufferId=null)}get initialized(){return!!this.bufferId}loseContext(){this.bufferId=null}unlock(t,e,s,n){const i=t.gl;if(this.bufferId)i.bindBuffer(s,this.bufferId),i.bufferSubData(s,0,n);else{let t;switch(e){case 0:t=i.STATIC_DRAW;break;case 1:t=i.DYNAMIC_DRAW;break;case 2:t=i.STREAM_DRAW;break;case 3:t=i.DYNAMIC_COPY}this.bufferId=i.createBuffer(),i.bindBuffer(s,this.bufferId),i.bufferData(s,n,t)}}constructor(){this.bufferId=null}}class ro extends io{destroy(t){super.destroy(t),t.unbindVertexArray()}loseContext(){super.loseContext(),this.vao=null}unlock(t){const e=t.device;super.unlock(e,t.usage,e.gl.ARRAY_BUFFER,t.storage)}constructor(...t){super(...t),this.vao=null}}class ao extends io{constructor(t){super();const e=t.device.gl,s=t.format;0===s?this.glFormat=e.UNSIGNED_BYTE:1===s?this.glFormat=e.UNSIGNED_SHORT:2===s&&(this.glFormat=e.UNSIGNED_INT)}unlock(t){const e=t.device;super.unlock(e,t.usage,e.gl.ELEMENT_ARRAY_BUFFER,t.storage)}}class oo{constructor(t,e,s,n){if(this.locationId=n,this.scopeId=t.scope.resolve(e),this.version=new Di,"[0]"===e.substring(e.length-3))switch(s){case 2:s=17;break;case 1:s=zn;break;case On:s=31;break;case 0:s=32;break;case 3:s=21;break;case 6:s=Un;break;case Fn:s=34;break;case 9:s=35;break;case 4:s=22;break;case 7:s=Vn;break;case Nn:s=37;break;case 10:s=38;break;case 5:s=23;break;case 8:s=39;break;case Bn:s=40;break;case 11:s=41}this.dataType=s,this.value=[null,null,null,null],this.array=[]}}const lo=new Set(["gl_VertexID","gl_InstanceID","gl_DrawID","gl_BaseVertex","gl_BaseInstance"]);class ho{destroy(t){this.map.forEach(e=>{t.gl.deleteShader(e)})}loseContext(t){this.map.clear()}constructor(){this.map=new Map}}const co=new di,uo=new di;class fo{constructor(t){this.compileDuration=0,this.init(),this.compile(t.device,t),this.link(t.device,t),t.device.shaders.push(t)}destroy(t){this.glProgram&&(t.device.gl.deleteProgram(this.glProgram),this.glProgram=null)}init(){this.uniforms=[],this.samplers=[],this.attributes=[],this.glProgram=null,this.glVertexShader=null,this.glFragmentShader=null}loseContext(){this.init()}restoreContext(t,e){this.compile(t,e),this.link(t,e)}compile(t,e){const s=e.definition;this.glVertexShader=this._compileShaderSource(t,s.vshader,!0),this.glFragmentShader=this._compileShaderSource(t,s.fshader,!1)}link(t,e){if(this.glProgram)return;const s=t.gl;if(s.isContextLost())return;const n=s.createProgram();this.glProgram=n,s.attachShader(n,this.glVertexShader),s.attachShader(n,this.glFragmentShader);const i=e.definition,r=i.attributes;if(i.useTransformFeedback){let t=i.feedbackVaryings;if(!t){t=[];for(const e in r)r.hasOwnProperty(e)&&t.push(`out_${e}`)}s.transformFeedbackVaryings(n,t,s.INTERLEAVED_ATTRIBS)}for(const t in r)if(r.hasOwnProperty(t)){const e=r[t],i=ni[e];s.bindAttribLocation(n,i,t)}s.linkProgram(n)}_compileShaderSource(t,e,s){const n=t.gl;if(n.isContextLost())return null;const i=(s?co:uo).get(t,()=>new ho);let r=i.map.get(e);return r||(r=n.createShader(s?n.VERTEX_SHADER:n.FRAGMENT_SHADER),n.shaderSource(r,e),n.compileShader(r),i.map.set(e,r)),r}finalize(t,e){const s=t.gl;if(s.isContextLost())return!0;const n=this.glProgram,i=e.definition;if(!s.getProgramParameter(n,s.LINK_STATUS)){if(!this._isCompiled(t,e,this.glVertexShader,i.vshader,"vertex"))return!1;if(!this._isCompiled(t,e,this.glFragmentShader,i.fshader,"fragment"))return!1;const r=`Failed to link shader program. Error: ${s.getProgramInfoLog(n)}`;return console.error(r),!1}const r=s.getProgramParameter(n,s.ACTIVE_ATTRIBUTES);e.attributes.clear();for(let t=0;t<r;t++){const r=s.getActiveAttrib(n,t),a=s.getAttribLocation(n,r.name);lo.has(r.name)||(void 0===i.attributes[r.name]?(console.error(`Vertex shader attribute "${r.name}" is not mapped to a semantic in shader definition, shader [${e.label}]`,e),e.failed=!0):e.attributes.set(a,r.name))}const a=t._samplerTypes,o=s.getProgramParameter(n,s.ACTIVE_UNIFORMS);for(let e=0;e<o;e++){const i=s.getActiveUniform(n,e),r=s.getUniformLocation(n,i.name);if(lo.has(i.name))continue;const o=new oo(t,i.name,t.pcUniformType[i.type],r);a.has(i.type)?this.samplers.push(o):this.uniforms.push(o)}return e.ready=!0,!0}_isCompiled(t,e,s,n,i){const r=t.gl;if(!r.getShaderParameter(s,r.COMPILE_STATUS)){const t=r.getShaderInfoLog(s),[e]=this._processError(n,t),a=`Failed to compile ${i} shader:\n\n${t}\n${e} while rendering undefined`;return console.error(a),!1}return!0}isLinked(t){const{extParallelShaderCompile:e}=t;return!e||t.gl.getProgramParameter(this.glProgram,e.COMPLETION_STATUS_KHR)}_processError(t,e){const s={};let n="";if(t){const i=t.split("\n");let r=0,a=i.length;if(e&&e.startsWith("ERROR:")){const t=e.match(/^ERROR:\s(\d+):(\d+):\s*(.+)/);t&&(s.message=t[3],s.line=parseInt(t[2],10),r=Math.max(0,s.line-6),a=Math.min(i.length,s.line+5))}for(let t=r;t<a;t++){n+=`${t+1===s.line?"> ":"  "}${t+1}:\t${i[t]}\n`}s.source=t}return[n,s]}}class po{constructor(t){this.glCounts=null,this.glOffsetsBytes=null,this.glInstanceCounts=null,this.indexSizeBytes=t}allocate(t){this.glCounts=new Int32Array(t),this.glOffsetsBytes=new Int32Array(t),this.glInstanceCounts=new Int32Array(t)}add(t,e,s,n){this.glCounts[t]=e,this.glOffsetsBytes[t]=n*this.indexSizeBytes,this.glInstanceCounts[t]=s}}function mo(t,e){const s=t.width,n=t.height;if(s>e||n>e){const i=e/Math.max(s,n),r=Math.floor(s*i),a=Math.floor(n*i),o=document.createElement("canvas");o.width=r,o.height=a;return o.getContext("2d").drawImage(t,0,0,s,n,0,0,r,a),o}return t}class go{constructor(t){this._glTexture=null,this.dirtyParameterFlags=0,this.texture=t}destroy(t){if(this._glTexture){for(let e=0;e<t.textureUnits.length;e++){const s=t.textureUnits[e];for(let t=0;t<s.length;t++)s[t]===this._glTexture&&(s[t]=null)}t.gl.deleteTexture(this._glTexture),this._glTexture=null}}loseContext(){this._glTexture=null}propertyChanged(t){this.dirtyParameterFlags|=t}initialize(t,e){const s=t.gl;switch(this._glTexture=s.createTexture(),this._glTarget=e._cubemap?s.TEXTURE_CUBE_MAP:e._volume?s.TEXTURE_3D:e.array?s.TEXTURE_2D_ARRAY:s.TEXTURE_2D,e._format){case 0:this._glFormat=s.ALPHA,this._glInternalFormat=s.ALPHA,this._glPixelType=s.UNSIGNED_BYTE;break;case 1:this._glFormat=s.LUMINANCE,this._glInternalFormat=s.LUMINANCE,this._glPixelType=s.UNSIGNED_BYTE;break;case 2:this._glFormat=s.LUMINANCE_ALPHA,this._glInternalFormat=s.LUMINANCE_ALPHA,this._glPixelType=s.UNSIGNED_BYTE;break;case 52:this._glFormat=s.RED,this._glInternalFormat=s.R8,this._glPixelType=s.UNSIGNED_BYTE;break;case 53:this._glFormat=s.RG,this._glInternalFormat=s.RG8,this._glPixelType=s.UNSIGNED_BYTE;break;case 3:this._glFormat=s.RGB,this._glInternalFormat=s.RGB565,this._glPixelType=s.UNSIGNED_SHORT_5_6_5;break;case 4:this._glFormat=s.RGBA,this._glInternalFormat=s.RGB5_A1,this._glPixelType=s.UNSIGNED_SHORT_5_5_5_1;break;case 5:this._glFormat=s.RGBA,this._glInternalFormat=s.RGBA4,this._glPixelType=s.UNSIGNED_SHORT_4_4_4_4;break;case 6:this._glFormat=s.RGB,this._glInternalFormat=s.RGB8,this._glPixelType=s.UNSIGNED_BYTE;break;case 7:this._glFormat=s.RGBA,this._glInternalFormat=s.RGBA8,this._glPixelType=s.UNSIGNED_BYTE;break;case 31:case 64:break;case 8:this._glFormat=s.RGB,this._glInternalFormat=t.extCompressedTextureS3TC.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case 9:this._glFormat=s.RGBA,this._glInternalFormat=t.extCompressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case Ps:this._glFormat=s.RGBA,this._glInternalFormat=t.extCompressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;case 21:this._glFormat=s.RGB,this._glInternalFormat=t.extCompressedTextureETC1.COMPRESSED_RGB_ETC1_WEBGL;break;case Ns:this._glFormat=s.RGB,this._glInternalFormat=t.extCompressedTexturePVRTC.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;break;case Bs:this._glFormat=s.RGBA,this._glInternalFormat=t.extCompressedTexturePVRTC.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;break;case 26:this._glFormat=s.RGB,this._glInternalFormat=t.extCompressedTexturePVRTC.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;break;case 27:this._glFormat=s.RGBA,this._glInternalFormat=t.extCompressedTexturePVRTC.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;break;case 22:this._glFormat=s.RGB,this._glInternalFormat=t.extCompressedTextureETC.COMPRESSED_RGB8_ETC2;break;case 23:this._glFormat=s.RGBA,this._glInternalFormat=t.extCompressedTextureETC.COMPRESSED_RGBA8_ETC2_EAC;break;case 28:this._glFormat=s.RGBA,this._glInternalFormat=t.extCompressedTextureASTC.COMPRESSED_RGBA_ASTC_4x4_KHR;break;case 29:this._glFormat=s.RGB,this._glInternalFormat=t.extCompressedTextureATC.COMPRESSED_RGB_ATC_WEBGL;break;case 30:this._glFormat=s.RGBA,this._glInternalFormat=t.extCompressedTextureATC.COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL;break;case 65:this._glFormat=s.RGB,this._glInternalFormat=t.extTextureCompressionBPTC.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT;break;case 66:this._glFormat=s.RGB,this._glInternalFormat=t.extTextureCompressionBPTC.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT;break;case 67:this._glFormat=s.RGBA,this._glInternalFormat=t.extTextureCompressionBPTC.COMPRESSED_RGBA_BPTC_UNORM_EXT;break;case 54:this._glFormat=s.SRGB,this._glInternalFormat=t.extCompressedTextureS3TC_SRGB.COMPRESSED_SRGB_S3TC_DXT1_EXT;break;case 55:this._glFormat=s.SRGB_ALPHA,this._glInternalFormat=t.extCompressedTextureS3TC_SRGB.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;break;case 56:this._glFormat=s.SRGB_ALPHA,this._glInternalFormat=t.extCompressedTextureS3TC_SRGB.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;break;case 61:this._glFormat=s.SRGB,this._glInternalFormat=t.extCompressedTextureETC.COMPRESSED_SRGB8_ETC2;break;case 62:this._glFormat=s.SRGB_ALPHA,this._glInternalFormat=t.extCompressedTextureETC.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;break;case 63:this._glFormat=s.SRGB_ALPHA,this._glInternalFormat=t.extCompressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case 68:this._glFormat=s.RGBA,this._glInternalFormat=t.extTextureCompressionBPTC.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case 50:this._glFormat=s.RED,this._glInternalFormat=s.R16F,this._glPixelType=s.HALF_FLOAT;break;case 51:this._glFormat=s.RG,this._glInternalFormat=s.RG16F,this._glPixelType=s.HALF_FLOAT;break;case 11:this._glFormat=s.RGB,this._glInternalFormat=s.RGB16F,this._glPixelType=s.HALF_FLOAT;break;case Ls:this._glFormat=s.RGBA,this._glInternalFormat=s.RGBA16F,this._glPixelType=s.HALF_FLOAT;break;case 13:this._glFormat=s.RGB,this._glInternalFormat=s.RGB32F,this._glPixelType=s.FLOAT;break;case Is:this._glFormat=s.RGBA,this._glInternalFormat=s.RGBA32F,this._glPixelType=s.FLOAT;break;case Rs:this._glFormat=s.RED,this._glInternalFormat=s.R32F,this._glPixelType=s.FLOAT;break;case Ms:this._glFormat=s.DEPTH_COMPONENT,this._glInternalFormat=s.DEPTH_COMPONENT32F,this._glPixelType=s.FLOAT;break;case Gs:this._glFormat=s.DEPTH_COMPONENT,this._glInternalFormat=s.DEPTH_COMPONENT16,this._glPixelType=s.UNSIGNED_SHORT;break;case ks:this._glFormat=s.DEPTH_STENCIL,this._glInternalFormat=s.DEPTH24_STENCIL8,this._glPixelType=s.UNSIGNED_INT_24_8;break;case Os:this._glFormat=s.RGB,this._glInternalFormat=s.R11F_G11F_B10F,this._glPixelType=s.UNSIGNED_INT_10F_11F_11F_REV;break;case 19:this._glFormat=s.RGB,this._glInternalFormat=s.SRGB8,this._glPixelType=s.UNSIGNED_BYTE;break;case Fs:this._glFormat=s.RGBA,this._glInternalFormat=s.SRGB8_ALPHA8,this._glPixelType=s.UNSIGNED_BYTE;break;case 32:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R8I,this._glPixelType=s.BYTE;break;case 33:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R8UI,this._glPixelType=s.UNSIGNED_BYTE;break;case 34:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R16I,this._glPixelType=s.SHORT;break;case 35:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R16UI,this._glPixelType=s.UNSIGNED_SHORT;break;case 36:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R32I,this._glPixelType=s.INT;break;case zs:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R32UI,this._glPixelType=s.UNSIGNED_INT;break;case 38:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG8I,this._glPixelType=s.BYTE;break;case 39:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG8UI,this._glPixelType=s.UNSIGNED_BYTE;break;case 40:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG16I,this._glPixelType=s.SHORT;break;case 41:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG16UI,this._glPixelType=s.UNSIGNED_SHORT;break;case 42:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG32I,this._glPixelType=s.INT;break;case Us:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG32UI,this._glPixelType=s.UNSIGNED_INT;break;case 44:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA8I,this._glPixelType=s.BYTE;break;case 45:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA8UI,this._glPixelType=s.UNSIGNED_BYTE;break;case 46:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA16I,this._glPixelType=s.SHORT;break;case Vs:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA16UI,this._glPixelType=s.UNSIGNED_SHORT;break;case 48:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA32I,this._glPixelType=s.INT;break;case Hs:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA32UI,this._glPixelType=s.UNSIGNED_INT}this._glCreated=!1}upload(t,e){const s=t.gl;if(!e._needsUpload&&(e._needsMipmapsUpload&&e._mipmapsUploaded||!e.pot))return;let n,i,r=0;const a=e.numLevels;for(e.array&&!this._glCreated&&s.texStorage3D(s.TEXTURE_2D_ARRAY,a,this._glInternalFormat,e._width,e._height,e._arrayLength);e._levels[r]||0===r;)if(e._needsUpload||0!==r){if(r&&(!e._needsMipmapsUpload||!e._mipmaps))break;if(n=e._levels[r],i=1/Math.pow(2,r),1===r&&!e._compressed&&!e._integerFormat&&e._levels.length<a&&(s.generateMipmap(this._glTarget),e._mipmapsUploaded=!0),e._cubemap){let a;if(t._isBrowserInterface(n[0]))for(a=0;a<6;a++){if(!e._levelsUpdated[0][a])continue;let i=n[a];t._isImageBrowserInterface(i)&&(i.width>t.maxCubeMapSize||i.height>t.maxCubeMapSize)&&(i=mo(i,t.maxCubeMapSize),0===r&&(e._width=i.width,e._height=i.height)),t.setUnpackFlipY(!1),t.setUnpackPremultiplyAlpha(e._premultiplyAlpha),this._glCreated?s.texSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+a,r,0,0,this._glFormat,this._glPixelType,i):s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+a,r,this._glInternalFormat,this._glFormat,this._glPixelType,i)}else for(i=1/Math.pow(2,r),a=0;a<6;a++){if(!e._levelsUpdated[0][a])continue;const o=n[a];e._compressed?this._glCreated&&o?s.compressedTexSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+a,r,0,0,Math.max(e._width*i,1),Math.max(e._height*i,1),this._glInternalFormat,o):s.compressedTexImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+a,r,this._glInternalFormat,Math.max(e._width*i,1),Math.max(e._height*i,1),0,o):(t.setUnpackFlipY(!1),t.setUnpackPremultiplyAlpha(e._premultiplyAlpha),this._glCreated&&o?s.texSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+a,r,0,0,Math.max(e._width*i,1),Math.max(e._height*i,1),this._glFormat,this._glPixelType,o):s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+a,r,this._glInternalFormat,Math.max(e._width*i,1),Math.max(e._height*i,1),0,this._glFormat,this._glPixelType,o))}}else if(e._volume)e._compressed?s.compressedTexImage3D(s.TEXTURE_3D,r,this._glInternalFormat,Math.max(e._width*i,1),Math.max(e._height*i,1),Math.max(e._depth*i,1),0,n):(t.setUnpackFlipY(!1),t.setUnpackPremultiplyAlpha(e._premultiplyAlpha),s.texImage3D(s.TEXTURE_3D,r,this._glInternalFormat,Math.max(e._width*i,1),Math.max(e._height*i,1),Math.max(e._depth*i,1),0,this._glFormat,this._glPixelType,n));else if(e.array&&"object"==typeof n){if(e._arrayLength===n.length)if(e._compressed)for(let t=0;t<e._arrayLength;t++)s.compressedTexSubImage3D(s.TEXTURE_2D_ARRAY,r,0,0,t,Math.max(Math.floor(e._width*i),1),Math.max(Math.floor(e._height*i),1),1,this._glInternalFormat,n[t]);else for(let t=0;t<e._arrayLength;t++)s.texSubImage3D(s.TEXTURE_2D_ARRAY,r,0,0,t,Math.max(Math.floor(e._width*i),1),Math.max(Math.floor(e._height*i),1),1,this._glFormat,this._glPixelType,n[t])}else{if(t._isBrowserInterface(n)){t._isImageBrowserInterface(n)&&(n.width>t.maxTextureSize||n.height>t.maxTextureSize)&&(n=mo(n,t.maxTextureSize),0===r&&(e._width=n.width,e._height=n.height));const i=n.width||n.videoWidth,a=n.height||n.videoHeight;t.setUnpackFlipY(e._flipY),t.setUnpackPremultiplyAlpha(e._premultiplyAlpha),this._glCreated&&e._width===i&&e._height===a&&!t._isImageVideoInterface(n)?s.texSubImage2D(s.TEXTURE_2D,r,0,0,this._glFormat,this._glPixelType,n):(s.texImage2D(s.TEXTURE_2D,r,this._glInternalFormat,this._glFormat,this._glPixelType,n),0===r&&(e._width=i,e._height=a))}else i=1/Math.pow(2,r),e._compressed?this._glCreated&&n?s.compressedTexSubImage2D(s.TEXTURE_2D,r,0,0,Math.max(Math.floor(e._width*i),1),Math.max(Math.floor(e._height*i),1),this._glInternalFormat,n):s.compressedTexImage2D(s.TEXTURE_2D,r,this._glInternalFormat,Math.max(Math.floor(e._width*i),1),Math.max(Math.floor(e._height*i),1),0,n):(t.setUnpackFlipY(!1),t.setUnpackPremultiplyAlpha(e._premultiplyAlpha),this._glCreated&&n?s.texSubImage2D(s.TEXTURE_2D,r,0,0,Math.max(e._width*i,1),Math.max(e._height*i,1),this._glFormat,this._glPixelType,n):s.texImage2D(s.TEXTURE_2D,r,this._glInternalFormat,Math.max(e._width*i,1),Math.max(e._height*i,1),0,this._glFormat,this._glPixelType,n));e._mipmapsUploaded=0!==r}r++}else r++;if(e._needsUpload)if(e._cubemap)for(let t=0;t<6;t++)e._levelsUpdated[0][t]=!1;else e._levelsUpdated[0]=!1;!e._compressed&&!e._integerFormat&&e._mipmaps&&e._needsMipmapsUpload&&1===e._levels.length&&(s.generateMipmap(this._glTarget),e._mipmapsUploaded=!0),e._gpuSize&&e.adjustVramSizeTracking(t._vram,-e._gpuSize),e._gpuSize=e.gpuSize,e.adjustVramSizeTracking(t._vram,e._gpuSize),this._glCreated=!0}uploadImmediate(t,e){(e._needsUpload||e._needsMipmapsUpload)&&(t.setTexture(e,0),e._needsUpload=!1,e._needsMipmapsUpload=!1)}read(t,e,s,n,i){const r=this.texture;return r.device.readTextureAsync(r,t,e,s,n,i)}write(t,e,s,n,i){const{texture:r}=this,{device:a}=r;return a.setTexture(r,0),a.writeTextureAsync(r,t,e,s,n,i)}}class _o{constructor(t,e){this.msaaFB=t,this.resolveFB=e}destroy(t){this.msaaFB&&(t.deleteRenderbuffer(this.msaaFB),this.msaaFB=null),this.resolveFB&&(t.deleteRenderbuffer(this.resolveFB),this.resolveFB=null)}}class vo{destroy(t){const e=t.gl;this._isInitialized=!1,this._glFrameBuffer&&(this._glFrameBuffer!==this.suppliedColorFramebuffer&&e.deleteFramebuffer(this._glFrameBuffer),this._glFrameBuffer=null),this._glDepthBuffer&&(e.deleteRenderbuffer(this._glDepthBuffer),this._glDepthBuffer=null),this._glResolveFrameBuffer&&(this._glResolveFrameBuffer!==this.suppliedColorFramebuffer&&e.deleteFramebuffer(this._glResolveFrameBuffer),this._glResolveFrameBuffer=null),this._glMsaaColorBuffers.forEach(t=>{e.deleteRenderbuffer(t)}),this._glMsaaColorBuffers.length=0,this.colorMrtFramebuffers?.forEach(t=>{t.destroy(e)}),this.colorMrtFramebuffers=null,this._glMsaaDepthBuffer&&(this._glMsaaDepthBuffer=null,this.msaaDepthBufferKey&&Sr(t).release(this.msaaDepthBufferKey)),this.suppliedColorFramebuffer=void 0}get initialized(){return this._isInitialized}init(t,e){const s=t.gl;this._isInitialized=!0;const n=[];if(void 0!==this.suppliedColorFramebuffer)this._glFrameBuffer=this.suppliedColorFramebuffer;else{this._glFrameBuffer=s.createFramebuffer(),t.setFramebuffer(this._glFrameBuffer);const i=e._colorBuffers?.length??0,r=s.COLOR_ATTACHMENT0;for(let a=0;a<i;++a){const i=e.getColorBuffer(a);i&&(i.impl._glTexture||(i._width=Math.min(i.width,t.maxRenderBufferSize),i._height=Math.min(i.height,t.maxRenderBufferSize),t.setTexture(i,0)),s.framebufferTexture2D(s.FRAMEBUFFER,r+a,i._cubemap?s.TEXTURE_CUBE_MAP_POSITIVE_X+e._face:s.TEXTURE_2D,i.impl._glTexture,e.mipLevel),n.push(r+a))}s.drawBuffers(n);const a=e._depthBuffer;if(a||e._depth){const n=e._stencil?s.DEPTH_STENCIL_ATTACHMENT:s.DEPTH_ATTACHMENT;if(a)a.impl._glTexture||(a._width=Math.min(a.width,t.maxRenderBufferSize),a._height=Math.min(a.height,t.maxRenderBufferSize),t.setTexture(a,0)),s.framebufferTexture2D(s.FRAMEBUFFER,n,a._cubemap?s.TEXTURE_CUBE_MAP_POSITIVE_X+e._face:s.TEXTURE_2D,e._depthBuffer.impl._glTexture,e.mipLevel);else{if(!(e._samples>1)){this._glDepthBuffer||(this._glDepthBuffer=s.createRenderbuffer());const t=e._stencil?s.DEPTH24_STENCIL8:s.DEPTH_COMPONENT32F;s.bindRenderbuffer(s.RENDERBUFFER,this._glDepthBuffer),s.renderbufferStorage(s.RENDERBUFFER,t,e.width,e.height),s.framebufferRenderbuffer(s.FRAMEBUFFER,n,s.RENDERBUFFER,this._glDepthBuffer),s.bindRenderbuffer(s.RENDERBUFFER,null)}}}}if(e._samples>1){this._glResolveFrameBuffer=this._glFrameBuffer,this._glFrameBuffer=s.createFramebuffer(),t.setFramebuffer(this._glFrameBuffer);const i=e._colorBuffers?.length??0;if(void 0!==this.suppliedColorFramebuffer){const n=s.createRenderbuffer();this._glMsaaColorBuffers.push(n);const i=7===t.backBufferFormat?s.RGBA8:s.RGB8;s.bindRenderbuffer(s.RENDERBUFFER,n),s.renderbufferStorageMultisample(s.RENDERBUFFER,e._samples,i,e.width,e.height),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.RENDERBUFFER,n)}else for(let t=0;t<i;++t){const n=e.getColorBuffer(t);if(n){const i=s.createRenderbuffer();this._glMsaaColorBuffers.push(i),s.bindRenderbuffer(s.RENDERBUFFER,i),s.renderbufferStorageMultisample(s.RENDERBUFFER,e._samples,n.impl._glInternalFormat,e.width,e.height),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0+t,s.RENDERBUFFER,i)}}if(e._depth){const n=e._stencil?s.DEPTH24_STENCIL8:s.DEPTH_COMPONENT32F,i=e._stencil?s.DEPTH_STENCIL_ATTACHMENT:s.DEPTH_ATTACHMENT;let r;const a=e._depthBuffer;a&&(r=`${a.id}:${e.width}:${e.height}:${e._samples}:${n}:${i}`,this._glMsaaDepthBuffer=Sr(t).get(r)),this._glMsaaDepthBuffer||(this._glMsaaDepthBuffer=s.createRenderbuffer(),s.bindRenderbuffer(s.RENDERBUFFER,this._glMsaaDepthBuffer),s.renderbufferStorageMultisample(s.RENDERBUFFER,e._samples,n,e.width,e.height),this._glMsaaDepthBuffer.destroy=function(){s.deleteRenderbuffer(this)},a&&Sr(t).set(r,this._glMsaaDepthBuffer)),this.msaaDepthBufferKey=r,s.framebufferRenderbuffer(s.FRAMEBUFFER,i,s.RENDERBUFFER,this._glMsaaDepthBuffer)}i>1&&(this._createMsaaMrtFramebuffers(t,e,i),t.setFramebuffer(this._glFrameBuffer),s.drawBuffers(n))}}_createMsaaMrtFramebuffers(t,e,s){const n=t.gl;this.colorMrtFramebuffers=[];for(let i=0;i<s;++i){const s=e.getColorBuffer(i),r=n.createFramebuffer();t.setFramebuffer(r);const a=this._glMsaaColorBuffers[i];n.bindRenderbuffer(n.RENDERBUFFER,a),n.renderbufferStorageMultisample(n.RENDERBUFFER,e._samples,s.impl._glInternalFormat,e.width,e.height),n.framebufferRenderbuffer(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.RENDERBUFFER,a),n.drawBuffers([n.COLOR_ATTACHMENT0]);const o=n.createFramebuffer();t.setFramebuffer(o),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,s._cubemap?n.TEXTURE_CUBE_MAP_POSITIVE_X+e._face:n.TEXTURE_2D,s.impl._glTexture,0),this.colorMrtFramebuffers[i]=new _o(r,o)}}_checkFbo(t,e,s=""){const n=t.gl;n.checkFramebufferStatus(n.FRAMEBUFFER)}loseContext(){this._glFrameBuffer=null,this._glDepthBuffer=null,this._glResolveFrameBuffer=null,this._glMsaaColorBuffers.length=0,this._glMsaaDepthBuffer=null,this.msaaDepthBufferKey=void 0,this.colorMrtFramebuffers=null,this.suppliedColorFramebuffer=void 0,this._isInitialized=!1}internalResolve(t,e,s,n,i){t.setScissor(0,0,n.width,n.height);const r=t.gl;r.bindFramebuffer(r.READ_FRAMEBUFFER,e),r.bindFramebuffer(r.DRAW_FRAMEBUFFER,s),r.blitFramebuffer(0,0,n.width,n.height,0,0,n.width,n.height,i,r.NEAREST)}resolve(t,e,s,n){const i=t.gl;if(this.colorMrtFramebuffers){if(s)for(let s=0;s<this.colorMrtFramebuffers.length;s++){const n=this.colorMrtFramebuffers[s];this.internalResolve(t,n.msaaFB,n.resolveFB,e,i.COLOR_BUFFER_BIT)}n&&this.internalResolve(t,this._glFrameBuffer,this._glResolveFrameBuffer,e,i.DEPTH_BUFFER_BIT)}else this.internalResolve(t,this._glFrameBuffer,this._glResolveFrameBuffer,e,(s?i.COLOR_BUFFER_BIT:0)|(n?i.DEPTH_BUFFER_BIT:0));i.bindFramebuffer(i.FRAMEBUFFER,this._glFrameBuffer)}constructor(){this._glFrameBuffer=null,this._glDepthBuffer=null,this._glResolveFrameBuffer=null,this.colorMrtFramebuffers=null,this._glMsaaColorBuffers=[],this._glMsaaDepthBuffer=null,this._isInitialized=!1}}class yo{constructor(t){this.availablePBOs=[],this.pendingPBOs=[],this.uploadStream=t,this.useSingleBuffer=t.useSingleBuffer}destroy(){const t=this.uploadStream.device.gl;this.availablePBOs.forEach(e=>t.deleteBuffer(e.pbo)),this.pendingPBOs.forEach(e=>{e.sync&&t.deleteSync(e.sync),t.deleteBuffer(e.pbo)})}_onDeviceLost(){this.availablePBOs.length=0,this.pendingPBOs.length=0}update(t){const e=this.uploadStream.device.gl,s=this.pendingPBOs;for(let t=s.length-1;t>=0;t--){const n=s[t],i=e.clientWaitSync(n.sync,0,0);i!==e.CONDITION_SATISFIED&&i!==e.ALREADY_SIGNALED||(e.deleteSync(n.sync),this.availablePBOs.push({pbo:n.pbo,size:n.size}),s.splice(t,1))}const n=this.availablePBOs;for(let s=n.length-1;s>=0;s--)n[s].size<t&&(e.deleteBuffer(n[s].pbo),n.splice(s,1))}upload(t,e,s,n){this.useSingleBuffer?this.uploadDirect(t,e,s,n):this.uploadPBO(t,e,s,n)}uploadDirect(t,e,s,n){e._levels[0]=t,e.upload()}uploadPBO(t,e,s,n){const i=this.uploadStream.device,r=i.gl,a=e.width,o=n*t.BYTES_PER_ELEMENT;this.update(o);const l=s/a,h=n/a,c=this.availablePBOs.pop()??{pbo:r.createBuffer(),size:o};r.bindBuffer(r.PIXEL_UNPACK_BUFFER,c.pbo),r.bufferData(r.PIXEL_UNPACK_BUFFER,o,r.STREAM_DRAW),r.bufferSubData(r.PIXEL_UNPACK_BUFFER,0,new Uint8Array(t.buffer,t.byteOffset,o)),r.bindBuffer(r.PIXEL_UNPACK_BUFFER,null),i.setTexture(e,0),i.activeTexture(0),i.bindTexture(e),r.bindBuffer(r.PIXEL_UNPACK_BUFFER,c.pbo),i.setUnpackFlipY(!1),i.setUnpackPremultiplyAlpha(!1),r.pixelStorei(r.UNPACK_ALIGNMENT,t.BYTES_PER_ELEMENT),r.pixelStorei(r.UNPACK_ROW_LENGTH,0),r.pixelStorei(r.UNPACK_SKIP_ROWS,0),r.pixelStorei(r.UNPACK_SKIP_PIXELS,0);const d=e.impl;r.texSubImage2D(r.TEXTURE_2D,0,0,l,a,h,d._glFormat,d._glPixelType,0),r.bindBuffer(r.PIXEL_UNPACK_BUFFER,null);const u=r.fenceSync(r.SYNC_GPU_COMMANDS_COMPLETE,0);this.pendingPBOs.push({pbo:c.pbo,size:o,sync:u}),r.flush()}}class bo{destroy(t){this.queries.forEach(e=>t.deleteQuery(e)),this.queries=null}constructor(){this.queries=[]}}class So extends Xa{constructor(t){super(),this.freeQueries=[],this.frameQueries=[],this.previousFrameQueries=[],this.timings=[],this.device=t,this.ext=t.extDisjointTimerQuery}destroy(){this.freeQueries.forEach(t=>this.device.gl.deleteQuery(t)),this.frameQueries.forEach(t=>this.device.gl.deleteQuery(t)),this.previousFrameQueries.forEach(t=>t.destroy(this.device.gl)),this.freeQueries=null,this.frameQueries=null,this.previousFrameQueries=null}loseContext(){super.loseContext(),this.freeQueries=[],this.frameQueries=[],this.previousFrameQueries=[]}restoreContext(){this.ext=this.device.extDisjointTimerQuery}getQuery(){return this.freeQueries.pop()??this.device.gl.createQuery()}start(t){if(this.ext){const e=this.getSlot(t),s=this.getQuery();return this.frameQueries[e]=s,this.device.gl.beginQuery(this.ext.TIME_ELAPSED_EXT,s),e}}end(t){void 0!==t&&this.device.gl.endQuery(this.ext.TIME_ELAPSED_EXT)}frameStart(){this.processEnableRequest(),this._enabled&&(this.frameGPUMarkerSlot=this.start("GpuFrame"))}frameEnd(){this._enabled&&this.end(this.frameGPUMarkerSlot)}request(){if(this._enabled){const t=this.ext,e=this.device.gl,s=this.device.renderVersion,n=this.frameQueries;if(n.length>0){this.frameQueries=[];const t=new bo;t.queries=n,t.renderVersion=s,this.previousFrameQueries.push(t)}if(this.previousFrameQueries.length>0){const s=this.previousFrameQueries[0],n=s.queries,i=n[n.length-1],r=e.getQueryParameter(i,e.QUERY_RESULT_AVAILABLE),a=e.getParameter(t.GPU_DISJOINT_EXT);if(r&&!a){this.previousFrameQueries.shift();const t=this.timings;t.length=0;for(let s=0;s<n.length;s++){const i=n[s],r=e.getQueryParameter(i,e.QUERY_RESULT);t[s]=1e-6*r,this.freeQueries.push(i)}this.report(s.renderVersion,t)}a&&(this.previousFrameQueries.forEach(t=>{this.report(t.renderVersion,null),t.destroy(e)}),this.previousFrameQueries.length=0)}super.request(s)}}}const xo=[];class wo extends Gi{constructor(t,e={}){super(t,e),this._defaultFramebuffer=null,this._defaultFramebufferChanged=!1,e=this.initOptions,this.updateClientRect(),this.initTextureUnits(),this.contextLost=!1,this._contextLostHandler=t=>{t.preventDefault(),this.loseContext(),this.fire("devicelost")},this._contextRestoredHandler=()=>{this.restoreContext(),this.fire("devicerestored")};const s="undefined"!=typeof navigator&&navigator.userAgent;if(this.forceDisableMultisampling=s&&s.includes("AppleWebKit")&&(s.includes("15.4")||s.includes("15_4")),this.forceDisableMultisampling&&(e.antialias=!1),"firefox"===ze.browserName){const t=("undefined"!=typeof navigator?navigator.userAgent:"").match(/Firefox\/(\d+(\.\d+)*)/),s=t?t[1]:null;if(s){const t=parseFloat(s);("windows"===ze.name&&(t>=120||115===t)||"android"===ze.name&&t>=132)&&(e.antialias=!1)}}this.backBufferAntialias=e.antialias??!1,e.antialias=!1;const n=e.gl??t.getContext("webgl2",e);if(!n)throw new Error("WebGL not supported");this.gl=n,this.isWebGL2=!0,this._deviceType=jn,this.updateBackbufferFormat(null);const i="chrome"===ze.browserName,r="safari"===ze.browserName,a=ze.browser&&-1!==navigator.appVersion.indexOf("Mac");let o,l,h,c,d;this._tempEnableSafariTextureUnitWorkaround=r,this._tempMacChromeBlitFramebufferWorkaround=a&&i&&!e.alpha,t.addEventListener("webglcontextlost",this._contextLostHandler,!1),t.addEventListener("webglcontextrestored",this._contextRestoredHandler,!1),this.initializeExtensions(),this.initializeCapabilities(),this.initializeRenderState(),this.initializeContextCaches(),this.createBackbuffer(null),this.supportsImageBitmap=!r&&"undefined"!=typeof ImageBitmap,this._samplerTypes=new Set([n.SAMPLER_2D,n.SAMPLER_CUBE,n.UNSIGNED_INT_SAMPLER_2D,n.INT_SAMPLER_2D,n.SAMPLER_2D_SHADOW,n.SAMPLER_CUBE_SHADOW,n.SAMPLER_3D,n.INT_SAMPLER_3D,n.UNSIGNED_INT_SAMPLER_3D,n.SAMPLER_2D_ARRAY,n.INT_SAMPLER_2D_ARRAY,n.UNSIGNED_INT_SAMPLER_2D_ARRAY]),this.glAddress=[n.REPEAT,n.CLAMP_TO_EDGE,n.MIRRORED_REPEAT],this.glBlendEquation=[n.FUNC_ADD,n.FUNC_SUBTRACT,n.FUNC_REVERSE_SUBTRACT,n.MIN,n.MAX],this.glBlendFunctionColor=[n.ZERO,n.ONE,n.SRC_COLOR,n.ONE_MINUS_SRC_COLOR,n.DST_COLOR,n.ONE_MINUS_DST_COLOR,n.SRC_ALPHA,n.SRC_ALPHA_SATURATE,n.ONE_MINUS_SRC_ALPHA,n.DST_ALPHA,n.ONE_MINUS_DST_ALPHA,n.CONSTANT_COLOR,n.ONE_MINUS_CONSTANT_COLOR],this.glBlendFunctionAlpha=[n.ZERO,n.ONE,n.SRC_COLOR,n.ONE_MINUS_SRC_COLOR,n.DST_COLOR,n.ONE_MINUS_DST_COLOR,n.SRC_ALPHA,n.SRC_ALPHA_SATURATE,n.ONE_MINUS_SRC_ALPHA,n.DST_ALPHA,n.ONE_MINUS_DST_ALPHA,n.CONSTANT_ALPHA,n.ONE_MINUS_CONSTANT_ALPHA],this.glComparison=[n.NEVER,n.LESS,n.EQUAL,n.LEQUAL,n.GREATER,n.NOTEQUAL,n.GEQUAL,n.ALWAYS],this.glStencilOp=[n.KEEP,n.ZERO,n.REPLACE,n.INCR,n.INCR_WRAP,n.DECR,n.DECR_WRAP,n.INVERT],this.glClearFlag=[0,n.COLOR_BUFFER_BIT,n.DEPTH_BUFFER_BIT,n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT,n.STENCIL_BUFFER_BIT,n.STENCIL_BUFFER_BIT|n.COLOR_BUFFER_BIT,n.STENCIL_BUFFER_BIT|n.DEPTH_BUFFER_BIT,n.STENCIL_BUFFER_BIT|n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT],this.glCull=[0,n.BACK,n.FRONT,n.FRONT_AND_BACK],this.glFilter=[n.NEAREST,n.LINEAR,n.NEAREST_MIPMAP_NEAREST,n.NEAREST_MIPMAP_LINEAR,n.LINEAR_MIPMAP_NEAREST,n.LINEAR_MIPMAP_LINEAR],this.glPrimitive=[n.POINTS,n.LINES,n.LINE_LOOP,n.LINE_STRIP,n.TRIANGLES,n.TRIANGLE_STRIP,n.TRIANGLE_FAN],this.glType=[n.BYTE,n.UNSIGNED_BYTE,n.SHORT,n.UNSIGNED_SHORT,n.INT,n.UNSIGNED_INT,n.FLOAT,n.HALF_FLOAT],this.pcUniformType={},this.pcUniformType[n.BOOL]=0,this.pcUniformType[n.INT]=1,this.pcUniformType[n.FLOAT]=2,this.pcUniformType[n.FLOAT_VEC2]=3,this.pcUniformType[n.FLOAT_VEC3]=4,this.pcUniformType[n.FLOAT_VEC4]=5,this.pcUniformType[n.INT_VEC2]=6,this.pcUniformType[n.INT_VEC3]=7,this.pcUniformType[n.INT_VEC4]=8,this.pcUniformType[n.BOOL_VEC2]=9,this.pcUniformType[n.BOOL_VEC3]=10,this.pcUniformType[n.BOOL_VEC4]=11,this.pcUniformType[n.FLOAT_MAT2]=12,this.pcUniformType[n.FLOAT_MAT3]=Mn,this.pcUniformType[n.FLOAT_MAT4]=kn,this.pcUniformType[n.SAMPLER_2D]=15,this.pcUniformType[n.SAMPLER_CUBE]=16,this.pcUniformType[n.UNSIGNED_INT]=On,this.pcUniformType[n.UNSIGNED_INT_VEC2]=Fn,this.pcUniformType[n.UNSIGNED_INT_VEC3]=Nn,this.pcUniformType[n.UNSIGNED_INT_VEC4]=Bn,this.pcUniformType[n.SAMPLER_2D_SHADOW]=18,this.pcUniformType[n.SAMPLER_CUBE_SHADOW]=19,this.pcUniformType[n.SAMPLER_2D_ARRAY]=25,this.pcUniformType[n.SAMPLER_3D]=20,this.pcUniformType[n.INT_SAMPLER_2D]=42,this.pcUniformType[n.UNSIGNED_INT_SAMPLER_2D]=43,this.pcUniformType[n.INT_SAMPLER_CUBE]=44,this.pcUniformType[n.UNSIGNED_INT_SAMPLER_2D]=45,this.pcUniformType[n.INT_SAMPLER_3D]=46,this.pcUniformType[n.UNSIGNED_INT_SAMPLER_3D]=47,this.pcUniformType[n.INT_SAMPLER_2D_ARRAY]=48,this.pcUniformType[n.UNSIGNED_INT_SAMPLER_2D_ARRAY]=49,this.targetToSlot={},this.targetToSlot[n.TEXTURE_2D]=0,this.targetToSlot[n.TEXTURE_CUBE_MAP]=1,this.targetToSlot[n.TEXTURE_3D]=2,this.commitFunction=[],this.commitFunction[0]=function(t,e){t.value!==e&&(n.uniform1i(t.locationId,e),t.value=e)},this.commitFunction[1]=this.commitFunction[0],this.commitFunction[2]=function(t,e){t.value!==e&&(n.uniform1f(t.locationId,e),t.value=e)},this.commitFunction[3]=function(t,e){d=t.value,o=e[0],l=e[1],d[0]===o&&d[1]===l||(n.uniform2fv(t.locationId,e),d[0]=o,d[1]=l)},this.commitFunction[4]=function(t,e){d=t.value,o=e[0],l=e[1],h=e[2],d[0]===o&&d[1]===l&&d[2]===h||(n.uniform3fv(t.locationId,e),d[0]=o,d[1]=l,d[2]=h)},this.commitFunction[5]=function(t,e){d=t.value,o=e[0],l=e[1],h=e[2],c=e[3],d[0]===o&&d[1]===l&&d[2]===h&&d[3]===c||(n.uniform4fv(t.locationId,e),d[0]=o,d[1]=l,d[2]=h,d[3]=c)},this.commitFunction[6]=function(t,e){d=t.value,o=e[0],l=e[1],d[0]===o&&d[1]===l||(n.uniform2iv(t.locationId,e),d[0]=o,d[1]=l)},this.commitFunction[9]=this.commitFunction[6],this.commitFunction[7]=function(t,e){d=t.value,o=e[0],l=e[1],h=e[2],d[0]===o&&d[1]===l&&d[2]===h||(n.uniform3iv(t.locationId,e),d[0]=o,d[1]=l,d[2]=h)},this.commitFunction[10]=this.commitFunction[7],this.commitFunction[8]=function(t,e){d=t.value,o=e[0],l=e[1],h=e[2],c=e[3],d[0]===o&&d[1]===l&&d[2]===h&&d[3]===c||(n.uniform4iv(t.locationId,e),d[0]=o,d[1]=l,d[2]=h,d[3]=c)},this.commitFunction[11]=this.commitFunction[8],this.commitFunction[12]=function(t,e){n.uniformMatrix2fv(t.locationId,!1,e)},this.commitFunction[13]=function(t,e){n.uniformMatrix3fv(t.locationId,!1,e)},this.commitFunction[14]=function(t,e){n.uniformMatrix4fv(t.locationId,!1,e)},this.commitFunction[17]=function(t,e){n.uniform1fv(t.locationId,e)},this.commitFunction[21]=function(t,e){n.uniform2fv(t.locationId,e)},this.commitFunction[22]=function(t,e){n.uniform3fv(t.locationId,e)},this.commitFunction[23]=function(t,e){n.uniform4fv(t.locationId,e)},this.commitFunction[26]=function(t,e){t.value!==e&&(n.uniform1ui(t.locationId,e),t.value=e)},this.commitFunction[27]=function(t,e){d=t.value,o=e[0],l=e[1],d[0]===o&&d[1]===l||(n.uniform2uiv(t.locationId,e),d[0]=o,d[1]=l)},this.commitFunction[28]=function(t,e){d=t.value,o=e[0],l=e[1],h=e[2],d[0]===o&&d[1]===l&&d[2]===h||(n.uniform3uiv(t.locationId,e),d[0]=o,d[1]=l,d[2]=h)},this.commitFunction[29]=function(t,e){d=t.value,o=e[0],l=e[1],h=e[2],c=e[3],d[0]===o&&d[1]===l&&d[2]===h&&d[3]===c||(n.uniform4uiv(t.locationId,e),d[0]=o,d[1]=l,d[2]=h,d[3]=c)},this.commitFunction[30]=function(t,e){n.uniform1iv(t.locationId,e)},this.commitFunction[31]=function(t,e){n.uniform1uiv(t.locationId,e)},this.commitFunction[32]=this.commitFunction[30],this.commitFunction[33]=function(t,e){n.uniform2iv(t.locationId,e)},this.commitFunction[34]=function(t,e){n.uniform2uiv(t.locationId,e)},this.commitFunction[35]=this.commitFunction[33],this.commitFunction[36]=function(t,e){n.uniform3iv(t.locationId,e)},this.commitFunction[37]=function(t,e){n.uniform3uiv(t.locationId,e)},this.commitFunction[38]=this.commitFunction[36],this.commitFunction[39]=function(t,e){n.uniform4iv(t.locationId,e)},this.commitFunction[40]=function(t,e){n.uniform4uiv(t.locationId,e)},this.commitFunction[41]=this.commitFunction[39],this.commitFunction[24]=function(t,e){n.uniformMatrix4fv(t.locationId,!1,e)},this.constantTexSource=this.scope.resolve("source"),this.postInit()}postInit(){super.postInit(),this.gpuProfiler=new So(this)}destroy(){super.destroy();const t=this.gl;this.feedback&&t.deleteTransformFeedback(this.feedback),this.clearVertexArrayObjectCache(),this.canvas.removeEventListener("webglcontextlost",this._contextLostHandler,!1),this.canvas.removeEventListener("webglcontextrestored",this._contextRestoredHandler,!1),this._contextLostHandler=null,this._contextRestoredHandler=null,this.gl=null,super.postDestroy()}createBackbuffer(t){this.supportsStencil=this.initOptions.stencil,this.backBuffer=new ji({name:"WebglFramebuffer",graphicsDevice:this,depth:this.initOptions.depth,stencil:this.supportsStencil,samples:this.samples}),this.backBuffer.impl.suppliedColorFramebuffer=t}updateBackbufferFormat(t){const e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,t);const s=this.gl.getParameter(this.gl.ALPHA_BITS);this.backBufferFormat=s?7:6}updateBackbuffer(){const t=this.canvas.width!==this.backBufferSize.x||this.canvas.height!==this.backBufferSize.y;(this._defaultFramebufferChanged||t)&&(this._defaultFramebufferChanged&&this.updateBackbufferFormat(this._defaultFramebuffer),this._defaultFramebufferChanged=!1,this.backBufferSize.set(this.canvas.width,this.canvas.height),this.backBuffer.destroy(),this.createBackbuffer(this._defaultFramebuffer))}createVertexBufferImpl(t,e){return new ro}createIndexBufferImpl(t){return new ao(t)}createShaderImpl(t){return new fo(t)}createDrawCommandImpl(t){return new po(t.indexSizeBytes)}createTextureImpl(t){return new go(t)}createRenderTargetImpl(t){return new vo}createUploadStreamImpl(t){return new yo(t)}getPrecision(){const t=this.gl;let e="highp";if(t.getShaderPrecisionFormat){const s=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.HIGH_FLOAT),n=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.MEDIUM_FLOAT),i=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_FLOAT),r=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.MEDIUM_FLOAT);if(s&&n&&i&&r){const t=s.precision>0&&i.precision>0,a=n.precision>0&&r.precision>0;t||(e=a?"mediump":"lowp")}}return e}getExtension(){for(let t=0;t<arguments.length;t++)if(-1!==this.supportedExtensions.indexOf(arguments[t]))return this.gl.getExtension(arguments[t]);return null}get extDisjointTimerQuery(){return this._extDisjointTimerQuery||(this._extDisjointTimerQuery=this.getExtension("EXT_disjoint_timer_query_webgl2","EXT_disjoint_timer_query")),this._extDisjointTimerQuery}initializeExtensions(){const t=this.gl;this.supportedExtensions=t.getSupportedExtensions()??[],this._extDisjointTimerQuery=null,this.textureRG11B10Renderable=!0,this.extColorBufferFloat=this.getExtension("EXT_color_buffer_float"),this.textureFloatRenderable=!!this.extColorBufferFloat,this.extColorBufferHalfFloat=this.getExtension("EXT_color_buffer_half_float"),this.textureHalfFloatRenderable=!!this.extColorBufferHalfFloat||!!this.extColorBufferFloat,this.extDebugRendererInfo=this.getExtension("WEBGL_debug_renderer_info"),this.extTextureFloatLinear=this.getExtension("OES_texture_float_linear"),this.textureFloatFilterable=!!this.extTextureFloatLinear,this.extFloatBlend=this.getExtension("EXT_float_blend"),this.extTextureFilterAnisotropic=this.getExtension("EXT_texture_filter_anisotropic","WEBKIT_EXT_texture_filter_anisotropic"),this.extParallelShaderCompile=this.getExtension("KHR_parallel_shader_compile"),this.extMultiDraw=this.getExtension("WEBGL_multi_draw"),this.supportsMultiDraw=!!this.extMultiDraw,this.extCompressedTextureETC1=this.getExtension("WEBGL_compressed_texture_etc1"),this.extCompressedTextureETC=this.getExtension("WEBGL_compressed_texture_etc"),this.extCompressedTexturePVRTC=this.getExtension("WEBGL_compressed_texture_pvrtc","WEBKIT_WEBGL_compressed_texture_pvrtc"),this.extCompressedTextureS3TC=this.getExtension("WEBGL_compressed_texture_s3tc","WEBKIT_WEBGL_compressed_texture_s3tc"),this.extCompressedTextureS3TC_SRGB=this.getExtension("WEBGL_compressed_texture_s3tc_srgb"),this.extCompressedTextureATC=this.getExtension("WEBGL_compressed_texture_atc"),this.extCompressedTextureASTC=this.getExtension("WEBGL_compressed_texture_astc"),this.extTextureCompressionBPTC=this.getExtension("EXT_texture_compression_bptc")}initializeCapabilities(){const t=this.gl;let e;const s="undefined"!=typeof navigator?navigator.userAgent:"";this.maxPrecision=this.precision=this.getPrecision();const n=t.getContextAttributes();this.supportsMsaa=n?.antialias??!1,this.supportsStencil=n?.stencil??!1,this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this.maxCubeMapSize=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),this.maxRenderBufferSize=t.getParameter(t.MAX_RENDERBUFFER_SIZE),this.maxTextures=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),this.maxCombinedTextures=t.getParameter(t.MAX_COMBINED_TEXTURE_IMAGE_UNITS),this.maxVertexTextures=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this.vertexUniformsCount=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),this.fragmentUniformsCount=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),this.maxColorAttachments=t.getParameter(t.MAX_COLOR_ATTACHMENTS),this.maxVolumeSize=t.getParameter(t.MAX_3D_TEXTURE_SIZE),e=this.extDebugRendererInfo,this.unmaskedRenderer=e?t.getParameter(e.UNMASKED_RENDERER_WEBGL):"",this.unmaskedVendor=e?t.getParameter(e.UNMASKED_VENDOR_WEBGL):"";this.supportsGpuParticles=!("ARM"===this.unmaskedVendor&&s.match(/SM-[a-zA-Z0-9]+/)||this.unmaskedRenderer.match(/\bMali-G52+/)),e=this.extTextureFilterAnisotropic,this.maxAnisotropy=e?t.getParameter(e.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1;const i=!this.forceDisableMultisampling;this.maxSamples=i?t.getParameter(t.MAX_SAMPLES):1,this.maxSamples=Math.min(this.maxSamples,4),this.samples=i&&this.backBufferAntialias?this.maxSamples:1,this.supportsAreaLights=!ze.android,this.maxTextures<=8&&(this.supportsAreaLights=!1),this.initCapsDefines()}initializeRenderState(){super.initializeRenderState();const t=this.gl;t.disable(t.BLEND),t.blendFunc(t.ONE,t.ZERO),t.blendEquation(t.FUNC_ADD),t.colorMask(!0,!0,!0,!0),t.blendColor(0,0,0,0),t.enable(t.CULL_FACE),this.cullFace=t.BACK,t.cullFace(t.BACK),t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL),t.depthMask(!0),this.stencil=!1,t.disable(t.STENCIL_TEST),this.stencilFuncFront=this.stencilFuncBack=7,this.stencilRefFront=this.stencilRefBack=0,this.stencilMaskFront=this.stencilMaskBack=255,t.stencilFunc(t.ALWAYS,0,255),this.stencilFailFront=this.stencilFailBack=0,this.stencilZfailFront=this.stencilZfailBack=0,this.stencilZpassFront=this.stencilZpassBack=0,this.stencilWriteMaskFront=255,this.stencilWriteMaskBack=255,t.stencilOp(t.KEEP,t.KEEP,t.KEEP),t.stencilMask(255),this.alphaToCoverage=!1,this.raster=!0,t.disable(t.SAMPLE_ALPHA_TO_COVERAGE),t.disable(t.RASTERIZER_DISCARD),this.depthBiasEnabled=!1,t.disable(t.POLYGON_OFFSET_FILL),this.clearDepth=1,t.clearDepth(1),this.clearColor=new Ze(0,0,0,0),t.clearColor(0,0,0,0),this.clearStencil=0,t.clearStencil(0),t.hint(t.FRAGMENT_SHADER_DERIVATIVE_HINT,t.NICEST),t.enable(t.SCISSOR_TEST),t.pixelStorei(t.UNPACK_COLORSPACE_CONVERSION_WEBGL,t.NONE),this.unpackFlipY=!1,t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),this.unpackPremultiplyAlpha=!1,t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),t.pixelStorei(t.UNPACK_ALIGNMENT,1)}initTextureUnits(t=16){this.textureUnits=[];for(let e=0;e<t;e++)this.textureUnits.push([null,null,null])}initializeContextCaches(){super.initializeContextCaches(),this._vaoMap=new Map,this.boundVao=null,this.activeFramebuffer=null,this.feedback=null,this.transformFeedbackBuffer=null,this.textureUnit=0,this.initTextureUnits(this.maxCombinedTextures)}loseContext(){super.loseContext();for(const t of this.shaders)t.loseContext()}restoreContext(){this.initializeExtensions(),this.initializeCapabilities(),super.restoreContext();for(const t of this.shaders)t.restoreContext()}setViewport(t,e,s,n){this.vx===t&&this.vy===e&&this.vw===s&&this.vh===n||(this.gl.viewport(t,e,s,n),this.vx=t,this.vy=e,this.vw=s,this.vh=n)}setScissor(t,e,s,n){this.sx===t&&this.sy===e&&this.sw===s&&this.sh===n||(this.gl.scissor(t,e,s,n),this.sx=t,this.sy=e,this.sw=s,this.sh=n)}setFramebuffer(t){if(this.activeFramebuffer!==t){const e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,t),this.activeFramebuffer=t}}copyRenderTarget(t,e,s,n){const i=this.gl;if(t===this.backBuffer&&(t=null),s)if(e){if(t){if(!t._colorBuffer||!e._colorBuffer)return!1;if(t._colorBuffer._format!==e._colorBuffer._format)return!1}}else if(!t._colorBuffer)return!1;if(n&&t&&!t._depth){if(!t._depthBuffer||!e._depthBuffer)return!1;if(t._depthBuffer._format!==e._depthBuffer._format)return!1}const r=this.renderTarget;this.renderTarget=e,this.updateBegin();const a=t?t.impl._glFrameBuffer:this.backBuffer?.impl._glFrameBuffer,o=e?e.impl._glFrameBuffer:this.backBuffer?.impl._glFrameBuffer;i.bindFramebuffer(i.READ_FRAMEBUFFER,a),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,o);const l=t?t.width:e?e.width:this.width,h=t?t.height:e?e.height:this.height;return i.blitFramebuffer(0,0,l,h,0,0,l,h,(s?i.COLOR_BUFFER_BIT:0)|(n?i.DEPTH_BUFFER_BIT:0),i.NEAREST),this.renderTarget=r,i.bindFramebuffer(i.FRAMEBUFFER,r?r.impl._glFrameBuffer:null),!0}frameStart(){super.frameStart(),this.updateBackbuffer(),this.gpuProfiler.frameStart()}frameEnd(){super.frameEnd(),this.gpuProfiler.frameEnd(),this.gpuProfiler.request()}startRenderPass(t){const e=t.renderTarget??this.backBuffer;this.renderTarget=e,this.updateBegin();const{width:s,height:n}=e;this.setViewport(0,0,s,n),this.setScissor(0,0,s,n);const i=t.colorOps,r=t.depthStencilOps;if(i?.clear||r.clearDepth||r.clearStencil){let t=0;const e={};i?.clear&&(t|=1,e.color=[i.clearValue.r,i.clearValue.g,i.clearValue.b,i.clearValue.a]),r.clearDepth&&(t|=2,e.depth=r.clearDepthValue),r.clearStencil&&(t|=4,e.stencil=r.clearStencilValue),e.flags=t,this.clear(e)}this.insideRenderPass=!0}endRenderPass(t){this.unbindVertexArray();const e=this.renderTarget,s=t.colorArrayOps.length;if(e){xo.length=0;const n=this.gl;for(let e=0;e<s;e++){const s=t.colorArrayOps[e];s.store||s.resolve||xo.push(n.COLOR_ATTACHMENT0+e)}e!==this.backBuffer&&(t.depthStencilOps.storeDepth||xo.push(n.DEPTH_ATTACHMENT),t.depthStencilOps.storeStencil||xo.push(n.STENCIL_ATTACHMENT)),xo.length>0&&t.fullSizeClearRect&&n.invalidateFramebuffer(n.DRAW_FRAMEBUFFER,xo),s&&t.colorOps?.resolve&&t.samples>1&&e.autoResolve&&e.resolve(!0,!1),e.depthBuffer&&t.depthStencilOps.resolveDepth&&t.samples>1&&e.autoResolve&&e.resolve(!1,!0);for(let n=0;n<s;n++){if(t.colorArrayOps[n].genMipmaps){const t=e._colorBuffers[n];t&&t.impl._glTexture&&t.mipmaps&&(this.activeTexture(this.maxCombinedTextures-1),this.bindTexture(t),this.gl.generateMipmap(t.impl._glTarget))}}}this.insideRenderPass=!1}set defaultFramebuffer(t){this._defaultFramebuffer!==t&&(this._defaultFramebuffer=t,this._defaultFramebufferChanged=!0)}get defaultFramebuffer(){return this._defaultFramebuffer}updateBegin(){if(this.boundVao=null,this._tempEnableSafariTextureUnitWorkaround)for(let t=0;t<this.textureUnits.length;++t)for(let e=0;e<3;++e)this.textureUnits[t][e]=null;const t=this.renderTarget??this.backBuffer,e=t.impl;e.initialized||this.initRenderTarget(t),this.setFramebuffer(e._glFrameBuffer)}updateEnd(){this.unbindVertexArray();const t=this.renderTarget;if(t&&t!==this.backBuffer){t._samples>1&&t.autoResolve&&t.resolve();const e=t._colorBuffer;e&&e.impl._glTexture&&e.mipmaps&&(this.activeTexture(this.maxCombinedTextures-1),this.bindTexture(e),this.gl.generateMipmap(e.impl._glTarget))}}setUnpackFlipY(t){if(this.unpackFlipY!==t){this.unpackFlipY=t;const e=this.gl;e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,t)}}setUnpackPremultiplyAlpha(t){if(this.unpackPremultiplyAlpha!==t){this.unpackPremultiplyAlpha=t;const e=this.gl;e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t)}}activeTexture(t){this.textureUnit!==t&&(this.gl.activeTexture(this.gl.TEXTURE0+t),this.textureUnit=t)}bindTexture(t){const e=t.impl,s=e._glTarget,n=e._glTexture,i=this.textureUnit,r=this.targetToSlot[s];this.textureUnits[i][r]!==n&&(this.gl.bindTexture(s,n),this.textureUnits[i][r]=n)}bindTextureOnUnit(t,e){const s=t.impl,n=s._glTarget,i=s._glTexture,r=this.targetToSlot[n];this.textureUnits[e][r]!==i&&(this.activeTexture(e),this.gl.bindTexture(n,i),this.textureUnits[e][r]=i)}setTextureParameters(t){const e=this.gl,s=t.impl.dirtyParameterFlags,n=t.impl._glTarget;if(1&s){let s=t._minFilter;(!t._mipmaps||t._compressed&&1===t._levels.length)&&(2===s||3===s?s=0:4!==s&&5!==s||(s=1)),e.texParameteri(n,e.TEXTURE_MIN_FILTER,this.glFilter[s])}if(2&s&&e.texParameteri(n,e.TEXTURE_MAG_FILTER,this.glFilter[t._magFilter]),4&s&&e.texParameteri(n,e.TEXTURE_WRAP_S,this.glAddress[t._addressU]),8&s&&e.texParameteri(n,e.TEXTURE_WRAP_T,this.glAddress[t._addressV]),16&s&&e.texParameteri(n,e.TEXTURE_WRAP_R,this.glAddress[t._addressW]),32&s&&e.texParameteri(n,e.TEXTURE_COMPARE_MODE,t._compareOnRead?e.COMPARE_REF_TO_TEXTURE:e.NONE),64&s&&e.texParameteri(n,e.TEXTURE_COMPARE_FUNC,this.glComparison[t._compareFunc]),128&s){const s=this.extTextureFilterAnisotropic;s&&e.texParameterf(n,s.TEXTURE_MAX_ANISOTROPY_EXT,Qe.clamp(Math.round(t._anisotropy),1,this.maxAnisotropy))}}setTexture(t,e){const s=t.impl;s._glTexture||s.initialize(this,t),s.dirtyParameterFlags>0||t._needsUpload||t._needsMipmapsUpload?(this.activeTexture(e),this.bindTexture(t),s.dirtyParameterFlags&&(this.setTextureParameters(t),s.dirtyParameterFlags=0),(t._needsUpload||t._needsMipmapsUpload)&&(s.upload(this,t),t._needsUpload=!1,t._needsMipmapsUpload=!1)):this.bindTextureOnUnit(t,e)}createVertexArray(t){let e,s;const n=t.length>1;if(n){e="";for(let s=0;s<t.length;s++){const n=t[s];e+=n.id+n.format.renderingHash}s=this._vaoMap.get(e)}if(!s){const i=this.gl;s=i.createVertexArray(),i.bindVertexArray(s),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null);for(let e=0;e<t.length;e++){const s=t[e];i.bindBuffer(i.ARRAY_BUFFER,s.impl.bufferId);const n=s.format.elements;for(let t=0;t<n.length;t++){const e=n[t],r=ni[e.name];e.asInt?i.vertexAttribIPointer(r,e.numComponents,this.glType[e.dataType],e.stride,e.offset):i.vertexAttribPointer(r,e.numComponents,this.glType[e.dataType],e.normalize,e.stride,e.offset),i.enableVertexAttribArray(r),s.format.instancing&&i.vertexAttribDivisor(r,1)}}i.bindVertexArray(null),i.bindBuffer(i.ARRAY_BUFFER,null),n&&this._vaoMap.set(e,s)}return s}unbindVertexArray(){this.boundVao&&(this.boundVao=null,this.gl.bindVertexArray(null))}setBuffers(t){const e=this.gl;let s;if(1===this.vertexBuffers.length){const t=this.vertexBuffers[0];t.impl.vao||(t.impl.vao=this.createVertexArray(this.vertexBuffers)),s=t.impl.vao}else s=this.createVertexArray(this.vertexBuffers);this.boundVao!==s&&(this.boundVao=s,e.bindVertexArray(s));const n=t?t.impl.bufferId:null;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,n)}_multiDrawLoopFallback(t,e,s,n,i){const r=this.gl;if(e.indexed){const e=s.impl.glFormat,{glCounts:a,glOffsetsBytes:o,glInstanceCounts:l,count:h}=i.impl;if(n>0)for(let s=0;s<h;s++)r.drawElementsInstanced(t,a[s],e,o[s],l[s]);else for(let s=0;s<h;s++)r.drawElements(t,a[s],e,o[s])}else{const{glCounts:e,glOffsetsBytes:s,glInstanceCounts:a,count:o}=i.impl;if(n>0)for(let n=0;n<o;n++)r.drawArraysInstanced(t,s[n],e[n],a[n]);else for(let n=0;n<o;n++)r.drawArrays(t,s[n],e[n])}}draw(t,e,s,n,i=!0,r=!0){const a=this.shader;if(a&&(this.activateShader(),this.shaderValid)){const r=this.gl;i&&this.setBuffers(e);let o=0;const l=a.impl.samplers;for(let t=0,e=l.length;t<e;t++){const e=l[t];let s=e.scopeId.value;if(!s){const t=e.scopeId.name;"uSceneDepthMap"===t&&(s=vi(this,"white")),"uSceneColorMap"===t&&(s=vi(this,"pink")),s||(s=vi(this,"pink"))}if(s instanceof pi){const t=s;this.setTexture(t,o),e.slot!==o&&(r.uniform1i(e.locationId,o),e.slot=o),o++}else{e.array.length=0;const t=s.length;for(let n=0;n<t;n++){const t=s[n];this.setTexture(t,o),e.array[n]=o,o++}r.uniform1iv(e.locationId,e.array)}}const h=a.impl.uniforms;for(let t=0,e=h.length;t<e;t++){const e=h[t],s=e.scopeId,n=e.version,i=s.versionObject.version;if(n.globalId!==i.globalId||n.revision!==i.revision){n.globalId=i.globalId,n.revision=i.revision;const t=s.value;null!=t&&this.commitFunction[e.dataType](e,t)}}this.transformFeedbackBuffer&&(r.bindBufferBase(r.TRANSFORM_FEEDBACK_BUFFER,0,this.transformFeedbackBuffer.impl.bufferId),r.beginTransformFeedback(r.POINTS));const c=this.glPrimitive[t.type],d=t.count;if(n)if(this.extMultiDraw){const i=n.impl;if(t.indexed){const t=e.impl.glFormat;s>0?this.extMultiDraw.multiDrawElementsInstancedWEBGL(c,i.glCounts,0,t,i.glOffsetsBytes,0,i.glInstanceCounts,0,n.count):this.extMultiDraw.multiDrawElementsWEBGL(c,i.glCounts,0,t,i.glOffsetsBytes,0,n.count)}else s>0?this.extMultiDraw.multiDrawArraysInstancedWEBGL(c,i.glOffsetsBytes,0,i.glCounts,0,i.glInstanceCounts,0,n.count):this.extMultiDraw.multiDrawArraysWEBGL(c,i.glOffsetsBytes,0,i.glCounts,0,n.count)}else this._multiDrawLoopFallback(c,t,e,s,n);else if(t.indexed){const n=e.impl.glFormat,i=t.base*e.bytesPerIndex;s>0?r.drawElementsInstanced(c,d,n,i,s):r.drawElements(c,d,n,i)}else{const e=t.base;s>0?r.drawArraysInstanced(c,e,d,s):r.drawArrays(c,e,d)}this.transformFeedbackBuffer&&(r.endTransformFeedback(),r.bindBufferBase(r.TRANSFORM_FEEDBACK_BUFFER,0,null)),this._drawCallsPerFrame++}r&&this.clearVertexBuffer()}clear(t){const e=this.defaultClearOptions,s=(t=t||e).flags??e.flags;if(0!==s){const n=this.gl;if(1&s){const s=t.color??e.color,n=s[0],i=s[1],r=s[2],a=s[3],o=this.clearColor;n===o.r&&i===o.g&&r===o.b&&a===o.a||(this.gl.clearColor(n,i,r,a),this.clearColor.set(n,i,r,a)),this.setBlendState(Ti.NOBLEND)}if(2&s){const s=t.depth??e.depth;s!==this.clearDepth&&(this.gl.clearDepth(s),this.clearDepth=s),this.setDepthState(Ai.WRITEDEPTH)}if(4&s){const s=t.stencil??e.stencil;s!==this.clearStencil&&(this.gl.clearStencil(s),this.clearStencil=s),n.stencilMask(255),this.stencilWriteMaskFront=255,this.stencilWriteMaskBack=255}n.clear(this.glClearFlag[s])}}submit(){this.gl.flush()}readPixels(t,e,s,n,i){const r=this.gl;r.readPixels(t,e,s,n,r.RGBA,r.UNSIGNED_BYTE,i)}clientWaitAsync(t,e){const s=this.gl,n=s.fenceSync(s.SYNC_GPU_COMMANDS_COMPLETE,0);return this.submit(),new Promise((i,r)=>{!function a(){const o=s.clientWaitSync(n,t,0);o===s.TIMEOUT_EXPIRED?setTimeout(a,e):(s.deleteSync(n),o===s.WAIT_FAILED?r(new Error("webgl clientWaitSync sync failed")):i())}()})}async readPixelsAsync(t,e,s,n,i){const r=this.gl,a=this.renderTarget.colorBuffer?.impl,o=a?._glFormat??r.RGBA,l=a?._glPixelType??r.UNSIGNED_BYTE,h=r.createBuffer();return r.bindBuffer(r.PIXEL_PACK_BUFFER,h),r.bufferData(r.PIXEL_PACK_BUFFER,i.byteLength,r.STREAM_READ),r.readPixels(t,e,s,n,o,l,0),r.bindBuffer(r.PIXEL_PACK_BUFFER,null),await this.clientWaitAsync(0,16),r.bindBuffer(r.PIXEL_PACK_BUFFER,h),r.getBufferSubData(r.PIXEL_PACK_BUFFER,0,i),r.bindBuffer(r.PIXEL_PACK_BUFFER,null),r.deleteBuffer(h),i}readTextureAsync(t,e,s,n,i,r){const a=r.face??0,o=r.renderTarget??new ji({colorBuffer:t,depth:!1,face:a}),l=new ArrayBuffer(ui.calcLevelGpuSize(n,i,1,t._format)),h=r.data??new(Ks(t._format))(l);return this.setRenderTarget(o),this.initRenderTarget(o),this.setFramebuffer(o.impl._glFrameBuffer),new Promise((t,a)=>{this.readPixelsAsync(e,s,n,i,h).then(e=>{this._destroyed||(r.renderTarget||o.destroy(),t(e))}).catch(a)})}async writeTextureAsync(t,e,s,n,i,r){const a=this.gl,o=t.impl,l=o?._glFormat??a.RGBA,h=o?._glPixelType??a.UNSIGNED_BYTE,c=a.createBuffer();a.bindBuffer(a.PIXEL_UNPACK_BUFFER,c),a.bufferData(a.PIXEL_UNPACK_BUFFER,r,a.STREAM_DRAW),a.bindTexture(a.TEXTURE_2D,o._glTexture),a.texSubImage2D(a.TEXTURE_2D,0,e,s,n,i,l,h,0),a.bindBuffer(a.PIXEL_UNPACK_BUFFER,null),t._needsUpload=!1,t._mipmapsUploaded=!1,await this.clientWaitAsync(0,16)}setAlphaToCoverage(t){this.alphaToCoverage!==t&&(this.alphaToCoverage=t,t?this.gl.enable(this.gl.SAMPLE_ALPHA_TO_COVERAGE):this.gl.disable(this.gl.SAMPLE_ALPHA_TO_COVERAGE))}setTransformFeedbackBuffer(t){if(this.transformFeedbackBuffer!==t){this.transformFeedbackBuffer=t;const e=this.gl;t?(this.feedback||(this.feedback=e.createTransformFeedback()),e.bindTransformFeedback(e.TRANSFORM_FEEDBACK,this.feedback)):e.bindTransformFeedback(e.TRANSFORM_FEEDBACK,null)}}setRaster(t){this.raster!==t&&(this.raster=t,t?this.gl.disable(this.gl.RASTERIZER_DISCARD):this.gl.enable(this.gl.RASTERIZER_DISCARD))}setStencilTest(t){if(this.stencil!==t){const e=this.gl;t?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),this.stencil=t}}setStencilFunc(t,e,s){this.stencilFuncFront===t&&this.stencilRefFront===e&&this.stencilMaskFront===s&&this.stencilFuncBack===t&&this.stencilRefBack===e&&this.stencilMaskBack===s||(this.gl.stencilFunc(this.glComparison[t],e,s),this.stencilFuncFront=this.stencilFuncBack=t,this.stencilRefFront=this.stencilRefBack=e,this.stencilMaskFront=this.stencilMaskBack=s)}setStencilFuncFront(t,e,s){if(this.stencilFuncFront!==t||this.stencilRefFront!==e||this.stencilMaskFront!==s){const n=this.gl;n.stencilFuncSeparate(n.FRONT,this.glComparison[t],e,s),this.stencilFuncFront=t,this.stencilRefFront=e,this.stencilMaskFront=s}}setStencilFuncBack(t,e,s){if(this.stencilFuncBack!==t||this.stencilRefBack!==e||this.stencilMaskBack!==s){const n=this.gl;n.stencilFuncSeparate(n.BACK,this.glComparison[t],e,s),this.stencilFuncBack=t,this.stencilRefBack=e,this.stencilMaskBack=s}}setStencilOperation(t,e,s,n){this.stencilFailFront===t&&this.stencilZfailFront===e&&this.stencilZpassFront===s&&this.stencilFailBack===t&&this.stencilZfailBack===e&&this.stencilZpassBack===s||(this.gl.stencilOp(this.glStencilOp[t],this.glStencilOp[e],this.glStencilOp[s]),this.stencilFailFront=this.stencilFailBack=t,this.stencilZfailFront=this.stencilZfailBack=e,this.stencilZpassFront=this.stencilZpassBack=s),this.stencilWriteMaskFront===n&&this.stencilWriteMaskBack===n||(this.gl.stencilMask(n),this.stencilWriteMaskFront=n,this.stencilWriteMaskBack=n)}setStencilOperationFront(t,e,s,n){this.stencilFailFront===t&&this.stencilZfailFront===e&&this.stencilZpassFront===s||(this.gl.stencilOpSeparate(this.gl.FRONT,this.glStencilOp[t],this.glStencilOp[e],this.glStencilOp[s]),this.stencilFailFront=t,this.stencilZfailFront=e,this.stencilZpassFront=s),this.stencilWriteMaskFront!==n&&(this.gl.stencilMaskSeparate(this.gl.FRONT,n),this.stencilWriteMaskFront=n)}setStencilOperationBack(t,e,s,n){this.stencilFailBack===t&&this.stencilZfailBack===e&&this.stencilZpassBack===s||(this.gl.stencilOpSeparate(this.gl.BACK,this.glStencilOp[t],this.glStencilOp[e],this.glStencilOp[s]),this.stencilFailBack=t,this.stencilZfailBack=e,this.stencilZpassBack=s),this.stencilWriteMaskBack!==n&&(this.gl.stencilMaskSeparate(this.gl.BACK,n),this.stencilWriteMaskBack=n)}setBlendState(t){const e=this.blendState;if(!e.equals(t)){const s=this.gl,{blend:n,colorOp:i,alphaOp:r,colorSrcFactor:a,colorDstFactor:o,alphaSrcFactor:l,alphaDstFactor:h}=t;if(e.blend!==n&&(n?s.enable(s.BLEND):s.disable(s.BLEND)),e.colorOp!==i||e.alphaOp!==r){const t=this.glBlendEquation;s.blendEquationSeparate(t[i],t[r])}e.colorSrcFactor===a&&e.colorDstFactor===o&&e.alphaSrcFactor===l&&e.alphaDstFactor===h||s.blendFuncSeparate(this.glBlendFunctionColor[a],this.glBlendFunctionColor[o],this.glBlendFunctionAlpha[l],this.glBlendFunctionAlpha[h]),e.allWrite!==t.allWrite&&this.gl.colorMask(t.redWrite,t.greenWrite,t.blueWrite,t.alphaWrite),e.copy(t)}}setBlendColor(t,e,s,n){const i=this.blendColor;t===i.r&&e===i.g&&s===i.b&&n===i.a||(this.gl.blendColor(t,e,s,n),i.set(t,e,s,n))}setStencilState(t,e){t||e?(this.setStencilTest(!0),t===e?(this.setStencilFunc(t.func,t.ref,t.readMask),this.setStencilOperation(t.fail,t.zfail,t.zpass,t.writeMask)):(t??=Hi.DEFAULT,this.setStencilFuncFront(t.func,t.ref,t.readMask),this.setStencilOperationFront(t.fail,t.zfail,t.zpass,t.writeMask),e??=Hi.DEFAULT,this.setStencilFuncBack(e.func,e.ref,e.readMask),this.setStencilOperationBack(e.fail,e.zfail,e.zpass,e.writeMask))):this.setStencilTest(!1)}setDepthState(t){const e=this.depthState;if(!e.equals(t)){const s=this.gl,n=t.write;e.write!==n&&s.depthMask(n);let{func:i,test:r}=t;!r&&n&&(r=!0,i=7),e.func!==i&&s.depthFunc(this.glComparison[i]),e.test!==r&&(r?s.enable(s.DEPTH_TEST):s.disable(s.DEPTH_TEST));const{depthBias:a,depthBiasSlope:o}=t;a||o?(this.depthBiasEnabled||(this.depthBiasEnabled=!0,this.gl.enable(this.gl.POLYGON_OFFSET_FILL)),s.polygonOffset(o,a)):this.depthBiasEnabled&&(this.depthBiasEnabled=!1,this.gl.disable(this.gl.POLYGON_OFFSET_FILL)),e.copy(t)}}setCullMode(t){if(this.cullMode!==t){if(0===t)this.gl.disable(this.gl.CULL_FACE);else{0===this.cullMode&&this.gl.enable(this.gl.CULL_FACE);const e=this.glCull[t];this.cullFace!==e&&(this.gl.cullFace(e),this.cullFace=e)}this.cullMode=t}}setShader(t,e=!1){t!==this.shader&&(this.shader=t,this.shaderAsyncCompile=e,this.shaderValid=void 0)}activateShader(){const{shader:t}=this,{impl:e}=t;void 0===this.shaderValid&&(t.failed?this.shaderValid=!1:t.ready||(this.shaderAsyncCompile?e.isLinked(this)?e.finalize(this,t)||(t.failed=!0,this.shaderValid=!1):this.shaderValid=!1:e.finalize(this,t)||(t.failed=!0,this.shaderValid=!1))),void 0===this.shaderValid&&(this.gl.useProgram(e.glProgram),this.shaderValid=!0)}clearVertexArrayObjectCache(){const t=this.gl;this._vaoMap.forEach((e,s,n)=>{t.deleteVertexArray(e)}),this._vaoMap.clear()}set fullscreen(t){if(t){this.gl.canvas.requestFullscreen()}else document.exitFullscreen()}get fullscreen(){return!!document.fullscreenElement}}class To{unlock(t){}}class Co{destroy(t){}init(t,e){}loseContext(){}resolve(t,e,s,n){}}class Eo{destroy(t){}loseContext(){}restoreContext(t,e){}}class Ao{destroy(t){}propertyChanged(t){}loseContext(){}}class Do{destroy(t){}unlock(t){}}class Po{add(t,e,s,n){}}class Lo extends Gi{constructor(t,e={}){super(t,e),e=this.initOptions,this.isNull=!0,this._deviceType=Xn,this.samples=1,this.backBuffer=new ji({name:"Framebuffer",graphicsDevice:this,depth:this.initOptions.depth,stencil:this.supportsStencil,samples:this.samples}),this.initDeviceCaps()}destroy(){super.destroy()}initDeviceCaps(){this.disableParticleSystem=!0,this.precision="highp",this.maxPrecision="highp",this.maxSamples=4,this.maxTextures=16,this.maxTextureSize=4096,this.maxCubeMapSize=4096,this.maxVolumeSize=4096,this.maxColorAttachments=8,this.maxPixelRatio=1,this.maxAnisotropy=16,this.supportsUniformBuffers=!1,this.supportsAreaLights=!0,this.supportsGpuParticles=!1,this.textureFloatRenderable=!0,this.textureHalfFloatRenderable=!0,this.supportsImageBitmap=!1}postInit(){super.postInit()}frameStart(){super.frameStart()}frameEnd(){super.frameEnd()}updateBegin(){}updateEnd(){}readPixels(t,e,s,n,i){}createVertexBufferImpl(t,e){return new Do(t,e)}createIndexBufferImpl(t){return new To(t)}createShaderImpl(t){return new Eo(t)}createTextureImpl(t){return new Ao(t)}createRenderTargetImpl(t){return new Co(t)}createDrawCommandImpl(t){return new Po}createUploadStreamImpl(t){return null}draw(t,e,s,n,i=!0,r=!0){}setShader(t,e=!1){}setBlendState(t){}setDepthState(t){}setStencilState(t,e){}setBlendColor(t,e,s,n){}setCullMode(t){}setAlphaToCoverage(t){}initializeContextCaches(){super.initializeContextCaches()}clear(t){}setViewport(t,e,s,n){}setScissor(t,e,s,n){}copyRenderTarget(t,e,s,n){return!0}}class Io{get maxCount(){return this._maxCount}get count(){return this._count}constructor(t,e=0){this._maxCount=0,this.impl=null,this._count=1,this.slotIndex=0,this.device=t,this.indexSizeBytes=e,this.impl=t.createDrawCommandImpl(this)}destroy(){this.impl?.destroy?.(),this.impl=null}allocate(t){this._maxCount=t,this.impl.allocate?.(t)}add(t,e,s,n,i=0,r=0){this.impl.add(t,e,s,n,i,r)}update(t){this._count=t,this.impl.update?.(t)}}let Ro=0;class Mo{constructor(t,e,s,n=0,i,r){this.device=t,this.format=e,this.numIndices=s,this.usage=n,this.id=Ro++,this.impl=t.createIndexBufferImpl(this,r);const a=ei[e];this.bytesPerIndex=a,this.numBytes=this.numIndices*a,i?this.setData(i):this.storage=new ArrayBuffer(this.numBytes),this.adjustVramSizeTracking(t._vram,this.numBytes),this.device.buffers.push(this)}destroy(){const t=this.device,e=t.buffers.indexOf(this);-1!==e&&t.buffers.splice(e,1),this.device.indexBuffer===this&&(this.device.indexBuffer=null),this.impl.initialized&&(this.impl.destroy(t),this.adjustVramSizeTracking(t._vram,-this.storage.byteLength))}adjustVramSizeTracking(t,e){t.ib+=e}loseContext(){this.impl.loseContext()}getFormat(){return this.format}getNumIndices(){return this.numIndices}lock(){return this.storage}unlock(){this.impl.unlock(this)}setData(t){return t.byteLength===this.numBytes&&(this.storage=t,this.unlock(),!0)}_lockTypedArray(){const t=this.lock();return 2===this.format?new Uint32Array(t):1===this.format?new Uint16Array(t):new Uint8Array(t)}writeData(t,e){const s=this._lockTypedArray();if(t.length>e)if(ArrayBuffer.isView(t))t=t.subarray(0,e),s.set(t);else for(let n=0;n<e;n++)s[n]=t[n];else s.set(t);this.unlock()}readData(t){const e=this._lockTypedArray(),s=this.numIndices;if(ArrayBuffer.isView(t))t.set(e);else{t.length=0;for(let n=0;n<s;n++)t[n]=e[n]}return s}}class ko{constructor(){this.clearValue=new Ze(0,0,0,1),this.clearValueLinear=new Ze(0,0,0,1),this.clear=!1,this.store=!1,this.resolve=!0,this.genMipmaps=!1}}class Oo{constructor(){this.clearDepthValue=1,this.clearStencilValue=0,this.clearDepth=!1,this.clearStencil=!1,this.storeDepth=!1,this.resolveDepth=!1,this.storeStencil=!1}}class Fo{get colorOps(){return this.colorArrayOps[0]}constructor(t){this._enabled=!0,this._skipStart=!1,this._skipEnd=!1,this.executeEnabled=!0,this.samples=0,this.colorArrayOps=[],this.requiresCubemaps=!0,this.fullSizeClearRect=!0,this.beforePasses=[],this.afterPasses=[],this.device=t}set name(t){this._name=t}get name(){return this._name||(this._name=this.constructor.name),this._name}set scaleX(t){this._options.scaleX=t}get scaleX(){return this._options.scaleX}set scaleY(t){this._options.scaleY=t}get scaleY(){return this._options.scaleY}set options(t){this._options=t,t&&(this.scaleX=this.scaleX??1,this.scaleY=this.scaleY??1)}get options(){return this._options}init(t=null,e){this.options=e,this.renderTarget=t,this.samples=Math.max(this.renderTarget?this.renderTarget.samples:this.device.samples,1),this.allocateAttachments(),this.postInit()}allocateAttachments(){const t=this.renderTarget;this.depthStencilOps=new Oo,t?.depthBuffer&&(this.depthStencilOps.storeDepth=!0);const e=t?t._colorBuffers?.length??0:1;this.colorArrayOps.length=0;for(let t=0;t<e;t++){const e=new ko;this.colorArrayOps[t]=e,1===this.samples&&(e.store=!0,e.resolve=!1);const s=this.renderTarget?._colorBuffers?.[t];if(this.renderTarget?.mipmaps&&s?.mipmaps){const t=Xs(s._format);e.genMipmaps=!t}}}destroy(){}postInit(){}frameUpdate(){if(this._options&&this.renderTarget){const t=this._options.resizeSource??this.device.backBuffer,e=Math.floor(t.width*this.scaleX),s=Math.floor(t.height*this.scaleY);this.renderTarget.resize(e,s)}}before(){}execute(){}after(){}onEnable(){}onDisable(){}set enabled(t){this._enabled!==t&&(this._enabled=t,t?this.onEnable():this.onDisable())}get enabled(){return this._enabled}setClearColor(t){const e=this.colorArrayOps.length;for(let s=0;s<e;s++){const e=this.colorArrayOps[s];t&&(e.clearValue.copy(t),e.clearValueLinear.linear(t)),e.clear=!!t}}setClearDepth(t){void 0!==t&&(this.depthStencilOps.clearDepthValue=t),this.depthStencilOps.clearDepth=void 0!==t}setClearStencil(t){void 0!==t&&(this.depthStencilOps.clearStencilValue=t),this.depthStencilOps.clearStencil=void 0!==t}render(){if(this.enabled){const t=this.device,e=void 0!==this.renderTarget;this.before(),this.executeEnabled&&(e&&!this._skipStart&&t.startRenderPass(this),this.execute(),e&&!this._skipEnd&&t.endRenderPass(this)),this.after(),t.renderPassIndex++}}}function No(t){this.array[this.index]=t}function Bo(t,e){this.array[this.index]=t,this.array[this.index+1]=e}function zo(t,e,s){this.array[this.index]=t,this.array[this.index+1]=e,this.array[this.index+2]=s}function Uo(t,e,s,n){this.array[this.index]=t,this.array[this.index+1]=e,this.array[this.index+2]=s,this.array[this.index+3]=n}function Vo(t,e,s){this.array[t]=e[s]}function Ho(t,e,s){this.array[t]=e[s],this.array[t+1]=e[s+1]}function Go(t,e,s){this.array[t]=e[s],this.array[t+1]=e[s+1],this.array[t+2]=e[s+2]}function Wo(t,e,s){this.array[t]=e[s],this.array[t+1]=e[s+1],this.array[t+2]=e[s+2],this.array[t+3]=e[s+3]}function jo(t,e,s){e[s]=this.array[t]}function $o(t,e,s){e[s]=this.array[t],e[s+1]=this.array[t+1]}function Xo(t,e,s){e[s]=this.array[t],e[s+1]=this.array[t+1],e[s+2]=this.array[t+2]}function qo(t,e,s){e[s]=this.array[t],e[s+1]=this.array[t+1],e[s+2]=this.array[t+2],e[s+3]=this.array[t+3]}class Ko{constructor(t,e,s){switch(this.index=0,this.numComponents=e.numComponents,s.interleaved?this.array=new Zn[e.dataType](t,e.offset):this.array=new Zn[e.dataType](t,e.offset,s.vertexCount*e.numComponents),this.stride=e.stride/this.array.constructor.BYTES_PER_ELEMENT,e.numComponents){case 1:this.set=No,this.getToArray=jo,this.setFromArray=Vo;break;case 2:this.set=Bo,this.getToArray=$o,this.setFromArray=Ho;break;case 3:this.set=zo,this.getToArray=Xo,this.setFromArray=Go;break;case 4:this.set=Uo,this.getToArray=qo,this.setFromArray=Wo}}get(t){return this.array[this.index+t]}set(t,e,s,n){}getToArray(t,e,s){}setFromArray(t,e,s){}}class Yo{constructor(t){this.vertexBuffer=t,this.vertexFormatSize=t.getFormat().size,this.buffer=this.vertexBuffer.lock(),this.accessors=[],this.element={};const e=this.vertexBuffer.getFormat();for(let t=0;t<e.elements.length;t++){const s=e.elements[t];this.accessors[t]=new Ko(this.buffer,s,e),this.element[s.name]=this.accessors[t]}}next(t=1){let e=0;const s=this.accessors,n=this.accessors.length;for(;e<n;){const n=s[e++];n.index+=t*n.stride}}end(){this.vertexBuffer.unlock()}writeData(t,e,s){const n=this.element[t];if(n){s>this.vertexBuffer.numVertices&&(s=this.vertexBuffer.numVertices);const t=n.numComponents;if(this.vertexBuffer.getFormat().interleaved){let i=0;for(let r=0;r<s;r++)n.setFromArray(i,e,r*t),i+=n.stride}else if(e.length>s*t){const i=s*t;if(ArrayBuffer.isView(e))e=e.subarray(0,i),n.array.set(e);else for(let t=0;t<i;t++)n.array[t]=e[t]}else n.array.set(e)}}readData(t,e){const s=this.element[t];let n=0;if(s){let t;n=this.vertexBuffer.numVertices;const i=s.numComponents;if(this.vertexBuffer.getFormat().interleaved){Array.isArray(e)&&(e.length=0),s.index=0;let r=0;for(t=0;t<n;t++)s.getToArray(r,e,t*i),r+=s.stride}else if(ArrayBuffer.isView(e))e.set(s.array);else{e.length=0;const r=n*i;for(t=0;t<r;t++)e[t]=s.array[t]}}return n}}const Qo=new class{constructor(t,e){this.key=null,this.element=null,this.event=null,e&&(this.key=e.keyCode,this.element=e.target,this.event=e)}};function Zo(t){return Qo.key=t.keyCode,Qo.element=t.target,Qo.event=t,Qo}function Jo(t){return"string"==typeof t?t.toUpperCase().charCodeAt(0):t}const tl={9:"Tab",13:"Enter",16:"Shift",17:"Control",18:"Alt",27:"Escape",37:"Left",38:"Up",39:"Right",40:"Down",46:"Delete",91:"Win"};class el extends Ve{static{this.EVENT_KEYDOWN="keydown"}static{this.EVENT_KEYUP="keyup"}constructor(t,e={}){super(),this._element=null,this._keymap={},this._lastmap={},this._keyDownHandler=this._handleKeyDown.bind(this),this._keyUpHandler=this._handleKeyUp.bind(this),this._keyPressHandler=this._handleKeyPress.bind(this),this._visibilityChangeHandler=this._handleVisibilityChange.bind(this),this._windowBlurHandler=this._handleWindowBlur.bind(this),t&&this.attach(t),this.preventDefault=e.preventDefault||!1,this.stopPropagation=e.stopPropagation||!1}attach(t){this._element&&this.detach(),this._element=t,this._element.addEventListener("keydown",this._keyDownHandler,!1),this._element.addEventListener("keypress",this._keyPressHandler,!1),this._element.addEventListener("keyup",this._keyUpHandler,!1),document.addEventListener("visibilitychange",this._visibilityChangeHandler,!1),window.addEventListener("blur",this._windowBlurHandler,!1)}detach(){this._element&&(this._element.removeEventListener("keydown",this._keyDownHandler),this._element.removeEventListener("keypress",this._keyPressHandler),this._element.removeEventListener("keyup",this._keyUpHandler),this._element=null,document.removeEventListener("visibilitychange",this._visibilityChangeHandler,!1),window.removeEventListener("blur",this._windowBlurHandler,!1))}toKeyIdentifier(t){t=Jo(t);const e=tl[t.toString()];if(e)return e;let s=t.toString(16).toUpperCase();const n=s.length;for(let t=0;t<4-n;t++)s=`0${s}`;return`U+${s}`}_handleKeyDown(t){const e=t.keyCode||t.charCode;if(void 0===e)return;const s=this.toKeyIdentifier(e);this._keymap[s]=!0,this.fire("keydown",Zo(t)),this.preventDefault&&t.preventDefault(),this.stopPropagation&&t.stopPropagation()}_handleKeyUp(t){const e=t.keyCode||t.charCode;if(void 0===e)return;const s=this.toKeyIdentifier(e);delete this._keymap[s],this.fire("keyup",Zo(t)),this.preventDefault&&t.preventDefault(),this.stopPropagation&&t.stopPropagation()}_handleKeyPress(t){this.fire("keypress",Zo(t)),this.preventDefault&&t.preventDefault(),this.stopPropagation&&t.stopPropagation()}_handleVisibilityChange(){"hidden"===document.visibilityState&&this._handleWindowBlur()}_handleWindowBlur(){this._keymap={},this._lastmap={}}update(){for(const t in this._lastmap)delete this._lastmap[t];for(const t in this._keymap)this._keymap.hasOwnProperty(t)&&(this._lastmap[t]=this._keymap[t])}isPressed(t){const e=Jo(t),s=this.toKeyIdentifier(e);return!!this._keymap[s]}wasPressed(t){const e=Jo(t),s=this.toKeyIdentifier(e);return!!this._keymap[s]&&!this._lastmap[s]}wasReleased(t){const e=Jo(t),s=this.toKeyIdentifier(e);return!this._keymap[s]&&!!this._lastmap[s]}}function sl(){return!!(document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement)}class nl{constructor(t,e){this.x=0,this.y=0,this.dx=0,this.dy=0,this.button=-1,this.wheelDelta=0,this.ctrlKey=!1,this.altKey=!1,this.shiftKey=!1,this.metaKey=!1;let s={x:0,y:0};if(e){if(e instanceof nl)throw Error("Expected MouseEvent");s=t._getTargetCoords(e)}else e={};if(s)this.x=s.x,this.y=s.y;else{if(!sl())return;this.x=0,this.y=0}"wheel"===e.type&&(e.deltaY>0?this.wheelDelta=1:e.deltaY<0&&(this.wheelDelta=-1)),sl()?(this.dx=e.movementX||e.webkitMovementX||e.mozMovementX||0,this.dy=e.movementY||e.webkitMovementY||e.mozMovementY||0):(this.dx=this.x-t._lastX,this.dy=this.y-t._lastY),"mousedown"!==e.type&&"mouseup"!==e.type||(this.button=e.button),this.buttons=t._buttons.slice(0),this.element=e.target,this.ctrlKey=e.ctrlKey??!1,this.altKey=e.altKey??!1,this.shiftKey=e.shiftKey??!1,this.metaKey=e.metaKey??!1,this.event=e}}class il extends Ve{static{this.EVENT_MOUSEMOVE="mousemove"}static{this.EVENT_MOUSEDOWN="mousedown"}static{this.EVENT_MOUSEUP="mouseup"}static{this.EVENT_MOUSEWHEEL="mousewheel"}constructor(t){super(),this._lastX=0,this._lastY=0,this._buttons=[!1,!1,!1],this._lastbuttons=[!1,!1,!1],this._target=null,this._attached=!1,this._upHandler=this._handleUp.bind(this),this._downHandler=this._handleDown.bind(this),this._moveHandler=this._handleMove.bind(this),this._wheelHandler=this._handleWheel.bind(this),this._contextMenuHandler=t=>{t.preventDefault()},this.attach(t)}static isPointerLocked(){return sl()}attach(t){if(this._target=t,this._attached)return;this._attached=!0;const e=!!ze.passiveEvents&&{passive:!1};window.addEventListener("mouseup",this._upHandler,e),window.addEventListener("mousedown",this._downHandler,e),window.addEventListener("mousemove",this._moveHandler,e),window.addEventListener("wheel",this._wheelHandler,e)}detach(){if(!this._attached)return;this._attached=!1,this._target=null;const t=!!ze.passiveEvents&&{passive:!1};window.removeEventListener("mouseup",this._upHandler,t),window.removeEventListener("mousedown",this._downHandler,t),window.removeEventListener("mousemove",this._moveHandler,t),window.removeEventListener("wheel",this._wheelHandler,t)}disableContextMenu(){this._target&&this._target.addEventListener("contextmenu",this._contextMenuHandler)}enableContextMenu(){this._target&&this._target.removeEventListener("contextmenu",this._contextMenuHandler)}enablePointerLock(t,e){if(!document.body.requestPointerLock)return void(e&&e());const s=()=>{t(),document.removeEventListener("pointerlockchange",s)},n=()=>{e(),document.removeEventListener("pointerlockerror",n)};t&&document.addEventListener("pointerlockchange",s,!1),e&&document.addEventListener("pointerlockerror",n,!1),document.body.requestPointerLock()}disablePointerLock(t){if(!document.exitPointerLock)return;const e=()=>{t(),document.removeEventListener("pointerlockchange",e)};t&&document.addEventListener("pointerlockchange",e,!1),document.exitPointerLock()}update(){this._lastbuttons[0]=this._buttons[0],this._lastbuttons[1]=this._buttons[1],this._lastbuttons[2]=this._buttons[2]}isPressed(t){return this._buttons[t]}wasPressed(t){return this._buttons[t]&&!this._lastbuttons[t]}wasReleased(t){return!this._buttons[t]&&this._lastbuttons[t]}_handleUp(t){this._buttons[t.button]=!1;const e=new nl(this,t);e.event&&this.fire("mouseup",e)}_handleDown(t){this._buttons[t.button]=!0;const e=new nl(this,t);e.event&&this.fire("mousedown",e)}_handleMove(t){const e=new nl(this,t);e.event&&(this.fire("mousemove",e),this._lastX=e.x,this._lastY=e.y)}_handleWheel(t){const e=new nl(this,t);e.event&&this.fire("mousewheel",e)}_getTargetCoords(t){const e=this._target.getBoundingClientRect(),s=Math.floor(e.left),n=Math.floor(e.top);return t.clientX<s||t.clientX>=s+this._target.clientWidth||t.clientY<n||t.clientY>=n+this._target.clientHeight?null:{x:t.clientX-s,y:t.clientY-n}}}class rl{constructor(t){const e=function(t){let e=0,s=0,n=t.target;for(;!(n instanceof HTMLElement)&&n;)n=n.parentNode;for(;n;)e+=n.offsetLeft-n.scrollLeft,s+=n.offsetTop-n.scrollTop,n=n.offsetParent;return{x:t.pageX-e,y:t.pageY-s}}(t);this.id=t.identifier,this.x=e.x,this.y=e.y,this.target=t.target,this.touch=t}}class al{constructor(t,e){this.touches=[],this.changedTouches=[],this.element=e.target,this.event=e,this.touches=Array.from(e.touches).map(t=>new rl(t)),this.changedTouches=Array.from(e.changedTouches).map(t=>new rl(t))}getTouchById(t,e){return e.find(e=>e.id===t)||null}}class ol extends Ve{static{this.EVENT_TOUCHSTART="touchstart"}static{this.EVENT_TOUCHEND="touchend"}static{this.EVENT_TOUCHMOVE="touchmove"}static{this.EVENT_TOUCHCANCEL="touchcancel"}constructor(t){super(),this._element=null,this._startHandler=this._handleTouchStart.bind(this),this._endHandler=this._handleTouchEnd.bind(this),this._moveHandler=this._handleTouchMove.bind(this),this._cancelHandler=this._handleTouchCancel.bind(this),this.attach(t)}attach(t){this._element&&this.detach(),this._element=t,this._element.addEventListener("touchstart",this._startHandler,!1),this._element.addEventListener("touchend",this._endHandler,!1),this._element.addEventListener("touchmove",this._moveHandler,!1),this._element.addEventListener("touchcancel",this._cancelHandler,!1)}detach(){this._element&&(this._element.removeEventListener("touchstart",this._startHandler,!1),this._element.removeEventListener("touchend",this._endHandler,!1),this._element.removeEventListener("touchmove",this._moveHandler,!1),this._element.removeEventListener("touchcancel",this._cancelHandler,!1)),this._element=null}_handleTouchStart(t){this.fire("touchstart",new al(this,t))}_handleTouchEnd(t){this.fire("touchend",new al(this,t))}_handleTouchMove(t){t.preventDefault(),this.fire("touchmove",new al(this,t))}_handleTouchCancel(t){this.fire("touchcancel",new al(this,t))}}class ll{static{this.ContentType={AAC:"audio/aac",BASIS:"image/basis",BIN:"application/octet-stream",DDS:"image/dds",FORM_URLENCODED:"application/x-www-form-urlencoded",GIF:"image/gif",GLB:"model/gltf-binary",JPEG:"image/jpeg",JSON:"application/json",MP3:"audio/mpeg",MP4:"audio/mp4",OGG:"audio/ogg",OPUS:'audio/ogg; codecs="opus"',PNG:"image/png",TEXT:"text/plain",WAV:"audio/x-wav",XML:"application/xml"}}static{this.ResponseType={TEXT:"text",ARRAY_BUFFER:"arraybuffer",BLOB:"blob",DOCUMENT:"document",JSON:"json"}}static{this.binaryExtensions=[".model",".wav",".ogg",".mp3",".mp4",".m4a",".aac",".dds",".basis",".glb",".opus"]}static{this.retryDelay=100}get(t,e,s){"function"==typeof e&&(s=e,e={});const n=this.request("GET",t,e,s),{progress:i}=e;if(i){const t=t=>{t.lengthComputable&&i.fire("progress",t.loaded,t.total)},e=s=>{t(s),n.removeEventListener("loadstart",t),n.removeEventListener("progress",t),n.removeEventListener("loadend",e)};n.addEventListener("loadstart",t),n.addEventListener("progress",t),n.addEventListener("loadend",e)}return n}post(t,e,s,n){return"function"==typeof s&&(n=s,s={}),s.postdata=e,this.request("POST",t,s,n)}put(t,e,s,n){return"function"==typeof s&&(n=s,s={}),s.postdata=e,this.request("PUT",t,s,n)}del(t,e,s){return"function"==typeof e&&(s=e,e={}),this.request("DELETE",t,e,s)}request(t,e,s,n){let i,r,a,o=!1;if("function"==typeof s&&(n=s,s={}),s.retry&&(s=Object.assign({retries:0,maxRetries:5},s)),s.callback=n,null==s.async&&(s.async=!0),null==s.headers&&(s.headers={}),null!=s.postdata)if(s.postdata instanceof Document)a=s.postdata;else if(s.postdata instanceof FormData)a=s.postdata;else if(s.postdata instanceof Object){let t=s.headers["Content-Type"];switch(void 0===t&&(s.headers["Content-Type"]=ll.ContentType.FORM_URLENCODED,t=s.headers["Content-Type"]),t){case ll.ContentType.FORM_URLENCODED:{a="";let t=!0;for(const e in s.postdata)if(s.postdata.hasOwnProperty(e)){t?t=!1:a+="&";a+=`${encodeURIComponent(e)}=${encodeURIComponent(s.postdata[e])}`}break}default:case ll.ContentType.JSON:null==t&&(s.headers["Content-Type"]=ll.ContentType.JSON),a=JSON.stringify(s.postdata)}}else a=s.postdata;if(!1===s.cache){const t=Xe();i=new Ke(e),i.query?i.query=`${i.query}&ts=${t}`:i.query=`ts=${t}`,e=i.toString()}s.query&&(i=new Ke(e),r=Ie(i.getQuery(),s.query),i.setQuery(r),e=i.toString());const l=new XMLHttpRequest;l.open(t,e,s.async),l.withCredentials=void 0!==s.withCredentials&&s.withCredentials,l.responseType=s.responseType||this._guessResponseType(e);for(const t in s.headers)s.headers.hasOwnProperty(t)&&l.setRequestHeader(t,s.headers[t]);l.onreadystatechange=()=>{this._onReadyStateChange(t,e,s,l)},l.onerror=()=>{this._onError(t,e,s,l),o=!0};try{l.send(a)}catch(t){o||s.error(l.status,l,t)}return l}_guessResponseType(t){const e=new Ke(t),s=Me.getExtension(e.path).toLowerCase();return ll.binaryExtensions.indexOf(s)>=0?ll.ResponseType.ARRAY_BUFFER:".json"===s?ll.ResponseType.JSON:".xml"===s?ll.ResponseType.DOCUMENT:ll.ResponseType.TEXT}_isBinaryContentType(t){return[ll.ContentType.BASIS,ll.ContentType.BIN,ll.ContentType.DDS,ll.ContentType.GLB,ll.ContentType.MP3,ll.ContentType.MP4,ll.ContentType.OGG,ll.ContentType.OPUS,ll.ContentType.WAV].indexOf(t)>=0}_isBinaryResponseType(t){return t===ll.ResponseType.ARRAY_BUFFER||t===ll.ResponseType.BLOB||t===ll.ResponseType.JSON}_onReadyStateChange(t,e,s,n){if(4===n.readyState)switch(n.status){case 0:n.responseURL&&n.responseURL.startsWith("file:///")?this._onSuccess(t,e,s,n):this._onError(t,e,s,n);break;case 200:case 201:case 206:case 304:this._onSuccess(t,e,s,n);break;default:this._onError(t,e,s,n)}}_onSuccess(t,e,s,n){let i,r;const a=n.getResponseHeader("Content-Type");if(a){r=a.split(";")[0].trim()}try{i=this._isBinaryContentType(r)||this._isBinaryResponseType(n.responseType)?n.response:r===ll.ContentType.JSON||e.split("?")[0].endsWith(".json")?JSON.parse(n.responseText):n.responseType===ll.ResponseType.DOCUMENT||r===ll.ContentType.XML?n.responseXML:n.responseText,s.callback(null,i)}catch(t){s.callback(t)}}_onError(t,e,s,n){if(!s.retrying)if(s.retry&&s.retries<s.maxRetries){s.retries++,s.retrying=!0;const i=Qe.clamp(Math.pow(2,s.retries)*ll.retryDelay,0,s.maxRetryDelay||5e3);console.log(`${t}: ${e} - Error ${n.status}. Retrying in ${i} ms`),setTimeout(()=>{s.retrying=!1,this.request(t,e,s,s.callback)},i)}else s.callback(0===n.status?"Network error":n.status,null)}}const hl=new ll,cl=0,dl=1,ul=2,fl=3,pl=4,ml=5,gl=6,_l=7,vl=8,yl=9,bl=10,Sl={[cl]:"SUBTRACTIVE",[dl]:"ADDITIVE",[ul]:"NORMAL",[fl]:"NONE",[pl]:"PREMULTIPLIED",[ml]:"MULTIPLICATIVE",[gl]:"ADDITIVEALPHA",[_l]:"MULTIPLICATIVE2X",[vl]:"SCREEN",[yl]:"MIN",[bl]:"MAX"},xl="none",wl=0,Tl=2,Cl={[wl]:"NONE",[Tl]:"SCHLICK"},El=0,Al=1,Dl=2,Pl={[El]:"DIRECTIONAL",[Al]:"OMNI",[Dl]:"SPOT"},Ll=100,Il=0,Rl=1,Ml=2,kl=3,Ol={[Il]:"PUNCTUAL",[Rl]:"RECT",[Ml]:"DISK",[kl]:"SPHERE"},Fl=0,Nl=1,Bl={[Fl]:"LINEAR",[Nl]:"INVERSESQUARED"},zl=new Map([[5,{name:"PCF1_32F",kind:"PCF1",format:Ms,pcf:!0}],[0,{name:"PCF3_32F",kind:"PCF3",format:Ms,pcf:!0}],[4,{name:"PCF5_32F",kind:"PCF5",format:Ms,pcf:!0}],[7,{name:"PCF1_16F",kind:"PCF1",format:Gs,pcf:!0}],[8,{name:"PCF3_16F",kind:"PCF3",format:Gs,pcf:!0}],[9,{name:"PCF5_16F",kind:"PCF5",format:Gs,pcf:!0}],[2,{name:"VSM_16F",kind:"VSM",format:Ls,vsm:!0}],[3,{name:"VSM_32F",kind:"VSM",format:Is,vsm:!0}],[6,{name:"PCSS_32F",kind:"PCSS",format:Rs,pcss:!0}]]),Ul=0,Vl=1,Hl={[Ul]:"NONE",[Vl]:"BOX"},Gl=0,Wl=1,jl={[Gl]:"NONE",[Wl]:"SRGB"},$l=["LINEAR","FILMIC","HEJL","ACES","ACES2","NEUTRAL","NONE"],Xl=0,ql=1,Kl=2,Yl={[Xl]:"NONE",[ql]:"AO",[Kl]:"GLOSSDEPENDENT"},Ql="none",Zl="envAtlas",Jl="envAtlasHQ",th="cubeMap",eh="sphereMap",sh={[Ql]:"NONE",[Zl]:"ENVATLAS",[Jl]:"ENVATLASHQ",[th]:"CUBEMAP",[eh]:"SPHEREMAP"},nh="ambientSH",ih="envAtlas",rh="constant",ah={[nh]:"AMBIENTSH",[ih]:"ENVALATLAS",[rh]:"CONSTANT"},oh=256,lh=1024,hh=2048,ch=8192,dh=16384,uh=0,fh=1,ph=2,mh={[uh]:"SIMPLE",[fh]:"SLICED",[ph]:"TILED"},gh="infinite",_h="dome",vh="none",yh="bayer8",bh="bluenoise",Sh="ignnoise",xh={[vh]:"NONE",[yh]:"BAYER8",[bh]:"BLUENOISE",[Sh]:"IGNNOISE"},wh="prerender",Th="postrender",Ch="precull",Eh="postcull";class Ah{constructor(t,e,s){this.uniformFormats=[],this.bindGroupFormats=[],this.uniformFormats[0]=t,this.bindGroupFormats[0]=e,this.vertexFormat=s}hasUniform(t){for(let e=0;e<this.uniformFormats.length;e++){const s=this.uniformFormats[e];if(s?.get(t))return!0}return!1}hasTexture(t){for(let e=0;e<this.bindGroupFormats.length;e++){const s=this.bindGroupFormats[e];if(s?.getTexture(t))return!0}return!1}getVertexElement(t){return this.vertexFormat?.elements.find(e=>e.name===t)}generateKey(t){let e=JSON.stringify(this.uniformFormats)+JSON.stringify(this.bindGroupFormats);return t.isWebGPU&&(e+=this.vertexFormat?.shaderProcessingHashString),e}}const Dh=new di;function Ph(t){return Dh.get(t)}class Lh{static definesHash(t){const e=Array.from(t).sort((t,e)=>t[0]>e[0]?1:-1);return Oi(JSON.stringify(e))}}const Ih=new di;class Rh{constructor(t,e,s={}){this.defines=new Map,this.name=t,this.index=e,Object.assign(this,s),this.buildShaderDefines()}buildShaderDefines(){let t;this.isShadow?t="SHADOW":this.isForward?t="FORWARD":3===this.index?t="PICK":4===this.index&&(t="PICK",this.defines.set("DEPTH_PICK_PASS","")),this.defines.set(`${t}_PASS`,""),this.defines.set(`${this.name.toUpperCase()}_PASS`,"")}}class Mh{constructor(){this.passesNamed=new Map,this.passesIndexed=[],this.nextIndex=0;const t=(t,e,s)=>{this.allocate(t,s)};t("forward",0,{isForward:!0}),t("prepass"),t("shadow"),t("pick"),t("depth_pick")}static get(t){return Ih.get(t,()=>new Mh)}allocate(t,e){let s=this.passesNamed.get(t);return void 0===s&&(s=new Rh(t,this.nextIndex,e),this.passesNamed.set(s.name,s),this.passesIndexed[s.index]=s,this.nextIndex++),s}getByIndex(t){return this.passesIndexed[t]}getByName(t){return this.passesNamed.get(t)}}class kh extends Map{set(t,e){return this.has(t)&&this.get(t)===e||this.markDirty(),super.set(t,e)}add(t,e=!0){for(const[s,n]of Object.entries(t))!e&&this.has(s)||this.set(s,n);return this}delete(t){const e=this.has(t),s=super.delete(t);return e&&s&&this.markDirty(),s}clear(){this.size>0&&this.markDirty(),super.clear()}markDirty(){this._dirty=!0,this._keyDirty=!0}isDirty(){return this._dirty}resetDirty(){this._dirty=!1}get key(){return this._keyDirty&&(this._keyDirty=!1,this._key=Array.from(this.entries()).sort(([t],[e])=>t<e?-1:t>e?1:0).map(([t,e])=>`${t}=${Oi(e)}`).join(",")),this._key}copy(t){this.clear();for(const[e,s]of t)this.set(e,s);return this}constructor(...t){super(...t),this._keyDirty=!1,this._key=""}}const Oh=new di;class Fh{static get(t,e=In){const s=Oh.get(t,()=>new Fh);return e===In?s.glsl:s.wgsl}get useWGSL(){return 0===this.glsl.size||this.wgsl.size>0}get key(){return`GLSL:${this.glsl.key}|WGSL:${this.wgsl.key}|API:${this.version}`}isDirty(){return this.glsl.isDirty()||this.wgsl.isDirty()}resetDirty(){this.glsl.resetDirty(),this.wgsl.resetDirty()}copy(t){return this.version=t.version,this.glsl.copy(t.glsl),this.wgsl.copy(t.wgsl),this}constructor(){this.glsl=new kh,this.wgsl=new kh,this.version=""}}class Nh{static merge(...t){const e=new Map(t[0]??[]);for(let s=1;s<t.length;s++){const n=t[s];if(n)for(const[t,s]of n)e.set(t,s)}return e}}class Bh extends Lh{constructor(t,e){super(),this.key=t,this.shaderDefinition=e}generateKey(t){return this.key}createShaderDefinition(t,e){return this.shaderDefinition}}class zh{static createShader(t,e){const s=Ph(t);let n=s.getCachedShader(e.uniqueName);if(!n){const i=t.isWebGPU&&(!!e.vertexWGSL||!!e.vertexChunk)&&(!!e.fragmentWGSL||!!e.fragmentChunk),r=Fh.get(t,i?Rn:In),a=e.vertexChunk?r.get(e.vertexChunk):i?e.vertexWGSL:e.vertexGLSL,o=e.fragmentChunk?r.get(e.fragmentChunk):i?e.fragmentWGSL:e.fragmentGLSL,l=Nh.merge(r,e.fragmentIncludes),h=Nh.merge(r,e.vertexIncludes);n=new Oa(t,Ma.createDefinition(t,{name:e.uniqueName,shaderLanguage:i?Rn:In,attributes:e.attributes,vertexCode:a,fragmentCode:o,useTransformFeedback:e.useTransformFeedback,vertexIncludes:h,vertexDefines:e.vertexDefines,fragmentIncludes:l,fragmentDefines:e.fragmentDefines,fragmentOutputTypes:e.fragmentOutputTypes})),s.setCachedShader(e.uniqueName,n)}return n}static getCoreDefines(t,e){const s=new Map(t.defines);e.cameraShaderParams.defines.forEach((t,e)=>s.set(e,t));return Mh.get(e.device).getByIndex(e.pass).defines.forEach((t,e)=>s.set(e,t)),s}static processShader(t,e){const s=t.definition,n=`${s.name??"shader"}-id-${t.id}`,i=new Bh(n,s),r="shader",a=Ph(t.device);a.register(r,i);const o=a.getProgram(r,{},e);return a.unregister(r),o}static addScreenDepthChunkDefines(t,e,s){e.sceneDepthMapLinear&&s.set("SCENE_DEPTHMAP_LINEAR",""),t.textureFloatRenderable&&s.set("SCENE_DEPTHMAP_FLOAT","")}}const Uh={type:5,base:0,baseVertex:0,count:4,indexed:!1},Vh=new ls,Hh=new ls,Gh=new bi;class Wh{constructor(t){const e=t.device;if(this.shader=t,e.supportsUniformBuffers){const s=new Ah;this.shader=zh.processShader(t,s);const n=this.shader.meshUniformBufferFormat;n&&(this.uniformBuffer=new Ua(e,n,!1));const i=this.shader.meshBindGroupFormat;this.bindGroup=new Si(e,i)}}destroy(){this.uniformBuffer?.destroy(),this.uniformBuffer=null,this.bindGroup?.destroy(),this.bindGroup=null}render(t,e){const s=this.shader.device;t&&(Vh.set(s.vx,s.vy,s.vw,s.vh),Hh.set(s.sx,s.sy,s.sw,s.sh),e=e??t,s.setViewport(t.x,t.y,t.z,t.w),s.setScissor(e.x,e.y,e.z,e.w)),s.setVertexBuffer(s.quadVertexBuffer);const n=this.shader;if(s.setShader(n),s.supportsUniformBuffers){s.setBindGroup(0,s.emptyBindGroup);const t=this.bindGroup;t.update(),s.setBindGroup(1,t);const e=this.uniformBuffer;e?(e.update(Gh),s.setBindGroup(2,Gh.bindGroup,Gh.offsets)):s.setBindGroup(2,s.emptyBindGroup)}s.draw(Uh),t&&(s.setViewport(Vh.x,Vh.y,Vh.z,Vh.w),s.setScissor(Hh.x,Hh.y,Hh.z,Hh.w))}}class jh extends Fo{constructor(t,e,s,n){super(t),this.quad=e,this.rect=s,this.scissorRect=n}execute(){const{device:t}=this;t.setCullMode(0),t.setDepthState(Ai.NODEPTH),t.setStencilState(null,null),this.quad.render(this.rect,this.scissorRect)}}const $h=new ls;function Xh(t,e,s,n,i){const r=new Wh(s);n||((n=$h).x=0,n.y=0,n.z=e?e.width:t.width,n.w=e?e.height:t.height);const a=new jh(t,r,n,i);a.init(e),a.colorOps.clear=!1,a.depthStencilOps.clearDepth=!1,t.isWebGPU&&null===e&&t.samples>1&&(a.colorOps.store=!0),a.render(),r.destroy()}class qh{constructor(t,e,s,n,i=[0]){this._ui=!1,this._sprite=!1,this._obj={model:[],element:[],sprite:[],render:[]},this.id=t,this.name=e,this.dynamic=s,this.maxAabbSize=n,this.layers=i}static{this.MODEL="model"}static{this.ELEMENT="element"}static{this.SPRITE="sprite"}static{this.RENDER="render"}}const Kh=new ps;class Yh{constructor(t){this._dirty=!0,this._rootBone=null,this._skinUpdateIndex=-1,this._updateBeforeCull=!0,t&&this.initSkin(t)}set rootBone(t){this._rootBone=t}get rootBone(){return this._rootBone}init(t,e){const s=3*e;let n=Math.ceil(Math.sqrt(s));n=Qe.roundUp(n,3);const i=Math.ceil(s/n);this.boneTexture=new pi(t,{width:n,height:i,format:Is,mipmaps:!1,minFilter:0,magFilter:0,name:"skin"}),this.matrixPalette=this.boneTexture.lock({mode:1}),this.boneTexture.unlock()}destroy(){this.boneTexture&&(this.boneTexture.destroy(),this.boneTexture=null)}resolve(t,e){this.rootBone=t;const s=this.skin,n=[];for(let i=0;i<s.boneNames.length;i++){const r=s.boneNames[i];let a=t.findByName(r);a||(a=e),n.push(a)}this.bones=n}initSkin(t){this.skin=t,this.bones=[];const e=t.inverseBindPose.length;this.init(t.device,e),this.matrices=[];for(let t=0;t<e;t++)this.matrices[t]=new ps}uploadBones(t){this.boneTexture.upload()}_updateMatrices(t,e){if(this._skinUpdateIndex!==e){this._skinUpdateIndex=e,Kh.copy(t.getWorldTransform()).invert();for(let t=this.bones.length-1;t>=0;t--)this.matrices[t].mulAffine2(Kh,this.bones[t].getWorldTransform()),this.matrices[t].mulAffine2(this.matrices[t],this.skin.inverseBindPose[t])}}updateMatrices(t,e){this._updateBeforeCull&&this._updateMatrices(t,e)}updateMatrixPalette(t,e){this._updateMatrices(t,e);const s=this.matrixPalette,n=this.bones.length;for(let t=0;t<n;t++){const e=this.matrices[t].data,n=12*t;s[n]=e[0],s[n+1]=e[4],s[n+2]=e[8],s[n+3]=e[12],s[n+4]=e[1],s[n+5]=e[5],s[n+6]=e[9],s[n+7]=e[13],s[n+8]=e[2],s[n+9]=e[6],s[n+10]=e[10],s[n+11]=e[14]}this.uploadBones(this.skin.device)}}let Qh=0;class Zh{constructor(){this.initDefaults()}initDefaults(){this.recreate=!1,this.verticesUsage=0,this.indicesUsage=0,this.maxVertices=0,this.maxIndices=0,this.vertexCount=0,this.indexCount=0,this.vertexStreamsUpdated=!1,this.indexStreamUpdated=!1,this.vertexStreamDictionary={},this.indices=null}_changeVertexCount(t,e){this.vertexCount||(this.vertexCount=t)}static{this.DEFAULT_COMPONENTS_POSITION=3}static{this.DEFAULT_COMPONENTS_NORMAL=3}static{this.DEFAULT_COMPONENTS_UV=2}static{this.DEFAULT_COMPONENTS_COLORS=4}}class Jh{constructor(t,e,s,n,i){this.data=t,this.componentCount=e,this.dataType=s,this.dataTypeNormalize=n,this.asInt=i}}class tc extends gr{constructor(t,e){super(),this.indexBuffer=[null],this.vertexBuffer=null,this.primitive=[{type:0,base:0,baseVertex:0,count:0}],this.skin=null,this.boneAabb=null,this._aabbVer=0,this._aabb=new Ss,this._geometryData=null,this._morph=null,this._storageIndex=!1,this._storageVertex=!1,this.id=Qh++,this.device=t,this._storageIndex=e?.storageIndex||!1,this._storageVertex=e?.storageVertex||!1}static fromGeometry(t,e,s={}){const n=new tc(t,s),{positions:i,normals:r,tangents:a,colors:o,uvs:l,uvs1:h,blendIndices:c,blendWeights:d,indices:u}=e;return i&&n.setPositions(i),r&&n.setNormals(r),a&&n.setVertexStream(Zs,a,4),o&&n.setColors32(o),l&&n.setUvs(0,l),h&&n.setUvs(1,h),c&&n.setVertexStream(tn,c,4,c.length/4,1),d&&n.setVertexStream(Js,d,4),u&&n.setIndices(u),n.update(),n}set morph(t){t!==this._morph&&(this._morph&&this._morph.decRefCount(),this._morph=t,t&&t.incRefCount())}get morph(){return this._morph}set aabb(t){this._aabb=t,this._aabbVer++}get aabb(){return this._aabb}destroy(){const t=this.morph;t&&(this.morph=null,t.refCount<1&&t.destroy()),this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null);for(let t=0;t<this.indexBuffer.length;t++)this._destroyIndexBuffer(t);this.indexBuffer.length=0,this._geometryData=null}_destroyIndexBuffer(t){this.indexBuffer[t]&&(this.indexBuffer[t].destroy(),this.indexBuffer[t]=null)}_initBoneAabbs(t){let e,s,n,i,r;this.boneAabb=[],this.boneUsed=[];const a=[],o=[],l=this.boneUsed,h=this.skin.boneNames.length;let c,d,u;for(let t=0;t<h;t++)a[t]=new rs(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),o[t]=new rs(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);const f=new Yo(this.vertexBuffer),p=f.element[Ys],m=f.element[Js],g=f.element[tn],_=this.vertexBuffer.numVertices;for(let h=0;h<_;h++){for(let f=0;f<4;f++){if(m.array[m.index+f]>0){const m=g.array[g.index+f];if(l[m]=!0,e=p.array[p.index],s=p.array[p.index+1],n=p.array[p.index+2],i=o[m],r=a[m],r.x>e&&(r.x=e),r.y>s&&(r.y=s),r.z>n&&(r.z=n),i.x<e&&(i.x=e),i.y<s&&(i.y=s),i.z<n&&(i.z=n),t){let a=c=e,o=d=s,l=u=n;for(let e=0;e<t.length;e++){const s=t[e],n=s.deltaPositions[3*h],i=s.deltaPositions[3*h+1],r=s.deltaPositions[3*h+2];n<0?a+=n:c+=n,i<0?o+=i:d+=i,r<0?l+=r:u+=r}r.x>a&&(r.x=a),r.y>o&&(r.y=o),r.z>l&&(r.z=l),i.x<c&&(i.x=c),i.y<d&&(i.y=d),i.z<u&&(i.z=u)}}}f.next()}const v=this.vertexBuffer.getFormat().elements.find(t=>t.name===Ys);if(v&&v.normalize){const t=(()=>{switch(v.dataType){case 0:return t=>Math.max(t/127,-1);case 1:return t=>t/255;case 2:return t=>Math.max(t/32767,-1);case 3:return t=>t/65535;default:return t=>t}})();for(let e=0;e<h;e++)if(l[e]){const s=a[e],n=o[e];s.set(t(s.x),t(s.y),t(s.z)),n.set(t(n.x),t(n.y),t(n.z))}}for(let t=0;t<h;t++){const e=new Ss;e.setMinMax(a[t],o[t]),this.boneAabb.push(e)}}_initGeometryData(){this._geometryData||(this._geometryData=new Zh,this.vertexBuffer&&(this._geometryData.vertexCount=this.vertexBuffer.numVertices,this._geometryData.maxVertices=this.vertexBuffer.numVertices),this.indexBuffer.length>0&&this.indexBuffer[0]&&(this._geometryData.indexCount=this.indexBuffer[0].numIndices,this._geometryData.maxIndices=this.indexBuffer[0].numIndices))}clear(t,e,s=0,n=0){this._initGeometryData(),this._geometryData.initDefaults(),this._geometryData.recreate=!0,this._geometryData.maxVertices=s,this._geometryData.maxIndices=n,this._geometryData.verticesUsage=t?0:1,this._geometryData.indicesUsage=e?0:1}setVertexStream(t,e,s,n,i=6,r=!1,a=!1){this._initGeometryData();const o=n||e.length/s;this._geometryData._changeVertexCount(o,t),this._geometryData.vertexStreamsUpdated=!0,this._geometryData.vertexStreamDictionary[t]=new Jh(e,s,i,r,a)}getVertexStream(t,e){let s=0,n=!1;if(this._geometryData){const i=this._geometryData.vertexStreamDictionary[t];i&&(n=!0,s=this._geometryData.vertexCount,ArrayBuffer.isView(e)?e.set(i.data):(e.length=0,e.push(i.data)))}if(!n&&this.vertexBuffer){s=new Yo(this.vertexBuffer).readData(t,e)}return s}setPositions(t,e=Zh.DEFAULT_COMPONENTS_POSITION,s){this.setVertexStream(Ys,t,e,s,6,!1)}setNormals(t,e=Zh.DEFAULT_COMPONENTS_NORMAL,s){this.setVertexStream(Qs,t,e,s,6,!1)}setUvs(t,e,s=Zh.DEFAULT_COMPONENTS_UV,n){this.setVertexStream(sn+t,e,s,n,6,!1)}setColors(t,e=Zh.DEFAULT_COMPONENTS_COLORS,s){this.setVertexStream(en,t,e,s,6,!1)}setColors32(t,e){this.setVertexStream(en,t,Zh.DEFAULT_COMPONENTS_COLORS,e,1,!0)}setIndices(t,e){this._initGeometryData(),this._geometryData.indexStreamUpdated=!0,this._geometryData.indices=t,this._geometryData.indexCount=e||t.length}getPositions(t){return this.getVertexStream(Ys,t)}getNormals(t){return this.getVertexStream(Qs,t)}getUvs(t,e){return this.getVertexStream(sn+t,e)}getColors(t){return this.getVertexStream(en,t)}getIndices(t){let e=0;if(this._geometryData&&this._geometryData.indices){const s=this._geometryData.indices;if(e=this._geometryData.indexCount,ArrayBuffer.isView(t))t.set(s);else{t.length=0;for(let e=0,n=s.length;e<n;e++)t.push(s[e])}}else if(this.indexBuffer.length>0&&this.indexBuffer[0]){e=this.indexBuffer[0].readData(t)}return e}update(t=4,e=!0){if(this._geometryData){if(e){const t=this._geometryData.vertexStreamDictionary[Ys];t&&3===t.componentCount&&(this._aabb.compute(t.data,this._geometryData.vertexCount),this._aabbVer++)}let s=this._geometryData.recreate;this._geometryData.vertexCount>this._geometryData.maxVertices&&(s=!0,this._geometryData.maxVertices=this._geometryData.vertexCount),s&&this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null);let n=this._geometryData.recreate;this._geometryData.indexCount>this._geometryData.maxIndices&&(n=!0,this._geometryData.maxIndices=this._geometryData.indexCount),n&&this.indexBuffer.length>0&&this.indexBuffer[0]&&(this.indexBuffer[0].destroy(),this.indexBuffer[0]=null),this._geometryData.vertexStreamsUpdated&&this._updateVertexBuffer(),this._geometryData.indexStreamUpdated&&this._updateIndexBuffer(),this.primitive[0].type=t,this.indexBuffer.length>0&&this.indexBuffer[0]?this._geometryData.indexStreamUpdated&&(this.primitive[0].count=this._geometryData.indexCount,this.primitive[0].indexed=!0):this._geometryData.vertexStreamsUpdated&&(this.primitive[0].count=this._geometryData.vertexCount,this.primitive[0].indexed=!1),this._geometryData.vertexCount=0,this._geometryData.indexCount=0,this._geometryData.vertexStreamsUpdated=!1,this._geometryData.indexStreamUpdated=!1,this._geometryData.recreate=!1,this.updateRenderStates()}}_buildVertexFormat(t){const e=[];for(const t in this._geometryData.vertexStreamDictionary){const s=this._geometryData.vertexStreamDictionary[t];e.push({semantic:t,components:s.componentCount,type:s.dataType,normalize:s.dataTypeNormalize,asInt:s.asInt})}return new Ui(this.device,e,t)}_updateVertexBuffer(){if(!this.vertexBuffer){const t=this._geometryData.maxVertices,e=this._buildVertexFormat(t);this.vertexBuffer=new ki(this.device,e,t,{usage:this._geometryData.verticesUsage,storage:this._storageVertex})}const t=new Yo(this.vertexBuffer),e=this._geometryData.vertexCount;for(const s in this._geometryData.vertexStreamDictionary){const n=this._geometryData.vertexStreamDictionary[s];t.writeData(s,n.data,e),delete this._geometryData.vertexStreamDictionary[s]}t.end()}_updateIndexBuffer(){if(this.indexBuffer.length<=0||!this.indexBuffer[0]){const t=this._geometryData.maxVertices,e=t>65535||0===t?2:1,s=this._storageIndex?{storage:!0}:void 0;this.indexBuffer[0]=new Mo(this.device,e,this._geometryData.maxIndices,this._geometryData.indicesUsage,void 0,s)}const t=this._geometryData.indices;if(t){this.indexBuffer[0].writeData(t,this._geometryData.indexCount),this._geometryData.indices=null}}prepareRenderState(t){1===t?this.generateWireframe():2===t&&(this.primitive[2]={type:0,base:0,baseVertex:0,count:this.vertexBuffer?this.vertexBuffer.numVertices:0,indexed:!1})}updateRenderStates(){this.primitive[2]&&this.prepareRenderState(2),this.primitive[1]&&this.prepareRenderState(1)}generateWireframe(){this._destroyIndexBuffer(1);const t=this.vertexBuffer.numVertices;let e,s;if(this.indexBuffer.length>0&&this.indexBuffer[0]){const n=[[0,1],[1,2],[2,0]],i=this.primitive[0].base,r=this.primitive[0].count,a=this.primitive[0].baseVertex||0,o=this.indexBuffer[0],l=ti[o.format],h=new l(o.storage),c=new l(2*r),d=new Set;let u=0;for(let e=i;e<i+r;e+=3)for(let s=0;s<3;s++){const i=h[e+n[s][0]]+a,r=h[e+n[s][1]]+a,o=i>r?r*t+i:i*t+r;d.has(o)||(d.add(o),c[u++]=i,c[u++]=r)}d.clear(),s=o.format,e=c.slice(0,u)}else{const n=t-t%3,i=n/3*6;s=i>65535?2:1,e=i>65535?new Uint32Array(i):new Uint16Array(i);let r=0;for(let t=0;t<n;t+=3)e[r++]=t,e[r++]=t+1,e[r++]=t+1,e[r++]=t+2,e[r++]=t+2,e[r++]=t}const n=new Mo(this.vertexBuffer.device,s,e.length,0,e.buffer);this.primitive[1]={type:1,base:0,baseVertex:0,count:e.length,indexed:!0},this.indexBuffer[1]=n}}const ec=new di;function sc(t){return ec.get(t)}class nc{destroy(){this.cache.forEach((t,e)=>{e.destroy()}),this.cache.clear()}incRef(t){const e=(this.cache.get(t)||0)+1;this.cache.set(t,e)}decRef(t){if(t){let e=this.cache.get(t);e&&(e--,0===e?(this.cache.delete(t),t.destroy()):this.cache.set(t,e))}}constructor(){this.cache=new Map}}class ic{static{this.cache=new nc}static incRef(t){this.cache.incRef(t)}static decRef(t){this.cache.decRef(t)}static destroy(){this.cache.destroy()}}let rc=0;const ac=new Ss,oc=new Ss,lc=new Ts,hc=new Set,cc=new Uint32Array(4);class dc{constructor(t){this.vertexBuffer=null,this._destroyVertexBuffer=!1,this.count=t}destroy(){this._destroyVertexBuffer&&this.vertexBuffer?.destroy(),this.vertexBuffer=null}}class uc{getBindGroup(t){if(!this.bindGroup){const e=this.shader.meshBindGroupFormat;this.bindGroup=new Si(t,e)}return this.bindGroup}getUniformBuffer(t){if(!this.uniformBuffer){const e=this.shader.meshUniformBufferFormat;this.uniformBuffer=new Ua(t,e,!1)}return this.uniformBuffer}destroy(){this.bindGroup?.destroy(),this.bindGroup=null,this.uniformBuffer?.destroy(),this.uniformBuffer=null}constructor(){this.bindGroup=null,this.uniformBuffer=null}}class fc{constructor(t,e,s=null){if(this.castShadow=!1,this.shadowCascadeMask=255,this.cull=!0,this.drawOrder=0,this._drawBucket=127,this.visible=!0,this.visibleThisFrame=!1,this.flipFacesFactor=1,this.gsplatInstance=null,this.id=rc++,this.isVisibleFunc=null,this.instancingData=null,this.indirectData=null,this.drawCommands=null,this.meshMetaData=null,this.parameters={},this.pick=!0,this.stencilFront=null,this.stencilBack=null,this.transparent=!1,this._aabb=new Ss,this._aabbVer=-1,this._aabbMeshVer=-1,this._customAabb=null,this._updateAabb=!0,this._updateAabbFunc=null,this._sortKeyShadow=0,this._sortKeyForward=0,this._sortKeyDynamic=0,this._layer=15,this._material=null,this._skinInstance=null,this._morphInstance=null,this._receiveShadow=!0,this._renderStyle=0,this._screenSpace=!1,this._shaderCache=new Map,this._shaderDefs=65536,this._calculateSortDistance=null,this.node=s,this._mesh=t,t.incRefCount(),this.material=e,t.vertexBuffer){const e=t.vertexBuffer.format;this._shaderDefs|=e.hasUv0?4:0,this._shaderDefs|=e.hasUv1?8:0,this._shaderDefs|=e.hasColor?16:0,this._shaderDefs|=e.hasTangents?512:0}this.updateKey()}set drawBucket(t){this._drawBucket=255&Math.floor(t),this.updateKey()}get drawBucket(){return this._drawBucket}set renderStyle(t){this._renderStyle=t,this.mesh.prepareRenderState(t)}get renderStyle(){return this._renderStyle}set mesh(t){t!==this._mesh&&(this._mesh&&this._mesh.decRefCount(),this._mesh=t,t&&t.incRefCount())}get mesh(){return this._mesh}set aabb(t){this._aabb=t}get aabb(){if(!this._updateAabb)return this._aabb;if(this._updateAabbFunc)return this._updateAabbFunc(this._aabb);let t=this._customAabb,e=!!t;if(!t)if(t=ac,this.skinInstance){if(!this.mesh.boneAabb){const t=this._morphInstance?this._morphInstance.morph._targets:null;this.mesh._initBoneAabbs(t)}const s=this.mesh.boneUsed;let n=!0;for(let e=0;e<this.mesh.boneAabb.length;e++)s[e]&&(oc.setFromTransformedAabb(this.mesh.boneAabb[e],this.skinInstance.matrices[e]),n?(n=!1,t.center.copy(oc.center),t.halfExtents.copy(oc.halfExtents)):t.add(oc));e=!0}else if(this.node._aabbVer!==this._aabbVer||this.mesh._aabbVer!==this._aabbMeshVer){if(this.mesh?(t.center.copy(this.mesh.aabb.center),t.halfExtents.copy(this.mesh.aabb.halfExtents)):(t.center.set(0,0,0),t.halfExtents.set(0,0,0)),this.mesh&&this.mesh.morph){const e=this.mesh.morph.aabb;t._expand(e.getMin(),e.getMax())}e=!0,this._aabbVer=this.node._aabbVer,this._aabbMeshVer=this.mesh._aabbVer}return e&&this._aabb.setFromTransformedAabb(t,this.node.getWorldTransform()),this._aabb}clearShaders(){this._shaderCache.forEach(t=>{t.destroy()}),this._shaderCache.clear()}getShaderInstance(t,e,s,n,i,r,a){const o=this._shaderDefs;cc[0]=t,cc[1]=e,cc[2]=o,cc[3]=n.hash;const l=Fi(cc);let h=this._shaderCache.get(l);if(!h){const e=this._material;if(h=new uc,h.shader=e.variants.get(l),h.hashes=new Uint32Array(cc),!h.shader){const c=e.getShaderVariant({device:this.mesh.device,scene:s,objDefs:o,cameraShaderParams:n,pass:t,sortedLights:a,viewUniformFormat:i,viewBindGroupFormat:r,vertexFormat:this.mesh.vertexBuffer?.format});e.variants.set(l,c),h.shader=c}this._shaderCache.set(l,h)}return h}set material(t){this.clearShaders();const e=this._material;e&&e.removeMeshInstanceRef(this),this._material=t,t&&(t.addMeshInstanceRef(this),this.transparent=t.transparent,this.updateKey())}get material(){return this._material}_updateShaderDefs(t){t!==this._shaderDefs&&(this._shaderDefs=t,this.clearShaders())}set calculateSortDistance(t){this._calculateSortDistance=t}get calculateSortDistance(){return this._calculateSortDistance}set receiveShadow(t){this._receiveShadow!==t&&(this._receiveShadow=t,this._updateShaderDefs(t?-2&this._shaderDefs:1|this._shaderDefs))}get receiveShadow(){return this._receiveShadow}set batching(t){this._updateShaderDefs(t?this._shaderDefs|dh:-16385&this._shaderDefs)}get batching(){return 0!==(this._shaderDefs&dh)}set skinInstance(t){this._skinInstance=t,this._updateShaderDefs(t?2|this._shaderDefs:-3&this._shaderDefs),this._setupSkinUpdate()}get skinInstance(){return this._skinInstance}set morphInstance(t){this._morphInstance?.destroy(),this._morphInstance=t;let e=this._shaderDefs;e=t&&t.morph.morphPositions?e|lh:-1025&e,e=t&&t.morph.morphNormals?e|hh:-2049&e,e=t&&t.morph.intRenderFormat?e|ch:-8193&e,this._updateShaderDefs(e)}get morphInstance(){return this._morphInstance}set screenSpace(t){this._screenSpace!==t&&(this._screenSpace=t,this._updateShaderDefs(t?this._shaderDefs|oh:-257&this._shaderDefs))}get screenSpace(){return this._screenSpace}set key(t){this._sortKeyForward=t}get key(){return this._sortKeyForward}set mask(t){const e=65535&this._shaderDefs;this._updateShaderDefs(e|t<<16)}get mask(){return this._shaderDefs>>16}set instancingCount(t){this.instancingData&&(this.instancingData.count=t)}get instancingCount(){return this.instancingData?this.instancingData.count:0}destroy(){const t=this.mesh;t&&(this.mesh=null,t.refCount<1&&t.destroy()),this.setRealtimeLightmap(fc.lightmapParamNames[0],null),this.setRealtimeLightmap(fc.lightmapParamNames[1],null),this._skinInstance?.destroy(),this._skinInstance=null,this.morphInstance?.destroy(),this.morphInstance=null,this.clearShaders(),this.material=null,this.instancingData?.destroy(),this.destroyDrawCommands()}destroyDrawCommands(){if(this.drawCommands){for(const t of this.drawCommands.values())t?.destroy();this.drawCommands=null}}static{this.lightmapParamNames=["texture_lightMap","texture_dirLightMap"]}static _prepareRenderStyleForArray(t,e){if(t){for(let s=0;s<t.length;s++){t[s]._renderStyle=e;const n=t[s].mesh;hc.has(n)||(hc.add(n),n.prepareRenderState(e))}hc.clear()}}_isVisible(t){return!!this.visible&&(this.isVisibleFunc?this.isVisibleFunc(t):(lc.center=this.aabb.center,lc.radius=this._aabb.halfExtents.length(),t.frustum.containsSphere(lc)>0))}updateKey(){const{material:t}=this;this._sortKeyForward=this._drawBucket<<23|(t.alphaToCoverage||t.alphaTest?4194304:0)|4194303&t.id}setInstancing(t,e=!1){t?(this.instancingData=new dc(t.numVertices),this.instancingData.vertexBuffer=t,t.format.instancing=!0,this.cull=e):(this.instancingData=null,this.cull=!0),this._updateShaderDefs(t?32|this._shaderDefs:-33&this._shaderDefs)}setIndirect(t,e,s=1){const n=t?.camera??null;if(-1===e)this._deleteDrawCommandsKey(n);else{this.drawCommands??=new Map;const t=this.drawCommands.get(n)??new Io(this.mesh.device);t.slotIndex=e,t.update(s),this.drawCommands.set(n,t);this.mesh.device.mapsToClear.add(this.drawCommands)}}setMultiDraw(t,e=1){const s=t?.camera??null;let n;if(0===e)this._deleteDrawCommandsKey(s);else{if(this.drawCommands??=new Map,n=this.drawCommands.get(s),!n){const t=this.mesh.indexBuffer?.[0],e=t?.format,i=void 0!==e?Ds[e]:0;n=new Io(this.mesh.device,i),this.drawCommands.set(s,n)}n.allocate(e)}return n}_deleteDrawCommandsKey(t){const e=this.drawCommands;if(e){const s=e.get(t);s?.destroy(),e.delete(t),0===e.size&&this.destroyDrawCommands()}}getDrawCommands(t){const e=this.drawCommands;if(e)return e.get(t)??e.get(null)}getIndirectMetaData(){const t=this.mesh?.primitive[this.renderStyle],e=this.meshMetaData??(this.meshMetaData=new Int32Array(4));return e[0]=t.count,e[1]=t.base,e[2]=t.baseVertex,e}ensureMaterial(t){this.material||(this.material=sc(t))}clearParameters(){this.parameters={}}getParameters(){return this.parameters}getParameter(t){return this.parameters[t]}setParameter(t,e,s=4294967295){const n=this.parameters[t];n?(n.data=e,n.passFlags=s):this.parameters[t]={scopeId:null,data:e,passFlags:s}}setRealtimeLightmap(t,e){const s=this.getParameter(t);s!==e&&(s&&ic.decRef(s.data),e?(ic.incRef(e),this.setParameter(t,e)):this.deleteParameter(t))}deleteParameter(t){this.parameters[t]&&delete this.parameters[t]}setParameters(t,e){const s=this.parameters;for(const n in s){const i=s[n];i.passFlags&e&&(i.scopeId||(i.scopeId=t.scope.resolve(n)),i.scopeId.setValue(i.data))}}setLightmapped(t){t?this.mask=-6&this.mask|2:(this.setRealtimeLightmap(fc.lightmapParamNames[0],null),this.setRealtimeLightmap(fc.lightmapParamNames[1],null),this._shaderDefs&=-4289,this.mask=-7&this.mask|1)}setCustomAabb(t){t?this._customAabb?this._customAabb.copy(t):this._customAabb=t.clone():(this._customAabb=null,this._aabbVer=-1),this._setupSkinUpdate()}_setupSkinUpdate(){this._skinInstance&&(this._skinInstance._updateBeforeCull=!this._customAabb)}}const pc="uSceneColorMap";class mc extends Fo{destroy(){super.destroy(),this.releaseRenderTarget(this.colorRenderTarget)}shouldReallocate(t,e,s){const n=t?.colorBuffer.format;if(n!==s)return!0;const i=e?.width||this.device.width,r=e?.height||this.device.height;return!t||i!==t.width||r!==t.height}allocateRenderTarget(t,e,s,n){const i=new pi(s,{name:pc,format:n,width:e?e.colorBuffer.width:s.width,height:e?e.colorBuffer.height:s.height,mipmaps:!0,minFilter:5,magFilter:1,addressU:1,addressV:1});return t?(t.destroyFrameBuffers(),t._colorBuffer=i,t._colorBuffers=[i],t.evaluateDimensions()):t=new ji({name:"ColorGrabRT",colorBuffer:i,depth:!1,stencil:!1,autoResolve:!1}),t}releaseRenderTarget(t){t&&(t.destroyTextureBuffers(),t.destroy())}frameUpdate(){const t=this.device,e=this.source,s=e?.colorBuffer.format??this.device.backBufferFormat;this.shouldReallocate(this.colorRenderTarget,e?.colorBuffer,s)&&(this.releaseRenderTarget(this.colorRenderTarget),this.colorRenderTarget=this.allocateRenderTarget(this.colorRenderTarget,e,t,s));const n=this.colorRenderTarget.colorBuffer;t.scope.resolve(pc).setValue(n)}execute(){const t=this.device,e=this.source,s=this.colorRenderTarget.colorBuffer;t.isWebGPU?(t.copyRenderTarget(e,this.colorRenderTarget,!0,!1),t.mipmapRenderer.generate(this.colorRenderTarget.colorBuffer.impl)):(t.copyRenderTarget(e,this.colorRenderTarget,!0,!1),t.activeTexture(t.maxCombinedTextures-1),t.bindTexture(s),t.gl.generateMipmap(s.impl._glTarget))}constructor(...t){super(...t),this.colorRenderTarget=null,this.source=null}}const gc="uSceneDepthMap";class _c extends Fo{constructor(t,e){super(t),this.depthRenderTarget=null,this.camera=null,this.camera=e}destroy(){super.destroy(),this.releaseRenderTarget(this.depthRenderTarget)}shouldReallocate(t,e){const s=e?.width||this.device.width,n=e?.height||this.device.height;return!t||s!==t.width||n!==t.height}allocateRenderTarget(t,e,s,n,i){const r=new pi(s,{name:gc,format:n,width:e?e.colorBuffer.width:s.width,height:e?e.colorBuffer.height:s.height,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1});return t?(t.destroyFrameBuffers(),i?t._depthBuffer=r:(t._colorBuffer=r,t._colorBuffers=[r]),t.evaluateDimensions()):t=new ji({name:"DepthGrabRT",colorBuffer:i?null:r,depthBuffer:i?r:null,depth:!i,stencil:s.supportsStencil,autoResolve:!1}),t}releaseRenderTarget(t){t&&(t.destroyTextureBuffers(),t.destroy())}before(){const t=this.camera,e=this.device,s=t?.renderTarget??e.backBuffer;let n=!0,i=s.stencil?ks:Ms;if(e.isWebGPU){s.samples>1&&(i=Rs,n=!1)}const r=t.renderTarget?.depthBuffer??t.renderTarget?.colorBuffer;this.shouldReallocate(this.depthRenderTarget,r)&&(this.releaseRenderTarget(this.depthRenderTarget),this.depthRenderTarget=this.allocateRenderTarget(this.depthRenderTarget,t.renderTarget,e,i,n));const a=n?this.depthRenderTarget.depthBuffer:this.depthRenderTarget.colorBuffer;e.scope.resolve(gc).setValue(a)}execute(){const t=this.device;if(t.isWebGL2&&t.renderTarget.samples>1){const e=t.renderTarget.impl._glFrameBuffer,s=this.depthRenderTarget;t.renderTarget=s,t.updateBegin(),this.depthRenderTarget.impl.internalResolve(t,e,s.impl._glFrameBuffer,this.depthRenderTarget,t.gl.DEPTH_BUFFER_BIT)}else t.copyRenderTarget(t.renderTarget,this.depthRenderTarget,!1,!0)}}class vc{get hash(){if(void 0===this._hash){const t=`${this.gammaCorrection}_${this.toneMapping}_${this.srgbRenderTarget}_${this.fog}_${this.ssaoEnabled}_${this.sceneDepthMapLinear}`;this._hash=Oi(t)}return this._hash}get defines(){const t=this._defines;return this._definesDirty&&(this._definesDirty=!1,t.clear(),this._sceneDepthMapLinear&&t.set("SCENE_DEPTHMAP_LINEAR",""),1===this.shaderOutputGamma&&t.set("SCENE_COLORMAP_GAMMA",""),t.set("FOG",this._fog.toUpperCase()),t.set("TONEMAP",$l[this._toneMapping]),t.set("GAMMA",jl[this.shaderOutputGamma])),t}markDirty(){this._hash=void 0,this._definesDirty=!0}set fog(t){this._fog!==t&&(this._fog=t,this.markDirty())}get fog(){return this._fog}set ssaoEnabled(t){this._ssaoEnabled!==t&&(this._ssaoEnabled=t,this.markDirty())}get ssaoEnabled(){return this._ssaoEnabled}set gammaCorrection(t){this._gammaCorrectionAssigned=!0,this._gammaCorrection!==t&&(this._gammaCorrection=t,this.markDirty())}get gammaCorrection(){return this._gammaCorrection}set toneMapping(t){this._toneMapping!==t&&(this._toneMapping=t,this.markDirty())}get toneMapping(){return this._toneMapping}set srgbRenderTarget(t){this._srgbRenderTarget!==t&&(this._srgbRenderTarget=t,this.markDirty())}get srgbRenderTarget(){return this._srgbRenderTarget}set sceneDepthMapLinear(t){this._sceneDepthMapLinear!==t&&(this._sceneDepthMapLinear=t,this.markDirty())}get sceneDepthMapLinear(){return this._sceneDepthMapLinear}get shaderOutputGamma(){return 1===this._gammaCorrection&&!this._srgbRenderTarget?1:0}constructor(){this._gammaCorrection=1,this._toneMapping=0,this._srgbRenderTarget=!1,this._ssaoEnabled=!1,this._fog=xl,this._sceneDepthMapLinear=!1,this._defines=new Map,this._definesDirty=!0}}const yc=new rs,bc=new rs,Sc=new rs,xc=new ps,wc=[new rs,new rs,new rs,new rs,new rs,new rs,new rs,new rs];class Tc{constructor(){this.shaderPassInfo=null,this.renderPassColorGrab=null,this.renderPassDepthGrab=null,this.fogParams=null,this.shaderParams=new vc,this.renderPasses=[],this.jitter=0,this._aspectRatio=16/9,this._aspectRatioMode=0,this._calculateProjection=null,this._calculateTransform=null,this._clearColor=new Ze(.75,.75,.75,1),this._clearColorBuffer=!0,this._clearDepth=1,this._clearDepthBuffer=!0,this._clearStencil=0,this._clearStencilBuffer=!0,this._cullFaces=!0,this._farClip=1e3,this._flipFaces=!1,this._fov=45,this._frustumCulling=!0,this._horizontalFov=!1,this._layers=[0,1,2,4,3],this._layersSet=new Set(this._layers),this._nearClip=.1,this._node=null,this._orthoHeight=10,this._projection=0,this._rect=new ls(0,0,1,1),this._renderTarget=null,this._scissorRect=new ls(0,0,1,1),this._scissorRectClear=!1,this._aperture=16,this._shutter=.001,this._sensitivity=1e3,this._projMat=new ps,this._projMatDirty=!0,this._projMatSkybox=new ps,this._viewMat=new ps,this._viewMatDirty=!0,this._viewProjMat=new ps,this._viewProjMatDirty=!0,this._shaderMatricesVersion=0,this._viewProjInverse=new ps,this._viewProjCurrent=null,this._viewProjPrevious=new ps,this._jitters=[0,0,0,0],this.frustum=new Es,this._xr=null,this._xrProperties={horizontalFov:this._horizontalFov,fov:this._fov,aspectRatio:this._aspectRatio,farClip:this._farClip,nearClip:this._nearClip}}destroy(){this.renderPassColorGrab?.destroy(),this.renderPassColorGrab=null,this.renderPassDepthGrab?.destroy(),this.renderPassDepthGrab=null,this.renderPasses.length=0}_storeShaderMatrices(t,e,s,n){this._shaderMatricesVersion!==n&&(this._shaderMatricesVersion=n,this._viewProjPrevious.copy(this._viewProjCurrent??t),this._viewProjCurrent??=new ps,this._viewProjCurrent.copy(t),this._viewProjInverse.invert(t),this._jitters[2]=this._jitters[0],this._jitters[3]=this._jitters[1],this._jitters[0]=e,this._jitters[1]=s)}get fullSizeClearRect(){const t=this._scissorRectClear?this.scissorRect:this._rect;return 0===t.x&&0===t.y&&1===t.z&&1===t.w}set aspectRatio(t){this._aspectRatio!==t&&(this._aspectRatio=t,this._projMatDirty=!0)}get aspectRatio(){return this.xr?.active?this._xrProperties.aspectRatio:this._aspectRatio}set aspectRatioMode(t){this._aspectRatioMode!==t&&(this._aspectRatioMode=t,this._projMatDirty=!0)}get aspectRatioMode(){return this._aspectRatioMode}set calculateProjection(t){this._calculateProjection=t,this._projMatDirty=!0}get calculateProjection(){return this._calculateProjection}set calculateTransform(t){this._calculateTransform=t}get calculateTransform(){return this._calculateTransform}set clearColor(t){this._clearColor.copy(t)}get clearColor(){return this._clearColor}set clearColorBuffer(t){this._clearColorBuffer=t}get clearColorBuffer(){return this._clearColorBuffer}set clearDepth(t){this._clearDepth=t}get clearDepth(){return this._clearDepth}set clearDepthBuffer(t){this._clearDepthBuffer=t}get clearDepthBuffer(){return this._clearDepthBuffer}set clearStencil(t){this._clearStencil=t}get clearStencil(){return this._clearStencil}set clearStencilBuffer(t){this._clearStencilBuffer=t}get clearStencilBuffer(){return this._clearStencilBuffer}set cullFaces(t){this._cullFaces=t}get cullFaces(){return this._cullFaces}set farClip(t){this._farClip!==t&&(this._farClip=t,this._projMatDirty=!0)}get farClip(){return this.xr?.active?this._xrProperties.farClip:this._farClip}set flipFaces(t){this._flipFaces=t}get flipFaces(){return this._flipFaces}set fov(t){this._fov!==t&&(this._fov=t,this._projMatDirty=!0)}get fov(){return this.xr?.active?this._xrProperties.fov:this._fov}set frustumCulling(t){this._frustumCulling=t}get frustumCulling(){return this._frustumCulling}set horizontalFov(t){this._horizontalFov!==t&&(this._horizontalFov=t,this._projMatDirty=!0)}get horizontalFov(){return this.xr?.active?this._xrProperties.horizontalFov:this._horizontalFov}set layers(t){this._layers=t.slice(0),this._layersSet=new Set(this._layers)}get layers(){return this._layers}get layersSet(){return this._layersSet}set nearClip(t){this._nearClip!==t&&(this._nearClip=t,this._projMatDirty=!0)}get nearClip(){return this.xr?.active?this._xrProperties.nearClip:this._nearClip}set node(t){this._node=t}get node(){return this._node}set orthoHeight(t){this._orthoHeight!==t&&(this._orthoHeight=t,this._projMatDirty=!0)}get orthoHeight(){return this._orthoHeight}set projection(t){this._projection!==t&&(this._projection=t,this._projMatDirty=!0)}get projection(){return this._projection}get projectionMatrix(){return this._evaluateProjectionMatrix(),this._projMat}set rect(t){this._rect.copy(t)}get rect(){return this._rect}set renderTarget(t){this._renderTarget=t}get renderTarget(){return this._renderTarget}set scissorRect(t){this._scissorRect.copy(t)}get scissorRect(){return this._scissorRect}get viewMatrix(){if(this._viewMatDirty){const t=this._node.getWorldTransform();this._viewMat.copy(t).invert(),this._viewMatDirty=!1}return this._viewMat}set aperture(t){this._aperture=t}get aperture(){return this._aperture}set sensitivity(t){this._sensitivity=t}get sensitivity(){return this._sensitivity}set shutter(t){this._shutter=t}get shutter(){return this._shutter}set xr(t){this._xr!==t&&(this._xr=t,this._projMatDirty=!0)}get xr(){return this._xr}clone(){return(new Tc).copy(this)}copy(t){return this._aspectRatio=t._aspectRatio,this._farClip=t._farClip,this._fov=t._fov,this._horizontalFov=t._horizontalFov,this._nearClip=t._nearClip,this._xrProperties.aspectRatio=t._xrProperties.aspectRatio,this._xrProperties.farClip=t._xrProperties.farClip,this._xrProperties.fov=t._xrProperties.fov,this._xrProperties.horizontalFov=t._xrProperties.horizontalFov,this._xrProperties.nearClip=t._xrProperties.nearClip,this.aspectRatioMode=t.aspectRatioMode,this.calculateProjection=t.calculateProjection,this.calculateTransform=t.calculateTransform,this.clearColor=t.clearColor,this.clearColorBuffer=t.clearColorBuffer,this.clearDepth=t.clearDepth,this.clearDepthBuffer=t.clearDepthBuffer,this.clearStencil=t.clearStencil,this.clearStencilBuffer=t.clearStencilBuffer,this.cullFaces=t.cullFaces,this.flipFaces=t.flipFaces,this.frustumCulling=t.frustumCulling,this.layers=t.layers,this.orthoHeight=t.orthoHeight,this.projection=t.projection,this.rect=t.rect,this.renderTarget=t.renderTarget,this.scissorRect=t.scissorRect,this.aperture=t.aperture,this.shutter=t.shutter,this.sensitivity=t.sensitivity,this.shaderPassInfo=t.shaderPassInfo,this.jitter=t.jitter,this._projMatDirty=!0,this}_enableRenderPassColorGrab(t,e){e?this.renderPassColorGrab||(this.renderPassColorGrab=new mc(t)):(this.renderPassColorGrab?.destroy(),this.renderPassColorGrab=null)}_enableRenderPassDepthGrab(t,e,s){s?this.renderPassDepthGrab||(this.renderPassDepthGrab=new _c(t,this)):(this.renderPassDepthGrab?.destroy(),this.renderPassDepthGrab=null)}_updateViewProjMat(){(this._projMatDirty||this._viewMatDirty||this._viewProjMatDirty)&&(this._viewProjMat.mul2(this.projectionMatrix,this.viewMatrix),this._viewProjMatDirty=!1)}worldToScreen(t,e,s,n=new rs){this._updateViewProjMat(),this._viewProjMat.transformPoint(t,n);const i=this._viewProjMat.data,r=t.x*i[3]+t.y*i[7]+t.z*i[11]+1*i[15];n.x=.5*(n.x/r+1),n.y=.5*(1-n.y/r);const{x:a,y:o,z:l,w:h}=this._rect;return n.x=n.x*l*e+a*e,n.y=n.y*h*s+(1-o-h)*s,n}screenToWorld(t,e,s,n,i,r=new rs){const{x:a,y:o,z:l,w:h}=this._rect,c=this.farClip-this.nearClip;if(yc.set((t-a*n)/(l*n),1-(e-(1-o-h)*i)/(h*i),s/c),yc.mulScalar(2),yc.sub(rs.ONE),0===this._projection){ps._getPerspectiveHalfSize(bc,this.fov,this.aspectRatio,this.nearClip,this.horizontalFov),bc.x*=yc.x,bc.y*=yc.y;const t=this._node.getWorldTransform();bc.z=-this.nearClip,t.transformPoint(bc,Sc);const e=this._node.getPosition();r.sub2(Sc,e),r.normalize(),r.mulScalar(s),r.add(e)}else this._updateViewProjMat(),xc.copy(this._viewProjMat).invert(),xc.transformPoint(yc,r);return r}_evaluateProjectionMatrix(){if(this._projMatDirty){if(0===this._projection)this._projMat.setPerspective(this.fov,this.aspectRatio,this.nearClip,this.farClip,this.horizontalFov),this._projMatSkybox.copy(this._projMat);else{const t=this._orthoHeight,e=t*this.aspectRatio;this._projMat.setOrtho(-e,e,-t,t,this.nearClip,this.farClip),this._projMatSkybox.setPerspective(this.fov,this.aspectRatio,this.nearClip,this.farClip)}this._projMatDirty=!1}}getProjectionMatrixSkybox(){return this._evaluateProjectionMatrix(),this._projMatSkybox}getExposure(){const t=Math.log2(this._aperture*this._aperture/this._shutter*100/this._sensitivity);return 1/(1.2*Math.pow(2,t))}getScreenSize(t){if(0===this._projection){const e=this._node.getPosition().distance(t.center);if(e<t.radius)return 1;const s=Math.asin(t.radius/e),n=Math.tan(s),i=Math.tan(this.fov/2*Qe.DEG_TO_RAD);return Math.min(n/i,1)}return Qe.clamp(t.radius/this._orthoHeight,0,1)}getFrustumCorners(t=this.nearClip,e=this.farClip){const s=this.fov*Qe.DEG_TO_RAD;let n,i;0===this.projection?this.horizontalFov?(n=t*Math.tan(s/2),i=n/this.aspectRatio):(i=t*Math.tan(s/2),n=i*this.aspectRatio):(i=this._orthoHeight,n=i*this.aspectRatio);const r=wc;return r[0].x=n,r[0].y=-i,r[0].z=-t,r[1].x=n,r[1].y=i,r[1].z=-t,r[2].x=-n,r[2].y=i,r[2].z=-t,r[3].x=-n,r[3].y=-i,r[3].z=-t,0===this._projection&&(this.horizontalFov?(n=e*Math.tan(s/2),i=n/this.aspectRatio):(i=e*Math.tan(s/2),n=i*this.aspectRatio)),r[4].x=n,r[4].y=-i,r[4].z=-e,r[5].x=n,r[5].y=i,r[5].z=-e,r[6].x=-n,r[6].y=i,r[6].z=-e,r[7].x=-n,r[7].y=-i,r[7].z=-e,r}setXrProperties(t){Object.assign(this._xrProperties,t),this._projMatDirty=!0}}const Cc=new ps,Ec=new rs,Ac=new ms,Dc=new ms,Pc=new rs,Lc=new rs,Ic=new ps,Rc=new ms,Mc=new rs,kc=new ps,Oc=new ms,Fc=new ms,Nc=new ps,Bc=new rs,zc=new rs;function Uc(t,e){return t instanceof Function?t:s=>{let n=s[t];return n instanceof Function&&(n=n()),n===e}}function Vc(t,e){if(e(t))return t;const s=t._children,n=s.length;for(let t=0;t<n;++t){const n=Vc(s[t],e);if(n)return n}return null}class Hc extends Ve{constructor(t="Untitled"){super(),this.tags=new $e(this),this.localPosition=new rs,this.localRotation=new ms,this.localScale=new rs(1,1,1),this.localEulerAngles=new rs,this.position=new rs,this.rotation=new ms,this.eulerAngles=new rs,this._scale=null,this.localTransform=new ps,this._dirtyLocal=!1,this._aabbVer=0,this._frozen=!1,this.worldTransform=new ps,this._dirtyWorld=!1,this._worldScaleSign=0,this._normalMatrix=new as,this._dirtyNormal=!0,this._right=null,this._up=null,this._forward=null,this._parent=null,this._children=[],this._graphDepth=0,this._enabled=!0,this._enabledInHierarchy=!1,this.scaleCompensation=!1,this.name=t}get right(){return this._right||(this._right=new rs),this.getWorldTransform().getX(this._right).normalize()}get up(){return this._up||(this._up=new rs),this.getWorldTransform().getY(this._up).normalize()}get forward(){return this._forward||(this._forward=new rs),this.getWorldTransform().getZ(this._forward).normalize().mulScalar(-1)}get normalMatrix(){const t=this._normalMatrix;return this._dirtyNormal&&(t.invertMat4(this.getWorldTransform()).transpose(),this._dirtyNormal=!1),t}set enabled(t){this._enabled!==t&&(this._enabled=t,(t&&this._parent?.enabled||!t)&&this._notifyHierarchyStateChanged(this,t))}get enabled(){return this._enabled&&this._enabledInHierarchy}get parent(){return this._parent}get path(){let t=this._parent;if(!t)return"";let e=this.name;for(;t&&t._parent;)e=`${t.name}/${e}`,t=t._parent;return e}get root(){let t=this;for(;t._parent;)t=t._parent;return t}get children(){return this._children}get graphDepth(){return this._graphDepth}_notifyHierarchyStateChanged(t,e){t._onHierarchyStateChanged(e);const s=t._children;for(let t=0,n=s.length;t<n;t++)s[t]._enabled&&this._notifyHierarchyStateChanged(s[t],e)}_onHierarchyStateChanged(t){this._enabledInHierarchy=t,t&&!this._frozen&&this._unfreezeParentToRoot()}_cloneInternal(t){t.name=this.name;const e=this.tags._list;t.tags.clear();for(let s=0;s<e.length;s++)t.tags.add(e[s]);t.localPosition.copy(this.localPosition),t.localRotation.copy(this.localRotation),t.localScale.copy(this.localScale),t.localEulerAngles.copy(this.localEulerAngles),t.position.copy(this.position),t.rotation.copy(this.rotation),t.eulerAngles.copy(this.eulerAngles),t.localTransform.copy(this.localTransform),t._dirtyLocal=this._dirtyLocal,t.worldTransform.copy(this.worldTransform),t._dirtyWorld=this._dirtyWorld,t._dirtyNormal=this._dirtyNormal,t._aabbVer=this._aabbVer+1,t._enabled=this._enabled,t.scaleCompensation=this.scaleCompensation,t._enabledInHierarchy=!1}clone(){const t=new this.constructor;return this._cloneInternal(t),t}copy(t){return t._cloneInternal(this),this}destroy(){this.remove();const t=this._children;for(;t.length;){const e=t.pop();e._parent=null,e.destroy()}this.fire("destroy",this),this.off()}find(t,e){const s=[],n=Uc(t,e);return this.forEach(t=>{n(t)&&s.push(t)}),s}findOne(t,e){return Vc(this,Uc(t,e))}findByTag(...t){const e=[],s=(n,i)=>{i&&n.tags.has(...t)&&e.push(n);for(let t=0;t<n._children.length;t++)s(n._children[t],!0)};return s(this,!1),e}findByName(t){return this.findOne("name",t)}findByPath(t){const e=Array.isArray(t)?t:t.split("/");let s=this;for(let t=0,n=e.length;t<n;++t)if(s=s.children.find(s=>s.name===e[t]),!s)return null;return s}forEach(t,e){t.call(e,this);const s=this._children,n=s.length;for(let i=0;i<n;++i)s[i].forEach(t,e)}isDescendantOf(t){let e=this._parent;for(;e;){if(e===t)return!0;e=e._parent}return!1}isAncestorOf(t){return t.isDescendantOf(this)}getEulerAngles(){return this.getWorldTransform().getEulerAngles(this.eulerAngles),this.eulerAngles}getLocalEulerAngles(){return this.localRotation.getEulerAngles(this.localEulerAngles),this.localEulerAngles}getLocalPosition(){return this.localPosition}getLocalRotation(){return this.localRotation}getLocalScale(){return this.localScale}getLocalTransform(){return this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1),this.localTransform}getPosition(){return this.getWorldTransform().getTranslation(this.position),this.position}getRotation(){return this.rotation.setFromMat4(this.getWorldTransform()),this.rotation}getScale(){return this._scale||(this._scale=new rs),this.getWorldTransform().getScale(this._scale)}getWorldTransform(){return this._dirtyLocal||this._dirtyWorld?(this._parent&&this._parent.getWorldTransform(),this._sync(),this.worldTransform):this.worldTransform}get worldScaleSign(){return 0===this._worldScaleSign&&(this._worldScaleSign=this.getWorldTransform().scaleSign),this._worldScaleSign}remove(){this._parent?.removeChild(this)}reparent(t,e){this.remove(),t&&(e>=0?t.insertChild(this,e):t.addChild(this))}setLocalEulerAngles(t,e,s){this.localRotation.setFromEulerAngles(t,e,s),this._dirtyLocal||this._dirtifyLocal()}setLocalPosition(t,e,s){t instanceof rs?this.localPosition.copy(t):this.localPosition.set(t,e,s),this._dirtyLocal||this._dirtifyLocal()}setLocalRotation(t,e,s,n){t instanceof ms?this.localRotation.copy(t):this.localRotation.set(t,e,s,n),this._dirtyLocal||this._dirtifyLocal()}setLocalScale(t,e,s){t instanceof rs?this.localScale.copy(t):this.localScale.set(t,e,s),this._dirtyLocal||this._dirtifyLocal()}_dirtifyLocal(){this._dirtyLocal||(this._dirtyLocal=!0,this._dirtyWorld||this._dirtifyWorld())}_unfreezeParentToRoot(){let t=this._parent;for(;t;)t._frozen=!1,t=t._parent}_dirtifyWorld(){this._dirtyWorld||this._unfreezeParentToRoot(),this._dirtifyWorldInternal()}_dirtifyWorldInternal(){if(!this._dirtyWorld){this._frozen=!1,this._dirtyWorld=!0;for(let t=0;t<this._children.length;t++)this._children[t]._dirtyWorld||this._children[t]._dirtifyWorldInternal()}this._dirtyNormal=!0,this._worldScaleSign=0,this._aabbVer++}setPosition(t,e,s){t instanceof rs?Mc.copy(t):Mc.set(t,e,s),null===this._parent?this.localPosition.copy(Mc):(kc.copy(this._parent.getWorldTransform()).invert(),kc.transformPoint(Mc,this.localPosition)),this._dirtyLocal||this._dirtifyLocal()}setRotation(t,e,s,n){if(t instanceof ms?Oc.copy(t):Oc.set(t,e,s,n),null===this._parent)this.localRotation.copy(Oc);else{const t=this._parent.getRotation();Fc.copy(t).invert(),this.localRotation.copy(Fc).mul(Oc)}this._dirtyLocal||this._dirtifyLocal()}setPositionAndRotation(t,e){if(null===this._parent)this.localPosition.copy(t),this.localRotation.copy(e);else{const s=this._parent.getWorldTransform();kc.copy(s).invert(),kc.transformPoint(t,this.localPosition),this.localRotation.setFromMat4(kc).mul(e)}this._dirtyLocal||this._dirtifyLocal()}setEulerAngles(t,e,s){if(this.localRotation.setFromEulerAngles(t,e,s),null!==this._parent){const t=this._parent.getRotation();Fc.copy(t).invert(),this.localRotation.mul2(Fc,this.localRotation)}this._dirtyLocal||this._dirtifyLocal()}addChild(t){this._prepareInsertChild(t),this._children.push(t),this._onInsertChild(t)}addChildAndSaveTransform(t){const e=t.getPosition(),s=t.getRotation();this._prepareInsertChild(t),t.setPosition(Ic.copy(this.worldTransform).invert().transformPoint(e)),t.setRotation(Rc.copy(this.getRotation()).invert().mul(s)),this._children.push(t),this._onInsertChild(t)}insertChild(t,e){this._prepareInsertChild(t),this._children.splice(e,0,t),this._onInsertChild(t)}_prepareInsertChild(t){t.remove()}_fireOnHierarchy(t,e,s){this.fire(t,s);for(let t=0;t<this._children.length;t++)this._children[t]._fireOnHierarchy(e,e,s)}_onInsertChild(t){t._parent=this;const e=t._enabled&&this.enabled;t._enabledInHierarchy!==e&&(t._enabledInHierarchy=e,t._notifyHierarchyStateChanged(t,e)),t._updateGraphDepth(),t._dirtifyWorld(),this._frozen&&t._unfreezeParentToRoot(),t._fireOnHierarchy("insert","inserthierarchy",this),this.fire&&this.fire("childinsert",t)}_updateGraphDepth(){this._graphDepth=this._parent?this._parent._graphDepth+1:0;for(let t=0,e=this._children.length;t<e;t++)this._children[t]._updateGraphDepth()}removeChild(t){const e=this._children.indexOf(t);-1!==e&&(this._children.splice(e,1),t._parent=null,t._fireOnHierarchy("remove","removehierarchy",this),this.fire("childremove",t))}_sync(){if(this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1),this._dirtyWorld){if(null===this._parent)this.worldTransform.copy(this.localTransform);else if(this.scaleCompensation){let t;const e=this._parent;let s=this.localScale,n=e;if(n){for(;n&&n.scaleCompensation;)n=n._parent;n&&(n=n._parent,n&&(t=n.worldTransform.getScale(),Pc.mul2(t,this.localScale),s=Pc))}Dc.setFromMat4(e.worldTransform),Ac.mul2(Dc,this.localRotation);let i=e.worldTransform;e.scaleCompensation&&(Lc.mul2(t,e.getLocalScale()),Cc.setTRS(e.worldTransform.getTranslation(Ec),Dc,Lc),i=Cc),i.transformPoint(this.localPosition,Ec),this.worldTransform.setTRS(Ec,Ac,s)}else this.worldTransform.mulAffine2(this._parent.worldTransform,this.localTransform);this._dirtyWorld=!1}}syncHierarchy(){if(!this._enabled)return;if(this._frozen)return;this._frozen=!0,(this._dirtyLocal||this._dirtyWorld)&&this._sync();const t=this._children;for(let e=0,s=t.length;e<s;e++)t[e].syncHierarchy()}lookAt(t,e,s,n=0,i=1,r=0){if(t instanceof rs)Bc.copy(t),e instanceof rs?zc.copy(e):zc.copy(rs.UP);else{if(void 0===s)return;Bc.set(t,e,s),zc.set(n,i,r)}Nc.setLookAt(this.getPosition(),Bc,zc),Oc.setFromMat4(Nc),this.setRotation(Oc)}translate(t,e,s){t instanceof rs?Mc.copy(t):Mc.set(t,e,s),Mc.add(this.getPosition()),this.setPosition(Mc)}translateLocal(t,e,s){t instanceof rs?Mc.copy(t):Mc.set(t,e,s),this.localRotation.transformVector(Mc,Mc),this.localPosition.add(Mc),this._dirtyLocal||this._dirtifyLocal()}rotate(t,e,s){if(Oc.setFromEulerAngles(t,e,s),null===this._parent)this.localRotation.mul2(Oc,this.localRotation);else{const t=this.getRotation(),e=this._parent.getRotation();Fc.copy(e).invert(),Oc.mul2(Fc,Oc),this.localRotation.mul2(Oc,t)}this._dirtyLocal||this._dirtifyLocal()}rotateLocal(t,e,s){Oc.setFromEulerAngles(t,e,s),this.localRotation.mul(Oc),this._dirtyLocal||this._dirtifyLocal()}}const Gc=new ps,Wc=new ps,jc=new ps;class $c{static{this.pointLightRotations=[(new ms).setFromEulerAngles(0,90,180),(new ms).setFromEulerAngles(0,-90,180),(new ms).setFromEulerAngles(90,0,0),(new ms).setFromEulerAngles(-90,0,0),(new ms).setFromEulerAngles(0,180,180),(new ms).setFromEulerAngles(0,0,180)]}static create(t,e,s){const n=new Tc;switch(n.node=new Hc(t),n.aspectRatio=1,n.aspectRatioMode=1,n._scissorRectClear=!0,e){case 1:n.node.setRotation($c.pointLightRotations[s]),n.fov=90,n.projection=0;break;case 2:n.projection=0;break;case 0:n.projection=1}return n}static{this._spotCookieCamera=null}static evalSpotCookieMatrix(t){let e=$c._spotCookieCamera;e||(e=$c.create("SpotCookieCamera",2),$c._spotCookieCamera=e),e.fov=2*t._outerConeAngle;const s=e._node;s.setPosition(t._node.getPosition()),s.setRotation(t._node.getRotation()),s.rotateLocal(-90,0,0),Gc.setTRS(s.getPosition(),s.getRotation(),rs.ONE).invert(),Wc.mul2(e.projectionMatrix,Gc);const n=t.cookieMatrix,i=t.atlasViewport;return jc.setViewport(i.x,i.y,i.z,i.w),n.mul2(jc,Wc),n}}const Xc=new rs,qc=new Float32Array(6),Kc=new rs(-.5,0,0),Yc=new rs(0,0,.5),Qc={POSITION_RANGE:0,DIRECTION_FLAGS:1,COLOR_ANGLES_BIAS:2,PROJ_MAT_0:3,ATLAS_VIEWPORT:3,PROJ_MAT_1:4,PROJ_MAT_2:5,PROJ_MAT_3:6,AREA_DATA_WIDTH:7,AREA_DATA_HEIGHT:8,COUNT:9},Zc={LIGHTSHAPE_PUNCTUAL:"0u",LIGHTSHAPE_RECT:"1u",LIGHTSHAPE_DISK:"2u",LIGHTSHAPE_SPHERE:"3u",LIGHT_COLOR_DIVIDER:"100.0"},Jc=(t,e)=>Object.keys(t).map(s=>`#define {${e}${s}} ${t[s]}`).join("\n"),td=`\n\n\t\t${Jc(Qc,"CLUSTER_TEXTURE_")}\n\t\t${Jc(Zc,"")}\n`;class ed{constructor(t){this.areaLightsEnabled=!1,this.device=t,Fh.get(t,In).set("lightBufferDefinesPS",td),Fh.get(t,Rn).set("lightBufferDefinesPS",td),this.cookiesEnabled=!1,this.shadowsEnabled=!1,this.areaLightsEnabled=!1,this.maxLights=255;const e=Qc.COUNT;this.lightsFloat=new Float32Array(4*e*this.maxLights),this.lightsUint=new Uint32Array(this.lightsFloat.buffer),this.lightsTexture=this.createTexture(this.device,e,this.maxLights,Is,"LightsTexture"),this._lightsTextureId=this.device.scope.resolve("lightsTexture"),this.invMaxColorValue=0,this.invMaxAttenuation=0,this.boundsMin=new rs,this.boundsDelta=new rs}destroy(){this.lightsTexture?.destroy(),this.lightsTexture=null}createTexture(t,e,s,n,i){return new pi(t,{name:i,width:e,height:s,mipmaps:!1,format:n,addressU:1,addressV:1,type:yn,magFilter:0,minFilter:0,anisotropy:1})}setBounds(t,e){this.boundsMin.copy(t),this.boundsDelta.copy(e)}uploadTextures(){this.lightsTexture.lock().set(this.lightsFloat),this.lightsTexture.unlock()}updateUniforms(){this._lightsTextureId.setValue(this.lightsTexture)}getSpotDirection(t,e){e._node.getWorldTransform().getY(t).mulScalar(-1),t.normalize()}getLightAreaSizes(t){const e=t._node.getWorldTransform();return e.transformVector(Kc,Xc),qc[0]=Xc.x,qc[1]=Xc.y,qc[2]=Xc.z,e.transformVector(Yc,Xc),qc[3]=Xc.x,qc[4]=Xc.y,qc[5]=Xc.z,qc}addLightData(t,e){const s=2===t._type,n=t.atlasViewportAllocated,i=this.cookiesEnabled&&!!t._cookie&&n,r=this.areaLightsEnabled&&0!==t.shape,a=this.shadowsEnabled&&t.castShadows&&n,o=t._node.getPosition();let l=null,h=null;if(s)if(a){l=t.getRenderData(null,0).shadowMatrix}else i&&(l=$c.evalSpotCookieMatrix(t));else(a||i)&&(h=t.atlasViewport);const c=this.lightsFloat,d=this.lightsUint,u=e*this.lightsTexture.width*4;c[u+4*Qc.POSITION_RANGE+0]=o.x,c[u+4*Qc.POSITION_RANGE+1]=o.y,c[u+4*Qc.POSITION_RANGE+2]=o.z,c[u+4*Qc.POSITION_RANGE+3]=t.attenuationEnd;const f=t.clusteredData;if(d[u+4*Qc.COLOR_ANGLES_BIAS+0]=f[0],d[u+4*Qc.COLOR_ANGLES_BIAS+1]=f[1],d[u+4*Qc.COLOR_ANGLES_BIAS+2]=f[2],t.castShadows){const e=t.getRenderData(null,0),s=t._getUniformBiasValues(e),n=is.float2Half(s.bias),i=is.float2Half(s.normalBias);d[u+4*Qc.COLOR_ANGLES_BIAS+3]=n|i<<16}if(s&&(this.getSpotDirection(Xc,t),c[u+4*Qc.DIRECTION_FLAGS+0]=Xc.x,c[u+4*Qc.DIRECTION_FLAGS+1]=Xc.y,c[u+4*Qc.DIRECTION_FLAGS+2]=Xc.z),d[u+4*Qc.DIRECTION_FLAGS+3]=t.getClusteredFlags(a,i),l){const t=l.data;for(let e=0;e<16;e++)c[u+4*Qc.PROJ_MAT_0+e]=t[e]}if(h&&(c[u+4*Qc.ATLAS_VIEWPORT+0]=h.x,c[u+4*Qc.ATLAS_VIEWPORT+1]=h.y,c[u+4*Qc.ATLAS_VIEWPORT+2]=h.z/3),r){const e=this.getLightAreaSizes(t);c[u+4*Qc.AREA_DATA_WIDTH+0]=e[0],c[u+4*Qc.AREA_DATA_WIDTH+1]=e[1],c[u+4*Qc.AREA_DATA_WIDTH+2]=e[2],c[u+4*Qc.AREA_DATA_HEIGHT+0]=e[3],c[u+4*Qc.AREA_DATA_HEIGHT+1]=e[4],c[u+4*Qc.AREA_DATA_HEIGHT+2]=e[5]}}}const sd=new rs,nd=new rs,id=new rs,rd=new Ss;class ad{constructor(){this.light=null,this.min=new rs,this.max=new rs}}class od{constructor(t){this.device=t,this.name="Untitled",this.reportCount=0,this.boundsMin=new rs,this.boundsMax=new rs,this.boundsDelta=new rs,this._cells=new rs(1,1,1),this._cellsLimit=new rs,this.cells=this._cells,this.maxCellLightCount=4,this._usedLights=[],this._usedLights.push(new ad),this.lightsBuffer=new ed(t),this.registerUniforms(t)}set maxCellLightCount(t){t!==this._maxCellLightCount&&(this._maxCellLightCount=t,this._cellsDirty=!0)}get maxCellLightCount(){return this._maxCellLightCount}set cells(t){sd.copy(t).floor(),this._cells.equals(sd)||(this._cells.copy(sd),this._cellsLimit.copy(sd).sub(rs.ONE),this._cellsDirty=!0)}get cells(){return this._cells}destroy(){this.lightsBuffer.destroy(),this.releaseClusterTexture()}releaseClusterTexture(){this.clusterTexture&&(this.clusterTexture.destroy(),this.clusterTexture=null)}registerUniforms(t){this._clusterSkipId=t.scope.resolve("clusterSkip"),this._clusterMaxCellsId=t.scope.resolve("clusterMaxCells"),this._clusterWorldTextureId=t.scope.resolve("clusterWorldTexture"),this._clusterTextureSizeId=t.scope.resolve("clusterTextureSize"),this._clusterTextureSizeData=new Float32Array(3),this._clusterBoundsMinId=t.scope.resolve("clusterBoundsMin"),this._clusterBoundsMinData=new Float32Array(3),this._clusterBoundsDeltaId=t.scope.resolve("clusterBoundsDelta"),this._clusterBoundsDeltaData=new Float32Array(3),this._clusterCellsCountByBoundsSizeId=t.scope.resolve("clusterCellsCountByBoundsSize"),this._clusterCellsCountByBoundsSizeData=new Float32Array(3),this._clusterCellsDotId=t.scope.resolve("clusterCellsDot"),this._clusterCellsDotData=new Float32Array(3),this._clusterCellsMaxId=t.scope.resolve("clusterCellsMax"),this._clusterCellsMaxData=new Float32Array(3)}updateParams(t){t&&(this.cells=t.cells,this.maxCellLightCount=t.maxLightsPerCell,this.lightsBuffer.cookiesEnabled=t.cookiesEnabled,this.lightsBuffer.shadowsEnabled=t.shadowsEnabled,this.lightsBuffer.areaLightsEnabled=t.areaLightsEnabled)}updateCells(){if(this._cellsDirty){this._cellsDirty=!1;const t=this._cells.x,e=this._cells.y,s=this._cells.z,n=t*e*s,i=this.maxCellLightCount*n;let r=Math.ceil(Math.sqrt(i));r=Qe.roundUp(r,this.maxCellLightCount);const a=Math.ceil(i/r);this._clusterCellsMaxData[0]=t,this._clusterCellsMaxData[1]=e,this._clusterCellsMaxData[2]=s,this._clusterCellsDotData[0]=this.maxCellLightCount,this._clusterCellsDotData[1]=t*s*this.maxCellLightCount,this._clusterCellsDotData[2]=t*this.maxCellLightCount,this.clusters=new Uint8ClampedArray(i),this.counts=new Int32Array(n),this._clusterTextureSizeData[0]=r,this._clusterTextureSizeData[1]=1/r,this._clusterTextureSizeData[2]=1/a,this.releaseClusterTexture(),this.clusterTexture=this.lightsBuffer.createTexture(this.device,r,a,52,"ClusterTexture")}}uploadTextures(){this.clusterTexture.lock().set(this.clusters),this.clusterTexture.unlock(),this.lightsBuffer.uploadTextures()}updateUniforms(){this._clusterSkipId.setValue(this._usedLights.length>1?0:1),this.lightsBuffer.updateUniforms(),this._clusterWorldTextureId.setValue(this.clusterTexture),this._clusterMaxCellsId.setValue(this.maxCellLightCount);const t=this.boundsDelta;this._clusterCellsCountByBoundsSizeData[0]=this._cells.x/t.x,this._clusterCellsCountByBoundsSizeData[1]=this._cells.y/t.y,this._clusterCellsCountByBoundsSizeData[2]=this._cells.z/t.z,this._clusterCellsCountByBoundsSizeId.setValue(this._clusterCellsCountByBoundsSizeData),this._clusterBoundsMinData[0]=this.boundsMin.x,this._clusterBoundsMinData[1]=this.boundsMin.y,this._clusterBoundsMinData[2]=this.boundsMin.z,this._clusterBoundsDeltaData[0]=t.x,this._clusterBoundsDeltaData[1]=t.y,this._clusterBoundsDeltaData[2]=t.z,this._clusterTextureSizeId.setValue(this._clusterTextureSizeData),this._clusterBoundsMinId.setValue(this._clusterBoundsMinData),this._clusterBoundsDeltaId.setValue(this._clusterBoundsDeltaData),this._clusterCellsDotId.setValue(this._clusterCellsDotData),this._clusterCellsMaxId.setValue(this._clusterCellsMaxData)}evalLightCellMinMax(t,e,s){e.copy(t.min),e.sub(this.boundsMin),e.div(this.boundsDelta),e.mul2(e,this.cells),e.floor(),s.copy(t.max),s.sub(this.boundsMin),s.div(this.boundsDelta),s.mul2(s,this.cells),s.ceil(),e.max(rs.ZERO),s.min(this._cellsLimit)}collectLights(t){const e=this.lightsBuffer.maxLights,s=this._usedLights;let n=1;t.forEach(t=>{const i=!!(3&t.mask),r=2===t.type&&0===t._outerConeAngle;if(t.enabled&&0!==t.type&&t.visibleThisFrame&&t.intensity>0&&i&&!r&&n<e){let e;n<s.length?e=s[n]:(e=new ad,s.push(e)),e.light=t,t.getBoundingBox(rd),e.min.copy(rd.getMin()),e.max.copy(rd.getMax()),n++}}),s.length=n}evaluateBounds(){const t=this._usedLights,e=this.boundsMin,s=this.boundsMax;if(t.length>1){e.copy(t[1].min),s.copy(t[1].max);for(let n=2;n<t.length;n++)e.min(t[n].min),s.max(t[n].max)}else e.set(0,0,0),s.set(1,1,1);this.boundsDelta.sub2(s,e),this.lightsBuffer.setBounds(e,this.boundsDelta)}updateClusters(t){this.counts.fill(0),this.clusters.fill(0),this.lightsBuffer.areaLightsEnabled=!!t&&t.areaLightsEnabled;const e=this._cells.x,s=this._cells.z,n=this.counts,i=this._maxCellLightCount,r=this.clusters,a=this.maxCellLightCount,o=this._usedLights;for(let t=1;t<o.length;t++){const l=o[t],h=l.light;this.lightsBuffer.addLightData(h,t),this.evalLightCellMinMax(l,nd,id);const c=nd.x,d=id.x,u=nd.y,f=id.y,p=nd.z,m=id.z;for(let o=c;o<=d;o++)for(let l=p;l<=m;l++)for(let h=u;h<=f;h++){const c=o+e*(l+h*s),d=n[c];d<i&&(r[a*c+d]=t,n[c]=d+1)}}}update(t,e=null){this.updateParams(e),this.updateCells(),this.collectLights(t),this.evaluateBounds(),this.updateClusters(e),this.uploadTextures()}activate(){this.updateUniforms()}}let ld=null;const hd=()=>{if(!ld){const t=atob("muPIHORMLNDCz4DxVR/ZvYfAUVEFR47KRIC4nwAAAAAP7WxlhD6Ci+2HCe7BF8jRAPZwdH2UPpI5PdLCJdkvG4UTaNDJ/0crAzne71GCrb4kbdMjjCEGzdX6fNxDMLJq5xkeoIVTdfiZkodEeArmZmp/FQzFjD4x8iOW7Dg64n+3mWqyEwLxXT8zoJXfbw8QJKDCaarUYyTlMzNFHbgUe9IQV7g4YOgtSKpIFZJ0qERm7u4PpmiF89ktHWCywaGmD6h+hfh2/Zd8KYlKqqo4Cem4T42bT/Z9FpCQF1hhSjfBzZ5XFn/y3jegWC6u86KuELRundQS/1Rp+XuKKGIgRv3CvP5y749yqLlFO495JOT3+f2CXgd71npU0/KjjpkZucbJ5m78IVyuSrSozc9jgBUhDrz0hFsyb7LFUH9//wJbBgLdNWJZObfKxrNt8TliLA9w9sXFv6g26iXpf6r/BqcAusj/QzGBZuoUGeEtw8BCXCZ3jUiw4hvM18ZVqlUD3C40LAFXW6FRjuAZGRNstb0/qVk4skwyT+MHrvRorI4rKHVMWZmKyAkzL/78u/9pMQuX14pZN50b2PHn6fRxeaCQLsfT4dpvIkWWFuFVENZIh+8xgR6lU+85W0PPdAu1j99kcCG40JBQa4JMyRzq6qriOBLtqF87vpCJan0WEduVr/mOYkS00urVA0mA6M3031+GmGmW48PaJDYOEIb3bIXWPaLoAOEinX1TN3+/vwhG6nqJu0TdHpedS7QsGZIoxH3nQYYjQP1jmbahlbNngw5ogsGk1y50XZyUmQBY+/JBJ3Unu4dApm+WmPwHPU9gLb+4mHh4BiY6M86pq+WeTyWdI3s0CXPEtHGXZ8zMZgUoyRomBi1VdazzuN+WOmQ9Pa0Z0tlNopUi8AJ4x2Xn4mmOKEbXLxlbVsWu8XhuDGYFOGCRVdSqDPXrHU5SDdUlti3k5///SBwzTMwK3L4a1H7w4lnpEas6////AfX8asyIBfeFXVJ3tgvxQ/blZuUKyIODIfr/UzdWNu7pciLBpdZRZ4pIfZ1R6szq+XNxkGG///8EZFpu7VHAhFWqHEOrB9unw+YQa5o8/9IR/V5/zq+986rJSyfgJKt2u9hxU1wzyQWPjJGvzG9+eWWxGFOHVKqI4jBQALwZZswesnvZ2UmmkEXdiRpz8B+oWE7PY70ZTMndisYSXg2TqoI+3y9BxbnY2Y4EfbdcRhAvG59NqDENNYbxKvK5HJfPG5M+Wi2AcpLVJrD6caiEOzgSoVNSgQK8fm2M3zGcF4xtClv/8Hs9oD7C3jitTATYNQxmKqKf1LhIxzf1bmfiNn7UKFmcJu4sLqVLwxGSue3taBEyknkw5hXTsUCvqmmL/f8n/w0giR7Hu/9EHvpkz3yuu64TioMkzdTJ30i0+hFnQqW1+v9mMwq+z9qGX0UFu9MomvVG2xod6vc12AAAAACq7sGa5qptFR0jF3nQt/D+7PibKYahaxP3hEixPbGi9nwNf2LAa7LkEZRKxzXeCD64Xpii5n+8Kpg8eHIv7AWXZltgMoGltmoJ0XGdOCL8WkzphvR9N2o3ARSZ42l5e5Pe4B58MCRlP3EKv+mcloknH+fto5BWsmEutW6KvjOVsznFCktkSczVk4aGvj9VXlRcLeDoKG8RkBgdcNG2bf8HUL4MT2DM+ar7NImJhKpxakX4Vk0CnP+/XNhl5UsP0lXgeZXPoDBMSW5An+DXlTCO5FQGwSPYwHLKYVIimEdAoVe49rQLaaNcye5LxU2/c5TijTgJtD5eQQIe1snxauj5jZsxJBUJdoP/zqpjqv8qBruoPsVsP8N44PCUW5Dd0DzqjSS/Dl5mI9cn1w2ndN/0KAEm1QAAAACwu6KM/083IBbH5bPa/9oHUwcU8I9v3j6/v18QYammrf+P6VL///8BrpuM3fOLCxaLNOFNF1zPbPYTP65ni6njft4eVcyrVXRQFrs52tr35StiSp55edVDCBC0H5rIfac6nzUwxQSt7y15QoKb+5zebEQUmVbrPjXuUa19Ey7sqXMiSUKHaw72PJKDdrutJoQr3u6lEYJ8K0MakWKj9zjTFi4X94TsKYco0GrLeB60M6D8M/80rhXUW8iMequg8y5F838WI0+gp3GBN5Kj/xIOxTWQuUaPV/LwvARr1VH93BFgGZR1MFW0Ua30GbYmdnAgo9VWy8SQtpDUgGE2r2zq2eTEMCL7sMKmE1hchVhuF/TCq9iXKEm86kzOf3Rp9ZnCxbpDUj+FKNxVyXe6pVZkRXv/m95SnB/EB8aME29N85MtAcDoXWlor8De2Q5Dg1tar+8wgiZufbMam81j//ASUohoR/zSh2KG4bvT6mkIPz6C5/98DC3LaWlaEZ1zA5JORZRu6J/a0GY285sEYzw71YqOT1ihAG0z5SDt1xNiDQWZdFpndArp6xWhqSDkRb4kSJEHb9liPvw7uLV/6i5MVf//A9Qjr8xkAEUh+KDI+zdtJ68d6MBOktg1iyp/SCq8O9f5pbamn1VVVQPRTWqNBvhQKa07s6P0lc9Luu/3gw4HeyOUfz8MxMwV4UQhua+t9cr4bz/nIB2wnDSK1K7I94M+s6C84htaX/CNlMQUSs2KJO+yaebfTbkNX5yWcqEJevo0vbKUiETuFXiL019A3E+lmsyZMwXrXLLiQAZ5t9+jI3JobhJTMiDH5ZOQ+8Jau5555NMjHSscP9qCVaa40doh+1a3Ukf6jqBmLddgh79/fwTfCyqiuldNkUoy+nUp+4nerwg0OjtGv2x485PJOJvUEokNhYIdWjpx7BWk0VZGWOp3jSFTJ2bnu6KCduZtG/UcBC9RZ3W/jMSfSMw4Etr/DoD/XYP2V5Ovw+YoM3F5g2dGLdvuG6ZkVGLE6Dk5Zr+sdSyGliJP1y2OFf/KFO0RWO+3gsGhesTnfZVpTd8/HwgO216gwaqo+vY3TljfJWowY+i0p0Os4SLn/1wLqDHMlszggmT/D8MRFzs+pLv6LNJSsNZ/r41mWi/rF6ZcKp/yzJdK0VU44hskq3RGpgO6mIpJDsf/mZkFrz0yYOMLbuaj/wp1v7JMFM5eqvBhmTd7U8frQAtHtys4zgpjZmzUhOVTfNNLifElGXADlqHGKrkBT/nYwX8ZRm3RjvyPvjKyEqEGKUpVnvOGx+NKPHiWM//ZDpDVGvvrjmk8RPF/wiYZD3+Us8YCXjrVOfjdd1UPAfjLp8jgSn4me7DPTpz1Ggy9XL80guFO7ECT10AvILKfD18Qx+KY/f8aRqu0oOO8hfKRFZa9PUJwCsp6VdZz6LFkm2b9Pl2LIifCwzRy7TpdG2uAtOxP2OemY26bJMa9ZGSLIRlMsgpDpnDJwd0oa5pQ13x1hrHf52HpulUWonGWsfXZbSQYKu9bnEN76ciQih0opN3deDVrbrxorfVlnCmL1R9zq3ePGWIv21c7pW8kEiFTM5JX8dAw867s/60cf79/BH+MDFCZBHlz1L+qGOJf/1txhhmrf3//As+RIJwevDb+fgNXVeHw67QptZegayhrEwr5Gy+EPo1RLaMtPbqOZYoVzXzwzjMFWZxyUG9YUIf6////AQWy84iAygLk9COtXt92+0mT/xg0zMzMBeLkb8y9SL2TDXgSX422hDgpGNLJyuPioA+YJ91G8znrpNqHkwYyscaJDEc9Vc+j4cXle3hvcd2JqDQH2lBZxDn6mUTs0b75raMvbs727codX01Anj8f3wir9P2xQaQ22v/TxCMglKDFoTjaP01XTLgxnTvPv02JgEUrW6UDgOnobFpLdvKdlypgIzPcq14fgXU5tvVW0FEs7VRlsG1IyA69fN4n+awHhT34cE+xUvdj86C8LgAsFheTjI9Ht9EyYAAAAAAVBVKRx2wLgUTI0/2QfyJo2riRw3JDqzEShmx/Lifo6mRkQVbS7X53t+EvKxcXogtdts31e9MRHdcHgsA8rt4/mt2unlzQ/wsU8Gu7+W6Oj7eD8EQdDp5XlCsVaS/AV/t5ZpPOHR3rGpyAJe9IPV+xMrBL1Oz/8MQhFs31h0N1cVnq371uqIJYHyafKH1jteAK3VpMXBcuC+yt0ZeKyRUY4QhdrJJ4tJ1wg3Hu6kDsbovxupTMkGdRrm8oZSoYPbJ+PwH/xotgTdkA1205vUEfnqkI04T/fnnd1fiZW5AwNcggd7fi4j5zasmcntZexIxqFZQMzMJpfndmI5jn17cgn5EV5t9XN0C///8Q9wlJpMGXdoiaMTG2sVyHQsn8mWRISCLNG777S0OuDRP2GlLcJ2UeOg7Fo8hTNPeJ//iTJhyqxhKRUntdXOihq2wfKfH///8B0GGrwT+fSOQRdctKxjjGCSS11d6BlQ9BDfE0J6Z25FaNTKGpFKNCMr2G/041KpWwBLVe1k08vncseQbKZdXi8x1t9XA45U/Wd43D9wAh3Tal0aiLVzGPusOZ1F+W3TWoqlX/A95+dNef11TsuGful+ctGssldk3fqpfqh+43XTxL42+leSHoF/dWHYGX6maqUEuLX7UB+r/6Llr4LKocbVIeu+hB9QTPfz9fCP8RyWmX4SmbhMFsNtCijV7lVcwejLKlvl0GfCndnWV7/39VBrtTRuUx92oke3GBgKkC5fdGK0YvNK+xenKaDmsHDjNFUM3NMz3ZiXXFuLgojosPVCDEl2W5BjX3Ms+j0GSqACHmh0+RPWyuNm/Qe8vFf9AW7N1uRaxWirrUytqEJnJ4/Flm8hSoiZ2NQBsS6w/yQlC4gCaFo8q4nyY6AFdo4hiwhBXzbNKKvZvktCjSCukRR/BbYVbNwZi2Yh3hGodEacLW8qijiWJODf0P2bhfaiPspPT4lYJBgi/KfcFwCfvyUIgkJOv///8CG/JEepRBLaMFE+2TgrqsJXOVOWHt6g/bFwVLLMVBsMR50dis/39/AlBX+/rMTJkUQrnlxpR2iu0Tp8tATkRYGmDIrcAiRP8PjoWIlb7/0ecTdSCE9Y58+a+n/FovJQTVF4F2jAxMZhTgrM/KVS5BQu6bVbkWY5HXnxRshks3urDdW4RkWp4M4TeLmFK5KF/uHkkiO5Kv96RioH984v/CSDBnG+BwlnU9B+o7Y+0X0Nob+0pLsStxjvPXMy2eCpzhOWV4XbObBHN4UE2sLQ/DIqXhOzxVf38GlTi6aG7EnePO7TRJm9yOfUUcqq1I2iQHrVDqn3TUNRi/lMw8KbMW/3/nqCz/Ef8PoW5Qxcz2yHR/f78EPB2Stbd+ZFmfNTUYILzsb9YNhpaHcaymYrBiNHmFE3Y4ccYJ25Prqm7zHobGHED8/93ZNlWro9vcKivGZs31UiK1k5zjUhexUgbqJb+fUTjxce/7Zly8a5KMC1fX5nfjPgibdvzbXV1jRT2asXvmSAusaLdq1TSIJ8fXINk5AtT34EWPAsfP9IFQqM5K11O6saoHJA==");ld=Uint8Array.from(t,t=>t.charCodeAt(0))}},cd=()=>(hd(),ld);class dd{constructor(t=0){this.seed=0,this.seed=4*t,hd()}_next(){this.seed=(this.seed+4)%ld.length}value(){return this._next(),ld[this.seed]/255}vec4(t=new ls){return this._next(),t.set(ld[this.seed],ld[this.seed+1],ld[this.seed+2],ld[this.seed+3]).mulScalar(1/255)}}const ud=[new rs(-1,0,0),new rs(1,0,0),new rs(0,-1,0),new rs(0,1,0),new rs(0,0,-1),new rs(0,0,1)];class fd{update(t,e){const s=this.colors,{r:n,g:i,b:r}=t;for(let t=0;t<6;t++)s[3*t]=n,s[3*t+1]=i,s[3*t+2]=r;for(let t=0;t<e.length;t++){const n=e[t];if(0===n._type)for(let t=0;t<6;t++){const e=Math.max(ud[t].dot(n._direction),0)*n._intensity,i=n._color;s[3*t]+=i.r*e,s[3*t+1]+=i.g*e,s[3*t+2]+=i.b*e}}}constructor(){this.colors=new Float32Array(18)}}const pd=new di,md=t=>pd.get(t,()=>{const e=cd(),s=Math.sqrt(e.length/4);return((t,e,s,n)=>{const i=new pi(t,{name:`${e}${s}`,width:s,height:s,format:7,addressU:0,addressV:0,type:yn,magFilter:0,minFilter:0,anisotropy:1,mipmaps:!1});return i.lock().set(n),i.unlock(),i})(t,"BlueNoise",s,e)});class gd{constructor(t,e){this.texture=t,this.cached=!1,this.renderTargets=e}destroy(){this.texture&&(this.texture.destroy(),this.texture=null);const t=this.renderTargets;for(let e=0;e<t.length;e++)t[e].destroy();this.renderTargets.length=0}static create(t,e){let s=null;return s=1===e._type?this.createCubemap(t,e._shadowResolution,e._shadowType):this.create2dMap(t,e._shadowResolution,e._shadowType),s}static createAtlas(t,e,s){const n=this.create2dMap(t,e,s),i=n.renderTargets,r=i[0];for(let t=0;t<5;t++)i.push(r);return n}static create2dMap(t,e,s){const n=zl.get(s);let i=n.format;i===Rs&&!t.textureFloatRenderable&&t.textureHalfFloatRenderable&&(i=50);const r=Ws.get(i)?.name;let a=1;3===s&&(a=t.extTextureFloatLinear?1:0),6===s&&(a=0);const o=new pi(t,{format:i,width:e,height:e,mipmaps:!1,minFilter:a,magFilter:a,addressU:1,addressV:1,name:`ShadowMap2D_${r}`});let l=null;return n?.pcf?(o.compareOnRead=!0,o.compareFunc=1,l=new ji({depthBuffer:o})):l=new ji({colorBuffer:o,depth:!0}),t.isWebGPU&&(l.flipY=!0),new gd(o,[l])}static createCubemap(t,e,s){const n=zl.get(s),i=Ws.get(n.format)?.name,r=6===s,a=r?0:1,o=new pi(t,{format:n?.format,width:e,height:e,cubemap:!0,mipmaps:!1,minFilter:a,magFilter:a,addressU:1,addressV:1,name:`ShadowMapCube_${i}`});r||(o.compareOnRead=!0,o.compareFunc=1);const l=[];for(let t=0;t<6;t++)r?l.push(new ji({colorBuffer:o,face:t,depth:!0})):l.push(new ji({depthBuffer:o,face:t}));return new gd(o,l)}}const _d=[],vd=[],yd=new ls,bd=new ls;class Sd{constructor(t){this.size=Math.floor(1024*t.w),this.used=!1,this.lightId=-1,this.rect=t}}class xd{constructor(t){this.device=t,this.version=1,this.shadowAtlasResolution=2048,this.shadowAtlas=null,this.shadowEdgePixels=3,this.cookieAtlasResolution=4,this.cookieAtlas=new pi(this.device,{name:"CookieAtlas",width:this.cookieAtlasResolution,height:this.cookieAtlasResolution,format:Fs,cubemap:!1,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1}),this.cookieRenderTarget=new ji({colorBuffer:this.cookieAtlas,depth:!1,flipY:!0}),this.slots=[],this.atlasSplit=[],this.cubeSlotsOffsets=[new os(0,0),new os(0,1),new os(1,0),new os(1,1),new os(2,0),new os(2,1)],this.scissorVec=new ls,this.allocateShadowAtlas(1),this.allocateCookieAtlas(1),this.allocateUniforms()}destroy(){this.destroyShadowAtlas(),this.destroyCookieAtlas()}destroyShadowAtlas(){this.shadowAtlas?.destroy(),this.shadowAtlas=null}destroyCookieAtlas(){this.cookieAtlas?.destroy(),this.cookieAtlas=null,this.cookieRenderTarget?.destroy(),this.cookieRenderTarget=null}allocateShadowAtlas(t,e=0){const s=this.shadowAtlas?.texture.format,n=zl.get(e).format;if(!this.shadowAtlas||this.shadowAtlas.texture.width!==t||s!==n){this.version++,this.destroyShadowAtlas(),this.shadowAtlas=gd.createAtlas(this.device,t,e),this.shadowAtlas.cached=!0;const s=4/this.shadowAtlasResolution;this.scissorVec.set(s,s,-2*s,-2*s)}}allocateCookieAtlas(t){this.cookieAtlas.width!==t&&(this.cookieRenderTarget.resize(t,t),this.version++)}allocateUniforms(){this._shadowAtlasTextureId=this.device.scope.resolve("shadowAtlasTexture"),this._shadowAtlasParamsId=this.device.scope.resolve("shadowAtlasParams"),this._shadowAtlasParams=new Float32Array(2),this._cookieAtlasTextureId=this.device.scope.resolve("cookieAtlasTexture")}updateUniforms(){const t=this.shadowAtlas.renderTargets[0].depthBuffer;this._shadowAtlasTextureId.setValue(t),this._shadowAtlasParams[0]=this.shadowAtlasResolution,this._shadowAtlasParams[1]=this.shadowEdgePixels,this._shadowAtlasParamsId.setValue(this._shadowAtlasParams),this._cookieAtlasTextureId.setValue(this.cookieAtlas)}subdivide(t,e){let s=e.atlasSplit;if(!s){const e=Math.ceil(Math.sqrt(t));s=vd,s[0]=e,s.length=1}if(n=s,i=this.atlasSplit,n.length!==i.length||!n.every((t,e)=>t===i[e])){this.version++,this.slots.length=0,this.atlasSplit.length=0,this.atlasSplit.push(...s);const t=this.atlasSplit[0];if(t>1){const e=1/t;for(let s=0;s<t;s++)for(let n=0;n<t;n++){const i=new ls(s*e,n*e,e,e),r=this.atlasSplit[1+s*t+n];if(r>1)for(let t=0;t<r;t++)for(let s=0;s<r;s++){const n=e/r,a=new ls(i.x+t*n,i.y+s*n,n,n);this.slots.push(new Sd(a))}else this.slots.push(new Sd(i))}}else this.slots.push(new Sd(new ls(0,0,1,1)));this.slots.sort((t,e)=>e.size-t.size)}var n,i}collectLights(t,e){const s=e.cookiesEnabled,n=e.shadowsEnabled;let i=!1,r=!1;const a=_d;a.length=0;return(s||n)&&(t=>{for(let e=0;e<t.length;e++){const o=t[e];if(o.visibleThisFrame){const t=n&&o.castShadows,e=s&&!!o.cookie;i||=t,r||=e,(t||e)&&a.push(o)}}})(t),a.sort((t,e)=>e.maxScreenSize-t.maxScreenSize),i&&this.allocateShadowAtlas(this.shadowAtlasResolution,e.shadowType),r&&this.allocateCookieAtlas(this.cookieAtlasResolution),(i||r)&&this.subdivide(a.length,e),a}setupSlot(t,e){t.atlasViewport.copy(e);const s=t.numShadowFaces;for(let n=0;n<s;n++)if(t.castShadows||t._cookie){if(yd.copy(e),bd.copy(e),2===t._type&&yd.add(this.scissorVec),1===t._type){const t=yd.z/3,e=this.cubeSlotsOffsets[n];yd.x+=t*e.x,yd.y+=t*e.y,yd.z=t,yd.w=t,bd.copy(yd)}if(t.castShadows){const e=t.getRenderData(null,n);e.shadowViewport.copy(yd),e.shadowScissor.copy(bd)}}}assignSlot(t,e,s){t.atlasViewportAllocated=!0;const n=this.slots[e];n.lightId=t.id,n.used=!0,s&&(t.atlasSlotUpdated=!0,t.atlasVersion=this.version,t.atlasSlotIndex=e)}update(t,e){this.shadowAtlasResolution=e.shadowAtlasResolution,this.cookieAtlasResolution=e.cookieAtlasResolution;const s=this.collectLights(t,e);if(s.length>0){const t=this.slots;for(let e=0;e<t.length;e++)t[e].used=!1;const e=Math.min(s.length,t.length);for(let n=0;n<e;n++){const e=s[n];e.castShadows&&(e._shadowMap=this.shadowAtlas);const i=t[e.atlasSlotIndex];if(e.atlasVersion===this.version&&e.id===i?.lightId){const s=t[e.atlasSlotIndex];s.size!==t[n].size||s.used||this.assignSlot(e,e.atlasSlotIndex,!1)}}let n=0;for(let i=0;i<e;i++){for(;n<t.length&&t[n].used;)n++;const e=s[i];e.atlasViewportAllocated||this.assignSlot(e,n,!0);const r=t[e.atlasSlotIndex];this.setupSlot(e,r.rect)}}this.updateUniforms()}}const wd=[];wd[0]={src:1,dst:1,op:2},wd[3]={src:1,dst:0,op:0},wd[2]={src:6,dst:8,op:0,alphaSrc:1},wd[4]={src:1,dst:8,op:0},wd[1]={src:1,dst:1,op:0},wd[6]={src:6,dst:1,op:0},wd[7]={src:4,dst:2,op:0},wd[8]={src:5,dst:1,op:0},wd[5]={src:4,dst:0,op:0},wd[9]={src:1,dst:1,op:3},wd[10]={src:1,dst:1,op:4};let Td=0;class Cd{constructor(){this.meshInstances=[],this.name="Untitled",this.userId="",this.id=Td++,this.variants=new Map,this.defines=new Map,this._definesDirty=!1,this.parameters={},this.alphaTest=0,this.alphaToCoverage=!1,this._blendState=new Ti,this._depthState=new Ai,this.cull=1,this.stencilFront=null,this.stencilBack=null,this._shaderChunks=null,this._oldChunks={},this._dirtyShader=!0,this._shaderVersion=0,this._scene=null,this.dirty=!0}get hasShaderChunks(){return null!=this._shaderChunks}get shaderChunks(){return this._shaderChunks||(this._shaderChunks=new Fh),this._shaderChunks}getShaderChunks(t=In){const e=this.shaderChunks;return t===In?e.glsl:e.wgsl}set shaderChunksVersion(t){this.shaderChunks.version=t}get shaderChunksVersion(){return this.shaderChunks.version}set chunks(t){this._oldChunks=t}get chunks(){return Object.assign(this._oldChunks,Object.fromEntries(this.shaderChunks.glsl)),this._oldChunks}set depthBias(t){this._depthState.depthBias=t}get depthBias(){return this._depthState.depthBias}set slopeDepthBias(t){this._depthState.depthBiasSlope=t}get slopeDepthBias(){return this._depthState.depthBiasSlope}set redWrite(t){this._blendState.redWrite=t}get redWrite(){return this._blendState.redWrite}set greenWrite(t){this._blendState.greenWrite=t}get greenWrite(){return this._blendState.greenWrite}set blueWrite(t){this._blendState.blueWrite=t}get blueWrite(){return this._blendState.blueWrite}set alphaWrite(t){this._blendState.alphaWrite=t}get alphaWrite(){return this._blendState.alphaWrite}get transparent(){return this._blendState.blend}_updateTransparency(){const t=this.transparent,e=this.meshInstances;for(let s=0;s<e.length;s++)e[s].transparent=t}set blendState(t){this._blendState.copy(t),this._updateTransparency()}get blendState(){return this._blendState}set blendType(t){const e=wd[t];this._blendState.setColorBlend(e.op,e.src,e.dst),this._blendState.setAlphaBlend(e.alphaOp??e.op,e.alphaSrc??e.src,e.alphaDst??e.dst);const s=3!==t;this._blendState.blend!==s&&(this._blendState.blend=s,this._updateTransparency()),this._updateMeshInstanceKeys()}get blendType(){if(!this.transparent)return 3;const{colorOp:t,colorSrcFactor:e,colorDstFactor:s,alphaOp:n,alphaSrcFactor:i,alphaDstFactor:r}=this._blendState;for(let a=0;a<wd.length;a++){const o=wd[a];if(o.src===e&&o.dst===s&&o.op===t&&o.src===i&&o.dst===r&&o.op===n)return a}return 2}set depthState(t){this._depthState.copy(t)}get depthState(){return this._depthState}set depthTest(t){this._depthState.test=t}get depthTest(){return this._depthState.test}set depthFunc(t){this._depthState.func=t}get depthFunc(){return this._depthState.func}set depthWrite(t){this._depthState.write=t}get depthWrite(){return this._depthState.write}copy(t){this.name=t.name,this.alphaTest=t.alphaTest,this.alphaToCoverage=t.alphaToCoverage,this._blendState.copy(t._blendState),this._depthState.copy(t._depthState),this.cull=t.cull,this.stencilFront=t.stencilFront?.clone(),t.stencilBack&&(this.stencilBack=t.stencilFront===t.stencilBack?this.stencilFront:t.stencilBack.clone()),this.clearParameters();for(const e in t.parameters)t.parameters.hasOwnProperty(e)&&this._setParameterSimple(e,t.parameters[e].data);return this.defines.clear(),t.defines.forEach((t,e)=>this.defines.set(e,t)),this._shaderChunks=t.hasShaderChunks?new Fh:null,this._shaderChunks?.copy(t._shaderChunks),this}clone(){return(new this.constructor).copy(this)}_updateMeshInstanceKeys(){const t=this.meshInstances;for(let e=0;e<t.length;e++)t[e].updateKey()}updateUniforms(t,e){this._dirtyShader&&this.clearVariants()}getShaderVariant(t){}update(){if(Object.keys(this._oldChunks).length>0)for(const[t,e]of Object.entries(this._oldChunks))this.shaderChunks.glsl.set(t,e),delete this._oldChunks[t];(this._definesDirty||this._shaderChunks?.isDirty())&&(this._definesDirty=!1,this._shaderChunks?.resetDirty(),this.clearVariants()),this.dirty=!0}clearParameters(){this.parameters={}}getParameters(){return this.parameters}clearVariants(){this.variants.clear();const t=this.meshInstances,e=t.length;for(let s=0;s<e;s++)t[s].clearShaders()}getParameter(t){return this.parameters[t]}_setParameterSimple(t,e){const s=this.parameters[t];s?s.data=e:this.parameters[t]={scopeId:null,data:e}}setParameter(t,e){if(void 0===e&&"object"==typeof t){const s=t;if(s.length){for(let t=0;t<s.length;t++)this.setParameter(s[t]);return}t=s.name,e=s.value}this._setParameterSimple(t,e)}deleteParameter(t){this.parameters[t]&&delete this.parameters[t]}setParameters(t,e){const s=this.parameters;void 0===e&&(e=s);for(const n in e){const e=s[n];e&&(e.scopeId||(e.scopeId=t.scope.resolve(n)),e.scopeId.setValue(e.data))}}setDefine(t,e){let s=!1;const{defines:n}=this;void 0!==e&&!1!==e?(s=!n.has(t)||n.get(t)!==e,n.set(t,e)):(s=n.has(t),n.delete(t)),this._definesDirty||=s}getDefine(t){return this.defines.has(t)}destroy(){this.variants.clear();for(let t=0;t<this.meshInstances.length;t++){const e=this.meshInstances[t];if(e.clearShaders(),e._material=null,e.mesh){const t=sc(e.mesh.device);this!==t&&(e.material=t)}}this.meshInstances.length=0}addMeshInstanceRef(t){this.meshInstances.push(t)}removeMeshInstanceRef(t){const e=this.meshInstances,s=e.indexOf(t);-1!==s&&e.splice(s,1)}}class Ed{constructor(){this.cache=new Map}destroy(){this.clear(),this.cache=null}clear(){this.cache.forEach(t=>{t.forEach(t=>{t.destroy()})}),this.cache.clear()}getKey(t){return`${1===t._type}-${t._shadowType}-${t._shadowResolution}`}get(t,e){const s=this.getKey(e),n=this.cache.get(s);if(n&&n.length)return n.pop();const i=gd.create(t,e);return i.cached=!0,i}add(t,e){const s=this.getKey(t),n=this.cache.get(s);n?n.push(e):this.cache.set(s,[e])}}class Ad extends Fo{constructor(t,e,s,n,i){super(t),this.requiresCubemaps=!1,this.shadowRenderer=e,this.light=s,this.face=n,this.applyVsm=i,this.shadowCamera=e.prepareFace(s,null,n),e.setupRenderPass(this,this.shadowCamera,!0)}execute(){this.shadowRenderer.renderFace(this.light,null,this.face,!1)}after(){this.applyVsm&&this.shadowRenderer.renderVsm(this.light,this.shadowCamera)}}class Dd{constructor(t,e){this.shadowLights=[],this.renderer=t,this.shadowRenderer=e,this.device=t.device}cull(t,e,s=null){const n=this.renderer.scene.clusteredLightingEnabled;t.visibleThisFrame=!0,n||t._shadowMap||(t._shadowMap=gd.create(this.device,t));const i=t._type,r=2===i?1:6;for(let a=0;a<r;a++){const r=t.getRenderData(null,a),o=r.shadowCamera;o.nearClip=t.attenuationEnd/1e3,o.farClip=t.attenuationEnd;const l=o._node,h=t._node;if(l.setPosition(h.getPosition()),2===i)o.fov=2*t._outerConeAngle,l.setRotation(h.getRotation()),l.rotateLocal(-90,0,0);else if(1===i)if(n){const e=2/(this.shadowRenderer.lightTextureAtlas.shadowAtlasResolution*t.atlasViewport.z/3)*this.shadowRenderer.lightTextureAtlas.shadowEdgePixels;o.fov=Math.atan(1+e)*Qe.RAD_TO_DEG*2}else o.fov=90;this.renderer.updateCameraFrustum(o),this.shadowRenderer.cullShadowCasters(e,t,r.visibleCasters,o,s)}}prepareLights(t,e){let s;for(let n=0;n<e.length;n++){const i=e[n];if(this.shadowRenderer.needsShadowRendering(i)&&i.atlasViewportAllocated){t.push(i);for(let t=0;t<i.numShadowFaces;t++)s=this.shadowRenderer.prepareFace(i,null,t)}}return s}buildNonClusteredRenderPasses(t,e){for(let s=0;s<e.length;s++){const n=e[s];if(this.shadowRenderer.needsShadowRendering(n)){const e=2===n._type,s=n.numShadowFaces;for(let i=0;i<s;i++){const s=new Ad(this.device,this.shadowRenderer,n,i,e);t.addRenderPass(s)}}}}}class Pd extends Fo{constructor(t,e,s,n,i){super(t),this.shadowRenderer=e,this.light=s,this.camera=n,this.allCascadesRendering=i}execute(){const{light:t,camera:e,shadowRenderer:s,allCascadesRendering:n}=this,i=t.numShadowFaces,r=t.shadowUpdateOverrides;for(let a=0;a<i;a++)0!==r?.[a]&&s.renderFace(t,e,a,!n),1===r?.[a]&&(r[a]=0)}after(){this.shadowRenderer.renderVsm(this.light,this.camera)}}const Ld=new Ss,Id=new rs,Rd=new ps,Md=[new rs,new rs,new rs,new rs,new rs,new rs,new rs,new rs],kd={min:0,max:0};function Od(t,e,s){Md[0].x=Md[1].x=Md[2].x=Md[3].x=e.x,Md[1].y=Md[3].y=Md[7].y=Md[5].y=e.y,Md[2].z=Md[3].z=Md[6].z=Md[7].z=e.z,Md[4].x=Md[5].x=Md[6].x=Md[7].x=s.x,Md[0].y=Md[2].y=Md[4].y=Md[6].y=s.y,Md[0].z=Md[1].z=Md[4].z=Md[5].z=s.z;let n=9999999999,i=-9999999999;for(let e=0;e<8;++e){t.transformPoint(Md[e],Md[e]);const s=Md[e].z;s<n&&(n=s),s>i&&(i=s)}return kd.min=n,kd.max=i,kd}class Fd{constructor(t,e){this.renderer=t,this.shadowRenderer=e,this.device=t.device}cull(t,e,s,n=null){t.visibleThisFrame=!0,t._shadowMap||(t._shadowMap=gd.create(this.device,t));const i=s._nearClip;this.generateSplitDistances(t,i,Math.min(s._farClip,t.shadowDistance));const r=t.shadowUpdateOverrides;for(let a=0;a<t.numCascades&&0!==r?.[a];a++){const r=t.getRenderData(s,a),o=r.shadowCamera;o.renderTarget=t._shadowMap.renderTargets[0],r.shadowViewport.copy(t.cascades[a]),r.shadowScissor.copy(t.cascades[a]);const l=o._node,h=t._node;l.setPosition(h.getPosition()),l.setRotation(h.getRotation()),l.rotateLocal(-90,0,0);const c=0===a?i:t._shadowCascadeDistances[a-1],d=t._shadowCascadeDistances[a],u=s.getFrustumCorners(c,d);Id.set(0,0,0);const f=s.node.getWorldTransform();for(let t=0;t<8;t++)f.transformPoint(u[t],u[t]),Id.add(u[t]);Id.mulScalar(1/8);let p=0;for(let t=0;t<8;t++){const e=u[t].sub(Id).length();e>p&&(p=e)}const m=l.right,g=l.up,_=l.forward,v=.25*t._shadowResolution/p,y=Math.ceil(Id.dot(g)*v)/v,b=Math.ceil(Id.dot(m)*v)/v,S=g.mulScalar(y),x=m.mulScalar(b),w=Id.dot(_),T=_.mulScalar(w);Id.add2(S,x).add(T),l.setPosition(Id),l.translateLocal(0,0,1e6),o.nearClip=.01,o.farClip=2e6,o.orthoHeight=p,this.renderer.updateCameraFrustum(o),this.shadowRenderer.cullShadowCasters(e,t,r.visibleCasters,o,n);const C=1<<a,E=r.visibleCasters,A=E.length;let D=0;for(let t=0;t<A;t++){const e=E[t];e.shadowCascadeMask&C&&(E[D++]=e,1===D?Ld.copy(e.aabb):Ld.add(e.aabb))}A!==D&&(E.length=D),Rd.copy(l.getWorldTransform()).invert();const P=Od(Rd,Ld.getMin(),Ld.getMax());l.translateLocal(0,0,P.max+.1),o.farClip=P.max-P.min+.2,r.projectionCompensation=p}}generateSplitDistances(t,e,s){t._shadowCascadeDistances.fill(s);for(let n=1;n<t.numCascades;n++){const i=n/t.numCascades,r=e+(s-e)*i,a=e*(s/e)**i,o=Qe.lerp(r,a,t.cascadeDistribution);t._shadowCascadeDistances[n-1]=o}}getLightRenderPass(t,e){let s=null;if(this.shadowRenderer.needsShadowRendering(t)){const n=t.numShadowFaces,i=t.shadowUpdateOverrides;let r,a=!0;for(let s=0;s<n;s++)0===i?.[s]&&(a=!1),r=this.shadowRenderer.prepareFace(t,e,s);s=new Pd(this.device,this.shadowRenderer,t,e,a),this.shadowRenderer.setupRenderPass(s,r,a)}return s}}const Nd=new Set,Bd=new ps,zd=new ps,Ud=new Float32Array(2),Vd=new ls(1,1,0,0),Hd=new ps;function Gd(t,e){return Math.exp(-t*t/(2*e*e))}class Wd{constructor(t,e){this.shadowPassCache=[],this.device=t.device,this.renderer=t,this.lightTextureAtlas=e;const s=this.device.scope;this.sourceId=s.resolve("source"),this.pixelOffsetId=s.resolve("pixelOffset"),this.weightId=s.resolve("weight[0]"),this.blurVsmShader=[{},{}],this.blurVsmWeights={},this.shadowMapLightRadiusId=s.resolve("light_radius"),this.viewUniformFormat=null,this.viewBindGroupFormat=null,this.blendStateWrite=new Ti,this.blendStateNoWrite=new Ti,this.blendStateNoWrite.setColorWrite(!1,!1,!1,!1)}static createShadowCamera(t,e,s){const n=$c.create("ShadowCamera",e,s),i=zl.get(t),r=i?.vsm??!1,a=i?.pcf??!1;return n.clearColor=r?new Ze(0,0,0,0):new Ze(1,1,1,1),n.clearDepthBuffer=!0,n.clearStencilBuffer=!1,n.clearColorBuffer=!a,n}_cullShadowCastersInternal(t,e,s){const n=t.length;for(let i=0;i<n;i++){const n=t[i];n.castShadow&&(n.cull&&!n._isVisible(s)||(n.visibleThisFrame=!0,e.push(n)))}}cullShadowCasters(t,e,s,n,i){if(this.renderer.scene?.fire(Ch,n),s.length=0,i)this._cullShadowCastersInternal(i,s,n);else{const i=t.layerList,r=i.length;for(let t=0;t<r;t++){const r=i[t];r._lightsSet.has(e)&&(Nd.has(r)||(Nd.add(r),this._cullShadowCastersInternal(r.shadowCasters,s,n)))}Nd.clear()}s.sort(this.sortCompareShader),this.renderer.scene?.fire(Eh,n)}sortCompareShader(t,e){const s=t._sortKeyShadow,n=e._sortKeyShadow;return s===n?e.mesh.id-t.mesh.id:n-s}setupRenderState(t,e){const s=this.renderer.scene.clusteredLightingEnabled?e._isPcf:e._isPcf&&1!==e._type;t.setBlendState(s?this.blendStateNoWrite:this.blendStateWrite),t.setDepthState(e.shadowDepthState),t.setStencilState(null,null)}dispatchUniforms(t,e,s,n){const i=e._node;0!==t._type&&(this.renderer.dispatchViewPos(i.getPosition()),this.shadowMapLightRadiusId.setValue(t.attenuationEnd)),Bd.setTRS(i.getPosition(),i.getRotation(),rs.ONE).invert(),zd.mul2(e.projectionMatrix,Bd);const r=s.shadowViewport;e.rect=r,e.scissorRect=s.shadowScissor,Hd.setViewport(r.x,r.y,r.z,r.w),s.shadowMatrix.mul2(Hd,zd),0===t._type&&t._shadowMatrixPalette.set(s.shadowMatrix.data,16*n)}getShadowPass(t){const e=t._type,s=t._shadowType;let n=this.shadowPassCache[e]?.[s];if(!n){const t=`ShadowPass_${e}_${s}`;n=Mh.get(this.device).allocate(t,{isShadow:!0,lightType:e,shadowType:s}),this.shadowPassCache[e]||(this.shadowPassCache[e]=[]),this.shadowPassCache[e][s]=n}return n.index}submitCasters(t,e,s){const n=this.device,i=this.renderer,r=i.scene,a=this.getShadowPass(e),o=s.shaderParams,l=s.renderTarget.flipY?-1:1,h=t.length;for(let e=0;e<h;e++){const h=t[e],c=h.mesh,d=h.instancingData;if(d&&d.count<=0)continue;h.ensureMaterial(n);const u=h.material;i.setBaseConstants(n,u),i.setSkinning(n,h),u.dirty&&(u.updateUniforms(n,r),u.dirty=!1),i.setupCullMode(!0,l,h),u.setParameters(n),h.setParameters(n,4);const f=h.getShaderInstance(a,0,r,o,this.viewUniformFormat,this.viewBindGroupFormat),p=f.shader;if(p.failed)continue;h._sortKeyShadow=p.id,n.setShader(p),i.setVertexBuffers(n,c),i.setMorphing(n,h.morphInstance),d&&n.setVertexBuffer(d.vertexBuffer),i.setMeshInstanceMatrices(h),i.setupMeshUniformBuffers(f);const m=h.renderStyle,g=h.getDrawCommands(s);n.draw(c.primitive[m],c.indexBuffer[m],d?.count,g),i._shadowDrawCalls++,d&&i._instancedDrawCalls++}}needsShadowRendering(t){const e=t.enabled&&t.castShadows&&0!==t.shadowUpdateMode&&t.visibleThisFrame;return 1===t.shadowUpdateMode&&(t.shadowUpdateMode=0),e&&(this.renderer._shadowMapUpdates+=t.numShadowFaces),e}getLightRenderData(t,e,s){return t.getRenderData(0===t._type?e:null,s)}setupRenderPass(t,e,s){const n=e.renderTarget;t.init(n),t.depthStencilOps.clearDepthValue=1,t.depthStencilOps.clearDepth=s,n.depthBuffer?t.depthStencilOps.storeDepth=!0:(t.colorOps.clearValue.copy(e.clearColor),t.colorOps.clear=s,t.depthStencilOps.storeDepth=!1),t.requiresCubemaps=!1}prepareFace(t,e,s){const n=t._type,i=this.getLightRenderData(t,e,s).shadowCamera,r=0===n?0:s;return i.renderTarget=t._shadowMap.renderTargets[r],i}renderFace(t,e,s,n,i=!0){const r=this.device,a=this.getLightRenderData(t,e,s),o=a.shadowCamera;this.dispatchUniforms(t,o,a,s);const l=o.renderTarget,h=this.renderer;h.setCameraUniforms(o,l),r.supportsUniformBuffers&&h.setupViewUniformBuffers(a.viewBindGroups,this.viewUniformFormat,this.viewBindGroupFormat,null),i?(h.setupViewport(o,l),n&&h.clear(o)):h.clearView(o,l,!0,!1),this.setupRenderState(r,t),this.submitCasters(a.visibleCasters,t,o)}render(t,e,s=!0){if(this.needsShadowRendering(t)){const n=t.numShadowFaces;for(let i=0;i<n;i++)this.prepareFace(t,e,i),this.renderFace(t,e,i,!0,s);this.renderVsm(t,e)}}renderVsm(t,e){if(t._isVsm&&t._vsmBlurSize>1){this.renderer.scene.clusteredLightingEnabled&&0!==t._type||this.applyVsmBlur(t,e)}}getVsmBlurShader(t,e){const s=this.blurVsmShader;let n=s[t][e];if(!n){this.blurVsmWeights[e]=function(t){const e=(t-1)/6,s=.5*(t-1),n=new Array(t);let i=0;for(let r=0;r<t;++r)n[r]=Gd(r-s,e),i+=n[r];for(let e=0;e<t;++e)n[e]/=i;return n}(e);const i=new Map;i.set("{SAMPLES}",e),1===t&&i.set("GAUSS",""),n=zh.createShader(this.device,{uniqueName:`blurVsm${t}${e}`,attributes:{vertex_position:Ys},vertexChunk:"fullscreenQuadVS",fragmentChunk:"blurVSMPS",fragmentDefines:i}),s[t][e]=n}return n}applyVsmBlur(t,e){const s=this.device;s.setBlendState(Ti.NOBLEND);const n=t.getRenderData(0===t._type?e:null,0).shadowCamera.renderTarget,i=this.renderer.shadowMapCache.get(s,t),r=i.renderTargets[0],a=t.vsmBlurMode,o=t._vsmBlurSize,l=this.getVsmBlurShader(a,o);Vd.z=t._shadowResolution-2,Vd.w=Vd.z,this.sourceId.setValue(n.colorBuffer),Ud[0]=1/t._shadowResolution,Ud[1]=0,this.pixelOffsetId.setValue(Ud),1===a&&this.weightId.setValue(this.blurVsmWeights[o]),Xh(s,r,l,null,Vd),this.sourceId.setValue(r.colorBuffer),Ud[1]=Ud[0],Ud[0]=0,this.pixelOffsetId.setValue(Ud),Xh(s,n,l,null,Vd),this.renderer.shadowMapCache.add(t,i)}initViewBindGroupFormat(){this.device.supportsUniformBuffers&&!this.viewUniformFormat&&(this.viewUniformFormat=new Dr(this.device,[new Ar("matrix_viewProjection",kn)]),this.viewBindGroupFormat=new ci(this.device,[new ai(Yn,3)]))}frameUpdate(){this.initViewBindGroupFormat()}}const jd=[];class $d{constructor(t){this._empty=null,this._allocated=[],this._clusters=new Map,this.device=t}destroy(){this._empty&&(this._empty.destroy(),this._empty=null),this._allocated.forEach(t=>{t.destroy()}),this._allocated.length=0}get count(){return this._allocated.length}get empty(){if(!this._empty){const t=new od(this.device);t.name="ClusterEmpty",t.update([]),this._empty=t}return this._empty}assign(t){jd.push(...this._allocated),this._allocated.length=0,this._clusters.clear();const e=t.length;for(let s=0;s<e;s++){const e=t[s].renderActions;if(e){const t=e.length;for(let s=0;s<t;s++){const t=e[s];t.lightClusters=null;const n=t.layer;if(n.hasClusteredLights&&n.meshInstances.length){const e=n.getLightIdHash(),s=this._clusters.get(e);let i=s?.lightClusters;i||(i=jd.pop()??new od(this.device),this._allocated.push(i),this._clusters.set(e,t)),t.lightClusters=i}t.lightClusters||(t.lightClusters=this.empty)}}}jd.forEach(t=>t.destroy()),jd.length=0}update(t,e){this.assign(t),this._clusters.forEach(t=>{const s=t.layer;t.lightClusters.update(s.clusteredLightsSet,e)})}}const Xd=new ls,qd=[];class Kd extends Fo{constructor(t,e){super(t),this._quadRenderer2D=null,this._quadRendererCube=null,this._filteredLights=[],this._forceCopy=!1,this._evtDeviceRestored=null,this._cubeSlotsOffsets=e,this.requiresCubemaps=!1,this.blitTextureId=t.scope.resolve("blitTexture"),this.invViewProjId=t.scope.resolve("invViewProj"),this._evtDeviceRestored=t.on("devicerestored",this.onDeviceRestored,this)}destroy(){this._quadRenderer2D?.destroy(),this._quadRenderer2D=null,this._quadRendererCube?.destroy(),this._quadRendererCube=null,this._evtDeviceRestored?.off(),this._evtDeviceRestored=null}static create(t,e){const s=new Kd(t.device,e);return s.init(t),s.colorOps.clear=!1,s.depthStencilOps.clearDepth=!1,s}onDeviceRestored(){this._forceCopy=!0}update(t){const e=this._filteredLights;this.filter(t,e),this.executeEnabled=e.length>0}filter(t,e){for(let s=0;s<t.length;s++){const n=t[s];0!==n._type&&(n.atlasViewportAllocated&&(n.atlasSlotUpdated||this._forceCopy)&&n.enabled&&n.cookie&&n.visibleThisFrame&&e.push(n))}this._forceCopy=!1}initInvViewProjMatrices(){if(!qd.length)for(let t=0;t<6;t++){const e=$c.create(null,1,t),s=e.projectionMatrix,n=e.node.getLocalTransform().clone().invert();qd[t]=(new ps).mul2(s,n).invert()}}get quadRenderer2D(){if(!this._quadRenderer2D){const t=zh.createShader(this.device,{uniqueName:"cookieRenderer2d",attributes:{vertex_position:Ys},vertexChunk:"cookieBlitVS",fragmentChunk:"cookieBlit2DPS"});this._quadRenderer2D=new Wh(t)}return this._quadRenderer2D}get quadRendererCube(){if(!this._quadRendererCube){const t=zh.createShader(this.device,{uniqueName:"cookieRendererCube",attributes:{vertex_position:Ys},vertexChunk:"cookieBlitVS",fragmentChunk:"cookieBlitCubePS"});this._quadRendererCube=new Wh(t)}return this._quadRendererCube}execute(){const t=this.device;t.setBlendState(Ti.NOBLEND),t.setCullMode(0),t.setDepthState(Ai.NODEPTH),t.setStencilState();const e=this.renderTarget.colorBuffer.width,s=this._cubeSlotsOffsets,n=this._filteredLights;for(let t=0;t<n.length;t++){const i=n[t],r=i.numShadowFaces,a=r>1?this.quadRendererCube:this.quadRenderer2D;r>1&&this.initInvViewProjMatrices(),this.blitTextureId.setValue(i.cookie);for(let t=0;t<r;t++){if(Xd.copy(i.atlasViewport),r>1){const e=Xd.z/3,n=s[t];Xd.x+=e*n.x,Xd.y+=e*n.y,Xd.z=e,Xd.w=e,this.invViewProjId.setValue(qd[t].data)}Xd.mulScalar(e),a.render(Xd)}}n.length=0}}class Yd extends Fo{constructor(t,e,s){super(t),this.requiresCubemaps=!1,this.shadowRenderer=e,this.shadowRendererLocal=s}update(t){const e=this.shadowRendererLocal.shadowLights,s=this.shadowRendererLocal.prepareLights(e,t),n=e.length;this.enabled=n>0,n&&this.shadowRenderer.setupRenderPass(this,s,!1)}execute(){const t=this.shadowRendererLocal.shadowLights,e=t.length;for(let s=0;s<e;s++){const e=t[s];for(let t=0;t<e.numShadowFaces;t++)this.shadowRenderer.renderFace(e,null,t,!0)}t.length=0}}class Qd extends Fo{constructor(t,e,s,n,i){super(t),this.renderer=e,this.frameGraph=null,this.cookiesRenderPass=Kd.create(i.cookieRenderTarget,i.cubeSlotsOffsets),this.beforePasses.push(this.cookiesRenderPass),this.shadowRenderPass=new Yd(t,s,n),this.beforePasses.push(this.shadowRenderPass)}update(t,e,s,n,i){this.frameGraph=t,this.cookiesRenderPass.enabled=s,s&&this.cookiesRenderPass.update(n),this.shadowRenderPass.enabled=e,e&&this.shadowRenderPass.update(i)}destroy(){this.cookiesRenderPass.destroy(),this.cookiesRenderPass=null}execute(){const{renderer:t}=this,{scene:e}=t;t.worldClustersAllocator.update(this.frameGraph.renderPasses,e.lighting)}}let Zd=0;const Jd=new ps,tu=new ps,eu=new ps,su=new as,nu=new Ts,iu=(new ps).setScale(1,-1,1),ru=new Set,au=new Set,ou=new bi,lu=(new ps).set([1,0,0,0,0,1,0,0,0,0,.5,0,0,0,.5,1]),hu=[new os(.5,.333333),new os(.25,.666667),new os(.75,.111111),new os(.125,.444444),new os(.625,.777778),new os(.375,.222222),new os(.875,.555556),new os(.0625,.888889),new os(.5625,.037037),new os(.3125,.37037),new os(.8125,.703704),new os(.1875,.148148),new os(.6875,.481481),new os(.4375,.814815),new os(.9375,.259259),new os(.03125,.592593)],cu=new ps,du=new ps,uu=new ps,fu=new ps,pu=new ps,mu=new ps,gu=new Set,_u=[],vu=[];class yu{constructor(t,e){this.clustersDebugRendered=!1,this.processingMeshInstances=new Set,this.lights=[],this.localLights=[],this.cameraDirShadowLights=new Map,this.dirLightShadows=new Map,this.blueNoise=new dd(123),this.gsplatDirector=null,this.device=t,this.scene=e,this.worldClustersAllocator=new $d(t),this.lightTextureAtlas=new xd(t),this.shadowMapCache=new Ed,this.shadowRenderer=new Wd(this,this.lightTextureAtlas),this._shadowRendererLocal=new Dd(this,this.shadowRenderer),this._shadowRendererDirectional=new Fd(this,this.shadowRenderer),this.scene.clusteredLightingEnabled&&(this._renderPassUpdateClustered=new Qd(this.device,this,this.shadowRenderer,this._shadowRendererLocal,this.lightTextureAtlas)),this.viewUniformFormat=null,this.viewBindGroupFormat=null,this._skinTime=0,this._morphTime=0,this._cullTime=0,this._shadowMapTime=0,this._lightClustersTime=0,this._layerCompositionUpdateTime=0,this._shadowDrawCalls=0,this._skinDrawCalls=0,this._instancedDrawCalls=0,this._shadowMapUpdates=0,this._numDrawCallsCulled=0,this._camerasRendered=0,this._lightClusters=0,this._gsplatCount=0;const s=t.scope;this.boneTextureId=s.resolve("texture_poseMap"),this.modelMatrixId=s.resolve("matrix_model"),this.normalMatrixId=s.resolve("matrix_normal"),this.viewInvId=s.resolve("matrix_viewInverse"),this.viewPos=new Float32Array(3),this.viewPosId=s.resolve("view_position"),this.projId=s.resolve("matrix_projection"),this.projSkyboxId=s.resolve("matrix_projectionSkybox"),this.viewId=s.resolve("matrix_view"),this.viewId3=s.resolve("matrix_view3"),this.viewProjId=s.resolve("matrix_viewProjection"),this.flipYId=s.resolve("projectionFlipY"),this.tbnBasis=s.resolve("tbnBasis"),this.nearClipId=s.resolve("camera_near"),this.farClipId=s.resolve("camera_far"),this.cameraParams=new Float32Array(4),this.cameraParamsId=s.resolve("camera_params"),this.viewIndexId=s.resolve("view_index"),this.viewIndexId.setValue(0),this.blueNoiseJitterVersion=0,this.blueNoiseJitterVec=new ls,this.blueNoiseJitterData=new Float32Array(4),this.blueNoiseJitterId=s.resolve("blueNoiseJitter"),this.blueNoiseTextureId=s.resolve("blueNoiseTex32"),this.alphaTestId=s.resolve("alpha_ref"),this.opacityMapId=s.resolve("texture_opacityMap"),this.exposureId=s.resolve("exposure"),this.twoSidedLightingNegScaleFactorId=s.resolve("twoSidedLightingNegScaleFactor"),this.twoSidedLightingNegScaleFactorId.setValue(0),this.morphPositionTex=s.resolve("morphPositionTex"),this.morphNormalTex=s.resolve("morphNormalTex"),this.morphTexParams=s.resolve("morph_tex_params"),this.lightCube=new fd,this.constantLightCube=s.resolve("lightCube[0]")}destroy(){this.shadowRenderer=null,this._shadowRendererLocal=null,this._shadowRendererDirectional=null,this.shadowMapCache.destroy(),this.shadowMapCache=null,this._renderPassUpdateClustered?.destroy(),this._renderPassUpdateClustered=null,this.lightTextureAtlas.destroy(),this.lightTextureAtlas=null,this.gsplatDirector?.destroy(),this.gsplatDirector=null}setupViewport(t,e){const s=this.device,n=e?e.width:s.width,i=e?e.height:s.height,r=t.rect;let a=Math.floor(r.x*n),o=Math.floor(r.y*i),l=Math.floor(r.z*n),h=Math.floor(r.w*i);if(s.setViewport(a,o,l,h),t._scissorRectClear){const e=t.scissorRect;a=Math.floor(e.x*n),o=Math.floor(e.y*i),l=Math.floor(e.z*n),h=Math.floor(e.w*i)}s.setScissor(a,o,l,h)}setCameraUniforms(t,e){const s=e?.flipY;let n=null;if(t.xr&&t.xr.session){const e=t._node?.parent?.getWorldTransform()||null;n=t.xr.views.list;for(let s=0;s<n.length;s++){const i=n[s];i.updateTransforms(e),t.frustum.setFromMat4(i.projViewOffMat)}}else{let n=t.projectionMatrix;t.calculateProjection&&t.calculateProjection(n,0);let i=t.getProjectionMatrixSkybox();s&&(n=cu.mul2(iu,n),i=du.mul2(iu,i)),this.device.isWebGPU&&(n=uu.mul2(lu,n),i=fu.mul2(lu,i));const{jitter:r}=t;let a=0,o=0;if(r>0){const t=e?e.width:this.device.width,s=e?e.height:this.device.height,l=hu[this.device.renderVersion%hu.length];a=r*(2*l.x-1)/t,o=r*(2*l.y-1)/s,n=pu.copy(n),n.data[8]=a,n.data[9]=o,i=mu.copy(i),i.data[8]=a,i.data[9]=o,this.blueNoiseJitterVersion!==this.device.renderVersion&&(this.blueNoiseJitterVersion=this.device.renderVersion,this.blueNoise.vec4(this.blueNoiseJitterVec))}const l=r>0?this.blueNoiseJitterVec:ls.ZERO;if(this.blueNoiseJitterData[0]=l.x,this.blueNoiseJitterData[1]=l.y,this.blueNoiseJitterData[2]=l.z,this.blueNoiseJitterData[3]=l.w,this.blueNoiseJitterId.setValue(this.blueNoiseJitterData),this.projId.setValue(n.data),this.projSkyboxId.setValue(i.data),t.calculateTransform)t.calculateTransform(tu,0);else{const e=t._node.getPosition(),s=t._node.getRotation();tu.setTRS(e,s,rs.ONE)}this.viewInvId.setValue(tu.data),eu.copy(tu).invert(),this.viewId.setValue(eu.data),su.setFromMat4(eu),this.viewId3.setValue(su.data),Jd.mul2(n,eu),this.viewProjId.setValue(Jd.data),t._storeShaderMatrices(Jd,a,o,this.device.renderVersion),this.flipYId.setValue(s?-1:1),this.dispatchViewPos(t._node.getPosition()),t.frustum.setFromMat4(Jd)}this.tbnBasis.setValue(s?-1:1);const i=t._nearClip,r=t._farClip;return this.nearClipId.setValue(i),this.farClipId.setValue(r),this.cameraParams[0]=1/r,this.cameraParams[1]=r,this.cameraParams[2]=i,this.cameraParams[3]=1===t.projection?1:0,this.cameraParamsId.setValue(this.cameraParams),this.exposureId.setValue(this.scene.physicalUnits?t.getExposure():this.scene.exposure),n}clear(t,e,s,n){const i=(e??t._clearColorBuffer?1:0)|(s??t._clearDepthBuffer?2:0)|(n??t._clearStencilBuffer?4:0);if(i){this.device.clear({color:[t._clearColor.r,t._clearColor.g,t._clearColor.b,t._clearColor.a],depth:t._clearDepth,stencil:t._clearStencil,flags:i})}}setCamera(t,e,s,n=null){this.setCameraUniforms(t,e),this.clearView(t,e,s,!1)}clearView(t,e,s,n){const i=this.device;if(i.setRenderTarget(e),i.updateBegin(),n&&(i.setColorWrite(!0,!0,!0,!0),i.setDepthWrite(!0)),this.setupViewport(t,e),s){const e=t._clearOptions;i.clear(e||{color:[t._clearColor.r,t._clearColor.g,t._clearColor.b,t._clearColor.a],depth:t._clearDepth,flags:(t._clearColorBuffer?1:0)|(t._clearDepthBuffer?2:0)|(t._clearStencilBuffer?4:0),stencil:t._clearStencil})}}setupCullMode(t,e,s){const n=s.material;let i=0;if(t){let t=1;2!==n.cull&&1!==n.cull||(t=e*s.flipFacesFactor*s.node.worldScaleSign),i=t<0?2===n.cull?1:2:n.cull}this.device.setCullMode(i),0===i&&0===n.cull&&this.twoSidedLightingNegScaleFactorId.setValue(s.node.worldScaleSign)}updateCameraFrustum(t){if(t.xr&&t.xr.views.list.length){const e=t.xr.views.list[0];return Jd.mul2(e.projMat,e.viewOffMat),void t.frustum.setFromMat4(Jd)}const e=t.projectionMatrix;if(t.calculateProjection&&t.calculateProjection(e,0),t.calculateTransform)t.calculateTransform(tu,0);else{const e=t._node.getPosition(),s=t._node.getRotation();tu.setTRS(e,s,rs.ONE),this.viewInvId.setValue(tu.data)}eu.copy(tu).invert(),Jd.mul2(e,eu),t.frustum.setFromMat4(Jd)}setBaseConstants(t,e){t.setCullMode(e.cull),e.opacityMap&&this.opacityMapId.setValue(e.opacityMap),(e.opacityMap||e.alphaTest>0)&&this.alphaTestId.setValue(e.alphaTest)}updateCpuSkinMatrices(t){Zd++;const e=t.length;if(0!==e)for(let s=0;s<e;s++){const e=t[s].skinInstance;e&&(e.updateMatrices(t[s].node,Zd),e._dirty=!0)}}updateGpuSkinMatrices(t){for(const e of t){const t=e.skinInstance;t&&t._dirty&&(t.updateMatrixPalette(e.node,Zd),t._dirty=!1)}}updateMorphing(t){for(const e of t){const t=e.morphInstance;t&&t._dirty&&t.update()}}updateGSplats(t){for(const e of t)e.gsplatInstance?.update()}gpuUpdate(t){this.updateGpuSkinMatrices(t),this.updateMorphing(t),this.updateGSplats(t)}setVertexBuffers(t,e){t.setVertexBuffer(e.vertexBuffer)}setMorphing(t,e){e&&(e.prepareRendering(t),t.setVertexBuffer(e.morph.vertexBufferIds),this.morphPositionTex.setValue(e.texturePositions),this.morphNormalTex.setValue(e.textureNormals),this.morphTexParams.setValue(e._textureParams))}setSkinning(t,e){const s=e.skinInstance;if(s){this._skinDrawCalls++;const t=s.boneTexture;this.boneTextureId.setValue(t)}}dispatchViewPos(t){const e=this.viewPos;e[0]=t.x,e[1]=t.y,e[2]=t.z,this.viewPosId.setValue(e)}initViewBindGroupFormat(t){if(this.device.supportsUniformBuffers&&!this.viewUniformFormat){const e=[new Ar("matrix_view",kn),new Ar("matrix_viewInverse",kn),new Ar("matrix_projection",kn),new Ar("matrix_projectionSkybox",kn),new Ar("matrix_viewProjection",kn),new Ar("matrix_view3",Mn),new Ar("cubeMapRotationMatrix",Mn),new Ar("view_position",4),new Ar("skyboxIntensity",2),new Ar("exposure",2),new Ar("textureBias",2),new Ar("view_index",2)];t&&e.push(new Ar("clusterCellsCountByBoundsSize",4),new Ar("clusterTextureSize",4),new Ar("clusterBoundsMin",4),new Ar("clusterBoundsDelta",4),new Ar("clusterCellsDot",4),new Ar("clusterCellsMax",4),new Ar("shadowAtlasParams",3),new Ar("clusterMaxCells",1),new Ar("clusterSkip",2)),this.viewUniformFormat=new Dr(this.device,e);const s=[new ai(Yn,3)];this.viewBindGroupFormat=new ci(this.device,s)}}setupViewUniforms(t,e){this.projId.setValue(t.projMat.data),this.projSkyboxId.setValue(t.projMat.data),this.viewId.setValue(t.viewOffMat.data),this.viewInvId.setValue(t.viewInvOffMat.data),this.viewId3.setValue(t.viewMat3.data),this.viewProjId.setValue(t.projViewOffMat.data),this.viewPosId.setValue(t.positionData),this.viewIndexId.setValue(e)}setupViewUniformBuffers(t,e,s,n){const{device:i}=this,r=n?.length??1;for(;t.length<r;){const n=new Ua(i,e,!1),r=new Si(i,s,n);t.push(r)}if(n)for(let e=0;e<r;e++){const s=n[e];this.setupViewUniforms(s,e);const i=t[e];i.defaultUniformBuffer.update(),i.update()}else{const e=t[0];e.defaultUniformBuffer.update(),e.update()}n||i.setBindGroup(0,t[0])}setupMeshUniformBuffers(t){const e=this.device;if(e.supportsUniformBuffers){const s=t.getBindGroup(e);s.update(),e.setBindGroup(1,s);t.getUniformBuffer(e).update(ou),e.setBindGroup(2,ou.bindGroup,ou.offsets)}}setMeshInstanceMatrices(t,e=!1){const s=t.node.worldTransform;this.modelMatrixId.setValue(s.data),e&&this.normalMatrixId.setValue(t.node.normalMatrix.data)}cull(t,e,s){const n=s.opaque;n.length=0;const i=s.transparent;i.length=0;const r=t.frustumCulling,a=e.length;for(let s=0;s<a;s++){const a=e[s];if(a.visible){if(!r||!a.cull||a._isVisible(t)){a.visibleThisFrame=!0;(a.transparent?i:n).push(a),(a.skinInstance||a.morphInstance||a.gsplatInstance)&&(this.processingMeshInstances.add(a),a.gsplatInstance&&a.gsplatInstance.cameras.push(t))}}}}collectLights(t){this.lights.length=0,this.localLights.length=0;const e=this.scene._stats,s=t.layerList.length;for(let e=0;e<s;e++){const s=t.layerList[e];if(!au.has(s)){au.add(s);const t=s._lights;for(let e=0;e<t.length;e++){const s=t[e];ru.has(s)||(ru.add(s),this.lights.push(s),0!==s._type&&this.localLights.push(s))}}}e.lights=this.lights.length,ru.clear(),au.clear()}cullLights(t,e){const s=this.scene.clusteredLightingEnabled,n=this.scene.physicalUnits;for(let i=0;i<e.length;i++){const r=e[i];if(r.enabled)if(0!==r._type)if(r.getBoundingSphere(nu),t.frustum.containsSphere(nu)){r.visibleThisFrame=!0,r.usePhysicalUnits=n;const e=t.getScreenSize(nu);r.maxScreenSize=Math.max(r.maxScreenSize,e)}else s||r.castShadows&&!r.shadowMap&&(r.visibleThisFrame=!0);else r.usePhysicalUnits=this.scene.physicalUnits}}cullShadowmaps(t){const e=this.scene.clusteredLightingEnabled;for(let s=0;s<this.localLights.length;s++){const n=this.localLights[s];0!==n._type&&(e?n.atlasSlotUpdated&&0===n.shadowUpdateMode&&(n.shadowUpdateMode=1):0===n.shadowUpdateMode&&n.castShadows&&(n.getRenderData(null,0).shadowCamera.renderTarget||(n.shadowUpdateMode=1)),n.visibleThisFrame&&n.castShadows&&0!==n.shadowUpdateMode&&this._shadowRendererLocal.cull(n,t))}this.cameraDirShadowLights.clear();const s=t.cameras;for(let e=0;e<s.length;e++){const n=s[e];if(n.enabled){const e=n.camera;let s;const i=e.layers;for(let n=0;n<i.length;n++){const r=t.getLayerById(i[n]);if(r){const n=r.splitLights[0];for(let i=0;i<n.length;i++){const r=n[i];r.castShadows&&!gu.has(r)&&(gu.add(r),s=s??[],s.push(r),this._shadowRendererDirectional.cull(r,t,e))}}}s&&this.cameraDirShadowLights.set(e,s),gu.clear()}}}cullComposition(t){const{scene:e}=this;this.processingMeshInstances.clear();const s=t.cameras.length;this._camerasRendered+=s;for(let n=0;n<s;n++){const s=t.cameras[n];e?.fire(Ch,s);const i=s.renderTarget;s.frameUpdate(i),this.updateCameraFrustum(s.camera);const r=s.layers;for(let e=0;e<r.length;e++){const n=t.getLayerById(r[e]);if(n&&n.enabled){this.cullLights(s.camera,n._lights);const t=n.getCulledInstances(s.camera);this.cull(s.camera,n.meshInstances,t)}}e?.fire(Eh,s)}e.clusteredLightingEnabled&&this.updateLightTextureAtlas(),this.cullShadowmaps(t),e?.fire("cull:end")}updateShaders(t,e){const s=t.length;for(let n=0;n<s;n++){const s=t[n].material;if(s&&!gu.has(s)&&(gu.add(s),s.getShaderVariant!==Cd.prototype.getShaderVariant)){if(e&&(!s.useLighting||s.emitter&&!s.emitter.lighting))continue;s.clearVariants()}}gu.clear()}updateFrameUniforms(){this.blueNoiseTextureId.setValue(md(this.device))}beginFrame(t){const e=this.scene,s=e.updateShaders||this.device._shadersDirty,n=t.layerList,i=n.length;for(let t=0;t<i;t++){const e=n[t].meshInstances,i=e.length;for(let t=0;t<i;t++){const n=e[t];n.visibleThisFrame=!1,s&&_u.push(n),n.skinInstance&&vu.push(n)}}if(s){const t=!e.updateShaders||!this.device._shadersDirty;this.updateShaders(_u,t),e.updateShaders=!1,this.device._shadersDirty=!1,e._shaderVersion++}this.updateFrameUniforms(),this.updateCpuSkinMatrices(vu),_u.length=0,vu.length=0;const r=this.lights,a=r.length;for(let t=0;t<a;t++)r[t].beginFrame()}updateLightTextureAtlas(){this.lightTextureAtlas.update(this.localLights,this.scene.lighting)}updateLayerComposition(t){const e=t.layerList.length,s=this.scene._shaderVersion;for(let n=0;n<e;n++){t.layerList[n]._shaderVersion=s}t._update()}frameUpdate(){this.clustersDebugRendered=!1,this.initViewBindGroupFormat(this.scene.clusteredLightingEnabled),this.dirLightShadows.clear()}}class bu{constructor(){this.camera=null,this.layer=null,this.transparent=!1,this.renderTarget=null,this.lightClusters=null,this.clearColor=!1,this.clearDepth=!1,this.clearStencil=!1,this.triggerPostprocess=!1,this.firstCameraUse=!1,this.lastCameraUse=!1,this.viewBindGroups=[],this.useCameraPasses=!1}destroy(){this.viewBindGroups.forEach(t=>{t.defaultUniformBuffer.destroy(),t.destroy()}),this.viewBindGroups.length=0}setupClears(t,e){this.clearColor=t?.clearColorBuffer||e.clearColorBuffer,this.clearDepth=t?.clearDepthBuffer||e.clearDepthBuffer,this.clearStencil=t?.clearStencilBuffer||e.clearStencilBuffer}}class Su extends Fo{constructor(t,e,s,n){super(t),this.renderActions=[],this.noDepthClear=!1,this.layerComposition=e,this.scene=s,this.renderer=n}get rendersAnything(){return this.renderActions.length>0}addRenderAction(t){this.renderActions.push(t)}addLayer(t,e,s,n=!0){const i=new bu;if(i.renderTarget=this.renderTarget,i.camera=t,i.layer=e,i.transparent=s,n){const s=0===this.renderActions.length;i.setupClears(s?t:void 0,e)}this.addRenderAction(i)}addLayers(t,e,s,n,i,r=!0){const{layerList:a,subLayerList:o}=t;let l=n,h=s;for(;h<a.length;){const t=a[h],s=o[h];if(e.camera.layersSet.has(t.id)&&(this.addLayer(e,t,s,l),l=!1),h++,t.id===i&&s===r)break}return h}updateDirectionalShadows(){const{renderer:t,renderActions:e}=this;for(let s=0;s<e.length;s++){const n=e[s].camera.camera,i=this.renderer.cameraDirShadowLights.get(n);if(i)for(let e=0;e<i.length;e++){const s=i[e];if(t.dirLightShadows.get(s)!==n){t.dirLightShadows.set(s,n);const e=t._shadowRendererDirectional.getLightRenderPass(s,n);e&&this.beforePasses.push(e)}}}}updateClears(){const t=this.renderActions[0];if(t){const e=t.camera.camera,s=e.fullSizeClearRect;this.setClearColor(s&&t.clearColor?e.clearColor:void 0),this.setClearDepth(s&&t.clearDepth&&!this.noDepthClear?e.clearDepth:void 0),this.setClearStencil(s&&t.clearStencil?e.clearStencil:void 0)}}frameUpdate(){super.frameUpdate(),this.updateDirectionalShadows(),this.updateClears()}before(){const{renderActions:t}=this;for(let e=0;e<t.length;e++){const s=t[e];s.firstCameraUse&&this.scene.fire(wh,s.camera)}}execute(){const{layerComposition:t,renderActions:e}=this;for(let s=0;s<e.length;s++){const n=e[s],i=n.layer;t.isEnabled(i,n.transparent)&&this.renderRenderAction(n,0===s)}}after(){for(let t=0;t<this.renderActions.length;t++){const e=this.renderActions[t];e.lastCameraUse&&this.scene.fire(Th,e.camera)}this.beforePasses.length=0}renderRenderAction(t,e){const{renderer:s,scene:n}=this,i=s.device,{layer:r,transparent:a,camera:o}=t;if(o){const l=o.gammaCorrection,h=o.toneMapping;void 0!==this.gammaCorrection&&(o.gammaCorrection=this.gammaCorrection),void 0!==this.toneMapping&&(o.toneMapping=this.toneMapping),n.fire("prerender:layer",o,r,a);const c={lightClusters:t.lightClusters},d=o.camera.shaderPassInfo?.index??0;e&&o.camera.fullSizeClearRect||(c.clearColor=t.clearColor,c.clearDepth=t.clearDepth,c.clearStencil=t.clearStencil);const u=t.renderTarget??i.backBuffer;s.renderForwardLayer(o.camera,u,r,a,d,t.viewBindGroups,c),i.setBlendState(Ti.NOBLEND),i.setStencilState(null,null),i.setAlphaToCoverage(!1),n.fire("postrender:layer",o,r,a),void 0!==this.gammaCorrection&&(o.gammaCorrection=l),void 0!==this.toneMapping&&(o.toneMapping=h)}}}class xu extends Fo{constructor(t,e,s){super(t),this.renderer=e,this.renderAction=s,this.requiresCubemaps=!1}execute(){this.renderAction.camera.onPostprocessing()}}const wu=[[],[],[]],Tu=new Ze,Cu={drawCalls:[],shaderInstances:[],isNewMaterial:[],lightMaskChanged:[],clear:function(){this.drawCalls.length=0,this.shaderInstances.length=0,this.isNewMaterial.length=0,this.lightMaskChanged.length=0}};class Eu extends yu{constructor(t,e){super(t,e);const s=this.device;this._forwardDrawCalls=0,this._materialSwitches=0,this._depthMapTime=0,this._forwardTime=0,this._sortTime=0;const n=s.scope;this.fogColorId=n.resolve("fog_color"),this.fogStartId=n.resolve("fog_start"),this.fogEndId=n.resolve("fog_end"),this.fogDensityId=n.resolve("fog_density"),this.ambientId=n.resolve("light_globalAmbient"),this.skyboxIntensityId=n.resolve("skyboxIntensity"),this.cubeMapRotationMatrixId=n.resolve("cubeMapRotationMatrix"),this.pcssDiskSamplesId=n.resolve("pcssDiskSamples[0]"),this.pcssSphereSamplesId=n.resolve("pcssSphereSamples[0]"),this.lightColorId=[],this.lightDir=[],this.lightDirId=[],this.lightShadowMapId=[],this.lightShadowMatrixId=[],this.lightShadowParamsId=[],this.lightShadowIntensity=[],this.lightRadiusId=[],this.lightPos=[],this.lightPosId=[],this.lightWidth=[],this.lightWidthId=[],this.lightHeight=[],this.lightHeightId=[],this.lightInAngleId=[],this.lightOutAngleId=[],this.lightCookieId=[],this.lightCookieIntId=[],this.lightCookieMatrixId=[],this.lightCookieOffsetId=[],this.lightShadowSearchAreaId=[],this.lightCameraParamsId=[],this.lightSoftShadowParamsId=[],this.shadowMatrixPaletteId=[],this.shadowCascadeDistancesId=[],this.shadowCascadeCountId=[],this.shadowCascadeBlendId=[],this.screenSizeId=n.resolve("uScreenSize"),this._screenSize=new Float32Array(4),this.fogColor=new Float32Array(3),this.ambientColor=new Float32Array(3),this.pcssDiskSamples=function(t){const e=[];for(let s=0;s<t;++s){const n=Math.sqrt(s+.5)/Math.sqrt(t);e.push(n)}return e}(16),this.pcssSphereSamples=function(t){const e=[];for(let s=0;s<t;s++){const n=s/t,i=Math.sqrt(n*n);e.push(i)}return e}(16)}destroy(){super.destroy()}dispatchGlobalLights(t){const e=this.ambientColor;if(Tu.linear(t.ambientLight),e[0]=Tu.r,e[1]=Tu.g,e[2]=Tu.b,t.physicalUnits)for(let s=0;s<3;s++)e[s]*=t.ambientLuminance;this.ambientId.setValue(e),this.skyboxIntensityId.setValue(t.physicalUnits?t.skyboxLuminance:t.skyboxIntensity),this.cubeMapRotationMatrixId.setValue(t._skyboxRotationMat3.data)}_resolveLight(t,e){const s=`light${e}`;this.lightColorId[e]=t.resolve(`${s}_color`),this.lightDir[e]=new Float32Array(3),this.lightDirId[e]=t.resolve(`${s}_direction`),this.lightShadowMapId[e]=t.resolve(`${s}_shadowMap`),this.lightShadowMatrixId[e]=t.resolve(`${s}_shadowMatrix`),this.lightShadowParamsId[e]=t.resolve(`${s}_shadowParams`),this.lightShadowIntensity[e]=t.resolve(`${s}_shadowIntensity`),this.lightShadowSearchAreaId[e]=t.resolve(`${s}_shadowSearchArea`),this.lightRadiusId[e]=t.resolve(`${s}_radius`),this.lightPos[e]=new Float32Array(3),this.lightPosId[e]=t.resolve(`${s}_position`),this.lightWidth[e]=new Float32Array(3),this.lightWidthId[e]=t.resolve(`${s}_halfWidth`),this.lightHeight[e]=new Float32Array(3),this.lightHeightId[e]=t.resolve(`${s}_halfHeight`),this.lightInAngleId[e]=t.resolve(`${s}_innerConeAngle`),this.lightOutAngleId[e]=t.resolve(`${s}_outerConeAngle`),this.lightCookieId[e]=t.resolve(`${s}_cookie`),this.lightCookieIntId[e]=t.resolve(`${s}_cookieIntensity`),this.lightCookieMatrixId[e]=t.resolve(`${s}_cookieMatrix`),this.lightCookieOffsetId[e]=t.resolve(`${s}_cookieOffset`),this.lightCameraParamsId[e]=t.resolve(`${s}_cameraParams`),this.lightSoftShadowParamsId[e]=t.resolve(`${s}_softShadowParams`),this.shadowMatrixPaletteId[e]=t.resolve(`${s}_shadowMatrixPalette[0]`),this.shadowCascadeDistancesId[e]=t.resolve(`${s}_shadowCascadeDistances`),this.shadowCascadeCountId[e]=t.resolve(`${s}_shadowCascadeCount`),this.shadowCascadeBlendId[e]=t.resolve(`${s}_shadowCascadeBlend`)}setLTCDirectionalLight(t,e,s,n,i){this.lightPos[e][0]=n.x-s.x*i,this.lightPos[e][1]=n.y-s.y*i,this.lightPos[e][2]=n.z-s.z*i,this.lightPosId[e].setValue(this.lightPos[e]);const r=t.transformVector(new rs(-.5,0,0));this.lightWidth[e][0]=r.x*i,this.lightWidth[e][1]=r.y*i,this.lightWidth[e][2]=r.z*i,this.lightWidthId[e].setValue(this.lightWidth[e]);const a=t.transformVector(new rs(0,0,.5));this.lightHeight[e][0]=a.x*i,this.lightHeight[e][1]=a.y*i,this.lightHeight[e][2]=a.z*i,this.lightHeightId[e].setValue(this.lightHeight[e])}dispatchDirectLights(t,e,s){let n=0;const i=this.device.scope;for(let r=0;r<t.length;r++){if(!(t[r].mask&e))continue;const a=t[r],o=a._node.getWorldTransform();if(this.lightColorId[n]||this._resolveLight(i,n),this.lightColorId[n].setValue(a._colorLinear),o.getY(a._direction).mulScalar(-1),a._direction.normalize(),this.lightDir[n][0]=a._direction.x,this.lightDir[n][1]=a._direction.y,this.lightDir[n][2]=a._direction.z,this.lightDirId[n].setValue(this.lightDir[n]),0!==a.shape&&this.setLTCDirectionalLight(o,n,a._direction,s._node.getPosition(),s.farClip),a.castShadows){const t=a.getRenderData(s,0),e=a._getUniformBiasValues(t);this.lightShadowMapId[n].setValue(t.shadowBuffer),this.lightShadowMatrixId[n].setValue(t.shadowMatrix.data),this.shadowMatrixPaletteId[n].setValue(a._shadowMatrixPalette),this.shadowCascadeDistancesId[n].setValue(a._shadowCascadeDistances),this.shadowCascadeCountId[n].setValue(a.numCascades),this.shadowCascadeBlendId[n].setValue(1-a.cascadeBlend),this.lightShadowIntensity[n].setValue(a.shadowIntensity),this.lightSoftShadowParamsId[n].setValue(a._softShadowParams);t.shadowCamera.renderTarget&&this.lightShadowSearchAreaId[n].setValue(a.penumbraSize/t.shadowCamera.renderTarget.width*t.projectionCompensation);const i=a._shadowCameraParams;i.length=4,i[0]=0,i[1]=t.shadowCamera._farClip,i[2]=t.shadowCamera._nearClip,i[3]=1,this.lightCameraParamsId[n].setValue(i);const r=a._shadowRenderParams;r.length=4,r[0]=a._shadowResolution,r[1]=e.normalBias,r[2]=e.bias,r[3]=0,this.lightShadowParamsId[n].setValue(r)}n++}return n}setLTCPositionalLight(t,e){const s=t.transformVector(new rs(-.5,0,0));this.lightWidth[e][0]=s.x,this.lightWidth[e][1]=s.y,this.lightWidth[e][2]=s.z,this.lightWidthId[e].setValue(this.lightWidth[e]);const n=t.transformVector(new rs(0,0,.5));this.lightHeight[e][0]=n.x,this.lightHeight[e][1]=n.y,this.lightHeight[e][2]=n.z,this.lightHeightId[e].setValue(this.lightHeight[e])}dispatchOmniLight(t,e,s){const n=e._node.getWorldTransform();if(this.lightColorId[s]||this._resolveLight(t,s),this.lightRadiusId[s].setValue(e.attenuationEnd),this.lightColorId[s].setValue(e._colorLinear),n.getTranslation(e._position),this.lightPos[s][0]=e._position.x,this.lightPos[s][1]=e._position.y,this.lightPos[s][2]=e._position.z,this.lightPosId[s].setValue(this.lightPos[s]),0!==e.shape&&this.setLTCPositionalLight(n,s),e.castShadows){const t=e.getRenderData(null,0);this.lightShadowMapId[s].setValue(t.shadowBuffer);const n=e._getUniformBiasValues(t),i=e._shadowRenderParams;i.length=4,i[0]=e._shadowResolution,i[1]=n.normalBias,i[2]=n.bias,i[3]=1/e.attenuationEnd,this.lightShadowParamsId[s].setValue(i),this.lightShadowIntensity[s].setValue(e.shadowIntensity);const r=e.penumbraSize/t.shadowCamera.renderTarget.width;this.lightShadowSearchAreaId[s].setValue(r);const a=e._shadowCameraParams;a.length=4,a[0]=0,a[1]=t.shadowCamera._farClip,a[2]=t.shadowCamera._nearClip,a[3]=0,this.lightCameraParamsId[s].setValue(a)}e._cookie&&(this.lightCookieId[s].setValue(e._cookie),this.lightShadowMatrixId[s].setValue(n.data),this.lightCookieIntId[s].setValue(e.cookieIntensity))}dispatchSpotLight(t,e,s){const n=e._node.getWorldTransform();if(this.lightColorId[s]||this._resolveLight(t,s),this.lightInAngleId[s].setValue(e._innerConeAngleCos),this.lightOutAngleId[s].setValue(e._outerConeAngleCos),this.lightRadiusId[s].setValue(e.attenuationEnd),this.lightColorId[s].setValue(e._colorLinear),n.getTranslation(e._position),this.lightPos[s][0]=e._position.x,this.lightPos[s][1]=e._position.y,this.lightPos[s][2]=e._position.z,this.lightPosId[s].setValue(this.lightPos[s]),0!==e.shape&&this.setLTCPositionalLight(n,s),n.getY(e._direction).mulScalar(-1),e._direction.normalize(),this.lightDir[s][0]=e._direction.x,this.lightDir[s][1]=e._direction.y,this.lightDir[s][2]=e._direction.z,this.lightDirId[s].setValue(this.lightDir[s]),e.castShadows){const t=e.getRenderData(null,0);this.lightShadowMapId[s].setValue(t.shadowBuffer),this.lightShadowMatrixId[s].setValue(t.shadowMatrix.data);const n=e._getUniformBiasValues(t),i=e._shadowRenderParams;i.length=4,i[0]=e._shadowResolution,i[1]=n.normalBias,i[2]=n.bias,i[3]=1/e.attenuationEnd,this.lightShadowParamsId[s].setValue(i),this.lightShadowIntensity[s].setValue(e.shadowIntensity);const r=e.penumbraSize/t.shadowCamera.renderTarget.width,a=t.shadowCamera._fov*Qe.DEG_TO_RAD,o=1/Math.tan(a/2);this.lightShadowSearchAreaId[s].setValue(r*o);const l=e._shadowCameraParams;l.length=4,l[0]=0,l[1]=t.shadowCamera._farClip,l[2]=t.shadowCamera._nearClip,l[3]=0,this.lightCameraParamsId[s].setValue(l)}if(e._cookie){if(!e.castShadows){const t=$c.evalSpotCookieMatrix(e);this.lightShadowMatrixId[s].setValue(t.data)}this.lightCookieId[s].setValue(e._cookie),this.lightCookieIntId[s].setValue(e.cookieIntensity),e._cookieTransform&&(e._cookieTransformUniform[0]=e._cookieTransform.x,e._cookieTransformUniform[1]=e._cookieTransform.y,e._cookieTransformUniform[2]=e._cookieTransform.z,e._cookieTransformUniform[3]=e._cookieTransform.w,this.lightCookieMatrixId[s].setValue(e._cookieTransformUniform),e._cookieOffsetUniform[0]=e._cookieOffset.x,e._cookieOffsetUniform[1]=e._cookieOffset.y,this.lightCookieOffsetId[s].setValue(e._cookieOffsetUniform))}}dispatchLocalLights(t,e,s){let n=s;const i=this.device.scope,r=t[1],a=r.length;for(let t=0;t<a;t++){const s=r[t];s.mask&e&&(this.dispatchOmniLight(i,s,n),n++)}const o=t[2],l=o.length;for(let t=0;t<l;t++){const s=o[t];s.mask&e&&(this.dispatchSpotLight(i,s,n),n++)}}renderForwardPrepareMaterials(t,e,s,n,i,r){const a=t.fogParams??this.scene.fog,o=t.shaderParams;o.fog=a.type,o.srgbRenderTarget=e?.isColorBufferSrgb(0)??!1;const l=(t,e,s,n)=>{Cu.drawCalls.push(t),Cu.shaderInstances.push(e),Cu.isNewMaterial.push(s),Cu.lightMaskChanged.push(n)};Cu.clear();const h=this.device,c=this.scene,d=c.clusteredLightingEnabled,u=i?.getLightHash(d)??0;let f,p,m=null;const g=s.length;for(let t=0;t<g;t++){const e=s[t],i=e.instancingData;if(i&&i.count<=0)continue;e.ensureMaterial(h);const a=e.material,d=e._shaderDefs,g=e.mask;a&&a===m&&d!==f&&(m=null),a!==m&&(this._materialSwitches++,a._scene=c,a.dirty&&(a.updateUniforms(h,c),a.dirty=!1));const _=e.getShaderInstance(r,u,c,o,this.viewUniformFormat,this.viewBindGroupFormat,n);l(e,_,a!==m,!m||g!==p),m=a,f=d,p=g}return Cu}renderForwardInternal(t,e,s,n,i,r,a){const o=this.device,l=1<<n,h=r?-1:1,c=this.scene.clusteredLightingEnabled,d=t.xr?.session&&t.xr.views.list.length?t.xr.views.list:null,u=e.drawCalls.length;for(let n=0;n<u;n++){const r=e.drawCalls[n],f=e.isNewMaterial[n],p=e.lightMaskChanged[n],m=e.shaderInstances[n],g=r.material,_=r.mask;if(m.shader.failed)continue;if(f){const e=!1;if(o.setShader(m.shader,e),g.setParameters(o),p){const e=this.dispatchDirectLights(s[0],_,t);c||this.dispatchLocalLights(s,_,e)}this.alphaTestId.setValue(g.alphaTest),o.setBlendState(g.blendState),o.setDepthState(g.depthState),o.setAlphaToCoverage(g.alphaToCoverage)}this.setupCullMode(t._cullFaces,h,r);const v=r.stencilFront??g.stencilFront,y=r.stencilBack??g.stencilBack;o.setStencilState(v,y),r.setParameters(o,l),o.scope.resolve("meshInstanceId").setValue(r.id);const b=r.mesh;this.setVertexBuffers(o,b),this.setMorphing(o,r.morphInstance),this.setSkinning(o,r);const S=r.instancingData;S&&o.setVertexBuffer(S.vertexBuffer),this.setMeshInstanceMatrices(r,!0),this.setupMeshUniformBuffers(m);const x=r.renderStyle,w=b.indexBuffer[x];i?.(r,n);const T=r.getDrawCommands(t);if(d)for(let t=0;t<d.length;t++){const e=d[t];if(o.setViewport(e.viewport.x,e.viewport.y,e.viewport.z,e.viewport.w),o.supportsUniformBuffers){const e=a[t];o.setBindGroup(0,e)}else this.setupViewUniforms(e,t);const s=0===t,n=t===d.length-1;o.draw(b.primitive[x],w,S?.count,T,s,n),this._forwardDrawCalls++,r.instancingData&&this._instancedDrawCalls++}else o.draw(b.primitive[x],w,S?.count,T),this._forwardDrawCalls++,r.instancingData&&this._instancedDrawCalls++;n<u-1&&!e.isNewMaterial[n+1]&&g.setParameters(o,r.parameters)}}renderForward(t,e,s,n,i,r,a,o,l){const h=this.renderForwardPrepareMaterials(t,e,s,n,a,i);this.renderForwardInternal(t,h,n,i,r,o,l),Cu.clear()}renderForwardLayer(t,e,s,n,i,r,a={}){const{scene:o,device:l}=this,h=o.clusteredLightingEnabled;let c,d;if(this.setupViewport(t,e),s){s.sortVisible(t,n);const e=s.getCulledInstances(t);c=n?e.transparent:e.opaque,o.immediate.onPreRenderLayer(s,c,n),s.requiresLightCube&&(this.lightCube.update(o.ambientLight,s._lights),this.constantLightCube.setValue(this.lightCube.colors)),d=s.splitLights}else c=a.meshInstances,d=a.splitLights??wu;if(h){(a.lightClusters??this.worldClustersAllocator.empty).activate(),s&&(this.clustersDebugRendered||o.lighting.debugLayer!==s.id||(this.clustersDebugRendered=!0))}o._activeCamera=t;const u=t.fogParams??this.scene.fog;this.setFogConstants(u);const f=this.setCameraUniforms(t,e);l.supportsUniformBuffers&&this.setupViewUniformBuffers(r,this.viewUniformFormat,this.viewBindGroupFormat,f);const p=a.clearColor??!1,m=a.clearDepth??!1,g=a.clearStencil??!1;(p||m||g)&&this.clear(t,p,m,g);const _=!!(t._flipFaces^e?.flipY),v=this._forwardDrawCalls;this.renderForward(t,e,c,d,i,null,s,_,r),s&&(s._forwardDrawCalls+=this._forwardDrawCalls-v)}setFogConstants(t){if(t.type!==xl){Tu.linear(t.color);const e=this.fogColor;e[0]=Tu.r,e[1]=Tu.g,e[2]=Tu.b,this.fogColorId.setValue(e),"linear"===t.type?(this.fogStartId.setValue(t.start),this.fogEndId.setValue(t.end)):this.fogDensityId.setValue(t.density)}}setSceneConstants(){const t=this.scene;this.dispatchGlobalLights(t);const e=this.device;this._screenSize[0]=e.width,this._screenSize[1]=e.height,this._screenSize[2]=1/e.width,this._screenSize[3]=1/e.height,this.screenSizeId.setValue(this._screenSize),this.pcssDiskSamplesId.setValue(this.pcssDiskSamples),this.pcssSphereSamplesId.setValue(this.pcssSphereSamples)}buildFrameGraph(t,e){const s=this.scene;if(t.reset(),s.clusteredLightingEnabled){const{shadowsEnabled:e,cookiesEnabled:n}=s.lighting;this._renderPassUpdateClustered.update(t,e,n,this.lights,this.localLights),t.addRenderPass(this._renderPassUpdateClustered)}else this._shadowRendererLocal.buildNonClusteredRenderPasses(t,this.localLights);let n=0,i=!0,r=null;const a=e._renderActions;for(let s=n;s<a.length;s++){const o=a[s],{layer:l,camera:h}=o;if(o.useCameraPasses)h.camera.renderPasses.forEach(e=>{t.addRenderPass(e)});else{const c=1===l.id,d=c&&(h.renderSceneColorMap||h.renderSceneDepthMap);i&&(i=!1,n=s,r=o.renderTarget);const u=a[s+1],f=!!u&&(!u.useCameraPasses&&1===u.layer.id)&&(h.renderSceneColorMap||h.renderSceneDepthMap),p=!!u&&(u.firstCameraUse&&this.cameraDirShadowLights.has(u.camera.camera));if(!u||u.renderTarget!==r||p||f||d){if(c&&n===s||this.addMainRenderPass(t,e,r,n,s),c){if(h.renderSceneColorMap){const e=h.camera.renderPassColorGrab;e.source=h.renderTarget,t.addRenderPass(e)}h.renderSceneDepthMap&&t.addRenderPass(h.camera.renderPassDepthGrab)}if(o.triggerPostprocess&&h?.onPostprocessing){const e=new xu(this.device,this,o);t.addRenderPass(e)}i=!0}}}}addMainRenderPass(t,e,s,n,i){const r=new Su(this.device,e,this.scene,this);r.init(s);const a=e._renderActions;for(let t=n;t<=i;t++)r.addRenderAction(a[t]);t.addRenderPass(r)}update(t){this.frameUpdate(),this.shadowRenderer.frameUpdate(),this.scene._updateSkyMesh(),this.updateLayerComposition(t),this.collectLights(t),this.beginFrame(t),this.setSceneConstants(),this.gsplatDirector?.update(t),this.cullComposition(t),this.gpuUpdate(this.processingMeshInstances)}}let Au=0;const Du=[],Pu=new Set;const Lu=[null,function(t,e){return t.drawOrder-e.drawOrder},function(t,e){const s=t._sortKeyForward,n=e._sortKeyForward;return s===n?e.mesh.id-t.mesh.id:n-s},function(t,e){return e._sortKeyDynamic-t._sortKeyDynamic},function(t,e){return t._sortKeyDynamic-e._sortKeyDynamic}];class Iu{constructor(){this.opaque=[],this.transparent=[]}}class Ru{constructor(t={}){this.meshInstances=[],this.meshInstancesSet=new Set,this.shadowCasters=[],this.shadowCastersSet=new Set,this._visibleInstances=new WeakMap,this._lights=[],this._lightsSet=new Set,this._clusteredLightsSet=new Set,this._splitLights=[[],[],[]],this._splitLightsDirty=!0,this.requiresLightCube=!1,this.cameras=[],this.camerasSet=new Set,this.gsplatPlacements=[],this.gsplatPlacementsDirty=!0,this._dirtyComposition=!1,void 0!==t.id?(this.id=t.id,Au=Math.max(this.id+1,Au)):this.id=Au++,this.name=t.name,this._enabled=t.enabled??!0,this._refCounter=this._enabled?1:0,this.opaqueSortMode=t.opaqueSortMode??2,this.transparentSortMode=t.transparentSortMode??3,t.renderTarget&&(this.renderTarget=t.renderTarget),this._clearColorBuffer=!!t.clearColorBuffer,this._clearDepthBuffer=!!t.clearDepthBuffer,this._clearStencilBuffer=!!t.clearStencilBuffer,this.onEnable=t.onEnable,this.onDisable=t.onDisable,this._enabled&&this.onEnable&&this.onEnable(),this.customSortCallback=null,this.customCalculateSortValues=null,this._lightHash=0,this._lightHashDirty=!1,this._lightIdHash=0,this._lightIdHashDirty=!1,this._shaderVersion=-1}set enabled(t){t!==this._enabled&&(this._dirtyComposition=!0,this.gsplatPlacementsDirty=!0,this._enabled=t,t?(this.incrementCounter(),this.onEnable&&this.onEnable()):(this.decrementCounter(),this.onDisable&&this.onDisable()))}get enabled(){return this._enabled}set clearColorBuffer(t){this._clearColorBuffer=t,this._dirtyComposition=!0}get clearColorBuffer(){return this._clearColorBuffer}set clearDepthBuffer(t){this._clearDepthBuffer=t,this._dirtyComposition=!0}get clearDepthBuffer(){return this._clearDepthBuffer}set clearStencilBuffer(t){this._clearStencilBuffer=t,this._dirtyComposition=!0}get clearStencilBuffer(){return this._clearStencilBuffer}get hasClusteredLights(){return this._clusteredLightsSet.size>0}get clusteredLightsSet(){return this._clusteredLightsSet}incrementCounter(){0===this._refCounter&&(this._enabled=!0,this.onEnable&&this.onEnable()),this._refCounter++}decrementCounter(){if(1===this._refCounter)this._enabled=!1,this.onDisable&&this.onDisable();else if(0===this._refCounter)return;this._refCounter--}addGSplatPlacement(t){this.gsplatPlacements.includes(t)||(this.gsplatPlacements.push(t),this.gsplatPlacementsDirty=!0)}removeGSplatPlacement(t){const e=this.gsplatPlacements.indexOf(t);e>=0&&(this.gsplatPlacements.splice(e,1),this.gsplatPlacementsDirty=!0)}addMeshInstances(t,e){const s=this.meshInstances,n=this.meshInstancesSet;for(let e=0;e<t.length;e++){const i=t[e];n.has(i)||(s.push(i),n.add(i),Pu.add(i.material))}if(e||this.addShadowCasters(t),Pu.size>0){const t=this._shaderVersion;Pu.forEach(e=>{t>=0&&e._shaderVersion!==t&&(e.getShaderVariant!==Cd.prototype.getShaderVariant&&e.clearVariants(),e._shaderVersion=t)}),Pu.clear()}}removeMeshInstances(t,e){const s=this.meshInstances,n=this.meshInstancesSet;for(let e=0;e<t.length;e++){const i=t[e];if(n.has(i)){n.delete(i);const t=s.indexOf(i);t>=0&&s.splice(t,1)}}e||this.removeShadowCasters(t)}addShadowCasters(t){const e=this.shadowCasters,s=this.shadowCastersSet;for(let n=0;n<t.length;n++){const i=t[n];i.castShadow&&!s.has(i)&&(s.add(i),e.push(i))}}removeShadowCasters(t){const e=this.shadowCasters,s=this.shadowCastersSet;for(let n=0;n<t.length;n++){const i=t[n];if(s.has(i)){s.delete(i);const t=e.indexOf(i);t>=0&&e.splice(t,1)}}}clearMeshInstances(t=!1){this.meshInstances.length=0,this.meshInstancesSet.clear(),t||(this.shadowCasters.length=0,this.shadowCastersSet.clear())}markLightsDirty(){this._lightHashDirty=!0,this._lightIdHashDirty=!0,this._splitLightsDirty=!0}hasLight(t){return this._lightsSet.has(t)}addLight(t){const e=t.light;this._lightsSet.has(e)||(this._lightsSet.add(e),this._lights.push(e),this.markLightsDirty()),0!==e.type&&this._clusteredLightsSet.add(e)}removeLight(t){const e=t.light;this._lightsSet.has(e)&&(this._lightsSet.delete(e),this._lights.splice(this._lights.indexOf(e),1),this.markLightsDirty()),0!==e.type&&this._clusteredLightsSet.delete(e)}clearLights(){this._lightsSet.forEach(t=>t.removeLayer(this)),this._lightsSet.clear(),this._clusteredLightsSet.clear(),this._lights.length=0,this.markLightsDirty()}get splitLights(){if(this._splitLightsDirty){this._splitLightsDirty=!1;const t=this._splitLights;for(let e=0;e<t.length;e++)t[e].length=0;const e=this._lights;for(let s=0;s<e.length;s++){const n=e[s];n.enabled&&t[n._type].push(n)}for(let e=0;e<t.length;e++)t[e].sort((t,e)=>t.key-e.key)}return this._splitLights}evaluateLightHash(t,e,s){let n=0;const i=this._lights;for(let n=0;n<i.length;n++){const r=0!==i[n].type;(t&&r||e&&!r)&&Du.push(s?i[n].id:i[n].key)}return Du.length>0&&(Du.sort(),n=Fi(Du),Du.length=0),n}getLightHash(t){return this._lightHashDirty&&(this._lightHashDirty=!1,this._lightHash=this.evaluateLightHash(!t,!0,!1)),this._lightHash}getLightIdHash(){return this._lightIdHashDirty&&(this._lightIdHashDirty=!1,this._lightIdHash=this.evaluateLightHash(!0,!1,!0)),this._lightIdHash}addCamera(t){this.camerasSet.has(t.camera)||(this.camerasSet.add(t.camera),this.cameras.push(t),this._dirtyComposition=!0)}removeCamera(t){if(this.camerasSet.has(t.camera)){this.camerasSet.delete(t.camera);const e=this.cameras.indexOf(t);this.cameras.splice(e,1),this._dirtyComposition=!0}}clearCameras(){this.cameras.length=0,this.camerasSet.clear(),this._dirtyComposition=!0}_calculateSortDistances(t,e,s){const n=t.length,{x:i,y:r,z:a}=e,{x:o,y:l,z:h}=s;for(let c=0;c<n;c++){const n=t[c];let d;if(n.calculateSortDistance)d=n.calculateSortDistance(n,e,s);else{const t=n.aabb.center;d=(t.x-i)*o+(t.y-r)*l+(t.z-a)*h}const u=1e9*n._drawBucket;n._sortKeyDynamic=u+d}}getCulledInstances(t){let e=this._visibleInstances.get(t);return e||(e=new Iu,this._visibleInstances.set(t,e)),e}sortVisible(t,e){const s=e?this.transparentSortMode:this.opaqueSortMode;if(0===s)return;const n=this.getCulledInstances(t),i=e?n.transparent:n.opaque,r=t.node;if(5===s){const t=r.getPosition(),e=r.forward;this.customCalculateSortValues&&this.customCalculateSortValues(i,i.length,t,e),this.customSortCallback&&i.sort(this.customSortCallback)}else{if(3===s||4===s){const t=r.getPosition(),e=r.forward;this._calculateSortDistances(i,t,e)}i.sort(Lu[s])}}}const Mu=(t,e)=>t.priority-e.priority,ku=t=>t.sort(Mu);class Ou extends Ve{constructor(t="Untitled"){super(),this.layerList=[],this.layerIdMap=new Map,this.layerNameMap=new Map,this.layerOpaqueIndexMap=new Map,this.layerTransparentIndexMap=new Map,this.subLayerList=[],this.subLayerEnabled=[],this.cameras=[],this.camerasSet=new Set,this._renderActions=[],this._dirty=!1,this.name=t,this._opaqueOrder={},this._transparentOrder={}}destroy(){this.destroyRenderActions()}destroyRenderActions(){this._renderActions.forEach(t=>t.destroy()),this._renderActions.length=0}markDirty(){this._dirty=!0}_update(){const t=this.layerList.length;if(!this._dirty)for(let e=0;e<t;e++)if(this.layerList[e]._dirtyComposition){this._dirty=!0;break}if(this._dirty){this._dirty=!1,this.cameras.length=0,this.camerasSet.clear();for(let e=0;e<t;e++){const t=this.layerList[e];t._dirtyComposition=!1;for(let e=0;e<t.cameras.length;e++){const s=t.cameras[e];this.camerasSet.has(s.camera)||(this.camerasSet.add(s.camera),this.cameras.push(s))}}this.cameras.length>1&&ku(this.cameras);let e=0;this.destroyRenderActions();for(let s=0;s<this.cameras.length;s++){const n=this.cameras[s];if(n.camera.renderPasses.length>0){this.addDummyRenderAction(e,n),e++;continue}let i=!0;const r=e;let a=null,o=!1;for(let s=0;s<t;s++){const t=this.layerList[s];if(t.enabled&&this.subLayerEnabled[s]&&t.cameras.length>0&&n.layers.indexOf(t.id)>=0){o||t.id!==n.disablePostEffectsLayer||(o=!0,a&&(a.triggerPostprocess=!0));const r=this.subLayerList[s];a=this.addRenderAction(e,t,r,n,i,o),e++,i=!1}}r<e&&(a.lastCameraUse=!0),!o&&a&&(a.triggerPostprocess=!0),n.renderTarget&&n.postEffectsEnabled&&this.propagateRenderTarget(r-1,n)}this._logRenderActions()}}getNextRenderAction(t){const e=new bu;return this._renderActions.push(e),e}addDummyRenderAction(t,e){const s=this.getNextRenderAction(t);s.camera=e,s.useCameraPasses=!0}addRenderAction(t,e,s,n,i,r){let a=1!==e.id?n.renderTarget:null,o=!1;const l=this._renderActions;for(let e=t-1;e>=0;e--)if(l[e].camera===n&&l[e].renderTarget===a){o=!0;break}r&&n.postEffectsEnabled&&(a=null);const h=this.getNextRenderAction(t);h.triggerPostprocess=!1,h.layer=e,h.transparent=s,h.camera=n,h.renderTarget=a,h.firstCameraUse=i,h.lastCameraUse=!1;const c=i||!o,d=e.clearColorBuffer||e.clearDepthBuffer||e.clearStencilBuffer;return(c||d)&&h.setupClears(c?n:void 0,e),h}propagateRenderTarget(t,e){for(let s=t;s>=0;s--){const t=this._renderActions[s],n=t.layer;if(t.renderTarget&&1!==n.id)break;if(1===n.id)continue;if(t.useCameraPasses)break;const i=t?.camera.camera;if(i&&(!e.camera.rect.equals(i.rect)||!e.camera.scissorRect.equals(i.scissorRect)))break;t.renderTarget=e.renderTarget}}_logRenderActions(){}_isLayerAdded(t){return this.layerIdMap.get(t.id)===t}_isSublayerAdded(t,e){return void 0!==(e?this.layerTransparentIndexMap:this.layerOpaqueIndexMap).get(t)}push(t){this._isLayerAdded(t)||(this.layerList.push(t),this.layerList.push(t),this._opaqueOrder[t.id]=this.subLayerList.push(!1)-1,this._transparentOrder[t.id]=this.subLayerList.push(!0)-1,this.subLayerEnabled.push(!0),this.subLayerEnabled.push(!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",t))}insert(t,e){if(this._isLayerAdded(t))return;this.layerList.splice(e,0,t,t),this.subLayerList.splice(e,0,!1,!0);const s=this.layerList.length;this._updateOpaqueOrder(e,s-1),this._updateTransparentOrder(e,s-1),this.subLayerEnabled.splice(e,0,!0,!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",t)}remove(t){let e=this.layerList.indexOf(t);for(delete this._opaqueOrder[e],delete this._transparentOrder[e];e>=0;)this.layerList.splice(e,1),this.subLayerList.splice(e,1),this.subLayerEnabled.splice(e,1),e=this.layerList.indexOf(t),this._dirty=!0,this.fire("remove",t);const s=this.layerList.length;this._updateOpaqueOrder(0,s-1),this._updateTransparentOrder(0,s-1),this._updateLayerMaps()}pushOpaque(t){this._isSublayerAdded(t,!1)||(this.layerList.push(t),this._opaqueOrder[t.id]=this.subLayerList.push(!1)-1,this.subLayerEnabled.push(!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",t))}insertOpaque(t,e){if(this._isSublayerAdded(t,!1))return;this.layerList.splice(e,0,t),this.subLayerList.splice(e,0,!1);const s=this.subLayerList.length;this._updateOpaqueOrder(e,s-1),this.subLayerEnabled.splice(e,0,!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",t)}removeOpaque(t){for(let e=0,s=this.layerList.length;e<s;e++)if(this.layerList[e]===t&&!this.subLayerList[e]){this.layerList.splice(e,1),this.subLayerList.splice(e,1),s--,this._updateOpaqueOrder(e,s-1),this.subLayerEnabled.splice(e,1),this._dirty=!0,this.layerList.indexOf(t)<0&&this.fire("remove",t);break}this._updateLayerMaps()}pushTransparent(t){this._isSublayerAdded(t,!0)||(this.layerList.push(t),this._transparentOrder[t.id]=this.subLayerList.push(!0)-1,this.subLayerEnabled.push(!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",t))}insertTransparent(t,e){if(this._isSublayerAdded(t,!0))return;this.layerList.splice(e,0,t),this.subLayerList.splice(e,0,!0);const s=this.subLayerList.length;this._updateTransparentOrder(e,s-1),this.subLayerEnabled.splice(e,0,!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",t)}removeTransparent(t){for(let e=0,s=this.layerList.length;e<s;e++)if(this.layerList[e]===t&&this.subLayerList[e]){this.layerList.splice(e,1),this.subLayerList.splice(e,1),s--,this._updateTransparentOrder(e,s-1),this.subLayerEnabled.splice(e,1),this._dirty=!0,this.layerList.indexOf(t)<0&&this.fire("remove",t);break}this._updateLayerMaps()}getOpaqueIndex(t){return this.layerOpaqueIndexMap.get(t)??-1}getTransparentIndex(t){return this.layerTransparentIndexMap.get(t)??-1}isEnabled(t,e){if(t.enabled){const s=e?this.getTransparentIndex(t):this.getOpaqueIndex(t);if(s>=0)return this.subLayerEnabled[s]}return!1}_updateLayerMaps(){this.layerIdMap.clear(),this.layerNameMap.clear(),this.layerOpaqueIndexMap.clear(),this.layerTransparentIndexMap.clear();for(let t=0;t<this.layerList.length;t++){const e=this.layerList[t];this.layerIdMap.set(e.id,e),this.layerNameMap.set(e.name,e);(this.subLayerList[t]?this.layerTransparentIndexMap:this.layerOpaqueIndexMap).set(e,t)}}getLayerById(t){return this.layerIdMap.get(t)??null}getLayerByName(t){return this.layerNameMap.get(t)??null}_updateOpaqueOrder(t,e){for(let s=t;s<=e;s++)!1===this.subLayerList[s]&&(this._opaqueOrder[this.layerList[s].id]=s)}_updateTransparentOrder(t,e){for(let s=t;s<=e;s++)!0===this.subLayerList[s]&&(this._transparentOrder[this.layerList[s].id]=s)}_sortLayersDescending(t,e,s){let n=-1,i=-1;for(let e=0,i=t.length;e<i;e++){const i=t[e];s.hasOwnProperty(i)&&(n=Math.max(n,s[i]))}for(let t=0,n=e.length;t<n;t++){const n=e[t];s.hasOwnProperty(n)&&(i=Math.max(i,s[n]))}return-1===n&&-1!==i?1:-1===i&&-1!==n?-1:i-n}sortTransparentLayers(t,e){return this._sortLayersDescending(t,e,this._transparentOrder)}sortOpaqueLayers(t,e){return this._sortLayersDescending(t,e,this._opaqueOrder)}}const Fu=new rs,Nu={bias:0,normalBias:0},Bu=new Ze,zu={r:0,g:1,b:2,a:3},Uu={directional:0,omni:1,point:1,spot:2},Vu=[[new ls(0,0,1,1)],[new ls(0,0,.5,.5),new ls(0,.5,.5,.5)],[new ls(0,0,.5,.5),new ls(0,.5,.5,.5),new ls(.5,0,.5,.5)],[new ls(0,0,.5,.5),new ls(0,.5,.5,.5),new ls(.5,0,.5,.5),new ls(.5,.5,.5,.5)]],Hu={rrr:1,ggg:2,bbb:4,aaa:8,rgb:7};let Gu=0;class Wu{constructor(t,e,s){this.light=s,this.camera=t,this.shadowCamera=Wd.createShadowCamera(s._shadowType,s._type,e),this.shadowMatrix=new ps,this.shadowViewport=new ls(0,0,1,1),this.shadowScissor=new ls(0,0,1,1),this.projectionCompensation=0,this.face=e,this.visibleCasters=[],this.viewBindGroups=[]}destroy(){this.viewBindGroups.forEach(t=>{t.defaultUniformBuffer.destroy(),t.destroy()}),this.viewBindGroups.length=0}get shadowBuffer(){const t=this.shadowCamera.renderTarget;return t?this.light._isPcf?t.depthBuffer:t.colorBuffer:null}}class ju{constructor(t,e){this.layers=new Set,this.shadowDepthState=Ai.DEFAULT.clone(),this.clusteredFlags=0,this.clusteredData=new Uint32Array(3),this.clusteredData16=new Uint16Array(this.clusteredData.buffer),this._evtDeviceRestored=null,this.device=t,this.clusteredLighting=e,this.id=Gu++,this._evtDeviceRestored=t.on("devicerestored",this.onDeviceRestored,this),this._type=0,this._color=new Ze(.8,.8,.8),this._intensity=1,this._affectSpecularity=!0,this._luminance=0,this._castShadows=!1,this._enabled=!1,this._mask=1,this.isStatic=!1,this.key=0,this.bakeDir=!0,this.bakeNumSamples=1,this.bakeArea=0,this.attenuationStart=10,this.attenuationEnd=10,this._falloffMode=0,this._shadowType=0,this._vsmBlurSize=11,this.vsmBlurMode=1,this.vsmBias=.0025,this._cookie=null,this.cookieIntensity=1,this._cookieFalloff=!0,this._cookieChannel="rgb",this._cookieTransform=null,this._cookieTransformUniform=new Float32Array(4),this._cookieOffset=null,this._cookieOffsetUniform=new Float32Array(2),this._cookieTransformSet=!1,this._cookieOffsetSet=!1,this._innerConeAngle=40,this._outerConeAngle=45,this.cascades=null,this._shadowMatrixPalette=null,this._shadowCascadeDistances=null,this.numCascades=1,this._cascadeBlend=0,this.cascadeDistribution=.5,this._shape=0,this._colorLinear=new Float32Array(3),this._updateLinearColor(),this._position=new rs(0,0,0),this._direction=new rs(0,0,0),this._innerConeAngleCos=Math.cos(this._innerConeAngle*Qe.DEG_TO_RAD),this._updateOuterAngle(this._outerConeAngle),this._usePhysicalUnits=void 0,this._shadowMap=null,this._shadowRenderParams=[],this._shadowCameraParams=[],this.shadowDistance=40,this._shadowResolution=1024,this._shadowBias=-5e-4,this._shadowIntensity=1,this._normalOffsetBias=0,this.shadowUpdateMode=2,this.shadowUpdateOverrides=null,this._isVsm=!1,this._isPcf=!0,this._softShadowParams=new Float32Array(4),this.shadowSamples=16,this.shadowBlockerSamples=16,this.penumbraSize=1,this.penumbraFalloff=1,this._cookieMatrix=null,this._atlasViewport=null,this.atlasViewportAllocated=!1,this.atlasVersion=0,this.atlasSlotIndex=0,this.atlasSlotUpdated=!1,this._node=null,this._renderData=[],this.visibleThisFrame=!1,this.maxScreenSize=0,this._updateShadowBias()}destroy(){this._evtDeviceRestored?.off(),this._evtDeviceRestored=null,this._destroyShadowMap(),this.releaseRenderData(),this._renderData=null}onDeviceRestored(){0===this.shadowUpdateMode&&(this.shadowUpdateMode=1)}releaseRenderData(){if(this._renderData){for(let t=0;t<this._renderData.length;t++)this._renderData[t].destroy();this._renderData.length=0}}addLayer(t){this.layers.add(t)}removeLayer(t){this.layers.delete(t)}set shadowSamples(t){this._softShadowParams[0]=t}get shadowSamples(){return this._softShadowParams[0]}set shadowBlockerSamples(t){this._softShadowParams[1]=t}get shadowBlockerSamples(){return this._softShadowParams[1]}set shadowBias(t){this._shadowBias!==t&&(this._shadowBias=t,this._updateShadowBias())}get shadowBias(){return this._shadowBias}set numCascades(t){this.cascades&&this.numCascades===t||(this.cascades=Vu[t-1],this._shadowMatrixPalette=new Float32Array(64),this._shadowCascadeDistances=new Float32Array(4),this._destroyShadowMap(),this.updateKey())}get numCascades(){return this.cascades.length}set cascadeBlend(t){this._cascadeBlend!==t&&(this._cascadeBlend=t,this.updateKey())}get cascadeBlend(){return this._cascadeBlend}set shadowMap(t){this._shadowMap!==t&&(this._destroyShadowMap(),this._shadowMap=t)}get shadowMap(){return this._shadowMap}set mask(t){this._mask!==t&&(this._mask=t,this.updateKey(),this.updateClusteredFlags())}get mask(){return this._mask}get numShadowFaces(){const t=this._type;return 0===t?this.numCascades:1===t?6:1}set type(t){if(this._type===t)return;this._type=t,this._destroyShadowMap(),this._updateShadowBias(),this.updateKey(),this.updateClusteredFlags();const e=this._shadowType;this._shadowType=null,this.shadowUpdateOverrides=null,this.shadowType=e}get type(){return this._type}set shape(t){if(this._shape===t)return;this._shape=t,this._destroyShadowMap(),this.updateKey(),this.updateClusteredFlags();const e=this._shadowType;this._shadowType=null,this.shadowType=e}get shape(){return this._shape}set usePhysicalUnits(t){this._usePhysicalUnits!==t&&(this._usePhysicalUnits=t,this._updateLinearColor())}get usePhysicalUnits(){return this._usePhysicalUnits}set shadowType(t){if(this._shadowType===t)return;let e=zl.get(t);e||(t=0);const s=this.device;6!==t||s.textureFloatRenderable&&s.textureFloatFilterable||(t=0),1===this._type&&5!==t&&0!==t&&7!==t&&8!==t&&6!==t&&(t=0),3!==t||s.textureFloatRenderable&&s.textureFloatFilterable||(t=2),2!==t||s.textureHalfFloatRenderable||(t=0),e=zl.get(t),this._isVsm=e?.vsm??!1,this._isPcf=e?.pcf??!1,this._shadowType=t,this._destroyShadowMap(),this.updateKey()}get shadowType(){return this._shadowType}set enabled(t){this._enabled!==t&&(this._enabled=t,this.layersDirty())}get enabled(){return this._enabled}set castShadows(t){this._castShadows!==t&&(this._castShadows=t,this._destroyShadowMap(),this.layersDirty(),this.updateKey())}get castShadows(){return this._castShadows&&4!==this._mask&&0!==this._mask}set shadowIntensity(t){this._shadowIntensity!==t&&(this._shadowIntensity=t,this.updateKey())}get shadowIntensity(){return this._shadowIntensity}get bakeShadows(){return this._castShadows&&4===this._mask}set shadowResolution(t){this._shadowResolution!==t&&(t=1===this._type?Math.min(t,this.device.maxCubeMapSize):Math.min(t,this.device.maxTextureSize),this._shadowResolution=t,this._destroyShadowMap())}get shadowResolution(){return this._shadowResolution}set vsmBlurSize(t){this._vsmBlurSize!==t&&(t%2==0&&t++,this._vsmBlurSize=t)}get vsmBlurSize(){return this._vsmBlurSize}set normalOffsetBias(t){if(this._normalOffsetBias!==t){const e=!this._normalOffsetBias&&t||this._normalOffsetBias&&!t;this._normalOffsetBias=t,e&&this.updateKey()}}get normalOffsetBias(){return this._normalOffsetBias}set falloffMode(t){this._falloffMode!==t&&(this._falloffMode=t,this.updateKey(),this.updateClusteredFlags())}get falloffMode(){return this._falloffMode}set innerConeAngle(t){this._innerConeAngle!==t&&(this._innerConeAngle=t,this._innerConeAngleCos=Math.cos(t*Qe.DEG_TO_RAD),this.updateClusterData(!1,!0),this._usePhysicalUnits&&this._updateLinearColor())}get innerConeAngle(){return this._innerConeAngle}set outerConeAngle(t){this._outerConeAngle!==t&&(this._outerConeAngle=t,this._updateOuterAngle(t),this._usePhysicalUnits&&this._updateLinearColor())}get outerConeAngle(){return this._outerConeAngle}set penumbraSize(t){this._penumbraSize=t,this._softShadowParams[2]=t}get penumbraSize(){return this._penumbraSize}set penumbraFalloff(t){this._softShadowParams[3]=t}get penumbraFalloff(){return this._softShadowParams[3]}_updateOuterAngle(t){const e=t*Qe.DEG_TO_RAD;this._outerConeAngleCos=Math.cos(e),this._outerConeAngleSin=Math.sin(e),this.updateClusterData(!1,!0)}set intensity(t){this._intensity!==t&&(this._intensity=t,this._updateLinearColor())}get intensity(){return this._intensity}set affectSpecularity(t){0===this._type&&(this._affectSpecularity=t,this.updateKey())}get affectSpecularity(){return this._affectSpecularity}set luminance(t){this._luminance!==t&&(this._luminance=t,this._updateLinearColor())}get luminance(){return this._luminance}get cookieMatrix(){return this._cookieMatrix||(this._cookieMatrix=new ps),this._cookieMatrix}get atlasViewport(){return this._atlasViewport||(this._atlasViewport=new ls(0,0,1,1)),this._atlasViewport}set cookie(t){this._cookie!==t&&(this._cookie=t,this.updateKey())}get cookie(){return this._cookie}set cookieFalloff(t){this._cookieFalloff!==t&&(this._cookieFalloff=t,this.updateKey())}get cookieFalloff(){return this._cookieFalloff}set cookieChannel(t){if(this._cookieChannel!==t){if(t.length<3){const e=t.charAt(t.length-1),s=3-t.length;for(let n=0;n<s;n++)t+=e}this._cookieChannel=t,this.updateKey(),this.updateClusteredFlags()}}get cookieChannel(){return this._cookieChannel}set cookieTransform(t){this._cookieTransform!==t&&(this._cookieTransform=t,this._cookieTransformSet=!!t,t&&!this._cookieOffset&&(this.cookieOffset=new os,this._cookieOffsetSet=!1),this.updateKey())}get cookieTransform(){return this._cookieTransform}set cookieOffset(t){if(this._cookieOffset===t)return;!(!this._cookieTransformSet&&!t)&&!t&&this._cookieOffset?this._cookieOffset.set(0,0):this._cookieOffset=t,this._cookieOffsetSet=!!t,t&&!this._cookieTransform&&(this.cookieTransform=new ls(1,1,0,0),this._cookieTransformSet=!1),this.updateKey()}get cookieOffset(){return this._cookieOffset}beginFrame(){this.visibleThisFrame=0===this._type&&this._enabled,this.maxScreenSize=0,this.atlasViewportAllocated=!1,this.atlasSlotUpdated=!1}_destroyShadowMap(){if(this.releaseRenderData(),this._shadowMap&&(this._shadowMap.cached||this._shadowMap.destroy(),this._shadowMap=null),0===this.shadowUpdateMode&&(this.shadowUpdateMode=1),this.shadowUpdateOverrides)for(let t=0;t<this.shadowUpdateOverrides.length;t++)0===this.shadowUpdateOverrides[t]&&(this.shadowUpdateOverrides[t]=1)}getRenderData(t,e){for(let s=0;s<this._renderData.length;s++){const n=this._renderData[s];if(n.camera===t&&n.face===e)return n}const s=new Wu(t,e,this);return this._renderData.push(s),s}clone(){const t=new ju(this.device,this.clusteredLighting);return t.type=this._type,t.setColor(this._color),t.intensity=this._intensity,t.affectSpecularity=this._affectSpecularity,t.luminance=this._luminance,t.castShadows=this.castShadows,t._enabled=this._enabled,t.attenuationStart=this.attenuationStart,t.attenuationEnd=this.attenuationEnd,t.falloffMode=this._falloffMode,t.shadowType=this._shadowType,t.vsmBlurSize=this._vsmBlurSize,t.vsmBlurMode=this.vsmBlurMode,t.vsmBias=this.vsmBias,t.shadowUpdateMode=this.shadowUpdateMode,t.mask=this.mask,this.shadowUpdateOverrides&&(t.shadowUpdateOverrides=this.shadowUpdateOverrides.slice()),t.innerConeAngle=this._innerConeAngle,t.outerConeAngle=this._outerConeAngle,t.numCascades=this.numCascades,t.cascadeDistribution=this.cascadeDistribution,t.cascadeBlend=this._cascadeBlend,t.shape=this._shape,t.shadowDepthState.copy(this.shadowDepthState),t.shadowBias=this.shadowBias,t.normalOffsetBias=this._normalOffsetBias,t.shadowResolution=this._shadowResolution,t.shadowDistance=this.shadowDistance,t.shadowIntensity=this.shadowIntensity,t.shadowSamples=this.shadowSamples,t.shadowBlockerSamples=this.shadowBlockerSamples,t.penumbraSize=this.penumbraSize,t.penumbraFalloff=this.penumbraFalloff,t}static getLightUnitConversion(t,e=Math.PI/4,s=0){switch(t){case 2:{const t=Math.cos(e),n=Math.cos(s);return 2*Math.PI*(1-n+(n-t)/2)}case 1:return 4*Math.PI;case 0:return 1}}_getUniformBiasValues(t){const e=t.shadowCamera._farClip;switch(this._type){case 1:Nu.bias=this.shadowBias,Nu.normalBias=this._normalOffsetBias;break;case 2:this._isVsm?Nu.bias=-2e-4:Nu.bias=20*this.shadowBias,Nu.normalBias=this._isVsm?this.vsmBias/(this.attenuationEnd/7):this._normalOffsetBias;break;case 0:this._isVsm?Nu.bias=-2e-4:Nu.bias=this.shadowBias/e*100,Nu.normalBias=this._isVsm?this.vsmBias/(e/7):this._normalOffsetBias}return Nu}getColor(){return this._color}getBoundingSphere(t){if(2===this._type){const e=this.attenuationEnd,s=this._outerConeAngle,n=this._outerConeAngleCos,i=this._node;Fu.copy(i.up),s>45?(t.radius=e*this._outerConeAngleSin,Fu.mulScalar(-e*n)):(t.radius=e/(2*n),Fu.mulScalar(-t.radius)),t.center.add2(i.getPosition(),Fu)}else 1===this._type&&(t.center=this._node.getPosition(),t.radius=this.attenuationEnd)}getBoundingBox(t){if(2===this._type){const e=this.attenuationEnd,s=this._outerConeAngle,n=this._node,i=Math.abs(Math.sin(s*Qe.DEG_TO_RAD)*e);t.center.set(0,.5*-e,0),t.halfExtents.set(i,.5*e,i),t.setFromTransformedAabb(t,n.getWorldTransform(),!0)}else 1===this._type&&(t.center.copy(this._node.getPosition()),t.halfExtents.set(this.attenuationEnd,this.attenuationEnd,this.attenuationEnd))}_updateShadowBias(){if(1!==this._type||this.clusteredLighting){const t=-1e3*this.shadowBias;this.shadowDepthState.depthBias=t,this.shadowDepthState.depthBiasSlope=t}else this.shadowDepthState.depthBias=0,this.shadowDepthState.depthBiasSlope=0}_updateLinearColor(){let t=this._intensity;this._usePhysicalUnits&&(t=this._luminance/ju.getLightUnitConversion(this._type,this._outerConeAngle*Qe.DEG_TO_RAD,this._innerConeAngle*Qe.DEG_TO_RAD));const e=this._color,s=this._colorLinear;t>=1?Bu.linear(e).mulScalar(t):Bu.copy(e).mulScalar(t).linear(),s[0]=Bu.r,s[1]=Bu.g,s[2]=Bu.b,this.updateClusterData(!0)}setColor(){1===arguments.length?this._color.set(arguments[0].r,arguments[0].g,arguments[0].b):3===arguments.length&&this._color.set(arguments[0],arguments[1],arguments[2]),this._updateLinearColor()}layersDirty(){this.layers.forEach(t=>{t.hasLight(this)&&t.markLightsDirty()})}updateKey(){let t=this._type<<29|this._shadowType<<25|this._falloffMode<<23|(0!==this._normalOffsetBias?1:0)<<22|(this._cookie?1:0)<<21|(this._cookieFalloff?1:0)<<20|zu[this._cookieChannel.charAt(0)]<<18|(this._cookieTransform?1:0)<<12|this._shape<<10|(this.numCascades>0?1:0)<<9|(this._cascadeBlend>0?1:0)<<8|(this.affectSpecularity?1:0)<<7|this.mask<<6|(this._castShadows?1:0)<<3;3===this._cookieChannel.length&&(t|=zu[this._cookieChannel.charAt(1)]<<16,t|=zu[this._cookieChannel.charAt(2)]<<14),t!==this.key&&this.layersDirty(),this.key=t}updateClusteredFlags(){const t=!!(1&this.mask),e=!!(2&this.mask);this.clusteredFlags=(2===this.type?1:0)<<30|(3&this._shape)<<28|(1&this._falloffMode)<<27|(Hu[this._cookieChannel]??0)<<23|(t?1:0)<<22|(e?1:0)<<21}getClusteredFlags(t,e){return this.clusteredFlags|255&(t?Math.floor(255*this.shadowIntensity):0)|(255&(e?Math.floor(255*this.cookieIntensity):0))<<8}updateClusterData(t,e){const{clusteredData16:s}=this,n=is.float2Half;if(t&&(s[0]=n(Qe.clamp(this._colorLinear[0]/Ll,0,65504)),s[1]=n(Qe.clamp(this._colorLinear[1]/Ll,0,65504)),s[2]=n(Qe.clamp(this._colorLinear[2]/Ll,0,65504))),e){const t=.5;let e=0;const i=.99;let r=Math.cos(this._innerConeAngle*i*Qe.DEG_TO_RAD);r>t&&(r=1-r,e|=1);let a=Math.cos(this._outerConeAngle*i*Qe.DEG_TO_RAD);a>t&&(a=1-a,e|=2),s[3]=e,s[4]=n(r),s[5]=n(a)}}}class $u{constructor(t,e,s){this._areaLightsEnabled=!1,this._cells=new rs(10,3,10),this._maxLightsPerCell=255,this._shadowsEnabled=!0,this._shadowType=0,this._shadowAtlasResolution=2048,this._cookiesEnabled=!1,this._cookieAtlasResolution=2048,this.atlasSplit=null,this._supportsAreaLights=t,this._maxTextureSize=e,this._dirtyLightsFnc=s}applySettings(t){this.shadowsEnabled=t.lightingShadowsEnabled??this.shadowsEnabled,this.cookiesEnabled=t.lightingCookiesEnabled??this.cookiesEnabled,this.areaLightsEnabled=t.lightingAreaLightsEnabled??this.areaLightsEnabled,this.shadowAtlasResolution=t.lightingShadowAtlasResolution??this.shadowAtlasResolution,this.cookieAtlasResolution=t.lightingCookieAtlasResolution??this.cookieAtlasResolution,this.maxLightsPerCell=t.lightingMaxLightsPerCell??this.maxLightsPerCell,this.shadowType=t.lightingShadowType??this.shadowType,t.lightingCells&&(this.cells=new rs(t.lightingCells))}set cells(t){this._cells.copy(t)}get cells(){return this._cells}set maxLightsPerCell(t){this._maxLightsPerCell=Qe.clamp(t,1,255)}get maxLightsPerCell(){return this._maxLightsPerCell}set cookieAtlasResolution(t){this._cookieAtlasResolution=Qe.clamp(t,32,this._maxTextureSize)}get cookieAtlasResolution(){return this._cookieAtlasResolution}set shadowAtlasResolution(t){this._shadowAtlasResolution=Qe.clamp(t,32,this._maxTextureSize)}get shadowAtlasResolution(){return this._shadowAtlasResolution}set shadowType(t){this._shadowType!==t&&(this._shadowType=t,this._dirtyLightsFnc())}get shadowType(){return this._shadowType}set cookiesEnabled(t){this._cookiesEnabled!==t&&(this._cookiesEnabled=t,this._dirtyLightsFnc())}get cookiesEnabled(){return this._cookiesEnabled}set areaLightsEnabled(t){this._supportsAreaLights&&this._areaLightsEnabled!==t&&(this._areaLightsEnabled=t,this._dirtyLightsFnc())}get areaLightsEnabled(){return this._areaLightsEnabled}set shadowsEnabled(t){this._shadowsEnabled!==t&&(this._shadowsEnabled=t,this._dirtyLightsFnc())}get shadowsEnabled(){return this._shadowsEnabled}}class Xu{constructor(t){this.morph=t,t.incRefCount(),this.device=t.device;const e=t._targets.length;this.shader=this._createShader(e),this._weights=[],this._weightMap=new Map;for(let e=0;e<t._targets.length;e++){const s=t._targets[e];s.name&&this._weightMap.set(s.name,e),this.setWeight(e,s.defaultWeight)}this._shaderMorphWeights=new Float32Array(e),this._shaderMorphIndex=new Uint32Array(e);const s=(e,s)=>(this[s]=t._createTexture(e,t._renderTextureFormat),new ji({colorBuffer:this[s],depth:!1}));t.morphPositions&&(this.rtPositions=s("MorphRTPos","texturePositions")),t.morphNormals&&(this.rtNormals=s("MorphRTNrm","textureNormals")),this._textureParams=new Float32Array([t.morphTextureWidth,t.morphTextureHeight]);const n=t.aabb.halfExtents;this._aabbSize=new Float32Array([4*n.x,4*n.y,4*n.z]);const i=t.aabb.getMin();this._aabbMin=new Float32Array([2*i.x,2*i.y,2*i.z]),this._aabbNrmSize=new Float32Array([2,2,2]),this._aabbNrmMin=new Float32Array([-1,-1,-1]),this.aabbSizeId=this.device.scope.resolve("aabbSize"),this.aabbMinId=this.device.scope.resolve("aabbMin"),this.morphTextureId=this.device.scope.resolve("morphTexture"),this.morphFactor=this.device.scope.resolve("morphFactor[0]"),this.morphIndex=this.device.scope.resolve("morphIndex[0]"),this.countId=this.device.scope.resolve("count"),this.zeroTextures=!1}destroy(){this.shader=null;const t=this.morph;t&&(this.morph=null,t.decRefCount(),t.refCount<1&&t.destroy()),this.rtPositions?.destroy(),this.rtPositions=null,this.texturePositions?.destroy(),this.texturePositions=null,this.rtNormals?.destroy(),this.rtNormals=null,this.textureNormals?.destroy(),this.textureNormals=null}clone(){return new Xu(this.morph)}_getWeightIndex(t){if("string"==typeof t){return this._weightMap.get(t)}return t}getWeight(t){const e=this._getWeightIndex(t);return this._weights[e]}setWeight(t,e){const s=this._getWeightIndex(t);this._weights[s]=e,this._dirty=!0}_createShader(t){const e=new Map;e.set("{MORPH_TEXTURE_MAX_COUNT}",t),this.morph.intRenderFormat&&e.set("MORPH_INT","");const s=this.morph.intRenderFormat?"uvec4":"vec4";return zh.createShader(this.device,{uniqueName:`TextureMorphShader_${t}-${this.morph.intRenderFormat?"int":"float"}`,attributes:{vertex_position:Ys},vertexChunk:"morphVS",fragmentChunk:"morphPS",fragmentDefines:e,fragmentOutputTypes:[s]})}_updateTextureRenderTarget(t,e,s){const{morph:n,device:i}=this;this.setAabbUniforms(s),this.morphTextureId.setValue(s?n.targetsTexturePositions:n.targetsTextureNormals),i.setBlendState(Ti.NOBLEND),this.countId.setValue(e),this.morphFactor.setValue(this._shaderMorphWeights),this.morphIndex.setValue(this._shaderMorphIndex),Xh(i,t,this.shader)}_updateTextureMorph(t){(t>0||!this.zeroTextures)&&(this.rtPositions&&this._updateTextureRenderTarget(this.rtPositions,t,!0),this.rtNormals&&this._updateTextureRenderTarget(this.rtNormals,t,!1),this.zeroTextures=0===t)}setAabbUniforms(t=!0){this.aabbSizeId.setValue(t?this._aabbSize:this._aabbNrmSize),this.aabbMinId.setValue(t?this._aabbMin:this._aabbNrmMin)}prepareRendering(t){this.setAabbUniforms()}update(){this._dirty=!1;const t=this.morph._targets,e=this._shaderMorphWeights,s=this._shaderMorphIndex;let n=0;for(let i=0;i<t.length;i++)Math.abs(this.getWeight(i))>1e-5&&(e[n]=this.getWeight(i),s[n]=i,n++);this._updateTextureMorph(n)}}class qu{constructor(){this.graph=null,this.meshInstances=[],this.skinInstances=[],this.morphInstances=[],this.cameras=[],this.lights=[],this._shadersVersion=0,this._immutable=!1}getGraph(){return this.graph}setGraph(t){this.graph=t}getCameras(){return this.cameras}setCameras(t){this.cameras=t}getLights(){return this.lights}setLights(t){this.lights=t}getMaterials(){const t=[];for(let e=0;e<this.meshInstances.length;e++){const s=this.meshInstances[e];-1===t.indexOf(s.material)&&t.push(s.material)}return t}clone(){const t=[],e=[],s=function(n){const i=n.clone();t.push(n),e.push(i);for(let t=0;t<n._children.length;t++)i.addChild(s(n._children[t]));return i},n=s(this.graph),i=[],r=[],a=[];for(let t=0;t<this.skinInstances.length;t++){const e=this.skinInstances[t].skin,s=new Yh(e),i=[];for(let t=0;t<e.boneNames.length;t++){const s=e.boneNames[t],r=n.findByName(s);i.push(r)}s.bones=i,r.push(s)}for(let t=0;t<this.morphInstances.length;t++){const e=this.morphInstances[t].morph,s=new Xu(e);a.push(s)}for(let s=0;s<this.meshInstances.length;s++){const n=this.meshInstances[s],o=t.indexOf(n.node),l=new fc(n.mesh,n.material,e[o]);if(n.skinInstance){const t=this.skinInstances.indexOf(n.skinInstance);l.skinInstance=r[t]}if(n.morphInstance){const t=this.morphInstances.indexOf(n.morphInstance);l.morphInstance=a[t]}i.push(l)}const o=new qu;return o.graph=n,o.meshInstances=i,o.skinInstances=r,o.morphInstances=a,o.getGraph().syncHierarchy(),o}destroy(){const t=this.meshInstances;for(let e=0;e<t.length;e++)t[e].destroy();this.meshInstances.length=0}generateWireframe(){fc._prepareRenderStyleForArray(this.meshInstances,1)}}class Ku extends gr{constructor(t,e,{preferHighPrecision:s=!1}={}){super(),this.device=e;const n=e;this.preferHighPrecision=s,this._targets=t.slice();const i=n.textureHalfFloatRenderable?Ls:void 0,r=n.textureFloatRenderable?Is:void 0;this._renderTextureFormat=this.preferHighPrecision?r??i:i??r,this._renderTextureFormat=this._renderTextureFormat??Vs,this.intRenderFormat=Xs(this._renderTextureFormat),this._textureFormat=this.preferHighPrecision?Is:Ls,this._init(),this._updateMorphFlags()}destroy(){this.vertexBufferIds?.destroy(),this.vertexBufferIds=null,this.targetsTexturePositions?.destroy(),this.targetsTexturePositions=null,this.targetsTextureNormals?.destroy(),this.targetsTextureNormals=null}get aabb(){if(!this._aabb){const t=new rs,e=new rs;for(let s=0;s<this._targets.length;s++){const n=this._targets[s].aabb;t.min(n.getMin()),e.max(n.getMax())}this._aabb=new Ss,this._aabb.setMinMax(t,e)}return this._aabb}get morphPositions(){return this._morphPositions}get morphNormals(){return this._morphNormals}_init(){this._initTextureBased();for(let t=0;t<this._targets.length;t++)this._targets[t]._postInit()}_findSparseSet(t,e,s){let n=1;const i=t[0].length;for(let r=0;r<i;r+=3){let i=!1;for(let e=0;e<t.length;e++){const s=t[e];if(0!==s[r]||0!==s[r+1]||0!==s[r+2]){i=!0;break}}i?(e.push(n),s.push(r/3),n++):e.push(0)}return n}_initTextureBased(){const t=[],e=[],s=this._targets;for(let n=0;n<s.length;n++){const i=s[n];i.options.deltaPositions&&(t.push(i.options.deltaPositions),e.push(!0)),i.options.deltaNormals&&(t.push(i.options.deltaNormals),e.push(!1))}const n=[],i=[],r=this._findSparseSet(t,n,i),a=this.device.maxTextureSize;let o=Math.ceil(Math.sqrt(r));o=Math.min(o,a);const l=Math.ceil(r/o);if(l>a)return;this.morphTextureWidth=o,this.morphTextureHeight=l;let h=!1;const c=is.float2Half;this._textureFormat===Ls&&(h=!0);const d=[],u=[],f=o*l*4;for(let s=0;s<t.length;s++){const n=t[s],r=this._textureFormat===Ls?new Uint16Array(f):new Float32Array(f);if((e[s]?d:u).push(r),h)for(let t=0;t<i.length;t++){const e=3*i[t],s=4*t+4;r[s]=c(n[e]),r[s+1]=c(n[e+1]),r[s+2]=c(n[e+2])}else for(let t=0;t<i.length;t++){const e=3*i[t],s=4*t+4;r[s]=n[e],r[s+1]=n[e+1],r[s+2]=n[e+2]}}d.length>0&&(this.targetsTexturePositions=this._createTexture("MorphPositionsTexture",this._textureFormat,s.length,[d])),u.length>0&&(this.targetsTextureNormals=this._createTexture("MorphNormalsTexture",this._textureFormat,s.length,[u]));const p=[{semantic:vn,components:1,type:5,asInt:!0}];return this.vertexBufferIds=new ki(this.device,new Ui(this.device,p,n.length),n.length,{data:new Uint32Array(n)}),!0}get targets(){return this._targets}_updateMorphFlags(){this._morphPositions=!1,this._morphNormals=!1;for(let t=0;t<this._targets.length;t++){const e=this._targets[t];e.morphPositions&&(this._morphPositions=!0),e.morphNormals&&(this._morphNormals=!0)}}_createTexture(t,e,s,n){return new pi(this.device,{levels:n,arrayLength:s,width:this.morphTextureWidth,height:this.morphTextureHeight,format:e,cubemap:!1,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1,name:t})}}class Yu{constructor(t){this.used=!1,this.options=t,this._name=t.name,this._defaultWeight=t.defaultWeight||0,this._aabb=t.aabb,this.deltaPositions=t.deltaPositions,this.morphPositions=!!t.deltaPositions,this.morphNormals=!!t.deltaNormals}get name(){return this._name}get defaultWeight(){return this._defaultWeight}get aabb(){return this._aabb||(this._aabb=new Ss,this.deltaPositions&&this._aabb.compute(this.deltaPositions)),this._aabb}clone(){return new Yu(this.options)}_postInit(){this.options.preserveData||(this.options=null),this.used=!0}}class Qu{set colorizeLod(t){this._colorizeLod!==t&&(this._colorizeLod=t,this.dirty=!0)}get colorizeLod(){return this._colorizeLod}set lodBehindPenalty(t){this._lodBehindPenalty!==t&&(this._lodBehindPenalty=t,this.dirty=!0)}get lodBehindPenalty(){return this._lodBehindPenalty}set lodRangeMin(t){this._lodRangeMin!==t&&(this._lodRangeMin=t,this.dirty=!0)}get lodRangeMin(){return this._lodRangeMin}set lodRangeMax(t){this._lodRangeMax!==t&&(this._lodRangeMax=t,this.dirty=!0)}get lodRangeMax(){return this._lodRangeMax}set lodUnderfillLimit(t){this._lodUnderfillLimit!==t&&(this._lodUnderfillLimit=t,this.dirty=!0)}get lodUnderfillLimit(){return this._lodUnderfillLimit}set splatBudget(t){}get splatBudget(){return 0}set colorRamp(t){this._colorRamp!==t&&(this._colorRamp=t,this.dirty=!0)}get colorRamp(){return this._colorRamp}constructor(){this.debugAabbs=!1,this.radialSorting=!1,this.debugNodeAabbs=!1,this.dirty=!1,this._colorizeLod=!1,this.lodUpdateDistance=1,this.lodUpdateAngle=0,this._lodBehindPenalty=1,this._lodRangeMin=0,this._lodRangeMax=10,this._lodUnderfillLimit=0,this._colorRamp=null,this.colorRampIntensity=1,this.colorizeColorUpdate=!1,this.colorUpdateDistance=.2,this.colorUpdateAngle=2,this.colorUpdateDistanceLodScale=2,this.colorUpdateAngleLodScale=2,this.cooldownTicks=100}}const Zu=new class extends Lh{generateKey(t){const e=t.shaderDesc,s=e.vertexGLSL?Oi(e.vertexGLSL):0,n=e.fragmentGLSL?Oi(e.fragmentGLSL):0,i=e.vertexWGSL?Oi(e.vertexWGSL):0,r=e.fragmentWGSL?Oi(e.fragmentWGSL):0,a=Lh.definesHash(t.defines),o=t.shaderChunks?.key??"";let l=`${e.uniqueName}_${a}_${s}_${n}_${i}_${r}_${o}`;return t.skin&&(l+="_skin"),t.useInstancing&&(l+="_inst"),t.useMorphPosition&&(l+="_morphp"),t.useMorphNormal&&(l+="_morphn"),t.useMorphTextureBasedInt&&(l+="_morphi"),l}createAttributesDefinition(t,e){const s=e.shaderDesc.attributes,n=s?{...s}:void 0;e.skin&&(n.vertex_boneWeights=Js,n.vertex_boneIndices=tn),(e.useMorphPosition||e.useMorphNormal)&&(n.morph_vertex_id=vn),t.attributes=n}createVertexDefinition(t,e,s,n){const i=e.shaderDesc,r=new Map(s);r.set("transformInstancingVS","");const a=new Map(e.defines);e.skin&&a.set("SKIN",!0),e.useInstancing&&a.set("INSTANCING",!0),(e.useMorphPosition||e.useMorphNormal)&&(a.set("MORPHING",!0),e.useMorphTextureBasedInt&&a.set("MORPHING_INT",!0),e.useMorphPosition&&a.set("MORPHING_POSITION",!0),e.useMorphNormal&&a.set("MORPHING_NORMAL",!0)),t.vertexCode=n?i.vertexWGSL:i.vertexGLSL,t.vertexIncludes=r,t.vertexDefines=a}createFragmentDefinition(t,e,s,n){const i=e.shaderDesc,r=new Map(s),a=new Map(e.defines);t.fragmentCode=n?i.fragmentWGSL:i.fragmentGLSL,t.fragmentIncludes=r,t.fragmentDefines=a}createShaderDefinition(t,e){const s=e.shaderDesc,n=t.isWebGPU&&!!s.vertexWGSL&&!!s.fragmentWGSL&&(e.shaderChunks?.useWGSL??!0),i={name:`ShaderMaterial-${s.uniqueName}`,shaderLanguage:n?Rn:In,fragmentOutputTypes:s.fragmentOutputTypes,meshUniformBufferFormat:s.meshUniformBufferFormat,meshBindGroupFormat:s.meshBindGroupFormat},r=n?Rn:In,a=Nh.merge(Fh.get(t,r),e.shaderChunks[r]);return this.createAttributesDefinition(i,e),this.createVertexDefinition(i,e,a,n),this.createFragmentDefinition(i,e,a,n),Ma.createDefinition(t,i)}};class Ju extends Cd{constructor(t){super(),this.shaderDesc=t}set shaderDesc(t){if(this._shaderDesc=void 0,t&&(this._shaderDesc={uniqueName:t.uniqueName,attributes:t.attributes,fragmentOutputTypes:t.fragmentOutputTypes,vertexGLSL:t.vertexGLSL,fragmentGLSL:t.fragmentGLSL,vertexWGSL:t.vertexWGSL,fragmentWGSL:t.fragmentWGSL},t.vertexCode||t.fragmentCode||t.shaderLanguage)){const e=t.shaderLanguage??In;e===In?(this._shaderDesc.vertexGLSL=t.vertexCode,this._shaderDesc.fragmentGLSL=t.fragmentCode):e===Rn&&(this._shaderDesc.vertexWGSL=t.vertexCode,this._shaderDesc.fragmentWGSL=t.fragmentCode)}this.clearVariants()}get shaderDesc(){return this._shaderDesc}copy(t){return super.copy(t),this.shaderDesc=t.shaderDesc,this}getShaderVariant(t){const{objDefs:e}=t,s={defines:zh.getCoreDefines(this,t),skin:!!(2&e),useInstancing:!!(32&e),useMorphPosition:0!==(e&lh),useMorphNormal:0!==(e&hh),useMorphTextureBasedInt:0!==(e&ch),pass:t.pass,gamma:t.cameraShaderParams.shaderOutputGamma,toneMapping:t.cameraShaderParams.toneMapping,fog:t.cameraShaderParams.fog,shaderDesc:this.shaderDesc,shaderChunks:this.shaderChunks},n=new Ah(t.viewUniformFormat,t.viewBindGroupFormat,t.vertexFormat),i=Ph(t.device);return i.register("shader-material",Zu),i.getProgram("shader-material",s,n,this.userId)}}const tf={linear:"decodeLinear",srgb:"decodeGamma",rgbm:"decodeRGBM",rgbe:"decodeRGBE",rgbp:"decodeRGBP",xy:"unpackNormalXY",xyz:"unpackNormalXYZ"},ef={linear:"encodeLinear",srgb:"encodeGamma",rgbm:"encodeRGBM",rgbe:"encodeRGBE",rgbp:"encodeRGBP"};class sf{static decodeFunc(t){return tf[t]??"decodeGamma"}static encodeFunc(t){return ef[t]??"encodeGamma"}}const nf=(t,e)=>{const s=e.length/3,n=t.length/3,i=new rs,r=new rs,a=new rs,o=new rs,l=new rs,h=new rs,c=[];for(let e=0;e<t.length;e++)c[e]=0;for(let n=0;n<s;n++){const s=e[3*n],d=e[3*n+1],u=e[3*n+2];i.set(t[3*s],t[3*s+1],t[3*s+2]),r.set(t[3*d],t[3*d+1],t[3*d+2]),a.set(t[3*u],t[3*u+1],t[3*u+2]),o.sub2(r,i),l.sub2(a,i),h.cross(o,l).normalize(),c[3*s]+=h.x,c[3*s+1]+=h.y,c[3*s+2]+=h.z,c[3*d]+=h.x,c[3*d+1]+=h.y,c[3*d+2]+=h.z,c[3*u]+=h.x,c[3*u+1]+=h.y,c[3*u+2]+=h.z}for(let t=0;t<n;t++){const e=c[3*t],s=c[3*t+1],n=c[3*t+2],i=1/Math.sqrt(e*e+s*s+n*n);c[3*t]*=i,c[3*t+1]*=i,c[3*t+2]*=i}return c},rf=(t,e,s,n)=>{const i=n.length/3,r=t.length/3,a=new rs,o=new rs,l=new rs,h=new os,c=new os,d=new os,u=new rs,f=new rs,p=new Float32Array(3*r),m=new Float32Array(3*r),g=[];for(let e=0;e<i;e++){const i=n[3*e],r=n[3*e+1],g=n[3*e+2];a.set(t[3*i],t[3*i+1],t[3*i+2]),o.set(t[3*r],t[3*r+1],t[3*r+2]),l.set(t[3*g],t[3*g+1],t[3*g+2]),h.set(s[2*i],s[2*i+1]),c.set(s[2*r],s[2*r+1]),d.set(s[2*g],s[2*g+1]);const _=o.x-a.x,v=l.x-a.x,y=o.y-a.y,b=l.y-a.y,S=o.z-a.z,x=l.z-a.z,w=c.x-h.x,T=d.x-h.x,C=c.y-h.y,E=d.y-h.y,A=w*E-T*C;if(0===A)u.set(0,1,0),f.set(1,0,0);else{const t=1/A;u.set((E*_-C*v)*t,(E*y-C*b)*t,(E*S-C*x)*t),f.set((w*v-T*_)*t,(w*b-T*y)*t,(w*x-T*S)*t)}p[3*i+0]+=u.x,p[3*i+1]+=u.y,p[3*i+2]+=u.z,p[3*r+0]+=u.x,p[3*r+1]+=u.y,p[3*r+2]+=u.z,p[3*g+0]+=u.x,p[3*g+1]+=u.y,p[3*g+2]+=u.z,m[3*i+0]+=f.x,m[3*i+1]+=f.y,m[3*i+2]+=f.z,m[3*r+0]+=f.x,m[3*r+1]+=f.y,m[3*r+2]+=f.z,m[3*g+0]+=f.x,m[3*g+1]+=f.y,m[3*g+2]+=f.z}const _=new rs,v=new rs,y=new rs,b=new rs;for(let t=0;t<r;t++){y.set(e[3*t],e[3*t+1],e[3*t+2]),_.set(p[3*t],p[3*t+1],p[3*t+2]),v.set(m[3*t],m[3*t+1],m[3*t+2]);const s=y.dot(_);b.copy(y).mulScalar(s),b.sub2(_,b).normalize(),g[4*t]=b.x,g[4*t+1]=b.y,g[4*t+2]=b.z,b.cross(y,_),g[4*t+3]=b.dot(v)<0?-1:1}return g};class af{calculateNormals(){this.normals=nf(this.positions,this.indices)}calculateTangents(){this.tangents=rf(this.positions,this.normals,this.uvs,this.indices)}}const of=4/64;class lf extends af{constructor(t={}){super();const e=t.halfExtents??new rs(.5,.5,.5),s=t.widthSegments??1,n=t.lengthSegments??1,i=t.heightSegments??1,r=t.yOffset??0,a=-e.y+r,o=e.y+r,l=[new rs(-e.x,a,e.z),new rs(e.x,a,e.z),new rs(e.x,o,e.z),new rs(-e.x,o,e.z),new rs(e.x,a,-e.z),new rs(-e.x,a,-e.z),new rs(-e.x,o,-e.z),new rs(e.x,o,-e.z)],h=[[0,1,3],[4,5,7],[3,2,6],[1,0,4],[1,4,2],[5,0,6]],c=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],d=1,u=2,f=3,p=4,m=5,g=[],_=[],v=[],y=[];let b=0;const S=(t,e,s)=>{const n=new rs,i=new rs,r=new rs,a=new rs;for(let o=0;o<=e;o++)for(let d=0;d<=s;d++){n.lerp(l[h[t][0]],l[h[t][1]],o/e),i.lerp(l[h[t][0]],l[h[t][2]],d/s),r.sub2(i,l[h[t][0]]),a.add2(n,r);let u=o/e,f=d/s;g.push(a.x,a.y,a.z),_.push(c[t][0],c[t][1],c[t][2]),v.push(u,1-f),u=.875*u+of,f=.875*f+of,u/=3,f/=3,u+=t%3/3,f+=Math.floor(t/3)/3,o<e&&d<s&&(y.push(b+s+1,b+1,b),y.push(b+s+1,b+s+2,b+1)),b++}};S(0,s,i),S(d,s,i),S(u,s,n),S(f,s,n),S(p,n,i),S(m,n,i),this.positions=g,this.normals=_,this.uvs=v,this.uvs1=v,this.indices=y,t.calculateTangents&&(this.tangents=rf(g,_,v,y))}}class hf extends af{constructor(t={}){super();const e=t.radius??.5,s=t.latitudeBands??16,n=t.longitudeBands??16,i=[],r=[],a=[],o=[];for(let t=0;t<=s;t++){const o=t*Math.PI/s,l=Math.sin(o),h=Math.cos(o);for(let o=0;o<=n;o++){const c=2*o*Math.PI/n-Math.PI/2,d=Math.sin(c),u=Math.cos(c)*l,f=h,p=d*l,m=1-o/n,g=1-t/s;i.push(u*e,f*e,p*e),r.push(u,f,p),a.push(m,1-g)}}for(let t=0;t<s;++t)for(let e=0;e<n;++e){const s=t*(n+1)+e,i=s+n+1;o.push(s+1,i,s),o.push(s+1,i+1,i)}this.positions=i,this.normals=r,this.uvs=a,this.uvs1=a,this.indices=o,t.calculateTangents&&(this.tangents=rf(i,r,a,o))}}class cf extends hf{constructor(t={}){const e=.5;super({radius:e,latitudeBands:t.latitudeBands??16,longitudeBands:t.longitudeBands??16});const s=this.positions;for(let t=0;t<s.length;t+=3){const n=s[t]/e;let i=s[t+1]/e;const r=s[t+2]/e;i<0&&(i*=.3,n*n+r*r<.9025&&(i=-.1)),i+=.1,i*=e,s[t+1]=i}}}class df{static create(t,e){switch(e){case"box":return df.box(t);case _h:return df.dome(t)}return df.infinite(t)}static infinite(t){return tc.fromGeometry(t,new lf(t))}static box(t){return tc.fromGeometry(t,new lf({yOffset:.5}))}static dome(t){const e=new cf({latitudeBands:50,longitudeBands:50});return e.normals=void 0,e.uvs=void 0,tc.fromGeometry(t,e)}}class uf{constructor(t,e,s,n,i){this.meshInstance=null,this._depthWrite=!1;const r=new Ju({uniqueName:"SkyMaterial",vertexGLSL:Fh.get(t,In).get("skyboxVS"),fragmentGLSL:Fh.get(t,In).get("skyboxPS"),vertexWGSL:Fh.get(t,Rn).get("skyboxVS"),fragmentWGSL:Fh.get(t,Rn).get("skyboxPS"),attributes:{aPosition:Ys}});r.setDefine("{SKYBOX_DECODE_FNC}",sf.decodeFunc(n.encoding)),i!==gh&&r.setDefine("SKYMESH",""),n.cubemap&&r.setDefine("SKY_CUBEMAP",""),r.setParameter("skyboxHighlightMultiplier",e.skyboxHighlightMultiplier),n.cubemap?r.setParameter("texture_cubeMap",n):(r.setParameter("texture_envAtlas",n),r.setParameter("mipLevel",e.skyboxMip)),r.cull=2,r.depthWrite=this._depthWrite;const a=e.layers.getLayerById(2);if(a){const e=df.create(t,i),n=new fc(e,r,s);this.meshInstance=n,n.cull=!1,n.pick=!1,a.addMeshInstances([n]),this.skyLayer=a}}destroy(){this.meshInstance&&(this.skyLayer&&this.skyLayer.removeMeshInstances([this.meshInstance]),this.meshInstance.destroy(),this.meshInstance=null)}set depthWrite(t){this._depthWrite=t,this.meshInstance&&(this.meshInstance.material.depthWrite=t)}get depthWrite(){return this._depthWrite}}class ff{constructor(t){this._type=gh,this._center=new rs(0,1,0),this.skyMesh=null,this._depthWrite=!1,this.node=new Hc("SkyMeshNode"),this.device=t.device,this.scene=t,this.center=new rs(0,1,0),this.centerArray=new Float32Array(3),this.projectedSkydomeCenterId=this.device.scope.resolve("projectedSkydomeCenter")}applySettings(t){this.type=t.skyType??gh,this.node.setLocalPosition(new rs(t.skyMeshPosition??[0,0,0])),this.node.setLocalEulerAngles(new rs(t.skyMeshRotation??[0,0,0])),this.node.setLocalScale(new rs(t.skyMeshScale??[1,1,1])),t.skyCenter&&(this._center=new rs(t.skyCenter))}set type(t){this._type!==t&&(this._type=t,this.scene.updateShaders=!0,this.updateSkyMesh())}get type(){return this._type}set center(t){this._center.copy(t)}get center(){return this._center}set depthWrite(t){this._depthWrite!==t&&(this._depthWrite=t,this.skyMesh&&(this.skyMesh.depthWrite=t))}get depthWrite(){return this._depthWrite}updateSkyMesh(){const t=this.scene._getSkyboxTex();t&&(this.resetSkyMesh(),this.skyMesh=new uf(this.device,this.scene,this.node,t,this.type),this.skyMesh.depthWrite=this._depthWrite,this.scene.fire("set:skybox",t))}resetSkyMesh(){this.skyMesh?.destroy(),this.skyMesh=null}update(){if(this.type!==gh){const{center:t,centerArray:e}=this,s=new rs;this.node.getWorldTransform().transformPoint(t,s),e[0]=s.x,e[1]=s.y,e[2]=s.z,this.projectedSkydomeCenterId.setValue(e)}}}const pf=new Hc;pf.worldTransform=ps.IDENTITY,pf._dirtyWorld=pf._dirtyNormal=!1;class mf{constructor(t,e,s){this.material=e,this.layer=s,this.positions=[],this.colors=[],this.mesh=new tc(t),this.meshInstance=null}addLines(t,e){const s=this.positions,n=t.length;for(let e=0;e<n;e++){const n=t[e];s.push(n.x,n.y,n.z)}const i=this.colors;if(e.length)for(let t=0;t<n;t++){const s=e[t];i.push(s.r,s.g,s.b,s.a)}else for(let t=0;t<n;t++)i.push(e.r,e.g,e.b,e.a)}addLinesArrays(t,e){const s=this.positions;for(let e=0;e<t.length;e+=3)s.push(t[e],t[e+1],t[e+2]);const n=this.colors;if(e.length)for(let t=0;t<e.length;t+=4)n.push(e[t],e[t+1],e[t+2],e[t+3]);else{const s=t.length/3;for(let t=0;t<s;t++)n.push(e.r,e.g,e.b,e.a)}}onPreRender(t,e){this.positions.length>0&&this.material.transparent===e&&(this.mesh.setPositions(this.positions),this.mesh.setColors(this.colors),this.mesh.update(1,!1),this.meshInstance||(this.meshInstance=new fc(this.mesh,this.material,pf)),t.push(this.meshInstance))}clear(){this.positions.length=0,this.colors.length=0}}class gf{constructor(t){this.device=t,this.map=new Map}getBatch(t,e){let s=this.map.get(t);return s||(s=new mf(this.device,t,e),this.map.set(t,s)),s}onPreRender(t,e){this.map.forEach(s=>{s.onPreRender(t,e)})}clear(){this.map.forEach(t=>t.clear())}}const _f=[],vf=new rs;class yf{constructor(t){this.shaderDescs=new Map,this.device=t,this.quadMesh=null,this.textureShader=null,this.depthTextureShader=null,this.cubeLocalPos=null,this.cubeWorldPos=null,this.batchesMap=new Map,this.allBatches=new Set,this.updatedLayers=new Set,this._materialDepth=null,this._materialNoDepth=null,this.layerMeshInstances=new Map}createMaterial(t){const e=new Ju({uniqueName:"ImmediateLine",vertexGLSL:Fh.get(this.device,In).get("immediateLineVS"),fragmentGLSL:Fh.get(this.device,In).get("immediateLinePS"),vertexWGSL:Fh.get(this.device,Rn).get("immediateLineVS"),fragmentWGSL:Fh.get(this.device,Rn).get("immediateLinePS"),attributes:{vertex_position:Ys,vertex_color:en}});return e.blendType=2,e.depthTest=t,e.update(),e}get materialDepth(){return this._materialDepth||(this._materialDepth=this.createMaterial(!0)),this._materialDepth}get materialNoDepth(){return this._materialNoDepth||(this._materialNoDepth=this.createMaterial(!1)),this._materialNoDepth}getBatch(t,e){let s=this.batchesMap.get(t);s||(s=new gf(this.device),this.batchesMap.set(t,s)),this.allBatches.add(s);const n=e?this.materialDepth:this.materialNoDepth;return s.getBatch(n,t)}getShaderDesc(t,e,s){return this.shaderDescs.has(t)||this.shaderDescs.set(t,{uniqueName:`DebugShader:${t}`,vertexGLSL:"\n\t\t\t\t\tattribute vec2 vertex_position;\n\t\t\t\t\tuniform mat4 matrix_model;\n\t\t\t\t\tvarying vec2 uv0;\n\t\t\t\t\tvoid main(void) {\n\t\t\t\t\t\tgl_Position = matrix_model * vec4(vertex_position, 0, 1);\n\t\t\t\t\t\tuv0 = vertex_position.xy + 0.5;\n\t\t\t\t\t}\n\t\t\t\t",vertexWGSL:"\n\t\t\t\t\tattribute vertex_position: vec2f;\n\t\t\t\t\tuniform matrix_model: mat4x4f;\n\t\t\t\t\tvarying uv0: vec2f;\n\t\t\t\t\t@vertex fn vertexMain(input: VertexInput) -> VertexOutput {\n\t\t\t\t\t\tvar output: VertexOutput;\n\t\t\t\t\t\toutput.position = uniform.matrix_model * vec4f(input.vertex_position, 0.0, 1.0);\n\t\t\t\t\t\toutput.uv0 = input.vertex_position.xy + vec2f(0.5);\n\t\t\t\t\t\treturn output;\n\t\t\t\t\t}\n\t\t\t\t",fragmentGLSL:e,fragmentWGSL:s,attributes:{vertex_position:Ys}}),this.shaderDescs.get(t)}getTextureShaderDesc(t){const e=sf.decodeFunc(t);return this.getShaderDesc(`textureShader-${t}`,`\n\t\t\t#include "gammaPS"\n\t\t\tvarying vec2 uv0;\n\t\t\tuniform sampler2D colorMap;\n\t\t\tvoid main (void) {\n\t\t\t\tvec3 linearColor = ${e}(texture2D(colorMap, uv0));\n\t\t\t\tgl_FragColor = vec4(gammaCorrectOutput(linearColor), 1);\n\t\t\t}\n\t\t`,`\n\t\t\t#include "gammaPS"\n\t\t\tvarying uv0: vec2f;\n\t\t\tvar colorMap: texture_2d<f32>;\n\t\t\tvar colorMapSampler: sampler;\n\t\t\t@fragment fn fragmentMain(input : FragmentInput) -> FragmentOutput {\n\t\t\t\tvar output: FragmentOutput;\n\t\t\t\tlet sampledTex = textureSample(colorMap, colorMapSampler, input.uv0);\n\t\t\t\tlet linearColor: vec3f = ${e}(sampledTex);\n\t\t\t\toutput.color = vec4f(gammaCorrectOutput(linearColor), 1.0);\n\t\t\t\treturn output;\n\t\t\t}\n\t\t`)}getUnfilterableTextureShaderDesc(){return this.getShaderDesc("textureShaderUnfilterable","\n\t\t\tvarying vec2 uv0;\n\t\t\tuniform highp sampler2D colorMap;\n\t\t\tvoid main (void) {\n\t\t\t\tivec2 uv = ivec2(uv0 * textureSize(colorMap, 0));\n\t\t\t\tgl_FragColor = vec4(texelFetch(colorMap, uv, 0).xyz, 1);\n\t\t\t}\n\t\t","\n\t\t\tvarying uv0: vec2f;\n\t\t\tvar colorMap: texture_2d<uff>;\n\t\t\t@fragment fn fragmentMain(input : FragmentInput) -> FragmentOutput {\n\t\t\t\tvar output: FragmentOutput;\n\t\t\t\tlet uv : vec2<i32> = vec2<i32>(input.uv0 * vec2f(textureDimensions(colorMap, 0)));\n\t\t\t\tlet fetchedColor : vec4f = textureLoad(colorMap, uv, 0);\n\t\t\t\toutput.color = vec4f(fetchedColor.xyz, 1.0);\n\t\t\t\treturn output;\n\t\t\t}\n\t\t")}getDepthTextureShaderDesc(){return this.getShaderDesc("depthTextureShader",'\n\t\t\t#include "screenDepthPS"\n\t\t\t#include "gammaPS"\n\t\t\tvarying vec2 uv0;\n\t\t\tvoid main() {\n\t\t\t\tfloat depth = getLinearScreenDepth(getImageEffectUV(uv0)) * camera_params.x;\n\t\t\t\tgl_FragColor = vec4(gammaCorrectOutput(vec3(depth)), 1.0);\n\t\t\t}\n\t\t','\n\t\t\t#include "screenDepthPS"\n\t\t\t#include "gammaPS"\n\t\t\tvarying uv0: vec2f;\n\t\t\t@fragment fn fragmentMain(input: FragmentInput) -> FragmentOutput {\n\t\t\t\tvar output: FragmentOutput;\n\t\t\t\tlet depth: f32 = getLinearScreenDepth(getImageEffectUV(input.uv0)) * uniform.camera_params.x;\n\t\t\t\toutput.color = vec4f(gammaCorrectOutput(vec3f(depth)), 1.0);\n\t\t\t\treturn output;\n\t\t\t}\n\t\t')}getQuadMesh(){return this.quadMesh||(this.quadMesh=new tc(this.device),this.quadMesh.setPositions([-.5,-.5,0,.5,-.5,0,-.5,.5,0,.5,.5,0]),this.quadMesh.update(5)),this.quadMesh}drawMesh(t,e,s,n,i){if(!n){const i=this.getGraphNode(e);n=new fc(s,t,i)}let r=this.layerMeshInstances.get(i);r||(r=[],this.layerMeshInstances.set(i,r)),r.push(n)}drawWireAlignedBox(t,e,s,n,i,r){if(r){const s=(t,e,s)=>{vf.set(t,e,s),r.transformPoint(vf,vf),_f.push(vf.x,vf.y,vf.z)};s(t.x,t.y,t.z),s(t.x,e.y,t.z),s(t.x,e.y,t.z),s(e.x,e.y,t.z),s(e.x,e.y,t.z),s(e.x,t.y,t.z),s(e.x,t.y,t.z),s(t.x,t.y,t.z),s(t.x,t.y,e.z),s(t.x,e.y,e.z),s(t.x,e.y,e.z),s(e.x,e.y,e.z),s(e.x,e.y,e.z),s(e.x,t.y,e.z),s(e.x,t.y,e.z),s(t.x,t.y,e.z),s(t.x,t.y,t.z),s(t.x,t.y,e.z),s(t.x,e.y,t.z),s(t.x,e.y,e.z),s(e.x,e.y,t.z),s(e.x,e.y,e.z),s(e.x,t.y,t.z),s(e.x,t.y,e.z)}else _f.push(t.x,t.y,t.z,t.x,e.y,t.z,t.x,e.y,t.z,e.x,e.y,t.z,e.x,e.y,t.z,e.x,t.y,t.z,e.x,t.y,t.z,t.x,t.y,t.z,t.x,t.y,e.z,t.x,e.y,e.z,t.x,e.y,e.z,e.x,e.y,e.z,e.x,e.y,e.z,e.x,t.y,e.z,e.x,t.y,e.z,t.x,t.y,e.z,t.x,t.y,t.z,t.x,t.y,e.z,t.x,e.y,t.z,t.x,e.y,e.z,e.x,e.y,t.z,e.x,e.y,e.z,e.x,t.y,t.z,e.x,t.y,e.z);this.getBatch(i,n).addLinesArrays(_f,s),_f.length=0}drawWireSphere(t,e,s,n,i,r){const a=2*Math.PI/n;let o=0;for(let s=0;s<n;s++){const s=Math.sin(o),n=Math.cos(o);o+=a;const i=Math.sin(o),r=Math.cos(o);_f.push(t.x+e*s,t.y,t.z+e*n),_f.push(t.x+e*i,t.y,t.z+e*r),_f.push(t.x+e*s,t.y+e*n,t.z),_f.push(t.x+e*i,t.y+e*r,t.z),_f.push(t.x,t.y+e*s,t.z+e*n),_f.push(t.x,t.y+e*i,t.z+e*r)}this.getBatch(r,i).addLinesArrays(_f,s),_f.length=0}getGraphNode(t){const e=new Hc("ImmediateDebug");return e.worldTransform=t,e._dirtyWorld=e._dirtyNormal=!1,e}onPreRenderLayer(t,e,s){if(this.batchesMap.forEach((n,i)=>{i===t&&n.onPreRender(e,s)}),!this.updatedLayers.has(t)){this.updatedLayers.add(t);const s=this.layerMeshInstances.get(t);if(s){for(let t=0;t<s.length;t++)e.push(s[t]);s.length=0}}}onPostRender(){this.allBatches.forEach(t=>t.clear()),this.allBatches.clear(),this.updatedLayers.clear()}}const bf=2.399963229728653,Sf={circlePoint(t){const e=Math.sqrt(Math.random()),s=2*Math.random()*Math.PI;t.x=e*Math.cos(s),t.y=e*Math.sin(s)},circlePointDeterministic(t,e,s){const n=e*bf,i=Math.sqrt(e/s);t.x=i*Math.cos(n),t.y=i*Math.sin(n)},spherePointDeterministic(t,e,s,n=0,i=1){n=1-2*n,i=1-2*i;const r=Qe.lerp(n,i,e/s),a=Math.sqrt(1-r*r),o=bf*e;t.x=Math.cos(o)*a,t.y=r,t.z=Math.sin(o)*a},radicalInverse(t){let e=(t<<16|t>>>16)>>>0;return e=((1431655765&e)<<1|(2863311530&e)>>>1)>>>0,e=((858993459&e)<<2|(3435973836&e)>>>2)>>>0,e=((252645135&e)<<4|(4042322160&e)>>>4)>>>0,e=((16711935&e)<<8|(4278255360&e)>>>8)>>>0,2.3283064365386963e-10*e}},xf=t=>{switch(t){case Pn:return"Cubemap";case"octahedral":return"Octahedral";default:return"Equirect"}},wf=(t,e,s)=>{if(t<=0)e[s+0]=0,e[s+1]=0,e[s+2]=0,e[s+3]=0;else if(t>=1)e[s+0]=255,e[s+1]=0,e[s+2]=0,e[s+3]=0;else{let n=1*t%1,i=255*t%1,r=65025*t%1;const a=16581375*t%1;n-=i/255,i-=r/255,r-=a/255,e[s+0]=Math.min(255,Math.floor(256*n)),e[s+1]=Math.min(255,Math.floor(256*i)),e[s+2]=Math.min(255,Math.floor(256*r)),e[s+3]=Math.min(255,Math.floor(256*a))}},Tf=(t,e,s,n)=>{const i=2*s*Math.PI,r=Math.pow(1-e,1/(n+1)),a=Math.sqrt(1-r*r);t.set(Math.cos(i)*a,Math.sin(i)*a,r).normalize()},Cf=(t,e,s)=>{const n=2*s*Math.PI,i=Math.sqrt(1-e),r=Math.sqrt(e);t.set(Math.cos(n)*r,Math.sin(n)*r,i).normalize()},Ef=(t,e,s,n)=>{const i=2*s*Math.PI,r=Math.sqrt((1-e)/(1+(n*n-1)*e)),a=Math.sqrt(1-r*r);t.set(Math.cos(i)*a,Math.sin(i)*a,r).normalize()},Af=(t,e)=>{const s=t*e,n=e/(1-t*t+s*s);return n*n*(1/Math.PI)},Df={16:{2:26,8:20,32:17,128:16,512:16},32:{2:53,8:40,32:34,128:32,512:32},128:{2:214,8:163,32:139,128:130,512:128},1024:{2:1722,8:1310,32:1114,128:1041,512:1025}},Pf=(t,e,s)=>{const n=s/t,i=1-Math.log2(e)/11,r=i*i,a=new rs,o=new rs,l=new rs(0,0,1),h=[],c=((t,e)=>{const s=Df[t];return s&&s[e]||t})(t,e);for(let t=0;t<c;++t){Ef(a,t/c,Sf.radicalInverse(t),r);const e=a.z;if(o.set(a.x,a.y,a.z).mulScalar(2*e).sub(l),o.z>0){const t=Af(Math.min(1,e),r)/4+.001,s=.5*Math.log2(n/t);h.push(o.x,o.y,o.z,s)}}for(;h.length<4*t;)h.push(0,0,0,0);return h},Lf=(t,e,s)=>{const n=(t=>{const e=t.length,s=Math.min(e,512),n=Math.ceil(e/s),i=new Uint8Array(s*n*4);let r=0;for(let s=0;s<e;s+=4)wf(.5*t[s+0]+.5,i,r+0),wf(.5*t[s+1]+.5,i,r+4),wf(.5*t[s+2]+.5,i,r+8),wf(t[s+3]/8,i,r+12),r+=16;return{width:s,height:n,data:i}})(s);return new pi(t,{name:e,width:n.width,height:n.height,mipmaps:!1,minFilter:0,magFilter:0,levels:[n.data]})};class If{constructor(t=!0){this.map=new Map,this.destroyContent=t}destroy(){this.destroyContent&&this.map.forEach((t,e)=>{t.destroy()})}get(t,e){if(!this.map.has(t)){const s=e();return this.map.set(t,s),s}return this.map.get(t)}}const Rf=new If(!1),Mf=new di,kf=(t,e,s)=>Mf.get(t,()=>new If).get(e,()=>Lf(t,e,Rf.get(e,s))),Of=(t,e,s)=>kf(t,`lambert-samples-${e}-${s}`,()=>((t,e)=>{const s=e/t,n=new rs,i=[];for(let e=0;e<t;++e){Cf(n,e/t,Sf.radicalInverse(e));const r=n.z/Math.PI,a=.5*Math.log2(s/r);i.push(n.x,n.y,n.z,a)}return i})(e,s)),Ff=(t,e,s)=>kf(t,`phong-samples-${e}-${s}`,()=>((t,e)=>{const s=new rs,n=[];for(let i=0;i<t;++i)Tf(s,i/t,Sf.radicalInverse(i),e),n.push(s.x,s.y,s.z,0);return n})(e,s));function Nf(t,e,s={}){const n=s.seamPixels??0,i=(s.rect?.z??e.width)-2*n,r=(s.rect?.w??e.height)-2*n;if(i<1||r<1)return!1;const a=s.hasOwnProperty("specularPower")?s.specularPower:1,o=s.hasOwnProperty("face")?s.face:null,l=s.hasOwnProperty("distribution")?s.distribution:1===a?"none":"phong",h={none:"reproject",lambert:"prefilterSamplesUnweighted",phong:"prefilterSamplesUnweighted",ggx:"prefilterSamples"}[l]||"reproject",c=h.startsWith("prefilterSamples"),d=sf.decodeFunc(t.encoding),u=sf.encodeFunc(e.encoding),f=`sample${xf(t.projection)}`,p=`getDirection${xf(e.projection)}`,m=s.hasOwnProperty("numSamples")?s.numSamples:1024,g=`ReprojectShader:${h}_${d}_${u}_${f}_${p}_${m}`,_=t.device;let v=Ph(_).getCachedShader(g);if(!v){const e=new Map;c&&e.set("USE_SAMPLES_TEX",""),t.cubemap&&e.set("CUBEMAP_SOURCE",""),e.set("{PROCESS_FUNC}",h),e.set("{DECODE_FUNC}",d),e.set("{ENCODE_FUNC}",u),e.set("{SOURCE_FUNC}",f),e.set("{TARGET_FUNC}",p),e.set("{NUM_SAMPLES}",m),e.set("{NUM_SAMPLES_SQRT}",Math.round(Math.sqrt(m)).toFixed(1));const s=_.isWebGPU,n=Fh.get(_,s?Rn:In),i=new Map;i.set("decodePS",n.get("decodePS")),i.set("encodePS",n.get("encodePS")),v=zh.createShader(_,{uniqueName:g,attributes:{vertex_position:Ys},vertexChunk:"reprojectVS",fragmentChunk:"reprojectPS",fragmentIncludes:i,fragmentDefines:e})}_.setBlendState(Ti.NOBLEND);_.scope.resolve(t.cubemap?"sourceCube":"sourceTex").setValue(t);const y=_.scope.resolve("params"),b=_.scope.resolve("uvMod");n>0?b.setValue([(i+2*n)/i,(r+2*n)/r,-n/i,-n/r]):b.setValue([1,1,0,0]);const S=[0,e.width*e.height*(e.cubemap?6:1),t.width*t.height*(t.cubemap?6:1)];if(c){const e=t.width*t.height*(t.cubemap?6:1),s="ggx"===l?((t,e,s,n)=>kf(t,`ggx-samples-${e}-${s}-${n}`,()=>Pf(e,s,n)))(_,m,a,e):"lambert"===l?Of(_,m,e):Ff(_,m,a);_.scope.resolve("samplesTex").setValue(s),_.scope.resolve("samplesTexInverseSize").setValue([1/s.width,1/s.height])}for(let t=0;t<(e.cubemap?6:1);t++)if(null===o||t===o){const n=new ji({colorBuffer:e,face:t,depth:!1,flipY:_.isWebGPU});S[0]=t,y.setValue(S),Xh(_,n,v,s?.rect),n.destroy()}return!0}const Bf=(t,e=0)=>1+Math.floor(Math.log2(Math.max(t,e)));class zf{static generateSkyboxCubemap(t,e){const s=((t,e,s)=>new pi(t,{name:`lighting-${e}`,cubemap:!0,width:e,height:e,format:s,type:xn,addressU:1,addressV:1,mipmaps:!1}))(t.device,e||(t.cubemap?t.width:t.width/4),7);return Nf(t,s,{numSamples:1024}),s}static generateLightingSource(t,e){const s=t.device,n=(t=>(t=>t.textureHalfFloatRenderable)(t)?Ls:(t=>t.textureFloatRenderable)(t)?Is:7)(s),i=e?.target||new pi(s,{name:"lighting-source",cubemap:!0,width:e?.size||128,height:e?.size||128,format:n,type:7===n?xn:yn,addressU:1,addressV:1,mipmaps:!0});return Nf(t,i,{numSamples:t.mipmaps?1:1024}),i}static generateAtlas(t,e){const s=t.device,n=e?.target||new pi(s,{name:"envAtlas",width:e?.size||512,height:e?.size||512,format:7,type:xn,projection:Ln,addressU:1,addressV:1,mipmaps:!1}),i=n.width/512,r=new ls(0,0,512*i,256*i),a=Bf(256)-Bf(4);for(let e=0;e<a;++e)Nf(t,n,{numSamples:1,rect:r,seamPixels:i}),r.x+=r.w,r.y+=r.w,r.z=Math.max(1,Math.floor(.5*r.z)),r.w=Math.max(1,Math.floor(.5*r.w));r.set(0,256*i,256*i,128*i);for(let s=1;s<7;++s)Nf(t,n,{numSamples:e?.numReflectionSamples||1024,distribution:e?.distribution||"ggx",specularPower:Math.max(1,2048>>2*s),rect:r,seamPixels:i}),r.y+=r.w,r.z=Math.max(1,Math.floor(.5*r.z)),r.w=Math.max(1,Math.floor(.5*r.w));return r.set(128*i,384*i,64*i,32*i),Nf(t,n,{numSamples:e?.numAmbientSamples||2048,distribution:"lambert",rect:r,seamPixels:i}),n}static generatePrefilteredAtlas(t,e){const s=t[0].device,n=t[0].format,i=t[0].type,r=e?.target||new pi(s,{name:"envPrefilteredAtlas",width:e?.size||512,height:e?.size||512,format:n,type:i,projection:Ln,addressU:1,addressV:1,mipmaps:!1}),a=r.width/512,o=new ls(0,0,512*a,256*a),l=Bf(512);for(let e=0;e<l;++e)Nf(t[0],r,{numSamples:1,rect:o,seamPixels:a}),o.x+=o.w,o.y+=o.w,o.z=Math.max(1,Math.floor(.5*o.z)),o.w=Math.max(1,Math.floor(.5*o.w));o.set(0,256*a,256*a,128*a);for(let e=1;e<t.length;++e)Nf(t[e],r,{numSamples:1,rect:o,seamPixels:a}),o.y+=o.w,o.z=Math.max(1,Math.floor(.5*o.z)),o.w=Math.max(1,Math.floor(.5*o.w));return o.set(128*a,384*a,64*a,32*a),e?.legacyAmbient?Nf(t[5],r,{numSamples:1,rect:o,seamPixels:a}):Nf(t[0],r,{numSamples:e?.numSamples||2048,distribution:"lambert",rect:o,seamPixels:a}),r}}class Uf{constructor(){this.type=xl,this.color=new Ze(0,0,0),this.density=0,this.start=1,this.end=1e3}}class Vf extends Ve{static{this.EVENT_SETLAYERS="set:layers"}static{this.EVENT_SETSKYBOX="set:skybox"}static{this.EVENT_PRERENDER="prerender"}static{this.EVENT_POSTRENDER="postrender"}static{this.EVENT_PRERENDER_LAYER="prerender:layer"}static{this.EVENT_POSTRENDER_LAYER="postrender:layer"}static{this.EVENT_PRECULL="precull"}static{this.EVENT_POSTCULL="postcull"}constructor(t){super(),this.ambientBake=!1,this.ambientBakeOcclusionBrightness=0,this.ambientBakeOcclusionContrast=0,this.ambientLight=new Ze(0,0,0),this.ambientLuminance=0,this.exposure=1,this.lightmapSizeMultiplier=1,this.lightmapMaxResolution=2048,this.lightmapMode=1,this.lightmapFilterEnabled=!1,this.lightmapHDR=!1,this.root=null,this.physicalUnits=!1,this._envAtlas=null,this._skyboxCubeMap=null,this._fogParams=new Uf,this.forcePassThroughSpecular=!1,this.device=t,this._gravity=new rs(0,-9.8,0),this._layers=null,this._prefilteredCubemaps=[],this._internalEnvAtlas=null,this._skyboxIntensity=1,this._skyboxLuminance=0,this._skyboxMip=0,this._skyboxHighlightMultiplier=1,this._skyboxRotationShaderInclude=!1,this._skyboxRotation=new ms,this._skyboxRotationMat3=new as,this._skyboxRotationMat4=new ps,this._ambientBakeNumSamples=1,this._ambientBakeSpherePart=.4,this._lightmapFilterRange=10,this._lightmapFilterSmoothness=.2,this._clusteredLightingEnabled=!0,this._lightingParams=new $u(this.device.supportsAreaLights,this.device.maxTextureSize,()=>{this.updateShaders=!0}),this._gsplatParams=new Qu,this._sky=new ff(this),this._stats={meshInstances:0,lights:0,dynamicLights:0,bakedLights:0,updateShadersTime:0},this.updateShaders=!0,this._shaderVersion=0,this.immediate=new yf(this.device)}get defaultDrawLayer(){return this.layers.getLayerById(3)}set ambientBakeNumSamples(t){this._ambientBakeNumSamples=Qe.clamp(Math.floor(t),1,255)}get ambientBakeNumSamples(){return this._ambientBakeNumSamples}set ambientBakeSpherePart(t){this._ambientBakeSpherePart=Qe.clamp(t,.001,1)}get ambientBakeSpherePart(){return this._ambientBakeSpherePart}set clusteredLightingEnabled(t){this.device.isWebGPU&&!t||(this._clusteredLightingEnabled||!t?this._clusteredLightingEnabled=t:console.error("Turning on disabled clustered lighting is not currently supported"))}get clusteredLightingEnabled(){return this._clusteredLightingEnabled}set envAtlas(t){t!==this._envAtlas&&(this._envAtlas=t,t&&(t.addressU=1,t.addressV=1,t.minFilter=1,t.magFilter=1,t.mipmaps=!1),this._prefilteredCubemaps=[],this._internalEnvAtlas&&(this._internalEnvAtlas.destroy(),this._internalEnvAtlas=null),this._resetSkyMesh())}get envAtlas(){return this._envAtlas}set layers(t){const e=this._layers;this._layers=t,this.fire("set:layers",e,t)}get layers(){return this._layers}get sky(){return this._sky}get lighting(){return this._lightingParams}get gsplat(){return this._gsplatParams}get fog(){return this._fogParams}set lightmapFilterRange(t){this._lightmapFilterRange=Math.max(t,.001)}get lightmapFilterRange(){return this._lightmapFilterRange}set lightmapFilterSmoothness(t){this._lightmapFilterSmoothness=Math.max(t,.001)}get lightmapFilterSmoothness(){return this._lightmapFilterSmoothness}set prefilteredCubemaps(t){t=t||[];const e=this._prefilteredCubemaps,s=e.length!==t.length||e.some((e,s)=>e!==t[s]);if(s){const e=6===t.length&&t.every(t=>!!t);e?(this._internalEnvAtlas=zf.generatePrefilteredAtlas(t,{target:this._internalEnvAtlas}),this._envAtlas=this._internalEnvAtlas):(this._internalEnvAtlas&&(this._internalEnvAtlas.destroy(),this._internalEnvAtlas=null),this._envAtlas=null),this._prefilteredCubemaps=t.slice(),this._resetSkyMesh()}}get prefilteredCubemaps(){return this._prefilteredCubemaps}set skybox(t){t!==this._skyboxCubeMap&&(this._skyboxCubeMap=t,this._resetSkyMesh())}get skybox(){return this._skyboxCubeMap}set skyboxIntensity(t){t!==this._skyboxIntensity&&(this._skyboxIntensity=t,this._resetSkyMesh())}get skyboxIntensity(){return this._skyboxIntensity}set skyboxLuminance(t){t!==this._skyboxLuminance&&(this._skyboxLuminance=t,this._resetSkyMesh())}get skyboxLuminance(){return this._skyboxLuminance}set skyboxMip(t){t!==this._skyboxMip&&(this._skyboxMip=t,this._resetSkyMesh())}get skyboxMip(){return this._skyboxMip}set skyboxHighlightMultiplier(t){t!==this._skyboxHighlightMultiplier&&(this._skyboxHighlightMultiplier=t,this._resetSkyMesh())}get skyboxHighlightMultiplier(){return this._skyboxHighlightMultiplier}set skyboxRotation(t){if(!this._skyboxRotation.equals(t)){const e=t.equals(ms.IDENTITY);this._skyboxRotation.copy(t),e?this._skyboxRotationMat3.setIdentity():(this._skyboxRotationMat4.setTRS(rs.ZERO,t,rs.ONE),this._skyboxRotationMat3.invertMat4(this._skyboxRotationMat4)),this._skyboxRotationShaderInclude||e||(this._skyboxRotationShaderInclude=!0,this._resetSkyMesh())}}get skyboxRotation(){return this._skyboxRotation}destroy(){this._resetSkyMesh(),this.root=null,this.off()}drawLine(t,e,s=Ze.WHITE,n=!0,i=this.defaultDrawLayer){this.immediate.getBatch(i,n).addLines([t,e],[s,s])}drawLines(t,e,s=!0,n=this.defaultDrawLayer){this.immediate.getBatch(n,s).addLines(t,e)}drawLineArrays(t,e,s=!0,n=this.defaultDrawLayer){this.immediate.getBatch(n,s).addLinesArrays(t,e)}applySettings(t){const e=t.physics,s=t.render;this._gravity.set(e.gravity[0],e.gravity[1],e.gravity[2]),this.ambientLight.set(s.global_ambient[0],s.global_ambient[1],s.global_ambient[2]),this.ambientLuminance=s.ambientLuminance,this.fog.type=s.fog,this.fog.color.set(s.fog_color[0],s.fog_color[1],s.fog_color[2]),this.fog.start=s.fog_start,this.fog.end=s.fog_end,this.fog.density=s.fog_density,this.lightmapSizeMultiplier=s.lightmapSizeMultiplier,this.lightmapMaxResolution=s.lightmapMaxResolution,this.lightmapMode=s.lightmapMode,this.exposure=s.exposure,this._skyboxIntensity=s.skyboxIntensity??1,this._skyboxLuminance=s.skyboxLuminance??2e4,this._skyboxMip=s.skyboxMip??0,s.skyboxRotation&&(this.skyboxRotation=(new ms).setFromEulerAngles(s.skyboxRotation[0],s.skyboxRotation[1],s.skyboxRotation[2])),this.sky.applySettings(s),this.clusteredLightingEnabled=s.clusteredLightingEnabled??!1,this.lighting.applySettings(s),["lightmapFilterEnabled","lightmapFilterRange","lightmapFilterSmoothness","ambientBake","ambientBakeNumSamples","ambientBakeSpherePart","ambientBakeOcclusionBrightness","ambientBakeOcclusionContrast"].forEach(t=>{s.hasOwnProperty(t)&&(this[t]=s[t])}),this._resetSkyMesh()}_getSkyboxTex(){const t=this._prefilteredCubemaps;if(this._skyboxMip){return t[[0,1,3,4,5,6][this._skyboxMip]]||this._envAtlas||t[0]||this._skyboxCubeMap}return this._skyboxCubeMap||t[0]||this._envAtlas}_updateSkyMesh(){this.sky.skyMesh||this.sky.updateSkyMesh(),this.sky.update()}_resetSkyMesh(){this.sky.resetSkyMesh(),this.updateShaders=!0}setSkybox(t){t?(this.skybox=t[0]||null,t[1]&&!t[1].cubemap?this.envAtlas=t[1]:this.prefilteredCubemaps=t.slice(1)):(this.skybox=null,this.envAtlas=null)}get lightmapPixelFormat(){return this.lightmapHDR&&this.device.getRenderableHdrFormat()||7}}class Hf{constructor(t,e,s){this.device=t,this.inverseBindPose=e,this.boneNames=s}}class Gf extends Fo{set shader(t){this.quadRender?.destroy(),this.quadRender=null,this._shader=t,t&&(this.quadRender=new Wh(t))}get shader(){return this._shader}execute(){const t=this.device;t.setBlendState(this.blendState),t.setCullMode(this.cullMode),t.setDepthState(this.depthState),t.setStencilState(this.stencilFront,this.stencilBack),this.quadRender.render()}constructor(...t){super(...t),this._shader=null,this.quadRender=null,this.cullMode=0,this.blendState=Ti.NOBLEND,this.depthState=Ai.NODEPTH,this.stencilFront=null,this.stencilBack=null}}class Wf{constructor(){this.hasTangents=!1,this.shaderChunks=null,this.pass=0,this.alphaTest=!1,this.blendType=3,this.separateAmbient=!1,this.screenSpace=!1,this.skin=!1,this.batch=!1,this.useInstancing=!1,this.useMorphPosition=!1,this.useMorphNormal=!1,this.useMorphTextureBasedInt=!1,this.nineSlicedMode=0,this.clusteredLightingEnabled=!0,this.clusteredLightingCookiesEnabled=!1,this.clusteredLightingShadowsEnabled=!1,this.clusteredLightingShadowType=0,this.clusteredLightingAreaLightsEnabled=!1,this.vertexColors=!1,this.useVertexColorGamma=!1,this.lightMapEnabled=!1,this.dirLightMapEnabled=!1,this.useHeights=!1,this.useNormals=!1,this.useClearCoatNormals=!1,this.useAo=!1,this.diffuseMapEnabled=!1,this.pixelSnap=!1,this.ambientSH=!1,this.ssao=!1,this.twoSidedLighting=!1,this.occludeDirect=!1,this.occludeSpecular=0,this.occludeSpecularFloat=!1,this.useMsdf=!1,this.msdfTextAttribute=!1,this.alphaToCoverage=!1,this.opacityFadesSpecular=!1,this.opacityDither=vh,this.opacityShadowDither=vh,this.cubeMapProjection=0,this.useSpecular=!1,this.useSpecularityFactor=!1,this.enableGGXSpecular=!1,this.fresnelModel=0,this.useRefraction=!1,this.useClearCoat=!1,this.useSheen=!1,this.useIridescence=!1,this.useMetalness=!1,this.useDynamicRefraction=!1,this.dispersion=!1,this.fog=xl,this.gamma=0,this.toneMap=-1,this.reflectionSource=Ql,this.reflectionEncoding=null,this.reflectionCubemapEncoding=null,this.ambientSource="constant",this.ambientEncoding=null,this.skyboxIntensity=1,this.useCubeMapRotation=!1,this.lightMapWithoutAmbient=!1,this.lights=[],this.noShadow=!1,this.lightMaskDynamic=0,this.userAttributes={},this.linearDepth=!1,this.shadowCatcher=!1}}class jf{static update(t,e,s,n,i,r,a){jf.updateSharedOptions(t,e,s,i,r),jf.updateMaterialOptions(t,e),jf.updateEnvOptions(t,e,s,n),jf.updateLightingOptions(t,e,s,i,a)}static updateSharedOptions(t,e,s,n,i){t.shaderChunks=e.shaderChunks,t.pass=i,t.alphaTest=e.alphaTest>0,t.blendType=e.blendType,t.screenSpace=n&&0!==(n&oh),t.skin=n&&!!(2&n),t.useInstancing=n&&!!(32&n),t.useMorphPosition=n&&0!==(n&lh),t.useMorphNormal=n&&0!==(n&hh),t.useMorphTextureBasedInt=n&&0!==(n&ch),t.hasTangents=n&&!!(512&n),t.nineSlicedMode=e.nineSlicedMode||0,e.useLighting&&s.clusteredLightingEnabled?(t.clusteredLightingEnabled=!0,t.clusteredLightingCookiesEnabled=s.lighting.cookiesEnabled,t.clusteredLightingShadowsEnabled=s.lighting.shadowsEnabled,t.clusteredLightingShadowType=s.lighting.shadowType,t.clusteredLightingAreaLightsEnabled=s.lighting.areaLightsEnabled):(t.clusteredLightingEnabled=!1,t.clusteredLightingCookiesEnabled=!1,t.clusteredLightingShadowsEnabled=!1,t.clusteredLightingAreaLightsEnabled=!1)}static updateMaterialOptions(t,e){t.separateAmbient=!1,t.pixelSnap=e.pixelSnap,t.ambientSH=e.ambientSH,t.twoSidedLighting=e.twoSidedLighting,t.occludeDirect=e.occludeDirect,t.occludeSpecular=e.occludeSpecular,t.occludeSpecularFloat=1!==e.occludeSpecularIntensity,t.useMsdf=!1,t.msdfTextAttribute=!1,t.alphaToCoverage=e.alphaToCoverage,t.opacityFadesSpecular=e.opacityFadesSpecular,t.opacityDither=e.opacityDither,t.cubeMapProjection=0,t.useSpecular=e.hasSpecular,t.useSpecularityFactor=e.hasSpecularityFactor,t.enableGGXSpecular=e.ggxSpecular,t.fresnelModel=e.fresnelModel,t.useRefraction=e.hasRefraction,t.useClearCoat=e.hasClearCoat,t.useSheen=e.hasSheen,t.useIridescence=e.hasIrridescence,t.useMetalness=e.hasMetalness,t.useDynamicRefraction=e.dynamicRefraction,t.dispersion=e.dispersion>0,t.vertexColors=!1,t.lightMapEnabled=e.hasLighting,t.dirLightMapEnabled=e.dirLightMap,t.useHeights=e.hasHeights,t.useNormals=e.hasNormals,t.useClearCoatNormals=e.hasClearCoatNormals,t.useAo=e.hasAo,t.diffuseMapEnabled=e.hasDiffuseMap}static updateEnvOptions(t,e,s,n){t.fog=e.useFog?n.fog:xl,t.gamma=n.shaderOutputGamma,t.toneMap=e.useTonemap?n.toneMapping:6,e.useSkybox&&s.envAtlas&&s.skybox?(t.reflectionSource=Jl,t.reflectionEncoding=s.envAtlas.encoding,t.reflectionCubemapEncoding=s.skybox.encoding):e.useSkybox&&s.envAtlas?(t.reflectionSource=Zl,t.reflectionEncoding=s.envAtlas.encoding):e.useSkybox&&s.skybox?(t.reflectionSource=th,t.reflectionEncoding=s.skybox.encoding):(t.reflectionSource=Ql,t.reflectionEncoding=null),e.ambientSH?(t.ambientSource=nh,t.ambientEncoding=null):t.reflectionSource!==Ql&&s.envAtlas?(t.ambientSource=ih,t.ambientEncoding=s.envAtlas.encoding):(t.ambientSource=rh,t.ambientEncoding=null);const i=t.reflectionSource!==Ql;t.skyboxIntensity=i,t.useCubeMapRotation=i&&s._skyboxRotationShaderInclude}static updateLightingOptions(t,e,s,n,i){if(t.lightMapWithoutAmbient=!1,e.useLighting){const e=[],r=n?n>>16:1;t.lightMaskDynamic=!!(1&r),t.lightMapWithoutAmbient=!1,i&&(jf.collectLights(0,i[0],e,r),s.clusteredLightingEnabled||(jf.collectLights(1,i[1],e,r),jf.collectLights(2,i[2],e,r))),t.lights=e}else t.lights=[];(0===t.lights.length&&!s.clusteredLightingEnabled||1&n)&&(t.noShadow=!0)}static collectLights(t,e,s,n){for(let t=0;t<e.length;t++){const i=e[t];i.enabled&&i.mask&n&&s.push(i)}}}const $f={vertex_normal:Qs,vertex_tangent:Zs,vertex_texCoord0:nn,vertex_texCoord1:rn,vertex_color:en,vertex_boneWeights:Js,vertex_boneIndices:tn};class Xf{constructor(t,e,s=!0){this.varyingsCode="",this.vDefines=new Map,this.fDefines=new Map,this.includes=new Map,this.chunks=null,this.device=t,this.options=e;const n=e.shaderChunks;if(this.shaderLanguage=t.isWebGPU&&s&&(!n||n.useWGSL)?Rn:In,this.attributes={vertex_position:Ys},e.userAttributes)for(const[t,s]of Object.entries(e.userAttributes))this.attributes[s]=t;const i=Fh.get(t,this.shaderLanguage);if(this.chunks=new Map(i),n){(this.shaderLanguage===In?n.glsl:n.wgsl).forEach((t,e)=>{for(const e in $f)$f.hasOwnProperty(e)&&t.indexOf(e)>=0&&(this.attributes[e]=$f[e]);this.chunks.set(e,t)})}this.shaderPassInfo=Mh.get(this.device).getByIndex(e.pass),this.shadowPass=this.shaderPassInfo.isShadow,this.lighting=e.lights.length>0||e.dirLightMapEnabled||e.clusteredLightingEnabled,this.reflections=e.reflectionSource!==Ql,this.needsNormal=this.lighting||this.reflections||e.useSpecular||e.ambientSH||e.useHeights||e.enableGGXSpecular||e.clusteredLightingEnabled&&!this.shadowPass||e.useClearCoatNormals,this.needsNormal=this.needsNormal&&!this.shadowPass,this.needsSceneColor=e.useDynamicRefraction,this.needsScreenSize=e.useDynamicRefraction,this.needsTransforms=e.useDynamicRefraction,this.vshader=null,this.fshader=null}fDefineSet(t,e,s=""){t&&this.fDefines.set(e,s)}generateVertexShader(t,e,s){const{options:n,vDefines:i,attributes:r}=this,a=new Map;if(a.set("vPositionW","vec3"),1!==n.nineSlicedMode&&2!==n.nineSlicedMode||i.set("NINESLICED",!0),this.options.linearDepth&&(i.set("LINEAR_DEPTH",!0),a.set("vLinearDepth","float")),this.needsNormal&&i.set("NORMALS",!0),this.options.useInstancing){const t=Fh.get(this.device,this.shaderLanguage);this.chunks.get("transformInstancingVS")===t.get("transformInstancingVS")&&(r.instance_line1=pn,r.instance_line2=mn,r.instance_line3=_n,r.instance_line4=vn)}this.needsNormal&&(r.vertex_normal=Qs,a.set("vNormalW","vec3"),n.hasTangents&&(n.useHeights||n.useNormals||n.useClearCoatNormals||n.enableGGXSpecular)?(i.set("TANGENTS",!0),r.vertex_tangent=Zs,a.set("vTangentW","vec3"),a.set("vBinormalW","vec3")):n.enableGGXSpecular&&(i.set("GGX_SPECULAR",!0),a.set("vObjectSpaceUpW","vec3")));for(let s=0;s<2;s++)t[s]&&(i.set(`UV${s}`,!0),r[`vertex_texCoord${s}`]=`TEXCOORD${s}`),e[s]&&(i.set(`UV${s}_UNMODIFIED`,!0),a.set(`vUv${s}`,"vec2"));let o=0;const l=new Set;s.forEach(t=>{const{id:e,uv:s,name:n}=t,r=e+100*s;if(!l.has(r)){l.add(r),a.set(`vUV${s}_${e}`,"vec2");const t=`texture_${n}MapTransform`;i.set(`{TRANSFORM_NAME_${o}}`,t),i.set(`{TRANSFORM_UV_${o}}`,s),i.set(`{TRANSFORM_ID_${o}}`,e),o++}}),i.set("UV_TRANSFORMS_COUNT",o),n.vertexColors&&(r.vertex_color=en,i.set("VERTEX_COLOR",!0),a.set("vVertexColor","vec4"),n.useVertexColorGamma&&i.set("STD_VERTEX_COLOR_GAMMA","")),n.useMsdf&&n.msdfTextAttribute&&(r.vertex_outlineParameters=un,r.vertex_shadowParameters=fn,i.set("MSDF",!0)),(n.useMorphPosition||n.useMorphNormal)&&(i.set("MORPHING",!0),n.useMorphTextureBasedInt&&i.set("MORPHING_INT",!0),n.useMorphPosition&&i.set("MORPHING_POSITION",!0),n.useMorphNormal&&i.set("MORPHING_NORMAL",!0),r.morph_vertex_id=vn),n.skin&&(r.vertex_boneIndices=tn,n.batch?i.set("BATCH",!0):(r.vertex_boneWeights=Js,i.set("SKIN",!0))),n.useInstancing&&i.set("INSTANCING",!0),n.screenSpace&&i.set("SCREENSPACE",!0),n.pixelSnap&&i.set("PIXELSNAP",!0),a.forEach((t,e)=>{this.varyingsCode+=`#define VARYING_${e.toUpperCase()}\n`,this.varyingsCode+=this.shaderLanguage===Rn?`varying ${e}: ${si.get(t)};\n`:`varying ${t} ${e};\n`}),this.includes.set("varyingsVS",this.varyingsCode),this.includes.set("varyingsPS",this.varyingsCode),this.vshader='\n\t\t\t\t\t\t#include "litMainVS"\n\t\t\t\t'}_setupLightingDefines(t,e){const s=this.fDefines,n=this.options;if(this.fDefines.set("LIGHT_COUNT",n.lights.length),t&&s.set("AREA_LIGHTS",!0),e&&this.lighting&&(s.set("LIT_CLUSTERED_LIGHTS",!0),n.clusteredLightingCookiesEnabled&&s.set("CLUSTER_COOKIES",!0),n.clusteredLightingAreaLightsEnabled&&s.set("CLUSTER_AREALIGHTS",!0),n.lightMaskDynamic&&s.set("CLUSTER_MESH_DYNAMIC_LIGHTS",!0),n.clusteredLightingShadowsEnabled&&!n.noShadow)){const t=zl.get(n.clusteredLightingShadowType);s.set("CLUSTER_SHADOWS",!0),s.set(`SHADOW_KIND_${t.kind}`,!0),s.set(`CLUSTER_SHADOW_TYPE_${t.kind}`,!0)}for(let i=0;i<n.lights.length;i++){const r=n.lights[i],a=r._type;if(e&&0!==a)continue;const o=t&&r._shape?r._shape:0,l=r._shadowType,h=r.castShadows&&!n.noShadow,c=zl.get(l);s.set(`LIGHT${i}`,!0),s.set(`LIGHT${i}TYPE`,`${Pl[a]}`),s.set(`LIGHT${i}SHADOWTYPE`,`${c.name}`),s.set(`LIGHT${i}SHAPE`,`${Ol[o]}`),s.set(`LIGHT${i}FALLOFF`,`${Bl[r._falloffMode]}`),r.affectSpecularity&&s.set(`LIGHT${i}AFFECT_SPECULARITY`,!0),r._cookie&&(2===a&&!r._cookie._cubemap||1===a&&r._cookie._cubemap)&&(s.set(`LIGHT${i}COOKIE`,!0),s.set(`{LIGHT${i}COOKIE_CHANNEL}`,r._cookieChannel),2===a&&(r._cookieTransform&&s.set(`LIGHT${i}COOKIE_TRANSFORM`,!0),r._cookieFalloff&&s.set(`LIGHT${i}COOKIE_FALLOFF`,!0))),h&&(s.set(`LIGHT${i}CASTSHADOW`,!0),c.pcf&&s.set(`LIGHT${i}SHADOW_PCF`,!0),r._normalOffsetBias&&!r._isVsm&&s.set(`LIGHT${i}_SHADOW_SAMPLE_NORMAL_OFFSET`,!0),0===a&&(s.set(`LIGHT${i}_SHADOW_SAMPLE_ORTHO`,!0),r.cascadeBlend>0&&s.set(`LIGHT${i}_SHADOW_CASCADE_BLEND`,!0),r.numCascades>1&&s.set(`LIGHT${i}_SHADOW_CASCADES`,!0)),(c.pcf||c.pcss||this.device.isWebGPU)&&s.set(`LIGHT${i}_SHADOW_SAMPLE_SOURCE_ZBUFFER`,!0),1===a&&s.set(`LIGHT${i}_SHADOW_SAMPLE_POINT`,!0)),h&&(s.set(`SHADOW_KIND_${c.kind}`,!0),0===a&&s.set("SHADOW_DIRECTIONAL",!0))}}prepareForwardPass(t){const{options:e}=this,s=e.clusteredLightingEnabled&&e.clusteredLightingAreaLightsEnabled||e.lights.some(t=>t._shape&&0!==t._shape),n=!e.lightMapEnabled||e.lightMapWithoutAmbient,i=this.needsNormal&&(e.useNormals||e.useClearCoatNormals||e.enableGGXSpecular&&!e.useHeights);e.useSpecular&&(this.fDefineSet(!0,"LIT_SPECULAR"),this.fDefineSet(this.reflections,"LIT_REFLECTIONS"),this.fDefineSet(e.useClearCoat,"LIT_CLEARCOAT"),this.fDefineSet(e.fresnelModel>0,"LIT_SPECULAR_FRESNEL"),this.fDefineSet(e.useSheen,"LIT_SHEEN"),this.fDefineSet(e.useIridescence,"LIT_IRIDESCENCE")),this.fDefineSet(this.lighting&&e.useSpecular||this.reflections,"LIT_SPECULAR_OR_REFLECTION"),this.fDefineSet(this.needsSceneColor,"LIT_SCENE_COLOR"),this.fDefineSet(this.needsScreenSize,"LIT_SCREEN_SIZE"),this.fDefineSet(this.needsTransforms,"LIT_TRANSFORMS"),this.fDefineSet(this.needsNormal,"LIT_NEEDS_NORMAL"),this.fDefineSet(this.lighting,"LIT_LIGHTING"),this.fDefineSet(e.useMetalness,"LIT_METALNESS"),this.fDefineSet(e.enableGGXSpecular,"LIT_GGX_SPECULAR"),this.fDefineSet(e.useSpecularityFactor,"LIT_SPECULARITY_FACTOR"),this.fDefineSet(e.useCubeMapRotation,"CUBEMAP_ROTATION"),this.fDefineSet(e.occludeSpecularFloat,"LIT_OCCLUDE_SPECULAR_FLOAT"),this.fDefineSet(e.separateAmbient,"LIT_SEPARATE_AMBIENT"),this.fDefineSet(e.twoSidedLighting,"LIT_TWO_SIDED_LIGHTING"),this.fDefineSet(e.lightMapEnabled,"LIT_LIGHTMAP"),this.fDefineSet(e.dirLightMapEnabled,"LIT_DIR_LIGHTMAP"),this.fDefineSet(e.skyboxIntensity>0,"LIT_SKYBOX_INTENSITY"),this.fDefineSet(e.clusteredLightingShadowsEnabled,"LIT_CLUSTERED_SHADOWS"),this.fDefineSet(e.clusteredLightingAreaLightsEnabled,"LIT_CLUSTERED_AREA_LIGHTS"),this.fDefineSet(i,"LIT_TBN"),this.fDefineSet(n,"LIT_ADD_AMBIENT"),this.fDefineSet(e.hasTangents,"LIT_TANGENTS"),this.fDefineSet(e.useNormals,"LIT_USE_NORMALS"),this.fDefineSet(e.useClearCoatNormals,"LIT_USE_CLEARCOAT_NORMALS"),this.fDefineSet(e.useRefraction,"LIT_REFRACTION"),this.fDefineSet(e.useDynamicRefraction,"LIT_DYNAMIC_REFRACTION"),this.fDefineSet(e.dispersion,"LIT_DISPERSION"),this.fDefineSet(e.useHeights,"LIT_HEIGHTS"),this.fDefineSet(e.opacityFadesSpecular,"LIT_OPACITY_FADES_SPECULAR"),this.fDefineSet(e.alphaToCoverage,"LIT_ALPHA_TO_COVERAGE"),this.fDefineSet(e.alphaTest,"LIT_ALPHA_TEST"),this.fDefineSet(e.useMsdf,"LIT_MSDF"),this.fDefineSet(e.ssao,"LIT_SSAO"),this.fDefineSet(e.useAo,"LIT_AO"),this.fDefineSet(e.occludeDirect,"LIT_OCCLUDE_DIRECT"),this.fDefineSet(e.msdfTextAttribute,"LIT_MSDF_TEXT_ATTRIBUTE"),this.fDefineSet(e.diffuseMapEnabled,"LIT_DIFFUSE_MAP"),this.fDefineSet(e.shadowCatcher,"LIT_SHADOW_CATCHER"),this.fDefineSet(!0,"LIT_FRESNEL_MODEL",Cl[e.fresnelModel]),this.fDefineSet(!0,"LIT_NONE_SLICE_MODE",mh[e.nineSlicedMode]),this.fDefineSet(!0,"LIT_BLEND_TYPE",Sl[e.blendType]),this.fDefineSet(!0,"LIT_CUBEMAP_PROJECTION",Hl[e.cubeMapProjection]),this.fDefineSet(!0,"LIT_OCCLUDE_SPECULAR",Yl[e.occludeSpecular]),this.fDefineSet(!0,"LIT_REFLECTION_SOURCE",sh[e.reflectionSource]),this.fDefineSet(!0,"LIT_AMBIENT_SOURCE",ah[e.ambientSource]),this.fDefineSet(!0,"{lightingUv}",t??""),this.fDefineSet(!0,"{reflectionDecode}",sf.decodeFunc(e.reflectionEncoding)),this.fDefineSet(!0,"{reflectionCubemapDecode}",sf.decodeFunc(e.reflectionCubemapEncoding)),this.fDefineSet(!0,"{ambientDecode}",sf.decodeFunc(e.ambientEncoding)),this._setupLightingDefines(s,e.clusteredLightingEnabled)}prepareShadowPass(){const{options:t}=this,e=this.shaderPassInfo.lightType,s=this.shaderPassInfo.shadowType,n=zl.get(s),i=0===e||!n.vsm&&2===e;this.fDefineSet(i,"PERSPECTIVE_DEPTH"),this.fDefineSet(!0,"LIGHT_TYPE",`${Pl[e]}`),this.fDefineSet(!0,"SHADOW_TYPE",`${n.name}`),this.fDefineSet(t.alphaTest,"LIT_ALPHA_TEST")}generateFragmentShader(t,e,s){const n=this.options;this.includes.set("frontendDeclPS",t??""),this.includes.set("frontendCodePS",e??""),3===n.pass||1===n.pass||(this.shadowPass?this.prepareShadowPass():this.prepareForwardPass(s)),this.fshader='\n\t\t\t\t\t\t#include "litMainPS"\n\t\t\t\t'}}const qf={generateKey:t=>`lit${Object.keys(t).sort().map(e=>"shaderChunks"===e?t.shaderChunks?.key??"":"lights"===e?qf.generateLightsKey(t):e+t[e]).join("\n")}`,generateLightsKey:t=>`lights:${t.lights.map(e=>t.clusteredLightingEnabled&&0!==e._type?"":`${e.key},`).join("")}`};class Kf{get pass(){return this.litOptions.pass}constructor(){this.defines=new Map,this.forceUv1=!1,this.specularTint=!1,this.metalnessTint=!1,this.glossTint=!1,this.emissiveEncoding="linear",this.lightMapEncoding="linear",this.vertexColorGamma=!1,this.packedNormal=!1,this.normalDetailPackedNormal=!1,this.clearCoatPackedNormal=!1,this.glossInvert=!1,this.sheenGlossInvert=!1,this.clearCoatGlossInvert=!1,this.useAO=!1,this.litOptions=new Wf}}const Yf=[],Qf=t=>Object.keys(t).filter(t=>"litOptions"!==t).sort();const Zf=new class extends Lh{generateKey(t){let e;t===this.optionsContextMin?(this.propsMin||(this.propsMin=Qf(t)),e=this.propsMin):t===this.optionsContext?(this.props||(this.props=Qf(t)),e=this.props):e=Qf(t);return`standard:\n${Lh.definesHash(t.defines)}\n${e.map(e=>e+t[e]).join("\n")}${qf.generateKey(t.litOptions)}`}_getUvSourceExpression(t,e,s){const n=s[t],i=s[e],r=0===s.litOptions.pass;let a;return r&&1===s.litOptions.nineSlicedMode||r&&2===s.litOptions.nineSlicedMode?a="nineSlicedUv":(a=0===n?`vUv${i}`:`vUV${i}_${n}`,s.heightMap&&"heightMapTransform"!==t&&(a+=" + dUvOffset")),a}_validateMapChunk(t,e,s,n){}_addMapDefines(t,e,s,n,i,r,a=null){const o=`${e}Map`,l=e.toUpperCase(),h=`${o}Uv`,c=`${o}Identifier`,d=`${o}Transform`,u=`${o}Channel`,f=`${e}VertexColorChannel`,p=`${e}VertexColor`,m=`${e}Mode`,g=`${e}Invert`,_=n[`${e}Tint`],v=n[p],y=n[o],b=n[c],S=n[m],x=i.get(s);if(y){t.set(`STD_${l}_TEXTURE`,"");const e=this._getUvSourceExpression(d,h,n);t.set(`{STD_${l}_TEXTURE_UV}`,e),t.set(`{STD_${l}_TEXTURE_CHANNEL}`,n[u]);const s=`{STD_${l}_TEXTURE_NAME}`;if(x.includes(s)){let e=`texture_${o}`;const n=r[b];n?e=n:(r[b]=e,t.set(`STD_${l}_TEXTURE_ALLOCATE`,"")),t.set(s,e)}if(a){const e="aaa"===n[u]?"passThrough":sf.decodeFunc(a);t.set(`{STD_${l}_TEXTURE_DECODE}`,e)}}v&&(t.set(`STD_${l}_VERTEX`,""),t.set(`{STD_${l}_VERTEX_CHANNEL}`,n[f])),S&&t.set(`{STD_${l}_DETAILMODE}`,S),_&&t.set(`STD_${l}_CONSTANT`,""),n[g]&&t.set(`STD_${l}_INVERT`,"")}_correctChannel(t,e,s){if(s[t]>0){if(s[t]<e.length)return e.substring(0,s[t]);if(s[t]>e.length){let n=e;const i=n.charAt(n.length-1),r=s[t]-n.length;for(let t=0;t<r;t++)n+=i;return n}return e}}createVertexShader(t,e){const s=[],n=[],i=[];for(const t in Yf){const r=`${t}Map`;if(e[`${t}VertexColor`]){const s=`${t}VertexColorChannel`;e[s]=this._correctChannel(t,e[s],Yf)}if(e[r]){const a=`${r}Channel`,o=`${r}Transform`,l=`${r}Uv`;e[l]=Math.min(e[l],1),e[a]=this._correctChannel(t,e[a],Yf);const h=e[l];s[h]=!0,n[h]=n[h]||e[r]&&!e[o],e[o]&&i.push({name:t,id:e[o],uv:e[l]})}}e.forceUv1&&(s[1]=!0,n[1]=void 0===n[1]||n[1]),t.generateVertexShader(s,n,i)}prepareFragmentDefines(t,e,s){const n=(t,s,n="")=>{t&&e.set(s,n)};n(t.lightMap,"STD_LIGHTMAP",""),n(t.lightVertexColor,"STD_LIGHT_VERTEX_COLOR",""),n(t.dirLightMap&&t.litOptions.useSpecular,"STD_LIGHTMAP_DIR",""),n(t.heightMap,"STD_HEIGHT_MAP",""),n(t.useSpecularColor,"STD_SPECULAR_COLOR",""),n(t.aoMap||t.aoVertexColor||t.useAO,"STD_AO",""),n(!0,"STD_OPACITY_DITHER",xh[s.isForward?t.litOptions.opacityDither:t.litOptions.opacityShadowDither])}createShaderDefinition(t,e){const s=Mh.get(t).getByIndex(e.litOptions.pass),n=s.isForward,i=new Xf(t,e.litOptions);this.createVertexShader(i,e);const r={};e.litOptions.fresnelModel=0===e.litOptions.fresnelModel?2:e.litOptions.fresnelModel;const a=i.fDefines;this.prepareFragmentDefines(e,a,s);let o="";if(n){if(e.heightMap&&this._addMapDefines(a,"height","parallaxPS",e,i.chunks,r),(3!==e.litOptions.blendType||e.litOptions.alphaTest||e.litOptions.alphaToCoverage||e.litOptions.opacityDither!==vh)&&this._addMapDefines(a,"opacity","opacityPS",e,i.chunks,r),i.needsNormal){if((e.normalMap||e.clearCoatNormalMap)&&!e.litOptions.hasTangents){const t=e.normalMap?"normalMap":"clearCoatNormalMap";o=this._getUvSourceExpression(`${t}Transform`,`${t}Uv`,e)}this._addMapDefines(a,"normalDetail","normalMapPS",e,i.chunks,r,e.normalDetailPackedNormal?"xy":"xyz"),this._addMapDefines(a,"normal","normalMapPS",e,i.chunks,r,e.packedNormal?"xy":"xyz")}e.diffuseDetail&&this._addMapDefines(a,"diffuseDetail","diffusePS",e,i.chunks,r,e.diffuseDetailEncoding),this._addMapDefines(a,"diffuse","diffusePS",e,i.chunks,r,e.diffuseEncoding),e.litOptions.useRefraction&&(this._addMapDefines(a,"refraction","transmissionPS",e,i.chunks,r),this._addMapDefines(a,"thickness","thicknessPS",e,i.chunks,r)),e.litOptions.useIridescence&&(this._addMapDefines(a,"iridescence","iridescencePS",e,i.chunks,r),this._addMapDefines(a,"iridescenceThickness","iridescenceThicknessPS",e,i.chunks,r)),(i.lighting&&e.litOptions.useSpecular||i.reflections)&&(e.litOptions.useSheen&&(this._addMapDefines(a,"sheen","sheenPS",e,i.chunks,r,e.sheenEncoding),this._addMapDefines(a,"sheenGloss","sheenGlossPS",e,i.chunks,r)),e.litOptions.useMetalness&&(this._addMapDefines(a,"metalness","metalnessPS",e,i.chunks,r),this._addMapDefines(a,"ior","iorPS",e,i.chunks,r)),e.litOptions.useSpecularityFactor&&this._addMapDefines(a,"specularityFactor","specularityFactorPS",e,i.chunks,r),e.useSpecularColor&&this._addMapDefines(a,"specular","specularPS",e,i.chunks,r,e.specularEncoding),this._addMapDefines(a,"gloss","glossPS",e,i.chunks,r)),e.aoDetail&&this._addMapDefines(a,"aoDetail","aoPS",e,i.chunks,r),(e.aoMap||e.aoVertexColor||e.useAO)&&this._addMapDefines(a,"ao","aoPS",e,i.chunks,r),this._addMapDefines(a,"emissive","emissivePS",e,i.chunks,r,e.emissiveEncoding),e.litOptions.useClearCoat&&(this._addMapDefines(a,"clearCoat","clearCoatPS",e,i.chunks,r),this._addMapDefines(a,"clearCoatGloss","clearCoatGlossPS",e,i.chunks,r),this._addMapDefines(a,"clearCoatNormal","clearCoatNormalPS",e,i.chunks,r,e.clearCoatPackedNormal?"xy":"xyz")),e.litOptions.enableGGXSpecular&&this._addMapDefines(a,"anisotropy","anisotropyPS",e,i.chunks,r),(e.lightMap||e.lightVertexColor)&&this._addMapDefines(a,"light","lightmapPS",e,i.chunks,r,e.lightMapEncoding)}else{const t=e.litOptions.opacityShadowDither;(e.litOptions.alphaTest||t)&&this._addMapDefines(a,"opacity","opacityPS",e,i.chunks,r)}i.generateFragmentShader(i.chunks.get("stdDeclarationPS"),i.chunks.get("stdFrontEndPS"),o);const l=Nh.merge(i.chunks,i.includes),h=i.vDefines;e.defines.forEach((t,e)=>h.set(e,t)),e.defines.forEach((t,e)=>a.set(e,t));const c=Ma.createDefinition(t,{name:"StandardShader",attributes:i.attributes,shaderLanguage:i.shaderLanguage,vertexCode:i.vshader,fragmentCode:i.fshader,vertexIncludes:l,fragmentIncludes:l,fragmentDefines:a,vertexDefines:h});return i.shaderPassInfo.isForward&&(c.tag=1),c}constructor(...t){super(...t),this.optionsContext=new Kf,this.optionsContextMin=new Kf}},Jf=(t,e)=>{if(t.length!==e.length)return!1;for(let s=0;s<t.length;++s)if(t[s]!==e[s])return!1;return!0};class tp{constructor(){this._mapXForms=null}updateMinRef(t,e,s,n,i,r){this._updateSharedOptions(t,e,s,n,i),this._updateMinOptions(t,s,i),this._updateUVOptions(t,s,n,!0)}updateRef(t,e,s,n,i,r,a){this._updateSharedOptions(t,e,n,i,r),this._updateEnvOptions(t,n,e,s),this._updateMaterialOptions(t,n,e),t.litOptions.hasTangents=i&&!!(512&i),this._updateLightOptions(t,e,n,i,a),this._updateUVOptions(t,n,i,!1,s)}_updateSharedOptions(t,e,s,n,i){t.forceUv1=s.forceUv1,s.userAttributes&&(t.litOptions.userAttributes=Object.fromEntries(s.userAttributes.entries())),t.litOptions.shaderChunks=s.shaderChunks,t.litOptions.pass=i,t.litOptions.alphaTest=s.alphaTest>0,t.litOptions.blendType=s.blendType,t.litOptions.screenSpace=n&&0!==(n&oh),t.litOptions.skin=n&&!!(2&n),t.litOptions.batch=n&&0!==(n&dh),t.litOptions.useInstancing=n&&!!(32&n),t.litOptions.useMorphPosition=n&&0!==(n&lh),t.litOptions.useMorphNormal=n&&0!==(n&hh),t.litOptions.useMorphTextureBasedInt=n&&0!==(n&ch),t.litOptions.nineSlicedMode=s.nineSlicedMode||0,e.clusteredLightingEnabled&&s.useLighting?(t.litOptions.clusteredLightingEnabled=!0,t.litOptions.clusteredLightingCookiesEnabled=e.lighting.cookiesEnabled,t.litOptions.clusteredLightingShadowsEnabled=e.lighting.shadowsEnabled,t.litOptions.clusteredLightingShadowType=e.lighting.shadowType,t.litOptions.clusteredLightingAreaLightsEnabled=e.lighting.areaLightsEnabled):(t.litOptions.clusteredLightingEnabled=!1,t.litOptions.clusteredLightingCookiesEnabled=!1,t.litOptions.clusteredLightingShadowsEnabled=!1,t.litOptions.clusteredLightingAreaLightsEnabled=!1)}_updateUVOptions(t,e,s,n,i){let r=!1,a=!1,o=!1;s&&(r=!!(4&s),a=!!(8&s),o=!!(16&s)),t.litOptions.vertexColors=!1,this._mapXForms=[];const l={};for(const s in Yf)this._updateTexOptions(t,e,s,r,a,o,n,l);this._mapXForms=null,t.litOptions.ssao=i?.ssaoEnabled,t.useAO=t.litOptions.ssao,t.litOptions.lightMapEnabled=t.lightMap,t.litOptions.dirLightMapEnabled=t.dirLightMap,t.litOptions.useHeights=t.heightMap,t.litOptions.useNormals=t.normalMap,t.litOptions.useClearCoatNormals=t.clearCoatNormalMap,t.litOptions.useAo=t.aoMap||t.aoVertexColor||t.litOptions.ssao,t.litOptions.diffuseMapEnabled=t.diffuseMap}_updateTexOptions(t,e,s,n,i,r,a,o){const l="opacity"===s;if(!a||l){const a=`${s}Map`,h=`${s}VertexColor`,c=`${s}VertexColorChannel`,d=`${a}Channel`,u=`${a}Transform`,f=`${a}Uv`,p=`${a}Identifier`;if("light"!==s&&(t[a]=!1,t[p]=void 0,t[d]="",t[u]=0,t[f]=0),t[h]=!1,t[c]="",l&&3===e.blendType&&0===e.alphaTest&&!e.alphaToCoverage&&e.opacityDither===vh)return;if("height"!==s&&e[h]&&r&&(t[h]=e[h],t[c]=e[c],t.litOptions.vertexColors=!0),e[a]){let r=!0;if(0!==e[f]||n||(r=!1),1!==e[f]||i||(r=!1),r){const n=e[a].id;let i=o[n];void 0===i&&(o[n]=s,i=s),t[a]=!!e[a],t[p]=i,t[u]=this._getMapTransformID(e.getUniform(u),e[f]),t[d]=e[d],t[f]=e[f]}}}}_updateMinOptions(t,e,s){const n=1===s;t.litOptions.opacityShadowDither=n?e.opacityDither:e.opacityShadowDither,t.litOptions.linearDepth=n,t.litOptions.lights=[]}_updateMaterialOptions(t,e,s){const n=!!(e.useMetalness||e.specularMap||e.sphereMap||e.cubeMap||(i=e.specular,0!==i.r||0!==i.g||0!==i.b)||e.specularityFactor>0&&e.useMetalness||e.enableGGXSpecular||e.clearCoat>0);var i;const r=!e.useMetalness||e.useMetalnessSpecularColor,a=n&&(e.specularTint||!e.specularMap&&!e.specularVertexColor)&&(t=>1!==t.r||1!==t.g||1!==t.b)(e.specular),o=n&&e.useMetalnessSpecularColor&&(e.specularityFactorTint||e.specularityFactor<1&&!e.specularityFactorMap),l=t=>!!t&&(t.format===Ps||t.type===wn),h=(t,e)=>Math.abs(t-e)<1e-4;t.specularTint=a,t.specularityFactorTint=o,t.metalnessTint=e.useMetalness&&e.metalness<1,t.glossTint=!0,t.diffuseEncoding=e.diffuseMap?.encoding,t.diffuseDetailEncoding=e.diffuseDetailMap?.encoding,t.emissiveEncoding=e.emissiveMap?.encoding,t.lightMapEncoding=e.lightMap?.encoding,t.packedNormal=l(e.normalMap),t.refractionTint=h(e.refraction,1),t.refractionIndexTint=h(e.refractionIndex,1/1.5),t.thicknessTint=e.useDynamicRefraction&&1!==e.thickness,t.specularEncoding=e.specularMap?.encoding,t.sheenEncoding=e.sheenMap?.encoding,t.aoMapUv=e.aoUvSet,t.aoDetail=!!e.aoDetailMap,t.diffuseDetail=!!e.diffuseDetailMap,t.normalDetail=!!e.normalMap,t.normalDetailPackedNormal=l(e.normalDetailMap),t.diffuseDetailMode=e.diffuseDetailMode,t.aoDetailMode=e.aoDetailMode,t.clearCoatGloss=!!e.clearCoatGloss,t.clearCoatPackedNormal=l(e.clearCoatNormalMap),t.iorTint=h(e.refractionIndex,1/1.5),s.forcePassThroughSpecular&&(t.specularEncoding="linear",t.sheenEncoding="linear"),t.iridescenceTint=1!==e.iridescence,t.glossInvert=e.glossInvert,t.sheenGlossInvert=e.sheenGlossInvert,t.clearCoatGlossInvert=e.clearCoatGlossInvert,t.useSpecularColor=r,t.litOptions.separateAmbient=!1,t.litOptions.pixelSnap=e.pixelSnap,t.litOptions.ambientSH=!!e.ambientSH,t.litOptions.twoSidedLighting=e.twoSidedLighting,t.litOptions.occludeSpecular=e.occludeSpecular,t.litOptions.occludeSpecularFloat=1!==e.occludeSpecularIntensity,t.litOptions.useMsdf=!!e.msdfMap,t.litOptions.msdfTextAttribute=!!e.msdfTextAttribute,t.litOptions.alphaToCoverage=e.alphaToCoverage,t.litOptions.opacityFadesSpecular=e.opacityFadesSpecular,t.litOptions.opacityDither=e.opacityDither,t.litOptions.cubeMapProjection=e.cubeMapProjection,t.litOptions.occludeDirect=e.occludeDirect,t.litOptions.useSpecular=n,t.litOptions.useSpecularityFactor=(o||!!e.specularityFactorMap)&&e.useMetalnessSpecularColor,t.litOptions.enableGGXSpecular=e.enableGGXSpecular,t.litOptions.fresnelModel=e.fresnelModel,t.litOptions.useRefraction=(e.refraction||!!e.refractionMap)&&(e.useDynamicRefraction||t.litOptions.reflectionSource!==Ql),t.litOptions.useClearCoat=!!e.clearCoat,t.litOptions.useSheen=e.useSheen,t.litOptions.useIridescence=e.useIridescence&&0!==e.iridescence,t.litOptions.useMetalness=e.useMetalness,t.litOptions.useDynamicRefraction=e.useDynamicRefraction,t.litOptions.dispersion=e.dispersion>0,t.litOptions.shadowCatcher=e.shadowCatcher,t.litOptions.useVertexColorGamma=e.vertexColorGamma}_updateEnvOptions(t,e,s,n){t.litOptions.fog=e.useFog?n.fog:xl,t.litOptions.gamma=n.shaderOutputGamma,t.litOptions.toneMap=e.useTonemap?n.toneMapping:6;let i=!1;if(e.envAtlas&&e.cubeMap?(t.litOptions.reflectionSource=Jl,t.litOptions.reflectionEncoding=e.envAtlas.encoding,t.litOptions.reflectionCubemapEncoding=e.cubeMap.encoding):e.envAtlas?(t.litOptions.reflectionSource=Zl,t.litOptions.reflectionEncoding=e.envAtlas.encoding):e.cubeMap?(t.litOptions.reflectionSource=th,t.litOptions.reflectionEncoding=e.cubeMap.encoding):e.sphereMap?(t.litOptions.reflectionSource=eh,t.litOptions.reflectionEncoding=e.sphereMap.encoding):e.useSkybox&&s.envAtlas&&s.skybox?(t.litOptions.reflectionSource=Jl,t.litOptions.reflectionEncoding=s.envAtlas.encoding,t.litOptions.reflectionCubemapEncoding=s.skybox.encoding,i=!0):e.useSkybox&&s.envAtlas?(t.litOptions.reflectionSource=Zl,t.litOptions.reflectionEncoding=s.envAtlas.encoding,i=!0):e.useSkybox&&s.skybox?(t.litOptions.reflectionSource=th,t.litOptions.reflectionEncoding=s.skybox.encoding,i=!0):(t.litOptions.reflectionSource=Ql,t.litOptions.reflectionEncoding=null),e.ambientSH)t.litOptions.ambientSource=nh,t.litOptions.ambientEncoding=null;else{const n=e.envAtlas||(e.useSkybox&&s.envAtlas?s.envAtlas:null);n&&!e.sphereMap?(t.litOptions.ambientSource=ih,t.litOptions.ambientEncoding=n.encoding):(t.litOptions.ambientSource=rh,t.litOptions.ambientEncoding=null)}t.litOptions.skyboxIntensity=i,t.litOptions.useCubeMapRotation=i&&s._skyboxRotationShaderInclude}_updateLightOptions(t,e,s,n,i){if(t.lightMap=!1,t.lightMapChannel="",t.lightMapUv=0,t.lightMapTransform=0,t.litOptions.lightMapWithoutAmbient=!1,t.dirLightMap=!1,n&&(t.litOptions.noShadow=!!(1&n),64&n&&(t.lightMapEncoding=7===e.lightmapPixelFormat?"rgbm":"linear",t.lightMap=!0,t.lightMapChannel="rgb",t.lightMapUv=1,t.lightMapTransform=0,t.litOptions.lightMapWithoutAmbient=!s.lightMap,128&n&&(t.dirLightMap=!0),4096&n&&(t.litOptions.lightMapWithoutAmbient=!1))),s.useLighting){const s=[],r=n?n>>16:1;t.litOptions.lightMaskDynamic=!!(1&r),i&&(jf.collectLights(0,i[0],s,r),e.clusteredLightingEnabled||(jf.collectLights(1,i[1],s,r),jf.collectLights(2,i[2],s,r))),t.litOptions.lights=s}else t.litOptions.lights=[];0!==t.litOptions.lights.length||e.clusteredLightingEnabled||(t.litOptions.noShadow=!0)}_getMapTransformID(t,e){if(!t)return 0;let s=this._mapXForms[e];s||(s=[],this._mapXForms[e]=s);for(let e=0;e<s.length;e++)if(Jf(s[e][0].value,t[0].value)&&Jf(s[e][1].value,t[1].value))return e+1;return s.push(t)}}function ep(t,e=!0,s=!0){const n={};return n[`${t}Map`]="texture",n[`${t}MapTiling`]="vec2",n[`${t}MapOffset`]="vec2",n[`${t}MapRotation`]="number",n[`${t}MapUv`]="number",e&&(n[`${t}MapChannel`]="string",s&&(n[`${t}VertexColor`]="boolean",n[`${t}VertexColorChannel`]="string")),n}const sp={name:"string",chunks:"chunks",mappingFormat:"string",_engine:"boolean",ambient:"rgb",...ep("ao"),...ep("aoDetail",!0,!1),aoDetailMode:"string",aoIntensity:"number",diffuse:"rgb",...ep("diffuse"),...ep("diffuseDetail",!0,!1),diffuseDetailMode:"string",vertexColorGamma:"boolean",specular:"rgb",specularTint:"boolean",...ep("specular"),occludeSpecular:"enum:occludeSpecular",specularityFactor:"number",specularityFactorTint:"boolean",...ep("specularityFactor"),useMetalness:"boolean",metalness:"number",enableGGXSpecular:"boolean",metalnessTint:"boolean",...ep("metalness"),useMetalnessSpecularColor:"boolean",anisotropyIntensity:"number",anisotropyRotation:"number",...ep("anisotropy"),shininess:"number",gloss:"number",glossInvert:"boolean",...ep("gloss"),clearCoat:"number",...ep("clearCoat"),clearCoatGloss:"number",clearCoatGlossInvert:"boolean",...ep("clearCoatGloss"),clearCoatBumpiness:"number",...ep("clearCoatNormal",!1),useSheen:"boolean",sheen:"rgb",...ep("sheen"),sheenGloss:"number",sheenGlossInvert:"boolean",...ep("sheenGloss"),fresnelModel:"number",emissive:"rgb",...ep("emissive"),emissiveIntensity:"number",...ep("normal",!1),bumpiness:"number",...ep("normalDetail",!1),normalDetailMapBumpiness:"number",...ep("height",!0,!1),heightMapFactor:"number",alphaToCoverage:"boolean",alphaTest:"number",alphaFade:"number",opacity:"number",...ep("opacity"),opacityFadesSpecular:"boolean",opacityDither:"string",opacityShadowDither:"string",reflectivity:"number",refraction:"number",refractionTint:"boolean",...ep("refraction"),refractionIndex:"number",dispersion:"number",thickness:"number",thicknessTint:"boolean",...ep("thickness"),attenuation:"rgb",attenuationDistance:"number",useDynamicRefraction:"boolean",sphereMap:"texture",cubeMap:"cubemap",cubeMapProjection:"number",cubeMapProjectionBox:"boundingbox",useIridescence:"boolean",iridescence:"number",iridescenceTint:"boolean",...ep("iridescence"),iridescenceThicknessTint:"boolean",iridescenceThicknessMin:"number",iridescenceThicknessMax:"number",iridescenceRefractionIndex:"number",...ep("iridescenceThickness"),...ep("light"),depthTest:"boolean",depthFunc:"enum:depthFunc",depthWrite:"boolean",depthBias:"number",slopeDepthBias:"number",cull:"enum:cull",blendType:"enum:blendType",useFog:"boolean",useLighting:"boolean",useSkybox:"boolean",useTonemap:"boolean",envAtlas:"texture",twoSidedLighting:"boolean",shadowCatcher:"boolean"},np=[];for(const t in sp){"texture"===sp[t]&&np.push(t)}const ip=[];for(const t in sp){"cubemap"===sp[t]&&ip.push(t)}const rp={},ap={};let op=new Set;const lp=new Ze;class hp extends Cd{static{this.TEXTURE_PARAMETERS=np}static{this.CUBEMAP_PARAMETERS=ip}constructor(){super(),this.userAttributes=new Map,this._assetReferences={},this._activeParams=new Set,this._activeLightingParams=new Set,this.shaderOptBuilder=new tp,this.reset()}reset(){Object.keys(rp).forEach(t=>{this[`_${t}`]=rp[t].value()}),this._uniformCache={}}copy(t){return super.copy(t),Object.keys(rp).forEach(e=>{this[e]=t[e]}),this.userAttributes=new Map(t.userAttributes),this}setAttribute(t,e){this.userAttributes.set(e,t)}_setParameter(t,e){op.add(t),this.setParameter(t,e)}_setParameters(t){t.forEach(t=>{this._setParameter(t.name,t.value)})}_processParameters(t){const e=this[t];e.forEach(t=>{op.has(t)||delete this.parameters[t]}),this[t]=op,op=e,op.clear()}_updateMap(t){const e=`${t}Map`,s=this[e];if(s){this._setParameter(`texture_${e}`,s);const t=`${e}Transform`,n=this.getUniform(t);n&&this._setParameters(n)}}_allocUniform(t,e){let s=this._uniformCache[t];return s||(s=e(),this._uniformCache[t]=s),s}getUniform(t,e,s){return ap[t](this,e,s)}updateUniforms(t,e){const s=s=>this.getUniform(s,t,e);this._setParameter("material_ambient",s("ambient")),this._setParameter("material_diffuse",s("diffuse")),this._setParameter("material_aoIntensity",this.aoIntensity),this.useMetalness?((!this.metalnessMap||this.metalness<1)&&this._setParameter("material_metalness",this.metalness),this.specularMap&&!this.specularTint||this._setParameter("material_specular",s("specular")),this.specularityFactorMap&&!this.specularityFactorTint||this._setParameter("material_specularityFactor",this.specularityFactor),this._setParameter("material_sheen",s("sheen")),this._setParameter("material_sheenGloss",this.sheenGloss),this._setParameter("material_refractionIndex",this.refractionIndex)):this.specularMap&&!this.specularTint||this._setParameter("material_specular",s("specular")),this.enableGGXSpecular&&(this._setParameter("material_anisotropyIntensity",this.anisotropyIntensity),this._setParameter("material_anisotropyRotation",[Math.cos(this.anisotropyRotation*Qe.DEG_TO_RAD),Math.sin(this.anisotropyRotation*Qe.DEG_TO_RAD)])),this.clearCoat>0&&(this._setParameter("material_clearCoat",this.clearCoat),this._setParameter("material_clearCoatGloss",this.clearCoatGloss),this._setParameter("material_clearCoatBumpiness",this.clearCoatBumpiness)),this._setParameter("material_gloss",this.gloss),this._setParameter("material_emissive",s("emissive")),this._setParameter("material_emissiveIntensity",this.emissiveIntensity),this.refraction>0&&this._setParameter("material_refraction",this.refraction),this.dispersion>0&&this._setParameter("material_dispersion",this.dispersion),this.useDynamicRefraction&&(this._setParameter("material_thickness",this.thickness),this._setParameter("material_attenuation",s("attenuation")),this._setParameter("material_invAttenuationDistance",0===this.attenuationDistance?0:1/this.attenuationDistance)),this.useIridescence&&(this._setParameter("material_iridescence",this.iridescence),this._setParameter("material_iridescenceRefractionIndex",this.iridescenceRefractionIndex),this._setParameter("material_iridescenceThicknessMin",this.iridescenceThicknessMin),this._setParameter("material_iridescenceThicknessMax",this.iridescenceThicknessMax)),this._setParameter("material_opacity",this.opacity),!1===this.opacityFadesSpecular&&this._setParameter("material_alphaFade",this.alphaFade),this.occludeSpecular&&this._setParameter("material_occludeSpecularIntensity",this.occludeSpecularIntensity),1===this.cubeMapProjection&&this._setParameter(s("cubeMapProjectionBox"));for(const t in Yf)this._updateMap(t);this.ambientSH&&this._setParameter("ambientSH[0]",this.ambientSH),this.normalMap&&this._setParameter("material_bumpiness",this.bumpiness),this.normalMap&&this.normalDetailMap&&this._setParameter("material_normalDetailMapBumpiness",this.normalDetailMapBumpiness),this.heightMap&&this._setParameter("material_heightMapFactor",s("heightMapFactor")),this.envAtlas&&this.cubeMap?(this._setParameter("texture_envAtlas",this.envAtlas),this._setParameter("texture_cubeMap",this.cubeMap)):this.envAtlas?this._setParameter("texture_envAtlas",this.envAtlas):this.cubeMap?this._setParameter("texture_cubeMap",this.cubeMap):this.sphereMap&&this._setParameter("texture_sphereMap",this.sphereMap),this._setParameter("material_reflectivity",this.reflectivity),this._processParameters("_activeParams"),super.updateUniforms(t,e)}updateEnvUniforms(t,e){!(this.envAtlas||this.cubeMap||this.sphereMap)&&this.useSkybox&&(e.envAtlas&&e.skybox?(this._setParameter("texture_envAtlas",e.envAtlas),this._setParameter("texture_cubeMap",e.skybox)):e.envAtlas?this._setParameter("texture_envAtlas",e.envAtlas):e.skybox&&this._setParameter("texture_cubeMap",e.skybox)),this._processParameters("_activeLightingParams")}getShaderVariant(t){const{device:e,scene:s,pass:n,objDefs:i,sortedLights:r,cameraShaderParams:a}=t;this.updateEnvUniforms(e,s);const o=Mh.get(e).getByIndex(n),l=3===n||1===n||o.isShadow;let h=l?Zf.optionsContextMin:Zf.optionsContext;h.defines=zh.getCoreDefines(this,t),l?this.shaderOptBuilder.updateMinRef(h,s,this,i,n,r):this.shaderOptBuilder.updateRef(h,s,a,this,i,n,r),this.useFog||h.defines.set("FOG","NONE"),h.defines.set("TONEMAP",$l[h.litOptions.toneMap]),this.onUpdateShader&&(h=this.onUpdateShader(h));const c=new Ah(t.viewUniformFormat,t.viewBindGroupFormat,t.vertexFormat),d=Ph(e);d.register("standard",Zf);const u=d.getProgram("standard",h,c,this.userId);return this._dirtyShader=!1,u}destroy(){for(const t in this._assetReferences)this._assetReferences[t]._unbind();this._assetReferences=null,super.destroy()}}const cp=(t,e)=>{ap[t]=e},dp=(t,e,s,n)=>{Object.defineProperty(hp.prototype,t,{get:n||function(){return this[`_${t}`]},set:s}),rp[t]={value:e}},up=t=>{const e=`_${t.name}`,s=t.dirtyShaderFunc||(()=>!0);dp(t.name,()=>t.defaultValue,function(t){const n=this[e];n!==t&&(this._dirtyShader=this._dirtyShader||s(n,t),this[e]=t)},t.getterFunc)},fp=t=>{const e=`_${t.name}`,s=t.dirtyShaderFunc||(()=>!0);dp(t.name,()=>t.defaultValue.clone(),function(t){const n=this[e];n.equals(t)||(this._dirtyShader=this._dirtyShader||s(n,t),this[e]=n.copy(t))},t.getterFunc)},pp=t=>t.defaultValue&&t.defaultValue.clone?fp(t):up(t);function mp(t,e="rgb",s=!0,n=0){Yf[t]=e.length||-1,pp({name:`${t}Map`,defaultValue:null,dirtyShaderFunc:(t,e)=>!!t!=!!e||t&&(t.type!==e.type||t.format!==e.format)}),pp({name:`${t}MapTiling`,defaultValue:new os(1,1)}),pp({name:`${t}MapOffset`,defaultValue:new os(0,0)}),pp({name:`${t}MapRotation`,defaultValue:0}),pp({name:`${t}MapUv`,defaultValue:n}),e&&(pp({name:`${t}MapChannel`,defaultValue:e}),s&&(pp({name:`${t}VertexColor`,defaultValue:!1}),pp({name:`${t}VertexColorChannel`,defaultValue:e})));const i=`${t}MapTiling`,r=`${t}MapOffset`,a=`${t}MapRotation`,o=`${t}MapTransform`;cp(o,(t,e,s)=>{const n=t[i],l=t[r],h=t[a];if(1===n.x&&1===n.y&&0===l.x&&0===l.y&&0===h)return null;const c=t._allocUniform(o,()=>[{name:`texture_${o}0`,value:new Float32Array(3)},{name:`texture_${o}1`,value:new Float32Array(3)}]),d=Math.cos(h*Qe.DEG_TO_RAD),u=Math.sin(h*Qe.DEG_TO_RAD),f=c[0].value;f[0]=d*n.x,f[1]=-u*n.y,f[2]=l.x;const p=c[1].value;return p[0]=u*n.x,p[1]=d*n.y,p[2]=1-n.y-l.y,c})}function gp(t,e){pp({name:t,defaultValue:e,getterFunc:function(){return this._dirtyShader=!0,this[`_${t}`]}}),cp(t,(e,s,n)=>{const i=e._allocUniform(t,()=>new Float32Array(3)),r=e[t];return lp.linear(r),i[0]=lp.r,i[1]=lp.g,i[2]=lp.b,i})}function _p(t,e,s){pp({name:t,defaultValue:e,dirtyShaderFunc:(t,e)=>(0===t||1===t)!=(0===e||1===e)}),cp(t,s)}function vp(t,e){pp({name:t,defaultValue:null,dirtyShaderFunc:(t,e)=>!!t==!!e}),cp(t,e)}function yp(t,e){pp({name:t,defaultValue:e})}!function(){gp("ambient",new Ze(1,1,1)),gp("diffuse",new Ze(1,1,1)),gp("specular",new Ze(0,0,0)),gp("emissive",new Ze(0,0,0)),gp("sheen",new Ze(1,1,1)),gp("attenuation",new Ze(1,1,1)),_p("emissiveIntensity",1),_p("specularityFactor",1),_p("sheenGloss",0),_p("gloss",.25),_p("aoIntensity",1),_p("heightMapFactor",1,(t,e,s)=>.025*t.heightMapFactor),_p("opacity",1),_p("alphaFade",1),_p("alphaTest",0),_p("bumpiness",1),_p("normalDetailMapBumpiness",1),_p("reflectivity",1),_p("occludeSpecularIntensity",1),_p("refraction",0),_p("refractionIndex",1/1.5),_p("dispersion",0),_p("thickness",0),_p("attenuationDistance",0),_p("metalness",1),_p("anisotropyIntensity",0),_p("anisotropyRotation",0),_p("clearCoat",0),_p("clearCoatGloss",1),_p("clearCoatBumpiness",1),_p("aoUvSet",0,null),_p("iridescence",0),_p("iridescenceRefractionIndex",1/1.5),_p("iridescenceThicknessMin",0),_p("iridescenceThicknessMax",0),vp("ambientSH"),vp("cubeMapProjectionBox",(t,e,s)=>{const n=t._allocUniform("cubeMapProjectionBox",()=>[{name:"envBoxMin",value:new Float32Array(3)},{name:"envBoxMax",value:new Float32Array(3)}]),i=t.cubeMapProjectionBox.getMin(),r=n[0].value;r[0]=i.x,r[1]=i.y,r[2]=i.z;const a=t.cubeMapProjectionBox.getMax(),o=n[1].value;return o[0]=a.x,o[1]=a.y,o[2]=a.z,n}),yp("specularTint",!1),yp("specularityFactorTint",!1),yp("useMetalness",!1),yp("useMetalnessSpecularColor",!1),yp("useSheen",!1),yp("enableGGXSpecular",!1),yp("occludeDirect",!1),yp("opacityFadesSpecular",!0),yp("occludeSpecular",1),yp("fresnelModel",2),yp("useDynamicRefraction",!1),yp("cubeMapProjection",0),yp("useFog",!0),yp("useLighting",!0),yp("useTonemap",!0),yp("useSkybox",!0),yp("forceUv1",!1),yp("pixelSnap",!1),yp("twoSidedLighting",!1),yp("nineSlicedMode",void 0),yp("msdfTextAttribute",!1),yp("useIridescence",!1),yp("glossInvert",!1),yp("sheenGlossInvert",!1),yp("clearCoatGlossInvert",!1),yp("opacityDither",vh),yp("opacityShadowDither",vh),yp("shadowCatcher",!1),yp("vertexColorGamma",!1),mp("diffuse"),mp("specular"),mp("emissive"),mp("thickness","g"),mp("specularityFactor","g"),mp("normal",""),mp("metalness","g"),mp("gloss","g"),mp("opacity","a"),mp("refraction","g"),mp("height","g",!1),mp("ao","g"),mp("light","rgb",!0,1),mp("msdf",""),mp("diffuseDetail","rgb",!1),mp("normalDetail",""),mp("aoDetail","g",!1),mp("clearCoat","g"),mp("clearCoatGloss","g"),mp("clearCoatNormal",""),mp("sheen","rgb"),mp("sheenGloss","g"),mp("iridescence","g"),mp("iridescenceThickness","g"),mp("anisotropy",""),yp("diffuseDetailMode","mul"),yp("aoDetailMode","mul"),vp("cubeMap"),vp("sphereMap"),vp("envAtlas");const t=[null,null,null,null,null,null];dp("prefilteredCubemaps",()=>t.slice(),function(t){const e=this._prefilteredCubemaps;t=t||[];let s=!1,n=!0;for(let i=0;i<6;++i){const r=t[i]||null;e[i]!==r&&(e[i]=r,s=!0),n=n&&!!e[i]}s&&(n?this.envAtlas=zf.generatePrefilteredAtlas(e,{target:this.envAtlas}):this.envAtlas&&(this.envAtlas.destroy(),this.envAtlas=null),this._dirtyShader=!0)},function(){return this._prefilteredCubemaps})}();const bp=4/64,Sp=.875;class xp extends af{constructor(t,e,s,n,i,r){super();const a=new rs,o=new rs,l=new rs,h=new rs,c=new rs,d=new rs,u=[],f=[],p=[],m=[],g=[];let _;if(s>0)for(let r=0;r<=n;r++)for(let _=0;_<=i;_++){const v=_/i*2*Math.PI-Math.PI,y=Math.sin(v),b=Math.cos(v);c.set(y*t,-s/2,b*t),h.set(y*e,s/2,b*e),a.lerp(c,h,r/n),o.sub2(h,c).normalize(),d.set(b,0,-y),l.cross(d,o).normalize(),u.push(a.x,a.y,a.z),f.push(l.x,l.y,l.z);let S=_/i,x=r/n;p.push(S,1-x);const w=x;if(x=S,S=w,S=S*Sp+bp,x=x*Sp+bp,S/=3,m.push(S,1-x),r<n&&_<i){const t=r*(i+1)+_,e=r*(i+1)+(_+1),s=(r+1)*(i+1)+_,n=(r+1)*(i+1)+(_+1);g.push(t,e,s),g.push(e,n,s)}}if(r){const t=Math.floor(i/2),r=i,a=s/2;for(let s=0;s<=t;s++){const n=s*Math.PI*.5/t,i=Math.sin(n),o=Math.cos(n);for(let n=0;n<=r;n++){const l=2*n*Math.PI/r-Math.PI/2,h=Math.sin(l),c=Math.cos(l)*i,d=o,g=h*i;let _=1-n/r,v=1-s/t;u.push(c*e,d*e+a,g*e),f.push(c,d,g),p.push(_,1-v),_=_*Sp+bp,v=v*Sp+bp,_/=3,v/=3,_+=1/3,m.push(_,1-v)}}_=(n+1)*(i+1);for(let e=0;e<t;++e)for(let t=0;t<r;++t){const s=e*(r+1)+t,n=s+r+1;g.push(_+s+1,_+n,_+s),g.push(_+s+1,_+n+1,_+n)}for(let s=0;s<=t;s++){const n=.5*Math.PI+s*Math.PI*.5/t,i=Math.sin(n),o=Math.cos(n);for(let n=0;n<=r;n++){const l=2*n*Math.PI/r-Math.PI/2,h=Math.sin(l),c=Math.cos(l)*i,d=o,g=h*i;let _=1-n/r,v=1-s/t;u.push(c*e,d*e-a,g*e),f.push(c,d,g),p.push(_,1-v),_=_*Sp+bp,v=v*Sp+bp,_/=3,v/=3,_+=2/3,m.push(_,1-v)}}_=(n+1)*(i+1)+(r+1)*(t+1);for(let e=0;e<t;++e)for(let t=0;t<r;++t){const s=e*(r+1)+t,n=s+r+1;g.push(_+s+1,_+n,_+s),g.push(_+s+1,_+n+1,_+n)}}else{if(_=(n+1)*(i+1),t>0)for(let e=0;e<i;e++){const n=e/i*2*Math.PI,r=Math.sin(n),a=-s/2,o=Math.cos(n);let l=1-(r+1)/2,h=(o+1)/2;u.push(r*t,a,o*t),f.push(0,-1,0),p.push(l,1-h),l=l*Sp+bp,h=h*Sp+bp,l/=3,h/=3,l+=1/3,m.push(l,1-h),e>1&&g.push(_,_+e,_+e-1)}if(_+=i,e>0)for(let t=0;t<i;t++){const n=t/i*2*Math.PI,r=Math.sin(n),a=s/2,o=Math.cos(n);let l=1-(r+1)/2,h=(o+1)/2;u.push(r*e,a,o*e),f.push(0,1,0),p.push(l,1-h),l=l*Sp+bp,h=h*Sp+bp,l/=3,h/=3,l+=2/3,m.push(l,1-h),t>1&&g.push(_,_+t-1,_+t)}}this.positions=u,this.normals=f,this.uvs=p,this.uvs1=m,this.indices=g}}class wp extends xp{constructor(t={}){const e=t.radius??.3;super(e,e,(t.height??1)-2*e,t.heightSegments??1,t.sides??20,!0),t.calculateTangents&&(this.tangents=rf(this.positions,this.normals,this.uvs,this.indices))}}class Tp extends xp{constructor(t={}){super(t.baseRadius??.5,t.peakRadius??0,t.height??1,t.heightSegments??5,t.capSegments??18,!1),t.calculateTangents&&(this.tangents=rf(this.positions,this.normals,this.uvs,this.indices))}}class Cp extends xp{constructor(t={}){const e=t.radius??.5;super(e,e,t.height??1,t.heightSegments??5,t.capSegments??20,!1),t.calculateTangents&&(this.tangents=rf(this.positions,this.normals,this.uvs,this.indices))}}class Ep extends af{constructor(t={}){super();const e=t.halfExtents??new os(.5,.5),s=t.widthSegments??5,n=t.lengthSegments??5,i=[],r=[],a=[],o=[];let l=0;for(let t=0;t<=s;t++)for(let h=0;h<=n;h++){const c=-e.x+2*e.x*t/s,d=0,u=-(-e.y+2*e.y*h/n),f=t/s,p=h/n;i.push(c,d,u),r.push(0,1,0),a.push(f,1-p),t<s&&h<n&&(o.push(l+n+1,l+1,l),o.push(l+n+1,l+n+2,l+1)),l++}this.positions=i,this.normals=r,this.uvs=a,this.uvs1=a,this.indices=o,t.calculateTangents&&(this.tangents=rf(i,r,a,o))}}class Ap extends af{constructor(t={}){super();const e=t.tubeRadius??.2,s=t.ringRadius??.3,n=(t.sectorAngle??360)*Qe.DEG_TO_RAD,i=t.segments??30,r=t.sides??20,a=[],o=[],l=[],h=[];for(let t=0;t<=r;t++)for(let c=0;c<=i;c++){const d=Math.cos(n*c/i)*(s+e*Math.cos(2*Math.PI*t/r)),u=Math.sin(2*Math.PI*t/r)*e,f=Math.sin(n*c/i)*(s+e*Math.cos(2*Math.PI*t/r)),p=Math.cos(n*c/i)*Math.cos(2*Math.PI*t/r),m=Math.sin(2*Math.PI*t/r),g=Math.sin(n*c/i)*Math.cos(2*Math.PI*t/r),_=t/r,v=1-c/i;if(a.push(d,u,f),o.push(p,m,g),l.push(_,1-v),t<r&&c<i){const e=t*(i+1)+c,s=(t+1)*(i+1)+c,n=t*(i+1)+(c+1),r=(t+1)*(i+1)+(c+1);h.push(e,s,n),h.push(s,r,n)}}this.positions=a,this.normals=o,this.uvs=l,this.uvs1=l,this.indices=h,t.calculateTangents&&(this.tangents=rf(a,o,l,h))}}class Dp{constructor(t,e){this.processedCache=new Map,this.definitionsCache=new Map,this._generators=new Map,this._device=t,this._isClearingCache=!1,this._precached=!1,this._programsCollection=[],this._defaultStdMatOption=new Kf,this._defaultStdMatOptionMin=new Kf;const s=new vc;e.shaderOptBuilder.updateRef(this._defaultStdMatOption,{},s,e,null,[],0,null),e.shaderOptBuilder.updateMinRef(this._defaultStdMatOptionMin,{},e,null,2,null),t.on("destroy:shader",t=>{this.removeFromCache(t)})}destroy(){this.clearCache()}register(t,e){this._generators.has(t)||this._generators.set(t,e)}unregister(t){this._generators.has(t)&&this._generators.delete(t)}isRegistered(t){return this._generators.has(t)}generateShaderDefinition(t,e,s,n){let i=this.definitionsCache.get(s);if(!i){let r;n.litOptions?.lights&&(r=n.litOptions.lights,n.litOptions.lights=r.map(t=>{const e=t.clone?t.clone():t;return e.key=t.key,e})),this.storeNewProgram(e,n),n.litOptions?.lights&&(n.litOptions.lights=r);const a=this._device;i=t.createShaderDefinition(a,n),i.name=i.name??(n.pass?`${e}-pass:${n.pass}`:e),this.definitionsCache.set(s,i)}return i}getCachedShader(t){return this.processedCache.get(t)}setCachedShader(t,e){this.processedCache.set(t,e)}getProgram(t,e,s,n){const i=this._generators.get(t);if(!i)return null;const r=Oi(i.generateKey(e)),a=`${r}#${Oi(s.generateKey(this._device))}`;let o=this.getCachedShader(a);if(!o){const l=this.generateShaderDefinition(i,t,r,e);let h,c="";void 0!==e.pass&&(h=Mh.get(this._device).getByIndex(e.pass),c=`-${h.name}`),this._device.fire("shader:generate",{userMaterialId:n,shaderPassInfo:h,definition:l});const d={name:`${l.name}${c}-proc`,attributes:l.attributes,vshader:l.vshader,vincludes:l.vincludes,fincludes:l.fincludes,fshader:l.fshader,processingOptions:s,shaderLanguage:l.shaderLanguage,meshUniformBufferFormat:l.meshUniformBufferFormat,meshBindGroupFormat:l.meshBindGroupFormat};o=new Oa(this._device,d),this.setCachedShader(a,o)}return o}storeNewProgram(t,e){let s={};if("standard"===t){const t=this._getDefaultStdMatOptions(e.pass);for(const n in e)(e.hasOwnProperty(n)&&t[n]!==e[n]||"pass"===n)&&(s[n]=e[n]);for(const t in e.litOptions)s[t]=e.litOptions[t]}else s=e;this._programsCollection.push(JSON.stringify({name:t,options:s}))}dumpPrograms(){let t="let device = pc.app ? pc.app.graphicsDevice : pc.Application.getApplication().graphicsDevice;\n";t+="let shaders = [",this._programsCollection[0]&&(t+=`\n\t${this._programsCollection[0]}`);for(let e=1;e<this._programsCollection.length;++e)t+=`,\n\t${this._programsCollection[e]}`;t+="\n];\n",t+="pc.getProgramLibrary(device).precompile(shaders);\n",t+=`if (pc.version != "${Pe}" || pc.revision != "${Le}")\n`,t+='\tconsole.warn("precompile-shaders.js: engine version mismatch, rebuild shaders lib with current engine");';const e=document.createElement("a");e.setAttribute("href",`data:text/plain;charset=utf-8,${encodeURIComponent(t)}`),e.setAttribute("download","precompile-shaders.js"),e.style.display="none",document.body.appendChild(e),e.click(),document.body.removeChild(e)}clearCache(){this._isClearingCache=!0,this.processedCache.forEach(t=>{t.destroy()}),this.processedCache.clear(),this._isClearingCache=!1}removeFromCache(t){this._isClearingCache||this.processedCache.forEach((e,s)=>{t===e&&this.processedCache.delete(s)})}_getDefaultStdMatOptions(t){const e=Mh.get(this._device).getByIndex(t);return 3===t||1===t||e.isShadow?this._defaultStdMatOptionMin:this._defaultStdMatOption}precompile(t){if(t){const e=new Array(t.length);for(let s=0;s<t.length;s++){if("standard"===t[s].name){const e=t[s].options,n=this._getDefaultStdMatOptions(e.pass);for(const t in n)n.hasOwnProperty(t)&&void 0===e[t]&&(e[t]=n[t])}e[s]=this.getProgram(t[s].name,t[s].options)}}this._precached=!0}}const Pp=new ps,Lp=new ms,Ip=new Ss,Rp=new Ss,Mp=new Ze(1,1,0,.4),kp=.28209479177387814;class Op{constructor(t,e,s,n,i){const r=t.getProp("x"),a=t.getProp("y"),o=t.getProp("z"),l=t.getProp("rot_1"),h=t.getProp("rot_2"),c=t.getProp("rot_3"),d=t.getProp("rot_0"),u=t.getProp("scale_0"),f=t.getProp("scale_1"),p=t.getProp("scale_2"),m=t.getProp("f_dc_0"),g=t.getProp("f_dc_1"),_=t.getProp("f_dc_2"),v=t.getProp("opacity");this.read=t=>{e&&(e.x=r[t],e.y=a[t],e.z=o[t]),s&&s.set(l[t],h[t],c[t],d[t]),n&&n.set(Math.exp(u[t]),Math.exp(f[t]),Math.exp(p[t])),i&&i.set(.5+m[t]*kp,.5+g[t]*kp,.5+_[t]*kp,(t=>{if(t>0)return 1/(1+Math.exp(-t));const e=Math.exp(t);return e/(1+e)})(v[t]))}}}const Fp=(t,e,s)=>{Lp.set(s.x,s.y,s.z,s.w).normalize(),t.setTRS(e,Lp,rs.ONE)};class Np{constructor(t,e=[]){this.elements=t,this.numSplats=this.getElement("vertex").count,this.comments=e}static calcSplatAabb(t,e,s,n){Fp(Pp,e,s),Ip.center.set(0,0,0),Ip.halfExtents.set(2*n.x,2*n.y,2*n.z),t.setFromTransformedAabb(Ip,Pp)}getProp(t,e="vertex"){return this.getElement(e)?.properties.find(e=>e.name===t)?.storage}getElement(t){return this.elements.find(e=>e.name===t)}addProp(t,e){this.getElement("vertex").properties.push({type:"float",name:t,storage:e,byteSize:4})}createIter(t,e,s,n){return new Op(this,t,e,s,n)}calcAabb(t,e){let s,n,i,r,a,o,l=!0;const h=this.getProp("x"),c=this.getProp("y"),d=this.getProp("z"),u=this.getProp("scale_0"),f=this.getProp("scale_1"),p=this.getProp("scale_2");for(let t=0;t<this.numSplats;++t){if(e&&!e(t))continue;const m=h[t],g=c[t],_=d[t],v=Math.max(u[t],f[t],p[t]);if(!(isFinite(m)&&isFinite(g)&&isFinite(_)&&isFinite(v)))continue;const y=2*Math.exp(v);l?(l=!1,s=m-y,n=g-y,i=_-y,r=m+y,a=g+y,o=_+y):(s=Math.min(s,m-y),n=Math.min(n,g-y),i=Math.min(i,_-y),r=Math.max(r,m+y),a=Math.max(a,g+y),o=Math.max(o,_+y))}return l||(t.center.set(.5*(s+r),.5*(n+a),.5*(i+o)),t.halfExtents.set(.5*(r-s),.5*(a-n),.5*(o-i))),!l}calcAabbExact(t,e){const s=new rs,n=new ms,i=new rs,r=this.createIter(s,n,i);let a=!0;for(let o=0;o<this.numSplats;++o)e&&!e(o)||(r.read(o),a?(a=!1,Np.calcSplatAabb(t,s,n,i)):(Np.calcSplatAabb(Rp,s,n,i),t.add(Rp)));return!a}getCenters(){const t=this.getProp("x"),e=this.getProp("y"),s=this.getProp("z"),n=new Float32Array(3*this.numSplats);for(let i=0;i<this.numSplats;++i)n[3*i+0]=t[i],n[3*i+1]=e[i],n[3*i+2]=s[i];return n}calcFocalPoint(t,e){const s=this.getProp("x"),n=this.getProp("y"),i=this.getProp("z"),r=this.getProp("scale_0"),a=this.getProp("scale_1"),o=this.getProp("scale_2");t.x=0,t.y=0,t.z=0;let l=0;for(let h=0;h<this.numSplats;++h){if(e&&!e(h))continue;const c=s[h],d=n[h],u=i[h];if(!isFinite(c)||!isFinite(d)||!isFinite(u))continue;const f=1/(1+Math.exp(Math.max(r[h],a[h],o[h])));t.x+=c*f,t.y+=d*f,t.z+=u*f,l+=f}t.mulScalar(1/l)}renderWireframeBounds(t,e){const s=new rs,n=new ms,i=new rs,r=new rs,a=new rs,o=this.createIter(s,n,i);for(let l=0;l<this.numSplats;++l)o.read(l),Fp(Pp,s,n),Pp.mul2(e,Pp),r.set(-2*i.x,-2*i.y,-2*i.z),a.set(2*i.x,2*i.y,2*i.z),t.immediate.drawWireAlignedBox(r,a,Mp,!0,t.defaultDrawLayer,Pp)}get isCompressed(){return!1}get shBands(){return{9:1,24:2,45:3}[(()=>{for(let t=0;t<45;++t)if(!this.getProp(`f_rest_${t}`))return t;return 45})()]??0}calcMortonOrder(){const t=t=>{let e=t[0],s=t[0];for(let n=1;n<t.length;n++)t[n]<e&&(e=t[n]),t[n]>s&&(s=t[n]);return{min:e,max:s}},e=(t,e,s)=>{const n=t=>t=153391689&((t=51130563&((t=50393103&((t=4278190335&((t&=1023)^t<<16))^t<<8))^t<<4))^t<<2);return(n(s)<<2)+(n(e)<<1)+n(t)},s=this.getProp("x"),n=this.getProp("y"),i=this.getProp("z"),{min:r,max:a}=t(s),{min:o,max:l}=t(n),{min:h,max:c}=t(i),d=r===a?0:1024/(a-r),u=o===l?0:1024/(l-o),f=h===c?0:1024/(c-h),p=new Map;for(let t=0;t<this.numSplats;t++){const a=e(Math.min(1023,Math.floor((s[t]-r)*d)),Math.min(1023,Math.floor((n[t]-o)*u)),Math.min(1023,Math.floor((i[t]-h)*f))),l=p.get(a);l?l.push(t):p.set(a,[t])}const m=Array.from(p.keys()).sort((t,e)=>t-e),g=new Uint32Array(this.numSplats);let _=0;for(let t=0;t<m.length;++t){const e=p.get(m[t]);for(let t=0;t<e.length;++t)g[_++]=e[t]}return g}reorder(t){const e=new Map,s=s=>{const n=new s.constructor((t=>{if(e.has(t)){const s=e.get(t);return e.delete(t),s}return new ArrayBuffer(t)})(s.byteLength));for(let e=0;e<t.length;e++)n[e]=s[t[e]];var i;return i=s.buffer,e.set(i.byteLength,i),n};this.elements.forEach(t=>{t.properties.forEach(t=>{t.storage&&(t.storage=s(t.storage))})})}reorderData(){this.reorder(this.calcMortonOrder())}}class Bp{constructor(t,e=!1){this._deviceLostEvent=null,this.device=t,this.useSingleBuffer=e,this.impl=t.createUploadStreamImpl(this),this._deviceLostEvent=this.device.on("devicelost",this._onDeviceLost,this)}destroy(){this._deviceLostEvent?.off(),this._deviceLostEvent=null,this.impl?.destroy(),this.impl=null}upload(t,e,s=0,n=t.length){this.impl?.upload(t,e,s,n)}_onDeviceLost(){this.impl?._onDeviceLost?.()}}const zp=new ps,Up=[1,1,1];class Vp extends Fo{constructor(t,e,s=!1){super(t),this.splats=[],this.colorsByLod=void 0,this.cameraNode=null,this.workBuffer=e,this.colorOnly=s}init(t){super.init(t),this.colorOps.clear=!1,this.depthStencilOps.clearDepth=!1}update(t,e,s){this.splats.length=0,this.colorsByLod=s;for(let e=0;e<t.length;e++){const s=t[e];s.activeSplats>0&&this.splats.push(s)}return this.cameraNode=e,this.splats.length>0}execute(){const{device:t,splats:e,cameraNode:s}=this;t.setBlendState(Ti.NOBLEND),t.setCullMode(0),t.setDepthState(Ai.NODEPTH),t.setStencilState();const n=s.getWorldTransform(),i=zp.copy(n).invert();t.scope.resolve("matrix_view").setValue(i.data);for(let t=0;t<e.length;t++)this.renderSplat(e[t])}renderSplat(t){const{device:e,resource:s}=t,n=e.scope,{intervals:i,activeSplats:r,lineStart:a,viewport:o,intervalTexture:l}=t,h=s.getWorkBufferRenderInfo(i.length>0,this.workBuffer.colorTextureFormat,this.colorOnly);h.material.setParameters(e),l&&n.resolve("uIntervalsTexture").setValue(l.texture),n.resolve("uActiveSplats").setValue(r),n.resolve("uStartLine").setValue(a),n.resolve("uViewportWidth").setValue(o.z);const c=this.colorsByLod?.[t.lodIndex]??this.colorsByLod?.[0]??Up;n.resolve("uColorMultiply").setValue(c),n.resolve("matrix_model").setValue(t.node.getWorldTransform().data),h.quadRender.render(o)}destroy(){this.splats.length=0,super.destroy()}}let Hp=0;class Gp{constructor(t,e,s,n,i){this.device=t,this.material=s;const r=new Map(s.defines),a=n===Vs,o=a?"uvec4":"vec4";a&&r.set("GSPLAT_COLOR_UINT",""),i&&r.set("GSPLAT_COLOR_ONLY","");const l=zh.createShader(this.device,{uniqueName:`SplatCopyToWorkBuffer:${e}`,attributes:{vertex_position:Ys},vertexDefines:r,fragmentDefines:r,vertexChunk:"fullscreenQuadVS",fragmentGLSL:'\n#define GSPLAT_CENTER_NOPROJ\n#include "gsplatStructsVS"\n#include "gsplatCenterVS"\n#include "gsplatEvalSHVS"\n#include "gsplatQuatToMat3VS"\n#include "gsplatSourceFormatVS"\n#include "packHalfPS"\nuniform int uStartLine;\nuniform int uViewportWidth;\n#ifdef GSPLAT_LOD\n\tuniform usampler2D uIntervalsTexture;\n#endif\nuniform vec3 uColorMultiply;\nuniform int uActiveSplats;\nvoid main(void) {\n\tivec2 localFragCoords = ivec2(int(gl_FragCoord.x), int(gl_FragCoord.y) - uStartLine);\n\tint targetIndex = localFragCoords.y * uViewportWidth + localFragCoords.x;\n\tif (targetIndex >= uActiveSplats) {\n\t\t#ifdef GSPLAT_COLOR_UINT\n\t\t\tpcFragColor0 = uvec4(0u);\n\t\t#else\n\t\t\tpcFragColor0 = vec4(0.0);\n\t\t#endif\n\t\t#ifndef GSPLAT_COLOR_ONLY\n\t\t\tpcFragColor1 = uvec4(0u);\n\t\t\tpcFragColor2 = uvec2(0u);\n\t\t#endif\n\t} else {\n\t\t#ifdef GSPLAT_LOD\n\t\t\tint intervalsSize = int(textureSize(uIntervalsTexture, 0).x);\n\t\t\tivec2 intervalUV = ivec2(targetIndex % intervalsSize, targetIndex / intervalsSize);\n\t\t\tuint originalIndex = texelFetch(uIntervalsTexture, intervalUV, 0).r;\n\t\t#else\n\t\t\tuint originalIndex = uint(targetIndex);\n\t\t#endif\n\t\t\n\t\t#if defined(GSPLAT_SOGS_DATA) || defined(GSPLAT_COMPRESSED_DATA)\n\t\t\tuint srcSize = uint(textureSize(packedTexture, 0).x);\n\t\t#else\n\t\t\tuint srcSize = uint(textureSize(splatColor, 0).x);\n\t\t#endif\n\t\t\n\t\tSplatSource source;\n\t\tsource.id = uint(originalIndex);\n\t\tsource.uv = ivec2(source.id % srcSize, source.id / srcSize);\n\t\tvec3 modelCenter = readCenter(source);\n\t\tvec3 worldCenter = (matrix_model * vec4(modelCenter, 1.0)).xyz;\n\t\tSplatCenter center;\n\t\tinitCenter(modelCenter, center);\n\t\tvec3 covA, covB;\n\t\treadCovariance(source, covA, covB);\n\t\tmat3 C = mat3(\n\t\t\tcovA.x, covA.y, covA.z,\n\t\t\tcovA.y, covB.x, covB.y,\n\t\t\tcovA.z, covB.y, covB.z\n\t\t);\n\t\tmat3 linear = mat3(matrix_model);\n\t\tmat3 Ct = linear * C * transpose(linear);\n\t\tcovA = Ct[0];\n\t\tcovB = vec3(Ct[1][1], Ct[1][2], Ct[2][2]);\n\t\tvec4 color = readColor(source);\n\t\t#if SH_BANDS > 0\n\t\t\tvec3 dir = normalize(center.view * mat3(center.modelView));\n\t\t\tvec3 sh[SH_COEFFS];\n\t\t\tfloat scale;\n\t\t\treadSHData(source, sh, scale);\n\t\t\tcolor.xyz += evalSH(sh, dir) * scale;\n\t\t#endif\n\t\tcolor.xyz *= uColorMultiply;\n\t\t#ifdef GSPLAT_COLOR_UINT\n\t\t\tuint packed_rg = packHalf2x16(color.rg);\n\t\t\tuint packed_ba = packHalf2x16(color.ba);\n\t\t\tpcFragColor0 = uvec4(\n\t\t\t\tpacked_rg & 0xFFFFu,\n\t\t\t\tpacked_rg >> 16u,\n\t\t\t\tpacked_ba & 0xFFFFu,\n\t\t\t\tpacked_ba >> 16u\n\t\t\t);\n\t\t#else\n\t\t\tpcFragColor0 = color;\n\t\t#endif\n\t\t#ifndef GSPLAT_COLOR_ONLY\n\t\t\tpcFragColor1 = uvec4(floatBitsToUint(worldCenter.x), floatBitsToUint(worldCenter.y), floatBitsToUint(worldCenter.z), packHalf2x16Safe(vec2(covA.z, covB.z)));\n\t\t\tpcFragColor2 = uvec2(packHalf2x16Safe(covA.xy), packHalf2x16Safe(covB.xy));\n\t\t#endif\n\t}\n}\n',fragmentWGSL:'\n#define GSPLAT_CENTER_NOPROJ\n#include "gsplatStructsVS"\n#include "gsplatCenterVS"\n#include "gsplatEvalSHVS"\n#include "gsplatQuatToMat3VS"\n#include "gsplatSourceFormatVS"\n#include "packHalfPS"\nuniform uStartLine: i32;\nuniform uViewportWidth: i32;\n#ifdef GSPLAT_LOD\n\tvar uIntervalsTexture: texture_2d<u32>;\n#endif\nuniform uColorMultiply: vec3f;\nuniform uActiveSplats: i32;\n@fragment\nfn fragmentMain(input: FragmentInput) -> FragmentOutput {\n\tvar output: FragmentOutput;\n\t\n\tlet localFragCoords = vec2i(i32(input.position.x), i32(input.position.y) - uniform.uStartLine);\n\tlet targetIndex = localFragCoords.y * uniform.uViewportWidth + localFragCoords.x;\n\t\n\tif (targetIndex >= uniform.uActiveSplats) {\n\t\toutput.color = vec4f(0.0);\n\t\t#ifndef GSPLAT_COLOR_ONLY\n\t\t\toutput.color1 = vec4u(0u);\n\t\t\toutput.color2 = vec2u(0u);\n\t\t#endif\n\t} else {\n\t\t#ifdef GSPLAT_LOD\n\t\t\tlet intervalsSize = i32(textureDimensions(uIntervalsTexture, 0).x);\n\t\t\tlet intervalUV = vec2i(targetIndex % intervalsSize, targetIndex / intervalsSize);\n\t\t\tlet originalIndex = textureLoad(uIntervalsTexture, intervalUV, 0).r;\n\t\t#else\n\t\t\tlet originalIndex = targetIndex;\n\t\t#endif\n\t\t\n\t\tvar srcSize: u32;\n\t\t#if defined(GSPLAT_SOGS_DATA) || defined(GSPLAT_COMPRESSED_DATA)\n\t\t\tsrcSize = u32(textureDimensions(packedTexture, 0).x);\n\t\t#else\n\t\t\tsrcSize = u32(textureDimensions(splatColor, 0).x);\n\t\t#endif\n\t\t\n\t\tvar source: SplatSource;\n\t\tsource.id = u32(originalIndex);\n\t\tsource.uv = vec2i(i32(source.id % srcSize), i32(source.id / srcSize));\n\t\tvar modelCenter = readCenter(&source);\n\t\tlet worldCenter = (uniform.matrix_model * vec4f(modelCenter, 1.0)).xyz;\n\t\tvar center: SplatCenter;\n\t\tinitCenter(modelCenter, &center);\n\t\tvar covA: vec3f;\n\t\tvar covB: vec3f;\n\t\treadCovariance(&source, &covA, &covB);\n\t\tlet C = mat3x3f(\n\t\t\tvec3f(covA.x, covA.y, covA.z),\n\t\t\tvec3f(covA.y, covB.x, covB.y),\n\t\t\tvec3f(covA.z, covB.y, covB.z)\n\t\t);\n\t\tlet linear = mat3x3f(uniform.matrix_model[0].xyz, uniform.matrix_model[1].xyz, uniform.matrix_model[2].xyz);\n\t\tlet Ct = linear * C * transpose(linear);\n\t\tcovA = Ct[0];\n\t\tcovB = vec3f(Ct[1][1], Ct[1][2], Ct[2][2]);\n\t\tvar color = readColor(&source);\n\t\t#if SH_BANDS > 0\n\t\t\tlet dir = normalize(center.view * mat3x3f(center.modelView[0].xyz, center.modelView[1].xyz, center.modelView[2].xyz));\n\t\t\tvar sh: array<vec3f, SH_COEFFS>;\n\t\t\tvar scale: f32;\n\t\t\treadSHData(&source, &sh, &scale);\n\t\t\tcolor = vec4f(color.xyz + evalSH(&sh, dir) * scale, color.w);\n\t\t#endif\n\t\tcolor = vec4f(color.xyz * uniform.uColorMultiply, color.w);\n\t\toutput.color = color;\n\t\t#ifndef GSPLAT_COLOR_ONLY\n\t\t\toutput.color1 = vec4u(bitcast<u32>(worldCenter.x), bitcast<u32>(worldCenter.y), bitcast<u32>(worldCenter.z), pack2x16floatSafe(vec2f(covA.z, covB.z)));\n\t\t\toutput.color2 = vec2u(pack2x16floatSafe(covA.xy), pack2x16floatSafe(covB.xy));\n\t\t#endif\n\t}\n\t\n\treturn output;\n}\n',fragmentOutputTypes:i?[o]:[o,"uvec4","uvec2"]});this.quadRender=new Wh(l)}destroy(){this.material?.destroy(),this.quadRender?.destroy()}}class Wp{constructor(t){this.id=Hp++,this._textureSize=1,this.device=t,this.colorTextureFormat=t.getRenderableHdrFormat([Ls])||Vs,this.colorTexture=this.createTexture("splatColor",this.colorTextureFormat,1,1),this.splatTexture0=this.createTexture("splatTexture0",Hs,1,1),this.splatTexture1=this.createTexture("splatTexture1",Us,1,1),this.renderTarget=new ji({name:`GsplatWorkBuffer-MRT-${this.id}`,colorBuffers:[this.colorTexture,this.splatTexture0,this.splatTexture1],depth:!1,flipY:!0}),this.colorRenderTarget=new ji({name:`GsplatWorkBuffer-Color-${this.id}`,colorBuffer:this.colorTexture,depth:!1,flipY:!0}),this.uploadStream=new Bp(t),t.isWebGPU?this.orderBuffer=new Ja(t,4,8):this.orderTexture=this.createTexture("SplatGlobalOrder",zs,1,1),this.renderPass=new Vp(t,this),this.renderPass.init(this.renderTarget),this.colorRenderPass=new Vp(t,this,!0),this.colorRenderPass.init(this.colorRenderTarget)}destroy(){this.renderPass?.destroy(),this.colorRenderPass?.destroy(),this.colorTexture?.destroy(),this.splatTexture0?.destroy(),this.splatTexture1?.destroy(),this.orderTexture?.destroy(),this.orderBuffer?.destroy(),this.renderTarget?.destroy(),this.colorRenderTarget?.destroy(),this.uploadStream.destroy()}get textureSize(){return this._textureSize}setOrderData(t){this.device.isWebGPU?this.uploadStream.upload(t,this.orderBuffer,0,t.length):this.uploadStream.upload(t,this.orderTexture,0,t.length)}createTexture(t,e,s,n){return new pi(this.device,{name:t,width:s,height:n,format:e,cubemap:!1,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1})}resize(t){if(this.renderTarget.resize(t,t),this.colorRenderTarget.resize(t,t),this._textureSize=t,this.device.isWebGPU){const e=t*t*4;this.orderBuffer.byteSize<e&&(this.orderBuffer.destroy(),this.orderBuffer=new Ja(this.device,e,8))}else this.orderTexture.resize(t,t)}render(t,e,s){this.renderPass.update(t,e,s)&&this.renderPass.render()}renderColor(t,e,s){this.colorRenderPass.update(t,e,s)&&this.colorRenderPass.render()}}let jp=0;const $p=new Map;class Xp{constructor(t,e){this.id=jp++,this.workBufferRenderInfos=new Map,this._refCount=0,this.device=t,this.gsplatData=e,this.centers=e.getCenters(),this.aabb=new Ss,e.calcAabb(this.aabb),this.mesh=Xp.createMesh(t),this.instanceIndices=Xp.createInstanceIndices(t,e.numSplats),this.mesh.incRefCount(),this.mesh.aabb.copy(this.aabb)}destroy(){this.mesh?.destroy(),this.instanceIndices?.destroy(),this.workBufferRenderInfos.forEach(t=>t.destroy()),this.workBufferRenderInfos.clear()}incRefCount(){this._refCount++}decRefCount(){this._refCount--}get refCount(){return this._refCount}getWorkBufferRenderInfo(t,e,s=!1){this.configureMaterialDefines($p),t&&$p.set("GSPLAT_LOD",""),s&&$p.set("GSPLAT_COLOR_ONLY","");const n=Array.from($p.entries()).map(([t,e])=>`${t}=${e}`).join(";");let i=this.workBufferRenderInfos.get(n);if(!i){const t=new Ju;this.configureMaterial(t),$p.forEach((e,s)=>t.setDefine(s,e)),i=new Gp(this.device,n,t,e,s),this.workBufferRenderInfos.set(n,i)}return $p.clear(),i}static createMesh(t){const e=Xp.instanceSize,s=new Float32Array(12*e),n=new Uint32Array(6*e);for(let t=0;t<e;++t){s.set([-1,-1,t,1,-1,t,1,1,t,-1,1,t],12*t);const e=4*t;n.set([0+e,1+e,2+e,0+e,2+e,3+e],6*t)}const i=new tc(t);return i.setPositions(s,3),i.setIndices(n),i.update(),i}static createInstanceIndices(t,e){const s=Xp.instanceSize,n=Math.ceil(e/s)*s/s,i=new Uint32Array(n);for(let t=0;t<n;++t)i[t]=t*s;const r=new Ui(t,[{semantic:gn,components:1,type:5,asInt:!0}]);return new ki(t,r,n,{usage:0,data:i.buffer})}static get instanceSize(){return 128}get numSplats(){return this.gsplatData.numSplats}configureMaterial(t){}configureMaterialDefines(t){}evalTextureSize(t){return os.ZERO}createTexture(t,e,s,n){return new pi(this.device,{name:t,width:s.x,height:s.y,format:e,cubemap:!1,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1,...n?{levels:[n]}:{}})}instantiate(){}}class qp extends Xp{constructor(t,e){super(t,e);const s=e.numSplats,n=this.evalTextureSize(s);this.colorTexture=this.createTexture("splatColor",Ls,n),this.transformATexture=this.createTexture("transformA",Hs,n),this.transformBTexture=this.createTexture("transformB",Ls,n),this.updateColorData(e),this.updateTransformData(e),this.shBands=e.shBands,this.shBands>0&&(this.sh1to3Texture=this.createTexture("splatSH_1to3",Hs,n),this.shBands>1&&(this.sh4to7Texture=this.createTexture("splatSH_4to7",Hs,n),this.shBands>2?(this.sh8to11Texture=this.createTexture("splatSH_8to11",Hs,n),this.sh12to15Texture=this.createTexture("splatSH_12to15",Hs,n)):this.sh8to11Texture=this.createTexture("splatSH_8to11",zs,n)),this.updateSHData(e))}destroy(){this.colorTexture?.destroy(),this.transformATexture?.destroy(),this.transformBTexture?.destroy(),this.sh1to3Texture?.destroy(),this.sh4to7Texture?.destroy(),this.sh8to11Texture?.destroy(),this.sh12to15Texture?.destroy(),super.destroy()}configureMaterialDefines(t){t.set("SH_BANDS",this.shBands)}configureMaterial(t){this.configureMaterialDefines(t.defines),t.setParameter("splatColor",this.colorTexture),t.setParameter("transformA",this.transformATexture),t.setParameter("transformB",this.transformBTexture),this.sh1to3Texture&&t.setParameter("splatSH_1to3",this.sh1to3Texture),this.sh4to7Texture&&t.setParameter("splatSH_4to7",this.sh4to7Texture),this.sh8to11Texture&&t.setParameter("splatSH_8to11",this.sh8to11Texture),this.sh12to15Texture&&t.setParameter("splatSH_12to15",this.sh12to15Texture)}evalTextureSize(t){const e=Math.ceil(Math.sqrt(t)),s=Math.ceil(t/e);return new os(e,s)}updateColorData(t){const e=this.colorTexture;if(!e)return;const s=is.float2Half,n=e.lock(),i=t.getProp("f_dc_0"),r=t.getProp("f_dc_1"),a=t.getProp("f_dc_2"),o=t.getProp("opacity"),l=.28209479177387814;for(let t=0;t<this.numSplats;++t){const e=i[t]*l+.5,h=r[t]*l+.5,c=a[t]*l+.5,d=1/(1+Math.exp(-o[t]));n[4*t+0]=s(e),n[4*t+1]=s(h),n[4*t+2]=s(c),n[4*t+3]=s(d)}e.unlock()}updateTransformData(t){const e=is.float2Half;if(!this.transformATexture)return;const s=this.transformATexture.lock(),n=new Float32Array(s.buffer),i=this.transformBTexture.lock(),r=new rs,a=new ms,o=new rs,l=t.createIter(r,a,o);for(let t=0;t<this.numSplats;t++)l.read(t),a.normalize(),a.w<0&&a.mulScalar(-1),n[4*t+0]=r.x,n[4*t+1]=r.y,n[4*t+2]=r.z,s[4*t+3]=e(a.x)|e(a.y)<<16,i[4*t+0]=e(o.x),i[4*t+1]=e(o.y),i[4*t+2]=e(o.z),i[4*t+3]=e(a.z);this.transformATexture.unlock(),this.transformBTexture.unlock()}updateSHData(t){const e=this.sh1to3Texture.lock(),s=this.sh4to7Texture?.lock(),n=this.sh8to11Texture?.lock(),i=this.sh12to15Texture?.lock(),r={1:3,2:8,3:15}[this.shBands],a=((t,e)=>{const s=[];for(let n=0;n<e;++n)s.push(t.getProp(`f_rest_${n}`));return s})(t,3*r),o=2047,l=new Float32Array(1),h=new Uint32Array(l.buffer),c=new Array(3*r).fill(0);for(let d=0;d<t.numSplats;++d){for(let t=0;t<r;++t)c[3*t]=a[t][d],c[3*t+1]=a[t+r][d],c[3*t+2]=a[t+2*r][d];let t=c[0];for(let e=1;e<3*r;++e)t=Math.max(t,Math.abs(c[e]));if(0!==t){for(let e=0;e<r;++e)c[3*e+0]=Math.max(0,Math.min(o,Math.floor((c[3*e+0]/t*.5+.5)*o+.5))),c[3*e+1]=Math.max(0,Math.min(1023,Math.floor(1023*(c[3*e+1]/t*.5+.5)+.5))),c[3*e+2]=Math.max(0,Math.min(o,Math.floor((c[3*e+2]/t*.5+.5)*o+.5)));l[0]=t,e[4*d+0]=h[0],e[4*d+1]=c[0]<<21|c[1]<<11|c[2],e[4*d+2]=c[3]<<21|c[4]<<11|c[5],e[4*d+3]=c[6]<<21|c[7]<<11|c[8],this.shBands>1&&(s[4*d+0]=c[9]<<21|c[10]<<11|c[11],s[4*d+1]=c[12]<<21|c[13]<<11|c[14],s[4*d+2]=c[15]<<21|c[16]<<11|c[17],s[4*d+3]=c[18]<<21|c[19]<<11|c[20],this.shBands>2?(n[4*d+0]=c[21]<<21|c[22]<<11|c[23],n[4*d+1]=c[24]<<21|c[25]<<11|c[26],n[4*d+2]=c[27]<<21|c[28]<<11|c[29],n[4*d+3]=c[30]<<21|c[31]<<11|c[32],i[4*d+0]=c[33]<<21|c[34]<<11|c[35],i[4*d+1]=c[36]<<21|c[37]<<11|c[38],i[4*d+2]=c[39]<<21|c[40]<<11|c[41],i[4*d+3]=c[42]<<21|c[43]<<11|c[44]):n[d]=c[21]<<21|c[22]<<11|c[23])}}this.sh1to3Texture.unlock(),this.sh4to7Texture?.unlock(),this.sh8to11Texture?.unlock(),this.sh12to15Texture?.unlock()}}let Kp=class extends Fo{execute(){this.executeCallback?.()}constructor(...t){super(...t),this.executeCallback=null}};const Yp=new ps,Qp=new rs;class Zp{constructor(t,e){this.prevDir=new rs,this.updateMode="enable",this.device=t,this.gsplatInstance=e;const{resource:s}=e,n=new Map(Fh.get(t,t.isWebGPU?"wgsl":"glsl"));this.shader=zh.createShader(t,{uniqueName:"gsplatResolveSH",vertexGLSL:"\n\tattribute vec2 vertex_position;\n\tvoid main(void) {\n\t\tgl_Position = vec4(vertex_position, 0.0, 1.0);\n\t}\n",fragmentGLSL:'\n\t#include "gsplatEvalSHVS"\n\tvec4 packRgb(vec3 v) {\n\t\tuvec3 vb = uvec3(clamp(v, vec3(0.0), vec3(1.0)) * vec3(2047.0, 2047.0, 1023.0));\n\t\tuint bits = (vb.x << 21) | (vb.y << 10) | vb.z;\n\t\treturn vec4((uvec4(bits) >> uvec4(24, 16, 8, 0)) & uvec4(0xff)) / vec4(255.0);\n\t}\n\tuniform mediump vec3 dir;\n\tuniform mediump sampler2D centroids;\n\tuniform mediump float shN_mins;\n\tuniform mediump float shN_maxs;\n\tvoid main(void) {\n\t\tivec2 uv = ivec2(gl_FragCoord.xy) * ivec2(SH_COEFFS, 1);\n\t\tmediump vec3 coefficients[SH_COEFFS];\n\t\tfor (int i = 0; i < SH_COEFFS; i++) {\n\t\t\tvec3 s = texelFetch(centroids, ivec2(uv.x + i, uv.y), 0).xyz;\n\t\t\tcoefficients[i] = mix(vec3(shN_mins), vec3(shN_maxs), s);\n\t\t}\n\t\tgl_FragColor = packRgb(evalSH(coefficients, dir) * 0.25 + 0.5);\n\t}\n',vertexWGSL:"\n\tattribute vertex_position: vec2f;\n\t@vertex\n\tfn vertexMain(input: VertexInput) -> VertexOutput {\n\t\tvar output: VertexOutput;\n\t\toutput.position = vec4f(vertex_position, 0.0, 1.0);\n\t\treturn output;\n\t}\n",fragmentWGSL:'\n\t#include "gsplatEvalSHVS"\n\tfn packRgb(v: vec3f) -> vec4f {\n\t\tlet vb = vec3u(clamp(v, vec3f(0.0), vec3f(1.0)) * vec3f(2047.0, 2047.0, 1023.0));\n\t\tlet bits = dot(vb, vec3u(1 << 21, 1 << 10, 1));\n\t\treturn vec4f((vec4u(bits) >> vec4u(24, 16, 8, 0)) & vec4u(0xff)) / vec4f(255.0);\n\t}\n\tuniform dir: vec3f;\n\tuniform shN_mins: f32;\n\tuniform shN_maxs: f32;\n\tvar centroids: texture_2d<f32>;\n\t@fragment\n\tfn fragmentMain(input: FragmentInput) -> FragmentOutput {\n\t\tvar output: FragmentOutput;\n\t\tvar uv = vec2i(input.position.xy) * vec2i(SH_COEFFS, 1);\n\t\tvar coefficients: array<vec3f, SH_COEFFS>;\n\t\tfor (var i: i32 = 0; i < SH_COEFFS; i++) {\n\t\t\tlet s: vec3f = textureLoad(centroids, vec2i(uv.x + i, uv.y), 0).xyz;\n\t\t\tcoefficients[i] = mix(vec3f(uniform.shN_mins), vec3f(uniform.shN_maxs), s);\n\t\t}\n\t\toutput.color = packRgb(evalSH(&coefficients, uniform.dir) * 0.25 + 0.5);\n\t\treturn output;\n\t}\n',vertexIncludes:n,fragmentIncludes:n,fragmentDefines:new Map([["SH_BANDS",s.gsplatData.shBands.toString()]]),attributes:{vertex_position:Ys}}),this.texture=s.createTexture("centroids",7,new os(64,1024)),this.renderTarget=new ji({colorBuffer:this.texture,depth:!1}),this.renderPass=new Kp(t),this.renderPass.init(this.renderTarget,{}),this.renderPass.colorOps.clear=!0,this.quadRender=new Wh(this.shader);const{material:i}=e;i.setDefine("SH_BANDS","0");const{shaderChunks:r}=i;r.glsl.set("gsplatSogsColorVS","\n\tuniform mediump sampler2D sh0;\n\tuniform highp sampler2D sh_labels;\n\tuniform mediump sampler2D sh_result;\n\tuniform vec4 sh0_mins;\n\tuniform vec4 sh0_maxs;\n\tfloat SH_C0 = 0.28209479177387814;\n\tvec3 unpackRgb(vec4 v) {\n\t\tuvec4 uv = uvec4(v * 255.0);\n\t\tuint bits = (uv.x << 24) | (uv.y << 16) | (uv.z << 8) | uv.w;\n\t\tuvec3 vb = (uvec3(bits) >> uvec3(21, 10, 0)) & uvec3(0x7ffu, 0x7ffu, 0x3ffu);\n\t\treturn vec3(vb) / vec3(2047.0, 2047.0, 1023.0);\n\t}\n\tvec4 readColor(in SplatSource source) {\n\t\tvec4 baseSample = mix(sh0_mins, sh0_maxs, texelFetch(sh0, source.uv, 0));\n\t\tvec4 base = vec4(vec3(0.5) + baseSample.xyz * SH_C0, 1.0 / (1.0 + exp(-baseSample.w)));\n\t\tivec2 labelSample = ivec2(texelFetch(sh_labels, source.uv, 0).xy * 255.0);\n\t\tint n = labelSample.x + labelSample.y * 256;\n\t\tvec4 shSample = texelFetch(sh_result, ivec2(n % 64, n / 64), 0);\n\t\tvec3 sh = (unpackRgb(shSample) - vec3(0.5)) * 4.0;\n\t\treturn vec4(base.xyz + sh, base.w);\n\t}\n"),r.wgsl.set("gsplatSogsColorVS","\n\tvar sh0: texture_2d<f32>;\n\tvar sh_labels: texture_2d<f32>;\n\tvar sh_result: texture_2d<f32>;\n\tuniform sh0_mins: vec4f;\n\tuniform sh0_maxs: vec4f;\n\tconst SH_C0: f32 = 0.28209479177387814;\n\tfn unpackRgb(v: vec4f) -> vec3f {\n\t\tlet bits = dot(vec4u(v * 255.0), vec4u(1u << 24, 1u << 16, 1u << 8, 1u));\n\t\tlet vb = (vec3u(bits) >> vec3u(21, 10, 0)) & vec3u(0x7ffu, 0x7ffu, 0x3ffu);\n\t\treturn vec3f(vb) / vec3f(2047.0, 2047.0, 1023.0);\n\t}\n\tfn readColor(source: ptr<function, SplatSource>) -> vec4f {\n\t\tlet baseSample: vec4f = mix(uniform.sh0_mins, uniform.sh0_maxs, textureLoad(sh0, source.uv, 0));\n\t\tlet base = vec4f(vec3f(0.5) + baseSample.xyz * SH_C0, 1.0 / (1.0 + exp(-baseSample.w)));\n\t\tlet labelSample: vec2i = vec2i(textureLoad(sh_labels, source.uv, 0).xy * 255.0);\n\t\tlet n = labelSample.x + labelSample.y * 256;\n\t\tlet shSample: vec4f = textureLoad(sh_result, vec2i(n % 64, n / 64), 0);\n\t\tlet sh: vec3f = (unpackRgb(shSample) - vec3f(0.5)) * 4.0;\n\t\treturn vec4f(base.xyz + sh, base.w);\n\t}\n"),i.update(),t.scope.resolve("sh_result").setValue(this.texture)}destroy(){const{gsplatInstance:t}=this,{material:e}=t;e.setDefine("SH_BANDS",t.resource.gsplatData.shBands.toString());const{shaderChunks:s}=e;s.glsl.delete("gsplatSogsColorVS"),s.wgsl.delete("gsplatSogsColorVS"),e.update(),this.quadRender.destroy(),this.renderPass.destroy(),this.renderTarget.destroy(),this.texture.destroy(),this.shader.destroy()}render(t,e){const{prevDir:s,updateMode:n}=this;if("disable"===n)return;if(Yp.invert(e),Yp.transformVector(t.forward,Qp),Qp.normalize(),"enable"===n&&Qp.equalsApprox(s,.001))return;s.copy(Qp);this.renderPass.executeCallback=()=>{const{device:t}=this,{sh_centroids:e,meta:s}=this.gsplatInstance.resource.gsplatData;((t,e)=>{for(const s in e)t.resolve(s).setValue(e[s])})(t.scope,{dir:Qp.toArray(),centroids:e,shN_mins:s.shN.mins,shN_maxs:s.shN.maxs}),t.setCullMode(0),t.setDepthState(Ai.NODEPTH),t.setStencilState(null,null),t.setBlendState(Ti.NOBLEND),this.quadRender.render()},this.renderPass.render()}}function Jp(){const t="undefined"!=typeof self&&self||require("node:worker_threads").parentPort;let e,s,n,i,r,a,o=!1;const l={x:0,y:0,z:0},h={x:0,y:0,z:0},c={x:0,y:0,z:0},d={x:0,y:0,z:0};let u,f;const p=32,m=new Array(p).fill(0),g=new Array(p).fill(0),_=new Array(p).fill(0);t.addEventListener("message",v=>{const y=v.data??v;if(y.order&&(e=new Uint32Array(y.order)),y.centers)if(s=new Float32Array(y.centers),o=!0,y.chunks){const t=new Float32Array(y.chunks);n=new Float32Array(y.chunks,0,4*t.length/6),c.x=t[0],c.y=t[1],c.z=t[2],d.x=t[3],d.y=t[4],d.z=t[5];for(let e=0;e<t.length/6;++e){const s=t[6*e+0],i=t[6*e+1],r=t[6*e+2],a=t[6*e+3],o=t[6*e+4],l=t[6*e+5];n[4*e+0]=.5*(s+a),n[4*e+1]=.5*(i+o),n[4*e+2]=.5*(r+l),n[4*e+3]=.5*Math.sqrt((a-s)**2+(o-i)**2+(l-r)**2),s<c.x&&(c.x=s),i<c.y&&(c.y=i),r<c.z&&(c.z=r),a>d.x&&(d.x=a),o>d.y&&(d.y=o),l>d.z&&(d.z=l)}}else{const t=s.length/3,e=Math.ceil(t/256);let i,r,a,o,l,h;n=new Float32Array(4*e),c.x=c.y=c.z=1/0,d.x=d.y=d.z=-1/0;for(let u=0;u<e;++u){i=r=a=1/0,o=l=h=-1/0;const e=256*u,f=Math.min(t,256*(u+1));for(let t=e;t<f;++t){const e=s[3*t+0],n=s[3*t+1],u=s[3*t+2],f=Number.isFinite(e),p=Number.isFinite(n),m=Number.isFinite(u);f||(s[3*t+0]=0),p||(s[3*t+1]=0),m||(s[3*t+2]=0),f&&p&&m&&(e<i?i=e:e>o&&(o=e),n<r?r=n:n>l&&(l=n),u<a?a=u:u>h&&(h=u),e<c.x?c.x=e:e>d.x&&(d.x=e),n<c.y?c.y=n:n>d.y&&(d.y=n),u<c.z?c.z=u:u>d.z&&(d.z=u))}n[4*u+0]=.5*(i+o),n[4*u+1]=.5*(r+l),n[4*u+2]=.5*(a+h),n[4*u+3]=.5*Math.sqrt((o-i)**2+(l-r)**2+(h-a)**2)}}y.hasOwnProperty("mapping")&&(i=y.mapping?new Uint32Array(y.mapping):null,o=!0),y.cameraPosition&&(r=y.cameraPosition),y.cameraDirection&&(a=y.cameraDirection),(()=>{if(!(e&&s&&0!==s.length&&r&&a))return;const v=r.x,y=r.y,b=r.z,S=a.x,x=a.y,w=a.z,T=.001;if(!o&&Math.abs(v-l.x)<T&&Math.abs(y-l.y)<T&&Math.abs(b-l.z)<T&&Math.abs(S-h.x)<T&&Math.abs(x-h.y)<T&&Math.abs(w-h.z)<T)return;let C,E;o=!1,l.x=v,l.y=y,l.z=b,h.x=S,h.y=x,h.z=w;for(let t=0;t<8;++t){const e=1&t?c.x:d.x,s=2&t?c.y:d.y,n=4&t?c.z:d.z,i=e*S+s*x+n*w;0===t?C=E=i:(C=Math.min(C,i),E=Math.max(E,i))}const A=s.length/3,D=2**Math.max(10,Math.min(20,Math.round(Math.log2(A/4))))+1;u?.length!==A&&(u=new Uint32Array(A)),f&&f.length===D?f.fill(0):f=new Uint32Array(D);const P=E-C;if(P<1e-6)for(let t=0;t<A;++t)u[t]=0,f[0]++;else{const t=n.length/4;m.fill(0);for(let e=0;e<t;++e){const t=n[4*e+0],s=n[4*e+1],i=n[4*e+2],r=n[4*e+3],a=t*S+s*x+i*w-C,o=Math.max(0,Math.floor((a-r)*p/P)),l=Math.min(p,Math.ceil((a+r)*p/P));for(let t=o;t<l;++t)m[t]++}const e=m.reduce((t,e)=>t+e,0);for(let t=0;t<p;++t)_[t]=m[t]/e*D>>>0;for(let t=0;t<p;++t)g[t]=0===t?0:g[t-1]+_[t-1];const i=P/p;let r=0;for(let t=0;t<A;++t){const e=s[r++],n=s[r++],a=s[r++],o=(e*S+n*x+a*w-C)/i,l=o>>>0,h=g[l]+_[l]*(o-l)>>>0;u[t]=h,f[h]++}}for(let t=1;t<D;t++)f[t]+=f[t-1];for(let t=0;t<A;t++){const s=u[t],n=--f[s];e[n]=t}const L=v*S+y*x+b*w,I=t=>{let n=3*e[t];return s[n++]*S+s[n++]*x+s[n]*w-L},R=I(A-1)>=0?(()=>{const t=((t,e,s)=>{for(;t<=e;){const n=e+t>>1,i=s(n);if(i>0)t=n+1;else{if(!(i<0))return n;e=n-1}}return~t})(0,A-1,t=>-I(t));return Math.min(A,Math.abs(t))})():A;if(i)for(let t=0;t<A;++t)e[t]=i[e[t]];t.postMessage({order:e.buffer,count:R},[e.buffer]),e=null})()})}class tm extends Ve{constructor(){super();const t=t=>{const e=t.data??t,s=e.order,n=this.orderTexture._levels[0].buffer;this.worker.postMessage({order:n},[n]),this.orderTexture._levels[0]=new Uint32Array(s),this.orderTexture.upload(),this.fire("updated",e.count)},e=`(${Jp.toString()})()`;"node"===ze.environment?(this.worker=new Worker(e,{eval:!0}),this.worker.on("message",t)):(this.worker=new Worker(URL.createObjectURL(new Blob([e],{type:"application/javascript"}))),this.worker.addEventListener("message",t))}destroy(){this.worker.terminate(),this.worker=null}init(t,e,s){this.orderTexture=t,this.centers=e.slice();const n=this.orderTexture.lock({mode:1}).slice();this.orderTexture.unlock();for(let t=0;t<n.length;++t)n[t]=t;const i={order:n.buffer,centers:e.buffer,chunks:s?.buffer},r=[n.buffer,e.buffer].concat(s?[s.buffer]:[]);this.worker.postMessage(i,r)}setMapping(t){if(t){const e=new Float32Array(3*t.length);for(let s=0;s<t.length;++s){const n=3*t[s],i=3*s;e[i+0]=this.centers[n+0],e[i+1]=this.centers[n+1],e[i+2]=this.centers[n+2]}this.worker.postMessage({centers:e.buffer,mapping:t.buffer},[e.buffer,t.buffer])}else{const t=this.centers.slice();this.worker.postMessage({centers:t.buffer,mapping:null},[t.buffer])}}setCamera(t,e){this.worker.postMessage({cameraPosition:{x:t.x,y:t.y,z:t.z},cameraDirection:{x:e.x,y:e.y,z:e.z}})}}var em="\nuint pack8888(vec4 v) {\n\tuvec4 t = uvec4(v * 255.0) << uvec4(24u, 16u, 8u, 0u);\n\treturn t.x | t.y | t.z | t.w;\n}\nuint pack101010(vec3 v) {\n\tuvec3 t = uvec3(v * 1023.0) << uvec3(20u, 10u, 0u);\n\treturn t.x | t.y | t.z;\n}\nuint pack111110(vec3 v) {\n\tuvec3 t = uvec3(v * vec3(2047.0, 2047.0, 1023.0)) << uvec3(21u, 10u, 0u);\n\treturn t.x | t.y | t.z;\n}\nvec4 unpack8888(uint v) {\n\treturn vec4((uvec4(v) >> uvec4(24u, 16u, 8u, 0u)) & 0xffu) / 255.0;\n}\nvec3 unpack101010(uint v) {\n\treturn vec3((uvec3(v) >> uvec3(20u, 10u, 0u)) & 0x3ffu) / 1023.0;\n}\nvec3 unpack111110(uint v) {\n\treturn vec3((uvec3(v) >> uvec3(21u, 10u, 0u)) & uvec3(0x7ffu, 0x7ffu, 0x3ffu)) / vec3(2047.0, 2047.0, 1023.0);\n}\nvec3 resolveCodebook(vec3 s, vec4 codebook[64]) {\n\tuvec3 idx = uvec3(s * 255.0);\n\tvec3 v = vec3(\n\t\tcodebook[idx.x >> 2u][idx.x & 3u],\n\t\tcodebook[idx.y >> 2u][idx.y & 3u],\n\t\tcodebook[idx.z >> 2u][idx.z & 3u]\n\t);\n\treturn (v - codebook[0].x) / (codebook[63].w - codebook[0].x);\n}\n",sm="\nfn pack8888(v: vec4f) -> u32 {\n\tlet t = vec4u(v * 255.0) << vec4u(24u, 16u, 8u, 0u);\n\treturn t.x | t.y | t.z | t.w;\n}\nfn pack101010(v: vec3f) -> u32 {\n\tlet t = vec3u(v * vec3f(1023.0, 1023.0, 1023.0)) << vec3u(20u, 10u, 0u);\n\treturn t.x | t.y | t.z;\n}\nfn pack111110(v: vec3f) -> u32 {\n\tlet t = vec3u(v * vec3f(2047.0, 2047.0, 1023.0)) << vec3u(21u, 10u, 0u);\n\treturn t.x | t.y | t.z;\n}\nfn unpack8888(v: u32) -> vec4f {\n\treturn vec4f((vec4u(v) >> vec4u(24u, 16u, 8u, 0u)) & vec4u(0xffu)) / 255.0;\n}\nfn unpack101010(v: u32) -> vec3f {\n\treturn vec3f((vec3u(v) >> vec3u(20u, 10u, 0u)) & vec3u(0x3ffu)) / 1023.0;\n}\nfn unpack111110(v: u32) -> vec3f {\n\treturn vec3f((vec3u(v) >> vec3u(21u, 10u, 0u)) & vec3u(0x7ffu, 0x7ffu, 0x3ffu)) / vec3f(2047.0, 2047.0, 1023.0);\n}\nfn resolveCodebook(s: vec3f, codebook: ptr<uniform, array<vec4f, 64>>) -> vec3f {\n\tlet idx = vec3u(s * 255.0);\n\tlet v = vec3f(\n\t\tcodebook[idx.x >> 2u][idx.x & 3u],\n\t\tcodebook[idx.y >> 2u][idx.y & 3u],\n\t\tcodebook[idx.z >> 2u][idx.z & 3u]\n\t);\n\treturn (v - codebook[0].x) / (codebook[63].w - codebook[0].x);\n}\n";const nm=.28209479177387814,im=t=>t.device.isNull?new Promise(e=>{e(new Uint8Array(t.width*t.height*4))}):t.read(0,0,t.width,t.height,{mipLevel:0,face:0,immediate:!0}),rm=(t,e)=>{for(const s in e)t.resolve(s).setValue(e[s])};class am{constructor(t,e,s,n,i,r){const a=(t,e,s)=>t*(1-s)+e*s,{meta:o,shBands:l}=t,{means:h,scales:c,sh0:d,shN:u}=o,f=e&&t.means_l._levels[0],p=e&&t.means_u._levels[0],m=s&&t.quats._levels[0],g=n&&t.scales._levels[0],_=i&&t.sh0._levels[0],v=r&&t.sh_labels._levels[0],y=r&&t.sh_centroids._levels[0],b=Math.SQRT2,S={1:3,2:8,3:15}[l]??0;this.read=l=>{if(e){const t=a(h.mins[0],h.maxs[0],((p[4*l+0]<<8)+f[4*l+0])/65535),s=a(h.mins[1],h.maxs[1],((p[4*l+1]<<8)+f[4*l+1])/65535),n=a(h.mins[2],h.maxs[2],((p[4*l+2]<<8)+f[4*l+2])/65535);e.x=Math.sign(t)*(Math.exp(Math.abs(t))-1),e.y=Math.sign(s)*(Math.exp(Math.abs(s))-1),e.z=Math.sign(n)*(Math.exp(Math.abs(n))-1)}if(s){const t=(m[4*l+0]/255-.5)*b,e=(m[4*l+1]/255-.5)*b,n=(m[4*l+2]/255-.5)*b,i=Math.sqrt(Math.max(0,1-(t*t+e*e+n*n)));switch(m[4*l+3]-252){case 0:s.set(t,e,n,i);break;case 1:s.set(i,e,n,t);break;case 2:s.set(e,i,n,t);break;case 3:s.set(e,n,i,t)}}if(n)if(2===o.version){const t=c.codebook[g[4*l+0]],e=c.codebook[g[4*l+1]],s=c.codebook[g[4*l+2]];n.set(t,e,s)}else{const t=a(c.mins[0],c.maxs[0],g[4*l+0]/255),e=a(c.mins[1],c.maxs[1],g[4*l+1]/255),s=a(c.mins[2],c.maxs[2],g[4*l+2]/255);n.set(t,e,s)}if(i)if(2===o.version){const t=d.codebook[_[4*l+0]],e=d.codebook[_[4*l+1]],s=d.codebook[_[4*l+2]],n=_[4*l+3]/255;i.set(.5+t*nm,.5+e*nm,.5+s*nm,n)}else{const t=a(d.mins[0],d.maxs[0],_[4*l+0]/255),e=a(d.mins[1],d.maxs[1],_[4*l+1]/255),s=a(d.mins[2],d.maxs[2],_[4*l+2]/255),n=a(d.mins[3],d.maxs[3],_[4*l+3]/255);i.set(.5+t*nm,.5+e*nm,.5+s*nm,1/(1+Math.exp(-n)))}if(r){const e=v[4*l+0]+(v[4*l+1]<<8),s=e%64*S,n=Math.floor(e/64);if(2===o.version)for(let e=0;e<3;++e)for(let i=0;i<S;++i)r[15*e+i]=u.codebook[y[4*(s+i)+e+n*t.sh_centroids.width*4]];else for(let e=0;e<3;++e)for(let i=0;i<S;++i)r[15*e+i]=a(u.mins,u.maxs,y[4*(s+i)+e+n*t.sh_centroids.width*4]/255)}}}}class om{_destroyGpuResources(){this.means_l?.destroy(),this.means_u?.destroy(),this.quats?.destroy(),this.scales?.destroy(),this.sh0?.destroy(),this.sh_centroids?.destroy(),this.sh_labels?.destroy(),this.packedTexture?.destroy(),this.packedSh0?.destroy(),this.packedShN?.destroy()}static calcBands(t){return{192:1,512:2,960:3}[t]??0}destroy(){this.deviceRestoredEvent?.off(),this.deviceRestoredEvent=null,this.destroyed=!0,this._destroyGpuResources()}createIter(t,e,s,n,i){return new am(this,t,e,s,n,i)}calcAabb(t){const{mins:e,maxs:s}=this.meta.means,n=t=>Math.sign(t)*(Math.exp(Math.abs(t))-1);t.center.set(.5*(n(e[0])+n(s[0])),.5*(n(e[1])+n(s[1])),.5*(n(e[2])+n(s[2]))),t.halfExtents.set(.5*(n(s[0])-n(e[0])),.5*(n(s[1])-n(e[1])),.5*(n(s[2])-n(e[2])))}getCenters(){const t=this._centers;return this._centers=null,t}calcFocalPoint(t,e){const{mins:s,maxs:n}=this.meta.means,i=t=>Math.sign(t)*(Math.exp(Math.abs(t))-1);t.set(.5*(i(s[0])+i(n[0])),.5*(i(s[1])+i(n[1])),.5*(i(s[2])+i(n[2])))}get isSogs(){return!0}async decompress(){const t=["x","y","z","f_dc_0","f_dc_1","f_dc_2","opacity","scale_0","scale_1","scale_2","rot_0","rot_1","rot_2","rot_3"],{shBands:e}=this,{means_l:s,means_u:n,quats:i,scales:r,sh0:a,sh_labels:o,sh_centroids:l}=this;if(s._levels[0]=await im(s),n._levels[0]=await im(n),i._levels[0]=await im(i),r._levels[0]=await im(r),a._levels[0]=await im(a),e>0){o._levels[0]=await im(o),l._levels[0]=await im(l);const e=[];for(let t=0;t<45;++t)e.push(`f_rest_${t}`);t.splice(t.indexOf("f_dc_0")+1,0,...e)}const h={};t.forEach(t=>{h[t]=new Float32Array(this.numSplats)});const c=new rs,d=new ms,u=new rs,f=new ls,p=e>0?new Float32Array(45):null,m=this.createIter(c,d,u,f,p);for(let t=0;t<this.numSplats;++t)if(m.read(t),h.x[t]=c.x,h.y[t]=c.y,h.z[t]=c.z,h.rot_1[t]=d.x,h.rot_2[t]=d.y,h.rot_3[t]=d.z,h.rot_0[t]=d.w,h.scale_0[t]=u.x,h.scale_1[t]=u.y,h.scale_2[t]=u.z,h.f_dc_0[t]=(f.x-.5)/nm,h.f_dc_1[t]=(f.y-.5)/nm,h.f_dc_2[t]=(f.z-.5)/nm,h.opacity[t]=f.w<=0?-40:f.w>=1?40:-Math.log(1/f.w-1),p)for(let e=0;e<45;++e)h[`f_rest_${e}`][t]=p[e];return new Np([{name:"vertex",count:this.numSplats,properties:t.map(t=>({name:t,type:"float",byteSize:4,storage:h[t]}))}])}async generateCenters(){const{device:t,width:e,height:s}=this.means_l,{scope:n}=t,i=new pi(t,{name:"sogsCentersTexture",width:e,height:s,format:Hs,mipmaps:!1}),r=zh.createShader(t,{uniqueName:"GsplatSogsCentersShader",attributes:{vertex_position:Ys},vertexChunk:"fullscreenQuadVS",fragmentGLSL:'\n#include "gsplatPackingPS"\nuniform highp sampler2D means_l;\nuniform highp sampler2D means_u;\nuniform highp uint numSplats;\nuniform highp vec3 means_mins;\nuniform highp vec3 means_maxs;\nvoid main(void) {\n\tint w = int(textureSize(means_l, 0).x);\n\tivec2 uv = ivec2(gl_FragCoord.xy);\n\tif (uint(uv.x + uv.y * w) >= numSplats) {\n\t\tdiscard;\n\t}\n\tvec3 l = texelFetch(means_l, uv, 0).xyz;\n\tvec3 u = texelFetch(means_u, uv, 0).xyz;\n\tvec3 n = (l + u * 256.0) / 257.0;\n\tvec3 v = mix(means_mins, means_maxs, n);\n\tvec3 center = sign(v) * (exp(abs(v)) - 1.0);\n\tpcFragColor0 = uvec4(floatBitsToUint(center), 0u);\n}\n',fragmentWGSL:"\nvar means_l: texture_2d<f32>;\nvar means_u: texture_2d<f32>;\nuniform numSplats: u32;\nuniform means_mins: vec3f;\nuniform means_maxs: vec3f;\n@fragment\nfn fragmentMain(input: FragmentInput) -> FragmentOutput {\n\tvar output: FragmentOutput;\n\tlet w: u32 = textureDimensions(means_l, 0).x;\n\tlet uv: vec2<i32> = vec2<i32>(input.position.xy);\n\tif (u32(uv.x + uv.y * i32(w)) >= uniform.numSplats) {\n\t\tdiscard;\n\t\treturn output;\n\t}\n\tlet l: vec3f = textureLoad(means_l, uv, 0).xyz;\n\tlet u: vec3f = textureLoad(means_u, uv, 0).xyz;\n\tlet n: vec3f = (l + u * 256.0) / 257.0;\n\tlet v: vec3f = mix(uniform.means_mins, uniform.means_maxs, n);\n\tlet center: vec3f = sign(v) * (exp(abs(v)) - 1.0);\n\tlet packed: vec4<u32> = bitcast<vec4<u32>>(vec4f(center, 0.0));\n\toutput.color = packed;\n\treturn output;\n}\n",fragmentOutputTypes:["uvec4"],fragmentIncludes:new Map([["gsplatPackingPS",t.isWebGPU?sm:em]])}),a=new ji({colorBuffer:i,depth:!1,mipLevel:0});t.setCullMode(0),t.setBlendState(Ti.NOBLEND),t.setDepthState(Ai.NODEPTH),rm(n,{means_l:this.means_l,means_u:this.means_u,numSplats:this.numSplats,means_mins:this.meta.means.mins,means_maxs:this.meta.means.maxs}),Xh(t,a,r),a.destroy();const o=await im(i);if(this.destroyed||t._destroyed)return void i.destroy();const l=new Float32Array(o.buffer),h=new Float32Array(3*this.numSplats);for(let t=0;t<this.numSplats;t++){const e=4*t;h[3*t+0]=l[e+0],h[3*t+1]=l[e+1],h[3*t+2]=l[e+2]}this._centers=h,i.destroy()}packGpuMemory(){const{meta:t,means_l:e,means_u:s,quats:n,scales:i,sh0:r,sh_labels:a,numSplats:o}=this,{device:l}=e,{scope:h}=l,c=2===t.version?"v2":"v1",d=zh.createShader(l,{uniqueName:`GsplatSogsReorderShader-${c}`,attributes:{vertex_position:Ys},vertexChunk:"fullscreenQuadVS",fragmentGLSL:'\n#include "gsplatPackingPS"\nuniform highp sampler2D means_l;\nuniform highp sampler2D means_u;\nuniform highp sampler2D quats;\nuniform highp sampler2D scales;\nuniform highp sampler2D sh0;\nuniform highp sampler2D sh_labels;\nuniform highp uint numSplats;\n#ifdef REORDER_V1\n\tfloat sigmoid(float x) { return 1.0 / (1.0 + exp(-x)); }\n\tvec3 vmin(vec3 v) { return vec3(min(min(v.x, v.y), v.z)); }\n\tvec3 vmax(vec3 v) { return vec3(max(max(v.x, v.y), v.z)); }\n\tvec3 resolve(vec3 m, vec3 M, vec3 v) { return (mix(m, M, v) - vmin(m)) / (vmax(M) - vmin(m)); }\n\t\n\tuniform vec3 scalesMins;\n\tuniform vec3 scalesMaxs;\n\tuniform vec4 sh0Mins;\n\tuniform vec4 sh0Maxs;\n#else\n\tuniform vec4 scales_codebook[64];\n\tuniform vec4 sh0_codebook[64];\n#endif\nvoid main(void) {\n\tint w = int(textureSize(means_l, 0).x);\n\tivec2 uv = ivec2(gl_FragCoord.xy);\n\tif (uint(uv.x + uv.y * w) >= numSplats) {\n\t\tdiscard;\n\t}\n\tvec3 meansLSample   = texelFetch(means_l, uv, 0).xyz;\n\tvec3 meansUSample   = texelFetch(means_u, uv, 0).xyz;\n\tvec4 quatsSample\t= texelFetch(quats, uv, 0);\n\tvec3 scalesSample   = texelFetch(scales, uv, 0).xyz;\n\tvec4 sh0Sample\t  = texelFetch(sh0, uv, 0);\n\tvec2 shLabelsSample = texelFetch(sh_labels, uv, 0).xy;\n\t#ifdef REORDER_V1\n\t\tuint scale = pack101010(resolve(scalesMins, scalesMaxs, scalesSample));\n\t\tuint sh0 = pack111110(resolve(sh0Mins.xyz, sh0Maxs.xyz, sh0Sample.xyz));\n\t\tfloat alpha = sigmoid(mix(sh0Mins.w, sh0Maxs.w, sh0Sample.w));\n\t#else\n\t\tuint scale = pack101010(resolveCodebook(scalesSample, scales_codebook));\n\t\tuint sh0 = pack111110(resolveCodebook(sh0Sample.xyz, sh0_codebook));\n\t\tfloat alpha = sh0Sample.w;\n\t#endif\n\tuint qmode = uint(quatsSample.w * 255.0) - 252u;\n\tpcFragColor0 = uvec4(\n\t\tpack8888(vec4(meansLSample, shLabelsSample.x)),\n\t\tpack8888(vec4(meansUSample, shLabelsSample.y)),\n\t\tpack8888(vec4(quatsSample.xyz, alpha)),\n\t\t(scale << 2u) | qmode\n\t);\n\tpcFragColor1 = unpack8888(sh0);\n}\n',fragmentWGSL:'\n#include "gsplatPackingPS"\nvar means_l: texture_2d<f32>;\nvar means_u: texture_2d<f32>;\nvar quats: texture_2d<f32>;\nvar scales: texture_2d<f32>;\nvar sh0: texture_2d<f32>;\nvar sh_labels: texture_2d<f32>;\nuniform numSplats: u32;\n#ifdef REORDER_V1\n\tfn sigmoid(x: f32) -> f32 { return 1.0 / (1.0 + exp(-x)); }\n\tfn vmin(v: vec3f) -> vec3f { return vec3f(min(min(v.x, v.y), v.z)); }\n\tfn vmax(v: vec3f) -> vec3f { return vec3f(max(max(v.x, v.y), v.z)); }\n\tfn resolve(m: vec3f, M: vec3f, v: vec3f) -> vec3f { return (mix(m, M, v) - vmin(m)) / (vmax(M) - vmin(m)); }\n\tuniform scalesMins: vec3f;\n\tuniform scalesMaxs: vec3f;\n\tuniform sh0Mins: vec4f;\n\tuniform sh0Maxs: vec4f;\n#else\n\tuniform scales_codebook: array<vec4f, 64>;\n\tuniform sh0_codebook: array<vec4f, 64>;\n#endif\n@fragment\nfn fragmentMain(input: FragmentInput) -> FragmentOutput {\n\tvar output: FragmentOutput;\n\tlet w: u32 = textureDimensions(means_l, 0).x;\n\tlet uv: vec2<u32> = vec2<u32>(input.position.xy);\n\tif (uv.x + uv.y * w >= uniform.numSplats) {\n\t\tdiscard;\n\t\treturn output;\n\t}\n\tlet meansLSample: vec3<f32> = textureLoad(means_l, uv, 0).xyz;\n\tlet meansUSample: vec3<f32> = textureLoad(means_u, uv, 0).xyz;\n\tlet quatsSample: vec4<f32> = textureLoad(quats, uv, 0);\n\tlet scalesSample: vec3<f32> = textureLoad(scales, uv, 0).xyz;\n\tlet sh0Sample: vec4f = textureLoad(sh0, uv, 0);\n\tlet shLabelsSample: vec2<f32> = textureLoad(sh_labels, uv, 0).xy;\n\t#ifdef REORDER_V1\n\t\tlet scale = pack101010(resolve(uniform.scalesMins, uniform.scalesMaxs, scalesSample));\n\t\tlet sh0 = pack111110(resolve(uniform.sh0Mins.xyz, uniform.sh0Maxs.xyz, sh0Sample.xyz));\n\t\tlet alpha = sigmoid(mix(uniform.sh0Mins.w, uniform.sh0Maxs.w, sh0Sample.w));\n\t#else\n\t\tlet scale = pack101010(resolveCodebook(scalesSample, &uniform.scales_codebook));\n\t\tlet sh0 = pack111110(resolveCodebook(sh0Sample.xyz, &uniform.sh0_codebook));\n\t\tlet alpha = sh0Sample.w;\n\t#endif\n\tlet qmode = u32(quatsSample.w * 255.0) - 252u;\n\toutput.color = vec4u(\n\t\tpack8888(vec4f(meansLSample, shLabelsSample.x)),\n\t\tpack8888(vec4f(meansUSample, shLabelsSample.y)),\n\t\tpack8888(vec4f(quatsSample.xyz, alpha)),\n\t\t(scale << 2u) | qmode\n\t);\n\toutput.color1 = unpack8888(sh0);\n\treturn output;\n}\n',fragmentOutputTypes:["uvec4","vec4"],fragmentIncludes:new Map([["gsplatPackingPS",l.isWebGPU?sm:em]]),fragmentDefines:2===t.version?void 0:new Map([["REORDER_V1","1"]])}),u=new ji({colorBuffers:[this.packedTexture,this.packedSh0],depth:!1,mipLevel:0});l.setCullMode(0),l.setBlendState(Ti.NOBLEND),l.setDepthState(Ai.NODEPTH),rm(h,{means_l:e,means_u:s,quats:n,scales:i,sh0:r,sh_labels:a??e,numSplats:o,"scales_codebook[0]":this.meta.scales.codebook,"sh0_codebook[0]":this.meta.sh0.codebook,scalesMins:t.scales.mins,scalesMaxs:t.scales.maxs,sh0Mins:t.sh0.mins,sh0Maxs:t.sh0.maxs}),Xh(l,u,d),u.destroy()}packShMemory(){const{meta:t,sh_centroids:e}=this,{device:s}=e,{scope:n}=s,i=2===t.version?"v2":"v1",r=zh.createShader(s,{uniqueName:`GsplatSogsReorderShShader-${i}`,attributes:{vertex_position:Ys},vertexChunk:"fullscreenQuadVS",fragmentGLSL:'\n#include "gsplatPackingPS"\nuniform highp sampler2D sh_centroids;\nuniform vec4 shN_codebook[64];\nvoid main(void) {\n\tivec2 uv = ivec2(gl_FragCoord.xy);\n\tvec3 shNSample = texelFetch(sh_centroids, uv, 0).xyz;\n#ifdef REORDER_V1\n\tpcFragColor0 = unpack8888(pack111110(shNSample));\n#else\n\tpcFragColor0 = unpack8888(pack111110(resolveCodebook(shNSample, shN_codebook)));\n#endif\n}\n',fragmentWGSL:'\n#include "gsplatPackingPS"\nvar sh_centroids: texture_2d<f32>;\nuniform shN_codebook: array<vec4f, 64>;\n@fragment\nfn fragmentMain(input: FragmentInput) -> FragmentOutput {\n\tvar output: FragmentOutput;\n\tvar uv = vec2i(input.position.xy);\n\tvar shNSample = textureLoad(sh_centroids, uv, 0).xyz;\n#ifdef REORDER_V1\n\toutput.color = unpack8888(pack111110(shNSample));\n#else\n\toutput.color = unpack8888(pack111110(resolveCodebook(shNSample, &uniform.shN_codebook)));\n#endif\n\treturn output;\n}\n',fragmentIncludes:new Map([["gsplatPackingPS",s.isWebGPU?sm:em]]),fragmentDefines:2===t.version?void 0:new Map([["REORDER_V1","1"]])}),a=new ji({colorBuffer:this.packedShN,depth:!1,mipLevel:0});s.setCullMode(0),s.setBlendState(Ti.NOBLEND),s.setDepthState(Ai.NODEPTH),rm(n,{sh_centroids:e,"shN_codebook[0]":this.meta.shN.codebook}),Xh(s,a,r),a.destroy()}async prepareGpuData(){let t=this.means_l.device;const{height:e,width:s}=this.means_l;if(this.destroyed||!t||t._destroyed)return;const n=this.url?`_${this.url}`:"";if(this.packedTexture=new pi(t,{name:`sogsPackedTexture${n}`,width:s,height:e,format:Hs,mipmaps:!1}),this.packedSh0=new pi(t,{name:`sogsPackedSh0${n}`,width:s,height:e,format:7,mipmaps:!1}),this.packedShN=this.sh_centroids&&new pi(t,{name:`sogsPackedShN${n}`,width:this.sh_centroids.width,height:this.sh_centroids.height,format:7,mipmaps:!1}),this.minimalMemory||(this.deviceRestoredEvent=t.on("devicerestored",()=>{this.packGpuMemory(),this.packedShN&&this.packShMemory()})),["scales","sh0","shN"].forEach(t=>{const e=this.meta[t]?.codebook;null===e?.[0]&&(e[0]=e[1]+(e[1]-e[255])/255)}),t=this.means_l?.device,!this.destroyed&&t&&!t._destroyed&&(await this.generateCenters(),t=this.means_l?.device,!this.destroyed&&t&&!t._destroyed)){if(this.packGpuMemory(),this.packedShN){if(t=this.means_l?.device,this.destroyed||!t||t._destroyed)return;this.packShMemory()}this.minimalMemory&&(this.means_l?.destroy(),this.means_u?.destroy(),this.quats?.destroy(),this.scales?.destroy(),this.sh0?.destroy(),this.sh_centroids?.destroy(),this.sh_labels?.destroy(),this.means_l=null,this.means_u=null,this.quats=null,this.scales=null,this.sh0=null,this.sh_centroids=null,this.sh_labels=null)}}reorderData(){return this.prepareGpuData()}constructor(){this.url="",this.minimalMemory=!1,this.deviceRestoredEvent=null,this._centers=null,this.destroyed=!1,this.shBands=0}}const lm=new ps,hm=new rs,cm=new rs,dm=[0,0];class um{constructor(t,e={}){this.options={},this.sorter=null,this.lastCameraPosition=new rs,this.lastCameraDirection=new rs,this.resolveSH=null,this.cameras=[],this.resource=t,this.orderTexture=t.createTexture("splatOrder",zs,t.evalTextureSize(t.numSplats)),e.material?(this._material=e.material,this.setMaterialOrderTexture(this._material)):(this._material=new Ju({uniqueName:"SplatMaterial",vertexGLSL:'#include "gsplatVS"',fragmentGLSL:'#include "gsplatPS"',vertexWGSL:'#include "gsplatVS"',fragmentWGSL:'#include "gsplatPS"',attributes:{vertex_position:Ys,vertex_id_attrib:gn}}),this.configureMaterial(this._material),this._material.update()),this.meshInstance=new fc(t.mesh,this._material),this.meshInstance.setInstancing(t.instanceIndices,!0),this.meshInstance.gsplatInstance=this,this.meshInstance.instancingCount=0;const s=t.centers.slice(),n=t.chunks?.slice();this.sorter=new tm,this.sorter.init(this.orderTexture,s,n),this.sorter.on("updated",t=>{this.meshInstance.instancingCount=Math.ceil(t/Xp.instanceSize),this.material.setParameter("numSplats",t)}),this.setHighQualitySH(e.highQualitySH??!1)}destroy(){this.orderTexture?.destroy(),this.resolveSH?.destroy(),this.material?.destroy(),this.meshInstance?.destroy(),this.sorter?.destroy()}setMaterialOrderTexture(t){t.setParameter("splatOrder",this.orderTexture),t.setParameter("splatTextureSize",this.orderTexture.width)}set material(t){this._material!==t&&(this._material=t,this.setMaterialOrderTexture(this._material),this.meshInstance&&(this.meshInstance.material=t))}get material(){return this._material}configureMaterial(t,e={}){this.resource.configureMaterial(t),t.setParameter("numSplats",0),this.setMaterialOrderTexture(t),t.setParameter("alphaClip",.3),t.setDefine("DITHER_"+(e.dither?"BLUENOISE":"NONE"),""),t.cull=0,t.blendType=e.dither?3:4,t.depthWrite=!!e.dither}updateViewport(t){const e=t?.camera,s=e?.renderTarget,{width:n,height:i}=s??this.resource.device;dm[0]=n,dm[1]=i;const r=e?.camera?.xr;r?.active&&2===r.views.list.length&&(dm[0]*=.5),this.material.setParameter("viewport",dm)}sort(t){if(this.sorter){const e=t.getWorldTransform();e.getTranslation(hm),e.getZ(cm);const s=this.meshInstance.node.getWorldTransform(),n=lm.invert(s);n.transformPoint(hm,hm),n.transformVector(cm,cm),hm.equalsApprox(this.lastCameraPosition)&&cm.equalsApprox(this.lastCameraDirection)||(this.lastCameraPosition.copy(hm),this.lastCameraDirection.copy(cm),this.sorter.setCamera(hm,cm))}this.updateViewport(t)}update(){if(this.cameras.length>0){const t=this.cameras[0];this.sort(t._node),this.resolveSH?.render(t._node,this.meshInstance.node.getWorldTransform()),this.cameras.length=0}}setHighQualitySH(t){const{resource:e}=this,{gsplatData:s}=e;s instanceof om&&s.shBands>0&&t===!!this.resolveSH&&(this.resolveSH?(this.resolveSH.destroy(),this.resolveSH=null):this.resolveSH=new Zp(e.device,this))}}class fm extends Xp{destroy(){this.gsplatData.destroy(),super.destroy()}configureMaterialDefines(t){t.set("GSPLAT_SOGS_DATA",!0),t.set("SH_BANDS",this.gsplatData.shBands)}configureMaterial(t){const{gsplatData:e}=this,{meta:s}=e;this.configureMaterialDefines(t.defines),["packedTexture","packedSh0","packedShN"].forEach(s=>{e[s]&&t.setParameter(s,e[s])}),["means"].forEach(e=>{const n=s[e];n&&(t.setParameter(`${e}_mins`,n.mins),t.setParameter(`${e}_maxs`,n.maxs))}),2===s.version?["scales","sh0","shN"].forEach(e=>{const n=s[e];n&&(t.setParameter(`${e}_mins`,n.codebook[0]),t.setParameter(`${e}_maxs`,n.codebook[255]))}):(["scales","sh0"].forEach(e=>{const n=s[e];n&&(t.setParameter(`${e}_mins`,Math.min(...n.mins.slice(0,3))),t.setParameter(`${e}_maxs`,Math.max(...n.maxs.slice(0,3))))}),["shN"].forEach(e=>{const n=s[e];n&&(t.setParameter(`${e}_mins`,n.mins),t.setParameter(`${e}_maxs`,n.maxs))}))}evalTextureSize(t){return new os(this.gsplatData.means_l.width,this.gsplatData.means_l.height)}}const pm="KEEP_ASPECT",mm="AUTO";let gm;function _m(){return gm}function vm(t){gm=t}class ym{addRenderPass(t){t.frameUpdate();const e=t.beforePasses;for(let t=0;t<e.length;t++){const s=e[t];s.enabled&&this.addRenderPass(s)}t.enabled&&this.renderPasses.push(t);const s=t.afterPasses;for(let t=0;t<s.length;t++){const e=s[t];e.enabled&&this.addRenderPass(e)}}reset(){this.renderPasses.length=0}compile(){const t=this.renderTargetMap,e=this.renderPasses;for(let s=0;s<e.length;s++){const n=e[s],i=n.renderTarget;if(void 0!==i){const e=t.get(i);if(e){const t=n.colorArrayOps.length;for(let s=0;s<t;s++){n.colorArrayOps[s].clear||(e.colorArrayOps[s].store=!0)}n.depthStencilOps.clearDepth||(e.depthStencilOps.storeDepth=!0),n.depthStencilOps.clearStencil||(e.depthStencilOps.storeStencil=!0)}t.set(i,n)}}for(let t=0;t<e.length-1;t++){const s=e[t],n=s.renderTarget,i=e[t+1];n===i.renderTarget&&void 0!==n&&(i.depthStencilOps.clearDepth||i.depthStencilOps.clearStencil||i.colorArrayOps.some(t=>t.clear)||s.afterPasses.length>0||i.beforePasses.length>0||(s._skipEnd=!0,i._skipStart=!0))}let s=null,n=null;for(let t=0;t<e.length;t++){const i=e[t],r=i.renderTarget,a=r?.colorBuffer;if(a?.cubemap){if(s===a){const t=n.colorArrayOps.length;for(let e=0;e<t;e++)n.colorArrayOps[e].mipmaps=!1}s=r.colorBuffer,n=i}else i.requiresCubemaps&&(s=null,n=null)}t.clear()}render(t){this.compile();const e=this.renderPasses;for(let t=0;t<e.length;t++)e[t].render()}constructor(){this.renderPasses=[],this.renderTargetMap=new Map}}class bm{constructor(t,e){this.texture0=t,this.texture1=e}destroy(){this.texture0?.destroy(),this.texture1?.destroy()}}const Sm=new di;class xm{static createTexture(t,e,s,n=""){return new pi(t,{name:`AreaLightLUT${n}`,width:s,height:s,format:e,addressU:1,addressV:1,type:yn,magFilter:1,minFilter:0,anisotropy:1,mipmaps:!1})}static applyTextures(t,e,s){Sm.remove(t),Sm.get(t,()=>new bm(e,e===s?null:s)),t.scope.resolve("areaLightsLutTex1").setValue(e),t.scope.resolve("areaLightsLutTex2").setValue(s)}static createPlaceholder(t){const e=xm.createTexture(t,Ls,2,"placeholder");e.lock().fill(0),e.unlock(),xm.applyTextures(t,e,e)}static set(t,e,s){function n(t,e,s){const n=xm.createTexture(t,s,64);return n.lock().set(e),n.unlock(),n}function i(t){const e=t.length,s=new Uint16Array(e),n=is.float2Half;for(let i=0;i<e;i++)s[i]=n(t[i]);return s}const r=s,a=i(e),o=i(r),l=n(t,a,Ls),h=n(t,o,Ls);xm.applyTextures(t,l,h)}}const wm="en-US",Tm={en:"en-US",es:"en-ES",zh:"zh-CN","zh-HK":"zh-TW","zh-TW":"zh-HK","zh-MO":"zh-HK",fr:"fr-FR",de:"de-DE",it:"it-IT",ru:"ru-RU",ja:"ja-JP"},Cm={};function Em(t,e){for(let s=0,n=t.length;s<n;s++)Cm[t[s]]=e}function Am(t){const e=t.indexOf("-");return-1!==e?t.substring(0,e):t}function Dm(t,e){if(e[t])return t;let s=Tm[t];if(s&&e[s])return s;const n=Am(t);return s=Tm[n],e[s]?s:e[n]?n:wm}Em(["ja","ko","th","vi","zh","id"],t=>0),Em(["fa","hi"],t=>t>=0&&t<=1?0:1),Em(["fr","pt"],t=>t>=0&&t<2?0:1),Em(["da"],t=>1===t||!Number.isInteger(t)&&t>=0&&t<=1?0:1),Em(["de","en","it","el","es","tr","fi","sv","nb","no","ur"],t=>1===t?0:1),Em(["ru","uk"],t=>{if(Number.isInteger(t)){const e=t%10,s=t%100;if(1===e&&11!==s)return 0;if(e>=2&&e<=4&&(s<12||s>14))return 1;if(0===e||e>=5&&e<=9||s>=11&&s<=14)return 2}return 3}),Em(["pl"],t=>{if(Number.isInteger(t)){if(1===t)return 0;const e=t%10,s=t%100;if(e>=2&&e<=4&&(s<12||s>14))return 1;if(e>=0&&e<=1||e>=5&&e<=9||s>=12&&s<=14)return 2}return 3}),Em(["ar"],t=>{if(0===t)return 0;if(1===t)return 1;if(2===t)return 2;if(Number.isInteger(t)){const e=t%100;if(e>=3&&e<=10)return 3;if(e>=11&&e<=99)return 4}return 5});const Pm=Cm[Am(wm)];function Lm(t){return Cm[t]||Pm}const Im=new RegExp("^\\s*(?:(?:[a-z]+[a-z0-9\\-+.]*:)?//|data:|blob:)","i");class Rm{constructor(t="",e="",s=null,n=null,i=null,r=null){this.url=t,this.filename=e,this.hash=s,this.size=n,this.opt=i,this.contents=r}equals(t){return this.url===t.url&&this.filename===t.filename&&this.hash===t.hash&&this.size===t.size&&this.opt===t.opt&&this.contents===t.contents}}let Mm=-1;const km={pvr:"extCompressedTexturePVRTC",dxt:"extCompressedTextureS3TC",etc2:"extCompressedTextureETC",etc1:"extCompressedTextureETC1",basis:"canvas"},Om=["pvr","dxt","etc2","etc1","basis"];class Fm extends Ve{static{this.EVENT_LOAD="load"}static{this.EVENT_UNLOAD="unload"}static{this.EVENT_REMOVE="remove"}static{this.EVENT_ERROR="error"}static{this.EVENT_CHANGE="change"}static{this.EVENT_PROGRESS="progress"}static{this.EVENT_ADDLOCALIZED="add:localized"}static{this.EVENT_REMOVELOCALIZED="remove:localized"}constructor(t,e,s,n={},i={}){super(),this._file=null,this._i18n={},this._preload=!1,this._resources=[],this.id=Mm--,this.loaded=!1,this.loading=!1,this.options={},this.registry=null,this.tags=new $e(this),this.urlObject=null,this._name=t||"",this.type=e,this._data=n||{},this.options=i||{},s&&(this.file=s)}set name(t){if(this._name===t)return;const e=this._name;this._name=t,this.fire("name",this,this._name,e)}get name(){return this._name}set file(t){if(t&&t.variants&&-1!==["texture","textureatlas","bundle"].indexOf(this.type)){const e=this.registry?._loader?._app||_m(),s=e?.graphicsDevice;if(s)for(let n=0,i=Om.length;n<i;n++){const i=Om[n];if(t.variants[i]&&s[km[i]]){t=t.variants[i];break}if(e.enableBundles){const t=e.bundles.listBundlesForAsset(this);if(t&&t.find(t=>t?.file?.variants[i]))break}}}const e=this._file,s=t?new Rm(t.url,t.filename,t.hash,t.size,t.opt,t.contents):null;(!!s!=!!e||s&&!s.equals(e))&&(this._file=s,this.fire("change",this,"file",s,e),this.reload())}get file(){return this._file}set data(t){const e=this._data;this._data=t,t!==e&&(this.fire("change",this,"data",t,e),this.loaded&&this.registry._loader.patch(this,this.registry))}get data(){return this._data}set resource(t){const e=this._resources[0];this._resources[0]=t,this.fire("change",this,"resource",t,e)}get resource(){return this._resources[0]}set resources(t){const e=this._resources;this._resources=t,this.fire("change",this,"resources",t,e)}get resources(){return this._resources}set preload(t){t=!!t,this._preload!==t&&(this._preload=t,this._preload&&!this.loaded&&!this.loading&&this.registry&&this.registry.load(this))}get preload(){return this._preload}set loadFaces(t){t=!!t,this.hasOwnProperty("_loadFaces")&&t===this._loadFaces||(this._loadFaces=t,this.loaded&&this.registry._loader.patch(this,this.registry))}get loadFaces(){return this._loadFaces}getFileUrl(){const t=this.file;if(!t||!t.url)return null;let e=t.url;if(this.registry&&this.registry.prefix&&!Im.test(e)&&(e=this.registry.prefix+e),"script"!==this.type&&t.hash){const s=-1!==e.indexOf("?")?"&":"?";e+=`${s}t=${t.hash}`}return e}getAbsoluteUrl(t){if(t.startsWith("blob:")||t.startsWith("data:"))return t;const e=Me.getDirectory(this.file.url);return Me.join(e,t)}getLocalizedAssetId(t){return t=Dm(t,this._i18n),this._i18n[t]||null}addLocalizedAssetId(t,e){this._i18n[t]=e,this.fire("add:localized",t,e)}removeLocalizedAssetId(t){const e=this._i18n[t];e&&(delete this._i18n[t],this.fire("remove:localized",t,e))}ready(t,e){e=e||this,this.loaded?t.call(e,this):this.once("load",s=>{t.call(e,s)})}reload(){this.loaded&&(this.loaded=!1,this.registry.load(this))}unload(){if(!this.loaded&&0===this._resources.length)return;this.fire("unload",this),this.registry.fire(`unload:${this.id}`,this);const t=this._resources;this.urlObject&&(URL.revokeObjectURL(this.urlObject),this.urlObject=null),this.resources=[],this.loaded=!1,this.file&&this.registry._loader.clearCache(this.getFileUrl(),this.type);for(let e=0;e<t.length;++e)t[e]?.destroy?.()}static fetchArrayBuffer(t,e,s,n=0){s?.file?.contents?setTimeout(()=>{e(null,s.file.contents)}):hl.get(t,{cache:!0,responseType:"arraybuffer",retry:n>0,maxRetries:n,progress:s},e)}}class Nm{constructor(t=null){this._index={},this._key=t}addItem(t){const e=t.tags._list;for(const s of e)this.add(s,t)}removeItem(t){const e=t.tags._list;for(const s of e)this.remove(s,t)}add(t,e){this._index[t]&&-1!==this._index[t].list.indexOf(e)||(this._index[t]||(this._index[t]={list:[]},this._key&&(this._index[t].keys={})),this._index[t].list.push(e),this._key&&(this._index[t].keys[e[this._key]]=e))}remove(t,e){if(!this._index[t])return;if(this._key&&!this._index[t].keys[e[this._key]])return;const s=this._index[t].list.indexOf(e);-1!==s&&(this._index[t].list.splice(s,1),this._key&&delete this._index[t].keys[e[this._key]],0===this._index[t].list.length&&delete this._index[t])}find(t){const e={},s=[];let n,i,r,a,o;const l=(t,e)=>this._index[t].list.length-this._index[e].list.length;for(let h=0;h<t.length;h++){if(i=t[h],i instanceof Array){if(0===i.length)continue;if(1!==i.length){o=!1;for(let t=0;t<i.length;t++)if(!this._index[i[t]]){o=!0;break}if(o)continue;r=i.slice(0).sort(l),a=r.slice(1),1===a.length&&(a=a[0]);for(let t=0;t<this._index[r[0]].list.length;t++)n=this._index[r[0]].list[t],(this._key?!e[n[this._key]]:-1===s.indexOf(n))&&n.tags.has(a)&&(this._key&&(e[n[this._key]]=!0),s.push(n));continue}i=i[0]}if(i&&"string"==typeof i&&this._index[i])for(let t=0;t<this._index[i].list.length;t++)n=this._index[i].list[t],this._key?e[n[this._key]]||(e[n[this._key]]=!0,s.push(n)):-1===s.indexOf(n)&&s.push(n)}return s}}class Bm extends Ve{static{this.EVENT_LOAD="load"}static{this.EVENT_ADD="add"}static{this.EVENT_REMOVE="remove"}static{this.EVENT_ERROR="error"}constructor(t){super(),this._assets=new Set,this._idToAsset=new Map,this._urlToAsset=new Map,this._nameToAsset=new Map,this._tags=new Nm("id"),this.prefix=null,this.bundles=null,this._loader=t}get loader(){return this._loader}list(t={}){const e=Array.from(this._assets);return void 0!==t.preload?e.filter(e=>e.preload===t.preload):e}add(t){this._assets.has(t)||(this._assets.add(t),this._idToAsset.set(t.id,t),t.file?.url&&this._urlToAsset.set(t.file.url,t),this._nameToAsset.has(t.name)||this._nameToAsset.set(t.name,new Set),this._nameToAsset.get(t.name).add(t),t.on("name",this._onNameChange,this),t.registry=this,this._tags.addItem(t),t.tags.on("add",this._onTagAdd,this),t.tags.on("remove",this._onTagRemove,this),this.fire("add",t),this.fire(`add:${t.id}`,t),t.file?.url&&this.fire(`add:url:${t.file.url}`,t),t.preload&&this.load(t))}remove(t){if(!this._assets.has(t))return!1;if(this._assets.delete(t),this._idToAsset.delete(t.id),t.file?.url&&this._urlToAsset.delete(t.file.url),t.off("name",this._onNameChange,this),this._nameToAsset.has(t.name)){const e=this._nameToAsset.get(t.name);e.delete(t),0===e.size&&this._nameToAsset.delete(t.name)}return this._tags.removeItem(t),t.tags.off("add",this._onTagAdd,this),t.tags.off("remove",this._onTagRemove,this),t.fire("remove",t),this.fire("remove",t),this.fire(`remove:${t.id}`,t),t.file?.url&&this.fire(`remove:url:${t.file.url}`,t),!0}get(t){return this._idToAsset.get(Number(t))}getByUrl(t){return this._urlToAsset.get(t)}load(t,e){if((t.loading||t.loaded)&&!e?.force)return;const s=t.file,n=()=>{this.fire("load",t),this.fire(`load:${t.id}`,t),s&&s.url&&this.fire(`load:url:${s.url}`,t),t.fire("load",t)},i=e=>{if(e instanceof Array?t.resources=e:t.resource=e,this._loader.patch(t,this),"bundle"===t.type){const e=t.data.assets;for(let t=0;t<e.length;t++){const s=this._idToAsset.get(e[t]);s&&!s.loaded&&this.load(s,{force:!0})}t.resource.loaded?n():(this.fire("load:start",t),this.fire(`load:start:${t.id}`,t),s&&s.url&&this.fire(`load:start:url:${s.url}`,t),t.fire("load:start",t),t.resource.on("load",n))}else n()},r=(e,s,n)=>{if(t.loaded=!0,t.loading=!1,e)this.fire("error",e,t),this.fire(`error:${t.id}`,e,t),t.fire("error",e,t);else{if("script"===t.type){const e=this._loader.getHandler("script");e._cache[t.id]&&e._cache[t.id].parentNode===document.head&&document.head.removeChild(e._cache[t.id]),n&&(e._cache[t.id]=n)}i(s)}};if(s||"cubemap"===t.type){this.fire("load:start",t),this.fire(`load:${t.id}:start`,t),t.loading=!0;const s=t.getFileUrl();if("bundle"===t.type){const e=t.data.assets;for(let t=0;t<e.length;t++){const s=this._idToAsset.get(e[t]);s&&(s.loaded||s.resource||s.loading||(s.loading=!0))}}this._loader.load(s,t.type,r,t,e)}else{const e=this._loader.open(t.type,t.data);t.loaded=!0,i(e)}}loadFromUrl(t,e,s){this.loadFromUrlAndFilename(t,null,e,s)}loadFromUrlAndFilename(t,e,s,n){const i=Me.getBasename(e||t),r={filename:e||i,url:t};let a=this.getByUrl(t);if(a){if(a.loaded)return void n(a.loadFromUrlError||null,a)}else a=new Fm(i,s,r),this.add(a);const o=t=>{t.once("load",t=>{"material"===s?this._loadTextures(t,(e,s)=>{n(e,t)}):n(null,t)}),t.once("error",e=>{e&&(this.loadFromUrlError=e),n(e,t)}),this.load(t)};a.resource?n(null,a):"model"===s?this._loadModel(a,o):o(a)}_loadModel(t,e){const s=t.getFileUrl(),n=Me.getExtension(s);if(".json"===n||".glb"===n){const i=Me.getDirectory(s),r=Me.getBasename(s),a=Me.join(i,r.replace(n,".mapping.json"));this._loader.load(a,"json",(s,n)=>{s?(t.data={mapping:[]},e(t)):this._loadMaterials(t,n,(s,i)=>{t.data=n,e(t)})})}else e(t)}_loadMaterials(t,e,s){const n=[];let i=0;const r=(t,e)=>{this._loadTextures(e,(t,r)=>{n.push(e),n.length===i&&s(null,n)})};for(let s=0;s<e.mapping.length;s++){const n=e.mapping[s].path;if(n){i++;const e=t.getAbsoluteUrl(n);this.loadFromUrl(e,"material",r)}}0===i&&s(null,n)}_loadTextures(t,e){const s=[];let n=0;const i=t.data;if("path"!==i.mappingFormat)return void e(null,s);const r=(t,i)=>{t&&console.error(t),s.push(i),s.length===n&&e(null,s)},a=np;for(let e=0;e<a.length;e++){const s=i[a[e]];if(s&&"string"==typeof s){n++;const e=t.getAbsoluteUrl(s);this.loadFromUrl(e,"texture",r)}}0===n&&e(null,s)}_onTagAdd(t,e){this._tags.add(t,e)}_onTagRemove(t,e){this._tags.remove(t,e)}_onNameChange(t,e,s){if(this._nameToAsset.has(s)){const e=this._nameToAsset.get(s);e.delete(t),0===e.size&&this._nameToAsset.delete(s)}this._nameToAsset.has(t.name)||this._nameToAsset.set(t.name,new Set),this._nameToAsset.get(t.name).add(t)}findByTag(...t){return this._tags.find(t)}filter(t){return Array.from(this._assets).filter(e=>t(e))}find(t,e){const s=this._nameToAsset.get(t);if(!s)return null;for(const t of s)if(!e||t.type===e)return t;return null}findAll(t,e){const s=this._nameToAsset.get(t);if(!s)return[];const n=Array.from(s);return e?n.filter(t=>t.type===e):n}log(){}}class zm{constructor(t){this._idToBundle=new Map,this._assetToBundles=new Map,this._urlsToBundles=new Map,this._fileRequests=new Map,this._assets=t,this._assets.bundles=this,this._assets.on("add",this._onAssetAdd,this),this._assets.on("remove",this._onAssetRemove,this)}_onAssetAdd(t){if("bundle"===t.type){this._idToBundle.set(t.id,t),this._assets.on(`load:start:${t.id}`,this._onBundleLoadStart,this),this._assets.on(`load:${t.id}`,this._onBundleLoad,this),this._assets.on(`error:${t.id}`,this._onBundleError,this);const e=t.data.assets;for(let s=0;s<e.length;s++)this._indexAssetInBundle(e[s],t)}else this._assetToBundles.has(t.id)&&this._indexAssetFileUrls(t)}_unbindAssetEvents(t){this._assets.off(`load:start:${t}`,this._onBundleLoadStart,this),this._assets.off(`load:${t}`,this._onBundleLoad,this),this._assets.off(`error:${t}`,this._onBundleError,this)}_indexAssetInBundle(t,e){let s=this._assetToBundles.get(t);s||(s=new Set,this._assetToBundles.set(t,s)),s.add(e);const n=this._assets.get(t);n&&this._indexAssetFileUrls(n)}_indexAssetFileUrls(t){const e=this._getAssetFileUrls(t);if(e)for(let s=0;s<e.length;s++){const n=this._assetToBundles.get(t.id);n&&this._urlsToBundles.set(e[s],n)}}_getAssetFileUrls(t){let e=t.getFileUrl();if(!e)return null;e=e.split("?")[0];const s=[e];if("font"===t.type){const n=t.data.info.maps.length;for(let t=1;t<n;t++)s.push(e.replace(".png",`${t}.png`))}return s}_onAssetRemove(t){if("bundle"===t.type){this._idToBundle.delete(t.id),this._unbindAssetEvents(t.id);const e=t.data.assets;for(let s=0;s<e.length;s++){const n=this._assetToBundles.get(e[s]);if(n&&(n.delete(t),0===n.size)){this._assetToBundles.delete(e[s]);for(const[t,e]of this._urlsToBundles)e===n&&this._urlsToBundles.delete(t)}}this._onBundleError(`Bundle ${t.id} was removed`)}else{if(!this._assetToBundles.get(t.id))return;this._assetToBundles.delete(t.id);const e=this._getAssetFileUrls(t);if(!e)return;for(let t=0;t<e.length;t++)this._urlsToBundles.delete(e[t])}}_onBundleLoadStart(t){t.resource.on("add",(t,e)=>{const s=this._fileRequests.get(t);if(s){for(let t=0;t<s.length;t++)s[t](null,e);this._fileRequests.delete(t)}})}_onBundleLoad(t){if(t.resource){if(this._fileRequests)for(const[e,s]of this._fileRequests){const n=this._urlsToBundles.get(e);if(!n||!n.has(t))continue;const i=decodeURIComponent(e);let r,a;if(t.resource.has(i))a=t.resource.get(i);else{if(!t.resource.loaded)continue;r=`Bundle ${t.id} does not contain URL ${e}`}for(let t=0;t<s.length;t++)s[t](r,r||a);this._fileRequests.delete(e)}}else this._onBundleError(`Bundle ${t.id} failed to load`)}_onBundleError(t){for(const[e,s]of this._fileRequests){if(!this._findLoadedOrLoadingBundleForUrl(e)){for(let e=0;e<s.length;e++)s[e](t);this._fileRequests.delete(e)}}}_findLoadedOrLoadingBundleForUrl(t){const e=this._urlsToBundles.get(t);if(!e)return null;let s=null;for(const t of e){if(t.loaded&&t.resource)return t;t.loading&&(s=t)}return s}listBundlesForAsset(t){const e=this._assetToBundles.get(t.id);return e?Array.from(e):null}list(){return Array.from(this._idToBundle.values())}hasUrl(t){return this._urlsToBundles.has(t)}urlIsLoadedOrLoading(t){return!!this._findLoadedOrLoadingBundleForUrl(t)}loadUrl(t,e){const s=this._findLoadedOrLoadingBundleForUrl(t);if(!s)return void e(`URL ${t} not found in any bundles`);if(s.loaded){const n=decodeURIComponent(t);if(s.resource.has(n))return void e(null,s.resource.get(n));if(s.resource.loaded)return void e(`Bundle ${s.id} does not contain URL ${t}`)}let n=this._fileRequests.get(t);n||(n=[],this._fileRequests.set(t,n)),n.push(e)}destroy(){this._assets.off("add",this._onAssetAdd,this),this._assets.off("remove",this._onAssetRemove,this);for(const t of this._idToBundle.keys())this._unbindAssetEvents(t);this._assets=null,this._idToBundle.clear(),this._idToBundle=null,this._assetToBundles.clear(),this._assetToBundles=null,this._urlsToBundles.clear(),this._urlsToBundles=null,this._fileRequests.clear(),this._fileRequests=null}}class Um extends Ve{constructor(){super(),this.list=[]}add(t){const e=t.id;if(this[e])throw new Error(`ComponentSystem name '${e}' already registered or not allowed`);this[e]=t,this.list.push(t)}remove(t){const e=t.id;if(!this[e])throw new Error(`No ComponentSystem named '${e}' registered`);delete this[e];const s=this.list.indexOf(this[e]);-1!==s&&this.list.splice(s,1)}destroy(){this.off();for(let t=0;t<this.list.length;t++)this.list[t].destroy()}}class Vm extends Ve{static{this.EVENT_ADD="add"}static{this.EVENT_LOAD="load"}addFile(t,e){this._index.has(t)||(this._index.set(t,e),this.fire("add",t,e))}has(t){return this._index.has(t)}get(t){return this._index.get(t)||null}destroy(){this._index.clear()}set loaded(t){t&&!this._loaded&&(this._loaded=!0,this.fire("load"))}get loaded(){return this._loaded}constructor(...t){super(...t),this._index=new Map,this._loaded=!1}}class Hm extends Ve{constructor(t,e=""){super(),this.headerSize=512,this.paddingSize=512,this.bytesRead=0,this.bytesReceived=0,this.headerRead=!1,this.reader=null,this.data=new Uint8Array(0),this.decoder=null,this.prefix="",this.fileName="",this.fileSize=0,this.fileType="",this.ustarFormat="",this.prefix=e||"",this.reader=t.body.getReader(),this.reader.read().then(t=>{this.pump(t.done,t.value)}).catch(t=>{this.fire("error",t)})}pump(t,e){if(t)return this.fire("done"),null;this.bytesReceived+=e.byteLength;const s=new Uint8Array(this.data.length+e.length);for(s.set(this.data),s.set(e,this.data.length),this.data=s;this.readFile(););return this.reader.read().then(t=>{this.pump(t.done,t.value)}).catch(t=>{this.fire("error",t)})}readFile(){if(!this.headerRead&&this.bytesReceived>this.bytesRead+this.headerSize){this.headerRead=!0;const t=new DataView(this.data.buffer,this.bytesRead,this.headerSize);this.decoder??=new TextDecoder("windows-1252");const e=this.decoder.decode(t);if(this.fileName=e.substring(0,100).replace(/\0/g,""),this.fileSize=parseInt(e.substring(124,136),8),this.fileType=e.substring(156,157),this.ustarFormat=e.substring(257,263),-1!==this.ustarFormat.indexOf("ustar")){const t=e.substring(345,500).replace(/\0/g,"");t.length>0&&(this.fileName=t.trim()+this.fileName.trim())}this.bytesRead+=512}if(this.headerRead){if(this.bytesReceived<this.bytesRead+this.fileSize)return!1;if(""===this.fileType||"0"===this.fileType){const t=new DataView(this.data.buffer,this.bytesRead,this.fileSize),e={name:this.prefix+this.fileName,size:this.fileSize,data:t};this.fire("file",e)}this.bytesRead+=this.fileSize,this.headerRead=!1;const t=this.bytesRead%this.paddingSize;return 0!==t&&(this.bytesRead+=this.paddingSize-t),!0}return!1}}class Gm{constructor(t,e){this.handlerType="",this._maxRetries=0,this._app=t,this.handlerType=e}set maxRetries(t){this._maxRetries=t}get maxRetries(){return this._maxRetries}load(t,e,s){}open(t,e,s){return e}patch(t,e){}}class Wm extends Gm{constructor(t){super(t,"bundle"),this._assets=t.assets}_fetchRetries(t,e,s=0){return new Promise((n,i)=>{const r=()=>{fetch(t,e).then(n).catch(t=>{++s<this.maxRetries?r():i(t)})};r()})}load(t,e){"string"==typeof t&&(t={load:t,original:t}),this._fetchRetries(t.load,{mode:"cors"},this.maxRetries).then(t=>{const s=new Vm;e(null,s);const n=new Hm(t,this._assets.prefix);n.on("file",t=>{s.addFile(t.name,t.data)}),n.on("done",()=>{s.loaded=!0}),n.on("error",t=>{e(t)})}).catch(t=>{e(t)})}open(t,e){return e}}class jm{constructor(t){this._handlers={},this._requests={},this._cache={},this._app=t}addHandler(t,e){this._handlers[t]=e,e._loader=this}removeHandler(t){delete this._handlers[t]}getHandler(t){return this._handlers[t]}static makeKey(t,e){return`${t}-${e}`}load(t,e,s,n,i){const r=this._handlers[e];if(!r){return void s(`No resource handler for asset type: '${e}' when loading [${t}]`)}if(!t)return void this._loadNull(r,s,n);const a=jm.makeKey(t,e);if(void 0!==this._cache[a])s(null,this._cache[a]);else if(this._requests[a])this._requests[a].push(s);else{this._requests[a]=[s];const e=this,o=function(t,s){if(t)e._onFailure(a,t);else{if(s.load instanceof DataView){if(r.openBinary){if(!e._requests[a])return;try{const t=r.openBinary(s.load);e._onSuccess(a,t)}catch(t){e._onFailure(a,t)}return}s.load=URL.createObjectURL(new Blob([s.load])),n&&(n.urlObject&&URL.revokeObjectURL(n.urlObject),n.urlObject=s.load)}r.load(s,(t,i,o)=>{if(e._requests[a])if(t)e._onFailure(a,t);else try{e._onSuccess(a,r.open(s.original,i,n),o)}catch(t){e._onFailure(a,t)}},n)}},l=t.split("?")[0];if(!this._app.enableBundles||!this._app.bundles.hasUrl(l)||i&&i.bundlesIgnore)o(null,{load:t,original:n&&n.file.filename||t});else{if(!this._app.bundles.urlIsLoadedOrLoading(l)){const t=this._app.bundles.listBundlesForAsset(n);let e;i&&i.bundlesFilter&&(e=i.bundlesFilter(t)),e||(t?.sort((t,e)=>t.file.size-e.file.size),e=t?.[0]),e&&this._app.assets?.load(e)}this._app.bundles.loadUrl(l,(t,e)=>{o(t,{load:e,original:l})})}}}_loadNull(t,e,s){t.load(null,function(n,i,r){if(n)e(n);else try{e(null,t.open(null,i,s),r)}catch(t){e(t)}},s)}_onSuccess(t,e,s){null!==e?this._cache[t]=e:delete this._cache[t];for(let n=0;n<this._requests[t].length;n++)this._requests[t][n](null,e,s);delete this._requests[t]}_onFailure(t,e){if(console.error(e),this._requests[t]){for(let s=0;s<this._requests[t].length;s++)this._requests[t][s](e);delete this._requests[t]}}open(t,e){const s=this._handlers[t];return s?s.open(null,e):(console.warn(`No resource handler found for: ${t}`),e)}patch(t,e){const s=this._handlers[t.type];s?s.patch&&s.patch(t,e):console.warn(`No resource handler found for: ${t.type}`)}clearCache(t,e){const s=jm.makeKey(t,e);delete this._cache[s]}getFromCache(t,e){const s=jm.makeKey(t,e);if(this._cache[s])return this._cache[s]}enableRetry(t=5){t=Math.max(0,t)||0;for(const e in this._handlers)this._handlers[e].maxRetries=t}disableRetry(){for(const t in this._handlers)this._handlers[t].maxRetries=0}destroy(){this._handlers={},this._requests={},this._cache={}}}class $m{_validate(t){if(!t.header)throw new Error('pc.I18n#addData: Missing "header" field');if(!t.header.version)throw new Error('pc.I18n#addData: Missing "header.version" field');if(1!==t.header.version)throw new Error('pc.I18n#addData: Invalid "header.version" field');if(!t.data)throw new Error('pc.I18n#addData: Missing "data" field');if(!Array.isArray(t.data))throw new Error('pc.I18n#addData: "data" field must be an array');for(let e=0,s=t.data.length;e<s;e++){const s=t.data[e];if(!s.info)throw new Error(`pc.I18n#addData: missing "data[${e}].info" field`);if(!s.info.locale)throw new Error(`pc.I18n#addData: missing "data[${e}].info.locale" field`);if("string"!=typeof s.info.locale)throw new Error(`pc.I18n#addData: "data[${e}].info.locale" must be a string`);if(!s.messages)throw new Error(`pc.I18n#addData: missing "data[${e}].messages" field`)}}parse(t){return t.data}}class Xm extends Ve{static{this.EVENT_CHANGE="change"}constructor(t){super(),this.locale=wm,this._translations={},this._availableLangs={},this._app=t,this._assets=[],this._parser=new $m}set assets(t){const e={};for(let s=0,n=t.length;s<n;s++){e[t[s]instanceof Fm?t[s].id:t[s]]=!0}let s=this._assets.length;for(;s--;){const t=this._assets[s];if(!e[t]){this._app.assets.off(`add:${t}`,this._onAssetAdd,this);const e=this._app.assets.get(t);e&&this._onAssetRemove(e),this._assets.splice(s,1)}}for(const t in e){const e=parseInt(t,10);if(-1!==this._assets.indexOf(e))continue;this._assets.push(e);const s=this._app.assets.get(e);s?this._onAssetAdd(s):this._app.assets.once(`add:${e}`,this._onAssetAdd,this)}}get assets(){return this._assets}set locale(t){if(this._locale===t)return;let e=Am(t);if("in"===e&&(e="id",t=function(t,e){const s=t.indexOf("-");return-1!==s?e+t.substring(s):e}(t,e),this._locale===t))return;const s=this._locale;this._locale=t,this._lang=e,this._pluralFn=Lm(this._lang),this.fire(Xm.EVENT_CHANGE,t,s)}get locale(){return this._locale}static findAvailableLocale(t,e){return Dm(t,e)}findAvailableLocale(t){if(this._translations[t])return t;const e=Am(t);return this._findFallbackLocale(t,e)}getText(t,e){let s,n=t;e||(e=this._locale,s=this._lang);let i=this._translations[e];return i||(s||(s=Am(e)),e=this._findFallbackLocale(e,s),i=this._translations[e]),i&&i.hasOwnProperty(t)&&(n=i[t],Array.isArray(n)&&(n=n[0]),null==n&&(n=t)),n}getPluralText(t,e,s){let n,i,r=t;s?(n=Am(s),i=Lm(n)):(s=this._locale,n=this._lang,i=this._pluralFn);let a=this._translations[s];if(a||(n=Am(s=this._findFallbackLocale(s,n)),i=Lm(n),a=this._translations[s]),a&&a[t]&&i){const s=i(e);r=a[t][s],null==r&&(r=t)}return r}addData(t){let e;try{e=this._parser.parse(t)}catch(t){return void console.error(t)}for(let t=0,s=e.length;t<s;t++){const s=e[t],n=s.info.locale,i=s.messages;if(!this._translations[n]){this._translations[n]={};const t=Am(n);this._availableLangs[t]||(this._availableLangs[t]=n)}Object.assign(this._translations[n],i),this.fire("data:add",n,i)}}removeData(t){let e;try{e=this._parser.parse(t)}catch(t){return void console.error(t)}for(let t=0,s=e.length;t<s;t++){const s=e[t],n=s.info.locale,i=this._translations[n];if(!i)continue;const r=s.messages;for(const t in r)delete i[t];0===Object.keys(i).length&&(delete this._translations[n],delete this._availableLangs[Am(n)]),this.fire("data:remove",n,r)}}destroy(){this._translations=null,this._availableLangs=null,this._assets=null,this._parser=null,this.off()}_findFallbackLocale(t,e){let s=Tm[t];return s&&this._translations[s]?s:(s=Tm[e],s&&this._translations[s]?s:(s=this._availableLangs[e],s&&this._translations[s]?s:wm))}_onAssetAdd(t){t.on("load",this._onAssetLoad,this),t.on("change",this._onAssetChange,this),t.on("remove",this._onAssetRemove,this),t.on("unload",this._onAssetUnload,this),t.resource&&this._onAssetLoad(t)}_onAssetLoad(t){this.addData(t.resource)}_onAssetChange(t){t.resource&&this.addData(t.resource)}_onAssetRemove(t){t.off("load",this._onAssetLoad,this),t.off("change",this._onAssetChange,this),t.off("remove",this._onAssetRemove,this),t.off("unload",this._onAssetUnload,this),t.resource&&this.removeData(t.resource),this._app.assets.once(`add:${t.id}`,this._onAssetAdd,this)}_onAssetUnload(t){t.resource&&this.removeData(t.resource)}}class qm extends Ve{constructor(t){super(),this._scripts={},this._list=[],this._scriptSchemas=new Map,this.app=t}destroy(){this.app=null,this.off()}addSchema(t,e){e&&this._scriptSchemas.set(t,e)}getSchema(t){return this._scriptSchemas.get(t)}add(t){const e=t.__name;return this._scripts.hasOwnProperty(e)?(setTimeout(()=>{if(t.prototype.swap){const s=this._scripts[e],n=this._list.indexOf(s);this._list[n]=t,this._scripts[e]=t,this.fire("swap",e,t),this.fire(`swap:${e}`,t)}else console.warn(`script registry already has '${e}' script, define 'swap' method for new script type to enable code hot swapping`)}),!1):(this._scripts[e]=t,this._list.push(t),this.fire("add",e,t),this.fire(`add:${e}`,t),setTimeout(()=>{if(!this._scripts.hasOwnProperty(e))return;if(!this.app||!this.app.systems||!this.app.systems.script)return;const t=this.app.systems.script._components;let s;const n=[],i=[];for(t.loopIndex=0;t.loopIndex<t.length;t.loopIndex++){const i=t.items[t.loopIndex];if(i._scriptsIndex[e]&&i._scriptsIndex[e].awaiting){i._scriptsData&&i._scriptsData[e]&&(s=i._scriptsData[e].attributes);const t=i.create(e,{preloading:!0,ind:i._scriptsIndex[e].ind,attributes:s});t&&n.push(t);for(const t of i.scripts)i.initializeAttributes(t)}}for(let t=0;t<n.length;t++)n[t].enabled&&(n[t]._initialized=!0,i.push(n[t]),n[t].initialize&&n[t].initialize());for(let t=0;t<i.length;t++)i[t].enabled&&!i[t]._postInitialized&&(i[t]._postInitialized=!0,i[t].postInitialize&&i[t].postInitialize())}),!0)}remove(t){let e=t,s=t;if("string"!=typeof s?s=e.__name:e=this.get(s),this.get(s)!==e)return!1;delete this._scripts[s];const n=this._list.indexOf(e);return this._list.splice(n,1),this.fire("remove",s,e),this.fire(`remove:${s}`,e),!0}get(t){return this._scripts[t]||null}has(t){if("string"==typeof t)return this._scripts.hasOwnProperty(t);if(!t)return!1;const e=t.__name;return this._scripts[e]===t}list(){return this._list}}const Km=(t,e)=>t.constructor.order-e.constructor.order,Ym=[],Qm=[],Zm=t=>{t.length=0,Qm.push(t)};class Jm extends Hc{static{this.EVENT_DESTROY="destroy"}constructor(t,e=_m()){super(t),this.c={},this._destroying=!1,this._guid=null,this._template=!1,this._app=e}addComponent(t,e){const s=this._app.systems[t];return s?this.c[t]?null:s.addComponent(this,e):null}removeComponent(t){const e=this._app.systems[t];e&&this.c[t]&&e.removeComponent(this)}findComponent(t){const e=this.findOne(e=>e.c?.[t]);return e&&e.c[t]}findComponents(t){return this.find(e=>e.c?.[t]).map(e=>e.c[t])}findScript(t){const e=this.findOne(e=>e.c?.script?.has(t));return e?.c.script.get(t)}findScripts(t){return this.find(e=>e.c?.script?.has(t)).map(e=>e.c.script.get(t))}getGuid(){return this._guid||this.setGuid(Re.create()),this._guid}setGuid(t){const e=this._app._entityIndex;this._guid&&delete e[this._guid],this._guid=t,e[this._guid]=this}_notifyHierarchyStateChanged(t,e){let s=!1;t===this&&0===Ym.length&&(s=!0),t._beingEnabled=!0,t._onHierarchyStateChanged(e),t._onHierarchyStatePostChanged&&Ym.push(t);const n=t._children;for(let t=0,s=n.length;t<s;t++)n[t]._enabled&&this._notifyHierarchyStateChanged(n[t],e);if(t._beingEnabled=!1,s){for(let t=0;t<Ym.length;t++)Ym[t]._onHierarchyStatePostChanged();Ym.length=0}}_onHierarchyStateChanged(t){super._onHierarchyStateChanged(t);const e=this._getSortedComponents();for(let s=0;s<e.length;s++){const n=e[s];n.enabled&&(t?n.onEnable():n.onDisable())}Zm(e)}_onHierarchyStatePostChanged(){const t=this._getSortedComponents();for(let e=0;e<t.length;e++)t[e].onPostStateChange();Zm(t)}findByGuid(t){if(this._guid===t)return this;const e=this._app._entityIndex[t];return e&&(e===this||e.isDescendantOf(this))?e:null}destroy(){this._destroying=!0;for(const t in this.c)this.c[t].enabled=!1;for(const t in this.c)this.c[t].system.removeComponent(this);super.destroy(),this._guid&&delete this._app._entityIndex[this._guid],this._destroying=!1}clone(){const t={},e=this._cloneRecursively(t);return t[this.getGuid()]=e,tg(this,this,e,t),e}_getSortedComponents(){const t=this.c,e=Qm.pop()??[];let s=0;for(const n in t)if(t.hasOwnProperty(n)){const i=t[n];s|=0!==i.constructor.order,e.push(i)}return s&&e.length>1&&e.sort(Km),e}_cloneRecursively(t){const e=new this.constructor(void 0,this._app);super._cloneInternal(e);for(const t in this.c){this.c[t].system.cloneComponent(this,e)}for(let s=0;s<this._children.length;s++){const n=this._children[s];if(n instanceof Jm){const s=n._cloneRecursively(t);e.addChild(s),t[n.getGuid()]=s}}return e}}function tg(t,e,s,n){if(e instanceof Jm){const i=e.c;for(const e in i){const r=i[e],a=r.system.getPropertiesOfType("entity");for(let i=0,o=a.length;i<o;i++){const o=a[i].name,l=r[o];if(!!t.findByGuid(l)){const t=n[l].getGuid();t&&(s.c[e][o]=t)}}}i.script&&s.script.resolveDuplicatedEntityReferenceProperties(i.script,n),i.render&&s.render.resolveDuplicatedEntityReferenceProperties(i.render,n),i.button&&s.button.resolveDuplicatedEntityReferenceProperties(i.button,n),i.scrollview&&s.scrollview.resolveDuplicatedEntityReferenceProperties(i.scrollview,n),i.scrollbar&&s.scrollbar.resolveDuplicatedEntityReferenceProperties(i.scrollbar,n),i.anim&&s.anim.resolveDuplicatedEntityReferenceProperties(i.anim,n);const r=e.children.filter(t=>t instanceof Jm),a=s.children.filter(t=>t instanceof Jm);for(let e=0,s=r.length;e<s;e++)tg(t,r[e],a[e],n)}}class eg{constructor(t,e){this.data=null,this._loading=!1,this._onLoadedCallbacks=[],this.name=t,this.url=e}get loaded(){return!!this.data}get loading(){return this._loading}}class sg{constructor(t){this._list=[],this._index={},this._urlIndex={},this._app=t}destroy(){this._app=null}list(){return this._list}add(t,e){if(this._index.hasOwnProperty(t))return!1;const s=new eg(t,e),n=this._list.push(s);return this._index[s.name]=n-1,this._urlIndex[s.url]=n-1,!0}find(t){return this._index.hasOwnProperty(t)?this._list[this._index[t]]:null}findByUrl(t){return this._urlIndex.hasOwnProperty(t)?this._list[this._urlIndex[t]]:null}remove(t){if(this._index.hasOwnProperty(t)){const e=this._index[t];let s=this._list[e];delete this._urlIndex[s.url],delete this._index[t],this._list.splice(e,1);for(let t=0;t<this._list.length;t++)s=this._list[t],this._index[s.name]=t,this._urlIndex[s.url]=t}}_loadSceneData(t,e,s){const n=this._app;let i=t;if("string"==typeof t&&(t=this.findByUrl(i)||this.find(i)||new eg("Untitled",i)),i=t.url,i)if(t.loaded)s(null,t);else{if(n.assets&&n.assets.prefix&&!Im.test(i)&&(i=Me.join(n.assets.prefix,i)),t._onLoadedCallbacks.push(s),!t._loading){n.loader.getHandler("hierarchy").load(i,(s,n)=>{t.data=n,t._loading=!1;for(let e=0;e<t._onLoadedCallbacks.length;e++)t._onLoadedCallbacks[e](s,t);e||(t.data=null),t._onLoadedCallbacks.length=0})}t._loading=!0}else s("Cannot find scene to load")}loadSceneData(t,e){this._loadSceneData(t,!0,e)}unloadSceneData(t){"string"==typeof t&&(t=this.findByUrl(t)),t&&(t.data=null)}_loadSceneHierarchy(t,e,s){this._loadSceneData(t,!1,(t,n)=>{if(t)return void(s&&s(t));e&&e(n);const i=this._app;i._preloadScripts(n.data,()=>{const t=i.loader.getHandler("hierarchy");i.systems.script.preloading=!0;const e=t.open(n.url,n.data);i.systems.script.preloading=!1,i.loader.clearCache(n.url,"hierarchy"),i.root.addChild(e),i.systems.fire("initialize",e),i.systems.fire("postInitialize",e),i.systems.fire("postPostInitialize",e),s&&s(null,e)})})}loadSceneHierarchy(t,e){this._loadSceneHierarchy(t,null,e)}loadSceneSettings(t,e){this._loadSceneData(t,!1,(t,s)=>{t?e&&e(t):(this._app.applySceneSettings(s.data.settings),e&&e(null))})}changeScene(t,e){const s=this._app;this._loadSceneHierarchy(t,t=>{const{children:e}=s.root;for(;e.length;)e[0].destroy();s.applySceneSettings(t.data.settings)},e)}loadScene(t,e){const s=this._app,n=s.loader.getHandler("scene");s.assets&&s.assets.prefix&&!Im.test(t)&&(t=Me.join(s.assets.prefix,t)),n.load(t,(i,r)=>{if(i)e&&e(i);else{const i=()=>{s.systems.script.preloading=!0;const i=n.open(t,r),a=this.findByUrl(t);a&&!a.loaded&&(a.data=r),s.systems.script.preloading=!1,s.loader.clearCache(t,"scene"),s.loader.patch({resource:i,type:"scene"},s.assets),s.root.addChild(i.root),s.systems.rigidbody&&"undefined"!=typeof Ammo&&s.systems.rigidbody.gravity.set(i._gravity.x,i._gravity.y,i._gravity.z),e&&e(null,i)};s._preloadScripts(r,i)}})}}class ng{constructor(t){this.frame={fps:0,ms:0,dt:0,updateStart:0,updateTime:0,renderStart:0,renderTime:0,physicsStart:0,physicsTime:0,cullTime:0,sortTime:0,skinTime:0,morphTime:0,instancingTime:0,triangles:0,gsplats:0,otherPrimitives:0,shaders:0,materials:0,cameras:0,shadowMapUpdates:0,shadowMapTime:0,depthMapTime:0,forwardTime:0,lightClustersTime:0,lightClusters:0,_timeToCountFrames:0,_fpsAccum:0},this.drawCalls={forward:0,depth:0,shadow:0,immediate:0,misc:0,total:0,skinned:0,instanced:0,removedByInstancing:0},this.misc={renderTargetCreationTime:0},this.particles={updatesPerFrame:0,_updatesPerFrame:0,frameTime:0,_frameTime:0},this.shaders=t._shaderStats,this.vram=t._vram,Object.defineProperty(this.vram,"totalUsed",{get:function(){return this.tex+this.vb+this.ib}}),Object.defineProperty(this.vram,"geom",{get:function(){return this.vb+this.ib}})}get scene(){return _m().scene._stats}get lightmapper(){return _m().lightmapper?.stats}get batcher(){const t=_m()._batcher;return t?t._stats:null}}const ig={alphaTestPS:"\nuniform float alpha_ref;\nvoid alphaTest(float a) {\n\tif (a < alpha_ref) discard;\n}\n",ambientPS:'\n#ifdef LIT_AMBIENT_SOURCE == AMBIENTSH\n\tuniform vec3 ambientSH[9];\n#endif\n#if LIT_AMBIENT_SOURCE == ENVALATLAS\n\t#include "envAtlasPS"\n\t#ifndef ENV_ATLAS\n\t#define ENV_ATLAS\n\t\tuniform sampler2D texture_envAtlas;\n\t#endif\n#endif\nvoid addAmbient(vec3 worldNormal) {\n\t#ifdef LIT_AMBIENT_SOURCE == AMBIENTSH\n\t\tvec3 n = cubeMapRotate(worldNormal);\n\t\tvec3 color =\n\t\t\tambientSH[0] +\n\t\t\tambientSH[1] * n.x +\n\t\t\tambientSH[2] * n.y +\n\t\t\tambientSH[3] * n.z +\n\t\t\tambientSH[4] * n.x * n.z +\n\t\t\tambientSH[5] * n.z * n.y +\n\t\t\tambientSH[6] * n.y * n.x +\n\t\t\tambientSH[7] * (3.0 * n.z * n.z - 1.0) +\n\t\t\tambientSH[8] * (n.x * n.x - n.y * n.y);\n\t\tdDiffuseLight += processEnvironment(max(color, vec3(0.0)));\n\t#endif\n\t#if LIT_AMBIENT_SOURCE == ENVALATLAS\n\t\tvec3 dir = normalize(cubeMapRotate(worldNormal) * vec3(-1.0, 1.0, 1.0));\n\t\tvec2 uv = mapUv(toSphericalUv(dir), vec4(128.0, 256.0 + 128.0, 64.0, 32.0) / atlasSize);\n\t\tvec4 raw = texture2D(texture_envAtlas, uv);\n\t\tvec3 linear = {ambientDecode}(raw);\n\t\tdDiffuseLight += processEnvironment(linear);\n\t#endif\n\t#if LIT_AMBIENT_SOURCE == CONSTANT\n\t\tdDiffuseLight += light_globalAmbient;\n\t#endif\n}\n',anisotropyPS:"\n#ifdef LIT_GGX_SPECULAR\n\tuniform float material_anisotropyIntensity;\n\tuniform vec2 material_anisotropyRotation;\n#endif\nvoid getAnisotropy() {\n\tdAnisotropy = 0.0;\n\tdAnisotropyRotation = vec2(1.0, 0.0);\n#ifdef LIT_GGX_SPECULAR\n\tdAnisotropy = material_anisotropyIntensity;\n\tdAnisotropyRotation = material_anisotropyRotation;\n#endif\n\t#ifdef STD_ANISOTROPY_TEXTURE\n\tvec3 anisotropyTex = texture2DBias({STD_ANISOTROPY_TEXTURE_NAME}, {STD_ANISOTROPY_TEXTURE_UV}, textureBias).rgb;\n\tdAnisotropy *= anisotropyTex.b;\n\tvec2 anisotropyRotationFromTex = anisotropyTex.rg * 2.0 - vec2(1.0);\n\tmat2 rotationMatrix = mat2(dAnisotropyRotation.x, dAnisotropyRotation.y, -dAnisotropyRotation.y, dAnisotropyRotation.x);\n\tdAnisotropyRotation = rotationMatrix * anisotropyRotationFromTex;\n\t#endif\n\t\n\tdAnisotropy = clamp(dAnisotropy, 0.0, 1.0);\n}\n",aoPS:'\n#if defined(STD_AO_TEXTURE) || defined(STD_AO_VERTEX)\n\tuniform float material_aoIntensity;\n#endif\n#ifdef STD_AODETAIL_TEXTURE\n\t#include "detailModesPS"\n#endif\nvoid getAO() {\n\tdAo = 1.0;\n\t#ifdef STD_AO_TEXTURE\n\t\tfloat aoBase = texture2DBias({STD_AO_TEXTURE_NAME}, {STD_AO_TEXTURE_UV}, textureBias).{STD_AO_TEXTURE_CHANNEL};\n\t\t#ifdef STD_AODETAIL_TEXTURE\n\t\t\tfloat aoDetail = texture2DBias({STD_AODETAIL_TEXTURE_NAME}, {STD_AODETAIL_TEXTURE_UV}, textureBias).{STD_AODETAIL_TEXTURE_CHANNEL};\n\t\t\taoBase = detailMode_{STD_AODETAIL_DETAILMODE}(vec3(aoBase), vec3(aoDetail)).r;\n\t\t#endif\n\t\tdAo *= aoBase;\n\t#endif\n\t#ifdef STD_AO_VERTEX\n\t\tdAo *= saturate(vVertexColor.{STD_AO_VERTEX_CHANNEL});\n\t#endif\n\t#if defined(STD_AO_TEXTURE) || defined(STD_AO_VERTEX)\n\t\tdAo = mix(1.0, dAo, material_aoIntensity);\n\t#endif\n}\n',aoDiffuseOccPS:"\nvoid occludeDiffuse(float ao) {\n\tdDiffuseLight *= ao;\n}\n",aoSpecOccPS:"\n#if LIT_OCCLUDE_SPECULAR != NONE\n\t#ifdef LIT_OCCLUDE_SPECULAR_FLOAT\n\t\tuniform float material_occludeSpecularIntensity;\n\t#endif\n#endif\nvoid occludeSpecular(float gloss, float ao, vec3 worldNormal, vec3 viewDir) {\n\t#if LIT_OCCLUDE_SPECULAR == AO\n\t\t#ifdef LIT_OCCLUDE_SPECULAR_FLOAT\n\t\t\tfloat specOcc = mix(1.0, ao, material_occludeSpecularIntensity);\n\t\t#else\n\t\t\tfloat specOcc = ao;\n\t\t#endif\n\t#endif\n\t#if LIT_OCCLUDE_SPECULAR == GLOSSDEPENDENT\n\t\tfloat specPow = exp2(gloss * 11.0);\n\t\tfloat specOcc = saturate(pow(dot(worldNormal, viewDir) + ao, 0.01 * specPow) - 1.0 + ao);\n\t\t#ifdef LIT_OCCLUDE_SPECULAR_FLOAT\n\t\t\tspecOcc = mix(1.0, specOcc, material_occludeSpecularIntensity);\n\t\t#endif\n\t#endif\n\t#if LIT_OCCLUDE_SPECULAR != NONE\n\t\tdSpecularLight *= specOcc;\n\t\tdReflection *= specOcc;\n\t\t#ifdef LIT_SHEEN\n\t\t\tsSpecularLight *= specOcc;\n\t\t\tsReflection *= specOcc;\n\t\t#endif\n\t#endif\n}\n",bakeDirLmEndPS:"\n\tvec4 dirLm = texture2D(texture_dirLightMap, vUv1);\n\tif (bakeDir > 0.5) {\n\t\tif (dAtten > 0.00001) {\n\t\t\tdirLm.xyz = dirLm.xyz * 2.0 - vec3(1.0);\n\t\t\tdAtten = saturate(dAtten);\n\t\t\tgl_FragColor.rgb = normalize(dLightDirNormW.xyz*dAtten + dirLm.xyz*dirLm.w) * 0.5 + vec3(0.5);\n\t\t\tgl_FragColor.a = dirLm.w + dAtten;\n\t\t\tgl_FragColor.a = max(gl_FragColor.a, 1.0 / 255.0);\n\t\t} else {\n\t\t\tgl_FragColor = dirLm;\n\t\t}\n\t} else {\n\t\tgl_FragColor.rgb = dirLm.xyz;\n\t\tgl_FragColor.a = max(dirLm.w, dAtten > 0.00001 ? (1.0/255.0) : 0.0);\n\t}\n",bakeLmEndPS:"\n#ifdef LIT_LIGHTMAP_BAKING_ADD_AMBIENT\n\tdDiffuseLight = ((dDiffuseLight - 0.5) * max(ambientBakeOcclusionContrast + 1.0, 0.0)) + 0.5;\n\tdDiffuseLight += vec3(ambientBakeOcclusionBrightness);\n\tdDiffuseLight = saturate(dDiffuseLight);\n\tdDiffuseLight *= dAmbientLight;\n#endif\n#ifdef LIGHTMAP_RGBM\n\tgl_FragColor.rgb = dDiffuseLight;\n\tgl_FragColor.rgb = pow(gl_FragColor.rgb, vec3(0.5));\n\tgl_FragColor.rgb /= 8.0;\n\tgl_FragColor.a = clamp( max( max( gl_FragColor.r, gl_FragColor.g ), max( gl_FragColor.b, 1.0 / 255.0 ) ), 0.0,1.0 );\n\tgl_FragColor.a = ceil(gl_FragColor.a * 255.0) / 255.0;\n\tgl_FragColor.rgb /= gl_FragColor.a;\n#else\n\tgl_FragColor = vec4(dDiffuseLight, 1.0);\n#endif\n",basePS:"\nuniform vec3 view_position;\nuniform vec3 light_globalAmbient;\nfloat square(float x) {\n\treturn x*x;\n}\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec3 saturate(vec3 x) {\n\treturn clamp(x, vec3(0.0), vec3(1.0));\n}\n",baseNineSlicedPS:"\n#define NINESLICED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\nvec2 nineSlicedUv;\n",baseNineSlicedTiledPS:"\n#define NINESLICED\n#define NINESLICETILED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\nvec2 nineSlicedUv;\n",bayerPS:"\nfloat bayer2(vec2 p) {\n\treturn mod(2.0 * p.y + p.x + 1.0, 4.0);\n}\nfloat bayer4(vec2 p) {\n\tvec2 p1 = mod(p, 2.0);\n\tvec2 p2 = floor(0.5 * mod(p, 4.0));\n\treturn 4.0 * bayer2(p1) + bayer2(p2);\n}\nfloat bayer8(vec2 p) {\n\tvec2 p1 = mod(p, 2.0);\n\tvec2 p2 = floor(0.5 * mod(p, 4.0));\n\tvec2 p4 = floor(0.25 * mod(p, 8.0));\n\treturn 4.0 * (4.0 * bayer2(p1) + bayer2(p2)) + bayer2(p4);\n}\n",blurVSMPS:"\nvarying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\n#ifdef GAUSS\n\tuniform float weight[{SAMPLES}];\n#endif\nvoid main(void) {\n\tvec3 moments = vec3(0.0);\n\tvec2 uv = vUv0 - pixelOffset * (float({SAMPLES}) * 0.5);\n\tfor (int i = 0; i < {SAMPLES}; i++) {\n\t\tvec4 c = texture2D(source, uv + pixelOffset * float(i));\n\t\t#ifdef GAUSS\n\t\t\tmoments += c.xyz * weight[i];\n\t\t#else\n\t\t\tmoments += c.xyz;\n\t\t#endif\n\t}\n\t#ifndef GAUSS\n\t\tmoments *= 1.0 / float({SAMPLES});\n\t#endif\n\tgl_FragColor = vec4(moments.x, moments.y, moments.z, 1.0);\n}\n",clearCoatPS:"\nuniform float material_clearCoat;\nvoid getClearCoat() {\n\tccSpecularity = material_clearCoat;\n\t#ifdef STD_CLEARCOAT_TEXTURE\n\tccSpecularity *= texture2DBias({STD_CLEARCOAT_TEXTURE_NAME}, {STD_CLEARCOAT_TEXTURE_UV}, textureBias).{STD_CLEARCOAT_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_CLEARCOAT_VERTEX\n\tccSpecularity *= saturate(vVertexColor.{STD_CLEARCOAT_VERTEX_CHANNEL});\n\t#endif\n}\n",clearCoatGlossPS:"\nuniform float material_clearCoatGloss;\nvoid getClearCoatGlossiness() {\n\tccGlossiness = material_clearCoatGloss;\n\t#ifdef STD_CLEARCOATGLOSS_TEXTURE\n\tccGlossiness *= texture2DBias({STD_CLEARCOATGLOSS_TEXTURE_NAME}, {STD_CLEARCOATGLOSS_TEXTURE_UV}, textureBias).{STD_CLEARCOATGLOSS_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_CLEARCOATGLOSS_VERTEX\n\tccGlossiness *= saturate(vVertexColor.{STD_CLEARCOATGLOSS_VERTEX_CHANNEL});\n\t#endif\n\t#ifdef STD_CLEARCOATGLOSS_INVERT\n\tccGlossiness = 1.0 - ccGlossiness;\n\t#endif\n\tccGlossiness += 0.0000001;\n}\n",clearCoatNormalPS:"\n#ifdef STD_CLEARCOATNORMAL_TEXTURE\nuniform float material_clearCoatBumpiness;\n#endif\nvoid getClearCoatNormal() {\n#ifdef STD_CLEARCOATNORMAL_TEXTURE\n\tvec3 normalMap = {STD_CLEARCOATNORMAL_TEXTURE_DECODE}(texture2DBias({STD_CLEARCOATNORMAL_TEXTURE_NAME}, {STD_CLEARCOATNORMAL_TEXTURE_UV}, textureBias));\n\tnormalMap = mix(vec3(0.0, 0.0, 1.0), normalMap, material_clearCoatBumpiness);\n\tccNormalW = normalize(dTBN * normalMap);\n#else\n\tccNormalW = dVertexNormalW;\n#endif\n}\n",clusteredLightCookiesPS:"\nvec3 _getCookieClustered(TEXTURE_ACCEPT(tex), vec2 uv, float intensity, vec4 cookieChannel) {\n\tvec4 pixel = mix(vec4(1.0), texture2DLod(tex, uv, 0.0), intensity);\n\tbool isRgb = dot(cookieChannel.rgb, vec3(1.0)) == 3.0;\n\treturn isRgb ? pixel.rgb : vec3(dot(pixel, cookieChannel));\n}\nvec3 getCookie2DClustered(TEXTURE_ACCEPT(tex), mat4 transform, vec3 worldPosition, float intensity, vec4 cookieChannel) {\n\tvec4 projPos = transform * vec4(worldPosition, 1.0);\n\treturn _getCookieClustered(TEXTURE_PASS(tex), projPos.xy / projPos.w, intensity, cookieChannel);\n}\nvec3 getCookieCubeClustered(TEXTURE_ACCEPT(tex), vec3 dir, float intensity, vec4 cookieChannel, float shadowTextureResolution, float shadowEdgePixels, vec3 omniAtlasViewport) {\n\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);\n\treturn _getCookieClustered(TEXTURE_PASS(tex), uv, intensity, cookieChannel);\n}\n",clusteredLightShadowsPS:"\nvec3 _getShadowCoordPerspZbuffer(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {\n\tvec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n\tprojPos.xyz /= projPos.w;\n\treturn projPos.xyz;\n}\nvec3 getShadowCoordPerspZbufferNormalOffset(mat4 shadowMatrix, vec4 shadowParams, vec3 normal) {\n\tvec3 wPos = vPositionW + normal * shadowParams.y;\n\treturn _getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, wPos);\n}\nvec3 normalOffsetPointShadow(vec4 shadowParams, vec3 lightPos, vec3 lightDir, vec3 lightDirNorm, vec3 normal) {\n\tfloat distScale = length(lightDir);\n\tvec3 wPos = vPositionW + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;\n\tvec3 dir = wPos - lightPos;\n\treturn dir;\n}\n#if defined(CLUSTER_SHADOW_TYPE_PCF1)\nfloat getShadowOmniClusteredPCF1(SHADOWMAP_ACCEPT(shadowMap), vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {\n\tfloat shadowTextureResolution = shadowParams.x;\n\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);\n\tfloat shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;\n\treturn textureShadow(shadowMap, vec3(uv, shadowZ));\n}\n#endif\n#if defined(CLUSTER_SHADOW_TYPE_PCF3)\nfloat getShadowOmniClusteredPCF3(SHADOWMAP_ACCEPT(shadowMap), vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {\n\tfloat shadowTextureResolution = shadowParams.x;\n\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);\n\tfloat shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;\n\tvec3 shadowCoord = vec3(uv, shadowZ);\n\treturn getShadowPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);\n}\n#endif\n#if defined(CLUSTER_SHADOW_TYPE_PCF5)\nfloat getShadowOmniClusteredPCF5(SHADOWMAP_ACCEPT(shadowMap), vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {\n\tfloat shadowTextureResolution = shadowParams.x;\n\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);\n\tfloat shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;\n\tvec3 shadowCoord = vec3(uv, shadowZ);\n\treturn getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);\n}\n#endif\n#if defined(CLUSTER_SHADOW_TYPE_PCF1)\nfloat getShadowSpotClusteredPCF1(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\treturn textureShadow(shadowMap, shadowCoord);\n}\n#endif\n#if defined(CLUSTER_SHADOW_TYPE_PCF3)\nfloat getShadowSpotClusteredPCF3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\treturn getShadowSpotPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);\n}\n#endif\n#if defined(CLUSTER_SHADOW_TYPE_PCF5)\nfloat getShadowSpotClusteredPCF5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\treturn getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);\n}\n#endif\n",clusteredLightUtilsPS:"\nvec2 getCubemapFaceCoordinates(const vec3 dir, out float faceIndex, out vec2 tileOffset)\n{\n\tvec3 vAbs = abs(dir);\n\tfloat ma;\n\tvec2 uv;\n\tif (vAbs.z >= vAbs.x && vAbs.z >= vAbs.y) {\n\t\tfaceIndex = dir.z < 0.0 ? 5.0 : 4.0;\n\t\tma = 0.5 / vAbs.z;\n\t\tuv = vec2(dir.z < 0.0 ? -dir.x : dir.x, -dir.y);\n\t\ttileOffset.x = 2.0;\n\t\ttileOffset.y = dir.z < 0.0 ? 1.0 : 0.0;\n\t} else if(vAbs.y >= vAbs.x) {\n\t\tfaceIndex = dir.y < 0.0 ? 3.0 : 2.0;\n\t\tma = 0.5 / vAbs.y;\n\t\tuv = vec2(dir.x, dir.y < 0.0 ? -dir.z : dir.z);\n\t\ttileOffset.x = 1.0;\n\t\ttileOffset.y = dir.y < 0.0 ? 1.0 : 0.0;\n\t} else {\n\t\tfaceIndex = dir.x < 0.0 ? 1.0 : 0.0;\n\t\tma = 0.5 / vAbs.x;\n\t\tuv = vec2(dir.x < 0.0 ? dir.z : -dir.z, -dir.y);\n\t\ttileOffset.x = 0.0;\n\t\ttileOffset.y = dir.x < 0.0 ? 1.0 : 0.0;\n\t}\n\treturn uv * ma + 0.5;\n}\nvec2 getCubemapAtlasCoordinates(const vec3 omniAtlasViewport, float shadowEdgePixels, float shadowTextureResolution, const vec3 dir) {\n\tfloat faceIndex;\n\tvec2 tileOffset;\n\tvec2 uv = getCubemapFaceCoordinates(dir, faceIndex, tileOffset);\n\tfloat atlasFaceSize = omniAtlasViewport.z;\n\tfloat tileSize = shadowTextureResolution * atlasFaceSize;\n\tfloat offset = shadowEdgePixels / tileSize;\n\tuv = uv * vec2(1.0 - offset * 2.0) + vec2(offset * 1.0);\n\tuv *= atlasFaceSize;\n\tuv += tileOffset * atlasFaceSize;\n\tuv += omniAtlasViewport.xy;\n\treturn uv;\n}\n",clusteredLightPS:'\n#include "lightBufferDefinesPS"\n#include "clusteredLightUtilsPS"\n#ifdef CLUSTER_COOKIES\n\t#include "clusteredLightCookiesPS"\n#endif\n#ifdef CLUSTER_SHADOWS\n\t#include "clusteredLightShadowsPS"\n#endif\nuniform highp sampler2D clusterWorldTexture;\nuniform highp sampler2D lightsTexture;\n#ifdef CLUSTER_SHADOWS\n\tuniform sampler2DShadow shadowAtlasTexture;\n#endif\n#ifdef CLUSTER_COOKIES\n\tuniform sampler2D cookieAtlasTexture;\n#endif\nuniform int clusterMaxCells;\nuniform float clusterSkip;\nuniform vec3 clusterCellsCountByBoundsSize;\nuniform vec3 clusterTextureSize;\nuniform vec3 clusterBoundsMin;\nuniform vec3 clusterBoundsDelta;\nuniform vec3 clusterCellsDot;\nuniform vec3 clusterCellsMax;\nuniform vec2 shadowAtlasParams;\nstruct ClusterLightData {\n\tuint flags;\n\tvec3 halfWidth;\n\tbool isSpot;\n\tvec3 halfHeight;\n\tint lightIndex;\n\tvec3 position;\n\tuint shape;\n\tvec3 direction;\n\tbool falloffModeLinear;\n\tvec3 color;\n\tfloat shadowIntensity;\n\tvec3 omniAtlasViewport;\n\tfloat range;\n\tvec4 cookieChannelMask;\n\tfloat biasesData;\n\tuint colorBFlagsData;\n\tfloat shadowBias;\n\tfloat shadowNormalBias;\n\tfloat anglesData;\n\tfloat innerConeAngleCos;\n\tfloat outerConeAngleCos;\n\tfloat cookieIntensity;\n\tbool isDynamic;\n\tbool isLightmapped;\n};\nmat4 lightProjectionMatrix;\nvec4 sampleLightTextureF(const ClusterLightData clusterLightData, int index) {\n\treturn texelFetch(lightsTexture, ivec2(index, clusterLightData.lightIndex), 0);\n}\nvoid decodeClusterLightCore(inout ClusterLightData clusterLightData, float lightIndex) {\n\tclusterLightData.lightIndex = int(lightIndex);\n\tvec4 halfData = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_COLOR_ANGLES_BIAS});\n\tclusterLightData.anglesData = halfData.z;\n\tclusterLightData.biasesData = halfData.w;\n\tclusterLightData.colorBFlagsData = floatBitsToUint(halfData.y);\n\tvec2 colorRG = unpackHalf2x16(floatBitsToUint(halfData.x));\n\tvec2 colorB_flags = unpackHalf2x16(clusterLightData.colorBFlagsData);\n\tclusterLightData.color = vec3(colorRG, colorB_flags.x) * {LIGHT_COLOR_DIVIDER};\n\tvec4 lightPosRange = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_POSITION_RANGE});\n\tclusterLightData.position = lightPosRange.xyz;\n\tclusterLightData.range = lightPosRange.w;\n\tvec4 lightDir_Flags = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_DIRECTION_FLAGS});\n\tclusterLightData.direction = lightDir_Flags.xyz;\n\tclusterLightData.flags = floatBitsToUint(lightDir_Flags.w);\n\tclusterLightData.isSpot = (clusterLightData.flags & (1u << 30u)) != 0u;\n\tclusterLightData.shape = (clusterLightData.flags >> 28u) & 0x3u;\n\tclusterLightData.falloffModeLinear = (clusterLightData.flags & (1u << 27u)) == 0u;\n\tclusterLightData.shadowIntensity = float((clusterLightData.flags >> 0u) & 0xFFu) / 255.0;\n\tclusterLightData.cookieIntensity = float((clusterLightData.flags >> 8u) & 0xFFu) / 255.0;\n\tclusterLightData.isDynamic = (clusterLightData.flags & (1u << 22u)) != 0u;\n\tclusterLightData.isLightmapped = (clusterLightData.flags & (1u << 21u)) != 0u;\n}\nvoid decodeClusterLightSpot(inout ClusterLightData clusterLightData) {\n\tuint angleFlags = (clusterLightData.colorBFlagsData >> 16u) & 0xFFFFu;\n\tvec2 angleValues = unpackHalf2x16(floatBitsToUint(clusterLightData.anglesData));\n\tfloat innerVal = angleValues.x;\n\tfloat outerVal = angleValues.y;\n\tfloat innerIsVersine = float(angleFlags & 1u);\n\tfloat outerIsVersine = float((angleFlags >> 1u) & 1u);\n\tclusterLightData.innerConeAngleCos = mix(innerVal, 1.0 - innerVal, innerIsVersine);\n\tclusterLightData.outerConeAngleCos = mix(outerVal, 1.0 - outerVal, outerIsVersine);\n}\nvoid decodeClusterLightOmniAtlasViewport(inout ClusterLightData clusterLightData) {\n\tclusterLightData.omniAtlasViewport = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_PROJ_MAT_0}).xyz;\n}\nvoid decodeClusterLightAreaData(inout ClusterLightData clusterLightData) {\n\tclusterLightData.halfWidth = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_AREA_DATA_WIDTH}).xyz;\n\tclusterLightData.halfHeight = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_AREA_DATA_HEIGHT}).xyz;\n}\nvoid decodeClusterLightProjectionMatrixData(inout ClusterLightData clusterLightData) {\n\t\n\tvec4 m0 = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_PROJ_MAT_0});\n\tvec4 m1 = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_PROJ_MAT_1});\n\tvec4 m2 = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_PROJ_MAT_2});\n\tvec4 m3 = sampleLightTextureF(clusterLightData, {CLUSTER_TEXTURE_PROJ_MAT_3});\n\tlightProjectionMatrix = mat4(m0, m1, m2, m3);\n}\nvoid decodeClusterLightShadowData(inout ClusterLightData clusterLightData) {\n\t\n\tvec2 biases = unpackHalf2x16(floatBitsToUint(clusterLightData.biasesData));\n\tclusterLightData.shadowBias = biases.x;\n\tclusterLightData.shadowNormalBias = biases.y;\n}\nvoid decodeClusterLightCookieData(inout ClusterLightData clusterLightData) {\n\tuint cookieFlags = (clusterLightData.flags >> 23u) & 0x0Fu;\n\tclusterLightData.cookieChannelMask = vec4(uvec4(cookieFlags) & uvec4(1u, 2u, 4u, 8u));\n\tclusterLightData.cookieChannelMask = step(1.0, clusterLightData.cookieChannelMask);\n}\nvoid evaluateLight(\n\tClusterLightData light, \n\tvec3 worldNormal, \n\tvec3 viewDir, \n\tvec3 reflectionDir,\n#if defined(LIT_CLEARCOAT)\n\tvec3 clearcoatReflectionDir,\n#endif\n\tfloat gloss, \n\tvec3 specularity, \n\tvec3 geometricNormal, \n\tmat3 tbn, \n#if defined(LIT_IRIDESCENCE)\n\tvec3 iridescenceFresnel,\n#endif\n\tvec3 clearcoat_worldNormal,\n\tfloat clearcoat_gloss,\n\tfloat sheen_gloss,\n\tfloat iridescence_intensity\n) {\n\tvec3 cookieAttenuation = vec3(1.0);\n\tfloat diffuseAttenuation = 1.0;\n\tfloat falloffAttenuation = 1.0;\n\tvec3 lightDirW = evalOmniLight(light.position);\n\tvec3 lightDirNormW = normalize(lightDirW);\n\t#ifdef CLUSTER_AREALIGHTS\n\tif (light.shape != {LIGHTSHAPE_PUNCTUAL}) {\n\t\tdecodeClusterLightAreaData(light);\n\t\tif (light.shape == {LIGHTSHAPE_RECT}) {\n\t\t\tcalcRectLightValues(light.position, light.halfWidth, light.halfHeight);\n\t\t} else if (light.shape == {LIGHTSHAPE_DISK}) {\n\t\t\tcalcDiskLightValues(light.position, light.halfWidth, light.halfHeight);\n\t\t} else {\n\t\t\tcalcSphereLightValues(light.position, light.halfWidth, light.halfHeight);\n\t\t}\n\t\tfalloffAttenuation = getFalloffWindow(light.range, lightDirW);\n\t} else\n\t#endif\n\t{\n\t\tif (light.falloffModeLinear)\n\t\t\tfalloffAttenuation = getFalloffLinear(light.range, lightDirW);\n\t\telse\n\t\t\tfalloffAttenuation = getFalloffInvSquared(light.range, lightDirW);\n\t}\n\tif (falloffAttenuation > 0.00001) {\n\t\t#ifdef CLUSTER_AREALIGHTS\n\t\tif (light.shape != {LIGHTSHAPE_PUNCTUAL}) {\n\t\t\tif (light.shape == {LIGHTSHAPE_RECT}) {\n\t\t\t\tdiffuseAttenuation = getRectLightDiffuse(worldNormal, viewDir, lightDirW, lightDirNormW) * 16.0;\n\t\t\t} else if (light.shape == {LIGHTSHAPE_DISK}) {\n\t\t\t\tdiffuseAttenuation = getDiskLightDiffuse(worldNormal, viewDir, lightDirW, lightDirNormW) * 16.0;\n\t\t\t} else {\n\t\t\t\tdiffuseAttenuation = getSphereLightDiffuse(worldNormal, viewDir, lightDirW, lightDirNormW) * 16.0;\n\t\t\t}\n\t\t} else\n\t\t#endif\n\t\t{\n\t\t\tfalloffAttenuation *= getLightDiffuse(worldNormal, viewDir, lightDirNormW); \n\t\t}\n\t\tif (light.isSpot) {\n\t\t\tdecodeClusterLightSpot(light);\n\t\t\tfalloffAttenuation *= getSpotEffect(light.direction, light.innerConeAngleCos, light.outerConeAngleCos, lightDirNormW);\n\t\t}\n\t\t#if defined(CLUSTER_COOKIES) || defined(CLUSTER_SHADOWS)\n\t\tif (falloffAttenuation > 0.00001) {\n\t\t\tif (light.shadowIntensity > 0.0 || light.cookieIntensity > 0.0) {\n\t\t\t\tif (light.isSpot) {\n\t\t\t\t\tdecodeClusterLightProjectionMatrixData(light);\n\t\t\t\t} else {\n\t\t\t\t\tdecodeClusterLightOmniAtlasViewport(light);\n\t\t\t\t}\n\t\t\t\tfloat shadowTextureResolution = shadowAtlasParams.x;\n\t\t\t\tfloat shadowEdgePixels = shadowAtlasParams.y;\n\t\t\t\t#ifdef CLUSTER_COOKIES\n\t\t\t\tif (light.cookieIntensity > 0.0) {\n\t\t\t\t\tdecodeClusterLightCookieData(light);\n\t\t\t\t\tif (light.isSpot) {\n\t\t\t\t\t\tcookieAttenuation = getCookie2DClustered(TEXTURE_PASS(cookieAtlasTexture), lightProjectionMatrix, vPositionW, light.cookieIntensity, light.cookieChannelMask);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tcookieAttenuation = getCookieCubeClustered(TEXTURE_PASS(cookieAtlasTexture), lightDirW, light.cookieIntensity, light.cookieChannelMask, shadowTextureResolution, shadowEdgePixels, light.omniAtlasViewport);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t#endif\n\t\t\t\t#ifdef CLUSTER_SHADOWS\n\t\t\t\tif (light.shadowIntensity > 0.0) {\n\t\t\t\t\tdecodeClusterLightShadowData(light);\n\t\t\t\t\tvec4 shadowParams = vec4(shadowTextureResolution, light.shadowNormalBias, light.shadowBias, 1.0 / light.range);\n\t\t\t\t\tif (light.isSpot) {\n\t\t\t\t\t\tvec3 shadowCoord = getShadowCoordPerspZbufferNormalOffset(lightProjectionMatrix, shadowParams, geometricNormal);\n\t\t\t\t\t\t\n\t\t\t\t\t\t#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\t\t\t\t\t\t\tfloat shadow = getShadowSpotClusteredPCF1(SHADOWMAP_PASS(shadowAtlasTexture), shadowCoord, shadowParams);\n\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCF3)\n\t\t\t\t\t\t\tfloat shadow = getShadowSpotClusteredPCF3(SHADOWMAP_PASS(shadowAtlasTexture), shadowCoord, shadowParams);\n\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCF5)\n\t\t\t\t\t\t\tfloat shadow = getShadowSpotClusteredPCF5(SHADOWMAP_PASS(shadowAtlasTexture), shadowCoord, shadowParams);\n\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCSS)\n\t\t\t\t\t\t\tfloat shadow = getShadowSpotClusteredPCSS(SHADOWMAP_PASS(shadowAtlasTexture), shadowCoord, shadowParams);\n\t\t\t\t\t\t#endif\n\t\t\t\t\t\tfalloffAttenuation *= mix(1.0, shadow, light.shadowIntensity);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tvec3 dir = normalOffsetPointShadow(shadowParams, light.position, lightDirW, lightDirNormW, geometricNormal);\n\t\t\t\t\t\t#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\t\t\t\t\t\t\tfloat shadow = getShadowOmniClusteredPCF1(SHADOWMAP_PASS(shadowAtlasTexture), shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);\n\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCF3)\n\t\t\t\t\t\t\tfloat shadow = getShadowOmniClusteredPCF3(SHADOWMAP_PASS(shadowAtlasTexture), shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);\n\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCF5)\n\t\t\t\t\t\t\tfloat shadow = getShadowOmniClusteredPCF5(SHADOWMAP_PASS(shadowAtlasTexture), shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);\n\t\t\t\t\t\t#endif\n\t\t\t\t\t\tfalloffAttenuation *= mix(1.0, shadow, light.shadowIntensity);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t#endif\n\t\t\t}\n\t\t}\n\t\t#endif\n\t\t#ifdef CLUSTER_AREALIGHTS\n\t\tif (light.shape != {LIGHTSHAPE_PUNCTUAL}) {\n\t\t\t{\n\t\t\t\tvec3 areaDiffuse = (diffuseAttenuation * falloffAttenuation) * light.color * cookieAttenuation;\n\t\t\t\t#if defined(LIT_SPECULAR)\n\t\t\t\t\tareaDiffuse = mix(areaDiffuse, vec3(0), dLTCSpecFres);\n\t\t\t\t#endif\n\t\t\t\tdDiffuseLight += areaDiffuse;\n\t\t\t}\n\t\t\t#ifdef LIT_SPECULAR\n\t\t\t\tfloat areaLightSpecular;\n\t\t\t\tif (light.shape == {LIGHTSHAPE_RECT}) {\n\t\t\t\t\tareaLightSpecular = getRectLightSpecular(worldNormal, viewDir);\n\t\t\t\t} else if (light.shape == {LIGHTSHAPE_DISK}) {\n\t\t\t\t\tareaLightSpecular = getDiskLightSpecular(worldNormal, viewDir);\n\t\t\t\t} else {\n\t\t\t\t\tareaLightSpecular = getSphereLightSpecular(worldNormal, viewDir);\n\t\t\t\t}\n\t\t\t\tdSpecularLight += dLTCSpecFres * areaLightSpecular * falloffAttenuation * light.color * cookieAttenuation;\n\t\t\t\t#ifdef LIT_CLEARCOAT\n\t\t\t\t\tfloat areaLightSpecularCC;\n\t\t\t\t\tif (light.shape == {LIGHTSHAPE_RECT}) {\n\t\t\t\t\t\tareaLightSpecularCC = getRectLightSpecular(clearcoat_worldNormal, viewDir);\n\t\t\t\t\t} else if (light.shape == {LIGHTSHAPE_DISK}) {\n\t\t\t\t\t\tareaLightSpecularCC = getDiskLightSpecular(clearcoat_worldNormal, viewDir);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tareaLightSpecularCC = getSphereLightSpecular(clearcoat_worldNormal, viewDir);\n\t\t\t\t\t}\n\t\t\t\t\tccSpecularLight += ccLTCSpecFres * areaLightSpecularCC * falloffAttenuation * light.color  * cookieAttenuation;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t} else\n\t\t#endif\n\t\t{\n\t\t\t{\n\t\t\t\tvec3 punctualDiffuse = falloffAttenuation * light.color * cookieAttenuation;\n\t\t\t\t#if defined(CLUSTER_AREALIGHTS)\n\t\t\t\t#if defined(LIT_SPECULAR)\n\t\t\t\t\tpunctualDiffuse = mix(punctualDiffuse, vec3(0), specularity);\n\t\t\t\t#endif\n\t\t\t\t#endif\n\t\t\t\tdDiffuseLight += punctualDiffuse;\n\t\t\t}\n\t \n\t\t\t#ifdef LIT_SPECULAR\n\t\t\t\tvec3 halfDir = normalize(-lightDirNormW + viewDir);\n\t\t\t\t\n\t\t\t\t#ifdef LIT_SPECULAR_FRESNEL\n\t\t\t\t\tdSpecularLight += \n\t\t\t\t\t\tgetLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, lightDirNormW, gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * \n\t\t\t\t\t\tgetFresnel(\n\t\t\t\t\t\t\tdot(viewDir, halfDir), \n\t\t\t\t\t\t\tgloss, \n\t\t\t\t\t\t\tspecularity\n\t\t\t\t\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t\t\t, iridescenceFresnel,\n\t\t\t\t\t\t\tiridescence_intensity\n\t\t\t\t\t\t#endif\n\t\t\t\t\t\t\t);\n\t\t\t\t#else\n\t\t\t\t\tdSpecularLight += getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, lightDirNormW, gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * specularity;\n\t\t\t\t#endif\n\t\t\t\t#ifdef LIT_CLEARCOAT\n\t\t\t\t\t#ifdef LIT_SPECULAR_FRESNEL\n\t\t\t\t\t\tccSpecularLight += getLightSpecular(halfDir, clearcoatReflectionDir, clearcoat_worldNormal, viewDir, lightDirNormW, clearcoat_gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * getFresnelCC(dot(viewDir, halfDir));\n\t\t\t\t\t#else\n\t\t\t\t\t\tccSpecularLight += getLightSpecular(halfDir, clearcoatReflectionDir, clearcoat_worldNormal, viewDir, lightDirNormW, clearcoat_gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation; \n\t\t\t\t\t#endif\n\t\t\t\t#endif\n\t\t\t\t#ifdef LIT_SHEEN\n\t\t\t\t\tsSpecularLight += getLightSpecularSheen(halfDir, worldNormal, viewDir, lightDirNormW, sheen_gloss) * falloffAttenuation * light.color * cookieAttenuation;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t}\n\t}\n\tdAtten = falloffAttenuation;\n\tdLightDirNormW = lightDirNormW;\n}\nvoid evaluateClusterLight(\n\tfloat lightIndex, \n\tvec3 worldNormal, \n\tvec3 viewDir, \n\tvec3 reflectionDir, \n#if defined(LIT_CLEARCOAT)\n\tvec3 clearcoatReflectionDir,\n#endif\n\tfloat gloss, \n\tvec3 specularity, \n\tvec3 geometricNormal, \n\tmat3 tbn, \n#if defined(LIT_IRIDESCENCE)\n\tvec3 iridescenceFresnel,\n#endif\n\tvec3 clearcoat_worldNormal,\n\tfloat clearcoat_gloss,\n\tfloat sheen_gloss,\n\tfloat iridescence_intensity\n) {\n\tClusterLightData clusterLightData;\n\tdecodeClusterLightCore(clusterLightData, lightIndex);\n\t#ifdef CLUSTER_MESH_DYNAMIC_LIGHTS\n\t\tbool acceptLightMask = clusterLightData.isDynamic;\n\t#else\n\t\tbool acceptLightMask = clusterLightData.isLightmapped;\n\t#endif\n\tif (acceptLightMask)\n\t\tevaluateLight(\n\t\t\tclusterLightData, \n\t\t\tworldNormal, \n\t\t\tviewDir, \n\t\t\treflectionDir, \n#if defined(LIT_CLEARCOAT)\n\t\t\tclearcoatReflectionDir, \n#endif\n\t\t\tgloss, \n\t\t\tspecularity, \n\t\t\tgeometricNormal, \n\t\t\ttbn, \n#if defined(LIT_IRIDESCENCE)\n\t\t\tiridescenceFresnel,\n#endif\n\t\t\tclearcoat_worldNormal,\n\t\t\tclearcoat_gloss,\n\t\t\tsheen_gloss,\n\t\t\tiridescence_intensity\n\t\t);\n}\nvoid addClusteredLights(\n\tvec3 worldNormal, \n\tvec3 viewDir, \n\tvec3 reflectionDir, \n#if defined(LIT_CLEARCOAT)\n\tvec3 clearcoatReflectionDir,\n#endif\n\tfloat gloss, \n\tvec3 specularity, \n\tvec3 geometricNormal, \n\tmat3 tbn, \n#if defined(LIT_IRIDESCENCE)\n\tvec3 iridescenceFresnel,\n#endif\n\tvec3 clearcoat_worldNormal,\n\tfloat clearcoat_gloss,\n\tfloat sheen_gloss,\n\tfloat iridescence_intensity\n) {\n\tif (clusterSkip > 0.5)\n\t\treturn;\n\tvec3 cellCoords = floor((vPositionW - clusterBoundsMin) * clusterCellsCountByBoundsSize);\n\tif (!(any(lessThan(cellCoords, vec3(0.0))) || any(greaterThanEqual(cellCoords, clusterCellsMax)))) {\n\t\tfloat cellIndex = dot(clusterCellsDot, cellCoords);\n\t\tfloat clusterV = floor(cellIndex * clusterTextureSize.y);\n\t\tfloat clusterU = cellIndex - (clusterV * clusterTextureSize.x);\n\t\tfor (int lightCellIndex = 0; lightCellIndex < clusterMaxCells; lightCellIndex++) {\n\t\t\tfloat lightIndex = texelFetch(clusterWorldTexture, ivec2(int(clusterU) + lightCellIndex, clusterV), 0).x;\n\t\t\tif (lightIndex <= 0.0)\n\t\t\t\tbreak;\n\t\t\tevaluateClusterLight(\n\t\t\t\tlightIndex * 255.0, \n\t\t\t\tworldNormal, \n\t\t\t\tviewDir, \n\t\t\t\treflectionDir,\n#if defined(LIT_CLEARCOAT)\n\t\t\t\tclearcoatReflectionDir,\n#endif\n\t\t\t\tgloss, \n\t\t\t\tspecularity, \n\t\t\t\tgeometricNormal, \n\t\t\t\ttbn, \n#if defined(LIT_IRIDESCENCE)\n\t\t\t\tiridescenceFresnel,\n#endif\n\t\t\t\tclearcoat_worldNormal,\n\t\t\t\tclearcoat_gloss,\n\t\t\t\tsheen_gloss,\n\t\t\t\tiridescence_intensity\n\t\t\t); \n\t\t}\n\t}\n}\n',combinePS:"\nvec3 combineColor(vec3 albedo, vec3 sheenSpecularity, float clearcoatSpecularity) {\n\tvec3 ret = vec3(0);\n#ifdef LIT_OLD_AMBIENT\n\tret += (dDiffuseLight - light_globalAmbient) * albedo + material_ambient * light_globalAmbient;\n#else\n\tret += albedo * dDiffuseLight;\n#endif\n#ifdef LIT_SPECULAR\n\tret += dSpecularLight;\n#endif\n#ifdef LIT_REFLECTIONS\n\tret += dReflection.rgb * dReflection.a;\n#endif\n#ifdef LIT_SHEEN\n\tfloat sheenScaling = 1.0 - max(max(sheenSpecularity.r, sheenSpecularity.g), sheenSpecularity.b) * 0.157;\n\tret = ret * sheenScaling + (sSpecularLight + sReflection.rgb) * sheenSpecularity;\n#endif\n#ifdef LIT_CLEARCOAT\n\tfloat clearCoatScaling = 1.0 - ccFresnel * clearcoatSpecularity;\n\tret = ret * clearCoatScaling + (ccSpecularLight + ccReflection) * clearcoatSpecularity;\n#endif\n\treturn ret;\n}\n",cookieBlit2DPS:"\n\tvarying vec2 uv0;\n\tuniform sampler2D blitTexture;\n\tvoid main(void) {\n\t\tgl_FragColor = texture2D(blitTexture, uv0);\n\t}\n",cookieBlitCubePS:"\n\tvarying vec2 uv0;\n\tuniform samplerCube blitTexture;\n\tuniform mat4 invViewProj;\n\tvoid main(void) {\n\t\tvec4 projPos = vec4(uv0 * 2.0 - 1.0, 0.5, 1.0);\n\t\tvec4 worldPos = invViewProj * projPos;\n\t\tgl_FragColor = textureCube(blitTexture, worldPos.xyz);\n\t}\n",cookieBlitVS:"\n\tattribute vec2 vertex_position;\n\tvarying vec2 uv0;\n\tvoid main(void) {\n\t\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\t\tuv0 = vertex_position.xy * 0.5 + 0.5;\n\t\t#ifndef WEBGPU\n\t\t\tuv0.y = 1.0 - uv0.y;\n\t\t#endif\n\t}\n",cookiePS:"\nvec4 getCookie2D(sampler2D tex, mat4 transform, float intensity) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\treturn mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\nvec4 getCookie2DClip(sampler2D tex, mat4 transform, float intensity) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\tif (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n\treturn mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\nvec4 getCookie2DXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\tprojPos.xy += cookieOffset;\n\tvec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n\treturn mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\nvec4 getCookie2DClipXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\tprojPos.xy += cookieOffset;\n\tif (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n\tvec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n\treturn mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\nvec4 getCookieCube(samplerCube tex, mat4 transform, float intensity) {\n\treturn mix(vec4(1.0), textureCube(tex, dLightDirNormW * mat3(transform)), intensity);\n}\n",cubeMapProjectPS:"\n#if LIT_CUBEMAP_PROJECTION == BOX\n\tuniform vec3 envBoxMin;\n\tuniform vec3 envBoxMax;\n#endif\nvec3 cubeMapProject(vec3 nrdir) {\n\t#if LIT_CUBEMAP_PROJECTION == NONE\n\t\treturn cubeMapRotate(nrdir);\n\t#endif\n\t#if LIT_CUBEMAP_PROJECTION == BOX\n\t\tnrdir = cubeMapRotate(nrdir);\n\t\tvec3 rbmax = (envBoxMax - vPositionW) / nrdir;\n\t\tvec3 rbmin = (envBoxMin - vPositionW) / nrdir;\n\t\tvec3 rbminmax = mix(rbmin, rbmax, vec3(greaterThan(nrdir, vec3(0.0))));\n\t\tfloat fa = min(min(rbminmax.x, rbminmax.y), rbminmax.z);\n\t\tvec3 posonbox = vPositionW + nrdir * fa;\n\t\tvec3 envBoxPos = (envBoxMin + envBoxMax) * 0.5;\n\t\treturn normalize(posonbox - envBoxPos);\n\t#endif\n}\n",cubeMapRotatePS:"\n#ifdef CUBEMAP_ROTATION\nuniform mat3 cubeMapRotationMatrix;\n#endif\nvec3 cubeMapRotate(vec3 refDir) {\n#ifdef CUBEMAP_ROTATION\n\treturn refDir * cubeMapRotationMatrix;\n#else\n\treturn refDir;\n#endif\n}\n",debugOutputPS:"\n#ifdef DEBUG_ALBEDO_PASS\ngl_FragColor = vec4(gammaCorrectOutput(dAlbedo), 1.0);\n#endif\n#ifdef DEBUG_UV0_PASS\ngl_FragColor = vec4(litArgs_albedo , 1.0);\n#endif\n#ifdef DEBUG_WORLD_NORMAL_PASS\ngl_FragColor = vec4(litArgs_worldNormal * 0.5 + 0.5, 1.0);\n#endif\n#ifdef DEBUG_OPACITY_PASS\ngl_FragColor = vec4(vec3(litArgs_opacity) , 1.0);\n#endif\n#ifdef DEBUG_SPECULARITY_PASS\ngl_FragColor = vec4(litArgs_specularity, 1.0);\n#endif\n#ifdef DEBUG_GLOSS_PASS\ngl_FragColor = vec4(vec3(litArgs_gloss) , 1.0);\n#endif\n#ifdef DEBUG_METALNESS_PASS\ngl_FragColor = vec4(vec3(litArgs_metalness) , 1.0);\n#endif\n#ifdef DEBUG_AO_PASS\ngl_FragColor = vec4(vec3(litArgs_ao) , 1.0);\n#endif\n#ifdef DEBUG_EMISSION_PASS\ngl_FragColor = vec4(gammaCorrectOutput(litArgs_emission), 1.0);\n#endif\n",debugProcessFrontendPS:"\n#ifdef DEBUG_LIGHTING_PASS\nlitArgs_albedo = vec3(0.5);\n#endif\n#ifdef DEBUG_UV0_PASS\n#ifdef VARYING_VUV0\nlitArgs_albedo = vec3(vUv0, 0);\n#else\nlitArgs_albedo = vec3(0);\n#endif\n#endif\n",detailModesPS:"\n#ifndef _DETAILMODES_INCLUDED_\n#define _DETAILMODES_INCLUDED_\nvec3 detailMode_mul(vec3 c1, vec3 c2) {\n\treturn c1 * c2;\n}\nvec3 detailMode_add(vec3 c1, vec3 c2) {\n\treturn c1 + c2;\n}\nvec3 detailMode_screen(vec3 c1, vec3 c2) {\n\treturn 1.0 - (1.0 - c1)*(1.0 - c2);\n}\nvec3 detailMode_overlay(vec3 c1, vec3 c2) {\n\treturn mix(1.0 - 2.0 * (1.0 - c1)*(1.0 - c2), 2.0 * c1 * c2, step(c1, vec3(0.5)));\n}\nvec3 detailMode_min(vec3 c1, vec3 c2) {\n\treturn min(c1, c2);\n}\nvec3 detailMode_max(vec3 c1, vec3 c2) {\n\treturn max(c1, c2);\n}\n#endif\n",diffusePS:'\nuniform vec3 material_diffuse;\n#ifdef STD_DIFFUSEDETAIL_TEXTURE\n\t#include "detailModesPS"\n#endif\nvoid getAlbedo() {\n\tdAlbedo = material_diffuse.rgb;\n\t#ifdef STD_DIFFUSE_TEXTURE\n\t\tvec3 albedoTexture = {STD_DIFFUSE_TEXTURE_DECODE}(texture2DBias({STD_DIFFUSE_TEXTURE_NAME}, {STD_DIFFUSE_TEXTURE_UV}, textureBias)).{STD_DIFFUSE_TEXTURE_CHANNEL};\n\t\t#ifdef STD_DIFFUSEDETAIL_TEXTURE\n\t\t\tvec3 albedoDetail = {STD_DIFFUSEDETAIL_TEXTURE_DECODE}(texture2DBias({STD_DIFFUSEDETAIL_TEXTURE_NAME}, {STD_DIFFUSEDETAIL_TEXTURE_UV}, textureBias)).{STD_DIFFUSEDETAIL_TEXTURE_CHANNEL};\n\t\t\talbedoTexture = detailMode_{STD_DIFFUSEDETAIL_DETAILMODE}(albedoTexture, albedoDetail);\n\t\t#endif\n\t\tdAlbedo *= albedoTexture;\n\t#endif\n\t#ifdef STD_DIFFUSE_VERTEX\n\t\tdAlbedo *= saturate(vVertexColor.{STD_DIFFUSE_VERTEX_CHANNEL});\n\t#endif\n}\n',decodePS:"\n#ifndef _DECODE_INCLUDED_\n#define _DECODE_INCLUDED_\nvec3 decodeLinear(vec4 raw) {\n\treturn raw.rgb;\n}\nfloat decodeGamma(float raw) {\n\treturn pow(raw, 2.2);\n}\nvec3 decodeGamma(vec3 raw) {\n\treturn pow(raw, vec3(2.2));\n}\nvec3 decodeGamma(vec4 raw) {\n\treturn pow(raw.xyz, vec3(2.2));\n}\nvec3 decodeRGBM(vec4 raw) {\n\tvec3 color = (8.0 * raw.a) * raw.rgb;\n\treturn color * color;\n}\nvec3 decodeRGBP(vec4 raw) {\n\tvec3 color = raw.rgb * (-raw.a * 7.0 + 8.0);\n\treturn color * color;\n}\nvec3 decodeRGBE(vec4 raw) {\n\tif (raw.a == 0.0) {\n\t\treturn vec3(0.0, 0.0, 0.0);\n\t} else {\n\t\treturn raw.xyz * pow(2.0, raw.w * 255.0 - 128.0);\n\t}\n}\nvec4 passThrough(vec4 raw) {\n\treturn raw;\n}\nvec3 unpackNormalXYZ(vec4 nmap) {\n\treturn nmap.xyz * 2.0 - 1.0;\n}\nvec3 unpackNormalXY(vec4 nmap) {\n\tvec3 normal;\n\tnormal.xy = nmap.wy * 2.0 - 1.0;\n\tnormal.z = sqrt(1.0 - clamp(dot(normal.xy, normal.xy), 0.0, 1.0));\n\treturn normal;\n}\n#endif\n",emissivePS:"\nuniform vec3 material_emissive;\nuniform float material_emissiveIntensity;\nvoid getEmission() {\n\tdEmission = material_emissive * material_emissiveIntensity;\n\t#ifdef STD_EMISSIVE_TEXTURE\n\tdEmission *= {STD_EMISSIVE_TEXTURE_DECODE}(texture2DBias({STD_EMISSIVE_TEXTURE_NAME}, {STD_EMISSIVE_TEXTURE_UV}, textureBias)).{STD_EMISSIVE_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_EMISSIVE_VERTEX\n\tdEmission *= saturate(vVertexColor.{STD_EMISSIVE_VERTEX_CHANNEL});\n\t#endif\n}\n",encodePS:"\nvec4 encodeLinear(vec3 source) {\n\treturn vec4(source, 1.0);\n}\nvec4 encodeGamma(vec3 source) {\n\treturn vec4(pow(source + 0.0000001, vec3(1.0 / 2.2)), 1.0);\n}\nvec4 encodeRGBM(vec3 source) {\n\tvec4 result;\n\tresult.rgb = pow(source.rgb, vec3(0.5));\n\tresult.rgb *= 1.0 / 8.0;\n\tresult.a = saturate( max( max( result.r, result.g ), max( result.b, 1.0 / 255.0 ) ) );\n\tresult.a = ceil(result.a * 255.0) / 255.0;\n\tresult.rgb /= result.a;\n\treturn result;\n}\nvec4 encodeRGBP(vec3 source) {\n\tvec3 gamma = pow(source, vec3(0.5));\n\tfloat maxVal = min(8.0, max(1.0, max(gamma.x, max(gamma.y, gamma.z))));\n\tfloat v = 1.0 - ((maxVal - 1.0) / 7.0);\n\tv = ceil(v * 255.0) / 255.0;\n\treturn vec4(gamma / (-v * 7.0 + 8.0), v);\t\n}\nvec4 encodeRGBE(vec3 source) {\n\tfloat maxVal = max(source.x, max(source.y, source.z));\n\tif (maxVal < 1e-32) {\n\t\treturn vec4(0, 0, 0, 0);\n\t} else {\n\t\tfloat e = ceil(log2(maxVal));\n\t\treturn vec4(source / pow(2.0, e), (e + 128.0) / 255.0);\n\t}\n}\n",endPS:"\n\tgl_FragColor.rgb = combineColor(litArgs_albedo, litArgs_sheen_specularity, litArgs_clearcoat_specularity);\n\tgl_FragColor.rgb += litArgs_emission;\n\tgl_FragColor.rgb = addFog(gl_FragColor.rgb);\n\tgl_FragColor.rgb = toneMap(gl_FragColor.rgb);\n\tgl_FragColor.rgb = gammaCorrectOutput(gl_FragColor.rgb);\n",envAtlasPS:"\n#ifndef _ENVATLAS_INCLUDED_\n#define _ENVATLAS_INCLUDED_\nconst float atlasSize = 512.0;\nconst float seamSize = 1.0 / atlasSize;\nvec2 mapUv(vec2 uv, vec4 rect) {\n\treturn vec2(mix(rect.x + seamSize, rect.x + rect.z - seamSize, uv.x),\n\t\t\t\tmix(rect.y + seamSize, rect.y + rect.w - seamSize, uv.y));\n}\nvec2 mapRoughnessUv(vec2 uv, float level) {\n\tfloat t = 1.0 / exp2(level);\n\treturn mapUv(uv, vec4(0, 1.0 - t, t, t * 0.5));\n}\nvec2 mapShinyUv(vec2 uv, float level) {\n\tfloat t = 1.0 / exp2(level);\n\treturn mapUv(uv, vec4(1.0 - t, 1.0 - t, t, t * 0.5));\n}\n#endif\n",envProcPS:"\n#ifdef LIT_SKYBOX_INTENSITY\n\tuniform float skyboxIntensity;\n#endif\nvec3 processEnvironment(vec3 color) {\n\t#ifdef LIT_SKYBOX_INTENSITY\n\t\treturn color * skyboxIntensity;\n\t#else\n\t\treturn color;\n\t#endif\n}\n",falloffInvSquaredPS:"\nfloat getFalloffWindow(float lightRadius, vec3 lightDir) {\n\tfloat sqrDist = dot(lightDir, lightDir);\n\tfloat invRadius = 1.0 / lightRadius;\n\treturn square(saturate(1.0 - square(sqrDist * square(invRadius))));\n}\nfloat getFalloffInvSquared(float lightRadius, vec3 lightDir) {\n\tfloat sqrDist = dot(lightDir, lightDir);\n\tfloat falloff = 1.0 / (sqrDist + 1.0);\n\tfloat invRadius = 1.0 / lightRadius;\n\tfalloff *= 16.0;\n\tfalloff *= square(saturate(1.0 - square(sqrDist * square(invRadius))));\n\treturn falloff;\n}\n",falloffLinearPS:"\nfloat getFalloffLinear(float lightRadius, vec3 lightDir) {\n\tfloat d = length(lightDir);\n\treturn max(((lightRadius - d) / lightRadius), 0.0);\n}\n",floatAsUintPS:"\n#ifndef FLOAT_AS_UINT\n#define FLOAT_AS_UINT\nvec4 float2uint(float value) {\n\tuint intBits = floatBitsToUint(value);\n\treturn vec4(\n\t\tfloat((intBits >> 24u) & 0xFFu) / 255.0,\n\t\tfloat((intBits >> 16u) & 0xFFu) / 255.0,\n\t\tfloat((intBits >> 8u) & 0xFFu) / 255.0,\n\t\tfloat(intBits & 0xFFu) / 255.0\n\t);\n}\nfloat uint2float(vec4 value) {\n\tuint intBits = \n\t\t(uint(value.r * 255.0) << 24u) |\n\t\t(uint(value.g * 255.0) << 16u) |\n\t\t(uint(value.b * 255.0) << 8u) |\n\t\tuint(value.a * 255.0);\n\treturn uintBitsToFloat(intBits);\n}\nvec4 float2vec4(float value) {\n\t#if defined(CAPS_TEXTURE_FLOAT_RENDERABLE)\n\t\treturn vec4(value, 1.0, 1.0, 1.0);\n\t#else\n\t\treturn float2uint(value);\n\t#endif\n}\n#endif\n",fogPS:"\nfloat dBlendModeFogFactor = 1.0;\n#if (FOG != NONE)\n\tuniform vec3 fog_color;\n\t#if (FOG == LINEAR)\n\t\tuniform float fog_start;\n\t\tuniform float fog_end;\n\t#else\n\t\tuniform float fog_density;\n\t#endif\n#endif\nfloat getFogFactor() {\n\tfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n\tfloat fogFactor = 0.0;\n\t#if (FOG == LINEAR)\n\t\tfogFactor = (fog_end - depth) / (fog_end - fog_start);\n\t#elif (FOG == EXP)\n\t\tfogFactor = exp(-depth * fog_density);\n\t#elif (FOG == EXP2)\n\t\tfogFactor = exp(-depth * depth * fog_density * fog_density);\n\t#endif\n\treturn clamp(fogFactor, 0.0, 1.0);\n}\nvec3 addFog(vec3 color) {\n\t#if (FOG != NONE)\n\t\treturn mix(fog_color * dBlendModeFogFactor, color, getFogFactor());\n\t#endif\n\treturn color;\n}\n",fresnelSchlickPS:"\nvec3 getFresnel(\n\t\tfloat cosTheta, \n\t\tfloat gloss, \n\t\tvec3 specularity\n#if defined(LIT_IRIDESCENCE)\n\t\t, vec3 iridescenceFresnel, \n\t\tfloat iridescenceIntensity\n#endif\n\t) {\n\tfloat fresnel = pow(1.0 - saturate(cosTheta), 5.0);\n\tfloat glossSq = gloss * gloss;\n\tvec3 ret = specularity + (max(vec3(glossSq), specularity) - specularity) * fresnel;\n#if defined(LIT_IRIDESCENCE)\n\treturn mix(ret, iridescenceFresnel, iridescenceIntensity);\n#else\n\treturn ret;\n#endif\t\n}\nfloat getFresnelCC(float cosTheta) {\n\tfloat fresnel = pow(1.0 - saturate(cosTheta), 5.0);\n\treturn 0.04 + (1.0 - 0.04) * fresnel;\n}\n",frontendCodePS:"",frontendDeclPS:"",fullscreenQuadVS:"\nattribute vec2 vertex_position;\nvarying vec2 vUv0;\nvoid main(void)\n{\n\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\tvUv0 = vertex_position.xy * 0.5 + 0.5;\n}\n",gammaPS:'\n#include "decodePS"\n#if (GAMMA == SRGB)\n\tfloat gammaCorrectInput(float color) {\n\t\treturn decodeGamma(color);\n\t}\n\tvec3 gammaCorrectInput(vec3 color) {\n\t\treturn decodeGamma(color);\n\t}\n\tvec4 gammaCorrectInput(vec4 color) {\n\t\treturn vec4(decodeGamma(color.xyz), color.w);\n\t}\n\tvec3 gammaCorrectOutput(vec3 color) {\n\t\treturn pow(color + 0.0000001, vec3(1.0 / 2.2));\n\t}\n#else\n\tfloat gammaCorrectInput(float color) {\n\t\treturn color;\n\t}\n\tvec3 gammaCorrectInput(vec3 color) {\n\t\treturn color;\n\t}\n\tvec4 gammaCorrectInput(vec4 color) {\n\t\treturn color;\n\t}\n\tvec3 gammaCorrectOutput(vec3 color) {\n\t\treturn color;\n\t}\n#endif\n',gles3PS:Ca,gles3VS:Ea,glossPS:"\n#ifdef STD_GLOSS_CONSTANT\nuniform float material_gloss;\n#endif\nvoid getGlossiness() {\n\tdGlossiness = 1.0;\n\t#ifdef STD_GLOSS_CONSTANT\n\tdGlossiness *= material_gloss;\n\t#endif\n\t#ifdef STD_GLOSS_TEXTURE\n\tdGlossiness *= texture2DBias({STD_GLOSS_TEXTURE_NAME}, {STD_GLOSS_TEXTURE_UV}, textureBias).{STD_GLOSS_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_GLOSS_VERTEX\n\tdGlossiness *= saturate(vVertexColor.{STD_GLOSS_VERTEX_CHANNEL});\n\t#endif\n\t#ifdef STD_GLOSS_INVERT\n\tdGlossiness = 1.0 - dGlossiness;\n\t#endif\n\tdGlossiness += 0.0000001;\n}\n",quadVS:"\n\tattribute vec2 aPosition;\n\tvarying vec2 uv0;\n\tvoid main(void)\n\t{\n\t\tgl_Position = vec4(aPosition, 0.0, 1.0);\n\t\tuv0 = getImageEffectUV((aPosition.xy + 1.0) * 0.5);\n\t}\n",immediateLinePS:'\n\t\t#include "gammaPS"\n\t\tvarying vec4 color;\n\t\tvoid main(void) {\n\t\t\tgl_FragColor = vec4(gammaCorrectOutput(decodeGamma(color.rgb)), color.a);\n\t\t}\n',immediateLineVS:"\n\tattribute vec4 vertex_position;\n\tattribute vec4 vertex_color;\n\tuniform mat4 matrix_model;\n\tuniform mat4 matrix_viewProjection;\n\tvarying vec4 color;\n\tvoid main(void) {\n\t\tcolor = vertex_color;\n\t\tgl_Position = matrix_viewProjection * matrix_model * vertex_position;\n\t}\n",iridescenceDiffractionPS:"\nuniform float material_iridescenceRefractionIndex;\nfloat iridescence_iorToFresnel(float transmittedIor, float incidentIor) {\n\treturn pow((transmittedIor - incidentIor) / (transmittedIor + incidentIor), 2.0);\n}\nvec3 iridescence_iorToFresnel(vec3 transmittedIor, float incidentIor) {\n\treturn pow((transmittedIor - vec3(incidentIor)) / (transmittedIor + vec3(incidentIor)), vec3(2.0));\n}\nvec3 iridescence_fresnelToIor(vec3 f0) {\n\tvec3 sqrtF0 = sqrt(f0);\n\treturn (vec3(1.0) + sqrtF0) / (vec3(1.0) - sqrtF0);\n}\nvec3 iridescence_sensitivity(float opd, vec3 shift) {\n\tfloat PI = 3.141592653589793;\n\tfloat phase = 2.0 * PI * opd * 1.0e-9;\n\tconst vec3 val = vec3(5.4856e-13, 4.4201e-13, 5.2481e-13);\n\tconst vec3 pos = vec3(1.6810e+06, 1.7953e+06, 2.2084e+06);\n\tconst vec3 var = vec3(4.3278e+09, 9.3046e+09, 6.6121e+09);\n\tvec3 xyz = val * sqrt(2.0 * PI * var) * cos(pos * phase + shift) * exp(-pow(phase, 2.0) * var);\n\txyz.x += 9.7470e-14 * sqrt(2.0 * PI * 4.5282e+09) * cos(2.2399e+06 * phase + shift[0]) * exp(-4.5282e+09 * pow(phase, 2.0));\n\txyz /= vec3(1.0685e-07);\n\tconst mat3 XYZ_TO_REC709 = mat3(\n\t\t3.2404542, -0.9692660,  0.0556434,\n\t   -1.5371385,  1.8760108, -0.2040259,\n\t   -0.4985314,  0.0415560,  1.0572252\n\t);\n\treturn XYZ_TO_REC709 * xyz;\n}\nfloat iridescence_fresnel(float cosTheta, float f0) {\n\tfloat x = clamp(1.0 - cosTheta, 0.0, 1.0);\n\tfloat x2 = x * x;\n\tfloat x5 = x * x2 * x2;\n\treturn f0 + (1.0 - f0) * x5;\n} \nvec3 iridescence_fresnel(float cosTheta, vec3 f0) {\n\tfloat x = clamp(1.0 - cosTheta, 0.0, 1.0);\n\tfloat x2 = x * x;\n\tfloat x5 = x * x2 * x2; \n\treturn f0 + (vec3(1.0) - f0) * x5;\n}\nvec3 calcIridescence(float outsideIor, float cosTheta, vec3 base_f0, float iridescenceThickness) {\n\tfloat PI = 3.141592653589793;\n\tfloat iridescenceIor = mix(outsideIor, material_iridescenceRefractionIndex, smoothstep(0.0, 0.03, iridescenceThickness));\n\tfloat sinTheta2Sq = pow(outsideIor / iridescenceIor, 2.0) * (1.0 - pow(cosTheta, 2.0));\n\tfloat cosTheta2Sq = 1.0 - sinTheta2Sq;\n\tif (cosTheta2Sq < 0.0) {\n\t\treturn vec3(1.0);\n\t}\n\tfloat cosTheta2 = sqrt(cosTheta2Sq);\n\tfloat r0 = iridescence_iorToFresnel(iridescenceIor, outsideIor);\n\tfloat r12 = iridescence_fresnel(cosTheta, r0);\n\tfloat r21 = r12;\n\tfloat t121 = 1.0 - r12;\n\tfloat phi12 = iridescenceIor < outsideIor ? PI : 0.0;\n\tfloat phi21 = PI - phi12;\n\tvec3 baseIor = iridescence_fresnelToIor(base_f0 + vec3(0.0001));\n\tvec3 r1 = iridescence_iorToFresnel(baseIor, iridescenceIor);\n\tvec3 r23 = iridescence_fresnel(cosTheta2, r1);\n\tvec3 phi23 = vec3(0.0);\n\tif (baseIor[0] < iridescenceIor) phi23[0] = PI;\n\tif (baseIor[1] < iridescenceIor) phi23[1] = PI;\n\tif (baseIor[2] < iridescenceIor) phi23[2] = PI;\n\tfloat opd = 2.0 * iridescenceIor * iridescenceThickness * cosTheta2;\n\tvec3 phi = vec3(phi21) + phi23; \n\tvec3 r123Sq = clamp(r12 * r23, 1e-5, 0.9999);\n\tvec3 r123 = sqrt(r123Sq);\n\tvec3 rs = pow(t121, 2.0) * r23 / (1.0 - r123Sq);\n\tvec3 c0 = r12 + rs;\n\tvec3 i = c0;\n\tvec3 cm = rs - t121;\n\tfor (int m = 1; m <= 2; m++) {\n\t\tcm *= r123;\n\t\tvec3 sm = 2.0 * iridescence_sensitivity(float(m) * opd, float(m) * phi);\n\t\ti += cm * sm;\n\t}\n\treturn max(i, vec3(0.0));\n}\nvec3 getIridescence(float cosTheta, vec3 specularity, float iridescenceThickness) {\n\treturn calcIridescence(1.0, cosTheta, specularity, iridescenceThickness);\n}\n",iridescencePS:"\n#ifdef STD_IRIDESCENCE_CONSTANT\nuniform float material_iridescence;\n#endif\nvoid getIridescence() {\n\tfloat iridescence = 1.0;\n\t#ifdef STD_IRIDESCENCE_CONSTANT\n\tiridescence *= material_iridescence;\n\t#endif\n\t#ifdef STD_IRIDESCENCE_TEXTURE\n\tiridescence *= texture2DBias({STD_IRIDESCENCE_TEXTURE_NAME}, {STD_IRIDESCENCE_TEXTURE_UV}, textureBias).{STD_IRIDESCENCE_TEXTURE_CHANNEL};\n\t#endif\n\tdIridescence = iridescence; \n}\n",iridescenceThicknessPS:"\nuniform float material_iridescenceThicknessMax;\n#ifdef STD_IRIDESCENCETHICKNESS_TEXTURE\nuniform float material_iridescenceThicknessMin;\n#endif\nvoid getIridescenceThickness() {\n\t#ifdef STD_IRIDESCENCETHICKNESS_TEXTURE\n\t\tfloat blend = texture2DBias({STD_IRIDESCENCETHICKNESS_TEXTURE_NAME}, {STD_IRIDESCENCETHICKNESS_TEXTURE_UV}, textureBias).{STD_IRIDESCENCETHICKNESS_TEXTURE_CHANNEL};\n\t\tfloat iridescenceThickness = mix(material_iridescenceThicknessMin, material_iridescenceThicknessMax, blend);\n\t#else\n\t\tfloat iridescenceThickness = material_iridescenceThicknessMax;\n\t#endif\n\tdIridescenceThickness = iridescenceThickness; \n}\n",iorPS:"\n#ifdef STD_IOR_CONSTANT\nuniform float material_refractionIndex;\n#endif\nvoid getIor() {\n#ifdef STD_IOR_CONSTANT\n\tdIor = material_refractionIndex;\n#else\n\tdIor = 1.0 / 1.5;\n#endif\n}\n",lightDeclarationPS:"\n#if defined(LIGHT{i})\n\tuniform vec3 light{i}_color;\n\t#if LIGHT{i}TYPE == DIRECTIONAL\n\t\tuniform vec3 light{i}_direction;\n\t#else\n\t\t#define LIT_CODE_LIGHTS_POINT\n\t\tuniform vec3 light{i}_position;\n\t\tuniform float light{i}_radius;\n\t\t#if LIGHT{i}TYPE == SPOT\n\t\t\t#define LIT_CODE_LIGHTS_SPOT\n\t\t\tuniform vec3 light{i}_direction;\n\t\t\tuniform float light{i}_innerConeAngle;\n\t\t\tuniform float light{i}_outerConeAngle;\n\t\t#endif\n\t#endif\n\t#if LIGHT{i}SHAPE != PUNCTUAL\n\t\t#define LIT_CODE_FALLOFF_SQUARED\n\t\t#if LIGHT{i}TYPE == DIRECTIONAL\n\t\t\tuniform vec3 light{i}_position;\n\t\t#endif\n\t\tuniform vec3 light{i}_halfWidth;\n\t\tuniform vec3 light{i}_halfHeight;\n\t#else\n\t\t#if LIGHT{i}FALLOFF == LINEAR\n\t\t\t#define LIT_CODE_FALLOFF_LINEAR\n\t\t#endif\n\t\t#if LIGHT{i}FALLOFF == INVERSESQUARED\n\t\t\t#define LIT_CODE_FALLOFF_SQUARED\n\t\t#endif\n\t#endif\n\t#if defined(LIGHT{i}CASTSHADOW)\n\t\tuniform mat4 light{i}_shadowMatrix;\n\t\tuniform float light{i}_shadowIntensity;\n\t\tuniform vec4 light{i}_shadowParams;\n\t\t#if LIGHT{i}SHADOWTYPE == PCSS_32F\n\t\t\tuniform float light{i}_shadowSearchArea;\n\t\t\tuniform vec4 light{i}_cameraParams;\n\t\t\t#if LIGHT{i}TYPE == DIRECTIONAL\n\t\t\t\tuniform vec4 light{i}_softShadowParams;\n\t\t\t#endif\n\t\t#endif\n\t\t#if LIGHT{i}TYPE == DIRECTIONAL\n\t\t\tuniform mat4 light{i}_shadowMatrixPalette[4];\n\t\t\tuniform vec4 light{i}_shadowCascadeDistances;\n\t\t\tuniform int light{i}_shadowCascadeCount;\n\t\t\tuniform float light{i}_shadowCascadeBlend;\n\t\t#endif\n\t\t#if LIGHT{i}TYPE == OMNI\n\t\t\t#if defined(LIGHT{i}SHADOW_PCF)\n\t\t\t\tuniform samplerCubeShadow light{i}_shadowMap;\n\t\t\t#else\n\t\t\t\tuniform samplerCube light{i}_shadowMap;\n\t\t\t#endif\n\t\t#else\n\t\t\t#if defined(LIGHT{i}SHADOW_PCF)\n\t\t\t\tuniform sampler2DShadow light{i}_shadowMap;\n\t\t\t#else\n\t\t\t\tuniform sampler2D light{i}_shadowMap;\n\t\t\t#endif\n\t\t#endif\n\t#endif\n\t#if defined(LIGHT{i}COOKIE)\n\t\t#define LIT_CODE_COOKIE\n\t\t#if LIGHT{i}TYPE == OMNI\n\t\t\tuniform samplerCube light{i}_cookie;\n\t\t\tuniform float light{i}_cookieIntensity;\n\t\t\t#if !defined(LIGHT{i}CASTSHADOW)\n\t\t\t\tuniform mat4 light{i}_shadowMatrix;\n\t\t\t#endif\n\t\t#endif\n\t\t#if LIGHT{i}TYPE == SPOT\n\t\t\tuniform sampler2D light{i}_cookie;\n\t\t\tuniform float light{i}_cookieIntensity;\n\t\t\t#if !defined(LIGHT{i}CASTSHADOW)\n\t\t\t\tuniform mat4 light{i}_shadowMatrix;\n\t\t\t#endif\n\t\t\t#if defined(LIGHT{i}COOKIE_TRANSFORM)\n\t\t\t\tuniform vec4 light{i}_cookieMatrix;\n\t\t\t\tuniform vec2 light{i}_cookieOffset;\n\t\t\t#endif\n\t\t#endif\n\t#endif\n#endif\n",lightDiffuseLambertPS:"\nfloat getLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm) {\n\treturn max(dot(worldNormal, -lightDirNorm), 0.0);\n}\n",lightDirPointPS:"\nvec3 evalOmniLight(vec3 lightPosW) {\n\treturn vPositionW - lightPosW;\n}\n",lightEvaluationPS:"\n#if defined(LIGHT{i})\n\tevaluateLight{i}(\n\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\tiridescenceFresnel\n\t\t#endif\n\t);\n#endif\n",lightFunctionLightPS:"\n#if defined(LIGHT{i})\nvoid evaluateLight{i}(\n\t#if defined(LIT_IRIDESCENCE)\n\t\tvec3 iridescenceFresnel\n\t#endif\n) {\n\tvec3 lightColor = light{i}_color;\n\t#if LIGHT{i}TYPE == DIRECTIONAL && !defined(LIT_SHADOW_CATCHER)\n\t\tif (all(equal(lightColor, vec3(0.0)))) {\n\t\t\treturn;\n\t\t}\n\t#endif\n\t#if LIGHT{i}TYPE == DIRECTIONAL\n\t\tdLightDirNormW = light{i}_direction;\n\t\tdAtten = 1.0;\n\t#else\n\t\t\n\t\tvec3 lightDirW = evalOmniLight(light{i}_position);\n\t\tdLightDirNormW = normalize(lightDirW);\n\t\t#if defined(LIGHT{i}COOKIE)\n\t\t\t#if LIGHT{i}TYPE == SPOT\n\t\t\t\t#ifdef LIGHT{i}COOKIE_FALLOFF\n\t\t\t\t\t#ifdef LIGHT{i}COOKIE_TRANSFORM\n\t\t\t\t\t\tvec3 cookieAttenuation = getCookie2DXform(light{i}_cookie, light{i}_shadowMatrix, light{i}_cookieIntensity, light{i}_cookieMatrix, light{i}_cookieOffset).{LIGHT{i}COOKIE_CHANNEL};\n\t\t\t\t\t#else\n\t\t\t\t\t\tvec3 cookieAttenuation = getCookie2D(light{i}_cookie, light{i}_shadowMatrix, light{i}_cookieIntensity).{LIGHT{i}COOKIE_CHANNEL};\n\t\t\t\t\t#endif\n\t\t\t\t#else\n\t\t\t\t\t#ifdef LIGHT{i}COOKIE_TRANSFORM\n\t\t\t\t\t\tvec3 cookieAttenuation = getCookie2DClipXform(light{i}_cookie, light{i}_shadowMatrix, light{i}_cookieIntensity, light{i}_cookieMatrix, light{i}_cookieOffset).{LIGHT{i}COOKIE_CHANNEL};\n\t\t\t\t\t#else\n\t\t\t\t\t\tvec3 cookieAttenuation = getCookie2DClip(light{i}_cookie, light{i}_shadowMatrix, light{i}_cookieIntensity).{LIGHT{i}COOKIE_CHANNEL};\n\t\t\t\t\t#endif\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\t#if LIGHT{i}TYPE == OMNI\n\t\t\t\tvec3 cookieAttenuation = getCookieCube(light{i}_cookie, light{i}_shadowMatrix, light{i}_cookieIntensity).{LIGHT{i}COOKIE_CHANNEL};\n\t\t\t#endif\n\t\t\tlightColor *= cookieAttenuation;\n\t\t#endif\n\t\t#if LIGHT{i}SHAPE == PUNCTUAL\n\t\t\t#if LIGHT{i}FALLOFF == LINEAR\n\t\t\t\tdAtten = getFalloffLinear(light{i}_radius, lightDirW);\n\t\t\t#else\n\t\t\t\tdAtten = getFalloffInvSquared(light{i}_radius, lightDirW);\n\t\t\t#endif\n\t\t#else\n\t\t\tdAtten = getFalloffWindow(light{i}_radius, lightDirW);\n\t\t#endif\n\t\t#if LIGHT{i}TYPE == SPOT\n\t\t\t#if !defined(LIGHT{i}COOKIE) || defined(LIGHT{i}COOKIE_FALLOFF)\n\t\t\t\tdAtten *= getSpotEffect(light{i}_direction, light{i}_innerConeAngle, light{i}_outerConeAngle, dLightDirNormW);\n\t\t\t#endif\n\t\t#endif\n\t#endif\n\tif (dAtten < 0.00001) {\n\t\treturn;\n\t}\n\t#if LIGHT{i}SHAPE != PUNCTUAL\n\t\t#if LIGHT{i}SHAPE == RECT\n\t\t\tcalcRectLightValues(light{i}_position, light{i}_halfWidth, light{i}_halfHeight);\n\t\t#elif LIGHT{i}SHAPE == DISK\n\t\t\tcalcDiskLightValues(light{i}_position, light{i}_halfWidth, light{i}_halfHeight);\n\t\t#elif LIGHT{i}SHAPE == SPHERE\n\t\t\tcalcSphereLightValues(light{i}_position, light{i}_halfWidth, light{i}_halfHeight);\n\t\t#endif\n\t#endif\n\t#if LIGHT{i}SHAPE != PUNCTUAL\n\t\t#if LIGHT{i}TYPE == DIRECTIONAL\n\t\t\tfloat attenDiffuse = getLightDiffuse(litArgs_worldNormal, dViewDirW, dLightDirNormW);\n\t\t#else\n\t\t\t#if LIGHT{i}SHAPE == RECT\n\t\t\t\tfloat attenDiffuse = getRectLightDiffuse(litArgs_worldNormal, dViewDirW, lightDirW, dLightDirNormW) * 16.0;\n\t\t\t#elif LIGHT{i}SHAPE == DISK\n\t\t\t\tfloat attenDiffuse = getDiskLightDiffuse(litArgs_worldNormal, dViewDirW, lightDirW, dLightDirNormW) * 16.0;\n\t\t\t#elif LIGHT{i}SHAPE == SPHERE\n\t\t\t\tfloat attenDiffuse = getSphereLightDiffuse(litArgs_worldNormal, dViewDirW, lightDirW, dLightDirNormW) * 16.0;\n\t\t\t#endif\n\t\t#endif\n\t#else\n\t\tdAtten *= getLightDiffuse(litArgs_worldNormal, vec3(0.0), dLightDirNormW);\n\t#endif\n\t#ifdef LIGHT{i}CASTSHADOW\n\t\t#if LIGHT{i}TYPE == DIRECTIONAL\n\t\t\tfloat shadow = getShadow{i}(vec3(0.0));\n\t\t#else\n\t\t\tfloat shadow = getShadow{i}(lightDirW);\n\t\t#endif\n\t\tshadow = mix(1.0, shadow, light{i}_shadowIntensity);\n\t\tdAtten *= shadow;\n\t\t#if defined(LIT_SHADOW_CATCHER) && LIGHT{i}TYPE == DIRECTIONAL\n\t\t\tdShadowCatcher *= shadow;\n\t\t#endif\t\t\t\n\t#endif\n\t#if LIGHT{i}SHAPE != PUNCTUAL\n\t\t#ifdef LIT_SPECULAR\n\t\t\tdDiffuseLight += ((attenDiffuse * dAtten) * lightColor) * (1.0 - dLTCSpecFres);\n\t\t#else\n\t\t\tdDiffuseLight += (attenDiffuse * dAtten) * lightColor;\n\t\t#endif\t\t\t\t\t\t\n\t#else\n\t\t#if defined(AREA_LIGHTS) && defined(LIT_SPECULAR)\n\t\t\tdDiffuseLight += (dAtten * lightColor) * (1.0 - litArgs_specularity);\n\t\t#else\n\t\t\tdDiffuseLight += dAtten * lightColor;\n\t\t#endif\n\t#endif\n\t#ifdef LIGHT{i}AFFECT_SPECULARITY\n\t\t#if LIGHT{i}SHAPE != PUNCTUAL\n\t\t\t#ifdef LIT_CLEARCOAT\n\t\t\t\t#if LIGHT{i}SHAPE == RECT\n\t\t\t\t\tccSpecularLight += ccLTCSpecFres * getRectLightSpecular(litArgs_clearcoat_worldNormal, dViewDirW) * dAtten * lightColor;\n\t\t\t\t#elif LIGHT{i}SHAPE == DISK\n\t\t\t\t\tccSpecularLight += ccLTCSpecFres * getDiskLightSpecular(litArgs_clearcoat_worldNormal, dViewDirW) * dAtten * lightColor;\n\t\t\t\t#elif LIGHT{i}SHAPE == SPHERE\n\t\t\t\t\tccSpecularLight += ccLTCSpecFres * getSphereLightSpecular(litArgs_clearcoat_worldNormal, dViewDirW) * dAtten * lightColor;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\t#ifdef LIT_SPECULAR\n\t\t\t\t#if LIGHT{i}SHAPE == RECT\n\t\t\t\t\tdSpecularLight += dLTCSpecFres * getRectLightSpecular(litArgs_worldNormal, dViewDirW) * dAtten * lightColor;\n\t\t\t\t#elif LIGHT{i}SHAPE == DISK\n\t\t\t\t\tdSpecularLight += dLTCSpecFres * getDiskLightSpecular(litArgs_worldNormal, dViewDirW) * dAtten * lightColor;\n\t\t\t\t#elif LIGHT{i}SHAPE == SPHERE\n\t\t\t\t\tdSpecularLight += dLTCSpecFres * getSphereLightSpecular(litArgs_worldNormal, dViewDirW) * dAtten * lightColor;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t#else\n\t\t\t#if LIGHT{i}TYPE == DIRECTIONAL && LIT_FRESNEL_MODEL != NONE\n\t\t\t\t#define LIGHT{i}FRESNEL\n\t\t\t#endif\n\t\t\t#ifdef LIT_SPECULAR\n\t\t\t\tvec3 halfDirW = normalize(-dLightDirNormW + dViewDirW);\n\t\t\t#endif\n\t\t\t#ifdef LIT_CLEARCOAT\n\t\t\t\tvec3 lightspecularCC = getLightSpecular(halfDirW, ccReflDirW, litArgs_clearcoat_worldNormal, dViewDirW, dLightDirNormW, litArgs_clearcoat_gloss, dTBN) * dAtten * lightColor;\n\t\t\t\t#ifdef LIGHT{i}FRESNEL\n\t\t\t\t\tlightspecularCC *= getFresnelCC(dot(dViewDirW, halfDirW));\n\t\t\t\t#endif\n\t\t\t\tccSpecularLight += lightspecularCC;\n\t\t\t#endif\n\t\t\t#ifdef LIT_SHEEN\n\t\t\t\tsSpecularLight += getLightSpecularSheen(halfDirW, litArgs_worldNormal, dViewDirW, dLightDirNormW, litArgs_sheen_gloss) * dAtten * lightColor;\n\t\t\t#endif\n\t\t\t#ifdef LIT_SPECULAR\n\t\t\t\tvec3 lightSpecular = getLightSpecular(halfDirW, dReflDirW, litArgs_worldNormal, dViewDirW, dLightDirNormW, litArgs_gloss, dTBN) * dAtten * lightColor;\n\t\t\t\t#ifdef LIGHT{i}FRESNEL\n\t\t\t\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t\tlightSpecular *= getFresnel(dot(dViewDirW, halfDirW), litArgs_gloss, litArgs_specularity, iridescenceFresnel, litArgs_iridescence_intensity);\n\t\t\t\t\t#else\n\t\t\t\t\t\tlightSpecular *= getFresnel(dot(dViewDirW, halfDirW), litArgs_gloss, litArgs_specularity);\n\t\t\t\t\t#endif\n\t\t\t\t#else\n\t\t\t\t\tlightSpecular *= litArgs_specularity;\n\t\t\t\t#endif\n\t\t\t\t\n\t\t\t\tdSpecularLight += lightSpecular;\n\t\t\t#endif\n\t\t#endif\n\t#endif\n}\n#endif\n",lightFunctionShadowPS:"\n#ifdef LIGHT{i}CASTSHADOW\n\tvec3 getShadowSampleCoord{i}(mat4 shadowTransform, vec4 shadowParams, vec3 worldPosition, vec3 lightPos, inout vec3 lightDir, vec3 lightDirNorm, vec3 normal) {\n\t\tvec3 surfacePosition = worldPosition;\n\t\t#ifdef LIGHT{i}_SHADOW_SAMPLE_POINT\n\t\t\t#ifdef LIGHT{i}_SHADOW_SAMPLE_NORMAL_OFFSET\n\t\t\t\tfloat distScale = length(lightDir);\n\t\t\t\tsurfacePosition = surfacePosition + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;\n\t\t\t\tlightDir = surfacePosition - lightPos;\n\t\t\t\treturn lightDir;\n\t\t\t#endif\n\t\t#else\n\t\t\t#ifdef LIGHT{i}_SHADOW_SAMPLE_SOURCE_ZBUFFER\n\t\t\t\t#ifdef LIGHT{i}_SHADOW_SAMPLE_NORMAL_OFFSET\n\t\t\t\t\tsurfacePosition = surfacePosition + normal * shadowParams.y;\n\t\t\t\t#endif\n\t\t\t#else\n\t\t\t\t#ifdef LIGHT{i}_SHADOW_SAMPLE_NORMAL_OFFSET\n\t\t\t\t\t#ifdef LIGHT{i}_SHADOW_SAMPLE_ORTHO\n\t\t\t\t\t\tfloat distScale = 1.0;\n\t\t\t\t\t#else\n\t\t\t\t\t\tfloat distScale = abs(dot(vPositionW - lightPos, lightDirNorm));\n\t\t\t\t\t#endif\n\t\t\t\t\tsurfacePosition = surfacePosition + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\tvec4 positionInShadowSpace = shadowTransform * vec4(surfacePosition, 1.0);\n\t\t\t#ifdef LIGHT{i}_SHADOW_SAMPLE_ORTHO\n\t\t\t\tpositionInShadowSpace.z = saturate(positionInShadowSpace.z) - 0.0001;\n\t\t\t#else\n\t\t\t\t#ifdef LIGHT{i}_SHADOW_SAMPLE_SOURCE_ZBUFFER\n\t\t\t\t\tpositionInShadowSpace.xyz /= positionInShadowSpace.w;\n\t\t\t\t#else\n\t\t\t\t\tpositionInShadowSpace.xy /= positionInShadowSpace.w;\n\t\t\t\t\tpositionInShadowSpace.z = length(lightDir) * shadowParams.w;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\t#ifdef SHADOW_SAMPLE_Z_BIAS\n\t\t\t#endif\n\t\t\tsurfacePosition = positionInShadowSpace.xyz;\n\t\t#endif\n\t\treturn surfacePosition;\n\t}\n\tfloat getShadow{i}(vec3 lightDirW) {\n\t\t#ifdef LIGHT{i}_SHADOW_CASCADES\n\t\t\tint cascadeIndex = getShadowCascadeIndex(light{i}_shadowCascadeDistances, light{i}_shadowCascadeCount);\n\t\t\t#ifdef LIGHT{i}_SHADOW_CASCADE_BLEND\n\t\t\t\tcascadeIndex = ditherShadowCascadeIndex(cascadeIndex, light{i}_shadowCascadeDistances, light{i}_shadowCascadeCount, light{i}_shadowCascadeBlend);\n\t\t\t#endif\n\t\t\tmat4 shadowMatrix = light{i}_shadowMatrixPalette[cascadeIndex];\n\t\t#else\n\t\t\tmat4 shadowMatrix = light{i}_shadowMatrix;\n\t\t#endif\n\t\t#if LIGHT{i}TYPE == DIRECTIONAL\n\t\t\tvec3 shadowCoord = getShadowSampleCoord{i}(shadowMatrix, light{i}_shadowParams, vPositionW, vec3(0.0), lightDirW, dLightDirNormW, dVertexNormalW);\n\t\t#else\n\t\t\tvec3 shadowCoord = getShadowSampleCoord{i}(shadowMatrix, light{i}_shadowParams, vPositionW, light{i}_position, lightDirW, dLightDirNormW, dVertexNormalW);\n\t\t#endif\n\t\t#if LIGHT{i}TYPE == DIRECTIONAL\n\t\t\tshadowCoord = fadeShadow(shadowCoord, light{i}_shadowCascadeDistances);\n\t\t#endif\n\t\t#if LIGHT{i}TYPE == DIRECTIONAL\n\t\t\t#if LIGHT{i}SHADOWTYPE == VSM_16F\n\t\t\t\treturn getShadowVSM16(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, 5.54);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == VSM_32F\n\t\t\t\treturn getShadowVSM32(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, 15.0);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCSS_32F\n\t\t\t\t#if LIGHT{i}SHAPE != PUNCTUAL\n\t\t\t\t\tvec2 shadowSearchArea = vec2(length(light{i}_halfWidth), length(light{i}_halfHeight)) * light{i}_shadowSearchArea;\n\t\t\t\t\treturn getShadowPCSS(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, light{i}_cameraParams, shadowSearchArea, lightDirW);\n\t\t\t\t#else\n\t\t\t\t\treturn getShadowPCSS(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, light{i}_cameraParams, light{i}_softShadowParams, lightDirW);\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCF1_16F || LIGHT{i}SHADOWTYPE == PCF1_32F\n\t\t\t\treturn getShadowPCF1x1(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCF3_16F || LIGHT{i}SHADOWTYPE == PCF3_32F\n\t\t\t\treturn getShadowPCF3x3(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCF5_16F || LIGHT{i}SHADOWTYPE == PCF5_32F\n\t\t\t\treturn getShadowPCF5x5(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);\n\t\t\t#endif\n\t\t#endif\n\t\t#if LIGHT{i}TYPE == SPOT\n\t\t\t#if LIGHT{i}SHADOWTYPE == VSM_16F\n\t\t\t\treturn getShadowSpotVSM16(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, 5.54, lightDirW);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == VSM_32F\n\t\t\t\treturn getShadowSpotVSM32(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, 15.0, lightDirW);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCSS_32F\n\t\t\t\t#if LIGHT{i}SHAPE != PUNCTUAL\n\t\t\t\t\tvec2 shadowSearchArea = vec2(length(light{i}_halfWidth), length(light{i}_halfHeight)) * light{i}_shadowSearchArea;\n\t\t\t\t#else\n\t\t\t\t\tvec2 shadowSearchArea = vec2(light{i}_shadowSearchArea);\n\t\t\t\t#endif\n\t\t\t\treturn getShadowSpotPCSS(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, light{i}_cameraParams, shadowSearchArea, lightDirW);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCF1_16F || LIGHT{i}SHADOWTYPE == PCF1_32F\n\t\t\t\treturn getShadowSpotPCF1x1(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCF3_16F || LIGHT{i}SHADOWTYPE == PCF3_32F\n\t\t\t\treturn getShadowSpotPCF3x3(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCF5_16F || LIGHT{i}SHADOWTYPE == PCF5_32F\n\t\t\t\treturn getShadowSpotPCF5x5(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams);\n\t\t\t#endif\n\t\t#endif\n\t\t#if LIGHT{i}TYPE == OMNI\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCSS_32F\n\t\t\t\t#if LIGHT{i}SHAPE != PUNCTUAL\n\t\t\t\t\tvec2 shadowSearchArea = vec2(length(light{i}_halfWidth), length(light{i}_halfHeight)) * light{i}_shadowSearchArea;\n\t\t\t\t#else\n\t\t\t\t\tvec2 shadowSearchArea = vec2(light{i}_shadowSearchArea);\n\t\t\t\t#endif\n\t\t\t\treturn getShadowOmniPCSS(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, light{i}_cameraParams, shadowSearchArea, lightDirW);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCF1_16F || LIGHT{i}SHADOWTYPE == PCF1_32F\n\t\t\t\treturn getShadowOmniPCF1x1(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, lightDirW);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCF3_16F || LIGHT{i}SHADOWTYPE == PCF3_32F\n\t\t\t\treturn getShadowOmniPCF3x3(SHADOWMAP_PASS(light{i}_shadowMap), shadowCoord, light{i}_shadowParams, lightDirW);\n\t\t\t#endif\n\t\t#endif\n\t}\n#endif\n",lightingPS:'\n#ifdef LIT_CLUSTERED_LIGHTS\n\t#define LIT_CODE_FALLOFF_LINEAR\n\t#define LIT_CODE_FALLOFF_SQUARED\n\t#define LIT_CODE_LIGHTS_POINT\n\t#define LIT_CODE_LIGHTS_SPOT\n#endif\n#ifdef AREA_LIGHTS\n\tuniform highp sampler2D areaLightsLutTex1;\n\tuniform highp sampler2D areaLightsLutTex2;\n#endif\n#ifdef LIT_LIGHTING\n\t#include "lightDiffuseLambertPS"\n\t#if defined(AREA_LIGHTS) || defined(LIT_CLUSTERED_AREA_LIGHTS)\n\t\t#include "ltcPS"\n\t#endif\n#endif\n#ifdef SHADOW_DIRECTIONAL\n\t#include "shadowCascadesPS"\n#endif\n#if defined(SHADOW_KIND_PCF1)\n\t#include "shadowPCF1PS"\n#endif\n#if defined(SHADOW_KIND_PCF3)\n\t#include "shadowPCF3PS"\n#endif\n#if defined(SHADOW_KIND_PCF5)\n\t#include "shadowPCF5PS"\n#endif\n#if defined(SHADOW_KIND_PCSS)\n\t#include "linearizeDepthPS"\n\t#include "shadowPCSSPS"\n\t#include "shadowSoftPS"\n#endif\n#if defined(SHADOW_KIND_VSM)\n\t#include "shadowEVSMPS"\n#endif\n#ifdef LIT_CODE_FALLOFF_LINEAR\n\t#include "falloffLinearPS"\n#endif\n#ifdef LIT_CODE_FALLOFF_SQUARED\n\t#include "falloffInvSquaredPS"\n#endif\n#ifdef LIT_CODE_LIGHTS_POINT\n\t#include "lightDirPointPS"\n#endif\n#ifdef LIT_CODE_LIGHTS_SPOT\n\t#include "spotPS"\n#endif\n#ifdef LIT_CODE_COOKIE\n\t#include "cookiePS"\n#endif\n#ifdef LIT_CLUSTERED_LIGHTS\n\t#include "clusteredLightPS"\n#endif\n#ifdef LIGHT_COUNT > 0\n\t#include "lightFunctionShadowPS, LIGHT_COUNT"\n\t#include "lightFunctionLightPS, LIGHT_COUNT"\n#endif\n',lightmapAddPS:"\nvoid addLightMap(\n\tvec3 lightmap, \n\tvec3 dir, \n\tvec3 worldNormal, \n\tvec3 viewDir, \n\tvec3 reflectionDir, \n\tfloat gloss, \n\tvec3 specularity, \n\tvec3 vertexNormal, \n\tmat3 tbn\n#if defined(LIT_IRIDESCENCE)\n\tvec3 iridescenceFresnel, \n\tfloat iridescenceIntensity\n#endif\n) {\n\t#if defined(LIT_SPECULAR) && defined(LIT_DIR_LIGHTMAP)\n\t\tif (dot(dir, dir) < 0.0001) {\n\t\t\t\tdDiffuseLight += lightmap;\n\t\t} else {\n\t\t\tfloat vlight = saturate(dot(dir, -vertexNormal));\n\t\t\tfloat flight = saturate(dot(dir, -worldNormal));\n\t\t\tfloat nlight = (flight / max(vlight, 0.01)) * 0.5;\n\t\t\tdDiffuseLight += lightmap * nlight * 2.0;\n\t\t\tvec3 halfDir = normalize(-dir + viewDir);\n\t\t\tvec3 specularLight = lightmap * getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, dir, gloss, tbn);\n\t\t\t#ifdef LIT_SPECULAR_FRESNEL\n\t\t\t\tspecularLight *= \n\t\t\t\t\tgetFresnel(dot(viewDir, halfDir), \n\t\t\t\t\tgloss, \n\t\t\t\t\tspecularity\n\t\t\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t, iridescenceFresnel,\n\t\t\t\t\tiridescenceIntensity\n\t\t\t\t#endif\n\t\t\t\t\t);\n\t\t\t#endif\n\t\t\tdSpecularLight += specularLight;\n\t\t}\n\t#else\n\t\tdDiffuseLight += lightmap;\n\t#endif\n}\n",lightmapPS:"\n#ifdef STD_LIGHTMAP_DIR\n\tvec3 dLightmapDir;\n\tuniform sampler2D texture_dirLightMap;\n#endif\nvoid getLightMap() {\n\tdLightmap = vec3(1.0);\n\t#ifdef STD_LIGHT_TEXTURE\n\t\tdLightmap *= {STD_LIGHT_TEXTURE_DECODE}(texture2DBias({STD_LIGHT_TEXTURE_NAME}, {STD_LIGHT_TEXTURE_UV}, textureBias)).{STD_LIGHT_TEXTURE_CHANNEL};\n\t\t#ifdef STD_LIGHTMAP_DIR\n\t\t\tvec3 dir = texture2DBias(texture_dirLightMap, {STD_LIGHT_TEXTURE_UV}, textureBias).xyz * 2.0 - 1.0;\n\t\t\tfloat dirDot = dot(dir, dir);\n\t\t\tdLightmapDir = (dirDot > 0.001) ? dir / sqrt(dirDot) : vec3(0.0);\n\t\t#endif\n\t#endif\n\t#ifdef STD_LIGHT_VERTEX\n\t\tdLightmap *= saturate(vVertexColor.{STD_LIGHT_VERTEX_CHANNEL});\n\t#endif\n}\n",lightSpecularAnisoGGXPS:"\nfloat calcLightSpecular(float gloss, vec3 worldNormal, vec3 viewDir, vec3 h, vec3 lightDirNorm, mat3 tbn) {\n\tfloat PI = 3.141592653589793;\n\tfloat roughness = max((1.0 - gloss) * (1.0 - gloss), 0.001);\n\tfloat alphaRoughness = roughness * roughness;\n\tfloat anisotropy = dAnisotropy;\n\tvec2 direction = dAnisotropyRotation;\n\tfloat at = mix(alphaRoughness, 1.0, anisotropy * anisotropy);\n\tfloat ab = clamp(alphaRoughness, 0.001, 1.0);\n\tvec3 anisotropicT = normalize(tbn * vec3(direction, 0.0));\n\tvec3 anisotropicB = normalize(cross(tbn[2], anisotropicT));\n\tfloat NoH = dot(worldNormal, h);\n\tfloat ToH = dot(anisotropicT, h);\n\tfloat BoH = dot(anisotropicB, h);\n\tfloat a2 = at * ab;\n\tvec3 v = vec3(ab * ToH, at * BoH, a2 * NoH);\n\tfloat v2 = dot(v, v);\n\tfloat w2 = a2 / v2;\n\tfloat D = a2 * w2 * w2 * (1.0 / PI);\n\tfloat ToV = dot(anisotropicT, viewDir);\n\tfloat BoV = dot(anisotropicB, viewDir);\n\tfloat ToL = dot(anisotropicT, -lightDirNorm);\n\tfloat BoL = dot(anisotropicB, -lightDirNorm);\n\tfloat NoV = dot(worldNormal, viewDir);\n\tfloat NoL = dot(worldNormal, -lightDirNorm);\n\tfloat lambdaV = NoL * length(vec3(at * ToV, ab * BoV, NoV));\n\tfloat lambdaL = NoV * length(vec3(at * ToL, ab * BoL, NoL));\n\tfloat G = 0.5 / (lambdaV + lambdaL);\n\treturn D * G;\n}\nfloat getLightSpecular(vec3 h, vec3 reflDir, vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm, float gloss, mat3 tbn) {\n\treturn calcLightSpecular(gloss, worldNormal, viewDir, h, lightDirNorm, tbn);\n}\n",lightSpecularBlinnPS:"\nfloat calcLightSpecular(float gloss, vec3 worldNormal, vec3 h) {\n\tfloat nh = max( dot( h, worldNormal ), 0.0 );\n\tfloat specPow = exp2(gloss * 11.0);\n\tspecPow = max(specPow, 0.0001);\n\treturn pow(nh, specPow) * (specPow + 2.0) / 8.0;\n}\nfloat getLightSpecular(vec3 h, vec3 reflDir, vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm, float gloss, mat3 tbn) {\n\treturn calcLightSpecular(gloss, worldNormal, h);\n}\n",lightSheenPS:"\nfloat sheenD(vec3 normal, vec3 h, float roughness) {\n\tconst float PI = 3.141592653589793;\n\tfloat invR = 1.0 / (roughness * roughness);\n\tfloat cos2h = max(dot(normal, h), 0.0);\n\tcos2h *= cos2h;\n\tfloat sin2h = max(1.0 - cos2h, 0.0078125);\n\treturn (2.0 + invR) * pow(sin2h, invR * 0.5) / (2.0 * PI);\n}\nfloat sheenV(vec3 normal, vec3 viewDir, vec3 light) {\n\tfloat NoV = max(dot(normal, viewDir), 0.000001);\n\tfloat NoL = max(dot(normal, light), 0.000001);\n\treturn 1.0 / (4.0 * (NoL + NoV - NoL * NoV));\n}\nfloat getLightSpecularSheen(vec3 h, vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm, float sheenGloss) {\n\tfloat D = sheenD(worldNormal, h, sheenGloss);\n\tfloat V = sheenV(worldNormal, viewDir, -lightDirNorm);\n\treturn D * V;\n}\n",linearizeDepthPS:"\n#ifndef LINEARIZE_DEPTH\n#define LINEARIZE_DEPTH\nfloat linearizeDepthWithParams(float z, vec4 cameraParams) {\n\tif (cameraParams.w == 0.0)\n\t\treturn (cameraParams.z * cameraParams.y) / (cameraParams.y + z * (cameraParams.z - cameraParams.y));\n\telse\n\t\treturn cameraParams.z + z * (cameraParams.y - cameraParams.z);\n}\n#ifndef CAMERAPLANES\n\t#define CAMERAPLANES\n\tuniform vec4 camera_params;\n#endif\nfloat linearizeDepth(float z) {\n\treturn linearizeDepthWithParams(z, camera_params);\n}\n#endif\n",litForwardBackendPS:'\nvoid evaluateBackend() {\n\t#ifdef LIT_SSAO\n\t\tlitArgs_ao *= texture2DLod(ssaoTexture, gl_FragCoord.xy * ssaoTextureSizeInv, 0.0).r;\n\t#endif\n\t#ifdef LIT_NEEDS_NORMAL\n\t\t#ifdef LIT_SPECULAR\n\t\t\tgetReflDir(litArgs_worldNormal, dViewDirW, litArgs_gloss, dTBN);\n\t\t#endif\n\t\t#ifdef LIT_CLEARCOAT\n\t\t\tccReflDirW = normalize(-reflect(dViewDirW, litArgs_clearcoat_worldNormal));\n\t\t#endif\n\t#endif\n\t#ifdef LIT_SPECULAR_OR_REFLECTION\n\t\t#ifdef LIT_METALNESS\n\t\t\tfloat f0 = 1.0 / litArgs_ior;\n\t\t\tf0 = (f0 - 1.0) / (f0 + 1.0);\n\t\t\tf0 *= f0;\n\t\t\tlitArgs_specularity = getSpecularModulate(litArgs_specularity, litArgs_albedo, litArgs_metalness, f0);\n\t\t\tlitArgs_albedo = getAlbedoModulate(litArgs_albedo, litArgs_metalness);\n\t\t#endif\n\t\t#ifdef LIT_IRIDESCENCE\n\t\t\tvec3 iridescenceFresnel = getIridescence(saturate(dot(dViewDirW, litArgs_worldNormal)), litArgs_specularity, litArgs_iridescence_thickness);\n\t\t#endif\n\t#endif\n\t#ifdef LIT_ADD_AMBIENT\n\t\taddAmbient(litArgs_worldNormal);\n\t\t#ifdef LIT_SPECULAR\n\t\t\tdDiffuseLight = dDiffuseLight * (1.0 - litArgs_specularity);\n\t\t#endif\n\t\t#ifdef LIT_SEPARATE_AMBIENT\n\t\t\tvec3 dAmbientLight = dDiffuseLight;\n\t\t\tdDiffuseLight = vec3(0);\n\t\t#endif\n\t#endif\n\t#ifndef LIT_OLD_AMBIENT\n\t\tdDiffuseLight *= material_ambient;\n\t#endif\n\t#ifdef LIT_AO\n\t\t#ifndef LIT_OCCLUDE_DIRECT\n\t\t\toccludeDiffuse(litArgs_ao);\n\t\t#endif\n\t#endif\n\t#ifdef LIT_LIGHTMAP\n\t\taddLightMap(\n\t\t\tlitArgs_lightmap, \n\t\t\tlitArgs_lightmapDir, \n\t\t\tlitArgs_worldNormal, \n\t\t\tdViewDirW, \n\t\t\tdReflDirW, \n\t\t\tlitArgs_gloss, \n\t\t\tlitArgs_specularity, \n\t\t\tdVertexNormalW,\n\t\t\tdTBN\n\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t, iridescenceFresnel,\n\t\t\tlitArgs_iridescence_intensity\n\t\t#endif\n\t\t);\n\t#endif\n\t#ifdef LIT_LIGHTING || LIT_REFLECTIONS\n\t\t#ifdef LIT_REFLECTIONS\n\t\t\t#ifdef LIT_CLEARCOAT\n\t\t\t\taddReflectionCC(ccReflDirW, litArgs_clearcoat_gloss);\n\t\t\t\n\t\t\t\t#ifdef LIT_SPECULAR_FRESNEL\n\t\t\t\t\tccFresnel = getFresnelCC(dot(dViewDirW, litArgs_clearcoat_worldNormal));\n\t\t\t\t\tccReflection *= ccFresnel;\n\t\t\t\t#else\n\t\t\t\t\tccFresnel = 0.0;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\t#ifdef LIT_SPECULARITY_FACTOR\n\t\t\t\tccReflection *= litArgs_specularityFactor;\n\t\t\t#endif\n\t\t\t#ifdef LIT_SHEEN\n\t\t\t\taddReflectionSheen(litArgs_worldNormal, dViewDirW, litArgs_sheen_gloss);\n\t\t\t#endif\n\t\t\taddReflection(dReflDirW, litArgs_gloss);\n\t\t\t#ifdef LIT_FRESNEL_MODEL\n\t\t\t\tdReflection.rgb *= getFresnel(\n\t\t\t\t\tdot(dViewDirW, litArgs_worldNormal), \n\t\t\t\t\tlitArgs_gloss, \n\t\t\t\t\tlitArgs_specularity\n\t\t\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t, iridescenceFresnel,\n\t\t\t\t\tlitArgs_iridescence_intensity\n\t\t\t\t#endif\n\t\t\t\t\t);\n\t\t\t#else\n\t\t\t\tdReflection.rgb *= litArgs_specularity;\n\t\t\t#endif\n\t\t\t#ifdef LIT_SPECULARITY_FACTOR\n\t\t\t\tdReflection.rgb *= litArgs_specularityFactor;\n\t\t\t#endif\n\t\t#endif\n\t\t#ifdef AREA_LIGHTS\n\t\t\tdSpecularLight *= litArgs_specularity;\n\t\t\t#ifdef LIT_SPECULAR\n\t\t\t\tcalcLTCLightValues(litArgs_gloss, litArgs_worldNormal, dViewDirW, litArgs_specularity, litArgs_clearcoat_gloss, litArgs_clearcoat_worldNormal, litArgs_clearcoat_specularity);\n\t\t\t#endif\n\t\t#endif\n\t\t\n\t\t#ifdef LIGHT_COUNT > 0\n\t\t\t#include "lightEvaluationPS, LIGHT_COUNT"\n\t\t#endif\n\t\t#ifdef LIT_CLUSTERED_LIGHTS\n\t\t\taddClusteredLights(litArgs_worldNormal, dViewDirW, dReflDirW,\n\t\t\t\t#if defined(LIT_CLEARCOAT)\n\t\t\t\t\t\tccReflDirW,\n\t\t\t\t#endif\n\t\t\t\t\t\tlitArgs_gloss, litArgs_specularity, dVertexNormalW, dTBN, \n\t\t\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t\tiridescenceFresnel,\n\t\t\t\t#endif\n\t\t\t\t\t\tlitArgs_clearcoat_worldNormal, litArgs_clearcoat_gloss, litArgs_sheen_gloss, litArgs_iridescence_intensity\n\t\t\t);\n\t\t#endif\n\t\t#ifdef AREA_LIGHTS\n\t\t\t#ifdef LIT_CLEARCOAT\n\t\t\t\tlitArgs_clearcoat_specularity = 1.0;\n\t\t\t#endif\n\t\t\t#ifdef LIT_SPECULAR\n\t\t\t\tlitArgs_specularity = vec3(1);\n\t\t\t#endif\n\t\t#endif\n\t\t#ifdef LIT_REFRACTION\n\t\t\taddRefraction(\n\t\t\t\tlitArgs_worldNormal, \n\t\t\t\tdViewDirW, \n\t\t\t\tlitArgs_thickness, \n\t\t\t\tlitArgs_gloss, \n\t\t\t\tlitArgs_specularity, \n\t\t\t\tlitArgs_albedo, \n\t\t\t\tlitArgs_transmission,\n\t\t\t\tlitArgs_ior,\n\t\t\t\tlitArgs_dispersion\n\t\t\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t, iridescenceFresnel, \n\t\t\t\t\tlitArgs_iridescence_intensity\n\t\t\t\t#endif\n\t\t\t);\n\t\t#endif\n\t#endif\n\t#ifdef LIT_AO\n\t\t#ifdef LIT_OCCLUDE_DIRECT\n\t\t\toccludeDiffuse(litArgs_ao);\n\t\t#endif\n\t\t#if LIT_OCCLUDE_SPECULAR != NONE\n\t\t\toccludeSpecular(litArgs_gloss, litArgs_ao, litArgs_worldNormal, dViewDirW);\n\t\t#endif\n\t#endif\n\t#ifdef LIT_SPECULARITY_FACTOR\n\t\tdSpecularLight *= litArgs_specularityFactor;\n\t#endif\n\t#if !defined(LIT_OPACITY_FADES_SPECULAR)\n\t\t#if LIT_BLEND_TYPE == NORMAL || LIT_BLEND_TYPE == PREMULTIPLIED\n\t\t\tfloat specLum = dot((dSpecularLight + dReflection.rgb * dReflection.a), vec3( 0.2126, 0.7152, 0.0722 ));\n\t\t\t#ifdef LIT_CLEARCOAT\n\t\t\t\tspecLum += dot(ccSpecularLight * litArgs_clearcoat_specularity + ccReflection * litArgs_clearcoat_specularity, vec3( 0.2126, 0.7152, 0.0722 ));\n\t\t\t#endif\n\t\t\tlitArgs_opacity = clamp(litArgs_opacity + gammaCorrectInput(specLum), 0.0, 1.0);\n\t\t#endif\n\t\tlitArgs_opacity *= material_alphaFade;\n\t#endif\n\t#ifdef LIT_LIGHTMAP_BAKING\n\t\t#ifdef LIT_LIGHTMAP_BAKING_COLOR\n\t\t\t#include "bakeLmEndPS"\n\t\t#endif\n\t\t#ifdef LIT_LIGHTMAP_BAKING_DIR\n\t\t\t#include "bakeDirLmEndPS"\n\t\t#endif\n\t#else\n\t\t#include "endPS"\n\t\t#include "outputAlphaPS"\n\t#endif\n\t#ifdef LIT_MSDF\n\t\tgl_FragColor = applyMsdf(gl_FragColor);\n\t#endif\n\t#include "outputPS"\n\t#include "debugOutputPS"\n\t#ifdef LIT_SHADOW_CATCHER\n\t\tgl_FragColor.rgb = vec3(dShadowCatcher);\n\t#endif\n}\n',litForwardDeclarationPS:'\nvec3 sReflection;\nvec3 dVertexNormalW;\nvec3 dTangentW;\nvec3 dBinormalW;\nvec3 dViewDirW;\nvec3 dReflDirW;\nvec3 ccReflDirW;\nvec3 dLightDirNormW;\nfloat dAtten;\nmat3 dTBN;\nvec4 dReflection;\nvec3 dDiffuseLight;\nvec3 dSpecularLight;\nfloat ccFresnel;\nvec3 ccReflection;\nvec3 ccSpecularLight;\nfloat ccSpecularityNoFres;\nvec3 sSpecularLight;\n#ifdef LIT_DISPERSION\n\tuniform float material_dispersion;\n#endif\n#ifndef LIT_OPACITY_FADES_SPECULAR\n\tuniform float material_alphaFade;\n#endif\n#ifdef LIT_SSAO\n\tuniform sampler2D ssaoTexture;\n\tuniform vec2 ssaoTextureSizeInv;\n#endif\n#ifdef LIT_SHADOW_CATCHER\n\tfloat dShadowCatcher = 1.0;\n#endif\n#if LIGHT_COUNT > 0\n\t#include "lightDeclarationPS, LIGHT_COUNT"\n#endif\n#ifdef LIT_SPECULAR\n\t#if LIT_FRESNEL_MODEL == NONE && !defined(LIT_REFLECTIONS) && !defined(LIT_DIFFUSE_MAP) \n\t\t#define LIT_OLD_AMBIENT\n\t#endif\n#endif\n#ifdef STD_LIGHTMAP_DIR\n\tuniform float bakeDir;\n#endif\n#ifdef LIT_LIGHTMAP_BAKING_ADD_AMBIENT\n\tuniform float ambientBakeOcclusionContrast;\n\tuniform float ambientBakeOcclusionBrightness;\n#endif\n',litForwardMainPS:'\nvoid main(void) {\n\t#include "litUserMainStartPS"\n\tdReflection = vec4(0);\n\t#ifdef LIT_CLEARCOAT\n\t\tccSpecularLight = vec3(0);\n\t\tccReflection = vec3(0);\n\t#endif\n\t#if LIT_NONE_SLICE_MODE == SLICED\n\t\t#include "startNineSlicedPS"\n\t#elif LIT_NONE_SLICE_MODE == TILED\n\t\t#include "startNineSlicedTiledPS"\n\t#endif\n\t#ifdef LIT_NEEDS_NORMAL\n\t\tdVertexNormalW = normalize(vNormalW);\n\t\t#ifdef LIT_TANGENTS\n\t\t\t#if defined(LIT_HEIGHTS) || defined(LIT_USE_NORMALS) || defined(LIT_USE_CLEARCOAT_NORMALS) || defined(LIT_GGX_SPECULAR)\n\t\t\t\tdTangentW = vTangentW;\n\t\t\t\tdBinormalW = vBinormalW;\n\t\t\t#endif\n\t\t#endif\n\t\tgetViewDir();\n\t\t#ifdef LIT_TBN\n\t\t\tgetTBN(dTangentW, dBinormalW, dVertexNormalW);\n\t\t\t#ifdef LIT_TWO_SIDED_LIGHTING\n\t\t\t\thandleTwoSidedLighting();\n\t\t\t#endif\n\t\t#endif\n\t#endif\n\tevaluateFrontend();\n\t#include "debugProcessFrontendPS"\n\tevaluateBackend();\n\t#include "litUserMainEndPS"\n}\n',litForwardPostCodePS:'\n#ifdef LIT_NEEDS_NORMAL\n\t#include "cubeMapRotatePS"\n\t#include "cubeMapProjectPS"\n\t#include "envProcPS"\n#endif\n#ifdef LIT_SPECULAR_OR_REFLECTION\n\t#ifdef LIT_METALNESS\n\t\t#include "metalnessModulatePS"\n\t#endif\n\t#if LIT_FRESNEL_MODEL == SCHLICK\n\t\t#include "fresnelSchlickPS"\n\t#endif\n\t#ifdef LIT_IRIDESCENCE\n\t\t#include "iridescenceDiffractionPS"\n\t#endif\n#endif\n#ifdef LIT_AO\n\t#include "aoDiffuseOccPS"\n\t#include "aoSpecOccPS"\n#endif\n#if LIT_REFLECTION_SOURCE == ENVATLASHQ\n\t#include "envAtlasPS"\n\t#include "reflectionEnvHQPS"\n#elif LIT_REFLECTION_SOURCE == ENVATLAS\n\t#include "envAtlasPS"\n\t#include "reflectionEnvPS"\n#elif LIT_REFLECTION_SOURCE == CUBEMAP\n\t#include "reflectionCubePS"\n#elif LIT_REFLECTION_SOURCE == SPHEREMAP\n\t#include "reflectionSpherePS"\n#endif\n#ifdef LIT_REFLECTIONS\n\t#ifdef LIT_CLEARCOAT\n\t\t#include "reflectionCCPS"\n\t#endif\n\t#ifdef LIT_SHEEN\n\t\t#include "reflectionSheenPS"\n\t#endif\n#endif\n#ifdef LIT_REFRACTION\n\t#if defined(LIT_DYNAMIC_REFRACTION)\n\t\t#include "refractionDynamicPS"\n\t#elif defined(LIT_REFLECTIONS)\n\t\t#include "refractionCubePS"\n\t#endif\n#endif\n#ifdef LIT_SHEEN\n\t#include "lightSheenPS"\n#endif\nuniform vec3 material_ambient;\n#ifdef LIT_SPECULAR\n\t#ifdef LIT_LIGHTING\n\t\t#ifdef LIT_GGX_SPECULAR\n\t\t\t#include "lightSpecularAnisoGGXPS"\n\t\t#else\n\t\t\t#include "lightSpecularBlinnPS"\n\t\t#endif\n\t#endif\n#endif\n#include "combinePS"\n#ifdef LIT_LIGHTMAP\n\t#include "lightmapAddPS"\n#endif\n#ifdef LIT_ADD_AMBIENT\n\t#include "ambientPS"\n#endif\n#ifdef LIT_MSDF\n\t#include "msdfPS"\n#endif\n#ifdef LIT_NEEDS_NORMAL\n\t#include "viewDirPS"\n\t#ifdef LIT_SPECULAR\n\t\t#ifdef LIT_GGX_SPECULAR\n\t\t\t#include "reflDirAnisoPS"\n\t\t#else\n\t\t\t#include "reflDirPS"\n\t\t#endif\n\t#endif\n#endif\n#include "lightingPS"\n',litForwardPreCodePS:'\n#include "basePS"\n#include "sphericalPS"\n#include "decodePS"\n#include "gammaPS"\n#include "tonemappingPS"\n#include "fogPS"\n#if LIT_NONE_SLICE_MODE == SLICED\n\t#include "baseNineSlicedPS"\n#elif LIT_NONE_SLICE_MODE == TILED\n\t#include "baseNineSlicedTiledPS"\n#endif\n#ifdef LIT_TBN\n\t#include "TBNPS"\n\t#ifdef LIT_TWO_SIDED_LIGHTING\n\t\t#include "twoSidedLightingPS"\n\t#endif\n#endif\n',litMainPS:'\n#include "varyingsPS"\n#include "litUserDeclarationPS"\n#include "frontendDeclPS"\n#if defined(PICK_PASS) || defined(PREPASS_PASS)\n\t#include "frontendCodePS"\n\t#include "litUserCodePS"\n\t#include "litOtherMainPS"\n#elif defined(SHADOW_PASS)\n\t#include "frontendCodePS"\n\t#include "litUserCodePS"\n\t#include "litShadowMainPS"\n#else\n\t#include "litForwardDeclarationPS"\n\t#include "litForwardPreCodePS"\n\t#include "frontendCodePS"\n\t#include "litForwardPostCodePS"\n\t#include "litForwardBackendPS"\n\t#include "litUserCodePS"\n\t#include "litForwardMainPS"\n#endif\n',litMainVS:'\n#include "varyingsVS"\n#include  "litUserDeclarationVS"\n#ifdef VERTEX_COLOR\n\tattribute vec4 vertex_color;\n#endif\n#ifdef NINESLICED\n\tvarying vec2 vMask;\n\tvarying vec2 vTiledUv;\n\tuniform mediump vec4 innerOffset;\n\tuniform mediump vec2 outerScale;\n\tuniform mediump vec4 atlasRect;\n#endif\nvec3 dPositionW;\nmat4 dModelMatrix;\n#include "transformCoreVS"\n#ifdef UV0\n\tattribute vec2 vertex_texCoord0;\n\t#include "uv0VS"\n#endif\n#ifdef UV1\n\tattribute vec2 vertex_texCoord1;\n\t#include "uv1VS"\n#endif\n#ifdef LINEAR_DEPTH\n\t#ifndef VIEWMATRIX\n\t#define VIEWMATRIX\n\t\tuniform mat4 matrix_view;\n\t#endif\n#endif\n#include "transformVS"\n#ifdef NORMALS\n\t#include "normalCoreVS"\n\t#include "normalVS"\n#endif\n#ifdef TANGENTS\n\tattribute vec4 vertex_tangent;\n#endif\n#include "uvTransformUniformsPS, UV_TRANSFORMS_COUNT"\n#ifdef MSDF\n\t#include "msdfVS"\n#endif\n#include  "litUserCodeVS"\n#ifdef VERTEX_COLOR\n\tvec3 decodeGamma(vec3 raw) {\n\t\treturn pow(raw, vec3(2.2));\n\t}\n\tvec4 gammaCorrectInput(vec4 color) {\n\t\treturn vec4(decodeGamma(color.xyz), color.w);\n\t}\n#endif\nvoid main(void) {\n\t#include "litUserMainStartVS"\n\tgl_PointSize = 1.0;\n\tgl_Position = getPosition();\n\tvPositionW = getWorldPosition();\n\t#ifdef NORMALS\n\t\tvNormalW = getNormal();\n\t#endif\n\t#ifdef TANGENTS\n\t\tvTangentW = normalize(dNormalMatrix * vertex_tangent.xyz);\n\t\tvBinormalW = cross(vNormalW, vTangentW) * vertex_tangent.w;\n\t#elif defined(GGX_SPECULAR)\n\t\tvObjectSpaceUpW = normalize(dNormalMatrix * vec3(0, 1, 0));\n\t#endif\n\t#ifdef UV0\n\t\tvec2 uv0 = getUv0();\n\t\t#ifdef UV0_UNMODIFIED\n\t\t\tvUv0 = uv0;\n\t\t#endif\n\t#endif\n\t#ifdef UV1\n\t\tvec2 uv1 = getUv1();\n\t\t#ifdef UV1_UNMODIFIED\n\t\t\tvUv1 = uv1;\n\t\t#endif\n\t#endif\n\t#include "uvTransformVS, UV_TRANSFORMS_COUNT"\n\t#ifdef VERTEX_COLOR\n\t\t#ifdef STD_VERTEX_COLOR_GAMMA\n\t\t\tvVertexColor = gammaCorrectInput(vertex_color);\n\t\t#else\n\t\t\tvVertexColor = vertex_color;\n\t\t#endif\n\t#endif\n\t#ifdef LINEAR_DEPTH\n\t\tvLinearDepth = -(matrix_view * vec4(vPositionW, 1.0)).z;\n\t#endif\n\t#ifdef MSDF\n\t\tunpackMsdfParams();\n\t#endif\n\t#include "litUserMainEndVS"\n}\n',litOtherMainPS:'\n#ifdef PICK_PASS\n\t#include "pickPS"\n#endif\n#ifdef PREPASS_PASS\n\t#include "floatAsUintPS"\n#endif\nvoid main(void) {\n\t#include "litUserMainStartPS"\n\tevaluateFrontend();\n\t#ifdef PICK_PASS\n\t\tpcFragColor0 = getPickOutput();\n\t\t#ifdef DEPTH_PICK_PASS\n\t\t\tpcFragColor1 = getPickDepth();\n\t\t#endif\n\t#endif\n\t#ifdef PREPASS_PASS\n\t\tgl_FragColor = float2vec4(vLinearDepth);\n\t#endif\n\t#include "litUserMainEndPS"\n}\n',litShaderArgsPS:"\nvec3 litArgs_albedo;\nfloat litArgs_opacity;\nvec3 litArgs_emission;\nvec3 litArgs_worldNormal;\nfloat litArgs_ao;\nvec3 litArgs_lightmap;\nvec3 litArgs_lightmapDir;\nfloat litArgs_metalness;\nvec3 litArgs_specularity;\nfloat litArgs_specularityFactor;\nfloat litArgs_gloss;\nfloat litArgs_sheen_gloss;\nvec3 litArgs_sheen_specularity;\nfloat litArgs_transmission;\nfloat litArgs_thickness;\nfloat litArgs_ior;\nfloat litArgs_dispersion;\nfloat litArgs_iridescence_intensity;\nfloat litArgs_iridescence_thickness;\nvec3 litArgs_clearcoat_worldNormal;\nfloat litArgs_clearcoat_specularity;\nfloat litArgs_clearcoat_gloss;\n",litShaderCorePS:'\n\t#if LIT_NONE_SLICE_MODE == TILED\n\t\tconst float textureBias = -1000.0;\n\t#else\n\t\tuniform float textureBias;\n\t#endif\n\t#include "litShaderArgsPS"\n',litShadowMainPS:'\n#if LIGHT_TYPE != DIRECTIONAL\n\tuniform vec3 view_position;\n\tuniform float light_radius;\n#endif\n#if SHADOW_TYPE == PCSS_32F\n\t#include "linearizeDepthPS"\n#endif\nvoid main(void) {\n\t#include "litUserMainStartPS"\n\tevaluateFrontend();\n\t#ifdef PERSPECTIVE_DEPTH\n\t\tfloat depth = gl_FragCoord.z;\n\t\t#if SHADOW_TYPE == PCSS_32F\n\t\t\t#if LIGHT_TYPE != DIRECTIONAL\n\t\t\t\tdepth = linearizeDepthWithParams(depth, camera_params);\n\t\t\t#endif\n\t\t#endif\n\t#else\n\t\tfloat depth = min(distance(view_position, vPositionW) / light_radius, 0.99999);\n\t\t#define MODIFIED_DEPTH\n\t#endif\n\t#if SHADOW_TYPE == VSM_16F || SHADOW_TYPE == VSM_32F\n\t\t#if SHADOW_TYPE == VSM_32F\n\t\t\tfloat exponent = 15.0;\n\t\t#else\n\t\t\tfloat exponent = 5.54;\n\t\t#endif\n\t\tdepth = 2.0 * depth - 1.0;\n\t\tdepth =  exp(exponent * depth);\n\t\tgl_FragColor = vec4(depth, depth*depth, 1.0, 1.0);\n\t#else\n\t\t#if SHADOW_TYPE == PCSS_32F\n\t\t\tgl_FragColor.r = depth;\n\t\t#else\n\t\t\t#ifdef MODIFIED_DEPTH\n\t\t\t\tgl_FragDepth = depth;\n\t\t\t#endif\n\t\t\tgl_FragColor = vec4(1.0);\n\t\t#endif\n\t#endif\n\t#include "litUserMainEndPS"\n}\n',litUserDeclarationPS:"",litUserDeclarationVS:"",litUserCodePS:"",litUserCodeVS:"",litUserMainStartPS:"",litUserMainStartVS:"",litUserMainEndPS:"",litUserMainEndVS:"",ltcPS:"\nmat3 transposeMat3( const in mat3 m ) {\n\tmat3 tmp;\n\ttmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );\n\ttmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );\n\ttmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );\n\treturn tmp;\n}\nvec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {\n\tconst float LUT_SIZE = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\tfloat dotNV = saturate( dot( N, V ) );\n\tvec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );\n\tuv = uv * LUT_SCALE + LUT_BIAS;\n\treturn uv;\n}\nfloat LTC_ClippedSphereFormFactor( const in vec3 f ) {\n\tfloat l = length( f );\n\treturn max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\n}\nvec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {\n\tfloat x = dot( v1, v2 );\n\tfloat y = abs( x );\n\tfloat a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;\n\tfloat b = 3.4175940 + ( 4.1616724 + y ) * y;\n\tfloat v = a / b;\n\tfloat theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;\n\treturn cross( v1, v2 ) * theta_sintheta;\n}\nstruct Coords {\n\tvec3 coord0;\n\tvec3 coord1;\n\tvec3 coord2;\n\tvec3 coord3;\n};\nfloat LTC_EvaluateRect( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in Coords rectCoords) {\n\tvec3 v1 = rectCoords.coord1 - rectCoords.coord0;\n\tvec3 v2 = rectCoords.coord3 - rectCoords.coord0;\n\t\n\tvec3 lightNormal = cross( v1, v2 );\n\tfloat factor = sign(-dot( lightNormal, P - rectCoords.coord0 ));\n\tvec3 T1, T2;\n\tT1 = normalize( V - N * dot( V, N ) );\n\tT2 =  factor * cross( N, T1 );\n\tmat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );\n\tvec3 coords[ 4 ];\n\tcoords[ 0 ] = mat * ( rectCoords.coord0 - P );\n\tcoords[ 1 ] = mat * ( rectCoords.coord1 - P );\n\tcoords[ 2 ] = mat * ( rectCoords.coord2 - P );\n\tcoords[ 3 ] = mat * ( rectCoords.coord3 - P );\n\tcoords[ 0 ] = normalize( coords[ 0 ] );\n\tcoords[ 1 ] = normalize( coords[ 1 ] );\n\tcoords[ 2 ] = normalize( coords[ 2 ] );\n\tcoords[ 3 ] = normalize( coords[ 3 ] );\n\tvec3 vectorFormFactor = vec3( 0.0 );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );\n\tfloat result = LTC_ClippedSphereFormFactor( vectorFormFactor );\n\treturn result;\n}\nCoords dLTCCoords;\nCoords getLTCLightCoords(vec3 lightPos, vec3 halfWidth, vec3 halfHeight){\n\tCoords coords;\n\tcoords.coord0 = lightPos + halfWidth - halfHeight;\n\tcoords.coord1 = lightPos - halfWidth - halfHeight;\n\tcoords.coord2 = lightPos - halfWidth + halfHeight;\n\tcoords.coord3 = lightPos + halfWidth + halfHeight;\n\treturn coords;\n}\nfloat dSphereRadius;\nCoords getSphereLightCoords(vec3 lightPos, vec3 halfWidth, vec3 halfHeight){\n\tdSphereRadius = max(length(halfWidth), length(halfHeight));\n\tvec3 f = reflect(normalize(lightPos - view_position), vNormalW);\n\tvec3 w = normalize(cross(f, halfHeight));\n\tvec3 h = normalize(cross(f, w));\n\treturn getLTCLightCoords(lightPos, w * dSphereRadius, h * dSphereRadius);\n}\nvec2 dLTCUV;\n#ifdef LIT_CLEARCOAT\n\tvec2 ccLTCUV;\n#endif\nvec2 getLTCLightUV(float gloss, vec3 worldNormal, vec3 viewDir)\n{\n\tfloat roughness = max((1.0 - gloss) * (1.0 - gloss), 0.001);\n\treturn LTC_Uv( worldNormal, viewDir, roughness );\n}\nvec3 dLTCSpecFres;\n#ifdef LIT_CLEARCOAT\n\tvec3 ccLTCSpecFres;\n#endif\nvec3 getLTCLightSpecFres(vec2 uv, vec3 specularity)\n{\n\tvec4 t2 = texture2DLod(areaLightsLutTex2, uv, 0.0);\n\treturn specularity * t2.x + ( vec3( 1.0 ) - specularity) * t2.y;\n}\nvoid calcLTCLightValues(float gloss, vec3 worldNormal, vec3 viewDir, vec3 specularity, float clearcoatGloss, vec3 clearcoatWorldNormal, float clearcoatSpecularity)\n{\n\tdLTCUV = getLTCLightUV(gloss, worldNormal, viewDir);\n\tdLTCSpecFres = getLTCLightSpecFres(dLTCUV, specularity); \n#ifdef LIT_CLEARCOAT\n\tccLTCUV = getLTCLightUV(clearcoatGloss, clearcoatWorldNormal, viewDir);\n\tccLTCSpecFres = getLTCLightSpecFres(ccLTCUV, vec3(clearcoatSpecularity));\n#endif\n}\nvoid calcRectLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight) {\n\tdLTCCoords = getLTCLightCoords(lightPos, halfWidth, halfHeight);\n}\nvoid calcDiskLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight) {\n\tcalcRectLightValues(lightPos, halfWidth, halfHeight);\n}\nvoid calcSphereLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight) {\n\tdLTCCoords = getSphereLightCoords(lightPos, halfWidth, halfHeight);\n}\nvec3 SolveCubic(vec4 Coefficient)\n{\n\tfloat pi = 3.14159;\n\tCoefficient.xyz /= Coefficient.w;\n\tCoefficient.yz /= 3.0;\n\tfloat A = Coefficient.w;\n\tfloat B = Coefficient.z;\n\tfloat C = Coefficient.y;\n\tfloat D = Coefficient.x;\n\tvec3 Delta = vec3(\n\t\t-Coefficient.z * Coefficient.z + Coefficient.y,\n\t\t-Coefficient.y * Coefficient.z + Coefficient.x,\n\t\tdot(vec2(Coefficient.z, -Coefficient.y), Coefficient.xy)\n\t);\n\tfloat Discriminant = dot(vec2(4.0 * Delta.x, -Delta.y), Delta.zy);\n\tvec2 xlc, xsc;\n\t{\n\t\tfloat A_a = 1.0;\n\t\tfloat C_a = Delta.x;\n\t\tfloat D_a = -2.0 * B * Delta.x + Delta.y;\n\t\tfloat Theta = atan(sqrt(Discriminant), -D_a) / 3.0;\n\t\tfloat x_1a = 2.0 * sqrt(-C_a) * cos(Theta);\n\t\tfloat x_3a = 2.0 * sqrt(-C_a) * cos(Theta + (2.0 / 3.0) * pi);\n\t\tfloat xl;\n\t\tif ((x_1a + x_3a) > 2.0 * B)\n\t\t\txl = x_1a;\n\t\telse\n\t\t\txl = x_3a;\n\t\txlc = vec2(xl - B, A);\n\t}\n\t{\n\t\tfloat A_d = D;\n\t\tfloat C_d = Delta.z;\n\t\tfloat D_d = -D * Delta.y + 2.0 * C * Delta.z;\n\t\tfloat Theta = atan(D * sqrt(Discriminant), -D_d) / 3.0;\n\t\tfloat x_1d = 2.0 * sqrt(-C_d) * cos(Theta);\n\t\tfloat x_3d = 2.0 * sqrt(-C_d) * cos(Theta + (2.0 / 3.0) * pi);\n\t\tfloat xs;\n\t\tif (x_1d + x_3d < 2.0 * C)\n\t\t\txs = x_1d;\n\t\telse\n\t\t\txs = x_3d;\n\t\txsc = vec2(-D, xs + C);\n\t}\n\tfloat E =  xlc.y * xsc.y;\n\tfloat F = -xlc.x * xsc.y - xlc.y * xsc.x;\n\tfloat G =  xlc.x * xsc.x;\n\tvec2 xmc = vec2(C * F - B * G, -B * F + C * E);\n\tvec3 Root = vec3(xsc.x / xsc.y, xmc.x / xmc.y, xlc.x / xlc.y);\n\tif (Root.x < Root.y && Root.x < Root.z)\n\t\tRoot.xyz = Root.yxz;\n\telse if (Root.z < Root.x && Root.z < Root.y)\n\t\tRoot.xyz = Root.xzy;\n\treturn Root;\n}\nfloat LTC_EvaluateDisk(vec3 N, vec3 V, vec3 P, mat3 Minv, Coords points)\n{\n\tvec3 T1 = normalize(V - N * dot(V, N));\n\tvec3 T2 = cross(N, T1);\n\tmat3 R = transposeMat3( mat3( T1, T2, N ) );\n\tvec3 L_[ 3 ];\n\tL_[ 0 ] = R * ( points.coord0 - P );\n\tL_[ 1 ] = R * ( points.coord1 - P );\n\tL_[ 2 ] = R * ( points.coord2 - P );\n\tvec3 C  = 0.5 * (L_[0] + L_[2]);\n\tvec3 V1 = 0.5 * (L_[1] - L_[2]);\n\tvec3 V2 = 0.5 * (L_[1] - L_[0]);\n\tC  = Minv * C;\n\tV1 = Minv * V1;\n\tV2 = Minv * V2;\n\tfloat a, b;\n\tfloat d11 = dot(V1, V1);\n\tfloat d22 = dot(V2, V2);\n\tfloat d12 = dot(V1, V2);\n\tif (abs(d12) / sqrt(d11 * d22) > 0.0001)\n\t{\n\t\tfloat tr = d11 + d22;\n\t\tfloat det = -d12 * d12 + d11 * d22;\n\t\tdet = sqrt(det);\n\t\tfloat u = 0.5 * sqrt(tr - 2.0 * det);\n\t\tfloat v = 0.5 * sqrt(tr + 2.0 * det);\n\t\tfloat e_max = (u + v) * (u + v);\n\t\tfloat e_min = (u - v) * (u - v);\n\t\tvec3 V1_, V2_;\n\t\tif (d11 > d22)\n\t\t{\n\t\t\tV1_ = d12 * V1 + (e_max - d11) * V2;\n\t\t\tV2_ = d12 * V1 + (e_min - d11) * V2;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tV1_ = d12*V2 + (e_max - d22)*V1;\n\t\t\tV2_ = d12*V2 + (e_min - d22)*V1;\n\t\t}\n\t\ta = 1.0 / e_max;\n\t\tb = 1.0 / e_min;\n\t\tV1 = normalize(V1_);\n\t\tV2 = normalize(V2_);\n\t}\n\telse\n\t{\n\t\ta = 1.0 / dot(V1, V1);\n\t\tb = 1.0 / dot(V2, V2);\n\t\tV1 *= sqrt(a);\n\t\tV2 *= sqrt(b);\n\t}\n\tvec3 V3 = normalize(cross(V1, V2));\n\tif (dot(C, V3) < 0.0)\n\t\tV3 *= -1.0;\n\tfloat L  = dot(V3, C);\n\tfloat x0 = dot(V1, C) / L;\n\tfloat y0 = dot(V2, C) / L;\n\tfloat E1 = inversesqrt(a);\n\tfloat E2 = inversesqrt(b);\n\ta *= L * L;\n\tb *= L * L;\n\tfloat c0 = a * b;\n\tfloat c1 = a * b * (1.0 + x0 * x0 + y0 * y0) - a - b;\n\tfloat c2 = 1.0 - a * (1.0 + x0 * x0) - b * (1.0 + y0 * y0);\n\tfloat c3 = 1.0;\n\tvec3 roots = SolveCubic(vec4(c0, c1, c2, c3));\n\tfloat e1 = roots.x;\n\tfloat e2 = roots.y;\n\tfloat e3 = roots.z;\n\tvec3 avgDir = vec3(a * x0 / (a - e2), b * y0 / (b - e2), 1.0);\n\tmat3 rotate = mat3(V1, V2, V3);\n\tavgDir = rotate * avgDir;\n\tavgDir = normalize(avgDir);\n\tfloat L1 = sqrt(-e2 / e3);\n\tfloat L2 = sqrt(-e2 / e1);\n\tfloat formFactor = max(0.0, L1 * L2 * inversesqrt((1.0 + L1 * L1) * (1.0 + L2 * L2)));\n\t\n\tconst float LUT_SIZE = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\tvec2 uv = vec2(avgDir.z * 0.5 + 0.5, formFactor);\n\tuv = uv*LUT_SCALE + LUT_BIAS;\n\tfloat scale = texture2DLod(areaLightsLutTex2, uv, 0.0).w;\n\treturn formFactor*scale;\n}\nfloat FixNan(float value) {\n\t#ifdef WEBGPU\n\t\treturn value != value ? 0.0 : value;\n\t#else\n\t\treturn isnan(value) ? 0.0 : value;\n\t#endif\n}\nfloat getRectLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDir, vec3 lightDirNorm) {\n\treturn LTC_EvaluateRect( worldNormal, viewDir, vPositionW, mat3( 1.0 ), dLTCCoords );\n}\nfloat getDiskLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDir, vec3 lightDirNorm) {\n\treturn FixNan(LTC_EvaluateDisk( worldNormal, viewDir, vPositionW, mat3( 1.0 ), dLTCCoords ));\n}\nfloat getSphereLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDir, vec3 lightDirNorm) {\n\tfloat falloff = dSphereRadius / (dot(lightDir, lightDir) + dSphereRadius);\n\treturn FixNan(getLightDiffuse(worldNormal, viewDir, lightDirNorm) * falloff);\n}\nmat3 getLTCLightInvMat(vec2 uv)\n{\n\tvec4 t1 = texture2DLod(areaLightsLutTex1, uv, 0.0);\n\treturn mat3(\n\t\tvec3( t1.x, 0, t1.y ),\n\t\tvec3(\t0, 1,\t0 ),\n\t\tvec3( t1.z, 0, t1.w )\n\t);\n}\nfloat calcRectLightSpecular(vec3 worldNormal, vec3 viewDir, vec2 uv) {\n\tmat3 mInv = getLTCLightInvMat(uv);\n\treturn LTC_EvaluateRect( worldNormal, viewDir, vPositionW, mInv, dLTCCoords );\n}\nfloat getRectLightSpecular(vec3 worldNormal, vec3 viewDir) {\n\treturn calcRectLightSpecular(worldNormal, viewDir, dLTCUV);\n}\nfloat calcDiskLightSpecular(vec3 worldNormal, vec3 viewDir, vec2 uv) {\n\tmat3 mInv = getLTCLightInvMat(uv);\n\treturn LTC_EvaluateDisk( worldNormal, viewDir, vPositionW, mInv, dLTCCoords );\n}\nfloat getDiskLightSpecular(vec3 worldNormal, vec3 viewDir) {\n\treturn calcDiskLightSpecular(worldNormal, viewDir, dLTCUV);\n}\nfloat getSphereLightSpecular(vec3 worldNormal, vec3 viewDir) {\n\treturn calcDiskLightSpecular(worldNormal, viewDir, dLTCUV);\n}\n",metalnessPS:"\n#ifdef STD_METALNESS_CONSTANT\nuniform float material_metalness;\n#endif\nvoid getMetalness() {\n\tfloat metalness = 1.0;\n\t#ifdef STD_METALNESS_CONSTANT\n\tmetalness *= material_metalness;\n\t#endif\n\t#ifdef STD_METALNESS_TEXTURE\n\tmetalness *= texture2DBias({STD_METALNESS_TEXTURE_NAME}, {STD_METALNESS_TEXTURE_UV}, textureBias).{STD_METALNESS_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_METALNESS_VERTEX\n\tmetalness *= saturate(vVertexColor.{STD_METALNESS_VERTEX_CHANNEL});\n\t#endif\n\tdMetalness = metalness;\n}\n",metalnessModulatePS:"\nvec3 getSpecularModulate(in vec3 specularity, in vec3 albedo, in float metalness, in float f0) {\n\tvec3 dielectricF0 = f0 * specularity;\n\treturn mix(dielectricF0, albedo, metalness);\n}\nvec3 getAlbedoModulate(in vec3 albedo, in float metalness) {\n\treturn albedo * (1.0 - metalness);\n}\n",morphPS:"\n\tvarying vec2 uv0;\n\tuniform sampler2DArray morphTexture;\n\tuniform highp float morphFactor[{MORPH_TEXTURE_MAX_COUNT}];\n\tuniform highp uint morphIndex[{MORPH_TEXTURE_MAX_COUNT}];\n\tuniform int count;\n\t#ifdef MORPH_INT\n\t\tuniform vec3 aabbSize;\n\t\tuniform vec3 aabbMin;\n\t#endif\n\tvoid main (void) {\n\t\thighp vec3 color = vec3(0, 0, 0);\n\t\tivec2 pixelCoords = ivec2(uv0 * vec2(textureSize(morphTexture, 0).xy));\n\t\t\n\t\tfor (int i = 0; i < count; i++) {\n\t\t\tuint textureIndex = morphIndex[i];\n\t\t\tvec3 delta = texelFetch(morphTexture, ivec3(pixelCoords, int(textureIndex)), 0).xyz;\n\t\t\tcolor += morphFactor[i] * delta;\n\t\t}\n\t\t#ifdef MORPH_INT\n\t\t\tcolor = (color - aabbMin) / aabbSize * 65535.0;\n\t\t\tgl_FragColor = uvec4(color, 1u);\n\t\t#else\n\t\t\tgl_FragColor = vec4(color, 1.0);\n\t\t#endif\n\t}\n",morphVS:"\n\tattribute vec2 vertex_position;\n\tvarying vec2 uv0;\n\tvoid main(void) {\n\t\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\t\tuv0 = vertex_position.xy * 0.5 + 0.5;\n\t}\n",msdfPS:"\nuniform sampler2D texture_msdfMap;\nfloat median(float r, float g, float b) {\n\treturn max(min(r, g), min(max(r, g), b));\n}\nfloat map (float min, float max, float v) {\n\treturn (v - min) / (max - min);\n}\nuniform float font_sdfIntensity;\nuniform float font_pxrange;\nuniform float font_textureWidth;\n#ifndef LIT_MSDF_TEXT_ATTRIBUTE\n\tuniform vec4 outline_color;\n\tuniform float outline_thickness;\n\tuniform vec4 shadow_color;\n\tuniform vec2 shadow_offset;\n#else\n\tvarying vec4 outline_color;\n\tvarying float outline_thickness;\n\tvarying vec4 shadow_color;\n\tvarying vec2 shadow_offset;\n#endif\nvec4 applyMsdf(vec4 color) {\n\tcolor.rgb = gammaCorrectInput(color.rgb);\n\tvec3 tsample = texture2D(texture_msdfMap, vUv0).rgb;\n\tvec2 uvShdw = vUv0 - shadow_offset;\n\tvec3 ssample = texture2D(texture_msdfMap, uvShdw).rgb;\n\tfloat sigDist = median(tsample.r, tsample.g, tsample.b);\n\tfloat sigDistShdw = median(ssample.r, ssample.g, ssample.b);\n\tfloat smoothingMax = 0.2;\n\tvec2 w = fwidth(vUv0);\n\tfloat smoothing = clamp(w.x * font_textureWidth / font_pxrange, 0.0, smoothingMax);\n\tfloat mapMin = 0.05;\n\tfloat mapMax = clamp(1.0 - font_sdfIntensity, mapMin, 1.0);\n\tfloat sigDistInner = map(mapMin, mapMax, sigDist);\n\tfloat sigDistOutline = map(mapMin, mapMax, sigDist + outline_thickness);\n\tsigDistShdw = map(mapMin, mapMax, sigDistShdw + outline_thickness);\n\tfloat center = 0.5;\n\tfloat inside = smoothstep(center-smoothing, center+smoothing, sigDistInner);\n\tfloat outline = smoothstep(center-smoothing, center+smoothing, sigDistOutline);\n\tfloat shadow = smoothstep(center-smoothing, center+smoothing, sigDistShdw);\n\tvec4 tcolor = (outline > inside) ? outline * vec4(outline_color.a * outline_color.rgb, outline_color.a) : vec4(0.0);\n\ttcolor = mix(tcolor, color, inside);\n\tvec4 scolor = (shadow > outline) ? shadow * vec4(shadow_color.a * shadow_color.rgb, shadow_color.a) : tcolor;\n\ttcolor = mix(scolor, tcolor, outline);\n\ttcolor.rgb = gammaCorrectOutput(tcolor.rgb);\n\t\n\treturn tcolor;\n}\n",msdfVS:"\nattribute vec3 vertex_outlineParameters;\nattribute vec3 vertex_shadowParameters;\nvarying vec4 outline_color;\nvarying float outline_thickness;\nvarying vec4 shadow_color;\nvarying vec2 shadow_offset;\nvoid unpackMsdfParams() {\n\tvec3 little = mod(vertex_outlineParameters, 256.);\n\tvec3 big = (vertex_outlineParameters - little) / 256.;\n\toutline_color.rb = little.xy / 255.;\n\toutline_color.ga = big.xy / 255.;\n\toutline_thickness = little.z / 255. * 0.2;\n\tlittle = mod(vertex_shadowParameters, 256.);\n\tbig = (vertex_shadowParameters - little) / 256.;\n\tshadow_color.rb = little.xy / 255.;\n\tshadow_color.ga = big.xy / 255.;\n\tshadow_offset = (vec2(little.z, big.z) / 127. - 1.) * 0.005;\n}\n",normalVS:"\nmat3 dNormalMatrix;\nvec3 getNormal() {\n\tdNormalMatrix = getNormalMatrix(dModelMatrix);\n\tvec3 localNormal = getLocalNormal(vertex_normal);\n\treturn normalize(dNormalMatrix * localNormal);\n}\n",normalCoreVS:"\nattribute vec3 vertex_normal;\nuniform mat3 matrix_normal;\n#ifdef MORPHING_NORMAL\n\t#ifdef MORPHING_INT\n\t\tuniform highp usampler2D morphNormalTex;\n\t#else\n\t\tuniform highp sampler2D morphNormalTex;\n\t#endif\n#endif\nvec3 getLocalNormal(vec3 vertexNormal) {\n\tvec3 localNormal = vertex_normal;\n\t#ifdef MORPHING_NORMAL\n\t\tivec2 morphUV = getTextureMorphCoords();\n\t\t#ifdef MORPHING_INT\n\t\t\tvec3 morphNormal = vec3(texelFetch(morphNormalTex, ivec2(morphUV), 0).xyz) / 65535.0 * 2.0 - 1.0;\n\t\t#else\n\t\t\tvec3 morphNormal = texelFetch(morphNormalTex, ivec2(morphUV), 0).xyz;\n\t\t#endif\n\t\tlocalNormal += morphNormal;\n\t#endif\n\treturn localNormal;\n}\n#if defined(SKIN) || defined(BATCH)\n\tmat3 getNormalMatrix(mat4 modelMatrix) {\n\t\treturn mat3(modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz);\n\t}\n#elif defined(INSTANCING)\n\tmat3 getNormalMatrix(mat4 modelMatrix) {\n\t\treturn mat3(modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz);\n\t}\n#else\n\tmat3 getNormalMatrix(mat4 modelMatrix) {\n\t\treturn matrix_normal;\n\t}\n#endif\n",normalMapPS:"\n#ifdef STD_NORMAL_TEXTURE\n\tuniform float material_bumpiness;\n#endif\n#ifdef STD_NORMALDETAIL_TEXTURE\n\tuniform float material_normalDetailMapBumpiness;\n\tvec3 blendNormals(vec3 n1, vec3 n2) {\n\t\tn1 += vec3(0, 0, 1);\n\t\tn2 *= vec3(-1, -1, 1);\n\t\treturn n1 * dot(n1, n2) / n1.z - n2;\n\t}\n#endif\nvoid getNormal() {\n#ifdef STD_NORMAL_TEXTURE\n\tvec3 normalMap = {STD_NORMAL_TEXTURE_DECODE}(texture2DBias({STD_NORMAL_TEXTURE_NAME}, {STD_NORMAL_TEXTURE_UV}, textureBias));\n\tnormalMap = mix(vec3(0.0, 0.0, 1.0), normalMap, material_bumpiness);\n\t#ifdef STD_NORMALDETAIL_TEXTURE\n\t\tvec3 normalDetailMap = {STD_NORMALDETAIL_TEXTURE_DECODE}(texture2DBias({STD_NORMALDETAIL_TEXTURE_NAME}, {STD_NORMALDETAIL_TEXTURE_UV}, textureBias));\n\t\tnormalDetailMap = mix(vec3(0.0, 0.0, 1.0), normalDetailMap, material_normalDetailMapBumpiness);\n\t\tnormalMap = blendNormals(normalMap, normalDetailMap);\n\t#endif\n\tdNormalW = normalize(dTBN * normalMap);\n#else\n\tdNormalW = dVertexNormalW;\n#endif\n}\n",opacityPS:"\nuniform float material_opacity;\nvoid getOpacity() {\n\tdAlpha = material_opacity;\n\t#ifdef STD_OPACITY_TEXTURE\n\tdAlpha *= texture2DBias({STD_OPACITY_TEXTURE_NAME}, {STD_OPACITY_TEXTURE_UV}, textureBias).{STD_OPACITY_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_OPACITY_VERTEX\n\tdAlpha *= clamp(vVertexColor.{STD_OPACITY_VERTEX_CHANNEL}, 0.0, 1.0);\n\t#endif\n}\n",opacityDitherPS:'\n#if STD_OPACITY_DITHER == BAYER8\n\t#include "bayerPS"\n#endif\nuniform vec4 blueNoiseJitter;\n#if STD_OPACITY_DITHER == BLUENOISE\n\tuniform sampler2D blueNoiseTex32;\n#endif\nvoid opacityDither(float alpha, float id) {\n\t#if STD_OPACITY_DITHER == BAYER8\n\t\tfloat noise = bayer8(floor(mod(gl_FragCoord.xy + blueNoiseJitter.xy + id, 8.0))) / 64.0;\n\t#else\n\t\t#if STD_OPACITY_DITHER == BLUENOISE\n\t\t\tvec2 uv = fract(gl_FragCoord.xy / 32.0 + blueNoiseJitter.xy + id);\n\t\t\tfloat noise = texture2DLod(blueNoiseTex32, uv, 0.0).y;\n\t\t#endif\n\t\t#if STD_OPACITY_DITHER == IGNNOISE\n\t\t\tvec3 magic = vec3(0.06711056, 0.00583715, 52.9829189);\n\t\t\tfloat noise = fract(magic.z * fract(dot(gl_FragCoord.xy + blueNoiseJitter.xy + id, magic.xy)));\n\t\t#endif\n\t#endif\n\tnoise = pow(noise, 2.2);\n\tif (alpha < noise)\n\t\tdiscard;\n}\n',outputPS:"\n",outputAlphaPS:"\n#if LIT_BLEND_TYPE == NORMAL || LIT_BLEND_TYPE == ADDITIVEALPHA || defined(LIT_ALPHA_TO_COVERAGE)\n\tgl_FragColor.a = litArgs_opacity;\n#elif LIT_BLEND_TYPE == PREMULTIPLIED\n\tgl_FragColor.rgb *= litArgs_opacity;\n\tgl_FragColor.a = litArgs_opacity;\n#else\n\tgl_FragColor.a = 1.0;\n#endif\n",packHalfPS:"\n#if defined(PLATFORM_ANDROID)\n\tuint floatToHalf(float a) {\n\t\tuint u\t= floatBitsToUint(a);\n\t\tuint sign = (u >> 16u) & 0x8000u;\n\t\tuint absu = u & 0x7FFFFFFFu;\n\t\tuint man  = u & 0x007FFFFFu;\n\t\tint  e32  = int((u >> 23u) & 0xFFu) - 127;\n\t\t\n\t\tif ((absu & 0x7F800000u) == 0x7F800000u) {\n\t\t\tbool isnan = (man != 0u);\n\t\t\treturn sign | (isnan ? 0x7E00u : 0x7C00u);\n\t\t}\n\t\t\n\t\tif (e32 > 15) return sign | 0x7C00u;\n\t\t\n\t\tif (e32 >= -14) {\n\t\t\tuint he  = uint(e32 + 15);\n\t\t\tuint hm  = man >> 13u;\n\t\t\tuint rem = man & 0x1FFFu;\n\t\t\tuint add = (rem > 0x1000u || (rem == 0x1000u && (hm & 1u) == 1u)) ? 1u : 0u;\n\t\t\thm = (hm + add) & 0x3FFu;\n\t\t\tif ((hm & 0x400u) != 0u) {\n\t\t\t\thm = 0u; he = he + 1u;\n\t\t\t\tif (he >= 31u) return sign | 0x7C00u;\n\t\t\t}\n\t\t\treturn sign | (he << 10u) | hm;\n\t\t}\n\t\t\n\t\tif (e32 >= -24) {\n\t\t\tuint s\t  = uint(-(e32 + 1));\n\t\t\tuint mnorm  = 0x00800000u | man;\n\t\t\tuint hm\t = mnorm >> s;\n\t\t\tuint mask   = (1u << s) - 1u;\n\t\t\tuint rem\t= mnorm & mask;\n\t\t\tuint halfBt = 1u << (s - 1u);\n\t\t\tuint add\t= (rem > halfBt || (rem == halfBt && (hm & 1u) == 1u)) ? 1u : 0u;\n\t\t\thm = hm + add;\n\t\t\tif (hm >= 0x400u) return sign | (1u << 10u);\n\t\t\treturn sign | hm;\n\t\t}\n\t\t\n\t\treturn sign;\n\t}\n\tuint packHalf2x16Safe(vec2 v) {\n\t\tuint u_x  = floatBitsToUint(v.x);\n\t\tuint u_y  = floatBitsToUint(v.y);\n\t\t\n\t\tint  e32_x = int((u_x >> 23u) & 0xFFu) - 127;\n\t\tint  e32_y = int((u_y >> 23u) & 0xFFu) - 127;\n\t\t\n\t\tif (e32_x < -14 || e32_y < -14) {\n\t\t\treturn (floatToHalf(v.y) << 16u) | floatToHalf(v.x);\n\t\t}\n\t\t\n\t\treturn packHalf2x16(v);\n\t}\n#else\n\tuint packHalf2x16Safe(vec2 v) {\n\t\treturn packHalf2x16(v);\n\t}\n#endif\n",outputTex2DPS:"\nvarying vec2 vUv0;\nuniform sampler2D source;\nvoid main(void) {\n\tgl_FragColor = texture2D(source, vUv0);\n}\n",sheenPS:"\nuniform vec3 material_sheen;\nvoid getSheen() {\n\tvec3 sheenColor = material_sheen;\n\t#ifdef STD_SHEEN_TEXTURE\n\tsheenColor *= {STD_SHEEN_TEXTURE_DECODE}(texture2DBias({STD_SHEEN_TEXTURE_NAME}, {STD_SHEEN_TEXTURE_UV}, textureBias)).{STD_SHEEN_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_SHEEN_VERTEX\n\tsheenColor *= saturate(vVertexColor.{STD_SHEEN_VERTEX_CHANNEL});\n\t#endif\n\tsSpecularity = sheenColor;\n}\n",sheenGlossPS:"\nuniform float material_sheenGloss;\nvoid getSheenGlossiness() {\n\tfloat sheenGlossiness = material_sheenGloss;\n\t#ifdef STD_SHEENGLOSS_TEXTURE\n\tsheenGlossiness *= texture2DBias({STD_SHEENGLOSS_TEXTURE_NAME}, {STD_SHEENGLOSS_TEXTURE_UV}, textureBias).{STD_SHEENGLOSS_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_SHEENGLOSS_VERTEX\n\tsheenGlossiness *= saturate(vVertexColor.{STD_SHEENGLOSS_VERTEX_CHANNEL});\n\t#endif\n\t#ifdef STD_SHEENGLOSS_INVERT\n\tsheenGlossiness = 1.0 - sheenGlossiness;\n\t#endif\n\tsGlossiness = sheenGlossiness + 0.0000001;\n}\n",parallaxPS:"\nuniform float material_heightMapFactor;\nvoid getParallax() {\n\tfloat parallaxScale = material_heightMapFactor;\n\tfloat height = texture2DBias({STD_HEIGHT_TEXTURE_NAME}, {STD_HEIGHT_TEXTURE_UV}, textureBias).{STD_HEIGHT_TEXTURE_CHANNEL};\n\theight = height * parallaxScale - parallaxScale * 0.5;\n\tvec3 viewDirT = dViewDirW * dTBN;\n\tviewDirT.z += 0.42;\n\tdUvOffset = height * (viewDirT.xy / viewDirT.z);\n}\n",pickPS:'\nuniform uint meshInstanceId;\nvec4 getPickOutput() {\n\tconst vec4 inv = vec4(1.0 / 255.0);\n\tconst uvec4 shifts = uvec4(16, 8, 0, 24);\n\tuvec4 col = (uvec4(meshInstanceId) >> shifts) & uvec4(0xff);\n\treturn vec4(col) * inv;\n}\n#ifdef DEPTH_PICK_PASS\n\t#include "floatAsUintPS"\n\tvec4 getPickDepth() {\n\t\treturn float2uint(gl_FragCoord.z);\n\t}\n#endif\n',reflDirPS:"\nvoid getReflDir(vec3 worldNormal, vec3 viewDir, float gloss, mat3 tbn) {\n\tdReflDirW = normalize(-reflect(viewDir, worldNormal));\n}\n",reflDirAnisoPS:"\nvoid getReflDir(vec3 worldNormal, vec3 viewDir, float gloss, mat3 tbn) {\n\tfloat roughness = sqrt(1.0 - min(gloss, 1.0));\n\tvec2 direction = dAnisotropyRotation;\n\tvec3 anisotropicT = normalize(tbn * vec3(direction, 0.0));\n\tvec3 anisotropicB = normalize(cross(tbn[2], anisotropicT));\n\tfloat anisotropy = dAnisotropy;\n\tvec3 anisotropicDirection = anisotropicB;\n\tvec3 anisotropicTangent = cross(anisotropicDirection, viewDir);\n\tvec3 anisotropicNormal = cross(anisotropicTangent, anisotropicDirection);\n\tfloat bendFactor = 1.0 - anisotropy * (1.0 - roughness);\n\tfloat bendFactor4 = bendFactor * bendFactor * bendFactor * bendFactor;\n\tvec3 bentNormal = normalize(mix(normalize(anisotropicNormal), normalize(worldNormal), bendFactor4));\n\tdReflDirW = reflect(-viewDir, bentNormal);\n}\n",reflectionCCPS:"\n#ifdef LIT_CLEARCOAT\nvoid addReflectionCC(vec3 reflDir, float gloss) {\n\tccReflection += calcReflection(reflDir, gloss);\n}\n#endif\n",reflectionCubePS:"\nuniform samplerCube texture_cubeMap;\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 reflDir, float gloss) {\n\tvec3 lookupVec = cubeMapProject(reflDir);\n\tlookupVec.x *= -1.0;\n\treturn {reflectionDecode}(textureCube(texture_cubeMap, lookupVec));\n}\nvoid addReflection(vec3 reflDir, float gloss) {   \n\tdReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);\n}\n",reflectionEnvHQPS:"\n#ifndef ENV_ATLAS\n\t#define ENV_ATLAS\n\tuniform sampler2D texture_envAtlas;\n#endif\nuniform samplerCube texture_cubeMap;\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 reflDir, float gloss) {\n\tvec3 dir = cubeMapProject(reflDir) * vec3(-1.0, 1.0, 1.0);\n\tvec2 uv = toSphericalUv(dir);\n\tfloat level = saturate(1.0 - gloss) * 5.0;\n\tfloat ilevel = floor(level);\n\tfloat flevel = level - ilevel;\n\tvec3 sharp = {reflectionCubemapDecode}(textureCube(texture_cubeMap, dir));\n\tvec3 roughA = {reflectionDecode}(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel)));\n\tvec3 roughB = {reflectionDecode}(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel + 1.0)));\n\treturn processEnvironment(mix(sharp, mix(roughA, roughB, flevel), min(level, 1.0)));\n}\nvoid addReflection(vec3 reflDir, float gloss) {   \n\tdReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);\n}\n",reflectionEnvPS:"\n#ifndef ENV_ATLAS\n#define ENV_ATLAS\n\tuniform sampler2D texture_envAtlas;\n#endif\nuniform float material_reflectivity;\nfloat shinyMipLevel(vec2 uv) {\n\tvec2 dx = dFdx(uv);\n\tvec2 dy = dFdy(uv);\n\tvec2 uv2 = vec2(fract(uv.x + 0.5), uv.y);\n\tvec2 dx2 = dFdx(uv2);\n\tvec2 dy2 = dFdy(uv2);\n\tfloat maxd = min(max(dot(dx, dx), dot(dy, dy)), max(dot(dx2, dx2), dot(dy2, dy2)));\n\treturn clamp(0.5 * log2(maxd) - 1.0 + textureBias, 0.0, 5.0);\n}\nvec3 calcReflection(vec3 reflDir, float gloss) {\n\tvec3 dir = cubeMapProject(reflDir) * vec3(-1.0, 1.0, 1.0);\n\tvec2 uv = toSphericalUv(dir);\n\tfloat level = saturate(1.0 - gloss) * 5.0;\n\tfloat ilevel = floor(level);\n\tfloat level2 = shinyMipLevel(uv * atlasSize);\n\tfloat ilevel2 = floor(level2);\n\tvec2 uv0, uv1;\n\tfloat weight;\n\tif (ilevel == 0.0) {\n\t\tuv0 = mapShinyUv(uv, ilevel2);\n\t\tuv1 = mapShinyUv(uv, ilevel2 + 1.0);\n\t\tweight = level2 - ilevel2;\n\t} else {\n\t\tuv0 = uv1 = mapRoughnessUv(uv, ilevel);\n\t\tweight = 0.0;\n\t}\n\tvec3 linearA = {reflectionDecode}(texture2D(texture_envAtlas, uv0));\n\tvec3 linearB = {reflectionDecode}(texture2D(texture_envAtlas, uv1));\n\tvec3 linear0 = mix(linearA, linearB, weight);\n\tvec3 linear1 = {reflectionDecode}(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel + 1.0)));\n\treturn processEnvironment(mix(linear0, linear1, level - ilevel));\n}\nvoid addReflection(vec3 reflDir, float gloss) {   \n\tdReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);\n}\n",reflectionSpherePS:"\n#ifndef VIEWMATRIX\n\t#define VIEWMATRIX\n\tuniform mat4 matrix_view;\n#endif\nuniform sampler2D texture_sphereMap;\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 reflDir, float gloss) {\n\tvec3 reflDirV = (mat3(matrix_view) * reflDir);\n\tfloat m = 2.0 * sqrt(dot(reflDirV.xy, reflDirV.xy) + (reflDirV.z + 1.0) * (reflDirV.z + 1.0));\n\tvec2 sphereMapUv = reflDirV.xy / m + 0.5;\n\treturn {reflectionDecode}(texture2D(texture_sphereMap, sphereMapUv));\n}\nvoid addReflection(vec3 reflDir, float gloss) {   \n\tdReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);\n}\n",reflectionSheenPS:"\nvoid addReflectionSheen(vec3 worldNormal, vec3 viewDir, float gloss) {\n\tfloat NoV = dot(worldNormal, viewDir);\n\tfloat alphaG = gloss * gloss;\n\tfloat a = gloss < 0.25 ? -339.2 * alphaG + 161.4 * gloss - 25.9 : -8.48 * alphaG + 14.3 * gloss - 9.95;\n\tfloat b = gloss < 0.25 ? 44.0 * alphaG - 23.7 * gloss + 3.26 : 1.97 * alphaG - 3.27 * gloss + 0.72;\n\tfloat DG = exp( a * NoV + b ) + ( gloss < 0.25 ? 0.0 : 0.1 * ( gloss - 0.25 ) );\n\tsReflection += calcReflection(worldNormal, 0.0) * saturate(DG);\n}\n",refractionCubePS:"\nvec3 refract2(vec3 viewVec, vec3 normal, float IOR) {\n\tfloat vn = dot(viewVec, normal);\n\tfloat k = 1.0 - IOR * IOR * (1.0 - vn * vn);\n\tvec3 refrVec = IOR * viewVec - (IOR * vn + sqrt(k)) * normal;\n\treturn refrVec;\n}\nvoid addRefraction(\n\tvec3 worldNormal, \n\tvec3 viewDir, \n\tfloat thickness, \n\tfloat gloss, \n\tvec3 specularity, \n\tvec3 albedo, \n\tfloat transmission,\n\tfloat refractionIndex,\n\tfloat dispersion\n#if defined(LIT_IRIDESCENCE)\n\t, vec3 iridescenceFresnel,\n\tfloat iridescenceIntensity\n#endif \n) {\n\tvec4 tmpRefl = dReflection;\n\tvec3 reflectionDir = refract2(-viewDir, worldNormal, refractionIndex);\n\tdReflection = vec4(0);\n\taddReflection(reflectionDir, gloss);\n\tdDiffuseLight = mix(dDiffuseLight, dReflection.rgb * albedo, transmission);\n\tdReflection = tmpRefl;\n}\n",refractionDynamicPS:"\nuniform float material_invAttenuationDistance;\nuniform vec3 material_attenuation;\nvec3 evalRefractionColor(vec3 refractionVector, float gloss, float refractionIndex) {\n\tvec4 pointOfRefraction = vec4(vPositionW + refractionVector, 1.0);\n\tvec4 projectionPoint = matrix_viewProjection * pointOfRefraction;\n\tvec2 uv = getGrabScreenPos(projectionPoint);\n\tfloat iorToRoughness = (1.0 - gloss) * clamp((1.0 / refractionIndex) * 2.0 - 2.0, 0.0, 1.0);\n\tfloat refractionLod = log2(uScreenSize.x) * iorToRoughness;\n\tvec3 refraction = texture2DLod(uSceneColorMap, uv, refractionLod).rgb;\n\t#ifdef SCENE_COLORMAP_GAMMA\n\t\trefraction = decodeGamma(refraction);\n\t#endif\n\treturn refraction;\n}\nvoid addRefraction(\n\tvec3 worldNormal, \n\tvec3 viewDir, \n\tfloat thickness, \n\tfloat gloss, \n\tvec3 specularity, \n\tvec3 albedo, \n\tfloat transmission,\n\tfloat refractionIndex,\n\tfloat dispersion\n#if defined(LIT_IRIDESCENCE)\n\t, vec3 iridescenceFresnel,\n\tfloat iridescenceIntensity\n#endif\n) {\n\tvec3 modelScale;\n\tmodelScale.x = length(vec3(matrix_model[0].xyz));\n\tmodelScale.y = length(vec3(matrix_model[1].xyz));\n\tmodelScale.z = length(vec3(matrix_model[2].xyz));\n\tvec3 scale = thickness * modelScale;\n\tvec3 refractionVector = normalize(refract(-viewDir, worldNormal, refractionIndex)) * scale;\n\tvec3 refraction = evalRefractionColor(refractionVector, gloss, refractionIndex);\n\t#ifdef LIT_DISPERSION\n\t\tfloat halfSpread = (1.0 / refractionIndex - 1.0) * 0.025 * dispersion;\n\t\tfloat refractionIndexR = refractionIndex - halfSpread;\n\t\trefractionVector = normalize(refract(-viewDir, worldNormal, refractionIndexR)) * scale;\n\t\trefraction.r = evalRefractionColor(refractionVector, gloss, refractionIndexR).r;\n\t\tfloat refractionIndexB = refractionIndex + halfSpread;\n\t\trefractionVector = normalize(refract(-viewDir, worldNormal, refractionIndexB)) * scale;\n\t\trefraction.b = evalRefractionColor(refractionVector, gloss, refractionIndexB).b;\n\t#endif\n\tvec3 transmittance;\n\tif (material_invAttenuationDistance != 0.0)\n\t{\n\t\tvec3 attenuation = -log(material_attenuation) * material_invAttenuationDistance;\n\t\ttransmittance = exp(-attenuation * length(refractionVector));\n\t}\n\telse\n\t{\n\t\ttransmittance = vec3(1.0);\n\t}\n\tvec3 fresnel = vec3(1.0) - \n\t\tgetFresnel(\n\t\t\tdot(viewDir, worldNormal), \n\t\t\tgloss, \n\t\t\tspecularity\n\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t, iridescenceFresnel,\n\t\t\tiridescenceIntensity\n\t\t#endif\n\t\t);\n\tdDiffuseLight = mix(dDiffuseLight, refraction * transmittance * fresnel, transmission);\n}\n",reprojectPS:'\nvarying vec2 vUv0;\n#ifdef CUBEMAP_SOURCE\n\tuniform samplerCube sourceCube;\n#else\n\tuniform sampler2D sourceTex;\n#endif\n#ifdef USE_SAMPLES_TEX\n\tuniform sampler2D samplesTex;\n\tuniform vec2 samplesTexInverseSize;\n#endif\nuniform vec3 params;\nfloat targetFace() { return params.x; }\nfloat targetTotalPixels() { return params.y; }\nfloat sourceTotalPixels() { return params.z; }\nfloat PI = 3.141592653589793;\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\n#include "decodePS"\n#include "encodePS"\nvec3 modifySeams(vec3 dir, float scale) {\n\tvec3 adir = abs(dir);\n\tfloat M = max(max(adir.x, adir.y), adir.z);\n\treturn dir / M * vec3(\n\t\tadir.x == M ? 1.0 : scale,\n\t\tadir.y == M ? 1.0 : scale,\n\t\tadir.z == M ? 1.0 : scale\n\t);\n}\nvec2 toSpherical(vec3 dir) {\n\treturn vec2(dir.xz == vec2(0.0) ? 0.0 : atan(dir.x, dir.z), asin(dir.y));\n}\nvec3 fromSpherical(vec2 uv) {\n\treturn vec3(cos(uv.y) * sin(uv.x),\n\t\t\t\tsin(uv.y),\n\t\t\t\tcos(uv.y) * cos(uv.x));\n}\nvec3 getDirectionEquirect() {\n\treturn fromSpherical((vec2(vUv0.x, 1.0 - vUv0.y) * 2.0 - 1.0) * vec2(PI, PI * 0.5));\n}\nfloat signNotZero(float k){\n\treturn(k >= 0.0) ? 1.0 : -1.0;\n}\nvec2 signNotZero(vec2 v) {\n\treturn vec2(signNotZero(v.x), signNotZero(v.y));\n}\nvec3 octDecode(vec2 o) {\n\tvec3 v = vec3(o.x, 1.0 - abs(o.x) - abs(o.y), o.y);\n\tif (v.y < 0.0) {\n\t\tv.xz = (1.0 - abs(v.zx)) * signNotZero(v.xz);\n\t}\n\treturn normalize(v);\n}\nvec3 getDirectionOctahedral() {\n\treturn octDecode(vec2(vUv0.x, 1.0 - vUv0.y) * 2.0 - 1.0);\n}\nvec2 octEncode(in vec3 v) {\n\tfloat l1norm = abs(v.x) + abs(v.y) + abs(v.z);\n\tvec2 result = v.xz * (1.0 / l1norm);\n\tif (v.y < 0.0) {\n\t\tresult = (1.0 - abs(result.yx)) * signNotZero(result.xy);\n\t}\n\treturn result;\n}\n#ifdef CUBEMAP_SOURCE\n\tvec4 sampleCubemap(vec3 dir) {\n\t\treturn textureCube(sourceCube, modifySeams(dir, 1.0));\n\t}\n\tvec4 sampleCubemap(vec2 sph) {\n\t\treturn sampleCubemap(fromSpherical(sph));\n\t}\n\tvec4 sampleCubemap(vec3 dir, float mipLevel) {\n\t\treturn textureCubeLod(sourceCube, modifySeams(dir, 1.0), mipLevel);\n\t}\n\tvec4 sampleCubemap(vec2 sph, float mipLevel) {\n\t\treturn sampleCubemap(fromSpherical(sph), mipLevel);\n\t}\n#else\n\tvec4 sampleEquirect(vec2 sph) {\n\t\tvec2 uv = sph / vec2(PI * 2.0, PI) + 0.5;\n\t\treturn texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));\n\t}\n\tvec4 sampleEquirect(vec3 dir) {\n\t\treturn sampleEquirect(toSpherical(dir));\n\t}\n\tvec4 sampleEquirect(vec2 sph, float mipLevel) {\n\t\tvec2 uv = sph / vec2(PI * 2.0, PI) + 0.5;\n\t\treturn texture2DLod(sourceTex, vec2(uv.x, 1.0 - uv.y), mipLevel);\n\t}\n\tvec4 sampleEquirect(vec3 dir, float mipLevel) {\n\t\treturn sampleEquirect(toSpherical(dir), mipLevel);\n\t}\n\tvec4 sampleOctahedral(vec3 dir) {\n\t\tvec2 uv = octEncode(dir) * 0.5 + 0.5;\n\t\treturn texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));\n\t}\n\tvec4 sampleOctahedral(vec2 sph) {\n\t\treturn sampleOctahedral(fromSpherical(sph));\n\t}\n\tvec4 sampleOctahedral(vec3 dir, float mipLevel) {\n\t\tvec2 uv = octEncode(dir) * 0.5 + 0.5;\n\t\treturn texture2DLod(sourceTex, vec2(uv.x, 1.0 - uv.y), mipLevel);\n\t}\n\tvec4 sampleOctahedral(vec2 sph, float mipLevel) {\n\t\treturn sampleOctahedral(fromSpherical(sph), mipLevel);\n\t}\n#endif\nvec3 getDirectionCubemap() {\n\tvec2 st = vUv0 * 2.0 - 1.0;\n\tfloat face = targetFace();\n\tvec3 vec;\n\tif (face == 0.0) {\n\t\tvec = vec3(1, -st.y, -st.x);\n\t} else if (face == 1.0) {\n\t\tvec = vec3(-1, -st.y, st.x);\n\t} else if (face == 2.0) {\n\t\tvec = vec3(st.x, 1, st.y);\n\t} else if (face == 3.0) {\n\t\tvec = vec3(st.x, -1, -st.y);\n\t} else if (face == 4.0) {\n\t\tvec = vec3(st.x, -st.y, 1);\n\t} else {\n\t\tvec = vec3(-st.x, -st.y, -1);\n\t}\n\treturn normalize(modifySeams(vec, 1.0));\n}\nmat3 matrixFromVector(vec3 n) {\n\tfloat a = 1.0 / (1.0 + n.z);\n\tfloat b = -n.x * n.y * a;\n\tvec3 b1 = vec3(1.0 - n.x * n.x * a, b, -n.x);\n\tvec3 b2 = vec3(b, 1.0 - n.y * n.y * a, -n.y);\n\treturn mat3(b1, b2, n);\n}\nmat3 matrixFromVectorSlow(vec3 n) {\n\tvec3 up = (1.0 - abs(n.y) <= 0.0000001) ? vec3(0.0, 0.0, n.y > 0.0 ? 1.0 : -1.0) : vec3(0.0, 1.0, 0.0);\n\tvec3 x = normalize(cross(up, n));\n\tvec3 y = cross(n, x);\n\treturn mat3(x, y, n);\n}\nvec4 reproject() {\n\tif ({NUM_SAMPLES} <= 1) {\n\t\treturn {ENCODE_FUNC}({DECODE_FUNC}({SOURCE_FUNC}({TARGET_FUNC}())));\n\t} else {\n\t\tvec3 t = {TARGET_FUNC}();\n\t\tvec3 tu = dFdx(t);\n\t\tvec3 tv = dFdy(t);\n\t\tvec3 result = vec3(0.0);\n\t\tfor (float u = 0.0; u < {NUM_SAMPLES_SQRT}; ++u) {\n\t\t\tfor (float v = 0.0; v < {NUM_SAMPLES_SQRT}; ++v) {\n\t\t\t\tresult += {DECODE_FUNC}({SOURCE_FUNC}(normalize(t +\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ttu * (u / {NUM_SAMPLES_SQRT} - 0.5) +\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ttv * (v / {NUM_SAMPLES_SQRT} - 0.5))));\n\t\t\t}\n\t\t}\n\t\treturn {ENCODE_FUNC}(result / ({NUM_SAMPLES_SQRT} * {NUM_SAMPLES_SQRT}));\n\t}\n}\nvec4 unpackFloat = vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0);\n#ifdef USE_SAMPLES_TEX\n\tvoid unpackSample(int i, out vec3 L, out float mipLevel) {\n\t\tfloat u = (float(i * 4) + 0.5) * samplesTexInverseSize.x;\n\t\tfloat v = (floor(u) + 0.5) * samplesTexInverseSize.y;\n\t\tvec4 raw;\n\t\traw.x = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;\n\t\traw.y = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;\n\t\traw.z = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;\n\t\traw.w = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat);\n\t\tL.xyz = raw.xyz * 2.0 - 1.0;\n\t\tmipLevel = raw.w * 8.0;\n\t}\n\tvec4 prefilterSamples() {\n\t\tmat3 vecSpace = matrixFromVectorSlow({TARGET_FUNC}());\n\t\tvec3 L;\n\t\tfloat mipLevel;\n\t\tvec3 result = vec3(0.0);\n\t\tfloat totalWeight = 0.0;\n\t\tfor (int i = 0; i < {NUM_SAMPLES}; ++i) {\n\t\t\tunpackSample(i, L, mipLevel);\n\t\t\tresult += {DECODE_FUNC}({SOURCE_FUNC}(vecSpace * L, mipLevel)) * L.z;\n\t\t\ttotalWeight += L.z;\n\t\t}\n\t\treturn {ENCODE_FUNC}(result / totalWeight);\n\t}\n\tvec4 prefilterSamplesUnweighted() {\n\t\tmat3 vecSpace = matrixFromVectorSlow({TARGET_FUNC}());\n\t\tvec3 L;\n\t\tfloat mipLevel;\n\t\tvec3 result = vec3(0.0);\n\t\tfloat totalWeight = 0.0;\n\t\tfor (int i = 0; i < {NUM_SAMPLES}; ++i) {\n\t\t\tunpackSample(i, L, mipLevel);\n\t\t\tresult += {DECODE_FUNC}({SOURCE_FUNC}(vecSpace * L, mipLevel));\n\t\t}\n\t\treturn {ENCODE_FUNC}(result / float({NUM_SAMPLES}));\n\t}\n#endif\nvoid main(void) {\n\tgl_FragColor = {PROCESS_FUNC}();\n}\n',reprojectVS:"\nattribute vec2 vertex_position;\nuniform vec4 uvMod;\nvarying vec2 vUv0;\nvoid main(void) {\n\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\tvUv0 = getImageEffectUV((vertex_position.xy * 0.5 + 0.5) * uvMod.xy + uvMod.zw);\n}\n",screenDepthPS:"\nuniform highp sampler2D uSceneDepthMap;\n#ifndef SCREENSIZE\n\t#define SCREENSIZE\n\tuniform vec4 uScreenSize;\n#endif\n#ifndef VIEWMATRIX\n\t#define VIEWMATRIX\n\tuniform mat4 matrix_view;\n#endif\n#ifndef LINEARIZE_DEPTH\n\t#define LINEARIZE_DEPTH\n\t\n\t#ifndef CAMERAPLANES\n\t\t#define CAMERAPLANES\n\t\tuniform vec4 camera_params;\n\t#endif\n\tfloat linearizeDepth(float z) {\n\t\tif (camera_params.w == 0.0)\n\t\t\treturn (camera_params.z * camera_params.y) / (camera_params.y + z * (camera_params.z - camera_params.y));\n\t\telse\n\t\t\treturn camera_params.z + z * (camera_params.y - camera_params.z);\n\t}\n#endif\nfloat delinearizeDepth(float linearDepth) {\n\tif (camera_params.w == 0.0) {\n\t\treturn (camera_params.y * (camera_params.z - linearDepth)) / (linearDepth * (camera_params.z - camera_params.y));\n\t} else {\n\t\treturn (linearDepth - camera_params.z) / (camera_params.y - camera_params.z);\n\t}\n}\nfloat getLinearScreenDepth(vec2 uv) {\n\t#ifdef SCENE_DEPTHMAP_LINEAR\n\t\t#ifdef SCENE_DEPTHMAP_FLOAT\n\t\t\treturn texture2D(uSceneDepthMap, uv).r;\n\t\t#else\n\t\t\tivec2 textureSize = textureSize(uSceneDepthMap, 0);\n\t\t\tivec2 texel = ivec2(uv * vec2(textureSize));\n\t\t\tvec4 data = texelFetch(uSceneDepthMap, texel, 0);\n\t\t\tuint intBits = \n\t\t\t\t(uint(data.r * 255.0) << 24u) |\n\t\t\t\t(uint(data.g * 255.0) << 16u) |\n\t\t\t\t(uint(data.b * 255.0) << 8u) |\n\t\t\t\tuint(data.a * 255.0);\n\t\t\treturn uintBitsToFloat(intBits);\n\t\t#endif\n\t#else\n\t\treturn linearizeDepth(texture2D(uSceneDepthMap, uv).r);\n\t#endif\n}\n#ifndef VERTEXSHADER\n\tfloat getLinearScreenDepth() {\n\t\tvec2 uv = gl_FragCoord.xy * uScreenSize.zw;\n\t\treturn getLinearScreenDepth(uv);\n\t}\n#endif\nfloat getLinearDepth(vec3 pos) {\n\treturn -(matrix_view * vec4(pos, 1.0)).z;\n}\n",shadowCascadesPS:"\nint getShadowCascadeIndex(vec4 shadowCascadeDistances, int shadowCascadeCount) {\n\tfloat depth = 1.0 / gl_FragCoord.w;\n\tvec4 comparisons = step(shadowCascadeDistances, vec4(depth));\n\tint cascadeIndex = int(dot(comparisons, vec4(1.0)));\n\treturn min(cascadeIndex, shadowCascadeCount - 1);\n}\nint ditherShadowCascadeIndex(int cascadeIndex, vec4 shadowCascadeDistances, int shadowCascadeCount, float blendFactor) {\n \n\tif (cascadeIndex < shadowCascadeCount - 1) {\n\t\tfloat currentRangeEnd = shadowCascadeDistances[cascadeIndex];\n\t\tfloat transitionStart = blendFactor * currentRangeEnd;\n\t\tfloat depth = 1.0 / gl_FragCoord.w;\n\t\tif (depth > transitionStart) {\n\t\t\tfloat transitionFactor = smoothstep(transitionStart, currentRangeEnd, depth);\n\t\t\tfloat dither = fract(sin(dot(gl_FragCoord.xy, vec2(12.9898, 78.233))) * 43758.5453);\n\t\t\tif (dither < transitionFactor) {\n\t\t\t\tcascadeIndex += 1;\n\t\t\t}\n\t\t}\n\t}\n\treturn cascadeIndex;\n}\nvec3 fadeShadow(vec3 shadowCoord, vec4 shadowCascadeDistances) {\t\t\t\t  \n\tfloat depth = 1.0 / gl_FragCoord.w;\n\tif (depth > shadowCascadeDistances.w) {\n\t\tshadowCoord.z = -9999999.0;\n\t}\n\treturn shadowCoord;\n}\n",shadowEVSMPS:"\nfloat linstep(float a, float b, float v) {\n\treturn saturate((v - a) / (b - a));\n}\nfloat reduceLightBleeding(float pMax, float amount) {\n\t return linstep(amount, 1.0, pMax);\n}\nfloat chebyshevUpperBound(vec2 moments, float mean, float minVariance, float lightBleedingReduction) {\n\tfloat variance = moments.y - (moments.x * moments.x);\n\tvariance = max(variance, minVariance);\n\tfloat d = mean - moments.x;\n\tfloat pMax = variance / (variance + (d * d));\n\tpMax = reduceLightBleeding(pMax, lightBleedingReduction);\n\treturn (mean <= moments.x ? 1.0 : pMax);\n}\nfloat calculateEVSM(vec3 moments, float Z, float vsmBias, float exponent) {\n\tZ = 2.0 * Z - 1.0;\n\tfloat warpedDepth = exp(exponent * Z);\n\tmoments.xy += vec2(warpedDepth, warpedDepth*warpedDepth) * (1.0 - moments.z);\n\tfloat VSMBias = vsmBias;\n\tfloat depthScale = VSMBias * exponent * warpedDepth;\n\tfloat minVariance1 = depthScale * depthScale;\n\treturn chebyshevUpperBound(moments.xy, warpedDepth, minVariance1, 0.1);\n}\nfloat VSM16(TEXTURE_ACCEPT(tex), vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n\tvec3 moments = texture2DLod(tex, texCoords, 0.0).xyz;\n\treturn calculateEVSM(moments, Z, vsmBias, exponent);\n}\nfloat getShadowVSM16(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent) {\n\treturn VSM16(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, shadowCoord.z, shadowParams.y, exponent);\n}\nfloat getShadowSpotVSM16(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent, vec3 lightDir) {\n\treturn VSM16(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, length(lightDir) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);\n}\nfloat VSM32(TEXTURE_ACCEPT(tex), vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n\t#ifdef CAPS_TEXTURE_FLOAT_FILTERABLE\n\t\tvec3 moments = texture2DLod(tex, texCoords, 0.0).xyz;\n\t#else\n\t\tfloat pixelSize = 1.0 / resolution;\n\t\ttexCoords -= vec2(pixelSize);\n\t\tvec3 s00 = texture2DLod(tex, texCoords, 0.0).xyz;\n\t\tvec3 s10 = texture2DLod(tex, texCoords + vec2(pixelSize, 0), 0.0).xyz;\n\t\tvec3 s01 = texture2DLod(tex, texCoords + vec2(0, pixelSize), 0.0).xyz;\n\t\tvec3 s11 = texture2DLod(tex, texCoords + vec2(pixelSize), 0.0).xyz;\n\t\tvec2 fr = fract(texCoords * resolution);\n\t\tvec3 h0 = mix(s00, s10, fr.x);\n\t\tvec3 h1 = mix(s01, s11, fr.x);\n\t\tvec3 moments = mix(h0, h1, fr.y);\n\t#endif\n\treturn calculateEVSM(moments, Z, vsmBias, exponent);\n}\nfloat getShadowVSM32(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent) {\n\treturn VSM32(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, shadowCoord.z, shadowParams.y, exponent);\n}\nfloat getShadowSpotVSM32(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent, vec3 lightDir) {\n\tfloat Z = length(lightDir) * shadowParams.w + shadowParams.z;\n\treturn VSM32(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, Z, shadowParams.y, exponent);\n}\n",shadowPCF1PS:"\nfloat getShadowPCF1x1(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\treturn textureShadow(shadowMap, shadowCoord);\n}\nfloat getShadowSpotPCF1x1(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\treturn textureShadow(shadowMap, shadowCoord);\n}\n#ifndef WEBGPU\nfloat getShadowOmniPCF1x1(samplerCubeShadow shadowMap, vec3 shadowCoord, vec4 shadowParams, vec3 lightDir) {\n\tfloat shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;\n\treturn texture(shadowMap, vec4(lightDir, shadowZ));\n}\n#endif\n",shadowPCF3PS:"\nfloat _getShadowPCF3x3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec3 shadowParams) {\n\tfloat z = shadowCoord.z;\n\tvec2 uv = shadowCoord.xy * shadowParams.x;\n\tfloat shadowMapSizeInv = 1.0 / shadowParams.x;\n\tvec2 base_uv = floor(uv + 0.5);\n\tfloat s = (uv.x + 0.5 - base_uv.x);\n\tfloat t = (uv.y + 0.5 - base_uv.y); \n\tbase_uv -= vec2(0.5);\n\tbase_uv *= shadowMapSizeInv;\n\tfloat sum = 0.0;\n\tfloat uw0 = (3.0 - 2.0 * s);\n\tfloat uw1 = (1.0 + 2.0 * s);\n\tfloat u0 = (2.0 - s) / uw0 - 1.0;\n\tfloat u1 = s / uw1 + 1.0;\n\tfloat vw0 = (3.0 - 2.0 * t);\n\tfloat vw1 = (1.0 + 2.0 * t);\n\tfloat v0 = (2.0 - t) / vw0 - 1.0;\n\tfloat v1 = t / vw1 + 1.0;\n\tu0 = u0 * shadowMapSizeInv + base_uv.x;\n\tv0 = v0 * shadowMapSizeInv + base_uv.y;\n\tu1 = u1 * shadowMapSizeInv + base_uv.x;\n\tv1 = v1 * shadowMapSizeInv + base_uv.y;\n\tsum += uw0 * vw0 * textureShadow(shadowMap, vec3(u0, v0, z));\n\tsum += uw1 * vw0 * textureShadow(shadowMap, vec3(u1, v0, z));\n\tsum += uw0 * vw1 * textureShadow(shadowMap, vec3(u0, v1, z));\n\tsum += uw1 * vw1 * textureShadow(shadowMap, vec3(u1, v1, z));\n\tsum *= 1.0f / 16.0;\n\treturn sum;\n}\nfloat getShadowPCF3x3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\treturn _getShadowPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);\n}\nfloat getShadowSpotPCF3x3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\treturn _getShadowPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);\n}\n#ifndef WEBGPU\nfloat getShadowOmniPCF3x3(samplerCubeShadow shadowMap, vec4 shadowParams, vec3 dir) {\n\t\n\tfloat shadowZ = length(dir) * shadowParams.w + shadowParams.z;\n\tfloat z = 1.0 / float(textureSize(shadowMap, 0));\n\tvec3 tc = normalize(dir);\n\tmediump vec4 shadows;\n\tshadows.x = texture(shadowMap, vec4(tc + vec3( z, z, z), shadowZ));\n\tshadows.y = texture(shadowMap, vec4(tc + vec3(-z,-z, z), shadowZ));\n\tshadows.z = texture(shadowMap, vec4(tc + vec3(-z, z,-z), shadowZ));\n\tshadows.w = texture(shadowMap, vec4(tc + vec3( z,-z,-z), shadowZ));\n\treturn dot(shadows, vec4(0.25));\n}\nfloat getShadowOmniPCF3x3(samplerCubeShadow shadowMap, vec3 shadowCoord, vec4 shadowParams, vec3 lightDir) {\n\treturn getShadowOmniPCF3x3(shadowMap, shadowParams, lightDir);\n}\n#endif\n",shadowPCF5PS:"\nfloat _getShadowPCF5x5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec3 shadowParams) {\n\tfloat z = shadowCoord.z;\n\tvec2 uv = shadowCoord.xy * shadowParams.x;\n\tfloat shadowMapSizeInv = 1.0 / shadowParams.x;\n\tvec2 base_uv = floor(uv + 0.5);\n\tfloat s = (uv.x + 0.5 - base_uv.x);\n\tfloat t = (uv.y + 0.5 - base_uv.y);\n\tbase_uv -= vec2(0.5);\n\tbase_uv *= shadowMapSizeInv;\n\tfloat uw0 = (4.0 - 3.0 * s);\n\tfloat uw1 = 7.0;\n\tfloat uw2 = (1.0 + 3.0 * s);\n\tfloat u0 = (3.0 - 2.0 * s) / uw0 - 2.0;\n\tfloat u1 = (3.0 + s) / uw1;\n\tfloat u2 = s / uw2 + 2.0;\n\tfloat vw0 = (4.0 - 3.0 * t);\n\tfloat vw1 = 7.0;\n\tfloat vw2 = (1.0 + 3.0 * t);\n\tfloat v0 = (3.0 - 2.0 * t) / vw0 - 2.0;\n\tfloat v1 = (3.0 + t) / vw1;\n\tfloat v2 = t / vw2 + 2.0;\n\tfloat sum = 0.0;\n\tu0 = u0 * shadowMapSizeInv + base_uv.x;\n\tv0 = v0 * shadowMapSizeInv + base_uv.y;\n\tu1 = u1 * shadowMapSizeInv + base_uv.x;\n\tv1 = v1 * shadowMapSizeInv + base_uv.y;\n\tu2 = u2 * shadowMapSizeInv + base_uv.x;\n\tv2 = v2 * shadowMapSizeInv + base_uv.y;\n\tsum += uw0 * vw0 * textureShadow(shadowMap, vec3(u0, v0, z));\n\tsum += uw1 * vw0 * textureShadow(shadowMap, vec3(u1, v0, z));\n\tsum += uw2 * vw0 * textureShadow(shadowMap, vec3(u2, v0, z));\n\tsum += uw0 * vw1 * textureShadow(shadowMap, vec3(u0, v1, z));\n\tsum += uw1 * vw1 * textureShadow(shadowMap, vec3(u1, v1, z));\n\tsum += uw2 * vw1 * textureShadow(shadowMap, vec3(u2, v1, z));\n\tsum += uw0 * vw2 * textureShadow(shadowMap, vec3(u0, v2, z));\n\tsum += uw1 * vw2 * textureShadow(shadowMap, vec3(u1, v2, z));\n\tsum += uw2 * vw2 * textureShadow(shadowMap, vec3(u2, v2, z));\n\tsum *= 1.0f / 144.0;\n\tsum = saturate(sum);\n\treturn sum;\n}\nfloat getShadowPCF5x5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\treturn _getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);\n}\nfloat getShadowSpotPCF5x5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\treturn _getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);\n}\n",shadowPCSSPS:"\n#define PCSS_SAMPLE_COUNT 16\nuniform float pcssDiskSamples[PCSS_SAMPLE_COUNT];\nuniform float pcssSphereSamples[PCSS_SAMPLE_COUNT];\nvec2 vogelDisk(int sampleIndex, float count, float phi, float r) {\n\tconst float GoldenAngle = 2.4;\n\tfloat theta = float(sampleIndex) * GoldenAngle + phi;\n\tfloat sine = sin(theta);\n\tfloat cosine = cos(theta);\n\treturn vec2(r * cosine, r * sine);\n}\nvec3 vogelSphere(int sampleIndex, float count, float phi, float r) {\n\tconst float GoldenAngle = 2.4;\n\tfloat theta = float(sampleIndex) * GoldenAngle + phi;\n\tfloat weight = float(sampleIndex) / count;\n\treturn vec3(cos(theta) * r, weight, sin(theta) * r);\n}\nfloat noise(vec2 screenPos) {\n\tconst float PHI = 1.61803398874989484820459;\n\treturn fract(sin(dot(screenPos * PHI, screenPos)) * screenPos.x);\n}\nfloat viewSpaceDepth(float depth, mat4 invProjection) {\n\tfloat z = depth * 2.0 - 1.0;\n\tvec4 clipSpace = vec4(0.0, 0.0, z, 1.0);\n\tvec4 viewSpace = invProjection * clipSpace;\n\treturn viewSpace.z;\n}\nfloat PCSSBlockerDistance(TEXTURE_ACCEPT(shadowMap), vec2 sampleCoords[PCSS_SAMPLE_COUNT], vec2 shadowCoords, vec2 searchSize, float z, vec4 cameraParams) {\n\tfloat blockers = 0.0;\n\tfloat averageBlocker = 0.0;\n\tfor (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {\n\t\tvec2 offset = sampleCoords[i] * searchSize;\n\t\tvec2 sampleUV = shadowCoords + offset;\n\t\tfloat blocker = texture2DLod(shadowMap, sampleUV, 0.0).r;\n\t\tfloat isBlocking = step(blocker, z);\n\t\tblockers += isBlocking;\n\t\taverageBlocker += blocker * isBlocking;\n\t}\n\tif (blockers > 0.0)\n\t\treturn averageBlocker / blockers;\n\treturn -1.0;\n}\nfloat PCSS(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoords, vec4 cameraParams, vec2 shadowSearchArea) {\n\tfloat receiverDepth = linearizeDepthWithParams(shadowCoords.z, cameraParams);\n\tvec2 samplePoints[PCSS_SAMPLE_COUNT];\n\tconst float PI = 3.141592653589793;\n\tfloat noise = noise( gl_FragCoord.xy ) * 2.0 * PI;\n\tfor (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {\n\t\tfloat pcssPresample = pcssDiskSamples[i];\n\t\tsamplePoints[i] = vogelDisk(i, float(PCSS_SAMPLE_COUNT), noise, pcssPresample);\n\t}\n\tfloat averageBlocker = PCSSBlockerDistance(TEXTURE_PASS(shadowMap), samplePoints, shadowCoords.xy, shadowSearchArea, receiverDepth, cameraParams);\n\tif (averageBlocker == -1.0) {\n\t\treturn 1.0;\n\t} else {\n\t\tfloat depthDifference = (receiverDepth - averageBlocker) / 3.0;\n\t\tvec2 filterRadius = depthDifference * shadowSearchArea;\n\t\tfloat shadow = 0.0;\n\t\tfor (int i = 0; i < PCSS_SAMPLE_COUNT; i ++)\n\t\t{\n\t\t\tvec2 sampleUV = samplePoints[i] * filterRadius;\n\t\t\tsampleUV = shadowCoords.xy + sampleUV;\n\t\t\tfloat depth = texture2DLod(shadowMap, sampleUV, 0.0).r;\n\t\t\tshadow += step(receiverDepth, depth);\n\t\t}\n\t\treturn shadow / float(PCSS_SAMPLE_COUNT);\n\t} \n}\n#ifndef WEBGPU\nfloat PCSSCubeBlockerDistance(samplerCube shadowMap, vec3 lightDirNorm, vec3 samplePoints[PCSS_SAMPLE_COUNT], float z, float shadowSearchArea) {\n\tfloat blockers = 0.0;\n\tfloat averageBlocker = 0.0;\n\tfor (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {\n\t\tvec3 sampleDir = lightDirNorm + samplePoints[i] * shadowSearchArea;\n\t\tsampleDir = normalize(sampleDir);\n\t\tfloat blocker = textureCubeLod(shadowMap, sampleDir, 0.0).r;\n\t\tfloat isBlocking = step(blocker, z);\n\t\tblockers += isBlocking;\n\t\taverageBlocker += blocker * isBlocking;\n\t}\n\tif (blockers > 0.0)\n\t\treturn averageBlocker / blockers;\n\treturn -1.0;\n}\nfloat PCSSCube(samplerCube shadowMap, vec4 shadowParams, vec3 shadowCoords, vec4 cameraParams, float shadowSearchArea, vec3 lightDir) {\n\t\n\tvec3 samplePoints[PCSS_SAMPLE_COUNT];\n\tconst float PI = 3.141592653589793;\n\tfloat noise = noise( gl_FragCoord.xy ) * 2.0 * PI;\n\tfor (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {\n\t\tfloat r = pcssSphereSamples[i];\n\t\tsamplePoints[i] = vogelSphere(i, float(PCSS_SAMPLE_COUNT), noise, r);\n\t}\n\tfloat receiverDepth = length(lightDir) * shadowParams.w + shadowParams.z;\n\tvec3 lightDirNorm = normalize(lightDir);\n\t\n\tfloat averageBlocker = PCSSCubeBlockerDistance(shadowMap, lightDirNorm, samplePoints, receiverDepth, shadowSearchArea);\n\tif (averageBlocker == -1.0) {\n\t\treturn 1.0;\n\t} else {\n\t\tfloat filterRadius = ((receiverDepth - averageBlocker) / averageBlocker) * shadowSearchArea;\n\t\tfloat shadow = 0.0;\n\t\tfor (int i = 0; i < PCSS_SAMPLE_COUNT; i++)\n\t\t{\n\t\t\tvec3 offset = samplePoints[i] * filterRadius;\n\t\t\tvec3 sampleDir = lightDirNorm + offset;\n\t\t\tsampleDir = normalize(sampleDir);\n\t\t\tfloat depth = textureCubeLod(shadowMap, sampleDir, 0.0).r;\n\t\t\tshadow += step(receiverDepth, depth);\n\t\t}\n\t\treturn shadow / float(PCSS_SAMPLE_COUNT);\n\t}\n}\nfloat getShadowOmniPCSS(samplerCube shadowMap, vec3 shadowCoord, vec4 shadowParams, vec4 cameraParams, vec2 shadowSearchArea, vec3 lightDir) {\n\treturn PCSSCube(shadowMap, shadowParams, shadowCoord, cameraParams, shadowSearchArea.x, lightDir);\n}\n#endif\nfloat getShadowSpotPCSS(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, vec4 cameraParams, vec2 shadowSearchArea, vec3 lightDir) {\n\treturn PCSS(TEXTURE_PASS(shadowMap), shadowCoord, cameraParams, shadowSearchArea);\n}\n",shadowSoftPS:"\nhighp float fractSinRand(const in vec2 uv) {\n\tconst float PI = 3.141592653589793;\n\tconst highp float a = 12.9898, b = 78.233, c = 43758.5453;\n\thighp float dt = dot(uv.xy, vec2(a, b)), sn = mod(dt, PI);\n\treturn fract(sin(sn) * c);\n}\nstruct VogelDiskData {\n\tfloat invNumSamples;\n\tfloat initialAngle;\n\tfloat currentPointId;\n};\nvoid prepareDiskConstants(out VogelDiskData data, int sampleCount, float randomSeed) {\n\tconst float pi2 = 6.28318530718;\n\tdata.invNumSamples = 1.0 / float(sampleCount);\n\tdata.initialAngle = randomSeed * pi2;\n\tdata.currentPointId = 0.0;\n}\nvec2 generateDiskSample(inout VogelDiskData data) {\n\tconst float GOLDEN_ANGLE = 2.399963;\n\tfloat r = sqrt((data.currentPointId + 0.5) * data.invNumSamples);\n\tfloat theta = data.currentPointId * GOLDEN_ANGLE + data.initialAngle;\n\tvec2 offset = vec2(cos(theta), sin(theta)) * pow(r, 1.33);\n\tdata.currentPointId += 1.0;\n\treturn offset;\n}\nvoid PCSSFindBlocker(TEXTURE_ACCEPT(shadowMap), out float avgBlockerDepth, out int numBlockers,\n\tvec2 shadowCoords, float z, int shadowBlockerSamples, float penumbraSize, float invShadowMapSize, float randomSeed) {\n\tVogelDiskData diskData;\n\tprepareDiskConstants(diskData, shadowBlockerSamples, randomSeed);\n\tfloat searchWidth = penumbraSize * invShadowMapSize;\n\tfloat blockerSum = 0.0;\n\tnumBlockers = 0;\n\tfor( int i = 0; i < shadowBlockerSamples; ++i ) {\n\t\tvec2 diskUV = generateDiskSample(diskData);\n\t\tvec2 sampleUV = shadowCoords + diskUV * searchWidth;\n\t\tfloat shadowMapDepth = texture2DLod(shadowMap, sampleUV, 0.0).r;\n\t\tif ( shadowMapDepth < z ) {\n\t\t\tblockerSum += shadowMapDepth;\n\t\t\tnumBlockers++;\n\t\t}\n\t}\n\tavgBlockerDepth = blockerSum / float(numBlockers);\n}\nfloat PCSSFilter(TEXTURE_ACCEPT(shadowMap), vec2 uv, float receiverDepth, int shadowSamples, float filterRadius, float randomSeed) {\n\tVogelDiskData diskData;\n\tprepareDiskConstants(diskData, shadowSamples, randomSeed);\n\tfloat sum = 0.0;\n\tfor (int i = 0; i < shadowSamples; i++) {\n\t\tvec2 offsetUV = generateDiskSample(diskData) * filterRadius;\n\t\tfloat depth = texture2DLod(shadowMap, uv + offsetUV, 0.0).r;\n\t\tsum += step(receiverDepth, depth);\n\t}\n\treturn sum / float(shadowSamples);\n}\nfloat getPenumbra(float dblocker, float dreceiver, float penumbraSize, float penumbraFalloff) {\n\tfloat dist = dreceiver - dblocker;\n\tfloat penumbra = 1.0 - pow(1.0 - dist, penumbraFalloff);\n\treturn penumbra * penumbraSize;\n}\nfloat PCSSDirectional(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoords, vec4 cameraParams, vec4 softShadowParams) {\n\tfloat receiverDepth = shadowCoords.z;\n\tfloat randomSeed = fractSinRand(gl_FragCoord.xy);\n\tint shadowSamples = int(softShadowParams.x);\n\tint shadowBlockerSamples = int(softShadowParams.y);\n\tfloat penumbraSize = softShadowParams.z;\n\tfloat penumbraFalloff = softShadowParams.w;\n\tint shadowMapSize = textureSize(shadowMap, 0).x;\n\tfloat invShadowMapSize = 1.0 / float(shadowMapSize);\n\tinvShadowMapSize *= float(shadowMapSize) / 2048.0;\n\tfloat penumbra;\n\tif (shadowBlockerSamples > 0) {\n\t\tfloat avgBlockerDepth = 0.0;\n\t\tint numBlockers = 0;\n\t\tPCSSFindBlocker(TEXTURE_PASS(shadowMap), avgBlockerDepth, numBlockers, shadowCoords.xy, receiverDepth, shadowBlockerSamples, penumbraSize, invShadowMapSize, randomSeed);\n\t\tif (numBlockers < 1)\n\t\t\treturn 1.0f;\n\t\tpenumbra = getPenumbra(avgBlockerDepth, shadowCoords.z, penumbraSize, penumbraFalloff);\n\t} else {\n\t\tpenumbra = penumbraSize;\n\t}\n\tfloat filterRadius = penumbra * invShadowMapSize;\n\treturn PCSSFilter(TEXTURE_PASS(shadowMap), shadowCoords.xy, receiverDepth, shadowSamples, filterRadius, randomSeed);\n}\nfloat getShadowPCSS(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, vec4 cameraParams, vec4 softShadowParams, vec3 lightDir) {\n\treturn PCSSDirectional(TEXTURE_PASS(shadowMap), shadowCoord, cameraParams, softShadowParams);\n}\n",skinBatchVS:"\nattribute float vertex_boneIndices;\nuniform highp sampler2D texture_poseMap;\nmat4 getBoneMatrix(const in float indexFloat) {\n\tint width = textureSize(texture_poseMap, 0).x;\n\tint index = int(indexFloat + 0.5) * 3;\n\tint iy = index / width;\n\tint ix = index % width;\n\tvec4 v1 = texelFetch(texture_poseMap, ivec2(ix + 0, iy), 0);\n\tvec4 v2 = texelFetch(texture_poseMap, ivec2(ix + 1, iy), 0);\n\tvec4 v3 = texelFetch(texture_poseMap, ivec2(ix + 2, iy), 0);\n\treturn mat4(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, 1\n\t);\n}\n",skinVS:"\nattribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\nuniform highp sampler2D texture_poseMap;\nvoid getBoneMatrix(const in int width, const in int index, out vec4 v1, out vec4 v2, out vec4 v3) {\n\tint v = index / width;\n\tint u = index % width;\n\tv1 = texelFetch(texture_poseMap, ivec2(u + 0, v), 0);\n\tv2 = texelFetch(texture_poseMap, ivec2(u + 1, v), 0);\n\tv3 = texelFetch(texture_poseMap, ivec2(u + 2, v), 0);\n}\nmat4 getSkinMatrix(const in vec4 indicesFloat, const in vec4 weights) {\n\tint width = textureSize(texture_poseMap, 0).x;\n\tivec4 indices = ivec4(indicesFloat + 0.5) * 3;\n\tvec4 a1, a2, a3;\n\tgetBoneMatrix(width, indices.x, a1, a2, a3);\n\tvec4 b1, b2, b3;\n\tgetBoneMatrix(width, indices.y, b1, b2, b3);\n\tvec4 c1, c2, c3;\n\tgetBoneMatrix(width, indices.z, c1, c2, c3);\n\tvec4 d1, d2, d3;\n\tgetBoneMatrix(width, indices.w, d1, d2, d3);\n\tvec4 v1 = a1 * weights.x + b1 * weights.y + c1 * weights.z + d1 * weights.w;\n\tvec4 v2 = a2 * weights.x + b2 * weights.y + c2 * weights.z + d2 * weights.w;\n\tvec4 v3 = a3 * weights.x + b3 * weights.y + c3 * weights.z + d3 * weights.w;\n\tfloat one = dot(weights, vec4(1.0));\n\treturn mat4(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, one\n\t);\n}\n",skyboxPS:'\n\t#define LIT_SKYBOX_INTENSITY\n\t#include "envProcPS"\n\t#include "gammaPS"\n\t#include "tonemappingPS"\n\t#ifdef PREPASS_PASS\n\t\tvarying float vLinearDepth;\n\t\t#include "floatAsUintPS"\n\t#endif\n\tvarying vec3 vViewDir;\n\tuniform float skyboxHighlightMultiplier;\n\t#ifdef SKY_CUBEMAP\n\t\tuniform samplerCube texture_cubeMap;\n\t\t#ifdef SKYMESH\n\t\t\tvarying vec3 vWorldPos;\n\t\t\tuniform mat3 cubeMapRotationMatrix;\n\t\t\tuniform vec3 projectedSkydomeCenter;\n\t\t#endif\n\t#else\n\t\t#include "sphericalPS"\n\t\t#include "envAtlasPS"\n\t\tuniform sampler2D texture_envAtlas;\n\t\tuniform float mipLevel;\n\t#endif\n\tvoid main(void) {\n\t\t#ifdef PREPASS_PASS\n\t\t\tgl_FragColor = float2vec4(vLinearDepth);\n\t\t#else\n\t\t\t#ifdef SKY_CUBEMAP\n\t\t\t\t#ifdef SKYMESH\n\t\t\t\t\tvec3 envDir = normalize(vWorldPos - projectedSkydomeCenter);\n\t\t\t\t\tvec3 dir = envDir * cubeMapRotationMatrix;\n\t\t\t\t#else\n\t\t\t\t\tvec3 dir = vViewDir;\n\t\t\t\t#endif\n\t\t\t\tdir.x *= -1.0;\n\t\t\t\tvec3 linear = {SKYBOX_DECODE_FNC}(textureCube(texture_cubeMap, dir));\n\t\t\t#else\n\t\t\t\tvec3 dir = vViewDir * vec3(-1.0, 1.0, 1.0);\n\t\t\t\tvec2 uv = toSphericalUv(normalize(dir));\n\t\t\t\tvec3 linear = {SKYBOX_DECODE_FNC}(texture2D(texture_envAtlas, mapRoughnessUv(uv, mipLevel)));\n\t\t\t#endif\n\t\t\tif (any(greaterThanEqual(linear, vec3(64.0)))) {\n\t\t\t\tlinear *= skyboxHighlightMultiplier;\n\t\t\t}\n\t\t\tgl_FragColor = vec4(gammaCorrectOutput(toneMap(processEnvironment(linear))), 1.0);\n\t\t#endif\n\t}\n',skyboxVS:"\nattribute vec4 aPosition;\nuniform mat4 matrix_view;\nuniform mat4 matrix_projectionSkybox;\nuniform mat3 cubeMapRotationMatrix;\nvarying vec3 vViewDir;\n#ifdef PREPASS_PASS\n\tvarying float vLinearDepth;\n#endif\n#ifdef SKYMESH\n\tuniform mat4 matrix_model;\n\tvarying vec3 vWorldPos;\n#endif\nvoid main(void) {\n\tmat4 view = matrix_view;\n\t#ifdef SKYMESH\n\t\tvec4 worldPos = matrix_model * aPosition;\n\t\tvWorldPos = worldPos.xyz;\n\t\tgl_Position = matrix_projectionSkybox * (view * worldPos);\n\t\t#ifdef PREPASS_PASS\n\t\t\tvLinearDepth = -(matrix_view * vec4(vWorldPos, 1.0)).z;\n\t\t#endif\n\t#else\n\t\tview[3][0] = view[3][1] = view[3][2] = 0.0;\n\t\tgl_Position = matrix_projectionSkybox * (view * aPosition);\n\t\tvViewDir = aPosition.xyz * cubeMapRotationMatrix;\n\t\t#ifdef PREPASS_PASS\n\t\t\tvLinearDepth = -gl_Position.w;\n\t\t#endif\n\t#endif\n\tgl_Position.z = gl_Position.w - 1.0e-7;\n}\n",specularPS:"\n#ifdef STD_SPECULAR_CONSTANT\nuniform vec3 material_specular;\n#endif\nvoid getSpecularity() {\n\tvec3 specularColor = vec3(1,1,1);\n\t#ifdef STD_SPECULAR_CONSTANT\n\tspecularColor *= material_specular;\n\t#endif\n\t#ifdef STD_SPECULAR_TEXTURE\n\tspecularColor *= {STD_SPECULAR_TEXTURE_DECODE}(texture2DBias({STD_SPECULAR_TEXTURE_NAME}, {STD_SPECULAR_TEXTURE_UV}, textureBias)).{STD_SPECULAR_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_SPECULAR_VERTEX\n\tspecularColor *= saturate(vVertexColor.{STD_SPECULAR_VERTEX_CHANNEL});\n\t#endif\n\tdSpecularity = specularColor;\n}\n",sphericalPS:"\nvec2 toSpherical(vec3 dir) {\n\treturn vec2(dir.xz == vec2(0.0) ? 0.0 : atan(dir.x, dir.z), asin(dir.y));\n}\nvec2 toSphericalUv(vec3 dir) {\n\tconst float PI = 3.141592653589793;\n\tvec2 uv = toSpherical(dir) / vec2(PI * 2.0, PI) + 0.5;\n\treturn vec2(uv.x, 1.0 - uv.y);\n}\n",specularityFactorPS:"\n#ifdef STD_SPECULARITYFACTOR_CONSTANT\nuniform float material_specularityFactor;\n#endif\nvoid getSpecularityFactor() {\n\tfloat specularityFactor = 1.0;\n\t#ifdef STD_SPECULARITYFACTOR_CONSTANT\n\tspecularityFactor *= material_specularityFactor;\n\t#endif\n\t#ifdef STD_SPECULARITYFACTOR_TEXTURE\n\tspecularityFactor *= texture2DBias({STD_SPECULARITYFACTOR_TEXTURE_NAME}, {STD_SPECULARITYFACTOR_TEXTURE_UV}, textureBias).{STD_SPECULARITYFACTOR_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_SPECULARITYFACTOR_VERTEX\n\tspecularityFactor *= saturate(vVertexColor.{STD_SPECULARITYFACTOR_VERTEX_CHANNEL});\n\t#endif\n\tdSpecularityFactor = specularityFactor;\n}\n",spotPS:"\nfloat getSpotEffect(vec3 lightSpotDir, float lightInnerConeAngle, float lightOuterConeAngle, vec3 lightDirNorm) {\n\tfloat cosAngle = dot(lightDirNorm, lightSpotDir);\n\treturn smoothstep(lightOuterConeAngle, lightInnerConeAngle, cosAngle);\n}\n",startNineSlicedPS:"\n\tnineSlicedUv = vec2(vUv0.x, 1.0 - vUv0.y);\n",startNineSlicedTiledPS:"\n\tvec2 tileMask = step(vMask, vec2(0.99999));\n\tvec2 tileSize = 0.5 * (innerOffset.xy + innerOffset.zw);\n\tvec2 tileScale = vec2(1.0) / (vec2(1.0) - tileSize);\n\tvec2 clampedUv = mix(innerOffset.xy * 0.5, vec2(1.0) - innerOffset.zw * 0.5, fract((vTiledUv - tileSize) * tileScale));\n\tclampedUv = clampedUv * atlasRect.zw + atlasRect.xy;\n\tnineSlicedUv = vUv0 * tileMask + clampedUv * (vec2(1.0) - tileMask);\n\tnineSlicedUv.y = 1.0 - nineSlicedUv.y;\n\t\n",stdDeclarationPS:'\n\tfloat dAlpha = 1.0;\n\t#if LIT_BLEND_TYPE != NONE || defined(LIT_ALPHA_TEST) || defined(LIT_ALPHA_TO_COVERAGE) || STD_OPACITY_DITHER != NONE\n\t\t#ifdef STD_OPACITY_TEXTURE_ALLOCATE\n\t\t\tuniform sampler2D texture_opacityMap;\n\t\t#endif\n\t#endif\n\t#ifdef FORWARD_PASS\n\t\tvec3 dAlbedo;\n\t\tvec3 dNormalW;\n\t\tvec3 dSpecularity = vec3(0.0);\n\t\tfloat dGlossiness = 0.0;\n\t\t#ifdef LIT_REFRACTION\n\t\t\tfloat dTransmission;\n\t\t\tfloat dThickness;\n\t\t#endif\n\t\t#ifdef LIT_SCENE_COLOR\n\t\t\tuniform sampler2D uSceneColorMap;\n\t\t#endif\n\t\t#ifdef LIT_SCREEN_SIZE\n\t\t\tuniform vec4 uScreenSize;\n\t\t#endif\n\t\t#ifdef LIT_TRANSFORMS\n\t\t\tuniform mat4 matrix_viewProjection;\n\t\t\tuniform mat4 matrix_model;\n\t\t#endif\n\t\t#ifdef STD_HEIGHT_MAP\n\t\t\tvec2 dUvOffset;\n\t\t\t#ifdef STD_HEIGHT_TEXTURE_ALLOCATE\n\t\t\t\tuniform sampler2D texture_heightMap;\n\t\t\t#endif\n\t\t#endif\n\t\t#ifdef STD_DIFFUSE_TEXTURE_ALLOCATE\n\t\t\tuniform sampler2D texture_diffuseMap;\n\t\t#endif\n\t\t#ifdef STD_DIFFUSEDETAIL_TEXTURE_ALLOCATE\n\t\t\tuniform sampler2D texture_diffuseDetailMap;\n\t\t#endif\n\t\t#ifdef STD_NORMAL_TEXTURE_ALLOCATE\n\t\t\tuniform sampler2D texture_normalMap;\n\t\t#endif\n\t\t#ifdef STD_NORMALDETAIL_TEXTURE_ALLOCATE\n\t\t\tuniform sampler2D texture_normalDetailMap;\n\t\t#endif\n\t\t#ifdef STD_THICKNESS_TEXTURE_ALLOCATE\n\t\t\tuniform sampler2D texture_thicknessMap;\n\t\t#endif\n\t\t#ifdef STD_REFRACTION_TEXTURE_ALLOCATE\n\t\t\tuniform sampler2D texture_refractionMap;\n\t\t#endif\n\t\t#ifdef LIT_IRIDESCENCE\n\t\t\tfloat dIridescence;\n\t\t\tfloat dIridescenceThickness;\n\t\t\t#ifdef STD_IRIDESCENCE_THICKNESS_TEXTURE_ALLOCATE\n\t\t\t\tuniform sampler2D texture_iridescenceThicknessMap;\n\t\t\t#endif\n\t\t\t#ifdef STD_IRIDESCENCE_TEXTURE_ALLOCATE\n\t\t\t\tuniform sampler2D texture_iridescenceMap;\n\t\t\t#endif\n\t\t#endif\n\t\t#ifdef LIT_CLEARCOAT\n\t\t\tfloat ccSpecularity;\n\t\t\tfloat ccGlossiness;\n\t\t\tvec3 ccNormalW;\n\t\t#endif\n\t\t#ifdef LIT_GGX_SPECULAR\n\t\t\tfloat dAnisotropy;\n\t\t\tvec2 dAnisotropyRotation;\n\t\t#endif\n\t\t#ifdef LIT_SPECULAR_OR_REFLECTION\n\t\t\t#ifdef LIT_SHEEN\n\t\t\t\tvec3 sSpecularity;\n\t\t\t\tfloat sGlossiness;\n\t\t\t\t#ifdef STD_SHEEN_TEXTURE_ALLOCATE\n\t\t\t\t\tuniform sampler2D texture_sheenMap;\n\t\t\t\t#endif\n\t\t\t\t#ifdef STD_SHEENGLOSS_TEXTURE_ALLOCATE\n\t\t\t\t\tuniform sampler2D texture_sheenGlossMap;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\t#ifdef LIT_METALNESS\n\t\t\t\tfloat dMetalness;\n\t\t\t\tfloat dIor;\n\t\t\t\t#ifdef STD_METALNESS_TEXTURE_ALLOCATE\n\t\t\t\t\tuniform sampler2D texture_metalnessMap;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\t#ifdef LIT_SPECULARITY_FACTOR\n\t\t\t\tfloat dSpecularityFactor;\n\t\t\t\t#ifdef STD_SPECULARITYFACTOR_TEXTURE_ALLOCATE\n\t\t\t\t\tuniform sampler2D texture_specularityFactorMap;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\t#ifdef STD_SPECULAR_COLOR\n\t\t\t\t#ifdef STD_SPECULAR_TEXTURE_ALLOCATE\n\t\t\t\t\tuniform sampler2D texture_specularMap;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\t#ifdef STD_GLOSS_TEXTURE_ALLOCATE\n\t\t\t\tuniform sampler2D texture_glossMap;\n\t\t\t#endif\n\t\t#endif\n\t\t#ifdef STD_AO\n\t\t\tfloat dAo;\n\t\t\t#ifdef STD_AO_TEXTURE_ALLOCATE\n\t\t\t\tuniform sampler2D texture_aoMap;\n\t\t\t#endif\n\t\t\t#ifdef STD_AODETAIL_TEXTURE_ALLOCATE\n\t\t\t\tuniform sampler2D texture_aoDetailMap;\n\t\t\t#endif\n\t\t#endif\n\t\tvec3 dEmission;\n\t\t#ifdef STD_EMISSIVE_TEXTURE_ALLOCATE\n\t\t\tuniform sampler2D texture_emissiveMap;\n\t\t#endif\n\t\t#ifdef LIT_CLEARCOAT\n\t\t\t#ifdef STD_CLEARCOAT_TEXTURE_ALLOCATE\n\t\t\t\tuniform sampler2D texture_clearCoatMap;\n\t\t\t#endif\n\t\t\t#ifdef STD_CLEARCOATGLOSS_TEXTURE_ALLOCATE\n\t\t\t\tuniform sampler2D texture_clearCoatGlossMap;\n\t\t\t#endif\n\t\t\t#ifdef STD_CLEARCOATNORMAL_TEXTURE_ALLOCATE\n\t\t\t\tuniform sampler2D texture_clearCoatNormalMap;\n\t\t\t#endif\n\t\t#endif\n\t\t\n\t\t#ifdef LIT_GGX_SPECULAR\n\t\t\t#ifdef STD_ANISOTROPY_TEXTURE_ALLOCATE\n\t\t\t\tuniform sampler2D texture_anisotropyMap;\n\t\t\t#endif\n\t\t#endif\n\t\t#if defined(STD_LIGHTMAP) || defined(STD_LIGHT_VERTEX_COLOR)\n\t\t\tvec3 dLightmap;\n\t\t\t#ifdef STD_LIGHT_TEXTURE_ALLOCATE\n\t\t\t\tuniform sampler2D texture_lightMap;\n\t\t\t#endif\n\t\t#endif\n\t#endif\n\t#include "litShaderCorePS"\n',stdFrontEndPS:'\n\t#if LIT_BLEND_TYPE != NONE || defined(LIT_ALPHA_TEST) || defined(LIT_ALPHA_TO_COVERAGE) || STD_OPACITY_DITHER != NONE\n\t\t#include "opacityPS"\n\t\t#if defined(LIT_ALPHA_TEST)\n\t\t\t#include "alphaTestPS"\n\t\t#endif\n\t\t#if STD_OPACITY_DITHER != NONE\n\t\t\t#include "opacityDitherPS"\n\t\t#endif\n\t#endif\n\t#ifdef FORWARD_PASS\n\t\t#ifdef STD_HEIGHT_MAP\n\t\t\t#include "parallaxPS"\n\t\t#endif\n\t\t#include  "diffusePS"\n\t\t#ifdef LIT_NEEDS_NORMAL\n\t\t\t#include "normalMapPS"\n\t\t#endif\n\t\t#ifdef LIT_REFRACTION\n\t\t\t#include "transmissionPS"\n\t\t\t#include "thicknessPS"\n\t\t#endif\n\t\t#ifdef LIT_IRIDESCENCE\n\t\t\t#include "iridescencePS"\n\t\t\t#include "iridescenceThicknessPS"\n\t\t#endif\n\t\t#ifdef LIT_SPECULAR_OR_REFLECTION\n\t\t\t#ifdef LIT_SHEEN\n\t\t\t\t#include "sheenPS"\n\t\t\t\t#include "sheenGlossPS"\n\t\t\t#endif\n\t\t\t#ifdef LIT_METALNESS\n\t\t\t\t#include "metalnessPS"\n\t\t\t\t#include "iorPS"\n\t\t\t#endif\n\t\t\t#ifdef LIT_SPECULARITY_FACTOR\n\t\t\t\t#include "specularityFactorPS"\n\t\t\t#endif\n\t\t\t#ifdef STD_SPECULAR_COLOR\n\t\t\t\t#include "specularPS"\n\t\t\t#else\n\t\t\t\tvoid getSpecularity() { \n\t\t\t\t\tdSpecularity = vec3(1);\n\t\t\t\t}\n\t\t\t#endif\n\t\t\t#include "glossPS"\n\t\t#endif\n\t\t#ifdef STD_AO\n\t\t\t#include "aoPS"\n\t\t#endif\n\t\t#include "emissivePS"\n\t\t#ifdef LIT_CLEARCOAT\n\t\t\t#include "clearCoatPS"\n\t\t\t#include "clearCoatGlossPS"\n\t\t\t#include "clearCoatNormalPS"\n\t\t#endif\n\t\t#if defined(LIT_SPECULAR) && defined(LIT_LIGHTING) && defined(LIT_GGX_SPECULAR)\n\t\t\t#include "anisotropyPS"\n\t\t#endif\n\t\t#if defined(STD_LIGHTMAP) || defined(STD_LIGHT_VERTEX_COLOR)\n\t\t\t#include "lightmapPS"\n\t\t#endif\n\t#endif\n\tvoid evaluateFrontend() {\n\t\t#if LIT_BLEND_TYPE != NONE || defined(LIT_ALPHA_TEST) || defined(LIT_ALPHA_TO_COVERAGE) || STD_OPACITY_DITHER != NONE\n\t\t\tgetOpacity();\n\t\t\t#if defined(LIT_ALPHA_TEST)\n\t\t\t\talphaTest(dAlpha);\n\t\t\t#endif\n\t\t\t#if STD_OPACITY_DITHER != NONE\n\t\t\t\topacityDither(dAlpha, 0.0);\n\t\t\t#endif\n\t\t\tlitArgs_opacity = dAlpha;\n\t\t#endif\n\t\t#ifdef FORWARD_PASS\n\t\t\t#ifdef STD_HEIGHT_MAP\n\t\t\t\tgetParallax();\n\t\t\t#endif\n\t\t\tgetAlbedo();\n\t\t\tlitArgs_albedo = dAlbedo;\n\t\t\t#ifdef LIT_NEEDS_NORMAL\n\t\t\t\tgetNormal();\n\t\t\t\tlitArgs_worldNormal = dNormalW;\n\t\t\t#endif\n\t\t\t#ifdef LIT_REFRACTION\n\t\t\t\tgetRefraction();\n\t\t\t\tlitArgs_transmission = dTransmission;\n\t\t\t\tgetThickness();\n\t\t\t\tlitArgs_thickness = dThickness;\n\t\t\t\t#ifdef LIT_DISPERSION\n\t\t\t\t\tlitArgs_dispersion = material_dispersion;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\t#ifdef LIT_IRIDESCENCE\n\t\t\t\tgetIridescence();\n\t\t\t\tgetIridescenceThickness();\n\t\t\t\tlitArgs_iridescence_intensity = dIridescence;\n\t\t\t\tlitArgs_iridescence_thickness = dIridescenceThickness;\n\t\t\t#endif\n\t\t\t#ifdef LIT_SPECULAR_OR_REFLECTION\n\t\t\t\t#ifdef LIT_SHEEN\n\t\t\t\t\tgetSheen();\n\t\t\t\t\tlitArgs_sheen_specularity = sSpecularity;\n\t\t\t\t\tgetSheenGlossiness();\n\t\t\t\t\tlitArgs_sheen_gloss = sGlossiness;\n\t\t\t\t#endif\n\t\t\t\t#ifdef LIT_METALNESS\n\t\t\t\t\tgetMetalness();\n\t\t\t\t\tlitArgs_metalness = dMetalness;\n\t\t\t\t\tgetIor();\n\t\t\t\t\tlitArgs_ior = dIor;\n\t\t\t\t#endif\n\t\t\t\t#ifdef LIT_SPECULARITY_FACTOR\n\t\t\t\t\tgetSpecularityFactor();\n\t\t\t\t\tlitArgs_specularityFactor = dSpecularityFactor;\n\t\t\t\t#endif\n\t\t\t\tgetGlossiness();\n\t\t\t\tgetSpecularity();\n\t\t\t\tlitArgs_specularity = dSpecularity;\n\t\t\t\tlitArgs_gloss = dGlossiness;\n\t\t\t#endif\n\t\t\t#ifdef STD_AO\n\t\t\t\tgetAO();\n\t\t\t\tlitArgs_ao = dAo;\n\t\t\t#endif\n\t\t\tgetEmission();\n\t\t\tlitArgs_emission = dEmission;\n\t\t\t#ifdef LIT_CLEARCOAT\n\t\t\t\tgetClearCoat();\n\t\t\t\tgetClearCoatGlossiness();\n\t\t\t\tgetClearCoatNormal();\n\t\t\t\tlitArgs_clearcoat_specularity = ccSpecularity;\n\t\t\t\tlitArgs_clearcoat_gloss = ccGlossiness;\n\t\t\t\tlitArgs_clearcoat_worldNormal = ccNormalW;\n\t\t\t#endif\n\t\t\t#if defined(LIT_SPECULAR) && defined(LIT_LIGHTING) && defined(LIT_GGX_SPECULAR)\n\t\t\t\tgetAnisotropy();\n\t\t\t#endif\n\t\t\t#if defined(STD_LIGHTMAP) || defined(STD_LIGHT_VERTEX_COLOR)\n\t\t\t\tgetLightMap();\n\t\t\t\tlitArgs_lightmap = dLightmap;\n\t\t\t\t#ifdef STD_LIGHTMAP_DIR\n\t\t\t\t\tlitArgs_lightmapDir = dLightmapDir;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t#endif\n\t}\n',TBNPS:"\n#ifdef LIT_TANGENTS\n\t#define TBN_TANGENTS\n#else\n\t#if defined(LIT_USE_NORMALS) || defined(LIT_USE_CLEARCOAT_NORMALS)\n\t\t#define TBN_DERIVATIVES\n\t#endif\n#endif\n#if defined(TBN_DERIVATIVES)\n\tuniform float tbnBasis;\n#endif\nvoid getTBN(vec3 tangent, vec3 binormal, vec3 normal) {\n\t#ifdef TBN_TANGENTS\n\t\tdTBN = mat3(normalize(tangent), normalize(binormal), normalize(normal));\n\t#elif defined(TBN_DERIVATIVES)\n\t\tvec2 uv = {lightingUv};\n\t\tvec3 dp1 = dFdx( vPositionW );\n\t\tvec3 dp2 = dFdy( vPositionW );\n\t\tvec2 duv1 = dFdx( uv );\n\t\tvec2 duv2 = dFdy( uv );\n\t\tvec3 dp2perp = cross( dp2, normal );\n\t\tvec3 dp1perp = cross( normal, dp1 );\n\t\tvec3 T = dp2perp * duv1.x + dp1perp * duv2.x;\n\t\tvec3 B = dp2perp * duv1.y + dp1perp * duv2.y;\n\t\tfloat denom = max( dot(T,T), dot(B,B) );\n\t\tfloat invmax = (denom == 0.0) ? 0.0 : tbnBasis / sqrt( denom );\n\t\tdTBN = mat3(T * invmax, -B * invmax, normal );\n\t#else\n\t\tvec3 B = cross(normal, vObjectSpaceUpW);\n\t\tvec3 T = cross(normal, B);\n\t\tif (dot(B,B)==0.0)\n\t\t{\n\t\t\tfloat major=max(max(normal.x, normal.y), normal.z);\n\t\t\tif (normal.x == major)\n\t\t\t{\n\t\t\t\tB = cross(normal, vec3(0,1,0));\n\t\t\t\tT = cross(normal, B);\n\t\t\t}\n\t\t\telse if (normal.y == major)\n\t\t\t{\n\t\t\t\tB = cross(normal, vec3(0,0,1));\n\t\t\t\tT = cross(normal, B);\n\t\t\t}\n\t\t\telse if (normal.z == major)\n\t\t\t{\n\t\t\t\tB = cross(normal, vec3(1,0,0));\n\t\t\t\tT = cross(normal, B);\n\t\t\t}\n\t\t}\n\t\tdTBN = mat3(normalize(T), normalize(B), normalize(normal));\n\t#endif\n}\n",thicknessPS:"\n#ifdef STD_THICKNESS_CONSTANT\nuniform float material_thickness;\n#endif\nvoid getThickness() {\n\tdThickness = 1.0;\n\t#ifdef STD_THICKNESS_CONSTANT\n\tdThickness *= material_thickness;\n\t#endif\n\t#ifdef STD_THICKNESS_TEXTURE\n\tdThickness *= texture2DBias({STD_THICKNESS_TEXTURE_NAME}, {STD_THICKNESS_TEXTURE_UV}, textureBias).{STD_THICKNESS_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_THICKNESS_VERTEX\n\tdThickness *= saturate(vVertexColor.{STD_THICKNESS_VERTEX_CHANNEL});\n\t#endif\n}\n",tonemappingPS:'\n#if (TONEMAP == NONE)\n\t#include "tonemappingNonePS"\n#elif TONEMAP == FILMIC\n\t#include "tonemappingFilmicPS"\n#elif TONEMAP == LINEAR\n\t#include "tonemappingLinearPS"\n#elif TONEMAP == HEJL\n\t#include "tonemappingHejlPS"\n#elif TONEMAP == ACES\n\t#include "tonemappingAcesPS"\n#elif TONEMAP == ACES2\n\t#include "tonemappingAces2PS"\n#elif TONEMAP == NEUTRAL\n\t#include "tonemappingNeutralPS"\n#endif\n',tonemappingAcesPS:"\nuniform float exposure;\nvec3 toneMap(vec3 color) {\n\tfloat tA = 2.51;\n\tfloat tB = 0.03;\n\tfloat tC = 2.43;\n\tfloat tD = 0.59;\n\tfloat tE = 0.14;\n\tvec3 x = color * exposure;\n\treturn (x*(tA*x+tB))/(x*(tC*x+tD)+tE);\n}\n",tonemappingAces2PS:"\nuniform float exposure;\nconst mat3 ACESInputMat = mat3(\n\t0.59719, 0.35458, 0.04823,\n\t0.07600, 0.90834, 0.01566,\n\t0.02840, 0.13383, 0.83777\n);\nconst mat3 ACESOutputMat = mat3(\n\t 1.60475, -0.53108, -0.07367,\n\t-0.10208,  1.10813, -0.00605,\n\t-0.00327, -0.07276,  1.07602\n);\nvec3 RRTAndODTFit(vec3 v) {\n\tvec3 a = v * (v + 0.0245786) - 0.000090537;\n\tvec3 b = v * (0.983729 * v + 0.4329510) + 0.238081;\n\treturn a / b;\n}\nvec3 toneMap(vec3 color) {\n\tcolor *= exposure / 0.6;\n\tcolor = color * ACESInputMat;\n\tcolor = RRTAndODTFit(color);\n\tcolor = color * ACESOutputMat;\n\tcolor = clamp(color, 0.0, 1.0);\n\treturn color;\n}\n",tonemappingFilmicPS:"\nconst float A =  0.15;\nconst float B =  0.50;\nconst float C =  0.10;\nconst float D =  0.20;\nconst float E =  0.02;\nconst float F =  0.30;\nconst float W =  11.2;\nuniform float exposure;\nvec3 uncharted2Tonemap(vec3 x) {\n\t return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;\n}\nvec3 toneMap(vec3 color) {\n\tcolor = uncharted2Tonemap(color * exposure);\n\tvec3 whiteScale = 1.0 / uncharted2Tonemap(vec3(W,W,W));\n\tcolor = color * whiteScale;\n\treturn color;\n}\n",tonemappingHejlPS:"\nuniform float exposure;\nvec3 toneMap(vec3 color) {\n\tcolor *= exposure;\n\tconst float  A = 0.22, B = 0.3, C = .1, D = 0.2, E = .01, F = 0.3;\n\tconst float Scl = 1.25;\n\tvec3 h = max( vec3(0.0), color - vec3(0.004) );\n\treturn (h*((Scl*A)*h+Scl*vec3(C*B,C*B,C*B))+Scl*vec3(D*E,D*E,D*E)) / (h*(A*h+vec3(B,B,B))+vec3(D*F,D*F,D*F)) - Scl*vec3(E/F,E/F,E/F);\n}\n",tonemappingLinearPS:"\nuniform float exposure;\nvec3 toneMap(vec3 color) {\n\treturn color * exposure;\n}\n",tonemappingNeutralPS:"\nuniform float exposure;\nvec3 toneMap(vec3 color) {\n\tcolor *= exposure;\n\tfloat startCompression = 0.8 - 0.04;\n\tfloat desaturation = 0.15;\n\tfloat x = min(color.r, min(color.g, color.b));\n\tfloat offset = x < 0.08 ? x - 6.25 * x * x : 0.04;\n\tcolor -= offset;\n\tfloat peak = max(color.r, max(color.g, color.b));\n\tif (peak < startCompression) return color;\n\tfloat d = 1. - startCompression;\n\tfloat newPeak = 1. - d * d / (peak + d - startCompression);\n\tcolor *= newPeak / peak;\n\tfloat g = 1. - 1. / (desaturation * (peak - newPeak) + 1.);\n\treturn mix(color, newPeak * vec3(1, 1, 1), g);\n}\n",tonemappingNonePS:"\nvec3 toneMap(vec3 color) {\n\treturn color;\n}\n",transformVS:"\n#ifdef PIXELSNAP\nuniform vec4 uScreenSize;\n#endif\n#ifdef SCREENSPACE\nuniform float projectionFlipY;\n#endif\nvec4 evalWorldPosition(vec3 vertexPosition, mat4 modelMatrix) {\n\tvec3 localPos = getLocalPosition(vertexPosition);\n\t#ifdef NINESLICED\n\t\tlocalPos.xz *= outerScale;\n\t\tvec2 positiveUnitOffset = clamp(vertexPosition.xz, vec2(0.0), vec2(1.0));\n\t\tvec2 negativeUnitOffset = clamp(-vertexPosition.xz, vec2(0.0), vec2(1.0));\n\t\tlocalPos.xz += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;\n\t\tvTiledUv = (localPos.xz - outerScale + innerOffset.xy) * -0.5 + 1.0;\n\t\tlocalPos.xz *= -0.5;\n\t\tlocalPos = localPos.xzy;\n\t#endif\n\tvec4 posW = modelMatrix * vec4(localPos, 1.0);\n\t#ifdef SCREENSPACE\n\t\tposW.zw = vec2(0.0, 1.0);\n\t#endif\n\treturn posW;\n}\nvec4 getPosition() {\n\tdModelMatrix = getModelMatrix();\n\tvec4 posW = evalWorldPosition(vertex_position.xyz, dModelMatrix);\n\tdPositionW = posW.xyz;\n\tvec4 screenPos;\n\t#ifdef UV1LAYOUT\n\t\tscreenPos = vec4(vertex_texCoord1.xy * 2.0 - 1.0, 0.5, 1);\n\t\t#ifdef WEBGPU\n\t\t\tscreenPos.y *= -1.0;\n\t\t#endif\n\t#else\n\t\t#ifdef SCREENSPACE\n\t\t\tscreenPos = posW;\n\t\t\tscreenPos.y *= projectionFlipY;\n\t\t#else\n\t\t\tscreenPos = matrix_viewProjection * posW;\n\t\t#endif\n\t\t#ifdef PIXELSNAP\n\t\t\tscreenPos.xy = (screenPos.xy * 0.5) + 0.5;\n\t\t\tscreenPos.xy *= uScreenSize.xy;\n\t\t\tscreenPos.xy = floor(screenPos.xy);\n\t\t\tscreenPos.xy *= uScreenSize.zw;\n\t\t\tscreenPos.xy = (screenPos.xy * 2.0) - 1.0;\n\t\t#endif\n\t#endif\n\treturn screenPos;\n}\nvec3 getWorldPosition() {\n\treturn dPositionW;\n}\n",transformCoreVS:'\nattribute vec4 vertex_position;\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\n#ifdef MORPHING\n\tuniform vec2 morph_tex_params;\n\tattribute uint morph_vertex_id;\n\tivec2 getTextureMorphCoords() {\n\t\tivec2 textureSize = ivec2(morph_tex_params);\n\t\tint morphGridV = int(morph_vertex_id) / textureSize.x;\n\t\tint morphGridU = int(morph_vertex_id) - (morphGridV * textureSize.x);\n\t\t#ifdef WEBGPU\n\t\t\tmorphGridV = textureSize.y - morphGridV - 1;\n\t\t#endif\n\t\treturn ivec2(morphGridU, morphGridV);\n\t}\n\t#ifdef MORPHING_POSITION\n\t\t#ifdef MORPHING_INT\n\t\t\tuniform vec3 aabbSize;\n\t\t\tuniform vec3 aabbMin;\n\t\t\tuniform usampler2D morphPositionTex;\n\t\t#else\n\t\t\tuniform highp sampler2D morphPositionTex;\n\t\t#endif\n\t#endif\n#endif\n#ifdef defined(BATCH)\n\t#include "skinBatchVS"\n\tmat4 getModelMatrix() {\n\t\treturn getBoneMatrix(vertex_boneIndices);\n\t}\n#elif defined(SKIN)\n\t#include "skinVS"\n\tmat4 getModelMatrix() {\n\t\treturn matrix_model * getSkinMatrix(vertex_boneIndices, vertex_boneWeights);\n\t}\n#elif defined(INSTANCING)\n\t#include "transformInstancingVS"\n#else\n\tmat4 getModelMatrix() {\n\t\treturn matrix_model;\n\t}\n#endif\nvec3 getLocalPosition(vec3 vertexPosition) {\n\tvec3 localPos = vertexPosition;\n\t#ifdef MORPHING_POSITION\n\t\tivec2 morphUV = getTextureMorphCoords();\n\t\t#ifdef MORPHING_INT\n\t\t\tvec3 morphPos = vec3(texelFetch(morphPositionTex, ivec2(morphUV), 0).xyz) / 65535.0 * aabbSize + aabbMin;\n\t\t#else\n\t\t\tvec3 morphPos = texelFetch(morphPositionTex, ivec2(morphUV), 0).xyz;\n\t\t#endif\n\t\tlocalPos += morphPos;\n\t#endif\n\treturn localPos;\n}\n',transformInstancingVS:"\nattribute vec4 instance_line1;\nattribute vec4 instance_line2;\nattribute vec4 instance_line3;\nattribute vec4 instance_line4;\nmat4 getModelMatrix() {\n\treturn matrix_model * mat4(instance_line1, instance_line2, instance_line3, instance_line4);\n}\n",transmissionPS:"\n#ifdef STD_REFRACTION_CONSTANT\nuniform float material_refraction;\n#endif\nvoid getRefraction() {\n\tfloat refraction = 1.0;\n\t#ifdef STD_REFRACTION_CONSTANT\n\trefraction = material_refraction;\n\t#endif\n\t#ifdef STD_REFRACTION_TEXTURE\n\trefraction *= texture2DBias({STD_REFRACTION_TEXTURE_NAME}, {STD_REFRACTION_TEXTURE_UV}, textureBias).{STD_REFRACTION_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_REFRACTION_VERTEX\n\trefraction *= saturate(vVertexColor.{STD_REFRACTION_VERTEX_CHANNEL});\n\t#endif\n\tdTransmission = refraction;\n}\n",twoSidedLightingPS:"\nuniform float twoSidedLightingNegScaleFactor;\nvoid handleTwoSidedLighting() {\n\tdTBN[2] *= gl_FrontFacing ? twoSidedLightingNegScaleFactor : -twoSidedLightingNegScaleFactor;\n}\n",uv0VS:"\n#ifdef NINESLICED\n\tvec2 getUv0() {\n\t\tvec2 uv = vertex_position.xz;\n\t\tvec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));\n\t\tvec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));\n\t\tuv += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;\n\t\tuv = uv * -0.5 + 0.5;\n\t\tuv = uv * atlasRect.zw + atlasRect.xy;\n\t\tvMask = vertex_texCoord0.xy;\n\t\treturn uv;\n\t}\n#else\n\tvec2 getUv0() {\n\t\treturn vertex_texCoord0;\n\t}\n#endif\n",uv1VS:"\nvec2 getUv1() {\n\treturn vertex_texCoord1;\n}\n",uvTransformVS:"\nvUV{TRANSFORM_UV_{i}}_{TRANSFORM_ID_{i}} = vec2(\n\tdot(vec3(uv{TRANSFORM_UV_{i}}, 1), {TRANSFORM_NAME_{i}}0),\n\tdot(vec3(uv{TRANSFORM_UV_{i}}, 1), {TRANSFORM_NAME_{i}}1)\n);\n",uvTransformUniformsPS:"\n\tuniform vec3 {TRANSFORM_NAME_{i}}0;\n\tuniform vec3 {TRANSFORM_NAME_{i}}1;\n",viewDirPS:"\nvoid getViewDir() {\n\tdViewDirW = normalize(view_position - vPositionW);\n}\n",webgpuPS:Aa,webgpuVS:Da};const rg={alphaTestPS:"\nuniform alpha_ref: f32;\nfn alphaTest(a: f32) {\n\tif (a < uniform.alpha_ref) {\n\t\tdiscard;\n\t}\n}\n",ambientPS:'\n#if LIT_AMBIENT_SOURCE == AMBIENTSH\n\tuniform ambientSH: array<vec3f, 9>;\n#endif\n#if LIT_AMBIENT_SOURCE == ENVALATLAS\n\t#include "envAtlasPS"\n\t#ifndef ENV_ATLAS\n\t\t#define ENV_ATLAS\n\t\tvar texture_envAtlas: texture_2d<f32>;\n\t\tvar texture_envAtlasSampler: sampler;\n\t#endif\n#endif\nfn addAmbient(worldNormal: vec3f) {\n\t#ifdef LIT_AMBIENT_SOURCE == AMBIENTSH\n\t\tlet n: vec3f = cubeMapRotate(worldNormal);\n\t\tlet color: vec3f =\n\t\t\tuniform.ambientSH[0] +\n\t\t\tuniform.ambientSH[1] * n.x +\n\t\t\tuniform.ambientSH[2] * n.y +\n\t\t\tuniform.ambientSH[3] * n.z +\n\t\t\tuniform.ambientSH[4] * n.x * n.z +\n\t\t\tuniform.ambientSH[5] * n.z * n.y +\n\t\t\tuniform.ambientSH[6] * n.y * n.x +\n\t\t\tuniform.ambientSH[7] * (3.0 * n.z * n.z - 1.0) +\n\t\t\tuniform.ambientSH[8] * (n.x * n.x - n.y * n.y);\n\t\tdDiffuseLight += processEnvironment(max(color, vec3f(0.0)));\n\t#endif\n\t#if LIT_AMBIENT_SOURCE == ENVALATLAS\n\t\tlet dir: vec3f = normalize(cubeMapRotate(worldNormal) * vec3f(-1.0, 1.0, 1.0));\n\t\tlet uv: vec2f = mapUv(toSphericalUv(dir), vec4f(128.0, 256.0 + 128.0, 64.0, 32.0) / atlasSize);\n\t\tlet raw: vec4f = textureSample(texture_envAtlas, texture_envAtlasSampler, uv);\n\t\tlet linear: vec3f = {ambientDecode}(raw);\n\t\tdDiffuseLight += processEnvironment(linear);\n\t#endif\n\t#if LIT_AMBIENT_SOURCE == CONSTANT\n\t\tdDiffuseLight += uniform.light_globalAmbient;\n\t#endif\n}\n',anisotropyPS:"\n#ifdef LIT_GGX_SPECULAR\n\tuniform material_anisotropyIntensity: f32;\n\tuniform material_anisotropyRotation: vec2f;\n#endif\nfn getAnisotropy() {\n\tdAnisotropy = 0.0;\n\tdAnisotropyRotation = vec2f(1.0, 0.0);\n#ifdef LIT_GGX_SPECULAR\n\tdAnisotropy = uniform.material_anisotropyIntensity;\n\tdAnisotropyRotation = uniform.material_anisotropyRotation;\n#endif\n#ifdef STD_ANISOTROPY_TEXTURE\n\tlet anisotropyTex: vec3f = textureSampleBias({STD_ANISOTROPY_TEXTURE_NAME}, {STD_ANISOTROPY_TEXTURE_NAME}Sampler, {STD_ANISOTROPY_TEXTURE_UV}, uniform.textureBias).rgb;\n\tdAnisotropy *= anisotropyTex.b;\n\tlet anisotropyRotationFromTex: vec2f = anisotropyTex.rg * 2.0 - vec2f(1.0);\n\tlet rotationMatrix: mat2x2f = mat2x2f(dAnisotropyRotation.x, dAnisotropyRotation.y, -dAnisotropyRotation.y, dAnisotropyRotation.x);\n\tdAnisotropyRotation = rotationMatrix * anisotropyRotationFromTex;\n#endif\n\tdAnisotropy = clamp(dAnisotropy, 0.0, 1.0);\n}\n",aoPS:'\n#if defined(STD_AO_TEXTURE) || defined(STD_AO_VERTEX)\n\tuniform material_aoIntensity: f32;\n#endif\n#ifdef STD_AODETAIL_TEXTURE\n\t#include "detailModesPS"\n#endif\nfn getAO() {\n\tdAo = 1.0;\n\t#ifdef STD_AO_TEXTURE\n\t\tvar aoBase: f32 = textureSampleBias({STD_AO_TEXTURE_NAME}, {STD_AO_TEXTURE_NAME}Sampler, {STD_AO_TEXTURE_UV}, uniform.textureBias).{STD_AO_TEXTURE_CHANNEL};\n\t\t#ifdef STD_AODETAIL_TEXTURE\n\t\t\tvar aoDetail: f32 = textureSampleBias({STD_AODETAIL_TEXTURE_NAME}, {STD_AODETAIL_TEXTURE_NAME}Sampler, {STD_AODETAIL_TEXTURE_UV}, uniform.textureBias).{STD_AODETAIL_TEXTURE_CHANNEL};\n\t\t\taoBase = detailMode_{STD_AODETAIL_DETAILMODE}(vec3f(aoBase), vec3f(aoDetail)).r;\n\t\t#endif\n\t\tdAo = dAo * aoBase;\n\t#endif\n\t#ifdef STD_AO_VERTEX\n\t\tdAo = dAo * saturate(vVertexColor.{STD_AO_VERTEX_CHANNEL});\n\t#endif\n\t#if defined(STD_AO_TEXTURE) || defined(STD_AO_VERTEX)\n\t\tdAo = mix(1.0, dAo, uniform.material_aoIntensity);\n\t#endif\n}\n',aoDiffuseOccPS:"\nfn occludeDiffuse(ao: f32) {\n\tdDiffuseLight = dDiffuseLight * ao;\n}\n",aoSpecOccPS:"\n#if LIT_OCCLUDE_SPECULAR != NONE\n\t#ifdef LIT_OCCLUDE_SPECULAR_FLOAT\n\t\tuniform material_occludeSpecularIntensity: f32;\n\t#endif\n#endif\nfn occludeSpecular(gloss: f32, ao: f32, worldNormal: vec3f, viewDir: vec3f) {\n\t#if LIT_OCCLUDE_SPECULAR == AO\n\t\t#ifdef LIT_OCCLUDE_SPECULAR_FLOAT\n\t\t\tvar specOcc: f32 = mix(1.0, ao, uniform.material_occludeSpecularIntensity);\n\t\t#else\n\t\t\tvar specOcc: f32 = ao;\n\t\t#endif\n\t#endif\n\t#if LIT_OCCLUDE_SPECULAR == GLOSSDEPENDENT\n\t\tvar specPow: f32 = exp2(gloss * 11.0);\n\t\tvar specOcc: f32 = saturate(pow(dot(worldNormal, viewDir) + ao, 0.01 * specPow) - 1.0 + ao);\n\t\t#ifdef LIT_OCCLUDE_SPECULAR_FLOAT\n\t\t\tspecOcc = mix(1.0, specOcc, uniform.material_occludeSpecularIntensity);\n\t\t#endif\n\t#endif\n\t#if LIT_OCCLUDE_SPECULAR != NONE\n\t\tdSpecularLight = dSpecularLight * specOcc;\n\t\tdReflection = dReflection * specOcc;\n\t\t#ifdef LIT_SHEEN\n\t\t\tsSpecularLight = sSpecularLight * specOcc;\n\t\t\tsReflection = sReflection * specOcc;\n\t\t#endif\n\t#endif\n}\n",bakeDirLmEndPS:"\n\tlet dirLm = textureSample(texture_dirLightMap, texture_dirLightMapSampler, vUv1);\n\tif (uniform.bakeDir > 0.5) {\n\t\tif (dAtten > 0.00001) {\n\t\t\tlet unpacked_dir = dirLm.xyz * 2.0 - vec3f(1.0);\n\t\t\tdAtten = clamp(dAtten, 0.0, 1.0);\n\t\t\tlet combined_dir = dLightDirNormW.xyz * dAtten + unpacked_dir * dirLm.w;\n\t\t\tlet finalRgb = normalize(combined_dir) * 0.5 + vec3f(0.5);\n\t\t\tlet finalA = max(dirLm.w + dAtten, 1.0 / 255.0);\n\t\t\toutput.color = vec4f(finalRgb, finalA);\n\t\t} else {\n\t\t\toutput.color = dirLm;\n\t\t}\n\t} else {\n\t\tlet alpha_min = select(0.0, 1.0 / 255.0, dAtten > 0.00001);\n\t\tlet finalA = max(dirLm.w, alpha_min);\n\t\toutput.color = vec4f(dirLm.rgb, finalA);\n\t}\n",bakeLmEndPS:"\n#ifdef LIT_LIGHTMAP_BAKING_ADD_AMBIENT\n\tdDiffuseLight = ((dDiffuseLight - 0.5) * max(uniform.ambientBakeOcclusionContrast + 1.0, 0.0)) + 0.5;\n\tdDiffuseLight = dDiffuseLight + vec3f(uniform.ambientBakeOcclusionBrightness);\n\tdDiffuseLight = saturate3(dDiffuseLight);\n\tdDiffuseLight = dDiffuseLight * dAmbientLight;\n#endif\n#ifdef LIGHTMAP_RGBM\n\tvar temp_color_rgbm = vec4f(dDiffuseLight, 1.0);\n\ttemp_color_rgbm = vec4f(pow(temp_color_rgbm.rgb, vec3f(0.5)), temp_color_rgbm.a);\n\ttemp_color_rgbm = vec4f(temp_color_rgbm.rgb / 8.0, temp_color_rgbm.a);\n\tlet max_g_b = max(temp_color_rgbm.g, max(temp_color_rgbm.b, 1.0 / 255.0));\n\tlet max_rgb = max(temp_color_rgbm.r, max_g_b);\n\ttemp_color_rgbm.a = clamp(max_rgb, 0.0, 1.0);\n\ttemp_color_rgbm.a = ceil(temp_color_rgbm.a * 255.0) / 255.0;\n\ttemp_color_rgbm = vec4f(temp_color_rgbm.rgb / temp_color_rgbm.a, temp_color_rgbm.a);\n\toutput.color = temp_color_rgbm;\n#else\n\toutput.color = vec4f(dDiffuseLight, 1.0);\n#endif\n",basePS:"\nuniform view_position: vec3f;\nuniform light_globalAmbient: vec3f;\nfn square(x: f32) -> f32 {\n\treturn x*x;\n}\nfn saturate(x: f32) -> f32 {\n\treturn clamp(x, 0.0, 1.0);\n}\nfn saturate3(x: vec3f) -> vec3f {\n\treturn clamp(x, vec3f(0.0), vec3f(1.0));\n}\n",baseNineSlicedPS:"\n#define NINESLICED\nvarying vMask: vec2f;\nvarying vTiledUv: vec2f;\nuniform innerOffset: vec4f;\nuniform outerScale: vec2f;\nuniform atlasRect: vec4f;\nvar<private> nineSlicedUv: vec2f;\n",baseNineSlicedTiledPS:"\n#define NINESLICED\n#define NINESLICETILED\nvarying vMask: vec2f;\nvarying vTiledUv: vec2f;\nuniform innerOffset: vec4f;\nuniform outerScale: vec2f;\nuniform atlasRect: vec4f;\nvar<private> nineSlicedUv: vec2f;\n",bayerPS:"\nfn bayer2(p: vec2f) -> f32 {\n\treturn (2.0 * p.y + p.x + 1.0) % 4.0;\n}\nfn bayer4(p: vec2f) -> f32 {\n\tlet p1: vec2f = p % vec2f(2.0);\n\tlet p2: vec2f = floor(0.5 * (p % vec2f(4.0)));\n\treturn 4.0 * bayer2(p1) + bayer2(p2);\n}\nfn bayer8(p: vec2f) -> f32 {\n\tlet p1: vec2f = p % vec2f(2.0);\n\tlet p2: vec2f = floor(0.5 * (p % vec2f(4.0)));\n\tlet p4: vec2f = floor(0.25 * (p % vec2f(8.0)));\n\treturn 4.0 * (4.0 * bayer2(p1) + bayer2(p2)) + bayer2(p4);\n}\n",blurVSMPS:"\nvarying vUv0: vec2f;\nvar source: texture_2d<f32>;\nvar sourceSampler: sampler;\n#ifdef GAUSS\n\tuniform weight: array<f32, {SAMPLES}>;\n#endif\nuniform pixelOffset: vec2f;\n@fragment\nfn fragmentMain(input: FragmentInput) -> FragmentOutput {\n\tvar output: FragmentOutput;\n\tvar moments: vec3f = vec3f(0.0);\n\tlet uv: vec2f = input.vUv0 - uniform.pixelOffset * (f32({SAMPLES}) * 0.5);\n\tfor (var i: i32 = 0; i < {SAMPLES}; i = i + 1) {\n\t\tlet c: vec4f = textureSample(source, sourceSampler, uv + uniform.pixelOffset * f32(i));\n\t\t#ifdef GAUSS\n\t\t\tmoments = moments + c.xyz * uniform.weight[i].element;\n\t\t#else\n\t\t\tmoments = moments + c.xyz;\n\t\t#endif\n\t}\n\t#ifndef GAUSS\n\t\tmoments = moments * (1.0 / f32({SAMPLES}));\n\t#endif\n\toutput.color = vec4f(moments, 1.0);\n\treturn output;\n}\n",clearCoatPS:"\nuniform material_clearCoat: f32;\nfn getClearCoat() {\n\tccSpecularity = uniform.material_clearCoat;\n\t#ifdef STD_CLEARCOAT_TEXTURE\n\tccSpecularity = ccSpecularity * textureSampleBias({STD_CLEARCOAT_TEXTURE_NAME}, {STD_CLEARCOAT_TEXTURE_NAME}Sampler, {STD_CLEARCOAT_TEXTURE_UV}, uniform.textureBias).{STD_CLEARCOAT_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_CLEARCOAT_VERTEX\n\tccSpecularity = ccSpecularity * saturate(vVertexColor.{STD_CLEARCOAT_VERTEX_CHANNEL});\n\t#endif\n}\n",clearCoatGlossPS:"\n\tuniform material_clearCoatGloss: f32;\nfn getClearCoatGlossiness() {\n\tccGlossiness = uniform.material_clearCoatGloss;\n\t#ifdef STD_CLEARCOATGLOSS_TEXTURE\n\tccGlossiness = ccGlossiness * textureSampleBias({STD_CLEARCOATGLOSS_TEXTURE_NAME}, {STD_CLEARCOATGLOSS_TEXTURE_NAME}Sampler, {STD_CLEARCOATGLOSS_TEXTURE_UV}, uniform.textureBias).{STD_CLEARCOATGLOSS_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_CLEARCOATGLOSS_VERTEX\n\tccGlossiness = ccGlossiness * saturate(vVertexColor.{STD_CLEARCOATGLOSS_VERTEX_CHANNEL});\n\t#endif\n\t#ifdef STD_CLEARCOATGLOSS_INVERT\n\tccGlossiness = 1.0 - ccGlossiness;\n\t#endif\n\tccGlossiness += 0.0000001;\n}\n",clearCoatNormalPS:"\n#ifdef STD_CLEARCOATNORMAL_TEXTURE\n\tuniform material_clearCoatBumpiness: f32;\n#endif\nfn getClearCoatNormal() {\n#ifdef STD_CLEARCOATNORMAL_TEXTURE\n\tvar normalMap: vec3f = {STD_CLEARCOATNORMAL_TEXTURE_DECODE}(textureSampleBias({STD_CLEARCOATNORMAL_TEXTURE_NAME}, {STD_CLEARCOATNORMAL_TEXTURE_NAME}Sampler, {STD_CLEARCOATNORMAL_TEXTURE_UV}, uniform.textureBias));\n\tnormalMap = mix(vec3f(0.0, 0.0, 1.0), normalMap, uniform.material_clearCoatBumpiness);\n\tccNormalW = normalize(dTBN * normalMap);\n#else\n\tccNormalW = dVertexNormalW;\n#endif\n}\n",clusteredLightCookiesPS:"\nfn _getCookieClustered(tex: texture_2d<f32>, texSampler: sampler, uv: vec2f, intensity: f32, cookieChannel: vec4f) -> vec3f {\n\tlet pixel: vec4f = mix(vec4f(1.0), textureSampleLevel(tex, texSampler, uv, 0.0), intensity);\n\tlet isRgb: bool = dot(cookieChannel.rgb, vec3f(1.0)) == 3.0;\n\treturn select(vec3f(dot(pixel, cookieChannel)), pixel.rgb, isRgb);\n}\nfn getCookie2DClustered(tex: texture_2d<f32>, texSampler: sampler, transform: mat4x4f, worldPosition: vec3f, intensity: f32, cookieChannel: vec4f) -> vec3f {\n\tlet projPos: vec4f = transform * vec4f(worldPosition, 1.0);\n\treturn _getCookieClustered(tex, texSampler, projPos.xy / projPos.w, intensity, cookieChannel);\n}\nfn getCookieCubeClustered(tex: texture_2d<f32>, texSampler: sampler, dir: vec3f, intensity: f32, cookieChannel: vec4f, shadowTextureResolution: f32, shadowEdgePixels: f32, omniAtlasViewport: vec3f) -> vec3f {\n\tlet uv: vec2f = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);\n\treturn _getCookieClustered(tex, texSampler, uv, intensity, cookieChannel);\n}\n",clusteredLightShadowsPS:"\nfn _getShadowCoordPerspZbuffer(shadowMatrix: mat4x4f, shadowParams: vec4f, wPos: vec3f) -> vec3f {\n\tvar projPos = shadowMatrix * vec4f(wPos, 1.0);\n\treturn projPos.xyz / projPos.w;\n}\nfn getShadowCoordPerspZbufferNormalOffset(shadowMatrix: mat4x4f, shadowParams: vec4f, normal: vec3f) -> vec3f {\n\tlet wPos: vec3f = vPositionW + normal * shadowParams.y;\n\treturn _getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, wPos);\n}\nfn normalOffsetPointShadow(shadowParams: vec4f, lightPos: vec3f, lightDir: vec3f, lightDirNorm: vec3f, normal: vec3f) -> vec3f {\n\tlet distScale: f32 = length(lightDir);\n\tlet wPos: vec3f = vPositionW + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;\n\tlet dir: vec3f = wPos - lightPos;\n\treturn dir;\n}\n#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\tfn getShadowOmniClusteredPCF1(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowParams: vec4f, omniAtlasViewport: vec3f, shadowEdgePixels: f32, lightDir: vec3f) -> f32 {\n\t\tlet shadowTextureResolution: f32 = shadowParams.x;\n\t\tlet uv: vec2f = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);\n\t\tlet shadowZ: f32 = length(lightDir) * shadowParams.w + shadowParams.z;\n\t\treturn textureSampleCompareLevel(shadowMap, shadowMapSampler, uv, shadowZ);\n\t}\n#endif\n#if defined(CLUSTER_SHADOW_TYPE_PCF3)\n\tfn getShadowOmniClusteredPCF3(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowParams: vec4f, omniAtlasViewport: vec3f, shadowEdgePixels: f32, lightDir: vec3f) -> f32 {\n\t\tlet shadowTextureResolution: f32 = shadowParams.x;\n\t\tlet uv: vec2f = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);\n\t\tlet shadowZ: f32 = length(lightDir) * shadowParams.w + shadowParams.z;\n\t\tlet shadowCoord: vec3f = vec3f(uv, shadowZ);\n\t\treturn getShadowPCF3x3(shadowMap, shadowMapSampler, shadowCoord, shadowParams);\n\t}\n#endif\n#if defined(CLUSTER_SHADOW_TYPE_PCF5)\n\tfn getShadowOmniClusteredPCF5(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowParams: vec4f, omniAtlasViewport: vec3f, shadowEdgePixels: f32, lightDir: vec3f) -> f32 {\n\t\tlet shadowTextureResolution: f32 = shadowParams.x;\n\t\tlet uv: vec2f = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);\n\t\tlet shadowZ: f32 = length(lightDir) * shadowParams.w + shadowParams.z;\n\t\tlet shadowCoord: vec3f = vec3f(uv, shadowZ);\n\t\treturn getShadowPCF5x5(shadowMap, shadowMapSampler, shadowCoord, shadowParams);\n\t}\n#endif\n#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\tfn getShadowSpotClusteredPCF1(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {\n\t\treturn textureSampleCompareLevel(shadowMap, shadowMapSampler, shadowCoord.xy, shadowCoord.z);\n\t}\n#endif\n\t#if defined(CLUSTER_SHADOW_TYPE_PCF3)\n\tfn getShadowSpotClusteredPCF3(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {\n\t\treturn getShadowSpotPCF3x3(shadowMap, shadowMapSampler, shadowCoord, shadowParams);\n\t}\n#endif\n\t#if defined(CLUSTER_SHADOW_TYPE_PCF5)\n\tfn getShadowSpotClusteredPCF5(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {\n\t\treturn getShadowPCF5x5(shadowMap, shadowMapSampler, shadowCoord, shadowParams);\n\t}\n#endif\n",clusteredLightUtilsPS:"\nstruct FaceCoords {\n\tuv: vec2f,\n\tfaceIndex: f32,\n\ttileOffset: vec2f,\n}\nfn getCubemapFaceCoordinates(dir: vec3f) -> FaceCoords {\n\tvar faceIndex: f32;\n\tvar tileOffset: vec2f;\n\tvar uv: vec2f;\n\tlet vAbs: vec3f = abs(dir);\n\tvar ma: f32;\n\tif (vAbs.z >= vAbs.x && vAbs.z >= vAbs.y) {\n\t\tlet is_neg_z = dir.z < 0.0;\n\t\tfaceIndex = select(4.0, 5.0, is_neg_z);\n\t\tma = 0.5 / vAbs.z;\n\t\tuv = vec2f(select(dir.x, -dir.x, is_neg_z), -dir.y);\n\t\ttileOffset = vec2f(2.0, select(0.0, 1.0, is_neg_z));\n\t} else if (vAbs.y >= vAbs.x) {\n\t\tlet is_neg_y = dir.y < 0.0;\n\t\tfaceIndex = select(2.0, 3.0, is_neg_y);\n\t\tma = 0.5 / vAbs.y;\n\t\tuv = vec2f(dir.x, select(dir.z, -dir.z, is_neg_y));\n\t\ttileOffset = vec2f(1.0, select(0.0, 1.0, is_neg_y));\n\t} else {\n\t\tlet is_neg_x = dir.x < 0.0;\n\t\tfaceIndex = select(0.0, 1.0, is_neg_x);\n\t\tma = 0.5 / vAbs.x;\n\t\tuv = vec2f(select(-dir.z, dir.z, is_neg_x), -dir.y);\n\t\ttileOffset = vec2f(0.0, select(0.0, 1.0, is_neg_x));\n\t}\n\tuv = uv * ma + 0.5;\n\treturn FaceCoords(uv, faceIndex, tileOffset);\n}\nfn getCubemapAtlasCoordinates(omniAtlasViewport: vec3f, shadowEdgePixels: f32, shadowTextureResolution: f32, dir: vec3f) -> vec2f {\n\tlet faceData: FaceCoords = getCubemapFaceCoordinates(dir);\n\tvar uv: vec2f = faceData.uv;\n\tlet tileOffset: vec2f = faceData.tileOffset;\n\tlet atlasFaceSize: f32 = omniAtlasViewport.z;\n\tlet tileSize: f32 = shadowTextureResolution * atlasFaceSize;\n\tvar offset: f32 = shadowEdgePixels / tileSize;\n\tuv = uv * (1.0 - offset * 2.0) + offset;\n\tuv = uv * atlasFaceSize;\n\tuv = uv + tileOffset * atlasFaceSize;\n\tuv = uv + omniAtlasViewport.xy;\n\treturn uv;\n}\n",clusteredLightPS:'\n#include "lightBufferDefinesPS"\n#include "clusteredLightUtilsPS"\n#ifdef CLUSTER_COOKIES\n\t#include "clusteredLightCookiesPS"\n#endif\n#ifdef CLUSTER_SHADOWS\n\t#include "clusteredLightShadowsPS"\n#endif\nvar clusterWorldTexture: texture_2d<f32>;\nvar lightsTexture: texture_2d<uff>;\n#ifdef CLUSTER_SHADOWS\n\tvar shadowAtlasTexture: texture_depth_2d;\n\tvar shadowAtlasTextureSampler: sampler_comparison;\n#endif\n#ifdef CLUSTER_COOKIES\n\tvar cookieAtlasTexture: texture_2d<f32>;\n\tvar cookieAtlasTextureSampler: sampler;\n#endif\nuniform clusterMaxCells: i32;\nuniform clusterSkip: f32;\nuniform clusterCellsCountByBoundsSize: vec3f;\nuniform clusterTextureSize: vec3f;\nuniform clusterBoundsMin: vec3f;\nuniform clusterBoundsDelta: vec3f;\nuniform clusterCellsDot: vec3f;\nuniform clusterCellsMax: vec3f;\nuniform shadowAtlasParams: vec2f;\nstruct ClusterLightData {\n\tflags: u32,\n\thalfWidth: vec3f,\n\tisSpot: bool,\n\thalfHeight: vec3f,\n\tlightIndex: i32,\n\tposition: vec3f,\n\tshape: u32,\n\tdirection: vec3f,\n\tfalloffModeLinear: bool,\n\tcolor: vec3f,\n\tshadowIntensity: f32,\n\tomniAtlasViewport: vec3f,\n\trange: f32,\n\tcookieChannelMask: vec4f,\n\tbiasesData: f32,\n\tcolorBFlagsData: u32,\n\tshadowBias: f32,\n\tshadowNormalBias: f32,\n\tanglesData: f32,\n\tinnerConeAngleCos: f32,\n\touterConeAngleCos: f32,\n\tcookieIntensity: f32,\n\tisDynamic: bool,\n\tisLightmapped: bool\n}\nvar<private> lightProjectionMatrix: mat4x4f;\nfn sampleLightTextureF(lightIndex: i32, index: i32) -> vec4f {\n\treturn textureLoad(lightsTexture, vec2<i32>(index, lightIndex), 0);\n}\nfn decodeClusterLightCore(clusterLightData: ptr<function, ClusterLightData>, lightIndex: f32) {\n\tclusterLightData.lightIndex = i32(lightIndex);\n\tlet halfData: vec4f = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_COLOR_ANGLES_BIAS});\n\tclusterLightData.anglesData = halfData.z;\n\tclusterLightData.biasesData = halfData.w;\n\tclusterLightData.colorBFlagsData = bitcast<u32>(halfData.y);\n\tlet colorRG: vec2f = unpack2x16float(bitcast<u32>(halfData.x));\n\tlet colorB_flags: vec2f = unpack2x16float(clusterLightData.colorBFlagsData);\n\tclusterLightData.color = vec3f(colorRG, colorB_flags.x) * {LIGHT_COLOR_DIVIDER};\n\tlet lightPosRange: vec4f = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_POSITION_RANGE});\n\tclusterLightData.position = lightPosRange.xyz;\n\tclusterLightData.range = lightPosRange.w;\n\tlet lightDir_Flags: vec4f = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_DIRECTION_FLAGS});\n\tclusterLightData.direction = lightDir_Flags.xyz;\n\tlet flags_uint: u32 = bitcast<u32>(lightDir_Flags.w);\n\tclusterLightData.flags = flags_uint;\n\tclusterLightData.isSpot = (flags_uint & (1u << 30u)) != 0u;\n\tclusterLightData.shape = (flags_uint >> 28u) & 0x3u;\n\tclusterLightData.falloffModeLinear = (flags_uint & (1u << 27u)) == 0u;\n\tclusterLightData.shadowIntensity = f32((flags_uint >> 0u) & 0xFFu) / 255.0;\n\tclusterLightData.cookieIntensity = f32((flags_uint >> 8u) & 0xFFu) / 255.0;\n\tclusterLightData.isDynamic = (flags_uint & (1u << 22u)) != 0u;\n\tclusterLightData.isLightmapped = (flags_uint & (1u << 21u)) != 0u;\n}\nfn decodeClusterLightSpot(clusterLightData: ptr<function, ClusterLightData>) {\n\tlet angleFlags: u32 = (clusterLightData.colorBFlagsData >> 16u) & 0xFFFFu;\n\tlet angleValues: vec2f = unpack2x16float(bitcast<u32>(clusterLightData.anglesData));\n\tlet innerVal: f32 = angleValues.x;\n\tlet outerVal: f32 = angleValues.y;\n\tlet innerIsVersine: bool = (angleFlags & 1u) != 0u;\n\tlet outerIsVersine: bool = ((angleFlags >> 1u) & 1u) != 0u;\n\tclusterLightData.innerConeAngleCos = select(innerVal, 1.0 - innerVal, innerIsVersine);\n\tclusterLightData.outerConeAngleCos = select(outerVal, 1.0 - outerVal, outerIsVersine);\n}\nfn decodeClusterLightOmniAtlasViewport(clusterLightData: ptr<function, ClusterLightData>) {\n\tclusterLightData.omniAtlasViewport = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_PROJ_MAT_0}).xyz;\n}\nfn decodeClusterLightAreaData(clusterLightData: ptr<function, ClusterLightData>) {\n\tclusterLightData.halfWidth = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_AREA_DATA_WIDTH}).xyz;\n\tclusterLightData.halfHeight = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_AREA_DATA_HEIGHT}).xyz;\n}\nfn decodeClusterLightProjectionMatrixData(clusterLightData: ptr<function, ClusterLightData>) {\n\tlet m0: vec4f = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_PROJ_MAT_0});\n\tlet m1: vec4f = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_PROJ_MAT_1});\n\tlet m2: vec4f = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_PROJ_MAT_2});\n\tlet m3: vec4f = sampleLightTextureF(clusterLightData.lightIndex, {CLUSTER_TEXTURE_PROJ_MAT_3});\n\tlightProjectionMatrix = mat4x4f(m0, m1, m2, m3);\n}\nfn decodeClusterLightShadowData(clusterLightData: ptr<function, ClusterLightData>) {\n\tlet biases: vec2f = unpack2x16float(bitcast<u32>(clusterLightData.biasesData));\n\tclusterLightData.shadowBias = biases.x;\n\tclusterLightData.shadowNormalBias = biases.y;\n}\nfn decodeClusterLightCookieData(clusterLightData: ptr<function, ClusterLightData>) {\n\tlet cookieFlags: u32 = (clusterLightData.flags >> 23u) & 0x0Fu;\n\tlet mask_uvec: vec4<u32> = vec4<u32>(cookieFlags) & vec4<u32>(1u, 2u, 4u, 8u);\n\tclusterLightData.cookieChannelMask = step(vec4f(1.0), vec4f(mask_uvec));\n}\nfn evaluateLight(\n\tlight: ptr<function, ClusterLightData>,\n\tworldNormal: vec3f,\n\tviewDir: vec3f,\n\treflectionDir: vec3f,\n#if defined(LIT_CLEARCOAT)\n\tclearcoatReflectionDir: vec3f,\n#endif\n\tgloss: f32,\n\tspecularity: vec3f,\n\tgeometricNormal: vec3f,\n\ttbn: mat3x3f,\n#if defined(LIT_IRIDESCENCE)\n\tiridescenceFresnel: vec3f,\n#endif\n\tclearcoat_worldNormal: vec3f,\n\tclearcoat_gloss: f32,\n\tsheen_gloss: f32,\n\tiridescence_intensity: f32\n) {\n\tvar cookieAttenuation: vec3f = vec3f(1.0);\n\tvar diffuseAttenuation: f32 = 1.0;\n\tvar falloffAttenuation: f32 = 1.0;\n\tlet lightDirW: vec3f = evalOmniLight(light.position);\n\tlet lightDirNormW: vec3f = normalize(lightDirW);\n\t#ifdef CLUSTER_AREALIGHTS\n\tif (light.shape != {LIGHTSHAPE_PUNCTUAL}) {\n\t\tdecodeClusterLightAreaData(light);\n\t\tif (light.shape == {LIGHTSHAPE_RECT}) {\n\t\t\tcalcRectLightValues(light.position, light.halfWidth, light.halfHeight);\n\t\t} else if (light.shape == {LIGHTSHAPE_DISK}) {\n\t\t\tcalcDiskLightValues(light.position, light.halfWidth, light.halfHeight);\n\t\t} else {\n\t\t\tcalcSphereLightValues(light.position, light.halfWidth, light.halfHeight);\n\t\t}\n\t\tfalloffAttenuation = getFalloffWindow(light.range, lightDirW);\n\t} else\n\t#endif\n\t{\n\t\tif (light.falloffModeLinear) {\n\t\t\tfalloffAttenuation = getFalloffLinear(light.range, lightDirW);\n\t\t} else {\n\t\t\tfalloffAttenuation = getFalloffInvSquared(light.range, lightDirW);\n\t\t}\n\t}\n\tif (falloffAttenuation > 0.00001) {\n\t\t#ifdef CLUSTER_AREALIGHTS\n\t\tif (light.shape != {LIGHTSHAPE_PUNCTUAL}) {\n\t\t\tif (light.shape == {LIGHTSHAPE_RECT}) {\n\t\t\t\tdiffuseAttenuation = getRectLightDiffuse(worldNormal, viewDir, lightDirW, lightDirNormW) * 16.0;\n\t\t\t} else if (light.shape == {LIGHTSHAPE_DISK}) {\n\t\t\t\tdiffuseAttenuation = getDiskLightDiffuse(worldNormal, viewDir, lightDirW, lightDirNormW) * 16.0;\n\t\t\t} else {\n\t\t\t\tdiffuseAttenuation = getSphereLightDiffuse(worldNormal, viewDir, lightDirW, lightDirNormW) * 16.0;\n\t\t\t}\n\t\t} else\n\t\t#endif\n\t\t{\n\t\t\tfalloffAttenuation = falloffAttenuation * getLightDiffuse(worldNormal, viewDir, lightDirNormW);\n\t\t}\n\t\tif (light.isSpot) {\n\t\t\tdecodeClusterLightSpot(light);\n\t\t\tfalloffAttenuation = falloffAttenuation * getSpotEffect(light.direction, light.innerConeAngleCos, light.outerConeAngleCos, lightDirNormW);\n\t\t}\n\t\t#if defined(CLUSTER_COOKIES) || defined(CLUSTER_SHADOWS)\n\t\tif (falloffAttenuation > 0.00001) {\n\t\t\tif (light.shadowIntensity > 0.0 || light.cookieIntensity > 0.0) {\n\t\t\t\tif (light.isSpot) {\n\t\t\t\t\tdecodeClusterLightProjectionMatrixData(light);\n\t\t\t\t} else {\n\t\t\t\t\tdecodeClusterLightOmniAtlasViewport(light);\n\t\t\t\t}\n\t\t\t\tlet shadowTextureResolution: f32 = uniform.shadowAtlasParams.x;\n\t\t\t\tlet shadowEdgePixels: f32 = uniform.shadowAtlasParams.y;\n\t\t\t\t#ifdef CLUSTER_COOKIES\n\t\t\t\tif (light.cookieIntensity > 0.0) {\n\t\t\t\t\tdecodeClusterLightCookieData(light);\n\t\t\t\t\tif (light.isSpot) {\n\t\t\t\t\t\tcookieAttenuation = getCookie2DClustered(cookieAtlasTexture, cookieAtlasTextureSampler, lightProjectionMatrix, vPositionW, light.cookieIntensity, light.cookieChannelMask);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tcookieAttenuation = getCookieCubeClustered(cookieAtlasTexture, cookieAtlasTextureSampler, lightDirW, light.cookieIntensity, light.cookieChannelMask, shadowTextureResolution, shadowEdgePixels, light.omniAtlasViewport);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t#endif\n\t\t\t\t#ifdef CLUSTER_SHADOWS\n\t\t\t\tif (light.shadowIntensity > 0.0) {\n\t\t\t\t\tdecodeClusterLightShadowData(light);\n\t\t\t\t\tlet shadowParams: vec4f = vec4f(shadowTextureResolution, light.shadowNormalBias, light.shadowBias, 1.0 / light.range);\n\t\t\t\t\tif (light.isSpot) {\n\t\t\t\t\t\tlet shadowCoord: vec3f = getShadowCoordPerspZbufferNormalOffset(lightProjectionMatrix, shadowParams, geometricNormal);\n\t\t\t\t\t\t#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\t\t\t\t\t\t\tlet shadow: f32 = getShadowSpotClusteredPCF1(shadowAtlasTexture, shadowAtlasTextureSampler, shadowCoord, shadowParams);\n\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCF3)\n\t\t\t\t\t\t\tlet shadow: f32 = getShadowSpotClusteredPCF3(shadowAtlasTexture, shadowAtlasTextureSampler, shadowCoord, shadowParams);\n\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCF5)\n\t\t\t\t\t\t\tlet shadow: f32 = getShadowSpotClusteredPCF5(shadowAtlasTexture, shadowAtlasTextureSampler, shadowCoord, shadowParams);\n\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCSS)\n\t\t\t\t\t\t\tlet shadow: f32 = getShadowSpotClusteredPCSS(shadowAtlasTexture, shadowAtlasTextureSampler, shadowCoord, shadowParams);\n\t\t\t\t\t\t#endif\n\t\t\t\t\t\tfalloffAttenuation = falloffAttenuation * mix(1.0, shadow, light.shadowIntensity);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tlet dir: vec3f = normalOffsetPointShadow(shadowParams, light.position, lightDirW, lightDirNormW, geometricNormal);\n\t\t\t\t\t\t#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\t\t\t\t\t\t\tlet shadow: f32 = getShadowOmniClusteredPCF1(shadowAtlasTexture, shadowAtlasTextureSampler, shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);\n\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCF3)\n\t\t\t\t\t\t\tlet shadow: f32 = getShadowOmniClusteredPCF3(shadowAtlasTexture, shadowAtlasTextureSampler, shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);\n\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCF5)\n\t\t\t\t\t\t\tlet shadow: f32 = getShadowOmniClusteredPCF5(shadowAtlasTexture, shadowAtlasTextureSampler, shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);\n\t\t\t\t\t\t#endif\n\t\t\t\t\t\tfalloffAttenuation = falloffAttenuation * mix(1.0, shadow, light.shadowIntensity);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t#endif\n\t\t\t}\n\t\t}\n\t\t#endif\n\t\t#ifdef CLUSTER_AREALIGHTS\n\t\tif (light.shape != {LIGHTSHAPE_PUNCTUAL}) {\n\t\t\t{\n\t\t\t\tvar areaDiffuse: vec3f = (diffuseAttenuation * falloffAttenuation) * light.color * cookieAttenuation;\n\t\t\t\t#if defined(LIT_SPECULAR)\n\t\t\t\t\tareaDiffuse = mix(areaDiffuse, vec3f(0.0), dLTCSpecFres);\n\t\t\t\t#endif\n\t\t\t\tdDiffuseLight = dDiffuseLight + areaDiffuse;\n\t\t\t}\n\t\t\t#ifdef LIT_SPECULAR\n\t\t\t\tvar areaLightSpecular: f32;\n\t\t\t\tif (light.shape == {LIGHTSHAPE_RECT}) {\n\t\t\t\t\tareaLightSpecular = getRectLightSpecular(worldNormal, viewDir);\n\t\t\t\t} else if (light.shape == {LIGHTSHAPE_DISK}) {\n\t\t\t\t\tareaLightSpecular = getDiskLightSpecular(worldNormal, viewDir);\n\t\t\t\t} else {\n\t\t\t\t\tareaLightSpecular = getSphereLightSpecular(worldNormal, viewDir);\n\t\t\t\t}\n\t\t\t\tdSpecularLight = dSpecularLight + dLTCSpecFres * areaLightSpecular * falloffAttenuation * light.color * cookieAttenuation;\n\t\t\t\t#ifdef LIT_CLEARCOAT\n\t\t\t\t\tvar areaLightSpecularCC: f32;\n\t\t\t\t\tif (light.shape == {LIGHTSHAPE_RECT}) {\n\t\t\t\t\t\tareaLightSpecularCC = getRectLightSpecular(clearcoat_worldNormal, viewDir);\n\t\t\t\t\t} else if (light.shape == {LIGHTSHAPE_DISK}) {\n\t\t\t\t\t\tareaLightSpecularCC = getDiskLightSpecular(clearcoat_worldNormal, viewDir);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tareaLightSpecularCC = getSphereLightSpecular(clearcoat_worldNormal, viewDir);\n\t\t\t\t\t}\n\t\t\t\t\tccSpecularLight = ccSpecularLight + ccLTCSpecFres * areaLightSpecularCC * falloffAttenuation * light.color  * cookieAttenuation;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t} else\n\t\t#endif\n\t\t{\n\t\t\t{\n\t\t\t\tvar punctualDiffuse: vec3f = falloffAttenuation * light.color * cookieAttenuation;\n\t\t\t\t#if defined(CLUSTER_AREALIGHTS)\n\t\t\t\t#if defined(LIT_SPECULAR)\n\t\t\t\t\tpunctualDiffuse = mix(punctualDiffuse, vec3f(0.0), specularity);\n\t\t\t\t#endif\n\t\t\t\t#endif\n\t\t\t\tdDiffuseLight = dDiffuseLight + punctualDiffuse;\n\t\t\t}\n\t\t\t#ifdef LIT_SPECULAR\n\t\t\t\tlet halfDir: vec3f = normalize(-lightDirNormW + viewDir);\n\t\t\t\t#ifdef LIT_SPECULAR_FRESNEL\n\t\t\t\t\tdSpecularLight = dSpecularLight +\n\t\t\t\t\t\tgetLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, lightDirNormW, gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation *\n\t\t\t\t\t\tgetFresnel(\n\t\t\t\t\t\t\tdot(viewDir, halfDir),\n\t\t\t\t\t\t\tgloss,\n\t\t\t\t\t\t\tspecularity\n\t\t\t\t\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t\t\t, iridescenceFresnel,\n\t\t\t\t\t\t\tiridescence_intensity\n\t\t\t\t\t\t#endif\n\t\t\t\t\t\t\t);\n\t\t\t\t#else\n\t\t\t\t\tdSpecularLight = dSpecularLight + getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, lightDirNormW, gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * specularity;\n\t\t\t\t#endif\n\t\t\t\t#ifdef LIT_CLEARCOAT\n\t\t\t\t\t#ifdef LIT_SPECULAR_FRESNEL\n\t\t\t\t\t\tccSpecularLight = ccSpecularLight + getLightSpecular(halfDir, clearcoatReflectionDir, clearcoat_worldNormal, viewDir, lightDirNormW, clearcoat_gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * getFresnelCC(dot(viewDir, halfDir));\n\t\t\t\t\t#else\n\t\t\t\t\t\tccSpecularLight = ccSpecularLight + getLightSpecular(halfDir, clearcoatReflectionDir, clearcoat_worldNormal, viewDir, lightDirNormW, clearcoat_gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation;\n\t\t\t\t\t#endif\n\t\t\t\t#endif\n\t\t\t\t#ifdef LIT_SHEEN\n\t\t\t\t\tsSpecularLight = sSpecularLight + getLightSpecularSheen(halfDir, worldNormal, viewDir, lightDirNormW, sheen_gloss) * falloffAttenuation * light.color * cookieAttenuation;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t}\n\t}\n\tdAtten = falloffAttenuation;\n\tdLightDirNormW = lightDirNormW;\n}\nfn evaluateClusterLight(\n\tlightIndex: f32,\n\tworldNormal: vec3f,\n\tviewDir: vec3f,\n\treflectionDir: vec3f,\n#if defined(LIT_CLEARCOAT)\n\tclearcoatReflectionDir: vec3f,\n#endif\n\tgloss: f32,\n\tspecularity: vec3f,\n\tgeometricNormal: vec3f,\n\ttbn: mat3x3f,\n#if defined(LIT_IRIDESCENCE)\n\tiridescenceFresnel: vec3f,\n#endif\n\tclearcoat_worldNormal: vec3f,\n\tclearcoat_gloss: f32,\n\tsheen_gloss: f32,\n\tiridescence_intensity: f32\n) {\n\tvar clusterLightData: ClusterLightData;\n\tdecodeClusterLightCore(&clusterLightData, lightIndex);\n\t#ifdef CLUSTER_MESH_DYNAMIC_LIGHTS\n\t\tlet acceptLightMask: bool = clusterLightData.isDynamic;\n\t#else\n\t\tlet acceptLightMask: bool = clusterLightData.isLightmapped;\n\t#endif\n\tif (acceptLightMask) {\n\t\tevaluateLight(\n\t\t\t&clusterLightData,\n\t\t\tworldNormal,\n\t\t\tviewDir,\n\t\t\treflectionDir,\n#if defined(LIT_CLEARCOAT)\n\t\t\tclearcoatReflectionDir,\n#endif\n\t\t\tgloss,\n\t\t\tspecularity,\n\t\t\tgeometricNormal,\n\t\t\ttbn,\n#if defined(LIT_IRIDESCENCE)\n\t\t\tiridescenceFresnel,\n#endif\n\t\t\tclearcoat_worldNormal,\n\t\t\tclearcoat_gloss,\n\t\t\tsheen_gloss,\n\t\t\tiridescence_intensity\n\t\t);\n\t}\n}\nfn addClusteredLights(\n\tworldNormal: vec3f,\n\tviewDir: vec3f,\n\treflectionDir: vec3f,\n#if defined(LIT_CLEARCOAT)\n\tclearcoatReflectionDir: vec3f,\n#endif\n\tgloss: f32,\n\tspecularity: vec3f,\n\tgeometricNormal: vec3f,\n\ttbn: mat3x3f,\n#if defined(LIT_IRIDESCENCE)\n\tiridescenceFresnel: vec3f,\n#endif\n\tclearcoat_worldNormal: vec3f,\n\tclearcoat_gloss: f32,\n\tsheen_gloss: f32,\n\tiridescence_intensity: f32\n) {\n\tif (uniform.clusterSkip > 0.5) {\n\t\treturn;\n\t}\n\tlet cellCoords: vec3f = floor((vPositionW - uniform.clusterBoundsMin) * uniform.clusterCellsCountByBoundsSize);\n\tif (!(any(cellCoords < vec3f(0.0)) || any(cellCoords >= uniform.clusterCellsMax))) {\n\t\tlet cellIndex: f32 = dot(uniform.clusterCellsDot, cellCoords);\n\t\tlet clusterV: f32 = floor(cellIndex * uniform.clusterTextureSize.y);\n\t\tlet clusterU: f32 = cellIndex - (clusterV * uniform.clusterTextureSize.x);\n\t\tfor (var lightCellIndex: i32 = 0; lightCellIndex < uniform.clusterMaxCells; lightCellIndex = lightCellIndex + 1) {\n\t\t\tlet lightIndexPacked: f32 = textureLoad(clusterWorldTexture, vec2<i32>(i32(clusterU) + lightCellIndex, i32(clusterV)), 0).r;\n\t\t\tif (lightIndexPacked <= 0.0) {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tevaluateClusterLight(\n\t\t\t\tlightIndexPacked * 255.0,\n\t\t\t\tworldNormal,\n\t\t\t\tviewDir,\n\t\t\t\treflectionDir,\n#if defined(LIT_CLEARCOAT)\n\t\t\t\tclearcoatReflectionDir,\n#endif\n\t\t\t\tgloss,\n\t\t\t\tspecularity,\n\t\t\t\tgeometricNormal,\n\t\t\t\ttbn,\n#if defined(LIT_IRIDESCENCE)\n\t\t\t\tiridescenceFresnel,\n#endif\n\t\t\t\tclearcoat_worldNormal,\n\t\t\t\tclearcoat_gloss,\n\t\t\t\tsheen_gloss,\n\t\t\t\tiridescence_intensity\n\t\t\t);\n\t\t}\n\t}\n}',combinePS:"\nfn combineColor(albedo: vec3f, sheenSpecularity: vec3f, clearcoatSpecularity: f32) -> vec3f {\n\tvar ret: vec3f = vec3f(0.0);\n\t#ifdef LIT_OLD_AMBIENT\n\t\tret = ret + ((dDiffuseLight - uniform.light_globalAmbient) * albedo + uniform.material_ambient * uniform.light_globalAmbient);\n\t#else\n\t\tret = ret + (albedo * dDiffuseLight);\n\t#endif\n\t#ifdef LIT_SPECULAR\n\t\tret = ret + dSpecularLight;\n\t#endif\n\t#ifdef LIT_REFLECTIONS\n\t\tret = ret + (dReflection.rgb * dReflection.a);\n\t#endif\n\t#ifdef LIT_SHEEN\n\t\tlet sheenScaling: f32 = 1.0 - max(max(sheenSpecularity.r, sheenSpecularity.g), sheenSpecularity.b) * 0.157;\n\t\tret = ret * sheenScaling + (sSpecularLight + sReflection.rgb) * sheenSpecularity;\n\t#endif\n\t#ifdef LIT_CLEARCOAT\n\t\tlet clearCoatScaling: f32 = 1.0 - ccFresnel * clearcoatSpecularity;\n\t\tret = ret * clearCoatScaling + (ccSpecularLight + ccReflection) * clearcoatSpecularity;\n\t#endif\n\treturn ret;\n}\n",cookieBlit2DPS:"\n\tvarying uv0: vec2f;\n\tvar blitTexture: texture_2d<f32>;\n\tvar blitTextureSampler : sampler;\n\t@fragment\n\tfn fragmentMain(input : FragmentInput) -> FragmentOutput {\n\t\tvar output: FragmentOutput;\n\t\toutput.color = textureSample(blitTexture, blitTextureSampler, input.uv0);\n\t\treturn output;\n\t}\n",cookieBlitCubePS:"\n\tvarying uv0: vec2f;\n\tuniform invViewProj: mat4x4<f32>;\n\tvar blitTexture: texture_cube<f32>;\n\tvar blitTextureSampler : sampler;\n\t@fragment\n\tfn fragmentMain(input : FragmentInput) -> FragmentOutput {\n\t\tvar output: FragmentOutput;\n\t\tvar projPos = vec4f(input.uv0 * 2.0 - 1.0, 0.5, 1.0);\n\t\tvar worldPos = uniform.invViewProj * projPos;\n\t\toutput.color = textureSample(blitTexture, blitTextureSampler, worldPos.xyz);\n\t\treturn output;\n\t}\n",cookieBlitVS:"\n\tattribute vertex_position: vec2f;\n\tvarying uv0: vec2f;\n\t@vertex\n\tfn vertexMain(input: VertexInput) -> VertexOutput {\n\t\tvar output: VertexOutput;\n\t\toutput.position = vec4f(input.vertex_position, 0.5, 1.0);\n\t\toutput.uv0 = input.vertex_position * 0.5 + vec2f(0.5, 0.5);\n\t\toutput.uv0.y = 1.0 - output.uv0.y;\n\t\treturn output;\n\t}\n",cubeMapProjectPS:"\n#if LIT_CUBEMAP_PROJECTION == BOX\n\tuniform envBoxMin: vec3f;\n\tuniform envBoxMax: vec3f;\n#endif\nfn cubeMapProject(nrdir: vec3f) -> vec3f {\n\t#if LIT_CUBEMAP_PROJECTION == NONE\n\t\treturn cubeMapRotate(nrdir);\n\t#endif\n\t#if LIT_CUBEMAP_PROJECTION == BOX\n\t\tlet nrdir_rotated: vec3f = cubeMapRotate(nrdir);\n\t\tlet rbmax: vec3f = (uniform.envBoxMax - vPositionW) / nrdir_rotated;\n\t\tlet rbmin: vec3f = (uniform.envBoxMin - vPositionW) / nrdir_rotated;\n\t\tlet rbminmax: vec3f = select(rbmin, rbmax, nrdir_rotated > vec3f(0.0));\n\t\tlet fa: f32 = min(min(rbminmax.x, rbminmax.y), rbminmax.z);\n\t\tlet posonbox: vec3f = vPositionW + nrdir_rotated * fa;\n\t\tlet envBoxPos: vec3f = (uniform.envBoxMin + uniform.envBoxMax) * 0.5;\n\t\treturn normalize(posonbox - envBoxPos);\n\t#endif\n}\n",cubeMapRotatePS:"\n#ifdef CUBEMAP_ROTATION\nuniform cubeMapRotationMatrix: mat3x3f;\n#endif\nfn cubeMapRotate(refDir: vec3f) -> vec3f {\n#ifdef CUBEMAP_ROTATION\n\treturn refDir * uniform.cubeMapRotationMatrix;\n#else\n\treturn refDir;\n#endif\n}\n",debugOutputPS:"\n#ifdef DEBUG_ALBEDO_PASS\noutput.color = vec4(gammaCorrectOutput(dAlbedo), 1.0);\n#endif\n#ifdef DEBUG_UV0_PASS\noutput.color = vec4f(litArgs_albedo , 1.0);\n#endif\n#ifdef DEBUG_WORLD_NORMAL_PASS\noutput.color = vec4f(litArgs_worldNormal * 0.5 + 0.5, 1.0);\n#endif\n#ifdef DEBUG_OPACITY_PASS\noutput.color = vec4f(vec3f(litArgs_opacity) , 1.0);\n#endif\n#ifdef DEBUG_SPECULARITY_PASS\noutput.color = vec4f(litArgs_specularity, 1.0);\n#endif\n#ifdef DEBUG_GLOSS_PASS\noutput.color = vec4f(vec3f(litArgs_gloss) , 1.0);\n#endif\n#ifdef DEBUG_METALNESS_PASS\noutput.color = vec4f(vec3f(litArgs_metalness) , 1.0);\n#endif\n#ifdef DEBUG_AO_PASS\noutput.color = vec4f(vec3f(litArgs_ao) , 1.0);\n#endif\n#ifdef DEBUG_EMISSION_PASS\noutput.color = vec4f(gammaCorrectOutput(litArgs_emission), 1.0);\n#endif\n",debugProcessFrontendPS:"\n#ifdef DEBUG_LIGHTING_PASS\n\tlitArgs_albedo = vec3f(0.5);\n#endif\n#ifdef DEBUG_UV0_PASS\n#ifdef VARYING_VUV0\n\tlitArgs_albedo = vec3f(vUv0, 0.0);\n#else\n\tlitArgs_albedo = vec3f(0.0);\n#endif\n#endif\n",detailModesPS:"\n#ifndef _DETAILMODES_INCLUDED_\n#define _DETAILMODES_INCLUDED_\nfn detailMode_mul(c1: vec3f, c2: vec3f) -> vec3f {\n\treturn c1 * c2;\n}\nfn detailMode_add(c1: vec3f, c2: vec3f) -> vec3f {\n\treturn c1 + c2;\n}\nfn detailMode_screen(c1: vec3f, c2: vec3f) -> vec3f {\n\treturn 1.0 - (1.0 - c1)*(1.0 - c2);\n}\nfn detailMode_overlay(c1: vec3f, c2: vec3f) -> vec3f {\n\treturn mix(1.0 - 2.0 * (1.0 - c1)*(1.0 - c2), 2.0 * c1 * c2, step(c1, vec3f(0.5)));\n}\nfn detailMode_min(c1: vec3f, c2: vec3f) -> vec3f {\n\treturn min(c1, c2);\n}\nfn detailMode_max(c1: vec3f, c2: vec3f) -> vec3f {\n\treturn max(c1, c2);\n}\n#endif\n",diffusePS:'\nuniform material_diffuse: vec3f;\n#ifdef STD_DIFFUSEDETAIL_TEXTURE\n\t#include "detailModesPS"\n#endif\nfn getAlbedo() {\n\tdAlbedo = uniform.material_diffuse.rgb;\n\t#ifdef STD_DIFFUSE_TEXTURE\n\t\tvar albedoTexture: vec3f = {STD_DIFFUSE_TEXTURE_DECODE}(textureSampleBias({STD_DIFFUSE_TEXTURE_NAME}, {STD_DIFFUSE_TEXTURE_NAME}Sampler, {STD_DIFFUSE_TEXTURE_UV}, uniform.textureBias)).{STD_DIFFUSE_TEXTURE_CHANNEL};\n\t\t#ifdef STD_DIFFUSEDETAIL_TEXTURE\n\t\t\tvar albedoDetail: vec3f = {STD_DIFFUSEDETAIL_TEXTURE_DECODE}(textureSampleBias({STD_DIFFUSEDETAIL_TEXTURE_NAME}, {STD_DIFFUSEDETAIL_TEXTURE_NAME}Sampler, {STD_DIFFUSEDETAIL_TEXTURE_UV}, uniform.textureBias)).{STD_DIFFUSEDETAIL_TEXTURE_CHANNEL};\n\t\t\talbedoTexture = detailMode_{STD_DIFFUSEDETAIL_DETAILMODE}(albedoTexture, albedoDetail);\n\t\t#endif\n\t\tdAlbedo = dAlbedo * albedoTexture;\n\t#endif\n\t#ifdef STD_DIFFUSE_VERTEX\n\t\tdAlbedo = dAlbedo * saturate3(vVertexColor.{STD_DIFFUSE_VERTEX_CHANNEL});\n\t#endif\n}\n',decodePS:"\n#ifndef _DECODE_INCLUDED_\n#define _DECODE_INCLUDED_\nfn decodeLinear(raw: vec4f) -> vec3f {\n\treturn raw.rgb;\n}\nfn decodeGammaFloat(raw: f32) -> f32 {\n\treturn pow(raw, 2.2);\n}\nfn decodeGamma3(raw: vec3f) -> vec3f {\n\treturn pow(raw, vec3f(2.2));\n}\nfn decodeGamma(raw: vec4f) -> vec3f {\n\treturn pow(raw.xyz, vec3f(2.2));\n}\nfn decodeRGBM(raw: vec4f) -> vec3f {\n\tlet color = (8.0 * raw.a) * raw.rgb;\n\treturn color * color;\n}\nfn decodeRGBP(raw: vec4f) -> vec3f {\n\tlet color = raw.rgb * (-raw.a * 7.0 + 8.0);\n\treturn color * color;\n}\nfn decodeRGBE(raw: vec4f) -> vec3f {\n\treturn select(vec3f(0.0), raw.xyz * pow(2.0, raw.w * 255.0 - 128.0), raw.a != 0.0);\n}\nfn passThrough(raw: vec4f) -> vec4f {\n\treturn raw;\n}\nfn unpackNormalXYZ(nmap: vec4f) -> vec3f {\n\treturn nmap.xyz * 2.0 - 1.0;\n}\nfn unpackNormalXY(nmap: vec4f) -> vec3f {\n\tvar xy = nmap.wy * 2.0 - 1.0;\n\treturn vec3f(xy, sqrt(1.0 - clamp(dot(xy, xy), 0.0, 1.0)));\n}\n#endif\n",emissivePS:"\nuniform material_emissive: vec3f;\nuniform material_emissiveIntensity: f32;\nfn getEmission() {\n\tdEmission = uniform.material_emissive * uniform.material_emissiveIntensity;\n\t#ifdef STD_EMISSIVE_TEXTURE\n\tdEmission *= {STD_EMISSIVE_TEXTURE_DECODE}(textureSampleBias({STD_EMISSIVE_TEXTURE_NAME}, {STD_EMISSIVE_TEXTURE_NAME}Sampler, {STD_EMISSIVE_TEXTURE_UV}, uniform.textureBias)).{STD_EMISSIVE_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_EMISSIVE_VERTEX\n\tdEmission = dEmission * saturate3(vVertexColor.{STD_EMISSIVE_VERTEX_CHANNEL});\n\t#endif\n}\n",encodePS:"\nfn encodeLinear(source: vec3f) -> vec4f {\n\treturn vec4f(source, 1.0);\n}\nfn encodeGamma(source: vec3f) -> vec4f {\n\treturn vec4f(pow(source + vec3f(0.0000001), vec3f(1.0 / 2.2)), 1.0);\n}\nfn encodeRGBM(source: vec3f) -> vec4f {\n\tvar color: vec3f = pow(source, vec3f(0.5));\n\tcolor *= 1.0 / 8.0;\n\tvar a: f32 = saturate(max(max(color.r, color.g), max(color.b, 1.0 / 255.0)));\n\ta = ceil(a * 255.0) / 255.0;\n\tcolor /= a;\n\treturn vec4f(color, a);\n}\nfn encodeRGBP(source: vec3f) -> vec4f {\n\tvar gamma: vec3f = pow(source, vec3f(0.5));\n\tvar maxVal: f32 = min(8.0, max(1.0, max(gamma.x, max(gamma.y, gamma.z))));\n\tvar v: f32 = 1.0 - ((maxVal - 1.0) / 7.0);\n\tv = ceil(v * 255.0) / 255.0;\n\treturn vec4f(gamma / (-v * 7.0 + 8.0), v);\n}\nfn encodeRGBE(source: vec3f) -> vec4f {\n\tvar maxVal: f32 = max(source.x, max(source.y, source.z));\n\tif (maxVal < 1e-32) {\n\t\treturn vec4f(0.0, 0.0, 0.0, 0.0);\n\t} else {\n\t\tvar e: f32 = ceil(log2(maxVal));\n\t\treturn vec4f(source / pow(2.0, e), (e + 128.0) / 255.0);\n\t}\n}\n",endPS:"\n\tvar finalRgb: vec3f = combineColor(litArgs_albedo, litArgs_sheen_specularity, litArgs_clearcoat_specularity);\n\tfinalRgb = finalRgb + litArgs_emission;\n\tfinalRgb = addFog(finalRgb);\n\tfinalRgb = toneMap(finalRgb);\n\tfinalRgb = gammaCorrectOutput(finalRgb);\n\toutput.color = vec4f(finalRgb, output.color.a);\n",envAtlasPS:"\n#ifndef _ENVATLAS_INCLUDED_\n#define _ENVATLAS_INCLUDED_\nconst atlasSize : f32 = 512.0;\nconst seamSize : f32 = 1.0 / atlasSize;\nfn mapUv(uv : vec2f, rect : vec4f) -> vec2f {\n\treturn vec2f(mix(rect.x + seamSize, rect.x + rect.z - seamSize, uv.x),\n\t\t\t\t mix(rect.y + seamSize, rect.y + rect.w - seamSize, uv.y));\n}\nfn mapRoughnessUv(uv : vec2f, level : f32) -> vec2f {\n\tlet t : f32 = 1.0 / exp2(level);\n\treturn mapUv(uv, vec4f(0.0, 1.0 - t, t, t * 0.5));\n}\nfn mapShinyUv(uv : vec2f, level : f32) -> vec2f {\n\tlet t : f32 = 1.0 / exp2(level);\n\treturn mapUv(uv, vec4f(1.0 - t, 1.0 - t, t, t * 0.5));\n}\n#endif\n",envProcPS:"\n#ifdef LIT_SKYBOX_INTENSITY\n\tuniform skyboxIntensity : f32;\n#endif\nfn processEnvironment(color : vec3f) -> vec3f {\n\t#ifdef LIT_SKYBOX_INTENSITY\n\t\treturn color * uniform.skyboxIntensity;\n\t#else\n\t\treturn color;\n\t#endif\n}\n",falloffInvSquaredPS:"\nfn getFalloffWindow(lightRadius: f32, lightDir: vec3f) -> f32 {\n\tlet sqrDist: f32 = dot(lightDir, lightDir);\n\tlet invRadius: f32 = 1.0 / lightRadius;\n\treturn square(saturate(1.0 - square(sqrDist * square(invRadius))));\n}\nfn getFalloffInvSquared(lightRadius: f32, lightDir: vec3f) -> f32 {\n\tlet sqrDist: f32 = dot(lightDir, lightDir);\n\tvar falloff: f32 = 1.0 / (sqrDist + 1.0);\n\tlet invRadius: f32 = 1.0 / lightRadius;\n\tfalloff = falloff * 16.0;\n\tfalloff = falloff * square(saturate(1.0 - square(sqrDist * square(invRadius))));\n\treturn falloff;\n}\n",falloffLinearPS:"\nfn getFalloffLinear(lightRadius: f32, lightDir: vec3f) -> f32 {\n\tlet d: f32 = length(lightDir);\n\treturn max(((lightRadius - d) / lightRadius), 0.0);\n}\n",floatAsUintPS:"\n#ifndef FLOAT_AS_UINT\n#define FLOAT_AS_UINT\nfn float2uint(value: f32) -> vec4f {\n\tlet intBits = bitcast<u32>(value);\n\treturn vec4f(\n\t\tf32((intBits >> 24u) & 0xffu),\n\t\tf32((intBits >> 16u) & 0xffu),\n\t\tf32((intBits >> 8u) & 0xffu),\n\t\tf32(intBits & 0xffu)\n\t) / 255.0;\n}\nfn uint2float(value: vec4f) -> f32 {\n\tlet rgba_u32 = vec4<u32>(value * 255.0);\n\tlet intBits: u32 =\n\t\t(rgba_u32.r << 24u) |\n\t\t(rgba_u32.g << 16u) |\n\t\t(rgba_u32.b << 8u)  |\n\t\t rgba_u32.a;\n\treturn bitcast<f32>(intBits);\n}\nfn float2vec4(value: f32) -> vec4f {\n\t#if defined(CAPS_TEXTURE_FLOAT_RENDERABLE)\n\t\treturn vec4f(value, 1.0, 1.0, 1.0);\n\t#else\n\t\treturn float2uint(value);\n\t#endif\n}\n#endif\n",fogPS:"\nvar<private> dBlendModeFogFactor : f32 = 1.0;\n#if (FOG != NONE)\n\tuniform fog_color : vec3f;\n\t\n\t#if (FOG == LINEAR)\n\t\tuniform fog_start : f32;\n\t\tuniform fog_end : f32;\n\t#else\n\t\tuniform fog_density : f32;\n\t#endif\n#endif\nfn getFogFactor() -> f32 {\n\tlet depth = pcPosition.z / pcPosition.w;\n\tvar fogFactor : f32 = 0.0;\n\t#if (FOG == LINEAR)\n\t\tfogFactor = (uniform.fog_end - depth) / (uniform.fog_end - uniform.fog_start);\n\t#elif (FOG == EXP)\n\t\tfogFactor = exp(-depth * uniform.fog_density);\n\t#elif (FOG == EXP2)\n\t\tfogFactor = exp(-depth * depth * uniform.fog_density * uniform.fog_density);\n\t#endif\n\treturn clamp(fogFactor, 0.0, 1.0);\n}\nfn addFog(color : vec3f) -> vec3f {\n\t#if (FOG != NONE)\n\t\treturn mix(uniform.fog_color * dBlendModeFogFactor, color, getFogFactor());\n\t#else\n\t\treturn color;\n\t#endif\n}\n",fresnelSchlickPS:"\nfn getFresnel(\n\t\tcosTheta: f32,\n\t\tgloss: f32,\n\t\tspecularity: vec3f\n\t#if defined(LIT_IRIDESCENCE)\n\t\t, iridescenceFresnel: vec3f,\n\t\tiridescenceIntensity: f32\n\t#endif\n) -> vec3f {\n\tlet fresnel: f32 = pow(1.0 - saturate(cosTheta), 5.0);\n\tlet glossSq: f32 = gloss * gloss;\n\tlet ret: vec3f = specularity + (max(vec3f(glossSq), specularity) - specularity) * fresnel;\n\t#if defined(LIT_IRIDESCENCE)\n\t\treturn mix(ret, iridescenceFresnel, iridescenceIntensity);\n\t#else\n\t\treturn ret;\n\t#endif\n}\nfn getFresnelCC(cosTheta: f32) -> f32 {\n\tlet fresnel: f32 = pow(1.0 - saturate(cosTheta), 5.0);\n\treturn 0.04 + (1.0 - 0.04) * fresnel;\n}",frontendCodePS:"",frontendDeclPS:"",fullscreenQuadVS:"\nattribute vertex_position: vec2f;\nvarying vUv0: vec2f;\n@vertex\nfn vertexMain(input: VertexInput) -> VertexOutput {\n\tvar output: VertexOutput;\n\toutput.position = vec4f(input.vertex_position, 0.5, 1.0);\n\toutput.vUv0 = input.vertex_position.xy * 0.5 + vec2f(0.5);\n\treturn output;\n}\n",gammaPS:'\n#include "decodePS"\n#if (GAMMA == SRGB)\n\tfn gammaCorrectInput(color: f32) -> f32 {\n\t\treturn decodeGammaFloat(color);\n\t}\n\tfn gammaCorrectInputVec3(color: vec3f) -> vec3f {\n\t\treturn decodeGamma3(color);\n\t}\n\tfn gammaCorrectInputVec4(color: vec4f) -> vec4f {\n\t\treturn vec4f(decodeGamma3(color.xyz), color.w);\n\t}\n\tfn gammaCorrectOutput(color: vec3f) -> vec3f {\n\t\treturn pow(color + 0.0000001, vec3f(1.0 / 2.2));\n\t}\n#else\n\tfn gammaCorrectInput(color: f32) -> f32 {\n\t\treturn color;\n\t}\n\tfn gammaCorrectInputVec3(color: vec3f) -> vec3f {\n\t\treturn color;\n\t}\n\tfn gammaCorrectInputVec4(color: vec4f) -> vec4f {\n\t\treturn color;\n\t}\n\tfn gammaCorrectOutput(color: vec3f) -> vec3f {\n\t\treturn color;\n\t}\n#endif\n',glossPS:"\n#ifdef STD_GLOSS_CONSTANT\n\tuniform material_gloss: f32;\n#endif\nfn getGlossiness() {\n\tdGlossiness = 1.0;\n\t#ifdef STD_GLOSS_CONSTANT\n\tdGlossiness = dGlossiness * uniform.material_gloss;\n\t#endif\n\t#ifdef STD_GLOSS_TEXTURE\n\tdGlossiness = dGlossiness * textureSampleBias({STD_GLOSS_TEXTURE_NAME}, {STD_GLOSS_TEXTURE_NAME}Sampler, {STD_GLOSS_TEXTURE_UV}, uniform.textureBias).{STD_GLOSS_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_GLOSS_VERTEX\n\tdGlossiness = dGlossiness * saturate(vVertexColor.{STD_GLOSS_VERTEX_CHANNEL});\n\t#endif\n\t#ifdef STD_GLOSS_INVERT\n\tdGlossiness = 1.0 - dGlossiness;\n\t#endif\n\tdGlossiness = dGlossiness + 0.0000001;\n}\n",quadVS:"\n\tattribute aPosition: vec2f;\n\tvarying uv0: vec2f;\n\t@vertex fn vertexMain(input: VertexInput) -> VertexOutput {\n\t\tvar output: VertexOutput;\n\t\toutput.position = vec4f(input.aPosition, 0.0, 1.0);\n\t\toutput.uv0 = getImageEffectUV((input.aPosition + 1.0) * 0.5);\n\t\treturn output;\n\t}\n",indirectCoreCS:"\nstruct DrawIndexedIndirectArgs {\n\tindexCount: u32,\n\tinstanceCount: u32,\n\tfirstIndex: u32,\n\tbaseVertex: i32,\n\tfirstInstance: u32\n};\nstruct DrawIndirectArgs {\n\tvertexCount: u32,\n\tinstanceCount: u32,\n\tfirstVertex: u32,\n\tfirstInstance: u32,\n\t_pad: u32\n};\n",immediateLinePS:'\n\t#include "gammaPS"\n\tvarying color: vec4f;\n\t@fragment\n\tfn fragmentMain(input : FragmentInput) -> FragmentOutput {\n\t\tvar output: FragmentOutput;\n\t\toutput.color = vec4f(gammaCorrectOutput(decodeGamma3(input.color.rgb)), input.color.a);\n\t\treturn output;\n\t}\n',immediateLineVS:"\n\tattribute vertex_position: vec4f;\n\tattribute vertex_color: vec4f;\n\tuniform matrix_model: mat4x4f;\n\tuniform matrix_viewProjection: mat4x4f;\n\tvarying color: vec4f;\n\t@vertex\n\tfn vertexMain(input : VertexInput) -> VertexOutput {\n\t\tvar output : VertexOutput;\n\t\toutput.color = input.vertex_color;\n\t\toutput.position = uniform.matrix_viewProjection * uniform.matrix_model * input.vertex_position;\n\t\treturn output;\n\t}\n",iridescenceDiffractionPS:"\nuniform material_iridescenceRefractionIndex: f32;\nfn iridescence_iorToFresnelScalar(transmittedIor: f32, incidentIor: f32) -> f32 {\n\treturn pow((transmittedIor - incidentIor) / (transmittedIor + incidentIor), 2.0);\n}\nfn iridescence_iorToFresnelVec3(transmittedIor: vec3f, incidentIor: f32) -> vec3f {\n\treturn pow((transmittedIor - vec3f(incidentIor)) / (transmittedIor + vec3f(incidentIor)), vec3f(2.0));\n}\nfn iridescence_fresnelToIor(f0: vec3f) -> vec3f {\n\tlet sqrtF0: vec3f = sqrt(f0);\n\treturn (vec3f(1.0) + sqrtF0) / (vec3f(1.0) - sqrtF0);\n}\nconst XYZ_TO_REC709: mat3x3f = mat3x3f(\n\tvec3f(3.2404542, -1.5371385, -0.4985314),\n\tvec3f(-0.9692660,  1.8760108,  0.0415560),\n\tvec3f(0.0556434, -0.2040259,  1.0572252)\n);\nfn iridescence_sensitivity(opd: f32, shift: vec3f) -> vec3f {\n\tlet PI: f32 = 3.141592653589793;\n\tlet phase: f32 = 2.0 * PI * opd * 1.0e-9;\n\tconst val: vec3f = vec3f(5.4856e-13, 4.4201e-13, 5.2481e-13);\n\tconst pos: vec3f = vec3f(1.6810e+06, 1.7953e+06, 2.2084e+06);\n\tconst var_: vec3f = vec3f(4.3278e+09, 9.3046e+09, 6.6121e+09);\n\tvar xyz: vec3f = val * sqrt(2.0 * PI * var_) * cos(pos * phase + shift) * exp(-pow(phase, 2.0) * var_);\n\txyz.x = xyz.x + 9.7470e-14 * sqrt(2.0 * PI * 4.5282e+09) * cos(2.2399e+06 * phase + shift[0]) * exp(-4.5282e+09 * pow(phase, 2.0));\n\txyz = xyz / vec3f(1.0685e-07);\n\treturn XYZ_TO_REC709 * xyz;\n}\nfn iridescence_fresnelScalar(cosTheta: f32, f0: f32) -> f32 {\n\tlet x: f32 = clamp(1.0 - cosTheta, 0.0, 1.0);\n\tlet x2: f32 = x * x;\n\tlet x5: f32 = x * x2 * x2;\n\treturn f0 + (1.0 - f0) * x5;\n}\nfn iridescence_fresnelVec3(cosTheta: f32, f0: vec3f) -> vec3f {\n\tlet x: f32 = clamp(1.0 - cosTheta, 0.0, 1.0);\n\tlet x2: f32 = x * x;\n\tlet x5: f32 = x * x2 * x2;\n\treturn f0 + (vec3f(1.0) - f0) * x5;\n}\nfn calcIridescence(outsideIor: f32, cosTheta: f32, base_f0: vec3f, iridescenceThickness: f32) -> vec3f {\n\tlet PI: f32 = 3.141592653589793;\n\tlet iridescenceIor: f32 = mix(outsideIor, uniform.material_iridescenceRefractionIndex, smoothstep(0.0, 0.03, iridescenceThickness));\n\tlet sinTheta2Sq: f32 = pow(outsideIor / iridescenceIor, 2.0) * (1.0 - pow(cosTheta, 2.0));\n\tlet cosTheta2Sq: f32 = 1.0 - sinTheta2Sq;\n\tif (cosTheta2Sq < 0.0) {\n\t\treturn vec3f(1.0);\n\t}\n\tlet cosTheta2: f32 = sqrt(cosTheta2Sq);\n\tlet r0: f32 = iridescence_iorToFresnelScalar(iridescenceIor, outsideIor);\n\tlet r12: f32 = iridescence_fresnelScalar(cosTheta, r0);\n\tlet r21: f32 = r12;\n\tlet t121: f32 = 1.0 - r12;\n\tlet phi12: f32 = select(0.0, PI, iridescenceIor < outsideIor);\n\tlet phi21: f32 = PI - phi12;\n\tlet baseIor: vec3f = iridescence_fresnelToIor(base_f0 + vec3f(0.0001));\n\tlet r1: vec3f = iridescence_iorToFresnelVec3(baseIor, iridescenceIor);\n\tlet r23: vec3f = iridescence_fresnelVec3(cosTheta2, r1);\n\tlet phi23: vec3f = select(vec3f(0.0), vec3f(PI), baseIor < vec3f(iridescenceIor));\n\tlet opd: f32 = 2.0 * iridescenceIor * iridescenceThickness * cosTheta2;\n\tlet phi: vec3f = vec3f(phi21) + phi23;\n\tlet r123Sq: vec3f = clamp(vec3f(r12) * r23, vec3f(1e-5), vec3f(0.9999));\n\tlet r123: vec3f = sqrt(r123Sq);\n\tlet rs: vec3f = pow(vec3f(t121), vec3f(2.0)) * r23 / (vec3f(1.0) - r123Sq);\n\tlet c0: vec3f = vec3f(r12) + rs;\n\tvar i_irid: vec3f = c0;\n\tvar cm: vec3f = rs - vec3f(t121);\n\tcm = cm * r123;\n\tlet sm1: vec3f = 2.0 * iridescence_sensitivity(1.0 * opd, 1.0 * phi);\n\ti_irid = i_irid + cm * sm1;\n\tcm = cm * r123;\n\tlet sm2: vec3f = 2.0 * iridescence_sensitivity(2.0 * opd, 2.0 * phi);\n\ti_irid = i_irid + cm * sm2;\n\treturn max(i_irid, vec3f(0.0));\n}\nfn getIridescenceDiffraction(cosTheta: f32, specularity: vec3f, iridescenceThickness: f32) -> vec3f {\n\treturn calcIridescence(1.0, cosTheta, specularity, iridescenceThickness);\n}\n",iridescencePS:"\n#ifdef STD_IRIDESCENCE_CONSTANT\n\tuniform material_iridescence: f32;\n#endif\nfn getIridescence() {\n\tvar iridescence = 1.0;\n\t#ifdef STD_IRIDESCENCE_CONSTANT\n\tiridescence = iridescence * uniform.material_iridescence;\n\t#endif\n\t#ifdef STD_IRIDESCENCE_TEXTURE\n\tiridescence = iridescence * textureSampleBias({STD_IRIDESCENCE_TEXTURE_NAME}, {STD_IRIDESCENCE_TEXTURE_NAME}Sampler, {STD_IRIDESCENCE_TEXTURE_UV}, uniform.textureBias).{STD_IRIDESCENCE_TEXTURE_CHANNEL};\n\t#endif\n\tdIridescence = iridescence; \n}\n",iridescenceThicknessPS:"\nuniform material_iridescenceThicknessMax: f32;\n#ifdef STD_IRIDESCENCETHICKNESS_TEXTURE\n\tuniform material_iridescenceThicknessMin: f32;\n#endif\nfn getIridescenceThickness() {\n\t#ifdef STD_IRIDESCENCETHICKNESS_TEXTURE\n\t\tvar blend: f32 = textureSampleBias({STD_IRIDESCENCETHICKNESS_TEXTURE_NAME}, {STD_IRIDESCENCETHICKNESS_TEXTURE_NAME}Sampler, {STD_IRIDESCENCETHICKNESS_TEXTURE_UV}, uniform.textureBias).{STD_IRIDESCENCETHICKNESS_TEXTURE_CHANNEL};\n\t\tvar iridescenceThickness: f32 = mix(uniform.material_iridescenceThicknessMin, uniform.material_iridescenceThicknessMax, blend);\n\t#else\n\t\tvar iridescenceThickness: f32 = uniform.material_iridescenceThicknessMax;\n\t#endif\n\tdIridescenceThickness = iridescenceThickness; \n}\n",iorPS:"\n#ifdef STD_IOR_CONSTANT\n\tuniform material_refractionIndex: f32;\n#endif\nfn getIor() {\n#ifdef STD_IOR_CONSTANT\n\tdIor = uniform.material_refractionIndex;\n#else\n\tdIor = 1.0 / 1.5;\n#endif\n}\n",lightDeclarationPS:"\n#if defined(LIGHT{i})\n\tuniform light{i}_color: vec3f;\n\t#if LIGHT{i}TYPE == DIRECTIONAL\n\t\tuniform light{i}_direction: vec3f;\n\t#else\n\t\t#define LIT_CODE_LIGHTS_POINT\n\t\tuniform light{i}_position: vec3f;\n\t\tuniform light{i}_radius: f32;\n\t\t#if LIGHT{i}TYPE == SPOT\n\t\t\t#define LIT_CODE_LIGHTS_SPOT\n\t\t\tuniform light{i}_direction: vec3f;\n\t\t\tuniform light{i}_innerConeAngle: f32;\n\t\t\tuniform light{i}_outerConeAngle: f32;\n\t\t#endif\n\t#endif\n\t#if LIGHT{i}SHAPE != PUNCTUAL\n\t\t#define LIT_CODE_FALLOFF_SQUARED\n\t\t#if LIGHT{i}TYPE == DIRECTIONAL\n\t\t\tuniform light{i}_position: vec3f;\n\t\t#endif\n\t\tuniform light{i}_halfWidth: vec3f;\n\t\tuniform light{i}_halfHeight: vec3f;\n\t#else\n\t\t#if LIGHT{i}FALLOFF == LINEAR\n\t\t\t#define LIT_CODE_FALLOFF_LINEAR\n\t\t#endif\n\t\t#if LIGHT{i}FALLOFF == INVERSESQUARED\n\t\t\t#define LIT_CODE_FALLOFF_SQUARED\n\t\t#endif\n\t#endif\n\t#if defined(LIGHT{i}CASTSHADOW)\n\t\tuniform light{i}_shadowMatrix: mat4x4f;\n\t\tuniform light{i}_shadowIntensity: f32;\n\t\tuniform light{i}_shadowParams: vec4f;\n\t\t#if LIGHT{i}SHADOWTYPE == PCSS_32F\n\t\t\tuniform light{i}_shadowSearchArea: f32;\n\t\t\tuniform light{i}_cameraParams: vec4f;\n\t\t\t#if LIGHT{i}TYPE == DIRECTIONAL\n\t\t\t\tuniform light{i}_softShadowParams: vec4f;\n\t\t\t#endif\n\t\t#endif\n\t\t#if LIGHT{i}TYPE == DIRECTIONAL\n\t\t\tuniform light{i}_shadowMatrixPalette: array<mat4x4f, 4>;\n\t\t\tuniform light{i}_shadowCascadeDistances: vec4f;\n\t\t\tuniform light{i}_shadowCascadeCount: i32;\n\t\t\tuniform light{i}_shadowCascadeBlend: f32;\n\t\t#endif\n\t\t#if LIGHT{i}TYPE == OMNI\n\t\t\tNOT SUPPORTED\n\t\t\t\n\t\t#else\n\t\t\t#if defined(LIGHT{i}SHADOW_PCF)\n\t\t\t\tvar light{i}_shadowMap: texture_depth_2d;\n\t\t\t\tvar light{i}_shadowMapSampler: sampler_comparison;\n\t\t\t#else\n\t\t\t\tvar light{i}_shadowMap: texture_2d<f32>;\n\t\t\t\tvar light{i}_shadowMapSampler: sampler;\n\t\t\t#endif\n\t\t#endif\n\t#endif\n\t#if defined(LIGHT{i}COOKIE)\n\t\t#define LIT_CODE_COOKIE\n\t\t#if LIGHT{i}TYPE == OMNI\n\t\t\tNOT SUPPORTED\n\t\t#endif\n\t\t#if LIGHT{i}TYPE == SPOT\n\t\t\tNOT SUPPORTED\n\t\t#endif\n\t#endif\n#endif\n",lightDiffuseLambertPS:"\nfn getLightDiffuse(worldNormal: vec3f, viewDir: vec3f, lightDirNorm: vec3f) -> f32 {\n\treturn max(dot(worldNormal, -lightDirNorm), 0.0);\n}\n",lightDirPointPS:"\nfn evalOmniLight(lightPosW: vec3f) -> vec3f {\n\treturn vPositionW - lightPosW;\n}\n",lightEvaluationPS:"\n#if defined(LIGHT{i})\n\tevaluateLight{i}(\n\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\tiridescenceFresnel\n\t\t#endif\n\t);\n#endif\n",lightFunctionLightPS:"\n#if defined(LIGHT{i})\nfn evaluateLight{i}(\n\t#if defined(LIT_IRIDESCENCE)\n\t\tiridescenceFresnel: vec3f\n\t#endif\n) {\n\tvar lightColor: vec3f = uniform.light{i}_color;\n\t#if LIGHT{i}TYPE == DIRECTIONAL && !defined(LIT_SHADOW_CATCHER)\n\t\tif (all(lightColor == vec3f(0.0, 0.0, 0.0))) {\n\t\t\treturn;\n\t\t}\n\t#endif\n\t#if LIGHT{i}TYPE == DIRECTIONAL\n\t\tdLightDirNormW = uniform.light{i}_direction;\n\t\tdAtten = 1.0;\n\t#else\n\t\tvar lightDirW: vec3f = evalOmniLight(uniform.light{i}_position);\n\t\tdLightDirNormW = normalize(lightDirW);\n\t\t#if defined(LIGHT{i}COOKIE)\n\t\t\t#if LIGHT{i}TYPE == SPOT\n\t\t\t\t#ifdef LIGHT{i}COOKIE_FALLOFF\n\t\t\t\t\t#ifdef LIGHT{i}COOKIE_TRANSFORM\n\t\t\t\t\t\tvar cookieAttenuation: vec3f = getCookie2DXform(uniform.light{i}_cookie, uniform.light{i}_shadowMatrix, uniform.light{i}_cookieIntensity, uniform.light{i}_cookieMatrix, uniform.light{i}_cookieOffset).{LIGHT{i}COOKIE_CHANNEL};\n\t\t\t\t\t#else\n\t\t\t\t\t\tvar cookieAttenuation: vec3f = getCookie2D(uniform.light{i}_cookie, uniform.light{i}_shadowMatrix, uniform.light{i}_cookieIntensity).{LIGHT{i}COOKIE_CHANNEL};\n\t\t\t\t\t#endif\n\t\t\t\t#else\n\t\t\t\t\t#ifdef LIGHT{i}COOKIE_TRANSFORM\n\t\t\t\t\t\tvar cookieAttenuation: vec3f = getCookie2DClipXform(uniform.light{i}_cookie, uniform.light{i}_shadowMatrix, uniform.light{i}_cookieIntensity, uniform.light{i}_cookieMatrix, uniform.light{i}_cookieOffset).{LIGHT{i}COOKIE_CHANNEL};\n\t\t\t\t\t#else\n\t\t\t\t\t\tvar cookieAttenuation: vec3f = getCookie2DClip(uniform.light{i}_cookie, uniform.light{i}_shadowMatrix, uniform.light{i}_cookieIntensity).{LIGHT{i}COOKIE_CHANNEL};\n\t\t\t\t\t#endif\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\t#if LIGHT{i}TYPE == OMNI\n\t\t\t\tvar cookieAttenuation: vec3f = getCookieCube(uniform.light{i}_cookie, uniform.light{i}_shadowMatrix, uniform.light{i}_cookieIntensity).{LIGHT{i}COOKIE_CHANNEL};\n\t\t\t#endif\n\t\t\tlightColor = lightColor * cookieAttenuation;\n\t\t#endif\n\t\t#if LIGHT{i}SHAPE == PUNCTUAL\n\t\t\t#if LIGHT{i}FALLOFF == LINEAR\n\t\t\t\tdAtten = getFalloffLinear(uniform.light{i}_radius, lightDirW);\n\t\t\t#else\n\t\t\t\tdAtten = getFalloffInvSquared(uniform.light{i}_radius, lightDirW);\n\t\t\t#endif\n\t\t#else\n\t\t\tdAtten = getFalloffWindow(uniform.light{i}_radius, lightDirW);\n\t\t#endif\n\t\t#if LIGHT{i}TYPE == SPOT\n\t\t\t#if !defined(LIGHT{i}COOKIE) || defined(LIGHT{i}COOKIE_FALLOFF)\n\t\t\t\tdAtten = dAtten * getSpotEffect(uniform.light{i}_direction, uniform.light{i}_innerConeAngle, uniform.light{i}_outerConeAngle, dLightDirNormW);\n\t\t\t#endif\n\t\t#endif\n\t#endif\n\tif (dAtten < 0.00001) {\n\t\treturn;\n\t}\n\t#if LIGHT{i}SHAPE != PUNCTUAL\n\t\t#if LIGHT{i}SHAPE == RECT\n\t\t\tcalcRectLightValues(uniform.light{i}_position, uniform.light{i}_halfWidth, uniform.light{i}_halfHeight);\n\t\t#elif LIGHT{i}SHAPE == DISK\n\t\t\tcalcDiskLightValues(uniform.light{i}_position, uniform.light{i}_halfWidth, uniform.light{i}_halfHeight);\n\t\t#elif LIGHT{i}SHAPE == SPHERE\n\t\t\tcalcSphereLightValues(uniform.light{i}_position, uniform.light{i}_halfWidth, uniform.light{i}_halfHeight);\n\t\t#endif\n\t#endif\n\t#if LIGHT{i}SHAPE != PUNCTUAL\n\t\t#if LIGHT{i}TYPE == DIRECTIONAL\n\t\t\tvar attenDiffuse: f32 = getLightDiffuse(litArgs_worldNormal, dViewDirW, dLightDirNormW);\n\t\t#else\n\t\t\t#if LIGHT{i}SHAPE == RECT\n\t\t\t\tvar attenDiffuse: f32 = getRectLightDiffuse(litArgs_worldNormal, dViewDirW, lightDirW, dLightDirNormW) * 16.0;\n\t\t\t#elif LIGHT{i}SHAPE == DISK\n\t\t\t\tvar attenDiffuse: f32 = getDiskLightDiffuse(litArgs_worldNormal, dViewDirW, lightDirW, dLightDirNormW) * 16.0;\n\t\t\t#elif LIGHT{i}SHAPE == SPHERE\n\t\t\t\tvar attenDiffuse: f32 = getSphereLightDiffuse(litArgs_worldNormal, dViewDirW, lightDirW, dLightDirNormW) * 16.0;\n\t\t\t#endif\n\t\t#endif\n\t#else\n\t\tdAtten = dAtten * getLightDiffuse(litArgs_worldNormal, vec3(0.0), dLightDirNormW);\n\t#endif\n\t#ifdef LIGHT{i}CASTSHADOW\n\t\t#if LIGHT{i}TYPE == DIRECTIONAL\n\t\t\tvar shadow: f32 = getShadow{i}(vec3(0.0));\n\t\t#else\n\t\t\tvar shadow: f32 = getShadow{i}(lightDirW);\n\t\t#endif\n\t\tshadow = mix(1.0, shadow, uniform.light{i}_shadowIntensity);\n\t\tdAtten = dAtten * shadow;\n\t\t#if defined(LIT_SHADOW_CATCHER) && LIGHT{i}TYPE == DIRECTIONAL\n\t\t\tdShadowCatcher = dShadowCatcher * shadow;\n\t\t#endif\t\t\t\n\t#endif\n\t#if LIGHT{i}SHAPE != PUNCTUAL\n\t\t#ifdef LIT_SPECULAR\n\t\t\tdDiffuseLight = dDiffuseLight + (((attenDiffuse * dAtten) * lightColor) * (1.0 - dLTCSpecFres));\n\t\t#else\n\t\t\tdDiffuseLight = dDiffuseLight + ((attenDiffuse * dAtten) * lightColor);\n\t\t#endif\t\t\t\t\t\t\n\t#else\n\t\t#if defined(AREA_LIGHTS) && defined(LIT_SPECULAR)\n\t\t\tdDiffuseLight = dDiffuseLight + ((dAtten * lightColor) * (1.0 - litArgs_specularity));\n\t\t#else\n\t\t\tdDiffuseLight = dDiffuseLight + (dAtten * lightColor);\n\t\t#endif\n\t#endif\n\t#ifdef LIGHT{i}AFFECT_SPECULARITY\n\t\t#if LIGHT{i}SHAPE != PUNCTUAL\n\t\t\t#ifdef LIT_CLEARCOAT\n\t\t\t\t#if LIGHT{i}SHAPE == RECT\n\t\t\t\t\tccSpecularLight = ccSpecularLight + (ccLTCSpecFres * getRectLightSpecular(litArgs_clearcoat_worldNormal, dViewDirW) * dAtten * lightColor);\n\t\t\t\t#elif LIGHT{i}SHAPE == DISK\n\t\t\t\t\tccSpecularLight = ccSpecularLight + (ccLTCSpecFres * getDiskLightSpecular(litArgs_clearcoat_worldNormal, dViewDirW) * dAtten * lightColor);\n\t\t\t\t#elif LIGHT{i}SHAPE == SPHERE\n\t\t\t\t\tccSpecularLight = ccSpecularLight + (ccLTCSpecFres * getSphereLightSpecular(litArgs_clearcoat_worldNormal, dViewDirW) * dAtten * lightColor);\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\t#ifdef LIT_SPECULAR\n\t\t\t\t#if LIGHT{i}SHAPE == RECT\n\t\t\t\t\tdSpecularLight = dSpecularLight + (dLTCSpecFres * getRectLightSpecular(litArgs_worldNormal, dViewDirW) * dAtten * lightColor);\n\t\t\t\t#elif LIGHT{i}SHAPE == DISK\n\t\t\t\t\tdSpecularLight = dSpecularLight + (dLTCSpecFres * getDiskLightSpecular(litArgs_worldNormal, dViewDirW) * dAtten * lightColor);\n\t\t\t\t#elif LIGHT{i}SHAPE == SPHERE\n\t\t\t\t\tdSpecularLight = dSpecularLight + (dLTCSpecFres * getSphereLightSpecular(litArgs_worldNormal, dViewDirW) * dAtten * lightColor);\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t#else\n\t\t\t#if LIGHT{i}TYPE == DIRECTIONAL && LIT_FRESNEL_MODEL != NONE\n\t\t\t\t#define LIGHT{i}FRESNEL\n\t\t\t#endif\n\t\t\t#ifdef LIT_SPECULAR\n\t\t\t\tvar halfDirW: vec3f = normalize(-dLightDirNormW + dViewDirW);\n\t\t\t#endif\n\t\t\t#ifdef LIT_CLEARCOAT\n\t\t\t\tvar lightspecularCC: vec3f = getLightSpecular(halfDirW, ccReflDirW, litArgs_clearcoat_worldNormal, dViewDirW, dLightDirNormW, litArgs_clearcoat_gloss, dTBN) * dAtten * lightColor;\n\t\t\t\t#ifdef LIGHT{i}FRESNEL\n\t\t\t\t\tlightspecularCC = lightspecularCC * getFresnelCC(dot(dViewDirW, halfDirW));\n\t\t\t\t#endif\n\t\t\t\tccSpecularLight = ccSpecularLight + lightspecularCC;\n\t\t\t#endif\n\t\t\t#ifdef LIT_SHEEN\n\t\t\t\tsSpecularLight = sSpecularLight + (getLightSpecularSheen(halfDirW, litArgs_worldNormal, dViewDirW, dLightDirNormW, litArgs_sheen_gloss) * dAtten * lightColor);\n\t\t\t#endif\n\t\t\t#ifdef LIT_SPECULAR\n\t\t\t\tvar lightSpecular: vec3f = getLightSpecular(halfDirW, dReflDirW, litArgs_worldNormal, dViewDirW, dLightDirNormW, litArgs_gloss, dTBN) * dAtten * lightColor;\n\t\t\t\t#ifdef LIGHT{i}FRESNEL\n\t\t\t\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t\tlightSpecular = lightSpecular * getFresnel(dot(dViewDirW, halfDirW), litArgs_gloss, litArgs_specularity, iridescenceFresnel, litArgs_iridescence_intensity);\n\t\t\t\t\t#else\n\t\t\t\t\t\tlightSpecular = lightSpecular * getFresnel(dot(dViewDirW, halfDirW), litArgs_gloss, litArgs_specularity);\n\t\t\t\t\t#endif\n\t\t\t\t#else\n\t\t\t\t\tlightSpecular = lightSpecular * litArgs_specularity;\n\t\t\t\t#endif\n\t\t\t\t\n\t\t\t\tdSpecularLight = dSpecularLight + lightSpecular;\n\t\t\t#endif\n\t\t#endif\n\t#endif\n}\n#endif\n",lightFunctionShadowPS:"\n#ifdef LIGHT{i}CASTSHADOW\n\tfn getShadowSampleCoord{i}(shadowTransform: mat4x4f, shadowParams: vec4f, worldPosition: vec3f, lightPos: vec3f, lightDir: ptr<function, vec3f>, lightDirNorm: vec3f, normal: vec3f) -> vec3f {\n\t\tvar surfacePosition = worldPosition;\n\t\t#ifdef LIGHT{i}_SHADOW_SAMPLE_POINT\n\t\t\t#ifdef LIGHT{i}_SHADOW_SAMPLE_NORMAL_OFFSET\n\t\t\t\tlet distScale: f32 = length(*lightDir);\n\t\t\t\tsurfacePosition = surfacePosition + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;\n\t\t\t\t*lightDir = surfacePosition - lightPos;\n\t\t\t\treturn *lightDir;\n\t\t\t#endif\n\t\t#else\n\t\t\t#ifdef LIGHT{i}_SHADOW_SAMPLE_SOURCE_ZBUFFER\n\t\t\t\t#ifdef LIGHT{i}_SHADOW_SAMPLE_NORMAL_OFFSET\n\t\t\t\t\tsurfacePosition = surfacePosition + normal * shadowParams.y;\n\t\t\t\t#endif\n\t\t\t#else\n\t\t\t\t#ifdef LIGHT{i}_SHADOW_SAMPLE_NORMAL_OFFSET\n\t\t\t\t\t#ifdef LIGHT{i}_SHADOW_SAMPLE_ORTHO\n\t\t\t\t\t\tvar distScale: f32 = 1.0;\n\t\t\t\t\t#else\n\t\t\t\t\t\tvar distScale: f32 = abs(dot(vPositionW - lightPos, lightDirNorm));\n\t\t\t\t\t#endif\n\t\t\t\t\tsurfacePosition = surfacePosition + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\tvar positionInShadowSpace: vec4f = shadowTransform * vec4f(surfacePosition, 1.0);\n\t\t\t#ifdef LIGHT{i}_SHADOW_SAMPLE_ORTHO\n\t\t\t\tpositionInShadowSpace.z = saturate(positionInShadowSpace.z) - 0.0001;\n\t\t\t#else\n\t\t\t\t#ifdef LIGHT{i}_SHADOW_SAMPLE_SOURCE_ZBUFFER\n\t\t\t\t\tpositionInShadowSpace.xyz = positionInShadowSpace.xyz / positionInShadowSpace.w;\n\t\t\t\t#else\n\t\t\t\t\tpositionInShadowSpace.xy = positionInShadowSpace.xy / positionInShadowSpace.w;\n\t\t\t\t\tpositionInShadowSpace.z = length(*lightDir) * shadowParams.w;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\t#ifdef SHADOW_SAMPLE_Z_BIAS\n\t\t\t#endif\n\t\t\tsurfacePosition = positionInShadowSpace.xyz;\n\t\t#endif\n\t\treturn surfacePosition;\n\t}\n\tfn getShadow{i}(lightDirW_in: vec3f) -> f32 {\n\t\t#ifdef LIGHT{i}_SHADOW_CASCADES\n\t\t\tvar cascadeIndex: i32 = getShadowCascadeIndex(uniform.light{i}_shadowCascadeDistances, uniform.light{i}_shadowCascadeCount);\n\t\t\t#ifdef LIGHT{i}_SHADOW_CASCADE_BLEND\n\t\t\t\tcascadeIndex = ditherShadowCascadeIndex(cascadeIndex, uniform.light{i}_shadowCascadeDistances, uniform.light{i}_shadowCascadeCount, uniform.light{i}_shadowCascadeBlend);\n\t\t\t#endif\n\t\t\tvar shadowMatrix: mat4x4f = uniform.light{i}_shadowMatrixPalette[cascadeIndex];\n\t\t#else\n\t\t\tvar shadowMatrix: mat4x4f = uniform.light{i}_shadowMatrix;\n\t\t#endif\n\t\tvar lightDirArg = lightDirW_in;\n\t\t#if LIGHT{i}TYPE == DIRECTIONAL\n\t\t\tvar shadowCoord: vec3f = getShadowSampleCoord{i}(shadowMatrix, uniform.light{i}_shadowParams, vPositionW, vec3f(0.0), &lightDirArg, dLightDirNormW, dVertexNormalW);\n\t\t#else\n\t\t\t var shadowCoord: vec3f = getShadowSampleCoord{i}(shadowMatrix, uniform.light{i}_shadowParams, vPositionW, uniform.light{i}_position, &lightDirArg, dLightDirNormW, dVertexNormalW);\n\t\t#endif\n\t\t#if LIGHT{i}TYPE == DIRECTIONAL\n\t\t\tshadowCoord = fadeShadow(shadowCoord, uniform.light{i}_shadowCascadeDistances);\n\t\t#endif\n\t\t#if LIGHT{i}TYPE == DIRECTIONAL\n\t\t\t#if LIGHT{i}SHADOWTYPE == VSM_16F\n\t\t\t\treturn getShadowVSM16(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, 5.54);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == VSM_32F\n\t\t\t\treturn getShadowVSM32(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, 15.0);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCSS_32F\n\t\t\t\t#if LIGHT{i}SHAPE != PUNCTUAL\n\t\t\t\t\tlet shadowSearchArea = vec2f(length(uniform.light{i}_halfWidth), length(uniform.light{i}_halfHeight)) * uniform.light{i}_shadowSearchArea;\n\t\t\t\t\treturn getShadowPCSS(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, uniform.light{i}_cameraParams, shadowSearchArea, lightDirW_in);\n\t\t\t\t#else\n\t\t\t\t\treturn getShadowPCSS(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, uniform.light{i}_cameraParams, uniform.light{i}_softShadowParams, lightDirW_in);\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCF1_16F || LIGHT{i}SHADOWTYPE == PCF1_32F\n\t\t\t\treturn getShadowPCF1x1(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCF3_16F || LIGHT{i}SHADOWTYPE == PCF3_32F\n\t\t\t\treturn getShadowPCF3x3(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCF5_16F || LIGHT{i}SHADOWTYPE == PCF5_32F\n\t\t\t\treturn getShadowPCF5x5(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams);\n\t\t\t#endif\n\t\t#endif\n\t\t#if LIGHT{i}TYPE == SPOT\n\t\t\t#if LIGHT{i}SHADOWTYPE == VSM_16F\n\t\t\t\treturn getShadowSpotVSM16(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, 5.54, lightDirW_in);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == VSM_32F\n\t\t\t\treturn getShadowSpotVSM32(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, 15.0, lightDirW_in);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCSS_32F\n\t\t\t\t#if LIGHT{i}SHAPE != PUNCTUAL\n\t\t\t\t\tvar shadowSearchArea: vec2f = vec2f(length(uniform.light{i}_halfWidth), length(uniform.light{i}_halfHeight)) * uniform.light{i}_shadowSearchArea;\n\t\t\t\t#else\n\t\t\t\t\tvar shadowSearchArea: vec2f = vec2f(uniform.light{i}_shadowSearchArea);\n\t\t\t\t#endif\n\t\t\t\treturn getShadowSpotPCSS(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, uniform.light{i}_cameraParams, shadowSearchArea, lightDirW_in);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCF1_16F || LIGHT{i}SHADOWTYPE == PCF1_32F\n\t\t\t\treturn getShadowSpotPCF1x1(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCF3_16F || LIGHT{i}SHADOWTYPE == PCF3_32F\n\t\t\t\treturn getShadowSpotPCF3x3(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCF5_16F || LIGHT{i}SHADOWTYPE == PCF5_32F\n\t\t\t\treturn getShadowSpotPCF5x5(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams);\n\t\t\t#endif\n\t\t#endif\n\t\t#if LIGHT{i}TYPE == OMNI\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCSS_32F\n\t\t\t\t var shadowSearchArea: vec2f;\n\t\t\t\t #if LIGHT{i}SHAPE != PUNCTUAL\n\t\t\t\t\tvar shadowSearchArea: vec2f = vec2f(length(uniform.light{i}_halfWidth), length(uniform.light{i}_halfHeight)) * uniform.light{i}_shadowSearchArea;\n\t\t\t\t#else\n\t\t\t\t\tvar shadowSearchArea: vec2f = vec2f(uniform.light{i}_shadowSearchArea);\n\t\t\t\t#endif\n\t\t\t\treturn getShadowOmniPCSS(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, uniform.light{i}_cameraParams, shadowSearchArea, lightDirW_in);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCF1_16F || LIGHT{i}SHADOWTYPE == PCF1_32F\n\t\t\t\treturn getShadowOmniPCF1x1(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, lightDirW_in);\n\t\t\t#endif\n\t\t\t#if LIGHT{i}SHADOWTYPE == PCF3_16F || LIGHT{i}SHADOWTYPE == PCF3_32F\n\t\t\t\treturn getShadowOmniPCF3x3(light{i}_shadowMap, light{i}_shadowMapSampler, shadowCoord, uniform.light{i}_shadowParams, lightDirW_in);\n\t\t\t#endif\n\t\t#endif\n\t}\n#endif\n",lightingPS:'\n#ifdef LIT_CLUSTERED_LIGHTS\n\t#define LIT_CODE_FALLOFF_LINEAR\n\t#define LIT_CODE_FALLOFF_SQUARED\n\t#define LIT_CODE_LIGHTS_POINT\n\t#define LIT_CODE_LIGHTS_SPOT\n#endif\n#ifdef AREA_LIGHTS\n\tvar areaLightsLutTex1: texture_2d<f32>;\n\tvar areaLightsLutTex1Sampler: sampler;\n\tvar areaLightsLutTex2: texture_2d<f32>;\n\tvar areaLightsLutTex2Sampler: sampler;\n#endif\n#ifdef LIT_LIGHTING\n\t#include "lightDiffuseLambertPS"\n\t#if defined(AREA_LIGHTS) || defined(LIT_CLUSTERED_AREA_LIGHTS)\n\t\t#include "ltcPS"\n\t#endif\n#endif\n#ifdef SHADOW_DIRECTIONAL\n\t#include "shadowCascadesPS"\n#endif\n#if defined(SHADOW_KIND_PCF1)\n\t#include "shadowPCF1PS"\n#endif\n#if defined(SHADOW_KIND_PCF3)\n\t#include "shadowPCF3PS"\n#endif\n#if defined(SHADOW_KIND_PCF5)\n\t#include "shadowPCF5PS"\n#endif\n#if defined(SHADOW_KIND_PCSS)\n\t#include "linearizeDepthPS"\n\t#include "shadowSoftPS"\n#endif\n#if defined(SHADOW_KIND_VSM)\n\t#include "shadowEVSMPS"\n#endif\n#ifdef LIT_CODE_FALLOFF_LINEAR\n\t#include "falloffLinearPS"\n#endif\n#ifdef LIT_CODE_FALLOFF_SQUARED\n\t#include "falloffInvSquaredPS"\n#endif\n#ifdef LIT_CODE_LIGHTS_POINT\n\t#include "lightDirPointPS"\n#endif\n#ifdef LIT_CODE_LIGHTS_SPOT\n\t#include "spotPS"\n#endif\n#ifdef LIT_CODE_COOKIE\n\t#include "cookiePS"\n#endif\n#ifdef LIT_CLUSTERED_LIGHTS\n\t#include "clusteredLightPS"\n#endif\n#ifdef LIGHT_COUNT > 0\n\t#include "lightFunctionShadowPS, LIGHT_COUNT"\n\t#include "lightFunctionLightPS, LIGHT_COUNT"\n#endif\n',lightmapAddPS:"\nfn addLightMap(\n\tlightmap: vec3f,\n\tdir: vec3f,\n\tworldNormal: vec3f,\n\tviewDir: vec3f,\n\treflectionDir: vec3f,\n\tgloss: f32,\n\tspecularity: vec3f,\n\tvertexNormal: vec3f,\n\ttbn: mat3x3f\n#if defined(LIT_IRIDESCENCE)\n\t, iridescenceFresnel: vec3f,\n\tiridescenceIntensity: f32\n#endif\n) {\n\t#if defined(LIT_SPECULAR) && defined(LIT_DIR_LIGHTMAP)\n\t\tif (dot(dir, dir) < 0.0001) {\n\t\t\t\tdDiffuseLight = dDiffuseLight + lightmap;\n\t\t} else {\n\t\t\tlet vlight: f32 = saturate(dot(dir, -vertexNormal));\n\t\t\tlet flight: f32 = saturate(dot(dir, -worldNormal));\n\t\t\tlet nlight: f32 = (flight / max(vlight, 0.01)) * 0.5;\n\t\t\tdDiffuseLight = dDiffuseLight + lightmap * nlight * 2.0;\n\t\t\tlet halfDir: vec3f = normalize(-dir + viewDir);\n\t\t\tvar specularLight: vec3f = lightmap * getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, dir, gloss, tbn);\n\t\t\t#ifdef LIT_SPECULAR_FRESNEL\n\t\t\t\tspecularLight = specularLight *\n\t\t\t\t\tgetFresnel(dot(viewDir, halfDir),\n\t\t\t\t\tgloss,\n\t\t\t\t\tspecularity\n\t\t\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t, iridescenceFresnel,\n\t\t\t\t\tiridescenceIntensity\n\t\t\t\t#endif\n\t\t\t\t\t);\n\t\t\t#endif\n\t\t\tdSpecularLight = dSpecularLight + specularLight;\n\t\t}\n\t#else\n\t\tdDiffuseLight = dDiffuseLight + lightmap;\n\t#endif\n}\n",lightmapPS:"\n#ifdef STD_LIGHTMAP_DIR\n\tvar<private> dLightmapDir: vec3f;\n\tvar texture_dirLightMap: texture_2d<f32>;\n\tvar texture_dirLightMapSampler: sampler;\n#endif\nfn getLightMap() {\n\tdLightmap = vec3f(1.0);\n\t#ifdef STD_LIGHT_TEXTURE\n\t\tdLightmap = dLightmap * {STD_LIGHT_TEXTURE_DECODE}(textureSampleBias({STD_LIGHT_TEXTURE_NAME}, {STD_LIGHT_TEXTURE_NAME}Sampler, {STD_LIGHT_TEXTURE_UV}, uniform.textureBias)).{STD_LIGHT_TEXTURE_CHANNEL};\n\t\t#ifdef STD_LIGHTMAP_DIR\n\t\t\tvar dir: vec3f = textureSampleBias(texture_dirLightMap, texture_dirLightMapSampler, {STD_LIGHT_TEXTURE_UV}, uniform.textureBias).xyz * 2.0 - 1.0;\n\t\t\tvar dirDot = dot(dir, dir);\n\t\t\tdLightmapDir = select(vec3(0.0), dir / sqrt(dirDot), dirDot > 0.001);\n\t\t#endif\n\t#endif\n\t#ifdef STD_LIGHT_VERTEX\n\t\tdLightmap = dLightmap * saturate(vVertexColor.{STD_LIGHT_VERTEX_CHANNEL});\n\t#endif\n}\n",lightSpecularAnisoGGXPS:"\nfn calcLightSpecular(gloss: f32, worldNormal: vec3f, viewDir: vec3f, h: vec3f, lightDirNorm: vec3f, tbn: mat3x3f) -> f32 {\n\tlet PI: f32 = 3.141592653589793;\n\tlet roughness: f32 = max((1.0 - gloss) * (1.0 - gloss), 0.001);\n\tlet alphaRoughness: f32 = roughness * roughness;\n\tlet anisotropy: f32 = dAnisotropy;\n\tlet direction: vec2f = dAnisotropyRotation;\n\tlet at: f32 = mix(alphaRoughness, 1.0, anisotropy * anisotropy);\n\tlet ab: f32 = clamp(alphaRoughness, 0.001, 1.0);\n\tlet anisotropicT: vec3f = normalize(tbn * vec3f(direction, 0.0));\n\tlet anisotropicB: vec3f = normalize(cross(tbn[2], anisotropicT));\n\tlet NoH: f32 = dot(worldNormal, h);\n\tlet ToH: f32 = dot(anisotropicT, h);\n\tlet BoH: f32 = dot(anisotropicB, h);\n\tlet a2: f32 = at * ab;\n\tlet v: vec3f = vec3f(ab * ToH, at * BoH, a2 * NoH);\n\tlet v2: f32 = dot(v, v);\n\tlet w2: f32 = a2 / v2;\n\tlet D: f32 = a2 * w2 * w2 * (1.0 / PI);\n\tlet ToV: f32 = dot(anisotropicT, viewDir);\n\tlet BoV: f32 = dot(anisotropicB, viewDir);\n\tlet ToL: f32 = dot(anisotropicT, -lightDirNorm);\n\tlet BoL: f32 = dot(anisotropicB, -lightDirNorm);\n\tlet NoV: f32 = dot(worldNormal, viewDir);\n\tlet NoL: f32 = dot(worldNormal, -lightDirNorm);\n\tlet lambdaV: f32 = NoL * length(vec3f(at * ToV, ab * BoV, NoV));\n\tlet lambdaL: f32 = NoV * length(vec3f(at * ToL, ab * BoL, NoL));\n\tlet G: f32 = 0.5 / (lambdaV + lambdaL);\n\treturn D * G;\n}\nfn getLightSpecular(h: vec3f, reflDir: vec3f, worldNormal: vec3f, viewDir: vec3f, lightDirNorm: vec3f, gloss: f32, tbn: mat3x3f) -> f32 {\n\treturn calcLightSpecular(gloss, worldNormal, viewDir, h, lightDirNorm, tbn);\n}\n",lightSpecularBlinnPS:"\nfn calcLightSpecular(gloss: f32, worldNormal: vec3f, h: vec3f) -> f32 {\n\tlet nh: f32 = max( dot( h, worldNormal ), 0.0 );\n\tvar specPow: f32 = exp2(gloss * 11.0);\n\tspecPow = max(specPow, 0.0001);\n\treturn pow(nh, specPow) * (specPow + 2.0) / 8.0;\n}\nfn getLightSpecular(h: vec3f, reflDir: vec3f, worldNormal: vec3f, viewDir: vec3f, lightDirNorm: vec3f, gloss: f32, tbn: mat3x3f) -> f32 {\n\treturn calcLightSpecular(gloss, worldNormal, h);\n}\n",lightSheenPS:"\nfn sheenD(normal: vec3f, h: vec3f, roughness: f32) -> f32 {\n\tlet PI: f32 = 3.141592653589793;\n\tlet invR: f32 = 1.0 / (roughness * roughness);\n\tvar cos2h: f32 = max(dot(normal, h), 0.0);\n\tcos2h = cos2h * cos2h;\n\tlet sin2h: f32 = max(1.0 - cos2h, 0.0078125);\n\treturn (2.0 + invR) * pow(sin2h, invR * 0.5) / (2.0 * PI);\n}\nfn sheenV(normal: vec3f, viewDir: vec3f, light: vec3f) -> f32 {\n\tlet NoV: f32 = max(dot(normal, viewDir), 0.000001);\n\tlet NoL: f32 = max(dot(normal, light), 0.000001);\n\treturn 1.0 / (4.0 * (NoL + NoV - NoL * NoV));\n}\nfn getLightSpecularSheen(h: vec3f, worldNormal: vec3f, viewDir: vec3f, lightDirNorm: vec3f, sheenGloss: f32) -> f32 {\n\tlet D: f32 = sheenD(worldNormal, h, sheenGloss);\n\tlet V: f32 = sheenV(worldNormal, viewDir, -lightDirNorm);\n\treturn D * V;\n}",linearizeDepthPS:"\n#ifndef LINEARIZE_DEPTH\n#define LINEARIZE_DEPTH\nfn linearizeDepthWithParams(z: f32, cameraParams: vec4f) -> f32 {\n\tif (cameraParams.w == 0.0) {\n\t\treturn (cameraParams.z * cameraParams.y) / (cameraParams.y + z * (cameraParams.z - cameraParams.y));\n\t} else {\n\t\treturn cameraParams.z + z * (cameraParams.y - cameraParams.z);\n\t}\n}\n#ifndef CAMERAPLANES\n\t#define CAMERAPLANES\n\tuniform camera_params: vec4f;\n#endif\nfn linearizeDepth(z: f32) -> f32 {\n\treturn linearizeDepthWithParams(z, uniform.camera_params);\n}\n#endif\n",litForwardBackendPS:'\nfn evaluateBackend() -> FragmentOutput {\n\tvar output: FragmentOutput;\n\t#ifdef LIT_SSAO\n\t\tlitArgs_ao = litArgs_ao * textureSampleLevel(ssaoTexture, ssaoTextureSampler, pcPosition.xy * uniform.ssaoTextureSizeInv, 0.0).r;\n\t#endif\n\t#ifdef LIT_NEEDS_NORMAL\n\t\t#ifdef LIT_SPECULAR\n\t\t\tgetReflDir(litArgs_worldNormal, dViewDirW, litArgs_gloss, dTBN);\n\t\t#endif\n\t\t#ifdef LIT_CLEARCOAT\n\t\t\tccReflDirW = normalize(-reflect(dViewDirW, litArgs_clearcoat_worldNormal));\n\t\t#endif\n\t#endif\n\t#ifdef LIT_SPECULAR_OR_REFLECTION\n\t\t#ifdef LIT_METALNESS\n\t\t\tvar f0: f32 = 1.0 / litArgs_ior;\n\t\t\tf0 = (f0 - 1.0) / (f0 + 1.0);\n\t\t\tf0 = f0 * f0;\n\t\t\tlitArgs_specularity = getSpecularModulate(litArgs_specularity, litArgs_albedo, litArgs_metalness, f0);\n\t\t\tlitArgs_albedo = getAlbedoModulate(litArgs_albedo, litArgs_metalness);\n\t\t#endif\n\t\t#ifdef LIT_IRIDESCENCE\n\t\t\tvar iridescenceFresnel: vec3f = getIridescenceDiffraction(saturate(dot(dViewDirW, litArgs_worldNormal)), litArgs_specularity, litArgs_iridescence_thickness);\n\t\t#endif\n\t#endif\n\t#ifdef LIT_ADD_AMBIENT\n\t\taddAmbient(litArgs_worldNormal);\n\t\t#ifdef LIT_SPECULAR\n\t\t\tdDiffuseLight = dDiffuseLight * (1.0 - litArgs_specularity);\n\t\t#endif\n\t\t#ifdef LIT_SEPARATE_AMBIENT\n\t\t\tvar dAmbientLight: vec3f = dDiffuseLight;\n\t\t\tdDiffuseLight = vec3(0.0);\n\t\t#endif\n\t#endif\n\t#ifndef LIT_OLD_AMBIENT\n\t\tdDiffuseLight = dDiffuseLight * uniform.material_ambient;\n\t#endif\n\t#ifdef LIT_AO\n\t\t#ifndef LIT_OCCLUDE_DIRECT\n\t\t\toccludeDiffuse(litArgs_ao);\n\t\t#endif\n\t#endif\n\t#ifdef LIT_LIGHTMAP\n\t\taddLightMap(\n\t\t\tlitArgs_lightmap, \n\t\t\tlitArgs_lightmapDir, \n\t\t\tlitArgs_worldNormal, \n\t\t\tdViewDirW, \n\t\t\tdReflDirW, \n\t\t\tlitArgs_gloss, \n\t\t\tlitArgs_specularity, \n\t\t\tdVertexNormalW,\n\t\t\tdTBN\n\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t, iridescenceFresnel,\n\t\t\tlitArgs_iridescence_intensity\n\t\t#endif\n\t\t);\n\t#endif\n\t#ifdef LIT_LIGHTING || LIT_REFLECTIONS\n\t\t#ifdef LIT_REFLECTIONS\n\t\t\t#ifdef LIT_CLEARCOAT\n\t\t\t\taddReflectionCC(ccReflDirW, litArgs_clearcoat_gloss);\n\t\t\t\n\t\t\t\t#ifdef LIT_SPECULAR_FRESNEL\n\t\t\t\t\tccFresnel = getFresnelCC(dot(dViewDirW, litArgs_clearcoat_worldNormal));\n\t\t\t\t\tccReflection = ccReflection * ccFresnel;\n\t\t\t\t#else\n\t\t\t\t\tccFresnel = 0.0;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\t#ifdef LIT_SPECULARITY_FACTOR\n\t\t\t\tccReflection = ccReflection * litArgs_specularityFactor;\n\t\t\t#endif\n\t\t\t#ifdef LIT_SHEEN\n\t\t\t\taddReflectionSheen(litArgs_worldNormal, dViewDirW, litArgs_sheen_gloss);\n\t\t\t#endif\n\t\t\taddReflection(dReflDirW, litArgs_gloss);\n\t\t\t#ifdef LIT_FRESNEL_MODEL\n\t\t\t\tdReflection = vec4f(\n\t\t\t\t\tdReflection.rgb * getFresnel(\n\t\t\t\t\t\tdot(dViewDirW, litArgs_worldNormal),\n\t\t\t\t\t\tlitArgs_gloss,\n\t\t\t\t\t\tlitArgs_specularity\n\t\t\t\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t\t, iridescenceFresnel,\n\t\t\t\t\t\tlitArgs_iridescence_intensity\n\t\t\t\t\t#endif\n\t\t\t\t\t\t),\n\t\t\t\t\tdReflection.a\n\t\t\t\t);\n\t\t\t#else\n\t\t\t\tdReflection = vec4f(dReflection.rgb * litArgs_specularity, dReflection.a);\n\t\t\t#endif\n\t\t\t#ifdef LIT_SPECULARITY_FACTOR\n\t\t\t\tdReflection = vec4f(dReflection.rgb * litArgs_specularityFactor, dReflection.a);\n\t\t\t#endif\n\t\t#endif\n\t\t#ifdef AREA_LIGHTS\n\t\t\tdSpecularLight = dSpecularLight * litArgs_specularity;\n\t\t\t#ifdef LIT_SPECULAR\n\t\t\t\tcalcLTCLightValues(litArgs_gloss, litArgs_worldNormal, dViewDirW, litArgs_specularity, litArgs_clearcoat_gloss, litArgs_clearcoat_worldNormal, litArgs_clearcoat_specularity);\n\t\t\t#endif\n\t\t#endif\n\t\t\n\t\t#ifdef LIGHT_COUNT > 0\n\t\t\t#include "lightEvaluationPS, LIGHT_COUNT"\n\t\t#endif\n\t\t#ifdef LIT_CLUSTERED_LIGHTS\n\t\t\taddClusteredLights(litArgs_worldNormal, dViewDirW, dReflDirW,\n\t\t\t\t#if defined(LIT_CLEARCOAT)\n\t\t\t\t\t\tccReflDirW,\n\t\t\t\t#endif\n\t\t\t\t\t\tlitArgs_gloss, litArgs_specularity, dVertexNormalW, dTBN, \n\t\t\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t\tiridescenceFresnel,\n\t\t\t\t#endif\n\t\t\t\t\t\tlitArgs_clearcoat_worldNormal, litArgs_clearcoat_gloss, litArgs_sheen_gloss, litArgs_iridescence_intensity\n\t\t\t);\n\t\t#endif\n\t\t#ifdef AREA_LIGHTS\n\t\t\t#ifdef LIT_CLEARCOAT\n\t\t\t\tlitArgs_clearcoat_specularity = 1.0;\n\t\t\t#endif\n\t\t\t#ifdef LIT_SPECULAR\n\t\t\t\tlitArgs_specularity = vec3(1.0);\n\t\t\t#endif\n\t\t#endif\n\t\t#ifdef LIT_REFRACTION\n\t\t\taddRefraction(\n\t\t\t\tlitArgs_worldNormal, \n\t\t\t\tdViewDirW, \n\t\t\t\tlitArgs_thickness, \n\t\t\t\tlitArgs_gloss, \n\t\t\t\tlitArgs_specularity, \n\t\t\t\tlitArgs_albedo, \n\t\t\t\tlitArgs_transmission,\n\t\t\t\tlitArgs_ior,\n\t\t\t\tlitArgs_dispersion\n\t\t\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t, iridescenceFresnel, \n\t\t\t\t\tlitArgs_iridescence_intensity\n\t\t\t\t#endif\n\t\t\t);\n\t\t#endif\n\t#endif\n\t#ifdef LIT_AO\n\t\t#ifdef LIT_OCCLUDE_DIRECT\n\t\t\toccludeDiffuse(litArgs_ao);\n\t\t#endif\n\t\t#if LIT_OCCLUDE_SPECULAR != NONE\n\t\t\toccludeSpecular(litArgs_gloss, litArgs_ao, litArgs_worldNormal, dViewDirW);\n\t\t#endif\n\t#endif\n\t#ifdef LIT_SPECULARITY_FACTOR\n\t\tdSpecularLight = dSpecularLight * litArgs_specularityFactor;\n\t#endif\n\t#if !defined(LIT_OPACITY_FADES_SPECULAR)\n\t\t#if LIT_BLEND_TYPE == NORMAL || LIT_BLEND_TYPE == PREMULTIPLIED\n\t\t\tvar specLum: f32 = dot((dSpecularLight + dReflection.rgb * dReflection.a), vec3f( 0.2126, 0.7152, 0.0722 ));\n\t\t\t#ifdef LIT_CLEARCOAT\n\t\t\t\tspecLum = specLum + dot(ccSpecularLight * litArgs_clearcoat_specularity + ccReflection * litArgs_clearcoat_specularity, vec3f( 0.2126, 0.7152, 0.0722 ));\n\t\t\t#endif\n\t\t\tlitArgs_opacity = clamp(litArgs_opacity + gammaCorrectInput(specLum), 0.0, 1.0);\n\t\t#endif\n\t\tlitArgs_opacity = litArgs_opacity * uniform.material_alphaFade;\n\t#endif\n\t#ifdef LIT_LIGHTMAP_BAKING\n\t\t#ifdef LIT_LIGHTMAP_BAKING_COLOR\n\t\t\t#include "bakeLmEndPS"\n\t\t#endif\n\t\t#ifdef LIT_LIGHTMAP_BAKING_DIR\n\t\t\t#include "bakeDirLmEndPS"\n\t\t#endif\n\t#else\n\t\t#include "endPS"\n\t\t#include "outputAlphaPS"\n\t#endif\n\t#ifdef LIT_MSDF\n\t\toutput.color = applyMsdf(output.color);\n\t#endif\n\t#include "outputPS"\n\t#include "debugOutputPS"\n\t#ifdef LIT_SHADOW_CATCHER\n\t\toutput.color = vec4f(vec3f(dShadowCatcher), output.color.a);\n\t#endif\n\treturn output;\n}\n',litForwardDeclarationPS:'\nvar<private> sReflection: vec3f;\nvar<private> dVertexNormalW: vec3f;\nvar<private> dTangentW: vec3f;\nvar<private> dBinormalW: vec3f;\nvar<private> dViewDirW: vec3f;\nvar<private> dReflDirW: vec3f;\nvar<private> ccReflDirW: vec3f;\nvar<private> dLightDirNormW: vec3f;\nvar<private> dAtten: f32;\nvar<private> dTBN: mat3x3f;\nvar<private> dReflection: vec4f;\nvar<private> dDiffuseLight: vec3f;\nvar<private> dSpecularLight: vec3f;\nvar<private> ccFresnel: f32;\nvar<private> ccReflection: vec3f;\nvar<private> ccSpecularLight: vec3f;\nvar<private> ccSpecularityNoFres: f32;\nvar<private> sSpecularLight: vec3f;\n#ifdef LIT_DISPERSION\n\tuniform material_dispersion: f32;\n#endif\n#ifndef LIT_OPACITY_FADES_SPECULAR\n\tuniform material_alphaFade: f32;\n#endif\n#ifdef LIT_SSAO\n\tvar ssaoTexture : texture_2d<f32>;\n\tvar ssaoTextureSampler : sampler;\n\tuniform ssaoTextureSizeInv: vec2f;\n#endif\n#ifdef LIT_SHADOW_CATCHER\n\tvar<private> dShadowCatcher: f32 = 1.0;\n#endif\n#if LIGHT_COUNT > 0\n\t#include "lightDeclarationPS, LIGHT_COUNT"\n#endif\n#ifdef LIT_SPECULAR\n\t#if LIT_FRESNEL_MODEL == NONE && !defined(LIT_REFLECTIONS) && !defined(LIT_DIFFUSE_MAP) \n\t\t#define LIT_OLD_AMBIENT\n\t#endif\n#endif\n#ifdef STD_LIGHTMAP_DIR\n\tuniform bakeDir: f32;\n#endif\n#ifdef LIT_LIGHTMAP_BAKING_ADD_AMBIENT\n\tuniform ambientBakeOcclusionContrast: f32;\n\tuniform ambientBakeOcclusionBrightness: f32;\n#endif\n',litForwardMainPS:'\n@fragment\nfn fragmentMain(input: FragmentInput) -> FragmentOutput {\n\t#include "litUserMainStartPS"\n\tdReflection = vec4f(0.0);\n\t#ifdef LIT_CLEARCOAT\n\t\tccSpecularLight = vec3f(0.0);\n\t\tccReflection = vec3f(0.0);\n\t#endif\n\t#if LIT_NONE_SLICE_MODE == SLICED\n\t\t#include "startNineSlicedPS"\n\t#elif LIT_NONE_SLICE_MODE == TILED\n\t\t#include "startNineSlicedTiledPS"\n\t#endif\n\t#ifdef LIT_NEEDS_NORMAL\n\t\tdVertexNormalW = normalize(vNormalW);\n\t\t#ifdef LIT_TANGENTS\n\t\t\t#if defined(LIT_HEIGHTS) || defined(LIT_USE_NORMALS) || defined(LIT_USE_CLEARCOAT_NORMALS) || defined(LIT_GGX_SPECULAR)\n\t\t\t\tdTangentW = vTangentW;\n\t\t\t\tdBinormalW = vBinormalW;\n\t\t\t#endif\n\t\t#endif\n\t\tgetViewDir();\n\t\t#ifdef LIT_TBN\n\t\t\tgetTBN(dTangentW, dBinormalW, dVertexNormalW);\n\t\t\t#ifdef LIT_TWO_SIDED_LIGHTING\n\t\t\t\thandleTwoSidedLighting();\n\t\t\t#endif\n\t\t#endif\n\t#endif\n\tevaluateFrontend();\n\t#include "debugProcessFrontendPS"\n\tvar output: FragmentOutput = evaluateBackend();\n\t#include "litUserMainEndPS"\n\treturn output;\n}\n',litForwardPostCodePS:'\n#ifdef LIT_NEEDS_NORMAL\n\t#include "cubeMapRotatePS"\n\t#include "cubeMapProjectPS"\n\t#include "envProcPS"\n#endif\n#ifdef LIT_SPECULAR_OR_REFLECTION\n\t#ifdef LIT_METALNESS\n\t\t#include "metalnessModulatePS"\n\t#endif\n\t#if LIT_FRESNEL_MODEL == SCHLICK\n\t\t#include "fresnelSchlickPS"\n\t#endif\n\t#ifdef LIT_IRIDESCENCE\n\t\t#include "iridescenceDiffractionPS"\n\t#endif\n#endif\n#ifdef LIT_AO\n\t#include "aoDiffuseOccPS"\n\t#include "aoSpecOccPS"\n#endif\n#if LIT_REFLECTION_SOURCE == ENVATLASHQ\n\t#include "envAtlasPS"\n\t#include "reflectionEnvHQPS"\n#elif LIT_REFLECTION_SOURCE == ENVATLAS\n\t#include "envAtlasPS"\n\t#include "reflectionEnvPS"\n#elif LIT_REFLECTION_SOURCE == CUBEMAP\n\t#include "reflectionCubePS"\n#elif LIT_REFLECTION_SOURCE == SPHEREMAP\n\t#include "reflectionSpherePS"\n#endif\n#ifdef LIT_REFLECTIONS\n\t#ifdef LIT_CLEARCOAT\n\t\t#include "reflectionCCPS"\n\t#endif\n\t#ifdef LIT_SHEEN\n\t\t#include "reflectionSheenPS"\n\t#endif\n#endif\n#ifdef LIT_REFRACTION\n\t#if defined(LIT_DYNAMIC_REFRACTION)\n\t\t#include "refractionDynamicPS"\n\t#elif defined(LIT_REFLECTIONS)\n\t\t#include "refractionCubePS"\n\t#endif\n#endif\n#ifdef LIT_SHEEN\n\t#include "lightSheenPS"\n#endif\nuniform material_ambient: vec3f;\n#ifdef LIT_SPECULAR\n\t#ifdef LIT_LIGHTING\n\t\t#ifdef LIT_GGX_SPECULAR\n\t\t\t#include "lightSpecularAnisoGGXPS"\n\t\t#else\n\t\t\t#include "lightSpecularBlinnPS"\n\t\t#endif\n\t#endif\n#endif\n#include "combinePS"\n#ifdef LIT_LIGHTMAP\n\t#include "lightmapAddPS"\n#endif\n#ifdef LIT_ADD_AMBIENT\n\t#include "ambientPS"\n#endif\n#ifdef LIT_MSDF\n\t#include "msdfPS"\n#endif\n#ifdef LIT_NEEDS_NORMAL\n\t#include "viewDirPS"\n\t#ifdef LIT_SPECULAR\n\t\t#ifdef LIT_GGX_SPECULAR\n\t\t\t#include "reflDirAnisoPS"\n\t\t#else\n\t\t\t#include "reflDirPS"\n\t\t#endif\n\t#endif\n#endif\n#include "lightingPS"\n',litForwardPreCodePS:'\n#include "basePS"\n#include "sphericalPS"\n#include "decodePS"\n#include "gammaPS"\n#include "tonemappingPS"\n#include "fogPS"\n#if LIT_NONE_SLICE_MODE == SLICED\n\t#include "baseNineSlicedPS"\n#elif LIT_NONE_SLICE_MODE == TILED\n\t#include "baseNineSlicedTiledPS"\n#endif\n#ifdef LIT_TBN\n\t#include "TBNPS"\n\t#ifdef LIT_TWO_SIDED_LIGHTING\n\t\t#include "twoSidedLightingPS"\n\t#endif\n#endif\n',litMainPS:'\n#include "varyingsPS"\n#include "litUserDeclarationPS"\n#include "frontendDeclPS"\n#if defined(PICK_PASS) || defined(PREPASS_PASS)\n\t#include "frontendCodePS"\n\t#include "litUserCodePS"\n\t#include "litOtherMainPS"\n#elif defined(SHADOW_PASS)\n\t#include "frontendCodePS"\n\t#include "litUserCodePS"\n\t#include "litShadowMainPS"\n#else\n\t#include "litForwardDeclarationPS"\n\t#include "litForwardPreCodePS"\n\t#include "frontendCodePS"\n\t#include "litForwardPostCodePS"\n\t#include "litForwardBackendPS"\n\t#include "litUserCodePS"\n\t#include "litForwardMainPS"\n#endif\n',litMainVS:'\n#include "varyingsVS"\n#include  "litUserDeclarationVS"\n#ifdef VERTEX_COLOR\n\tattribute vertex_color: vec4f;\n#endif\n#ifdef NINESLICED\n\tvarying vMask: vec2f;\n\tvarying vTiledUv: vec2f;\n\tvar<private> dMaskGlobal: vec2f;\n\tvar<private> dTiledUvGlobal: vec2f;\n\tuniform innerOffset: vec4f;\n\tuniform outerScale: vec2f;\n\tuniform atlasRect: vec4f;\n#endif\nvar<private> dPositionW: vec3f;\nvar<private> dModelMatrix: mat4x4f;\n#include "transformCoreVS"\n#ifdef UV0\n\tattribute vertex_texCoord0: vec2f;\n\t#include "uv0VS"\n#endif\n#ifdef UV1\n\tattribute vertex_texCoord1: vec2f;\n\t#include "uv1VS"\n#endif\n#ifdef LINEAR_DEPTH\n\t#ifndef VIEWMATRIX\n\t#define VIEWMATRIX\n\t\tuniform matrix_view: mat4x4f;\n\t#endif\n#endif\n#include "transformVS"\n#ifdef NORMALS\n\t#include "normalCoreVS"\n\t#include "normalVS"\n#endif\n#ifdef TANGENTS\n\tattribute vertex_tangent: vec4f;\n#endif\n#include "uvTransformUniformsPS, UV_TRANSFORMS_COUNT"\n#ifdef MSDF\n\t#include "msdfVS"\n#endif\n#include  "litUserCodeVS"\n#ifdef VERTEX_COLOR\n\tfn decodeGamma3(raw: vec3f) -> vec3f {\n\t\treturn pow(raw, vec3f(2.2));\n\t}\n\tfn gammaCorrectInputVec4(color: vec4f) -> vec4f {\n\t\treturn vec4f(decodeGamma3(color.xyz), color.w);\n\t}\n#endif\n@vertex\nfn vertexMain(input : VertexInput) -> VertexOutput {\n\t#include "litUserMainStartVS"\n\tvar output : VertexOutput;\n\toutput.position = getPosition();\n\toutput.vPositionW = getWorldPosition();\n\t#ifdef NORMALS\n\t\toutput.vNormalW = getNormal();\n\t#endif\n\t#ifdef TANGENTS\n\t\toutput.vTangentW = normalize(dNormalMatrix * vertex_tangent.xyz);\n\t\toutput.vBinormalW = cross(output.vNormalW, output.vTangentW) * vertex_tangent.w;\n\t#elif defined(GGX_SPECULAR)\n\t\toutput.vObjectSpaceUpW = normalize(dNormalMatrix * vec3f(0.0, 1.0, 0.0));\n\t#endif\n\t#ifdef UV0\n\t\tvar uv0: vec2f = getUv0();\n\t\t#ifdef UV0_UNMODIFIED\n\t\t\toutput.vUv0 = uv0;\n\t\t#endif\n\t#endif\n\t#ifdef UV1\n\t\tvar uv1: vec2f = getUv1();\n\t\t#ifdef UV1_UNMODIFIED\n\t\t\toutput.vUv1 = uv1;\n\t\t#endif\n\t#endif\n\t#include "uvTransformVS, UV_TRANSFORMS_COUNT"\n\t#ifdef VERTEX_COLOR\n\t\t#ifdef STD_VERTEX_COLOR_GAMMA\n\t\t\toutput.vVertexColor = gammaCorrectInputVec4(vertex_color);\n\t\t#else\n\t\t\toutput.vVertexColor = vertex_color;\n\t\t#endif\n\t#endif\n\t#ifdef LINEAR_DEPTH\n\t\toutput.vLinearDepth = -(uniform.matrix_view * vec4f(output.vPositionW, 1.0)).z;\n\t#endif\n\t#ifdef MSDF\n\t\tunpackMsdfParams();\n\t\toutput.outline_color = dOutlineColor;\n\t\toutput.outline_thickness = dOutlineThickness;\n\t\toutput.shadow_color = dShadowColor;\n\t\toutput.shadow_offset = dShadowOffset;\n\t#endif\n\t#ifdef NINESLICED\n\t\toutput.vMask = dMaskGlobal;\n\t\toutput.vTiledUv = dTiledUvGlobal;\n\t#endif\n\t#include "litUserMainEndVS"\n\treturn output;\n}\n',litOtherMainPS:'\n#ifdef PICK_PASS\n\t#include "pickPS"\n#endif\n#ifdef PREPASS_PASS\n\t#include "floatAsUintPS"\n#endif\n@fragment\nfn fragmentMain(input: FragmentInput) -> FragmentOutput {\n\t#include "litUserMainStartPS"\n\tvar output: FragmentOutput;\n\t\n\tevaluateFrontend();\n\t#ifdef PICK_PASS\n\t\toutput.color = getPickOutput();\n\t\t#ifdef DEPTH_PICK_PASS\n\t\t\toutput.color1 = getPickDepth();\n\t\t#endif\n\t#endif\n\t#ifdef PREPASS_PASS\n\t\toutput.color = float2vec4(vLinearDepth);\n\t#endif\n\t#include "litUserMainEndPS"\n\treturn output;\n}\n',litShaderArgsPS:"\nvar<private> litArgs_albedo: vec3f;\nvar<private> litArgs_opacity: f32;\nvar<private> litArgs_emission: vec3f;\nvar<private> litArgs_worldNormal: vec3f;\nvar<private> litArgs_ao: f32;\nvar<private> litArgs_lightmap: vec3f;\nvar<private> litArgs_lightmapDir: vec3f;\nvar<private> litArgs_metalness: f32;\nvar<private> litArgs_specularity: vec3f;\nvar<private> litArgs_specularityFactor: f32;\nvar<private> litArgs_gloss: f32;\nvar<private> litArgs_sheen_gloss: f32;\nvar<private> litArgs_sheen_specularity: vec3f;\nvar<private> litArgs_transmission: f32;\nvar<private> litArgs_thickness: f32;\nvar<private> litArgs_ior: f32;\nvar<private> litArgs_dispersion: f32;\nvar<private> litArgs_iridescence_intensity: f32;\nvar<private> litArgs_iridescence_thickness: f32;\nvar<private> litArgs_clearcoat_worldNormal: vec3f;\nvar<private> litArgs_clearcoat_specularity: f32;\nvar<private> litArgs_clearcoat_gloss: f32;\n",litShaderCorePS:'\n\t#if LIT_NONE_SLICE_MODE == TILED\n\t\tvar<private> textureBias: f32 = -1000.0;\n\t#else\n\t\tuniform textureBias: f32;\n\t#endif\n\t#include "litShaderArgsPS"\n',litShadowMainPS:'\n#if LIGHT_TYPE != DIRECTIONAL\n\tuniform view_position: vec3f;\n\tuniform light_radius: f32;\n#endif\n#if SHADOW_TYPE == PCSS_32F\n\t#include "linearizeDepthPS"\n#endif\n@fragment\nfn fragmentMain(input: FragmentInput) -> FragmentOutput {\n\t#include "litUserMainStartPS"\n\tvar output: FragmentOutput;\n\tevaluateFrontend();\n\t#ifdef PERSPECTIVE_DEPTH\n\t\tvar depth: f32 = input.position.z;\n\t\t#if SHADOW_TYPE == PCSS_32F\n\t\t\t#if LIGHT_TYPE != DIRECTIONAL\n\t\t\t\tdepth = linearizeDepthWithParams(depth, camera_params);\n\t\t\t#endif\n\t\t#endif\n\t#else\n\t\tvar depth: f32 = min(distance(uniform.view_position, input.vPositionW) / uniform.light_radius, 0.99999);\n\t\t#define MODIFIED_DEPTH\n\t#endif\n\t#if SHADOW_TYPE == VSM_16F || SHADOW_TYPE == VSM_32F\n\t\t#if SHADOW_TYPE == VSM_32F\n\t\t\tvar exponent: f32 = 15.0;\n\t\t#else\n\t\t\tvar exponent: f32 = 5.54;\n\t\t#endif\n\t\tvar depth_vsm = 2.0 * depth - 1.0;\n\t\tdepth_vsm = exp(exponent * depth_vsm);\n\t\toutput.color = vec4f(depth_vsm, depth_vsm * depth_vsm, 1.0, 1.0);\n\t#else\n\t\t#if SHADOW_TYPE == PCSS_32F\n\t\t\toutput.color = vec4f(depth, 0.0, 0.0, 1.0);\n\t\t#else\n\t\t\t#ifdef MODIFIED_DEPTH\n\t\t\t\toutput.fragDepth = depth;\n\t\t\t#endif\n\t\t\toutput.color = vec4f(1.0);\n\t\t#endif\n\t#endif\n\t#include "litUserMainEndPS"\n\t\n\treturn output;\n}\n',litUserDeclarationPS:"",litUserDeclarationVS:"",litUserCodePS:"",litUserCodeVS:"",litUserMainStartPS:"",litUserMainStartVS:"",litUserMainEndPS:"",litUserMainEndVS:"",ltcPS:"\nfn LTC_Uv(N: vec3f, V: vec3f, roughness: f32) -> vec2f {\n\tconst LUT_SIZE: f32 = 64.0;\n\tconst LUT_SCALE: f32 = (LUT_SIZE - 1.0) / LUT_SIZE;\n\tconst LUT_BIAS: f32 = 0.5 / LUT_SIZE;\n\tlet dotNV: f32 = saturate(dot( N, V ));\n\tlet uv: vec2f = vec2f( roughness, sqrt( 1.0 - dotNV ) );\n\treturn uv * LUT_SCALE + LUT_BIAS;\n}\nfn LTC_ClippedSphereFormFactor( f: vec3f ) -> f32 {\n\tlet l: f32 = length( f );\n\treturn max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\n}\nfn LTC_EdgeVectorFormFactor( v1: vec3f, v2: vec3f ) -> vec3f {\n\tlet x: f32 = dot( v1, v2 );\n\tlet y: f32 = abs( x );\n\tlet a: f32 = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;\n\tlet b: f32 = 3.4175940 + ( 4.1616724 + y ) * y;\n\tlet v: f32 = a / b;\n\tlet inv_sqrt_term = inverseSqrt( max( 1.0 - x * x, 1e-7f ) );\n\tlet theta_sintheta: f32 = select( (0.5 * inv_sqrt_term - v), v, x > 0.0 );\n\treturn cross( v1, v2 ) * theta_sintheta;\n}\nstruct Coords {\n\tcoord0: vec3f,\n\tcoord1: vec3f,\n\tcoord2: vec3f,\n\tcoord3: vec3f,\n}\nfn LTC_EvaluateRect( N: vec3f, V: vec3f, P: vec3f, mInv: mat3x3f, rectCoords: Coords) -> f32 {\n\tlet v1: vec3f = rectCoords.coord1 - rectCoords.coord0;\n\tlet v2: vec3f = rectCoords.coord3 - rectCoords.coord0;\n\tlet lightNormal: vec3f = cross( v1, v2 );\n\tlet factor: f32 = sign(-dot( lightNormal, P - rectCoords.coord0 ));\n\tlet T1: vec3f = normalize( V - N * dot( V, N ) );\n\tlet T2: vec3f = factor * cross( N, T1 );\n\tlet mat: mat3x3f = mInv * transpose( mat3x3f( T1, T2, N ) );\n\tvar coords: array<vec3f, 4>;\n\tcoords[0] = mat * ( rectCoords.coord0 - P );\n\tcoords[1] = mat * ( rectCoords.coord1 - P );\n\tcoords[2] = mat * ( rectCoords.coord2 - P );\n\tcoords[3] = mat * ( rectCoords.coord3 - P );\n\tcoords[0] = normalize( coords[0] );\n\tcoords[1] = normalize( coords[1] );\n\tcoords[2] = normalize( coords[2] );\n\tcoords[3] = normalize( coords[3] );\n\tvar vectorFormFactor: vec3f = vec3f( 0.0 );\n\tvectorFormFactor = vectorFormFactor + LTC_EdgeVectorFormFactor( coords[0], coords[1] );\n\tvectorFormFactor = vectorFormFactor + LTC_EdgeVectorFormFactor( coords[1], coords[2] );\n\tvectorFormFactor = vectorFormFactor + LTC_EdgeVectorFormFactor( coords[2], coords[3] );\n\tvectorFormFactor = vectorFormFactor + LTC_EdgeVectorFormFactor( coords[3], coords[0] );\n\tlet result: f32 = LTC_ClippedSphereFormFactor( vectorFormFactor );\n\treturn result;\n}\nvar<private> dLTCCoords: Coords;\nfn getLTCLightCoords(lightPos: vec3f, halfWidth: vec3f, halfHeight: vec3f) -> Coords {\n\tvar coords: Coords;\n\tcoords.coord0 = lightPos + halfWidth - halfHeight;\n\tcoords.coord1 = lightPos - halfWidth - halfHeight;\n\tcoords.coord2 = lightPos - halfWidth + halfHeight;\n\tcoords.coord3 = lightPos + halfWidth + halfHeight;\n\treturn coords;\n}\nvar<private> dSphereRadius: f32;\nfn getSphereLightCoords(lightPos: vec3f, halfWidth: vec3f, halfHeight: vec3f) -> Coords {\n\tdSphereRadius = max(length(halfWidth), length(halfHeight));\n\tlet f: vec3f = reflect(normalize(lightPos - uniform.view_position), vNormalW);\n\tlet w: vec3f = normalize(cross(f, halfHeight));\n\tlet h: vec3f = normalize(cross(f, w));\n\treturn getLTCLightCoords(lightPos, w * dSphereRadius, h * dSphereRadius);\n}\nvar<private> dLTCUV: vec2f;\n#ifdef LIT_CLEARCOAT\n\tvar<private> ccLTCUV: vec2f;\n#endif\nfn getLTCLightUV(gloss: f32, worldNormal: vec3f, viewDir: vec3f) -> vec2f {\n\tlet roughness: f32 = max((1.0 - gloss) * (1.0 - gloss), 0.001);\n\treturn LTC_Uv( worldNormal, viewDir, roughness );\n}\nvar<private> dLTCSpecFres: vec3f;\n#ifdef LIT_CLEARCOAT\n\tvar<private> ccLTCSpecFres: vec3f;\n#endif\nfn getLTCLightSpecFres(uv: vec2f, specularity: vec3f) -> vec3f {\n\tlet t2: vec4f = textureSampleLevel(areaLightsLutTex2, areaLightsLutTex2Sampler, uv, 0.0);\n\treturn specularity * t2.x + ( vec3f( 1.0 ) - specularity) * t2.y;\n}\nfn calcLTCLightValues(gloss: f32, worldNormal: vec3f, viewDir: vec3f, specularity: vec3f, clearcoatGloss: f32, clearcoatWorldNormal: vec3f, clearcoatSpecularity: f32) {\n\tdLTCUV = getLTCLightUV(gloss, worldNormal, viewDir);\n\tdLTCSpecFres = getLTCLightSpecFres(dLTCUV, specularity);\n\t#ifdef LIT_CLEARCOAT\n\t\tccLTCUV = getLTCLightUV(clearcoatGloss, clearcoatWorldNormal, viewDir);\n\t\tccLTCSpecFres = getLTCLightSpecFres(ccLTCUV, vec3f(clearcoatSpecularity));\n\t#endif\n}\nfn calcRectLightValues(lightPos: vec3f, halfWidth: vec3f, halfHeight: vec3f) {\n\tdLTCCoords = getLTCLightCoords(lightPos, halfWidth, halfHeight);\n}\nfn calcDiskLightValues(lightPos: vec3f, halfWidth: vec3f, halfHeight: vec3f) {\n\tcalcRectLightValues(lightPos, halfWidth, halfHeight);\n}\nfn calcSphereLightValues(lightPos: vec3f, halfWidth: vec3f, halfHeight: vec3f) {\n\tdLTCCoords = getSphereLightCoords(lightPos, halfWidth, halfHeight);\n}\nfn SolveCubic(Coefficient_in: vec4f) -> vec3f {\n\tlet pi: f32 = 3.14159;\n\tvar Coefficient = Coefficient_in;\n\tCoefficient = vec4f(Coefficient.xyz / Coefficient.w, Coefficient.w);\n\tlet new_yz: vec2f = Coefficient.yz / 3.0;\n\tCoefficient = vec4f(Coefficient.x, new_yz.x, new_yz.y, Coefficient.w);\n\t\n\tlet A: f32 = Coefficient.w;\n\tlet B: f32 = Coefficient.z;\n\tlet C: f32 = Coefficient.y;\n\tlet D: f32 = Coefficient.x;\n\tlet Delta: vec3f = vec3f(\n\t\t-Coefficient.z * Coefficient.z + Coefficient.y,\n\t\t-Coefficient.y * Coefficient.z + Coefficient.x,\n\t\tdot(vec2f(Coefficient.z, -Coefficient.y), Coefficient.xy)\n\t);\n\tlet Discriminant: f32 = dot(vec2f(4.0 * Delta.x, -Delta.y), Delta.zy);\n\tvar xlc: vec2f;\n\tvar xsc: vec2f;\n\t{\n\t\tlet A_a: f32 = 1.0;\n\t\tlet C_a: f32 = Delta.x;\n\t\tlet D_a: f32 = -2.0 * B * Delta.x + Delta.y;\n\t\tlet Theta: f32 = atan2(sqrt(Discriminant), -D_a) / 3.0;\n\t\tlet sqrt_neg_Ca = sqrt(-C_a);\n\t\tlet x_1a: f32 = 2.0 * sqrt_neg_Ca * cos(Theta);\n\t\tlet x_3a: f32 = 2.0 * sqrt_neg_Ca * cos(Theta + (2.0 / 3.0) * pi);\n\t\tlet xl: f32 = select(x_3a, x_1a, (x_1a + x_3a) > 2.0 * B);\n\t\txlc = vec2f(xl - B, A);\n\t}\n\t{\n\t\tlet A_d: f32 = D;\n\t\tlet C_d: f32 = Delta.z;\n\t\tlet D_d: f32 = -D * Delta.y + 2.0 * C * Delta.z;\n\t\tlet Theta: f32 = atan2(D * sqrt(Discriminant), -D_d) / 3.0;\n\t\tlet sqrt_neg_Cd = sqrt(-C_d);\n\t\tlet x_1d: f32 = 2.0 * sqrt_neg_Cd * cos(Theta);\n\t\tlet x_3d: f32 = 2.0 * sqrt_neg_Cd * cos(Theta + (2.0 / 3.0) * pi);\n\t\tlet xs: f32 = select(x_3d, x_1d, x_1d + x_3d < 2.0 * C);\n\t\txsc = vec2f(-D, xs + C);\n\t}\n\tlet E: f32 =  xlc.y * xsc.y;\n\tlet F: f32 = -xlc.x * xsc.y - xlc.y * xsc.x;\n\tlet G: f32 =  xlc.x * xsc.x;\n\tlet xmc: vec2f = vec2f(C * F - B * G, -B * F + C * E);\n\tvar Root: vec3f = vec3f(xsc.x / xsc.y, xmc.x / xmc.y, xlc.x / xlc.y);\n\tif (Root.x < Root.y && Root.x < Root.z) {\n\t\tRoot = Root.yxz;\n\t} else if (Root.z < Root.x && Root.z < Root.y) {\n\t\tRoot = Root.xzy;\n\t}\n\treturn Root;\n}\nfn LTC_EvaluateDisk(N: vec3f, V: vec3f, P: vec3f, Minv: mat3x3f, points: Coords) -> f32 {\n\tlet T1: vec3f = normalize(V - N * dot(V, N));\n\tlet T2: vec3f = cross(N, T1);\n\tlet R: mat3x3f = transpose( mat3x3f( T1, T2, N ) );\n\tvar L_: array<vec3f, 3>;\n\tL_[0] = R * ( points.coord0 - P );\n\tL_[1] = R * ( points.coord1 - P );\n\tL_[2] = R * ( points.coord2 - P );\n\tlet C: vec3f  = 0.5 * (L_[0] + L_[2]);\n\tvar V1: vec3f = 0.5 * (L_[1] - L_[2]);\n\tvar V2: vec3f = 0.5 * (L_[1] - L_[0]);\n\tlet C_Minv: vec3f  = Minv * C;\n\tlet V1_Minv: vec3f = Minv * V1;\n\tlet V2_Minv: vec3f = Minv * V2;\n\tvar a: f32;\n\tvar b: f32;\n\tlet d11: f32 = dot(V1_Minv, V1_Minv);\n\tlet d22: f32 = dot(V2_Minv, V2_Minv);\n\tlet d12: f32 = dot(V1_Minv, V2_Minv);\n\tif (abs(d12) / sqrt(d11 * d22) > 0.0001) {\n\t\tlet tr: f32 = d11 + d22;\n\t\tlet det_inner: f32 = -d12 * d12 + d11 * d22;\n\t\tlet det: f32 = sqrt(det_inner);\n\t\tlet u: f32 = 0.5 * sqrt(tr - 2.0 * det);\n\t\tlet v: f32 = 0.5 * sqrt(tr + 2.0 * det);\n\t\tlet e_max: f32 = (u + v) * (u + v);\n\t\tlet e_min: f32 = (u - v) * (u - v);\n\t\tvar V1_: vec3f;\n\t\tvar V2_: vec3f;\n\t\tif (d11 > d22) {\n\t\t\tV1_ = d12 * V1_Minv + (e_max - d11) * V2_Minv;\n\t\t\tV2_ = d12 * V1_Minv + (e_min - d11) * V2_Minv;\n\t\t} else {\n\t\t\tV1_ = d12*V2_Minv + (e_max - d22)*V1_Minv;\n\t\t\tV2_ = d12*V2_Minv + (e_min - d22)*V1_Minv;\n\t\t}\n\t\ta = 1.0 / e_max;\n\t\tb = 1.0 / e_min;\n\t\tV1 = normalize(V1_);\n\t\tV2 = normalize(V2_);\n\t} else {\n\t\ta = 1.0 / dot(V1_Minv, V1_Minv);\n\t\tb = 1.0 / dot(V2_Minv, V2_Minv);\n\t\tV1 = V1_Minv * sqrt(a);\n\t\tV2 = V2_Minv * sqrt(b);\n\t}\n\tvar V3: vec3f = normalize(cross(V1, V2));\n\tif (dot(C_Minv, V3) < 0.0) {\n\t\tV3 = V3 * -1.0;\n\t}\n\tlet L: f32  = dot(V3, C_Minv);\n\tlet x0: f32 = dot(V1, C_Minv) / L;\n\tlet y0: f32 = dot(V2, C_Minv) / L;\n\tlet E1: f32 = inverseSqrt(a);\n\tlet E2: f32 = inverseSqrt(b);\n\tlet a_scaled = a * L * L;\n\tlet b_scaled = b * L * L;\n\tlet c0: f32 = a_scaled * b_scaled;\n\tlet c1: f32 = a_scaled * b_scaled * (1.0 + x0 * x0 + y0 * y0) - a_scaled - b_scaled;\n\tlet c2: f32 = 1.0 - a_scaled * (1.0 + x0 * x0) - b_scaled * (1.0 + y0 * y0);\n\tlet c3: f32 = 1.0;\n\tlet roots: vec3f = SolveCubic(vec4f(c0, c1, c2, c3));\n\tlet e1: f32 = roots.x;\n\tlet e2: f32 = roots.y;\n\tlet e3: f32 = roots.z;\n\tvar avgDir: vec3f = vec3f(a_scaled * x0 / (a_scaled - e2), b_scaled * y0 / (b_scaled - e2), 1.0);\n\tlet rotate: mat3x3f = mat3x3f(V1, V2, V3);\n\tavgDir = rotate * avgDir;\n\tavgDir = normalize(avgDir);\n\tlet L1: f32 = sqrt(-e2 / e3);\n\tlet L2: f32 = sqrt(-e2 / e1);\n\tlet formFactor: f32 = max(0.0, L1 * L2 * inverseSqrt((1.0 + L1 * L1) * (1.0 + L2 * L2)));\n\tconst LUT_SIZE_disk: f32 = 64.0;\n\tconst LUT_SCALE_disk: f32 = ( LUT_SIZE_disk - 1.0 ) / LUT_SIZE_disk;\n\tconst LUT_BIAS_disk: f32 = 0.5 / LUT_SIZE_disk;\n\tvar uv: vec2f = vec2f(avgDir.z * 0.5 + 0.5, formFactor);\n\tuv = uv * LUT_SCALE_disk + LUT_BIAS_disk;\n\tlet scale: f32 = textureSampleLevel(areaLightsLutTex2, areaLightsLutTex2Sampler, uv, 0.0).w;\n\treturn formFactor * scale;\n}\nfn FixNan(value: f32) -> f32 {\n\treturn select(value, 0.0, value != value);\n}\nfn getRectLightDiffuse(worldNormal: vec3f, viewDir: vec3f, lightDir: vec3f, lightDirNorm: vec3f) -> f32 {\n\tlet identityMat = mat3x3f(vec3f(1.0, 0.0, 0.0), vec3f(0.0, 1.0, 0.0), vec3f(0.0, 0.0, 1.0));\n\treturn LTC_EvaluateRect( worldNormal, viewDir, vPositionW, identityMat, dLTCCoords );\n}\nfn getDiskLightDiffuse(worldNormal: vec3f, viewDir: vec3f, lightDir: vec3f, lightDirNorm: vec3f) -> f32 {\n\tlet identityMat = mat3x3f(vec3f(1.0, 0.0, 0.0), vec3f(0.0, 1.0, 0.0), vec3f(0.0, 0.0, 1.0));\n\treturn FixNan(LTC_EvaluateDisk( worldNormal, viewDir, vPositionW, identityMat, dLTCCoords ));\n}\nfn getSphereLightDiffuse(worldNormal: vec3f, viewDir: vec3f, lightDir: vec3f, lightDirNorm: vec3f) -> f32 {\n\tlet falloff: f32 = dSphereRadius / (dot(lightDir, lightDir) + dSphereRadius);\n\treturn FixNan(getLightDiffuse(worldNormal, viewDir, lightDirNorm) * falloff);\n}\nfn getLTCLightInvMat(uv: vec2f) -> mat3x3f {\n\tlet t1: vec4f = textureSampleLevel(areaLightsLutTex1, areaLightsLutTex1Sampler, uv, 0.0);\n\treturn mat3x3f(\n\t\tvec3f( t1.x, 0.0, t1.y ),\n\t\tvec3f( 0.0, 1.0, 0.0 ),\n\t\tvec3f( t1.z, 0.0, t1.w )\n\t);\n}\nfn calcRectLightSpecular(worldNormal: vec3f, viewDir: vec3f, uv: vec2f) -> f32 {\n\tlet mInv: mat3x3f = getLTCLightInvMat(uv);\n\treturn LTC_EvaluateRect( worldNormal, viewDir, vPositionW, mInv, dLTCCoords );\n}\nfn getRectLightSpecular(worldNormal: vec3f, viewDir: vec3f) -> f32 {\n\treturn calcRectLightSpecular(worldNormal, viewDir, dLTCUV);\n}\nfn calcDiskLightSpecular(worldNormal: vec3f, viewDir: vec3f, uv: vec2f) -> f32 {\n\tlet mInv: mat3x3f = getLTCLightInvMat(uv);\n\treturn LTC_EvaluateDisk( worldNormal, viewDir, vPositionW, mInv, dLTCCoords );\n}\nfn getDiskLightSpecular(worldNormal: vec3f, viewDir: vec3f) -> f32 {\n\treturn calcDiskLightSpecular(worldNormal, viewDir, dLTCUV);\n}\nfn getSphereLightSpecular(worldNormal: vec3f, viewDir: vec3f) -> f32 {\n\treturn calcDiskLightSpecular(worldNormal, viewDir, dLTCUV);\n}\n",metalnessPS:"\n#ifdef STD_METALNESS_CONSTANT\nuniform material_metalness: f32;\n#endif\nfn getMetalness() {\n\tvar metalness: f32 = 1.0;\n\t#ifdef STD_METALNESS_CONSTANT\n\t\tmetalness = metalness * uniform.material_metalness;\n\t#endif\n\t#ifdef STD_METALNESS_TEXTURE\n\t\tmetalness = metalness * textureSampleBias({STD_METALNESS_TEXTURE_NAME}, {STD_METALNESS_TEXTURE_NAME}Sampler, {STD_METALNESS_TEXTURE_UV}, uniform.textureBias).{STD_METALNESS_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_METALNESS_VERTEX\n\tmetalness = metalness * saturate(vVertexColor.{STD_METALNESS_VERTEX_CHANNEL});\n\t#endif\n\tdMetalness = metalness;\n}\n",metalnessModulatePS:"\nfn getSpecularModulate(specularity: vec3f, albedo: vec3f, metalness: f32, f0: f32) -> vec3f {\n\tlet dielectricF0: vec3f = f0 * specularity;\n\treturn mix(dielectricF0, albedo, metalness);\n}\nfn getAlbedoModulate(albedo: vec3f, metalness: f32) -> vec3f {\n\treturn albedo * (1.0 - metalness);\n}\n",morphPS:"\n\tvarying uv0: vec2f;\n\tvar morphTexture: texture_2d_array<f32>;\n\tuniform morphFactor: array<f32, {MORPH_TEXTURE_MAX_COUNT}>;\n\tuniform morphIndex: array<u32, {MORPH_TEXTURE_MAX_COUNT}>;\n\tuniform count: u32;\n\t@fragment\n\tfn fragmentMain(input : FragmentInput) -> FragmentOutput {\n\t\tvar color = vec3f(0, 0, 0);\n\t\tlet textureDims = textureDimensions(morphTexture);\n\t\tlet pixelCoords = vec2i(input.uv0 * vec2f(textureDims));\n\t\t\n\t\tfor (var i: u32 = 0; i < uniform.count; i = i + 1) {\n\t\t\tvar textureIndex: u32 = uniform.morphIndex[i].element;\n\t\t\tvar delta = textureLoad(morphTexture, pixelCoords, textureIndex, 0).xyz;\n\t\t\tcolor += uniform.morphFactor[i].element * delta;\n\t\t}\n\t\tvar output: FragmentOutput;\n\t\toutput.color = vec4f(color, 1.0);\n\t\treturn output;\n\t}\n",morphVS:"\n\tattribute vertex_position: vec2f;\n\tvarying uv0: vec2f;\n\t@vertex\n\tfn vertexMain(input: VertexInput) -> VertexOutput {\n\t\tvar output: VertexOutput;\n\t\toutput.position = vec4f(input.vertex_position, 0.5, 1.0);\n\t\toutput.uv0 = input.vertex_position * 0.5 + vec2f(0.5, 0.5);\n\t\treturn output;\n\t}\n",msdfPS:"\nvar texture_msdfMap: texture_2d<f32>;\nvar texture_msdfMapSampler: sampler;\nfn median(r: f32, g: f32, b: f32) -> f32 {\n\treturn max(min(r, g), min(max(r, g), b));\n}\nfn map(min: f32, max: f32, v: f32) -> f32 {\n\treturn (v - min) / (max - min);\n}\nuniform font_sdfIntensity: f32;\nuniform font_pxrange: f32;\nuniform font_textureWidth: f32;\n#ifndef LIT_MSDF_TEXT_ATTRIBUTE\n\tuniform outline_color: vec4f;\n\tuniform outline_thickness: f32;\n\tuniform shadow_color: vec4f;\n\tuniform shadow_offset: vec2f;\n#else\n\tvarying outline_color: vec4f;\n\tvarying outline_thickness: f32;\n\tvarying shadow_color: vec4f;\n\tvarying shadow_offset: vec2f;\n#endif\nfn applyMsdf(color_in: vec4f) -> vec4f {\n\t#ifndef LIT_MSDF_TEXT_ATTRIBUTE\n\t\tvar outline_colorValue = uniform.outline_color;\n\t\tvar outline_thicknessValue = uniform.outline_thickness;\n\t\tvar shadow_colorValue = uniform.shadow_color;\n\t\tvar shadow_offsetValue = uniform.shadow_offset;\n\t#else\n\t\tvar outline_colorValue = outline_color;\n\t\tvar outline_thicknessValue = outline_thickness;\n\t\tvar shadow_colorValue = shadow_color;\n\t\tvar shadow_offsetValue = shadow_offset;\n\t#endif\n\tvar color = vec4f(gammaCorrectInputVec3(color_in.rgb), color_in.a);\n\tlet tsample: vec3f = textureSample(texture_msdfMap, texture_msdfMapSampler, vUv0).rgb;\n\tlet uvShdw: vec2f = vUv0 - shadow_offsetValue;\n\tlet ssample: vec3f = textureSample(texture_msdfMap, texture_msdfMapSampler, uvShdw).rgb;\n\tlet sigDist: f32 = median(tsample.r, tsample.g, tsample.b);\n\tvar sigDistShdw: f32 = median(ssample.r, ssample.g, ssample.b);\n\tlet smoothingMax: f32 = 0.2;\n\tlet w: vec2f = abs(dpdx(vUv0)) + abs(dpdy(vUv0));\n\tlet smoothing: f32 = clamp(w.x * uniform.font_textureWidth / uniform.font_pxrange, 0.0, smoothingMax);\n\tlet mapMin: f32 = 0.05;\n\tlet mapMax: f32 = clamp(1.0 - uniform.font_sdfIntensity, mapMin, 1.0);\n\tlet sigDistInner: f32 = map(mapMin, mapMax, sigDist);\n\tlet sigDistOutline: f32 = map(mapMin, mapMax, sigDist + outline_thicknessValue);\n\tsigDistShdw = map(mapMin, mapMax, sigDistShdw + outline_thicknessValue);\n\tlet center: f32 = 0.5;\n\tlet inside: f32 = smoothstep(center - smoothing, center + smoothing, sigDistInner);\n\tlet outline: f32 = smoothstep(center - smoothing, center + smoothing, sigDistOutline);\n\tlet shadow: f32 = smoothstep(center - smoothing, center + smoothing, sigDistShdw);\n\tlet tcolor_outline: vec4f = outline * vec4f(outline_colorValue.a * outline_colorValue.rgb, outline_colorValue.a);\n\tvar tcolor: vec4f = select(vec4f(0.0), tcolor_outline, outline > inside);\n\ttcolor = mix(tcolor, color, inside);\n\tlet scolor_shadow: vec4f = shadow * vec4f(shadow_colorValue.a * shadow_colorValue.rgb, shadow_colorValue.a);\n\tlet scolor: vec4f = select(tcolor, scolor_shadow, shadow > outline);\n\ttcolor = mix(scolor, tcolor, outline);\n\ttcolor = vec4f(gammaCorrectOutput(tcolor.rgb), tcolor.a);\n\treturn tcolor;\n}\n",msdfVS:"\nattribute vertex_outlineParameters: vec3f;\nattribute vertex_shadowParameters: vec3f;\nvarying outline_color: vec4f;\nvarying outline_thickness: f32;\nvarying shadow_color: vec4f;\nvarying shadow_offset: vec2f;\nvar<private> dOutlineColor: vec4f;\nvar<private> dOutlineThickness: f32;\nvar<private> dShadowColor: vec4f;\nvar<private> dShadowOffset: vec2f;\nfn unpackMsdfParams() {\n\tlet little: vec3f = vertex_outlineParameters % vec3f(256.0);\n\tlet big: vec3f = (vertex_outlineParameters - little) / 256.0;\n\tdOutlineColor = vec4f(little.x, big.x, little.y, big.y) / 255.0;\n\tdOutlineThickness = little.z / 255.0 * 0.2;\n\tlet little_shadow = vertex_shadowParameters % vec3f(256.0);\n\tlet big_shadow = (vertex_shadowParameters - little_shadow) / 256.0;\n\tdShadowColor = vec4f(little_shadow.x, big_shadow.x, little_shadow.y, big_shadow.y) / 255.0;\n\tdShadowOffset = (vec2f(little_shadow.z, big_shadow.z) / 127.0 - 1.0) * 0.005;\n}\n",normalVS:"\nvar<private> dNormalMatrix: mat3x3f;\nfn getNormal() -> vec3f {\n\tdNormalMatrix = getNormalMatrix(dModelMatrix);\n\tlet localNormal: vec3f = getLocalNormal(vertex_normal);\n\treturn normalize(dNormalMatrix * localNormal);\n}",normalCoreVS:"\nattribute vertex_normal: vec3f;\nuniform matrix_normal: mat3x3f;\n#ifdef MORPHING_NORMAL\n\t#ifdef MORPHING_INT\n\t\tvar morphNormalTex: texture_2d<u32>;\n\t\tvar morphNormalTexSampler: sampler;\n\t#else\n\t\tvar morphNormalTex: texture_2d<f32>;\n\t\tvar morphNormalTexSampler: sampler;\n\t#endif\n#endif\nfn getLocalNormal(vertexNormal: vec3f) -> vec3f {\n\tvar localNormal: vec3f = vertexNormal;\n\t#ifdef MORPHING_NORMAL\n\t\tlet morphUV: vec2i = getTextureMorphCoords();\n\t\t#ifdef MORPHING_INT\n\t\t\tlet morphNormalInt: vec4u = textureLoad(morphNormalTex, morphUV, 0);\n\t\t\tlet morphNormalF: vec3f = vec3f(morphNormalInt.xyz) / 65535.0 * 2.0 - 1.0;\n\t\t\tlocalNormal = localNormal + morphNormalF;\n\t\t#else\n\t\t\tlet morphNormal: vec3f = textureLoad(morphNormalTex, morphUV, 0).xyz;\n\t\t\tlocalNormal = localNormal + morphNormal;\n\t\t#endif\n\t#endif\n\treturn localNormal;\n}\n#if defined(SKIN) || defined(BATCH)\n\tfn getNormalMatrix(modelMatrix: mat4x4f) -> mat3x3f {\n\t\treturn mat3x3f(modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz);\n\t}\n#elif defined(INSTANCING)\n\tfn getNormalMatrix(modelMatrix: mat4x4f) -> mat3x3f {\n\t\treturn mat3x3f(modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz);\n\t}\n#else\n\tfn getNormalMatrix(modelMatrix: mat4x4f) -> mat3x3f {\n\t\treturn uniform.matrix_normal;\n\t}\n#endif\n",normalMapPS:"\n#ifdef STD_NORMAL_TEXTURE\n\tuniform material_bumpiness: f32;\n#endif\n#ifdef STD_NORMALDETAIL_TEXTURE\n\tuniform material_normalDetailMapBumpiness: f32;\n\tfn blendNormals(inN1: vec3f, inN2: vec3f) -> vec3f {\n\t\tlet n1: vec3f = inN1 + vec3f(0.0, 0.0, 1.0);\n\t\tlet n2: vec3f = inN2 * vec3f(-1.0, -1.0, 1.0);\n\t\treturn n1 * dot(n1, n2) / n1.z - n2;\n\t}\n#endif\nfn getNormal() {\n#ifdef STD_NORMAL_TEXTURE\n\tvar normalMap: vec3f = {STD_NORMAL_TEXTURE_DECODE}(textureSampleBias({STD_NORMAL_TEXTURE_NAME}, {STD_NORMAL_TEXTURE_NAME}Sampler, {STD_NORMAL_TEXTURE_UV}, uniform.textureBias));\n\tnormalMap = mix(vec3f(0.0, 0.0, 1.0), normalMap, uniform.material_bumpiness);\n\t#ifdef STD_NORMALDETAIL_TEXTURE\n\t\tvar normalDetailMap: vec3f = {STD_NORMALDETAIL_TEXTURE_DECODE}(textureSampleBias({STD_NORMALDETAIL_TEXTURE_NAME}, {STD_NORMALDETAIL_TEXTURE_NAME}Sampler, {STD_NORMALDETAIL_TEXTURE_UV}, uniform.textureBias));\n\t\tnormalDetailMap = mix(vec3f(0.0, 0.0, 1.0), normalDetailMap, uniform.material_normalDetailMapBumpiness);\n\t\tnormalMap = blendNormals(normalMap, normalDetailMap);\n\t#endif\n\tdNormalW = normalize(dTBN * normalMap);\n#else\n\tdNormalW = dVertexNormalW;\n#endif\n}\n",opacityPS:"\nuniform material_opacity: f32;\nfn getOpacity() {\n\tdAlpha = uniform.material_opacity;\n\t#ifdef STD_OPACITY_TEXTURE\n\tdAlpha = dAlpha * textureSampleBias({STD_OPACITY_TEXTURE_NAME}, {STD_OPACITY_TEXTURE_NAME}Sampler, {STD_OPACITY_TEXTURE_UV}, uniform.textureBias).{STD_OPACITY_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_OPACITY_VERTEX\n\tdAlpha = dAlpha * clamp(vVertexColor.{STD_OPACITY_VERTEX_CHANNEL}, 0.0, 1.0);\n\t#endif\n}\n",opacityDitherPS:'\n#if STD_OPACITY_DITHER == BAYER8\n\t#include "bayerPS"\n#endif\nuniform blueNoiseJitter: vec4f;\n#if STD_OPACITY_DITHER == BLUENOISE\n\tvar blueNoiseTex32 : texture_2d<f32>;\n\tvar blueNoiseTex32Sampler : sampler;\n#endif\nfn opacityDither(alpha: f32, id: f32) {\n\t#if STD_OPACITY_DITHER == BAYER8\n\t\tvar noise: f32 = bayer8(floor((pcPosition.xy + uniform.blueNoiseJitter.xy + id) % vec2f(8.0))) / 64.0;\n\t#else\n\t\t#if STD_OPACITY_DITHER == BLUENOISE\n\t\t\tvar uv = fract(pcPosition.xy / 32.0 + uniform.blueNoiseJitter.xy + id);\n\t\t\tvar noise: f32 = textureSampleLevel(blueNoiseTex32, blueNoiseTex32Sampler, uv, 0.0).y;\n\t\t#endif\n\t\t#if STD_OPACITY_DITHER == IGNNOISE\n\t\t\tvar magic = vec3f(0.06711056, 0.00583715, 52.9829189);\n\t\t\tvar noise: f32 = fract(magic.z * fract(dot(pcPosition.xy + uniform.blueNoiseJitter.xy + id, magic.xy)));\n\t\t#endif\n\t#endif\n\tnoise = pow(noise, 2.2);\n\tif (alpha < noise) {\n\t\tdiscard;\n\t}\n}\n',outputPS:"\n",outputAlphaPS:"\n#if LIT_BLEND_TYPE == NORMAL || LIT_BLEND_TYPE == ADDITIVEALPHA || defined(LIT_ALPHA_TO_COVERAGE)\n\toutput.color = vec4f(output.color.rgb, litArgs_opacity);\n#elif LIT_BLEND_TYPE == PREMULTIPLIED\n\toutput.color = vec4f(output.color.rgb * litArgs_opacity, litArgs_opacity);\n#else\n\toutput.color = vec4f(output.color.rgb, 1.0);\n#endif\n",packHalfPS:"\n#if defined(PLATFORM_ANDROID)\n\tfn floatToHalf(a: f32) -> u32 {\n\t\tlet u: u32\t= bitcast<u32>(a);\n\t\tlet sign: u32 = (u >> 16u) & 0x8000u;\n\t\tlet absu: u32 = u & 0x7FFFFFFFu;\n\t\tlet man: u32  = u & 0x007FFFFFu;\n\t\tlet e32: i32  = i32((u >> 23u) & 0xFFu) - 127;\n\t\t\n\t\tif ((absu & 0x7F800000u) == 0x7F800000u) {\n\t\t\tlet isnan = (man != 0u);\n\t\t\treturn sign | select(0x7C00u, 0x7E00u, isnan);\n\t\t}\n\t\t\n\t\tif (e32 > 15) { return sign | 0x7C00u; }\n\t\t\n\t\tif (e32 >= -14) {\n\t\t\tvar he: u32 = u32(e32 + 15);\n\t\t\tvar hm: u32 = man >> 13u;\n\t\t\tlet rem: u32 = man & 0x1FFFu;\n\t\t\tlet add: u32 = select(0u, 1u, (rem > 0x1000u) || (rem == 0x1000u && (hm & 1u) == 1u));\n\t\t\thm = (hm + add) & 0x3FFu;\n\t\t\tif ((hm & 0x400u) != 0u) {\n\t\t\t\thm = 0u; he = he + 1u;\n\t\t\t\tif (he >= 31u) { return sign | 0x7C00u; }\n\t\t\t}\n\t\t\treturn sign | (he << 10u) | hm;\n\t\t}\n\t\t\n\t\tif (e32 >= -24) {\n\t\t\tlet s: u32\t  = u32(-(e32 + 1));\n\t\t\tlet mnorm: u32  = 0x00800000u | man;\n\t\t\tvar hm: u32\t = mnorm >> s;\n\t\t\tlet mask: u32   = (1u << s) - 1u;\n\t\t\tlet rem: u32\t= mnorm & mask;\n\t\t\tlet halfBt: u32 = 1u << (s - 1u);\n\t\t\tlet add: u32\t= select(0u, 1u, (rem > halfBt) || (rem == halfBt && (hm & 1u) == 1u));\n\t\t\thm = hm + add;\n\t\t\tif (hm >= 0x400u) { return sign | (1u << 10u); }\n\t\t\treturn sign | hm;\n\t\t}\n\t\t\n\t\treturn sign;\n\t}\n\tfn pack2x16floatSafe(v: vec2f) -> u32 {\n\t\tlet u_x: u32  = bitcast<u32>(v.x);\n\t\tlet u_y: u32  = bitcast<u32>(v.y);\n\t\t\n\t\tlet e32_x: i32 = i32((u_x >> 23u) & 0xFFu) - 127;\n\t\tlet e32_y: i32 = i32((u_y >> 23u) & 0xFFu) - 127;\n\t\t\n\t\tif (e32_x < -14 || e32_y < -14) {\n\t\t\treturn (floatToHalf(v.y) << 16u) | floatToHalf(v.x);\n\t\t}\n\t\t\n\t\treturn pack2x16float(v);\n\t}\n#else\n\tfn pack2x16floatSafe(v: vec2f) -> u32 {\n\t\treturn pack2x16float(v);\n\t}\n#endif\n",outputTex2DPS:"\nvarying vUv0: vec2f;\nvar source: texture_2d<f32>;\nvar sourceSampler: sampler;\n@fragment fn fragmentMain(input : FragmentInput) -> FragmentOutput {\n\tvar output: FragmentOutput;\n\toutput.color = textureSample(source, sourceSampler, input.vUv0);\n\treturn output;\n}\n",sheenPS:"\nuniform material_sheen: vec3f;\nfn getSheen() {\n\tvar sheenColor = uniform.material_sheen;\n\t#ifdef STD_SHEEN_TEXTURE\n\tsheenColor = sheenColor * {STD_SHEEN_TEXTURE_DECODE}(textureSampleBias({STD_SHEEN_TEXTURE_NAME}, {STD_SHEEN_TEXTURE_NAME}Sampler, {STD_SHEEN_TEXTURE_UV}, uniform.textureBias)).{STD_SHEEN_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_SHEEN_VERTEX\n\tsheenColor = sheenColor * saturate3(vVertexColor.{STD_SHEEN_VERTEX_CHANNEL});\n\t#endif\n\tsSpecularity = sheenColor;\n}\n",sheenGlossPS:"\nuniform material_sheenGloss: f32;\nfn getSheenGlossiness() {\n\tvar sheenGlossiness = uniform.material_sheenGloss;\n\t#ifdef STD_SHEENGLOSS_TEXTURE\n\tsheenGlossiness = sheenGlossiness * textureSampleBias({STD_SHEENGLOSS_TEXTURE_NAME}, {STD_SHEENGLOSS_TEXTURE_NAME}Sampler, {STD_SHEENGLOSS_TEXTURE_UV}, uniform.textureBias).{STD_SHEENGLOSS_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_SHEENGLOSS_VERTEX\n\tsheenGlossiness = sheenGlossiness * saturate(vVertexColor.{STD_SHEENGLOSS_VERTEX_CHANNEL});\n\t#endif\n\t#ifdef STD_SHEENGLOSS_INVERT\n\tsheenGlossiness = 1.0 - sheenGlossiness;\n\t#endif\n\tsGlossiness = sheenGlossiness + 0.0000001;\n}\n",parallaxPS:"\nuniform material_heightMapFactor: f32;\nfn getParallax() {\n\tvar parallaxScale = uniform.material_heightMapFactor;\n\tvar height: f32 = textureSampleBias({STD_HEIGHT_TEXTURE_NAME}, {STD_HEIGHT_TEXTURE_NAME}Sampler, {STD_HEIGHT_TEXTURE_UV}, uniform.textureBias).{STD_HEIGHT_TEXTURE_CHANNEL};\n\theight = height * parallaxScale - parallaxScale * 0.5;\n\tvar viewDirT: vec3f = dViewDirW * dTBN;\n\tviewDirT.z = viewDirT.z + 0.42;\n\tdUvOffset = height * (viewDirT.xy / viewDirT.z);\n}\n",pickPS:'\nuniform meshInstanceId: u32;\nfn getPickOutput() -> vec4f {\n\tlet inv: vec4f = vec4f(1.0 / 255.0);\n\tlet shifts: vec4u = vec4u(16u, 8u, 0u, 24u);\n\tlet col: vec4u = (vec4u(uniform.meshInstanceId) >> shifts) & vec4u(0xffu);\n\treturn vec4f(col) * inv;\n}\n#ifdef DEPTH_PICK_PASS\n\t#include "floatAsUintPS"\n\tfn getPickDepth() -> vec4f {\n\t\treturn float2uint(pcPosition.z);\n\t}\n#endif\n',reflDirPS:"\nfn getReflDir(worldNormal: vec3f, viewDir: vec3f, gloss: f32, tbn: mat3x3f) {\n\tdReflDirW = normalize(-reflect(viewDir, worldNormal));\n}\n",reflDirAnisoPS:"\nfn getReflDir(worldNormal: vec3f, viewDir: vec3f, gloss: f32, tbn: mat3x3f) {\n\tlet roughness: f32 = sqrt(1.0 - min(gloss, 1.0));\n\tlet direction: vec2f = dAnisotropyRotation;\n\tlet anisotropicT: vec3f = normalize(tbn * vec3f(direction, 0.0));\n\tlet anisotropicB: vec3f = normalize(cross(tbn[2], anisotropicT));\n\tlet anisotropy: f32 = dAnisotropy;\n\tlet anisotropicDirection: vec3f = anisotropicB;\n\tlet anisotropicTangent: vec3f = cross(anisotropicDirection, viewDir);\n\tlet anisotropicNormal: vec3f = cross(anisotropicTangent, anisotropicDirection);\n\tlet bendFactor: f32 = 1.0 - anisotropy * (1.0 - roughness);\n\tlet bendFactor4: f32 = bendFactor * bendFactor * bendFactor * bendFactor;\n\tlet bentNormal: vec3f = normalize(mix(normalize(anisotropicNormal), normalize(worldNormal), bendFactor4));\n\tdReflDirW = reflect(-viewDir, bentNormal);\n}",reflectionCCPS:"\n#ifdef LIT_CLEARCOAT\nfn addReflectionCC(reflDir: vec3f, gloss: f32) {\n\tccReflection = ccReflection + calcReflection(reflDir, gloss);\n}\n#endif\n",reflectionCubePS:"\nvar texture_cubeMap: texture_cube<f32>;\nvar texture_cubeMapSampler: sampler;\nuniform material_reflectivity: f32;\nfn calcReflection(reflDir: vec3f, gloss: f32) -> vec3f {\n\tvar lookupVec: vec3f = cubeMapProject(reflDir);\n\tlookupVec.x = lookupVec.x * -1.0;\n\treturn {reflectionDecode}(textureSample(texture_cubeMap, texture_cubeMapSampler, lookupVec));\n}\nfn addReflection(reflDir: vec3f, gloss: f32) {\n\tdReflection = dReflection + vec4f(calcReflection(reflDir, gloss), uniform.material_reflectivity);\n}\n",reflectionEnvHQPS:"\n#ifndef ENV_ATLAS\n\t#define ENV_ATLAS\n\tvar texture_envAtlas: texture_2d<f32>;\n\tvar texture_envAtlasSampler: sampler;\n#endif\nvar texture_cubeMap: texture_cube<f32>;\nvar texture_cubeMapSampler: sampler;\nuniform material_reflectivity: f32;\nfn calcReflection(reflDir: vec3f, gloss: f32) -> vec3f {\n\tlet dir: vec3f = cubeMapProject(reflDir) * vec3f(-1.0, 1.0, 1.0);\n\tlet uv: vec2f = toSphericalUv(dir);\n\tlet level: f32 = saturate(1.0 - gloss) * 5.0;\n\tlet ilevel: f32 = floor(level);\n\tlet flevel: f32 = level - ilevel;\n\tlet sharp: vec3f = {reflectionCubemapDecode}(textureSample(texture_cubeMap, texture_cubeMapSampler, dir));\n\tlet roughA: vec3f = {reflectionDecode}(textureSample(texture_envAtlas, texture_envAtlasSampler, mapRoughnessUv(uv, ilevel)));\n\tlet roughB: vec3f = {reflectionDecode}(textureSample(texture_envAtlas, texture_envAtlasSampler, mapRoughnessUv(uv, ilevel + 1.0)));\n\treturn processEnvironment(mix(sharp, mix(roughA, roughB, flevel), min(level, 1.0)));\n}\nfn addReflection(reflDir: vec3f, gloss: f32) {\n\tdReflection = dReflection + vec4f(calcReflection(reflDir, gloss), uniform.material_reflectivity);\n}\n",reflectionEnvPS:"\n#ifndef ENV_ATLAS\n#define ENV_ATLAS\n\tvar texture_envAtlas: texture_2d<f32>;\n\tvar texture_envAtlasSampler: sampler;\n#endif\nuniform material_reflectivity: f32;\nfn shinyMipLevel(uv: vec2f) -> f32 {\n\tlet dx: vec2f = dpdx(uv);\n\tlet dy: vec2f = dpdy(uv);\n\tlet uv2: vec2f = vec2f(fract(uv.x + 0.5), uv.y);\n\tlet dx2: vec2f = dpdx(uv2);\n\tlet dy2: vec2f = dpdy(uv2);\n\tlet maxd: f32 = min(max(dot(dx, dx), dot(dy, dy)), max(dot(dx2, dx2), dot(dy2, dy2)));\n\treturn clamp(0.5 * log2(maxd) - 1.0 + uniform.textureBias, 0.0, 5.0);\n}\nfn calcReflection(reflDir: vec3f, gloss: f32) -> vec3f {\n\tlet dir: vec3f = cubeMapProject(reflDir) * vec3f(-1.0, 1.0, 1.0);\n\tlet uv: vec2f = toSphericalUv(dir);\n\tlet level: f32 = saturate(1.0 - gloss) * 5.0;\n\tlet ilevel: f32 = floor(level);\n\tlet level2: f32 = shinyMipLevel(uv * atlasSize);\n\tlet ilevel2: f32 = floor(level2);\n\tvar uv0: vec2f;\n\tvar uv1: vec2f;\n\tvar weight: f32;\n\tif (ilevel == 0.0) {\n\t\tuv0 = mapShinyUv(uv, ilevel2);\n\t\tuv1 = mapShinyUv(uv, ilevel2 + 1.0);\n\t\tweight = level2 - ilevel2;\n\t} else {\n\t\tuv0 = mapRoughnessUv(uv, ilevel);\n\t\tuv1 = uv0;\n\t\tweight = 0.0;\n\t}\n\tlet linearA: vec3f = {reflectionDecode}(textureSample(texture_envAtlas, texture_envAtlasSampler, uv0));\n\tlet linearB: vec3f = {reflectionDecode}(textureSample(texture_envAtlas, texture_envAtlasSampler, uv1));\n\tlet linear0: vec3f = mix(linearA, linearB, weight);\n\tlet linear1: vec3f = {reflectionDecode}(textureSample(texture_envAtlas, texture_envAtlasSampler, mapRoughnessUv(uv, ilevel + 1.0)));\n\treturn processEnvironment(mix(linear0, linear1, level - ilevel));\n}\nfn addReflection(reflDir: vec3f, gloss: f32) {\n\tdReflection = dReflection + vec4f(calcReflection(reflDir, gloss), uniform.material_reflectivity);\n}\n",reflectionSpherePS:"\n#ifndef VIEWMATRIX\n\t#define VIEWMATRIX\n\tuniform matrix_view: mat4x4f;\n#endif\nvar texture_sphereMap: texture_2d<f32>;\nvar texture_sphereMapSampler: sampler;\nuniform material_reflectivity: f32;\nfn calcReflection(reflDir: vec3f, gloss: f32) -> vec3f {\n\tlet viewRotationMatrix = mat3x3f(uniform.matrix_view[0].xyz, uniform.matrix_view[1].xyz, uniform.matrix_view[2].xyz);\n\tlet reflDirV: vec3f = viewRotationMatrix * reflDir;\n\tlet m: f32 = 2.0 * sqrt(dot(reflDirV.xy, reflDirV.xy) + (reflDirV.z + 1.0) * (reflDirV.z + 1.0));\n\tlet sphereMapUv: vec2f = reflDirV.xy / m + 0.5;\n\treturn {reflectionDecode}(textureSample(texture_sphereMap, texture_sphereMapSampler, sphereMapUv));\n}\nfn addReflection(reflDir: vec3f, gloss: f32) {\n\tdReflection = dReflection + vec4f(calcReflection(reflDir, gloss), uniform.material_reflectivity);\n}\n",reflectionSheenPS:"\nfn addReflectionSheen(worldNormal: vec3f, viewDir: vec3f, gloss: f32) {\n\tlet NoV: f32 = dot(worldNormal, viewDir);\n\tlet alphaG: f32 = gloss * gloss;\n\tlet a: f32 = select(\n\t\t-8.48 * alphaG + 14.3 * gloss - 9.95,\n\t\t-339.2 * alphaG + 161.4 * gloss - 25.9,\n\t\tgloss < 0.25\n\t);\n\tlet b: f32 = select(\n\t\t1.97 * alphaG - 3.27 * gloss + 0.72,\n\t\t44.0 * alphaG - 23.7 * gloss + 3.26,\n\t\tgloss < 0.25\n\t);\n\tlet dg_add: f32 = select(\n\t\t0.1 * ( gloss - 0.25 ),\n\t\t0.0,\n\t\tgloss < 0.25\n\t);\n\tlet dg: f32 = exp( a * NoV + b ) + dg_add;\n\tsReflection = sReflection + (calcReflection(worldNormal, 0.0) * saturate(dg));\n}",refractionCubePS:"\nfn refract2(viewVec: vec3f, normal: vec3f, IOR: f32) -> vec3f {\n\tlet vn: f32 = dot(viewVec, normal);\n\tlet k: f32 = 1.0 - IOR * IOR * (1.0 - vn * vn);\n\tlet refrVec: vec3f = IOR * viewVec - (IOR * vn + sqrt(k)) * normal;\n\treturn refrVec;\n}\nfn addRefraction(\n\tworldNormal: vec3f,\n\tviewDir: vec3f,\n\tthickness: f32,\n\tgloss: f32,\n\tspecularity: vec3f,\n\talbedo: vec3f,\n\ttransmission: f32,\n\trefractionIndex: f32,\n\tdispersion: f32\n#if defined(LIT_IRIDESCENCE)\n\t, iridescenceFresnel: vec3f,\n\tiridescenceIntensity: f32\n#endif\n) {\n\tlet tmpRefl: vec4f = dReflection;\n\tlet reflectionDir: vec3f = refract2(-viewDir, worldNormal, refractionIndex);\n\tdReflection = vec4f(0.0);\n\taddReflection(reflectionDir, gloss);\n\tdDiffuseLight = mix(dDiffuseLight, dReflection.rgb * albedo, transmission);\n\tdReflection = tmpRefl;\n}\n",refractionDynamicPS:"\nuniform material_invAttenuationDistance: f32;\nuniform material_attenuation: vec3f;\nfn evalRefractionColor(refractionVector: vec3f, gloss: f32, refractionIndex: f32) -> vec3f {\n\tlet pointOfRefraction: vec4f = vec4f(vPositionW + refractionVector, 1.0);\n\tlet projectionPoint: vec4f = uniform.matrix_viewProjection * pointOfRefraction;\n\tlet uv: vec2f = getGrabScreenPos(projectionPoint);\n\tlet iorToRoughness: f32 = (1.0 - gloss) * clamp((1.0 / refractionIndex) * 2.0 - 2.0, 0.0, 1.0);\n\tlet refractionLod: f32 = log2(uniform.uScreenSize.x) * iorToRoughness;\n\tvar refraction: vec3f = textureSampleLevel(uSceneColorMap, uSceneColorMapSampler, uv, refractionLod).rgb;\n\t#ifdef SCENE_COLORMAP_GAMMA\n\t\trefraction = decodeGamma3(refraction);\n\t#endif\n\treturn refraction;\n}\nfn addRefraction(\n\tworldNormal: vec3f,\n\tviewDir: vec3f,\n\tthickness: f32,\n\tgloss: f32,\n\tspecularity: vec3f,\n\talbedo: vec3f,\n\ttransmission: f32,\n\trefractionIndex: f32,\n\tdispersion: f32,\n#if defined(LIT_IRIDESCENCE)\n\tiridescenceFresnel: vec3f,\n\tiridescenceIntensity: f32\n#endif\n) {\n\tvar modelScale: vec3f;\n\tmodelScale.x = length(uniform.matrix_model[0].xyz);\n\tmodelScale.y = length(uniform.matrix_model[1].xyz);\n\tmodelScale.z = length(uniform.matrix_model[2].xyz);\n\tlet scale: vec3f = thickness * modelScale;\n\tvar refractionVector = normalize(refract(-viewDir, worldNormal, refractionIndex)) * scale;\n\tvar refraction = evalRefractionColor(refractionVector, gloss, refractionIndex);\n\t#ifdef LIT_DISPERSION\n\t\tlet halfSpread: f32 = (1.0 / refractionIndex - 1.0) * 0.025 * dispersion;\n\t\tlet refractionIndexR: f32 = refractionIndex - halfSpread;\n\t\trefractionVector = normalize(refract(-viewDir, worldNormal, refractionIndexR)) * scale;\n\t\trefraction.r = evalRefractionColor(refractionVector, gloss, refractionIndexR).r;\n\t\tlet refractionIndexB: f32 = refractionIndex + halfSpread;\n\t\trefractionVector = normalize(refract(-viewDir, worldNormal, refractionIndexB)) * scale;\n\t\trefraction.b = evalRefractionColor(refractionVector, gloss, refractionIndexB).b;\n\t#endif\n\tvar transmittance: vec3f;\n\tif (uniform.material_invAttenuationDistance != 0.0)\n\t{\n\t\tlet attenuation: vec3f = -log(uniform.material_attenuation) * uniform.material_invAttenuationDistance;\n\t\ttransmittance = exp(-attenuation * length(refractionVector));\n\t}\n\telse\n\t{\n\t\ttransmittance = vec3f(1.0);\n\t}\n\tlet fresnel: vec3f = vec3f(1.0) -\n\t\tgetFresnel(\n\t\t\tdot(viewDir, worldNormal),\n\t\t\tgloss,\n\t\t\tspecularity\n\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t, iridescenceFresnel,\n\t\t\tiridescenceIntensity\n\t\t#endif\n\t\t);\n\tdDiffuseLight = mix(dDiffuseLight, refraction * transmittance * fresnel, transmission);\n}\n",reprojectPS:'\nvarying vUv0: vec2f;\n#ifdef CUBEMAP_SOURCE\n\tvar sourceCube: texture_cube<f32>;\n\tvar sourceCubeSampler : sampler;\n#else\n\tvar sourceTex: texture_2d<f32>;\n\tvar sourceTexSampler : sampler;\n#endif\n#ifdef USE_SAMPLES_TEX\n\tvar samplesTex: texture_2d<f32>;\n\tvar samplesTexSampler : sampler;\n\tuniform samplesTexInverseSize: vec2f;\n#endif\nuniform params: vec3f;\nfn targetFace() -> f32 { return uniform.params.x; }\nfn targetTotalPixels() -> f32 { return uniform.params.y; }\nfn sourceTotalPixels() -> f32 { return uniform.params.z; }\nconst PI: f32 = 3.141592653589793;\nfn saturate(x: f32) -> f32 {\n\treturn clamp(x, 0.0, 1.0);\n}\n#include "decodePS"\n#include "encodePS"\nfn modifySeams(dir: vec3f, scale: f32) -> vec3f {\n\tlet adir = abs(dir);\n\tlet M = max(max(adir.x, adir.y), adir.z);\n\treturn dir / M * vec3f(\n\t\tselect(scale, 1.0, adir.x == M),\n\t\tselect(scale, 1.0, adir.y == M),\n\t\tselect(scale, 1.0, adir.z == M)\n\t);\n}\nfn toSpherical(dir: vec3f) -> vec2f {\n\tlet nonZeroXZ = any(dir.xz != vec2f(0.0, 0.0));\n\treturn vec2f(select(0.0, atan2(dir.x, dir.z), nonZeroXZ), asin(dir.y));\n}\nfn fromSpherical(uv: vec2f) -> vec3f {\n\treturn vec3f(cos(uv.y) * sin(uv.x),\n\t\t\t\tsin(uv.y),\n\t\t\t\tcos(uv.y) * cos(uv.x));\n}\nfn getDirectionEquirect(uv: vec2f) -> vec3f {\n\treturn fromSpherical((vec2f(uv.x, 1.0 - uv.y) * 2.0 - 1.0) * vec2f(PI, PI * 0.5));\n}\nfn signNotZero(k: f32) -> f32 {\n\treturn select(-1.0, 1.0, k >= 0.0);\n}\nfn signNotZeroVec2(v: vec2f) -> vec2f {\n\treturn vec2f(signNotZero(v.x), signNotZero(v.y));\n}\nfn octDecode(o: vec2f) -> vec3f {\n\tvar v = vec3f(o.x, 1.0 - abs(o.x) - abs(o.y), o.y);\n\tif (v.y < 0.0) {\n\t\tvar temp: vec2f = (1.0 - abs(v.zx)) * signNotZeroVec2(v.xz);\n\t\tv = vec3f(temp.x, v.y, temp.y);\n\t}\n\treturn normalize(v);\n}\nfn getDirectionOctahedral(uv: vec2f) -> vec3f {\n\treturn octDecode(vec2f(uv.x, 1.0 - uv.y) * 2.0 - 1.0);\n}\nfn octEncode(v: vec3f) -> vec2f {\n\tlet l1norm = abs(v.x) + abs(v.y) + abs(v.z);\n\tvar result = v.xz * (1.0 / l1norm);\n\tif (v.y < 0.0) {\n\t\tresult = (1.0 - abs(result.yx)) * signNotZeroVec2(result.xy);\n\t}\n\treturn result;\n}\n#ifdef CUBEMAP_SOURCE\n\tfn sampleCubemapDir(dir: vec3f) -> vec4f {\n\t\treturn textureSample(sourceCube, sourceCubeSampler, modifySeams(dir, 1.0));\n\t}\n\tfn sampleCubemapSph(sph: vec2f) -> vec4f {\n\t\treturn sampleCubemapDir(fromSpherical(sph));\n\t}\n\tfn sampleCubemapDirLod(dir: vec3f, mipLevel: f32) -> vec4f {\n\t\treturn textureSampleLevel(sourceCube, sourceCubeSampler, modifySeams(dir, 1.0), mipLevel);\n\t}\n\tfn sampleCubemapSphLod(sph: vec2f, mipLevel: f32) -> vec4f {\n\t\treturn sampleCubemapDirLod(fromSpherical(sph), mipLevel);\n\t}\n#else\n\tfn sampleEquirectSph(sph: vec2f) -> vec4f {\n\t\tlet uv = sph / vec2f(PI * 2.0, PI) + 0.5;\n\t\treturn textureSample(sourceTex, sourceTexSampler, vec2f(uv.x, 1.0 - uv.y));\n\t}\n\tfn sampleEquirectDir(dir: vec3f) -> vec4f {\n\t\treturn sampleEquirectSph(toSpherical(dir));\n\t}\n\tfn sampleEquirectSphLod(sph: vec2f, mipLevel: f32) -> vec4f {\n\t\tlet uv = sph / vec2f(PI * 2.0, PI) + 0.5;\n\t\treturn textureSampleLevel(sourceTex, sourceTexSampler, vec2f(uv.x, 1.0 - uv.y), mipLevel);\n\t}\n\tfn sampleEquirectDirLod(dir: vec3f, mipLevel: f32) -> vec4f {\n\t\treturn sampleEquirectSphLod(toSpherical(dir), mipLevel);\n\t}\n\tfn sampleOctahedralDir(dir: vec3f) -> vec4f {\n\t\tlet uv = octEncode(dir) * 0.5 + 0.5;\n\t\treturn textureSample(sourceTex, sourceTexSampler, vec2f(uv.x, 1.0 - uv.y));\n\t}\n\tfn sampleOctahedralSph(sph: vec2f) -> vec4f {\n\t\treturn sampleOctahedralDir(fromSpherical(sph));\n\t}\n\tfn sampleOctahedralDirLod(dir: vec3f, mipLevel: f32) -> vec4f {\n\t\tlet uv = octEncode(dir) * 0.5 + 0.5;\n\t\treturn textureSampleLevel(sourceTex, sourceTexSampler, vec2f(uv.x, 1.0 - uv.y), mipLevel);\n\t}\n\tfn sampleOctahedralSphLod(sph: vec2f, mipLevel: f32) -> vec4f {\n\t\treturn sampleOctahedralDirLod(fromSpherical(sph), mipLevel);\n\t}\n#endif\nfn getDirectionCubemap(uv: vec2f) -> vec3f {\n\tlet st = uv * 2.0 - 1.0;\n\tlet face = targetFace();\n\tvar vec: vec3f;\n\tif (face == 0.0) {\n\t\tvec = vec3f(1, -st.y, -st.x);\n\t} else if (face == 1.0) {\n\t\tvec = vec3f(-1, -st.y, st.x);\n\t} else if (face == 2.0) {\n\t\tvec = vec3f(st.x, 1, st.y);\n\t} else if (face == 3.0) {\n\t\tvec = vec3f(st.x, -1, -st.y);\n\t} else if (face == 4.0) {\n\t\tvec = vec3f(st.x, -st.y, 1);\n\t} else {\n\t\tvec = vec3f(-st.x, -st.y, -1);\n\t}\n\treturn normalize(modifySeams(vec, 1.0));\n}\nfn matrixFromVector(n: vec3f) -> mat3x3f {\n\tlet a = 1.0 / (1.0 + n.z);\n\tlet b = -n.x * n.y * a;\n\tlet b1 = vec3f(1.0 - n.x * n.x * a, b, -n.x);\n\tlet b2 = vec3f(b, 1.0 - n.y * n.y * a, -n.y);\n\treturn mat3x3f(b1, b2, n);\n}\nfn matrixFromVectorSlow(n: vec3f) -> mat3x3f {\n\tlet up = select(vec3f(0.0, 0.0, select(-1.0, 1.0, n.y > 0.0)), vec3f(0.0, 1.0, 0.0), abs(n.y) > 0.0000001);\n\tlet x = normalize(cross(up, n));\n\tlet y = cross(n, x);\n\treturn mat3x3f(x, y, n);\n}\nfn reproject(uv: vec2f) -> vec4f {\n\tif ({NUM_SAMPLES} <= 1) {\n\t\treturn {ENCODE_FUNC}({DECODE_FUNC}({SOURCE_FUNC}Dir({TARGET_FUNC}(uv))));\n\t} else {\n\t\tlet t = {TARGET_FUNC}(uv);\n\t\tlet tu = dpdx(t);\n\t\tlet tv = dpdy(t);\n\t\tvar result = vec3f(0.0);\n\t\tfor (var u = 0.0; u < {NUM_SAMPLES_SQRT}; u += 1.0) {\n\t\t\tfor (var v = 0.0; v < {NUM_SAMPLES_SQRT}; v += 1.0) {\n\t\t\t\tresult += {DECODE_FUNC}({SOURCE_FUNC}Dir(normalize(t +\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ttu * (u / {NUM_SAMPLES_SQRT} - 0.5) +\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ttv * (v / {NUM_SAMPLES_SQRT} - 0.5))));\n\t\t\t}\n\t\t}\n\t\treturn {ENCODE_FUNC}(result / ({NUM_SAMPLES_SQRT} * {NUM_SAMPLES_SQRT}));\n\t}\n}\nconst unpackFloat: vec4f = vec4f(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0);\n#ifdef USE_SAMPLES_TEX\n\tfn unpackSample(i: i32, L: ptr<function, vec3f>, mipLevel: ptr<function, f32>) {\n\t\tvar u = (f32(i * 4) + 0.5) * uniform.samplesTexInverseSize.x;\n\t\tvar v = (floor(u) + 0.5) * uniform.samplesTexInverseSize.y;\n\t\tvar raw: vec4f;\n\t\traw.x = dot(textureSample(samplesTex, samplesTexSampler, vec2f(u, v)), unpackFloat); u += uniform.samplesTexInverseSize.x;\n\t\traw.y = dot(textureSample(samplesTex, samplesTexSampler, vec2f(u, v)), unpackFloat); u += uniform.samplesTexInverseSize.x;\n\t\traw.z = dot(textureSample(samplesTex, samplesTexSampler, vec2f(u, v)), unpackFloat); u += uniform.samplesTexInverseSize.x;\n\t\traw.w = dot(textureSample(samplesTex, samplesTexSampler, vec2f(u, v)), unpackFloat);\n\t\t*L = raw.xyz * 2.0 - 1.0;\n\t\t*mipLevel = raw.w * 8.0;\n\t}\n\tfn prefilterSamples(uv: vec2f) -> vec4f {\n\t\tlet vecSpace = matrixFromVectorSlow({TARGET_FUNC}(uv));\n\t\tvar L: vec3f;\n\t\tvar mipLevel: f32;\n\t\tvar result = vec3f(0.0);\n\t\tvar totalWeight = 0.0;\n\t\tfor (var i = 0; i < {NUM_SAMPLES}; i += 1) {\n\t\t\tunpackSample(i, &L, &mipLevel);\n\t\t\tresult += {DECODE_FUNC}({SOURCE_FUNC}DirLod(vecSpace * L, mipLevel)) * L.z;\n\t\t\ttotalWeight += L.z;\n\t\t}\n\t\treturn {ENCODE_FUNC}(result / totalWeight);\n\t}\n\tfn prefilterSamplesUnweighted(uv: vec2f) -> vec4f {\n\t\tlet vecSpace = matrixFromVectorSlow({TARGET_FUNC}(uv));\n\t\tvar L: vec3f;\n\t\tvar mipLevel: f32;\n\t\tvar result = vec3f(0.0);\n\t\tfor (var i = 0; i < {NUM_SAMPLES}; i += 1) {\n\t\t\tunpackSample(i, &L, &mipLevel);\n\t\t\tresult += {DECODE_FUNC}({SOURCE_FUNC}DirLod(vecSpace * L, mipLevel));\n\t\t}\n\t\treturn {ENCODE_FUNC}(result / f32({NUM_SAMPLES}));\n\t}\n#endif\n@fragment\nfn fragmentMain(input : FragmentInput) -> FragmentOutput {\n\tvar output: FragmentOutput;\n\toutput.color = {PROCESS_FUNC}(input.vUv0);\n\treturn output;\n}\n',reprojectVS:"\nattribute vertex_position: vec2f;\nuniform uvMod: vec4f;\nvarying vUv0: vec2f;\n@vertex\nfn vertexMain(input: VertexInput) -> VertexOutput {\n\tvar output: VertexOutput;\n\toutput.position = vec4f(input.vertex_position, 0.5, 1.0);\n\toutput.vUv0 = getImageEffectUV((input.vertex_position * 0.5 + vec2f(0.5, 0.5)) * uniform.uvMod.xy + uniform.uvMod.zw);\n\treturn output;\n}\n",screenDepthPS:"\nvar uSceneDepthMap: texture_2d<uff>;\n#ifndef SCREENSIZE\n\t#define SCREENSIZE\n\tuniform uScreenSize: vec4f;\n#endif\n#ifndef VIEWMATRIX\n\t#define VIEWMATRIX\n\tuniform matrix_view: mat4x4f;\n#endif\n#ifndef LINEARIZE_DEPTH\n\t#define LINEARIZE_DEPTH\n\t#ifndef CAMERAPLANES\n\t\t#define CAMERAPLANES\n\t\tuniform camera_params: vec4f;\n\t#endif\n\tfn linearizeDepth(z: f32) -> f32 {\n\t\tif (uniform.camera_params.w == 0.0) {\n\t\t\treturn (uniform.camera_params.z * uniform.camera_params.y) / (uniform.camera_params.y + z * (uniform.camera_params.z - uniform.camera_params.y));\n\t\t} else {\n\t\t\treturn uniform.camera_params.z + z * (uniform.camera_params.y - uniform.camera_params.z);\n\t\t}\n\t}\n#endif\nfn delinearizeDepth(linearDepth: f32) -> f32 {\n\tif (uniform.camera_params.w == 0.0) {\n\t\treturn (uniform.camera_params.y * (uniform.camera_params.z - linearDepth)) / (linearDepth * (uniform.camera_params.z - uniform.camera_params.y));\n\t} else {\n\t\treturn (linearDepth - uniform.camera_params.z) / (uniform.camera_params.y - uniform.camera_params.z);\n\t}\n}\nfn getLinearScreenDepth(uv: vec2f) -> f32 {\n\tlet textureSize = textureDimensions(uSceneDepthMap, 0);\n\tlet texel: vec2i = vec2i(uv * vec2f(textureSize));\n\t#ifdef SCENE_DEPTHMAP_LINEAR\n\t\treturn textureLoad(uSceneDepthMap, texel, 0).r;\n\t#else\n\t\treturn linearizeDepth(textureLoad(uSceneDepthMap, texel, 0).r);\n\t#endif\n}\n#ifndef VERTEXSHADER\n\tfn getLinearScreenDepthFrag() -> f32 {\n\t\tlet uv: vec2f = pcPosition.xy * uniform.uScreenSize.zw;\n\t\treturn getLinearScreenDepth(uv);\n\t}\n#endif\nfn getLinearDepth(pos: vec3f) -> f32 {\n\treturn -(uniform.matrix_view * vec4f(pos, 1.0)).z;\n}\n",shadowCascadesPS:"\nfn getShadowCascadeIndex(shadowCascadeDistances: vec4f, shadowCascadeCount: i32) -> i32 {\n\tlet depth: f32 = 1.0 / pcPosition.w;\n\tlet comparisons: vec4f = step(shadowCascadeDistances, vec4f(depth));\n\tlet cascadeIndex: i32 = i32(dot(comparisons, vec4f(1.0)));\n\treturn min(cascadeIndex, shadowCascadeCount - 1);\n}\nfn ditherShadowCascadeIndex(cascadeIndex_in: i32, shadowCascadeDistances: vec4f, shadowCascadeCount: i32, blendFactor: f32) -> i32 {\n\tvar cascadeIndex: i32 = cascadeIndex_in;\n\tif (cascadeIndex < shadowCascadeCount - 1) {\n\t\tlet currentRangeEnd: f32 = shadowCascadeDistances[cascadeIndex];\n\t\tlet transitionStart: f32 = blendFactor * currentRangeEnd;\n\t\tlet depth: f32 = 1.0 / pcPosition.w;\n\t\tif (depth > transitionStart) {\n\t\t\tlet transitionFactor: f32 = smoothstep(transitionStart, currentRangeEnd, depth);\n\t\t\tlet dither: f32 = fract(sin(dot(pcPosition.xy, vec2f(12.9898, 78.233))) * 43758.5453);\n\t\t\tif (dither < transitionFactor) {\n\t\t\t\tcascadeIndex = cascadeIndex + 1;\n\t\t\t}\n\t\t}\n\t}\n\treturn cascadeIndex;\n}\nfn fadeShadow(shadowCoord_in: vec3f, shadowCascadeDistances: vec4f) -> vec3f {\n\tvar shadowCoord: vec3f = shadowCoord_in;\n\tlet depth: f32 = 1.0 / pcPosition.w;\n\tif (depth > shadowCascadeDistances.w) {\n\t\tshadowCoord.z = -9999999.0;\n\t}\n\treturn shadowCoord;\n}\n",shadowEVSMPS:"\nfn linstep(a: f32, b: f32, v: f32) -> f32 {\n\treturn clamp((v - a) / (b - a), 0.0, 1.0);\n}\nfn reduceLightBleeding(pMax: f32, amount: f32) -> f32 {\n\t return linstep(amount, 1.0, pMax);\n}\nfn chebyshevUpperBound(moments: vec2f, mean: f32, minVariance: f32, lightBleedingReduction: f32) -> f32 {\n\tvar variance: f32 = moments.y - (moments.x * moments.x);\n\tvariance = max(variance, minVariance);\n\tlet d: f32 = mean - moments.x;\n\tvar pMax: f32 = variance / (variance + (d * d));\n\tpMax = reduceLightBleeding(pMax, lightBleedingReduction);\n\treturn select(pMax, 1.0, mean <= moments.x);\n}\nfn calculateEVSM(moments_in: vec3f, Z_in: f32, vsmBias: f32, exponent: f32) -> f32 {\n\tlet Z: f32 = 2.0 * Z_in - 1.0;\n\tlet warpedDepth: f32 = exp(exponent * Z);\n\tlet moments: vec2f = moments_in.xy + vec2f(warpedDepth, warpedDepth*warpedDepth) * (1.0 - moments_in.z);\n\tlet VSMBias: f32 = vsmBias;\n\tlet depthScale: f32 = VSMBias * exponent * warpedDepth;\n\tlet minVariance1: f32 = depthScale * depthScale;\n\treturn chebyshevUpperBound(moments, warpedDepth, minVariance1, 0.1);\n}\nfn VSM16(tex: texture_2d<f32>, texSampler: sampler, texCoords: vec2f, resolution: f32, Z: f32, vsmBias: f32, exponent: f32) -> f32 {\n\tlet moments: vec3f = textureSampleLevel(tex, texSampler, texCoords, 0.0).xyz;\n\treturn calculateEVSM(moments, Z, vsmBias, exponent);\n}\nfn getShadowVSM16(shadowMap: texture_2d<f32>, shadowMapSampler: sampler, shadowCoord: vec3f, shadowParams: vec4f, exponent: f32) -> f32 {\n\treturn VSM16(shadowMap, shadowMapSampler, shadowCoord.xy, shadowParams.x, shadowCoord.z, shadowParams.y, exponent);\n}\nfn getShadowSpotVSM16(shadowMap: texture_2d<f32>, shadowMapSampler: sampler, shadowCoord: vec3f, shadowParams: vec4f, exponent: f32, lightDir: vec3f) -> f32 {\n\tlet Z: f32 = length(lightDir) * shadowParams.w + shadowParams.z;\n\treturn VSM16(shadowMap, shadowMapSampler, shadowCoord.xy, shadowParams.x, Z, shadowParams.y, exponent);\n}\nfn VSM32(tex: texture_2d<f32>, texSampler: sampler, texCoords_in: vec2f, resolution: f32, Z: f32, vsmBias: f32, exponent: f32) -> f32 {\n\t#ifdef CAPS_TEXTURE_FLOAT_FILTERABLE\n\t\tvar moments: vec3f = textureSampleLevel(tex, texSampler, texCoords_in, 0.0).xyz;\n\t#else\n\t\tvar pixelSize : f32 = 1.0 / resolution;\n\t\tlet texCoords: vec2f = texCoords_in - vec2f(pixelSize);\n\t\tlet s00: vec3f = textureSampleLevel(tex, texSampler, texCoords, 0.0).xyz;\n\t\tlet s10: vec3f = textureSampleLevel(tex, texSampler, texCoords + vec2f(pixelSize, 0.0), 0.0).xyz;\n\t\tlet s01: vec3f = textureSampleLevel(tex, texSampler, texCoords + vec2f(0.0, pixelSize), 0.0).xyz;\n\t\tlet s11: vec3f = textureSampleLevel(tex, texSampler, texCoords + vec2f(pixelSize), 0.0).xyz;\n\t\tlet fr: vec2f = fract(texCoords * resolution);\n\t\tlet h0: vec3f = mix(s00, s10, fr.x);\n\t\tlet h1: vec3f = mix(s01, s11, fr.x);\n\t\tvar moments: vec3f = mix(h0, h1, fr.y);\n\t#endif\n\treturn calculateEVSM(moments, Z, vsmBias, exponent);\n}\nfn getShadowVSM32(shadowMap: texture_2d<f32>, shadowMapSampler: sampler, shadowCoord: vec3f, shadowParams: vec4f, exponent: f32) -> f32 {\n\treturn VSM32(shadowMap, shadowMapSampler, shadowCoord.xy, shadowParams.x, shadowCoord.z, shadowParams.y, exponent);\n}\nfn getShadowSpotVSM32(shadowMap: texture_2d<f32>, shadowMapSampler: sampler, shadowCoord: vec3f, shadowParams: vec4f, exponent: f32, lightDir: vec3f) -> f32 {\n\tlet Z: f32 = length(lightDir) * shadowParams.w + shadowParams.z;\n\treturn VSM32(shadowMap, shadowMapSampler, shadowCoord.xy, shadowParams.x, Z, shadowParams.y, exponent);\n}\n",shadowPCF1PS:"\nfn getShadowPCF1x1(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {\n\treturn textureSampleCompareLevel(shadowMap, shadowMapSampler, shadowCoord.xy, shadowCoord.z);\n}\nfn getShadowSpotPCF1x1(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {\n\treturn textureSampleCompareLevel(shadowMap, shadowMapSampler, shadowCoord.xy, shadowCoord.z);\n}\n",shadowPCF3PS:"\nfn _getShadowPCF3x3(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec3f) -> f32 {\n\tlet z: f32 = shadowCoord.z;\n\tlet uv: vec2f = shadowCoord.xy * shadowParams.x;\n\tlet shadowMapSizeInv: f32 = 1.0 / shadowParams.x;\n\tlet base_uv_temp: vec2f = floor(uv + 0.5);\n\tlet s: f32 = (uv.x + 0.5 - base_uv_temp.x);\n\tlet t: f32 = (uv.y + 0.5 - base_uv_temp.y);\n\tlet base_uv: vec2f = (base_uv_temp - vec2f(0.5)) * shadowMapSizeInv;\n\tvar sum: f32 = 0.0;\n\tlet uw0: f32 = (3.0 - 2.0 * s);\n\tlet uw1: f32 = (1.0 + 2.0 * s);\n\tlet u0_offset: f32 = (2.0 - s) / uw0 - 1.0;\n\tlet u1_offset: f32 = s / uw1 + 1.0;\n\tlet vw0: f32 = (3.0 - 2.0 * t);\n\tlet vw1: f32 = (1.0 + 2.0 * t);\n\tlet v0_offset: f32 = (2.0 - t) / vw0 - 1.0;\n\tlet v1_offset: f32 = t / vw1 + 1.0;\n\tlet u0: f32 = u0_offset * shadowMapSizeInv + base_uv.x;\n\tlet v0: f32 = v0_offset * shadowMapSizeInv + base_uv.y;\n\tlet u1: f32 = u1_offset * shadowMapSizeInv + base_uv.x;\n\tlet v1: f32 = v1_offset * shadowMapSizeInv + base_uv.y;\n\tsum = sum + uw0 * vw0 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u0, v0), z);\n\tsum = sum + uw1 * vw0 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u1, v0), z);\n\tsum = sum + uw0 * vw1 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u0, v1), z);\n\tsum = sum + uw1 * vw1 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u1, v1), z);\n\tsum = sum * (1.0 / 16.0);\n\treturn sum;\n}\nfn getShadowPCF3x3(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {\n\treturn _getShadowPCF3x3(shadowMap, shadowMapSampler, shadowCoord, shadowParams.xyz);\n}\nfn getShadowSpotPCF3x3(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {\n\treturn _getShadowPCF3x3(shadowMap, shadowMapSampler, shadowCoord, shadowParams.xyz);\n}\n",shadowPCF5PS:"\nfn _getShadowPCF5x5(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec3f) -> f32 {\n\tlet z: f32 = shadowCoord.z;\n\tlet uv: vec2f = shadowCoord.xy * shadowParams.x;\n\tlet shadowMapSizeInv: f32 = 1.0 / shadowParams.x;\n\tlet base_uv_temp: vec2f = floor(uv + 0.5);\n\tlet s: f32 = (uv.x + 0.5 - base_uv_temp.x);\n\tlet t: f32 = (uv.y + 0.5 - base_uv_temp.y);\n\tlet base_uv: vec2f = (base_uv_temp - vec2f(0.5)) * shadowMapSizeInv;\n\tlet uw0: f32 = (4.0 - 3.0 * s);\n\tlet uw1: f32 = 7.0;\n\tlet uw2: f32 = (1.0 + 3.0 * s);\n\tlet u0_offset: f32 = (3.0 - 2.0 * s) / uw0 - 2.0;\n\tlet u1_offset: f32 = (3.0 + s) / uw1;\n\tlet u2_offset: f32 = s / uw2 + 2.0;\n\tlet vw0: f32 = (4.0 - 3.0 * t);\n\tlet vw1: f32 = 7.0;\n\tlet vw2: f32 = (1.0 + 3.0 * t);\n\tlet v0_offset: f32 = (3.0 - 2.0 * t) / vw0 - 2.0;\n\tlet v1_offset: f32 = (3.0 + t) / vw1;\n\tlet v2_offset: f32 = t / vw2 + 2.0;\n\tvar sum: f32 = 0.0;\n\tlet u0: f32 = u0_offset * shadowMapSizeInv + base_uv.x;\n\tlet v0: f32 = v0_offset * shadowMapSizeInv + base_uv.y;\n\tlet u1: f32 = u1_offset * shadowMapSizeInv + base_uv.x;\n\tlet v1: f32 = v1_offset * shadowMapSizeInv + base_uv.y;\n\tlet u2: f32 = u2_offset * shadowMapSizeInv + base_uv.x;\n\tlet v2: f32 = v2_offset * shadowMapSizeInv + base_uv.y;\n\tsum = sum + uw0 * vw0 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u0, v0), z);\n\tsum = sum + uw1 * vw0 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u1, v0), z);\n\tsum = sum + uw2 * vw0 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u2, v0), z);\n\tsum = sum + uw0 * vw1 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u0, v1), z);\n\tsum = sum + uw1 * vw1 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u1, v1), z);\n\tsum = sum + uw2 * vw1 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u2, v1), z);\n\tsum = sum + uw0 * vw2 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u0, v2), z);\n\tsum = sum + uw1 * vw2 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u1, v2), z);\n\tsum = sum + uw2 * vw2 * textureSampleCompareLevel(shadowMap, shadowMapSampler, vec2f(u2, v2), z);\n\tsum = sum * (1.0 / 144.0);\n\tsum = saturate(sum);\n\treturn sum;\n}\nfn getShadowPCF5x5(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {\n\treturn _getShadowPCF5x5(shadowMap, shadowMapSampler, shadowCoord, shadowParams.xyz);\n}\nfn getShadowSpotPCF5x5(shadowMap: texture_depth_2d, shadowMapSampler: sampler_comparison, shadowCoord: vec3f, shadowParams: vec4f) -> f32 {\n\treturn _getShadowPCF5x5(shadowMap, shadowMapSampler, shadowCoord, shadowParams.xyz);\n}\n",shadowSoftPS:"\nfn fractSinRand(uv: vec2f) -> f32 {\n\tlet PI: f32 = 3.141592653589793;\n\tlet a: f32 = 12.9898; let b: f32 = 78.233; let c: f32 = 43758.5453;\n\tlet dt: f32 = dot(uv.xy, vec2f(a, b));\n\tlet sn: f32 = dt % PI;\n\treturn fract(sin(sn) * c);\n}\nstruct VogelDiskData {\n\tinvNumSamples: f32,\n\tinitialAngle: f32,\n\tcurrentPointId: f32,\n}\nfn prepareDiskConstants(data: ptr<function, VogelDiskData>, sampleCount: i32, randomSeed: f32) {\n\tlet pi2: f32 = 6.28318530718;\n\tdata.invNumSamples = 1.0 / f32(sampleCount);\n\tdata.initialAngle = randomSeed * pi2;\n\tdata.currentPointId = 0.0;\n}\nfn generateDiskSample(data: ptr<function, VogelDiskData>) -> vec2f {\n\tlet GOLDEN_ANGLE: f32 = 2.399963;\n\tlet r: f32 = sqrt((data.currentPointId + 0.5) * data.invNumSamples);\n\tlet theta: f32 = data.currentPointId * GOLDEN_ANGLE + data.initialAngle;\n\tlet offset: vec2f = vec2f(cos(theta), sin(theta)) * pow(r, 1.33);\n\tdata.currentPointId = data.currentPointId + 1.0;\n\treturn offset;\n}\nfn PCSSFindBlocker(shadowMap: texture_2d<f32>, shadowMapSampler: sampler, avgBlockerDepth: ptr<function, f32>, numBlockers: ptr<function, i32>,\n\tshadowCoords: vec2f, z: f32, shadowBlockerSamples: i32, penumbraSize: f32, invShadowMapSize: f32, randomSeed: f32) {\n\tvar diskData: VogelDiskData;\n\tprepareDiskConstants(&diskData, shadowBlockerSamples, randomSeed);\n\tlet searchWidth: f32 = penumbraSize * invShadowMapSize;\n\tvar blockerSum: f32 = 0.0;\n\tvar numBlockers_local: i32 = 0;\n\tfor( var i: i32 = 0; i < shadowBlockerSamples; i = i + 1 ) {\n\t\tlet diskUV: vec2f = generateDiskSample(&diskData);\n\t\tlet sampleUV: vec2f = shadowCoords + diskUV * searchWidth;\n\t\tlet shadowMapDepth: f32 = textureSampleLevel(shadowMap, shadowMapSampler, sampleUV, 0.0).r;\n\t\tif ( shadowMapDepth < z ) {\n\t\t\tblockerSum = blockerSum + shadowMapDepth;\n\t\t\tnumBlockers_local = numBlockers_local + 1;\n\t\t}\n\t}\n\t*avgBlockerDepth = blockerSum / f32(numBlockers_local);\n\t*numBlockers = numBlockers_local;\n}\nfn PCSSFilter(shadowMap: texture_2d<f32>, shadowMapSampler: sampler, uv: vec2f, receiverDepth: f32, shadowSamples: i32, filterRadius: f32, randomSeed: f32) -> f32 {\n\tvar diskData: VogelDiskData;\n\tprepareDiskConstants(&diskData, shadowSamples, randomSeed);\n\tvar sum: f32 = 0.0;\n\tfor (var i: i32 = 0; i < shadowSamples; i = i + 1) {\n\t\tlet offsetUV: vec2f = generateDiskSample(&diskData) * filterRadius;\n\t\tlet depth: f32 = textureSampleLevel(shadowMap, shadowMapSampler, uv + offsetUV, 0.0).r;\n\t\tsum = sum + step(receiverDepth, depth);\n\t}\n\treturn sum / f32(shadowSamples);\n}\nfn getPenumbra(dblocker: f32, dreceiver: f32, penumbraSize: f32, penumbraFalloff: f32) -> f32 {\n\tlet dist: f32 = dreceiver - dblocker;\n\tlet penumbra: f32 = 1.0 - pow(1.0 - dist, penumbraFalloff);\n\treturn penumbra * penumbraSize;\n}\nfn PCSSDirectional(shadowMap: texture_2d<f32>, shadowMapSampler: sampler, shadowCoords: vec3f, cameraParams: vec4f, softShadowParams: vec4f) -> f32 {\n\tlet receiverDepth: f32 = shadowCoords.z;\n\tlet randomSeed: f32 = fractSinRand(pcPosition.xy);\n\tlet shadowSamples: i32 = i32(softShadowParams.x);\n\tlet shadowBlockerSamples: i32 = i32(softShadowParams.y);\n\tlet penumbraSize: f32 = softShadowParams.z;\n\tlet penumbraFalloff: f32 = softShadowParams.w;\n\tlet shadowMapSize: i32 = i32(textureDimensions(shadowMap, 0).x);\n\tvar invShadowMapSize: f32 = 1.0 / f32(shadowMapSize);\n\tinvShadowMapSize = invShadowMapSize * (f32(shadowMapSize) / 2048.0);\n\tvar penumbra: f32;\n\tif (shadowBlockerSamples > 0) {\n\t\tvar avgBlockerDepth: f32 = 0.0;\n\t\tvar numBlockers: i32 = 0;\n\t\tPCSSFindBlocker(shadowMap, shadowMapSampler, &avgBlockerDepth, &numBlockers, shadowCoords.xy, receiverDepth, shadowBlockerSamples, penumbraSize, invShadowMapSize, randomSeed);\n\t\tif (numBlockers < 1) {\n\t\t\treturn 1.0;\n\t\t}\n\t\tpenumbra = getPenumbra(avgBlockerDepth, shadowCoords.z, penumbraSize, penumbraFalloff);\n\t} else {\n\t\tpenumbra = penumbraSize;\n\t}\n\tlet filterRadius: f32 = penumbra * invShadowMapSize;\n\treturn PCSSFilter(shadowMap, shadowMapSampler, shadowCoords.xy, receiverDepth, shadowSamples, filterRadius, randomSeed);\n}\nfn getShadowPCSS(shadowMap: texture_2d<f32>, shadowMapSampler: sampler, shadowCoord: vec3f, shadowParams: vec4f, cameraParams: vec4f, softShadowParams: vec4f, lightDir: vec3f) -> f32 {\n\treturn PCSSDirectional(shadowMap, shadowMapSampler, shadowCoord, cameraParams, softShadowParams);\n}\n",skinBatchVS:"\nattribute vertex_boneIndices: f32;\nvar texture_poseMap: texture_2d<uff>;\nfn getBoneMatrix(indexFloat: f32) -> mat4x4f {\n\tlet width = i32(textureDimensions(texture_poseMap).x);\n\tlet index: i32 = i32(indexFloat + 0.5) * 3;\n\tlet iy: i32 = index / width;\n\tlet ix: i32 = index % width;\n\tlet v1: vec4f = textureLoad(texture_poseMap, vec2i(ix + 0, iy), 0);\n\tlet v2: vec4f = textureLoad(texture_poseMap, vec2i(ix + 1, iy), 0);\n\tlet v3: vec4f = textureLoad(texture_poseMap, vec2i(ix + 2, iy), 0);\n\treturn mat4x4f(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, 1.0\n\t);\n}\n",skinVS:"\nattribute vertex_boneWeights: vec4f;\nattribute vertex_boneIndices: vec4f;\nvar texture_poseMap: texture_2d<uff>;\nstruct BoneMatrix {\n\tv1: vec4f,\n\tv2: vec4f,\n\tv3: vec4f,\n}\nfn getBoneMatrix(width: i32, index: i32) -> BoneMatrix {\n\tlet v = index / width;\n\tlet u = index % width;\n\tvar result: BoneMatrix;\n\tresult.v1 = textureLoad(texture_poseMap, vec2i(u + 0, v), 0);\n\tresult.v2 = textureLoad(texture_poseMap, vec2i(u + 1, v), 0);\n\tresult.v3 = textureLoad(texture_poseMap, vec2i(u + 2, v), 0);\n\treturn result;\n}\nfn getSkinMatrix(indicesFloat: vec4f, weights: vec4f) -> mat4x4f {\n\tlet width = i32(textureDimensions(texture_poseMap).x);\n\tvar indices = vec4i(indicesFloat + 0.5) * 3;\n\tlet boneA = getBoneMatrix(width, indices.x);\n\tlet boneB = getBoneMatrix(width, indices.y);\n\tlet boneC = getBoneMatrix(width, indices.z);\n\tlet boneD = getBoneMatrix(width, indices.w);\n\tlet v1 = boneA.v1 * weights.x + boneB.v1 * weights.y + boneC.v1 * weights.z + boneD.v1 * weights.w;\n\tlet v2 = boneA.v2 * weights.x + boneB.v2 * weights.y + boneC.v2 * weights.z + boneD.v2 * weights.w;\n\tlet v3 = boneA.v3 * weights.x + boneB.v3 * weights.y + boneC.v3 * weights.z + boneD.v3 * weights.w;\n\tlet one = dot(weights, vec4f(1.0, 1.0, 1.0, 1.0));\n\treturn mat4x4f(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, one\n\t);\n}\n",skyboxPS:'\n\t#define LIT_SKYBOX_INTENSITY\n\t#include "envProcPS"\n\t#include "gammaPS"\n\t#include "tonemappingPS"\n\t#ifdef PREPASS_PASS\n\t\tvarying vLinearDepth: f32;\n\t\t#include "floatAsUintPS"\n\t#endif\n\tvarying vViewDir : vec3f;\n\tuniform skyboxHighlightMultiplier : f32;\n\t#ifdef SKY_CUBEMAP\n\t\tvar texture_cubeMap : texture_cube<f32>;\n\t\tvar texture_cubeMap_sampler : sampler;\n\t\t#ifdef SKYMESH\n\t\t\tvarying vWorldPos : vec3f;\n\t\t\tuniform cubeMapRotationMatrix : mat3x3f;\n\t\t\tuniform projectedSkydomeCenter : vec3f;\n\t\t#endif\n\t#else\n\t\t#include "sphericalPS"\n\t\t#include "envAtlasPS"\n\t\tvar texture_envAtlas : texture_2d<f32>;\n\t\tvar texture_envAtlas_sampler : sampler;\n\t\tuniform mipLevel : f32;\n\t#endif\n\t@fragment\n\tfn fragmentMain(input : FragmentInput) -> FragmentOutput {\n\t\tvar output: FragmentOutput;\n\t\t#ifdef PREPASS_PASS\n\t\t\toutput.color = float2vec4(vLinearDepth);\n\t\t#else\n\t\t\tvar linear : vec3f;\n\t\t\tvar dir : vec3f;\n\t\t\t#ifdef SKY_CUBEMAP\n\t\t\t\t#ifdef SKYMESH\n\t\t\t\t\tvar envDir : vec3f = normalize(input.vWorldPos - uniform.projectedSkydomeCenter);\n\t\t\t\t\tdir = envDir * uniform.cubeMapRotationMatrix;\n\t\t\t\t#else\n\t\t\t\t\tdir = input.vViewDir;\n\t\t\t\t#endif\n\t\t\t\tdir.x *= -1.0;\n\t\t\t\tlinear = {SKYBOX_DECODE_FNC}(textureSample(texture_cubeMap, texture_cubeMap_sampler, dir));\n\t\t\t#else\n\t\t\t\tdir = input.vViewDir * vec3f(-1.0, 1.0, 1.0);\n\t\t\t\tlet uv : vec2f = toSphericalUv(normalize(dir));\n\t\t\t\tlinear = {SKYBOX_DECODE_FNC}(textureSample(texture_envAtlas, texture_envAtlas_sampler, mapRoughnessUv(uv, uniform.mipLevel)));\n\t\t\t#endif\n\t\t\tif (any(linear >= vec3f(64.0))) {\n\t\t\t\tlinear *= uniform.skyboxHighlightMultiplier;\n\t\t\t}\n\t\t\t\n\t\t\toutput.color = vec4f(gammaCorrectOutput(toneMap(processEnvironment(linear))), 1.0);\n\t\t#endif\n\t\treturn output;\n\t}\n',skyboxVS:"\n\tattribute aPosition : vec4f;\n\tuniform matrix_view : mat4x4f;\n\tuniform matrix_projectionSkybox : mat4x4f;\n\tuniform cubeMapRotationMatrix : mat3x3f;\n\tvarying vViewDir : vec3f;\n\t#ifdef PREPASS_PASS\n\t\tvarying vLinearDepth: f32;\n\t#endif\n\t#ifdef SKYMESH\n\t\tuniform matrix_model : mat4x4f;\n\t\tvarying vWorldPos : vec3f;\n\t#endif\n\t@vertex\n\tfn vertexMain(input : VertexInput) -> VertexOutput {\n\t\tvar output : VertexOutput;\n\t\tvar view : mat4x4f = uniform.matrix_view;\n\t\t#ifdef SKYMESH\n\t\t\tvar worldPos : vec4f = uniform.matrix_model * input.aPosition;\n\t\t\toutput.vWorldPos = worldPos.xyz;\n\t\t\toutput.position = uniform.matrix_projectionSkybox * (view * worldPos);\n\t\t\t#ifdef PREPASS_PASS\n\t\t\t\toutput.vLinearDepth = -(uniform.matrix_view * vec4f(worldPos.xyz, 1.0)).z;\n\t\t\t#endif\n\t\t#else\n\t\t\tview[3][0] = 0.0;\n\t\t\tview[3][1] = 0.0;\n\t\t\tview[3][2] = 0.0;\n\t\t\toutput.position = uniform.matrix_projectionSkybox * (view * input.aPosition);\n\t\t\toutput.vViewDir = input.aPosition.xyz * uniform.cubeMapRotationMatrix;\n\t\t\t#ifdef PREPASS_PASS\n\t\t\t\toutput.vLinearDepth = -pcPosition.w;\n\t\t\t#endif\n\t\t#endif\n\t\toutput.position.z = output.position.w - 1.0e-7;\n\t\treturn output;\n\t}\n",specularPS:"\n#ifdef STD_SPECULAR_CONSTANT\n\tuniform material_specular: vec3f;\n#endif\nfn getSpecularity() {\n\tvar specularColor = vec3f(1.0, 1.0, 1.0);\n\t#ifdef STD_SPECULAR_CONSTANT\n\tspecularColor = specularColor * uniform.material_specular;\n\t#endif\n\t#ifdef STD_SPECULAR_TEXTURE\n\tspecularColor = specularColor * {STD_SPECULAR_TEXTURE_DECODE}(textureSampleBias({STD_SPECULAR_TEXTURE_NAME}, {STD_SPECULAR_TEXTURE_NAME}Sampler, {STD_SPECULAR_TEXTURE_UV}, uniform.textureBias)).{STD_SPECULAR_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_SPECULAR_VERTEX\n\tspecularColor = specularColor * saturate3(vVertexColor.{STD_SPECULAR_VERTEX_CHANNEL});\n\t#endif\n\tdSpecularity = specularColor;\n}\n",sphericalPS:"\nfn toSpherical(dir: vec3f) -> vec2f {\n\tlet angle_xz = select(0.0, atan2(dir.x, dir.z), any(dir.xz != vec2f(0.0)));\n\treturn vec2f(angle_xz, asin(dir.y));\n}\nfn toSphericalUv(dir : vec3f) -> vec2f {\n\tconst PI : f32 = 3.141592653589793;\n\tlet uv : vec2f = toSpherical(dir) / vec2f(PI * 2.0, PI) + vec2f(0.5, 0.5);\n\treturn vec2f(uv.x, 1.0 - uv.y);\n}\n",specularityFactorPS:"\n#ifdef STD_SPECULARITYFACTOR_CONSTANT\n\tuniform material_specularityFactor: f32;\n#endif\nfn getSpecularityFactor() {\n\tvar specularityFactor = 1.0;\n\t#ifdef STD_SPECULARITYFACTOR_CONSTANT\n\tspecularityFactor = specularityFactor * uniform.material_specularityFactor;\n\t#endif\n\t#ifdef STD_SPECULARITYFACTOR_TEXTURE\n\tspecularityFactor = specularityFactor * textureSampleBias({STD_SPECULARITYFACTOR_TEXTURE_NAME}, {STD_SPECULARITYFACTOR_TEXTURE_NAME}Sampler, {STD_SPECULARITYFACTOR_TEXTURE_UV}, uniform.textureBias).{STD_SPECULARITYFACTOR_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_SPECULARITYFACTOR_VERTEX\n\tspecularityFactor = specularityFactor * saturate(vVertexColor.{STD_SPECULARITYFACTOR_VERTEX_CHANNEL});\n\t#endif\n\tdSpecularityFactor = specularityFactor;\n}\n",spotPS:"\nfn getSpotEffect(lightSpotDir: vec3f, lightInnerConeAngle: f32, lightOuterConeAngle: f32, lightDirNorm: vec3f) -> f32 {\n\tlet cosAngle: f32 = dot(lightDirNorm, lightSpotDir);\n\treturn smoothstep(lightOuterConeAngle, lightInnerConeAngle, cosAngle);\n}",startNineSlicedPS:"\n\tnineSlicedUv = vec2f(vUv0.x, 1.0 - vUv0.y);\n",startNineSlicedTiledPS:"\n\tlet tileMask: vec2f = step(vMask, vec2f(0.99999));\n\tlet tileSize: vec2f = 0.5 * (innerOffset.xy + innerOffset.zw);\n\tlet tileScale: vec2f = vec2f(1.0) / (vec2f(1.0) - tileSize);\n\tvar clampedUv: vec2f = mix(innerOffset.xy * 0.5, vec2f(1.0) - innerOffset.zw * 0.5, fract((vTiledUv - tileSize) * tileScale));\n\tclampedUv = clampedUv * atlasRect.zw + atlasRect.xy;\n\tvar nineSlicedUv: vec2f = vUv0 * tileMask + clampedUv * (vec2f(1.0) - tileMask);\n\tnineSlicedUv.y = 1.0 - nineSlicedUv.y;\n",stdDeclarationPS:'\n\tvar<private> dAlpha: f32 = 1.0;\n\t#if LIT_BLEND_TYPE != NONE || defined(LIT_ALPHA_TEST) || defined(LIT_ALPHA_TO_COVERAGE) || STD_OPACITY_DITHER != NONE\n\t\t#ifdef STD_OPACITY_TEXTURE_ALLOCATE\n\t\t\tvar texture_opacityMap : texture_2d<f32>;\n\t\t\tvar texture_opacityMapSampler : sampler;\n\t\t#endif\n\t#endif\n\t#ifdef FORWARD_PASS\n\t\tvar<private> dAlbedo: vec3f;\n\t\tvar<private> dNormalW: vec3f;\n\t\tvar<private> dSpecularity: vec3f = vec3f(0.0, 0.0, 0.0);\n\t\tvar<private> dGlossiness: f32 = 0.0;\n\t\t#ifdef LIT_REFRACTION\n\t\t\tvar<private> dTransmission: f32;\n\t\t\tvar<private> dThickness: f32;\n\t\t#endif\n\t\t#ifdef LIT_SCENE_COLOR\n\t\t\tvar uSceneColorMap : texture_2d<f32>;\n\t\t\tvar uSceneColorMapSampler : sampler;\n\t\t#endif\n\t\t#ifdef LIT_SCREEN_SIZE\n\t\t\tuniform uScreenSize: vec4f;\n\t\t#endif\n\t\t#ifdef LIT_TRANSFORMS\n\t\t\tvar<private> matrix_viewProjection: mat4x4f;\n\t\t\tvar<private> matrix_model: mat4x4f;\n\t\t#endif\n\t\t#ifdef STD_HEIGHT_MAP\n\t\t\tvar<private> dUvOffset: vec2f;\n\t\t\t#ifdef STD_HEIGHT_TEXTURE_ALLOCATE\n\t\t\t\tvar texture_heightMap : texture_2d<f32>;\n\t\t\t\tvar texture_heightMapSampler : sampler;\n\t\t\t#endif\n\t\t#endif\n\t\t#ifdef STD_DIFFUSE_TEXTURE_ALLOCATE\n\t\t\tvar texture_diffuseMap : texture_2d<f32>;\n\t\t\tvar texture_diffuseMapSampler : sampler;\n\t\t#endif\n\t\t#ifdef STD_DIFFUSEDETAIL_TEXTURE_ALLOCATE\n\t\t\tvar texture_diffuseDetailMap : texture_2d<f32>;\n\t\t\tvar texture_diffuseDetailMapSampler : sampler;\n\t\t#endif\n\t\t#ifdef STD_NORMAL_TEXTURE_ALLOCATE\n\t\t\tvar texture_normalMap : texture_2d<f32>;\n\t\t\tvar texture_normalMapSampler : sampler;\n\t\t#endif\n\t\t#ifdef STD_NORMALDETAIL_TEXTURE_ALLOCATE\n\t\t\tvar texture_normalDetailMap : texture_2d<f32>;\n\t\t\tvar texture_normalDetailMapSampler : sampler;\n\t\t#endif\n\t\t#ifdef STD_THICKNESS_TEXTURE_ALLOCATE\n\t\t\tvar texture_thicknessMap : texture_2d<f32>;\n\t\t\tvar texture_thicknessMapSampler : sampler;\n\t\t#endif\n\t\t#ifdef STD_REFRACTION_TEXTURE_ALLOCATE\n\t\t\tvar texture_refractionMap : texture_2d<f32>;\n\t\t\tvar texture_refractionMapSampler : sampler;\n\t\t#endif\n\t\t#ifdef LIT_IRIDESCENCE\n\t\t\tvar<private> dIridescence: f32;\n\t\t\tvar<private> dIridescenceThickness: f32;\n\t\t\t#ifdef STD_IRIDESCENCE_THICKNESS_TEXTURE_ALLOCATE\n\t\t\t\tvar texture_iridescenceThicknessMap : texture_2d<f32>;\n\t\t\t\tvar texture_iridescenceThicknessMapSampler : sampler;\n\t\t\t#endif\n\t\t\t#ifdef STD_IRIDESCENCE_TEXTURE_ALLOCATE\n\t\t\t\tvar texture_iridescenceMap : texture_2d<f32>;\n\t\t\t\tvar texture_iridescenceMapSampler : sampler;\n\t\t\t#endif\n\t\t#endif\n\t\t#ifdef LIT_CLEARCOAT\n\t\t\tvar<private> ccSpecularity: f32;\n\t\t\tvar<private> ccGlossiness: f32;\n\t\t\tvar<private> ccNormalW: vec3f;\n\t\t#endif\n\t\t#ifdef LIT_GGX_SPECULAR\n\t\t\tvar<private> dAnisotropy: f32;\n\t\t\tvar<private> dAnisotropyRotation: vec2f;\n\t\t#endif\n\t\t#ifdef LIT_SPECULAR_OR_REFLECTION\n\t\t\t#ifdef LIT_SHEEN\n\t\t\t\tvar<private> sSpecularity: vec3f;\n\t\t\t\tvar<private> sGlossiness: f32;\n\t\t\t\t#ifdef STD_SHEEN_TEXTURE_ALLOCATE\n\t\t\t\t\tvar texture_sheenMap : texture_2d<f32>;\n\t\t\t\t\tvar texture_sheenMapSampler : sampler;\n\t\t\t\t#endif\n\t\t\t\t#ifdef STD_SHEENGLOSS_TEXTURE_ALLOCATE\n\t\t\t\t\tvar texture_sheenGlossMap : texture_2d<f32>;\n\t\t\t\t\tvar texture_sheenGlossMapSampler : sampler;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\t#ifdef LIT_METALNESS\n\t\t\t\tvar<private> dMetalness: f32;\n\t\t\t\tvar<private> dIor: f32;\n\t\t\t\t#ifdef STD_METALNESS_TEXTURE_ALLOCATE\n\t\t\t\t\tvar texture_metalnessMap : texture_2d<f32>;\n\t\t\t\t\tvar texture_metalnessMapSampler : sampler;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\t#ifdef LIT_SPECULARITY_FACTOR\n\t\t\t\tvar<private> dSpecularityFactor: f32;\n\t\t\t\t#ifdef STD_SPECULARITYFACTOR_TEXTURE_ALLOCATE\n\t\t\t\t\tvar texture_specularityFactorMap : texture_2d<f32>;\n\t\t\t\t\tvar texture_specularityFactorMapSampler : sampler;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\t#ifdef STD_SPECULAR_COLOR\n\t\t\t\t#ifdef STD_SPECULAR_TEXTURE_ALLOCATE\n\t\t\t\t\tvar texture_specularMap : texture_2d<f32>;\n\t\t\t\t\tvar texture_specularMapSampler : sampler;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\t#ifdef STD_GLOSS_TEXTURE_ALLOCATE\n\t\t\t\tvar texture_glossMap : texture_2d<f32>;\n\t\t\t\tvar texture_glossMapSampler : sampler;\n\t\t\t#endif\n\t\t#endif\n\t\t#ifdef STD_AO\n\t\t\tvar <private> dAo: f32;\n\t\t\t#ifdef STD_AO_TEXTURE_ALLOCATE\n\t\t\t\tvar texture_aoMap : texture_2d<f32>;\n\t\t\t\tvar texture_aoMapSampler : sampler;\n\t\t\t#endif\n\t\t\t#ifdef STD_AODETAIL_TEXTURE_ALLOCATE\n\t\t\t\tvar texture_aoDetailMap : texture_2d<f32>;\n\t\t\t\tvar texture_aoDetailMapSampler : sampler;\n\t\t\t#endif\n\t\t#endif\n\t\tvar <private> dEmission: vec3f;\n\t\t#ifdef STD_EMISSIVE_TEXTURE_ALLOCATE\n\t\t\tvar texture_emissiveMap : texture_2d<f32>;\n\t\t\tvar texture_emissiveMapSampler : sampler;\n\t\t#endif\n\t\t#ifdef LIT_CLEARCOAT\n\t\t\t#ifdef STD_CLEARCOAT_TEXTURE_ALLOCATE\n\t\t\t\tvar texture_clearCoatMap : texture_2d<f32>;\n\t\t\t\tvar texture_clearCoatMapSampler : sampler;\n\t\t\t#endif\n\t\t\t#ifdef STD_CLEARCOATGLOSS_TEXTURE_ALLOCATE\n\t\t\t\tvar texture_clearCoatGlossMap : texture_2d<f32>;\n\t\t\t\tvar texture_clearCoatGlossMapSampler : sampler;\n\t\t\t#endif\n\t\t\t#ifdef STD_CLEARCOATNORMAL_TEXTURE_ALLOCATE\n\t\t\t\tvar texture_clearCoatNormalMap : texture_2d<f32>;\n\t\t\t\tvar texture_clearCoatNormalMapSampler : sampler;\n\t\t\t#endif\n\t\t#endif\n\t\t#ifdef LIT_GGX_SPECULAR\n\t\t\t#ifdef STD_ANISOTROPY_TEXTURE_ALLOCATE\n\t\t\t\tvar texture_anisotropyMap : texture_2d<f32>;\n\t\t\t\tvar texture_anisotropyMapSampler : sampler;\n\t\t\t#endif\n\t\t#endif\n\t\t#if defined(STD_LIGHTMAP) || defined(STD_LIGHT_VERTEX_COLOR)\n\t\t\tvar<private> dLightmap: vec3f;\n\t\t\t#ifdef STD_LIGHT_TEXTURE_ALLOCATE\n\t\t\t\tvar texture_lightMap : texture_2d<f32>;\n\t\t\t\tvar texture_lightMapSampler : sampler;\n\t\t\t#endif\n\t\t#endif\n\t#endif\n\t#include "litShaderCorePS"\n',stdFrontEndPS:'\n\t#if LIT_BLEND_TYPE != NONE || defined(LIT_ALPHA_TEST) || defined(LIT_ALPHA_TO_COVERAGE) || STD_OPACITY_DITHER != NONE\n\t\t#include "opacityPS"\n\t\t#if defined(LIT_ALPHA_TEST)\n\t\t\t#include "alphaTestPS"\n\t\t#endif\n\t\t#if STD_OPACITY_DITHER != NONE\n\t\t\t#include "opacityDitherPS"\n\t\t#endif\n\t#endif\n\t#ifdef FORWARD_PASS\n\t\t#ifdef STD_HEIGHT_MAP\n\t\t\t#include "parallaxPS"\n\t\t#endif\n\t\t#include  "diffusePS"\n\t\t#ifdef LIT_NEEDS_NORMAL\n\t\t\t#include "normalMapPS"\n\t\t#endif\n\t\t#ifdef LIT_REFRACTION\n\t\t\t#include "transmissionPS"\n\t\t\t#include "thicknessPS"\n\t\t#endif\n\t\t#ifdef LIT_IRIDESCENCE\n\t\t\t#include "iridescencePS"\n\t\t\t#include "iridescenceThicknessPS"\n\t\t#endif\n\t\t#ifdef LIT_SPECULAR_OR_REFLECTION\n\t\t\t#ifdef LIT_SHEEN\n\t\t\t\t#include "sheenPS"\n\t\t\t\t#include "sheenGlossPS"\n\t\t\t#endif\n\t\t\t#ifdef LIT_METALNESS\n\t\t\t\t#include "metalnessPS"\n\t\t\t\t#include "iorPS"\n\t\t\t#endif\n\t\t\t#ifdef LIT_SPECULARITY_FACTOR\n\t\t\t\t#include "specularityFactorPS"\n\t\t\t#endif\n\t\t\t#ifdef STD_SPECULAR_COLOR\n\t\t\t\t#include "specularPS"\n\t\t\t#else\n\t\t\t\tfn getSpecularity() { \n\t\t\t\t\tdSpecularity = vec3f(1.0, 1.0, 1.0);\n\t\t\t\t}\n\t\t\t#endif\n\t\t\t#include "glossPS"\n\t\t#endif\n\t\t#ifdef STD_AO\n\t\t\t#include "aoPS"\n\t\t#endif\n\t\t#include "emissivePS"\n\t\t#ifdef LIT_CLEARCOAT\n\t\t\t#include "clearCoatPS"\n\t\t\t#include "clearCoatGlossPS"\n\t\t\t#include "clearCoatNormalPS"\n\t\t#endif\n\t\t#if defined(LIT_SPECULAR) && defined(LIT_LIGHTING) && defined(LIT_GGX_SPECULAR)\n\t\t\t#include "anisotropyPS"\n\t\t#endif\n\t\t#if defined(STD_LIGHTMAP) || defined(STD_LIGHT_VERTEX_COLOR)\n\t\t\t#include "lightmapPS"\n\t\t#endif\n\t#endif\n\tfn evaluateFrontend() {\n\t\t#if LIT_BLEND_TYPE != NONE || defined(LIT_ALPHA_TEST) || defined(LIT_ALPHA_TO_COVERAGE) || STD_OPACITY_DITHER != NONE\n\t\t\tgetOpacity();\n\t\t\t#if defined(LIT_ALPHA_TEST)\n\t\t\t\talphaTest(dAlpha);\n\t\t\t#endif\n\t\t\t#if STD_OPACITY_DITHER != NONE\n\t\t\t\topacityDither(dAlpha, 0.0);\n\t\t\t#endif\n\t\t\tlitArgs_opacity = dAlpha;\n\t\t#endif\n\t\t#ifdef FORWARD_PASS\n\t\t\t#ifdef STD_HEIGHT_MAP\n\t\t\t\tgetParallax();\n\t\t\t#endif\n\t\t\tgetAlbedo();\n\t\t\tlitArgs_albedo = dAlbedo;\n\t\t\t#ifdef LIT_NEEDS_NORMAL\n\t\t\t\tgetNormal();\n\t\t\t\tlitArgs_worldNormal = dNormalW;\n\t\t\t#endif\n\t\t\t#ifdef LIT_REFRACTION\n\t\t\t\tgetRefraction();\n\t\t\t\tlitArgs_transmission = dTransmission;\n\t\t\t\tgetThickness();\n\t\t\t\tlitArgs_thickness = dThickness;\n\t\t\t\t#ifdef LIT_DISPERSION\n\t\t\t\t\tlitArgs_dispersion = uniform.material_dispersion;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t\t#ifdef LIT_IRIDESCENCE\n\t\t\t\tgetIridescence();\n\t\t\t\tgetIridescenceThickness();\n\t\t\t\tlitArgs_iridescence_intensity = dIridescence;\n\t\t\t\tlitArgs_iridescence_thickness = dIridescenceThickness;\n\t\t\t#endif\n\t\t\t#ifdef LIT_SPECULAR_OR_REFLECTION\n\t\t\t\t#ifdef LIT_SHEEN\n\t\t\t\t\tgetSheen();\n\t\t\t\t\tlitArgs_sheen_specularity = sSpecularity;\n\t\t\t\t\tgetSheenGlossiness();\n\t\t\t\t\tlitArgs_sheen_gloss = sGlossiness;\n\t\t\t\t#endif\n\t\t\t\t#ifdef LIT_METALNESS\n\t\t\t\t\tgetMetalness();\n\t\t\t\t\tlitArgs_metalness = dMetalness;\n\t\t\t\t\tgetIor();\n\t\t\t\t\tlitArgs_ior = dIor;\n\t\t\t\t#endif\n\t\t\t\t#ifdef LIT_SPECULARITY_FACTOR\n\t\t\t\t\tgetSpecularityFactor();\n\t\t\t\t\tlitArgs_specularityFactor = dSpecularityFactor;\n\t\t\t\t#endif\n\t\t\t\tgetGlossiness();\n\t\t\t\tgetSpecularity();\n\t\t\t\tlitArgs_specularity = dSpecularity;\n\t\t\t\tlitArgs_gloss = dGlossiness;\n\t\t\t#endif\n\t\t\t#ifdef STD_AO\n\t\t\t\tgetAO();\n\t\t\t\tlitArgs_ao = dAo;\n\t\t\t#endif\n\t\t\tgetEmission();\n\t\t\tlitArgs_emission = dEmission;\n\t\t\t#ifdef LIT_CLEARCOAT\n\t\t\t\tgetClearCoat();\n\t\t\t\tgetClearCoatGlossiness();\n\t\t\t\tgetClearCoatNormal();\n\t\t\t\tlitArgs_clearcoat_specularity = ccSpecularity;\n\t\t\t\tlitArgs_clearcoat_gloss = ccGlossiness;\n\t\t\t\tlitArgs_clearcoat_worldNormal = ccNormalW;\n\t\t\t#endif\n\t\t\t#if defined(LIT_SPECULAR) && defined(LIT_LIGHTING) && defined(LIT_GGX_SPECULAR)\n\t\t\t\tgetAnisotropy();\n\t\t\t#endif\n\t\t\t#if defined(STD_LIGHTMAP) || defined(STD_LIGHT_VERTEX_COLOR)\n\t\t\t\tgetLightMap();\n\t\t\t\tlitArgs_lightmap = dLightmap;\n\t\t\t\t#ifdef STD_LIGHTMAP_DIR\n\t\t\t\t\tlitArgs_lightmapDir = dLightmapDir;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t#endif\n\t}\n',TBNPS:"\n#ifdef LIT_TANGENTS\n\t#define TBN_TANGENTS\n#else\n\t#if defined(LIT_USE_NORMALS) || defined(LIT_USE_CLEARCOAT_NORMALS)\n\t\t#define TBN_DERIVATIVES\n\t#endif\n#endif\n#if defined(TBN_DERIVATIVES)\n\tuniform tbnBasis: f32;\n#endif\nfn getTBN(tangent: vec3f, binormal: vec3f, normal: vec3f) {\n\t#ifdef TBN_TANGENTS\n\t\tdTBN = mat3x3f(normalize(tangent), normalize(binormal), normalize(normal));\n\t#elif defined(TBN_DERIVATIVES)\n\t\tlet uv: vec2f = {lightingUv};\n\t\tlet dp1: vec3f = dpdx( vPositionW );\n\t\tlet dp2: vec3f = dpdy( vPositionW );\n\t\tlet duv1: vec2f = dpdx( uv );\n\t\tlet duv2: vec2f = dpdy( uv );\n\t\tlet dp2perp: vec3f = cross( dp2, normal );\n\t\tlet dp1perp: vec3f = cross( normal, dp1 );\n\t\tlet T: vec3f = dp2perp * duv1.x + dp1perp * duv2.x;\n\t\tlet B: vec3f = dp2perp * duv1.y + dp1perp * duv2.y;\n\t\tlet denom: f32 = max( dot(T, T), dot(B, B) );\n\t\tlet invmax: f32 = select(uniform.tbnBasis / sqrt( denom ), 0.0, denom == 0.0);\n\t\tdTBN = mat3x3f(T * invmax, -B * invmax, normal );\n\t#else\n\t\tvar B: vec3f = cross(normal, vObjectSpaceUpW);\n\t\tvar T: vec3f = cross(normal, B);\n\t\tif (dot(B,B) == 0.0)\n\t\t{\n\t\t\tlet major: f32 = max(max(normal.x, normal.y), normal.z);\n\t\t\tif (normal.x == major)\n\t\t\t{\n\t\t\t\tB = cross(normal, vec3f(0.0, 1.0, 0.0));\n\t\t\t\tT = cross(normal, B);\n\t\t\t}\n\t\t\telse if (normal.y == major)\n\t\t\t{\n\t\t\t\tB = cross(normal, vec3f(0.0, 0.0, 1.0));\n\t\t\t\tT = cross(normal, B);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tB = cross(normal, vec3f(1.0, 0.0, 0.0));\n\t\t\t\tT = cross(normal, B);\n\t\t\t}\n\t\t}\n\t\tdTBN = mat3x3f(normalize(T), normalize(B), normalize(normal));\n\t#endif\n}",thicknessPS:"\n#ifdef STD_THICKNESS_CONSTANT\nuniform material_thickness: f32;\n#endif\nfn getThickness() {\n\tdThickness = 1.0;\n\t#ifdef STD_THICKNESS_CONSTANT\n\tdThickness = dThickness * uniform.material_thickness;\n\t#endif\n\t#ifdef STD_THICKNESS_TEXTURE\n\tdThickness = dThickness * textureSampleBias({STD_THICKNESS_TEXTURE_NAME}, {STD_THICKNESS_TEXTURE_NAME}Sampler, {STD_THICKNESS_TEXTURE_UV}, uniform.textureBias).{STD_THICKNESS_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_THICKNESS_VERTEX\n\tdThickness = dThickness * saturate(vVertexColor.{STD_THICKNESS_VERTEX_CHANNEL});\n\t#endif\n}\n",tonemappingPS:'\n#if (TONEMAP == NONE)\n\t#include "tonemappingNonePS"\n#elif TONEMAP == FILMIC\n\t#include "tonemappingFilmicPS"\n#elif TONEMAP == LINEAR\n\t#include "tonemappingLinearPS"\n#elif TONEMAP == HEJL\n\t#include "tonemappingHejlPS"\n#elif TONEMAP == ACES\n\t#include "tonemappingAcesPS"\n#elif TONEMAP == ACES2\n\t#include "tonemappingAces2PS"\n#elif TONEMAP == NEUTRAL\n\t#include "tonemappingNeutralPS"\n#endif\n',tonemappingAcesPS:"\nuniform exposure: f32;\nfn toneMap(color: vec3f) -> vec3f {\n\tlet tA: f32 = 2.51;\n\tlet tB: f32 = 0.03;\n\tlet tC: f32 = 2.43;\n\tlet tD: f32 = 0.59;\n\tlet tE: f32 = 0.14;\n\tlet x: vec3f = color * uniform.exposure;\n\treturn (x * (tA * x + tB)) / (x * (tC * x + tD) + tE);\n}\n",tonemappingAces2PS:"\nuniform exposure: f32;\nconst ACESInputMat: mat3x3f = mat3x3f(\n\tvec3f(0.59719, 0.35458, 0.04823),\n\tvec3f(0.07600, 0.90834, 0.01566),\n\tvec3f(0.02840, 0.13383, 0.83777)\n);\nconst ACESOutputMat: mat3x3f = mat3x3f(\n\tvec3f( 1.60475, -0.53108, -0.07367),\n\tvec3f(-0.10208,  1.10813, -0.00605),\n\tvec3f(-0.00327, -0.07276,  1.07602)\n);\nfn RRTAndODTFit(v: vec3f) -> vec3f {\n\tlet a: vec3f = v * (v + vec3f(0.0245786)) - vec3f(0.000090537);\n\tlet b: vec3f = v * (vec3f(0.983729) * v + vec3f(0.4329510)) + vec3f(0.238081);\n\treturn a / b;\n}\nfn toneMap(color: vec3f) -> vec3f {\n\tvar c: vec3f = color * (uniform.exposure / 0.6);\n\tc = c * ACESInputMat;\n\tc = RRTAndODTFit(c);\n\tc = c * ACESOutputMat;\n\treturn clamp(c, vec3f(0.0), vec3f(1.0));\n}\n",tonemappingFilmicPS:"\nconst A: f32 = 0.15;\nconst B: f32 = 0.50;\nconst C: f32 = 0.10;\nconst D: f32 = 0.20;\nconst E: f32 = 0.02;\nconst F: f32 = 0.30;\nconst W: f32 = 11.2;\nuniform exposure: f32;\nfn uncharted2Tonemap(x: vec3f) -> vec3f {\n\treturn ((x * (A * x + C * B) + D * E) / (x * (A * x + B) + D * F)) - vec3f(E / F);\n}\nfn toneMap(color: vec3f) -> vec3f {\n\tvar c: vec3f = uncharted2Tonemap(color * uniform.exposure);\n\tlet whiteScale: vec3f = vec3f(1.0) / uncharted2Tonemap(vec3f(W, W, W));\n\tc *= whiteScale;\n\treturn c;\n}\n",tonemappingHejlPS:"\nuniform exposure: f32;\nfn toneMap(color: vec3f) -> vec3f {\n\tlet A: f32 = 0.22;\n\tlet B: f32 = 0.3;\n\tlet C: f32 = 0.1;\n\tlet D: f32 = 0.2;\n\tlet E: f32 = 0.01;\n\tlet F: f32 = 0.3;\n\tlet Scl: f32 = 1.25;\n\tlet adjusted_color = color * uniform.exposure;\n\tlet h = max(vec3f(0.0), adjusted_color - vec3f(0.004));\n\treturn (h * ((Scl * A) * h + Scl * vec3f(C * B)) + Scl * vec3f(D * E)) /\n\t\t   (h * (A * h + vec3f(B)) + vec3f(D * F)) -\n\t\t   Scl * vec3f(E / F);\n}\n",tonemappingLinearPS:"\nuniform exposure: f32;\nfn toneMap(color: vec3f) -> vec3f {\n\treturn color * uniform.exposure;\n}\n",tonemappingNeutralPS:"\nuniform exposure: f32;\nfn toneMap(col: vec3f) -> vec3f {\n\tvar color = col * uniform.exposure;\n\tlet startCompression = 0.8 - 0.04;\n\tlet desaturation = 0.15;\n\tlet x = min(color.r, min(color.g, color.b));\n\tlet offset = select(0.04, x - 6.25 * x * x, x < 0.08);\n\tcolor -= vec3f(offset);\n\tlet peak = max(color.r, max(color.g, color.b));\n\tif (peak < startCompression) {\n\t\treturn color;\n\t}\n\tlet d = 1.0 - startCompression;\n\tlet newPeak = 1.0 - d * d / (peak + d - startCompression);\n\tcolor *= newPeak / peak;\n\tlet g = 1.0 - 1.0 / (desaturation * (peak - newPeak) + 1.0);\n\treturn mix(color, vec3f(newPeak), vec3f(g));\n}\n",tonemappingNonePS:"\nfn toneMap(color: vec3f) -> vec3f {\n\treturn color;\n}\n",transformVS:"\n#ifdef PIXELSNAP\n\tuniform uScreenSize: vec4f;\n#endif\n#ifdef SCREENSPACE\n\tuniform projectionFlipY: f32;\n#endif\nfn evalWorldPosition(vertexPosition: vec3f, modelMatrix: mat4x4f) -> vec4f {\n\tvar localPos: vec3f = getLocalPosition(vertexPosition);\n\t#ifdef NINESLICED\n\t\tvar localPosXZ: vec2f = localPos.xz;\n\t\tlocalPosXZ = localPosXZ * uniform.outerScale;\n\t\tlet positiveUnitOffset: vec2f = clamp(vertexPosition.xz, vec2f(0.0), vec2f(1.0));\n\t\tlet negativeUnitOffset: vec2f = clamp(-vertexPosition.xz, vec2f(0.0), vec2f(1.0));\n\t\tlocalPosXZ = localPosXZ + (-positiveUnitOffset * uniform.innerOffset.xy + negativeUnitOffset * uniform.innerOffset.zw) * vertex_texCoord0.xy;\n\t\tdTiledUvGlobal = (localPosXZ - uniform.outerScale + uniform.innerOffset.xy) * -0.5 + 1.0;\n\t\tlocalPosXZ = localPosXZ * -0.5;\n\t\tlocalPos = vec3f(localPosXZ.x, localPosXZ.y, localPos.y);\n\t#endif\n\tvar posW: vec4f = modelMatrix * vec4f(localPos, 1.0);\n\t#ifdef SCREENSPACE\n\t\tposW = vec4f(posW.xy, 0.0, 1.0);\n\t#endif\n\treturn posW;\n}\nfn getPosition() -> vec4f {\n\tdModelMatrix = getModelMatrix();\n\tlet posW: vec4f = evalWorldPosition(vertex_position.xyz, dModelMatrix);\n\tdPositionW = posW.xyz;\n\tvar screenPos: vec4f;\n\t#ifdef UV1LAYOUT\n\t\tscreenPos = vec4f(vertex_texCoord1.xy * 2.0 - 1.0, 0.5, 1.0);\n\t\tscreenPos.y *= -1.0;\n\t#else\n\t\t#ifdef SCREENSPACE\n\t\t\tscreenPos = posW;\n\t\t\tscreenPos.y *= uniform.projectionFlipY;\n\t\t#else\n\t\t\tscreenPos = uniform.matrix_viewProjection * posW;\n\t\t#endif\n\t\t#ifdef PIXELSNAP\n\t\t\tscreenPos.xy = (screenPos.xy * 0.5) + 0.5;\n\t\t\tscreenPos.xy *= uniforms.uScreenSize.xy;\n\t\t\tscreenPos.xy = floor(screenPos.xy);\n\t\t\tscreenPos.xy *= uniforms.uScreenSize.zw;\n\t\t\tscreenPos.xy = (screenPos.xy * 2.0) - 1.0;\n\t\t#endif\n\t#endif\n\treturn screenPos;\n}\nfn getWorldPosition() -> vec3f {\n\treturn dPositionW;\n}\n",transformCoreVS:'\n\tattribute vertex_position: vec4f;\n\tuniform matrix_viewProjection: mat4x4f;\n\tuniform matrix_model: mat4x4f;\n\t\n\t#ifdef MORPHING\n\t\tuniform morph_tex_params: vec2f;\n\t\tattribute morph_vertex_id: u32;\n\t\tfn getTextureMorphCoords() -> vec2i {\n\t\t\tvar textureSize: vec2i = vec2i(uniform.morph_tex_params);\n\t\t\tvar morphGridV: i32 = i32(morph_vertex_id) / textureSize.x;\n\t\t\tvar morphGridU: i32 = i32(morph_vertex_id) - (morphGridV * textureSize.x);\n\t\t\tmorphGridV = textureSize.y - morphGridV - 1;\n\t\t\treturn vec2i(morphGridU, morphGridV);\n\t\t}\n\t\t#ifdef MORPHING_POSITION\n\t\t\t#ifdef MORPHING_INT\n\t\t\t\tuniform aabbSize: vec3f;\n\t\t\t\tuniform aabbMin: vec3f;\n\t\t\t\tvar morphPositionTex: texture_2d<u32>;\n\t\t\t#else\n\t\t\t\tvar morphPositionTex: texture_2d<f32>;\n\t\t\t#endif\n\t\t#endif\n\t#endif\n\t#ifdef defined(BATCH)\n\t\t#include "skinBatchVS"\n\t\tfn getModelMatrix() -> mat4x4f {\n\t\t\treturn getBoneMatrix(vertex_boneIndices);\n\t\t}\n\t#elif defined(SKIN)\n\t\t#include "skinVS"\n\t\tfn getModelMatrix() -> mat4x4f {\n\t\t\treturn uniform.matrix_model * getSkinMatrix(vertex_boneIndices, vertex_boneWeights);\n\t\t}\n\t#elif defined(INSTANCING)\n\t\t#include "transformInstancingVS"\n\t#else\n\t\tfn getModelMatrix() -> mat4x4f {\n\t\t\treturn uniform.matrix_model;\n\t\t}\n\t#endif\n\tfn getLocalPosition(vertexPosition: vec3f) -> vec3f {\n\t\tvar localPos: vec3f = vertexPosition;\n\t\t#ifdef MORPHING_POSITION\n\t\t\tvar morphUV: vec2i = getTextureMorphCoords();\n\t\t\t#ifdef MORPHING_INT\n\t\t\t\tvar morphPos: vec3f = vec3f(textureLoad(morphPositionTex, morphUV, 0).xyz) / 65535.0 * uniform.aabbSize + uniform.aabbMin;\n\t\t\t#else\n\t\t\t\tvar morphPos: vec3f = textureLoad(morphPositionTex, morphUV, 0).xyz;\n\t\t\t#endif\n\t\t\tlocalPos += morphPos;\n\t\t#endif\n\t\treturn localPos;\n\t}\n',transformInstancingVS:"\nattribute instance_line1: vec4f;\nattribute instance_line2: vec4f;\nattribute instance_line3: vec4f;\nattribute instance_line4: vec4f;\nfn getModelMatrix() -> mat4x4f {\n\treturn uniform.matrix_model * mat4x4f(instance_line1, instance_line2, instance_line3, instance_line4);\n}\n",transmissionPS:"\n#ifdef STD_REFRACTION_CONSTANT\n\tuniform material_refraction: f32;\n#endif\nfn getRefraction() {\n\tvar refraction: f32 = 1.0;\n\t#ifdef STD_REFRACTION_CONSTANT\n\trefraction = uniform.material_refraction;\n\t#endif\n\t#ifdef STD_REFRACTION_TEXTURE\n\trefraction = refraction * textureSampleBias({STD_REFRACTION_TEXTURE_NAME}, {STD_REFRACTION_TEXTURE_NAME}Sampler, {STD_REFRACTION_TEXTURE_UV}, uniform.textureBias).{STD_REFRACTION_TEXTURE_CHANNEL};\n\t#endif\n\t#ifdef STD_REFRACTION_VERTEX\n\trefraction = refraction * saturate(vVertexColor.{STD_REFRACTION_VERTEX_CHANNEL});\n\t#endif\n\tdTransmission = refraction;\n}\n",twoSidedLightingPS:"\nuniform twoSidedLightingNegScaleFactor: f32;\nfn handleTwoSidedLighting() {\n\tdTBN[2] = dTBN[2] * select(-uniform.twoSidedLightingNegScaleFactor, uniform.twoSidedLightingNegScaleFactor, pcFrontFacing);\n}\n",uv0VS:"\n#ifdef NINESLICED\n\tfn getUv0() -> vec2f {\n\t\tvar uv = vertex_position.xz;\n\t\tlet positiveUnitOffset = clamp(vertex_position.xz, vec2f(0.0, 0.0), vec2f(1.0, 1.0));\n\t\tlet negativeUnitOffset = clamp(-vertex_position.xz, vec2f(0.0, 0.0), vec2f(1.0, 1.0));\n\t\tuv = uv + ((-positiveUnitOffset * uniform.innerOffset.xy) + (negativeUnitOffset * uniform.innerOffset.zw)) * vertex_texCoord0.xy;\n\t\tuv = uv * -0.5 + vec2f(0.5, 0.5);\n\t\tuv = uv * uniform.atlasRect.zw + uniform.atlasRect.xy;\n\t\tdMaskGlobal = vertex_texCoord0.xy;\n\t\treturn uv;\n\t}\n#else\n\tfn getUv0() -> vec2f {\n\t\treturn vertex_texCoord0;\n\t}\n#endif\n",uv1VS:"\nfn getUv1() -> vec2f {\n\treturn vertex_texCoord1;\n}\n",uvTransformVS:"\noutput.vUV{TRANSFORM_UV_{i}}_{TRANSFORM_ID_{i}} = vec2f(\n\tdot(vec3f(uv{TRANSFORM_UV_{i}}, 1), uniform.{TRANSFORM_NAME_{i}}0),\n\tdot(vec3f(uv{TRANSFORM_UV_{i}}, 1), uniform.{TRANSFORM_NAME_{i}}1)\n);\n",uvTransformUniformsPS:"\n\tuniform {TRANSFORM_NAME_{i}}0: vec3f;\n\tuniform {TRANSFORM_NAME_{i}}1: vec3f;\n",viewDirPS:"\nfn getViewDir() {\n\tdViewDirW = normalize(uniform.view_position - vPositionW);\n}\n",webgpuPS:"\n",webgpuVS:Pa};class ag extends Ve{constructor(t){super(),this._batcher=null,this._destroyRequested=!1,this._inFrameUpdate=!1,this._librariesLoaded=!1,this._fillMode=pm,this._resolutionMode="FIXED",this._allowResize=!0,this._skyboxAsset=null,this._entityIndex={},this._inTools=!1,this._scriptPrefix="",this._time=0,this.enableBundles="undefined"!=typeof TextDecoder,this.timeScale=1,this.maxDeltaTime=.1,this.frame=0,this.frameGraph=new ym,this.scriptsOrder=[],this.autoRender=!0,this.renderNextFrame=!1,this.lightmapper=null,this.loader=new jm(this),this.scenes=new sg(this),this.scripts=new qm(this),this.systems=new Um,this.i18n=new Xm(this),this.keyboard=null,this.mouse=null,this.touch=null,this.gamepads=null,this.elementInput=null,this.xr=null,ag._applications[t.id]=this,vm(this),this.root=new Jm,this.root._enabledInHierarchy=!0}init(t){const{assetPrefix:e,batchManager:s,componentSystems:n,elementInput:i,gamepads:r,graphicsDevice:a,keyboard:o,lightmapper:l,mouse:h,resourceHandlers:c,scriptsOrder:d,scriptPrefix:u,soundManager:f,touch:p,xr:m}=t;this.graphicsDevice=a,Fh.get(a,In).add(ig),Fh.get(a,Rn).add(rg),this._initDefaultMaterial(),this._initProgramLibrary(),this.stats=new ng(a),this._soundManager=f,this.scene=new Vf(a),this._registerSceneImmediate(this.scene),this.assets=new Bm(this.loader),e&&(this.assets.prefix=e),this.bundles=new zm(this.assets),this.scriptsOrder=d||[],this.defaultLayerWorld=new Ru({name:"World",id:0}),this.defaultLayerDepth=new Ru({name:"Depth",id:1,enabled:!1,opaqueSortMode:0}),this.defaultLayerSkybox=new Ru({name:"Skybox",id:2,opaqueSortMode:0}),this.defaultLayerUi=new Ru({name:"UI",id:4,transparentSortMode:1}),this.defaultLayerImmediate=new Ru({name:"Immediate",id:3,opaqueSortMode:0});const g=new Ou("default");g.pushOpaque(this.defaultLayerWorld),g.pushOpaque(this.defaultLayerDepth),g.pushOpaque(this.defaultLayerSkybox),g.pushTransparent(this.defaultLayerWorld),g.pushOpaque(this.defaultLayerImmediate),g.pushTransparent(this.defaultLayerImmediate),g.pushTransparent(this.defaultLayerUi),this.scene.layers=g,xm.createPlaceholder(a),this.renderer=new Eu(a,this.scene),l&&(this.lightmapper=new l(a,this.root,this.scene,this.renderer,this.assets),this.once("prerender",this._firstBake,this)),s&&(this._batcher=new s(a,this.root,this.scene),this.once("prerender",this._firstBatch,this)),this.keyboard=o||null,this.mouse=h||null,this.touch=p||null,this.gamepads=r||null,i&&(this.elementInput=i,this.elementInput.app=this),this.xr=m?new m(this):null,this.elementInput&&this.elementInput.attachSelectEvents(),this._scriptPrefix=u||"",this.enableBundles&&this.loader.addHandler("bundle",new Wm(this)),c.forEach(t=>{const e=new t(this);this.loader.addHandler(e.handlerType,e)}),n.forEach(t=>{this.systems.add(new t(this))}),this._visibilityChangeHandler=this.onVisibilityChange.bind(this),"undefined"!=typeof document&&(void 0!==document.hidden?(this._hiddenAttr="hidden",document.addEventListener("visibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.mozHidden?(this._hiddenAttr="mozHidden",document.addEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.msHidden?(this._hiddenAttr="msHidden",document.addEventListener("msvisibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.webkitHidden&&(this._hiddenAttr="webkitHidden",document.addEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1))),this.tick=og(this)}static{this._applications={}}static getApplication(t){return t?ag._applications[t]:_m()}_initDefaultMaterial(){const t=new hp;t.name="Default Material",function(t,e){ec.get(t,()=>e)}(this.graphicsDevice,t)}_initProgramLibrary(){const t=new Dp(this.graphicsDevice,new hp);!function(t,e){Dh.get(t,()=>e)}(this.graphicsDevice,t)}get soundManager(){return this._soundManager}get batcher(){return this._batcher}get fillMode(){return this._fillMode}get resolutionMode(){return this._resolutionMode}configure(t,e){hl.get(t,(t,s)=>{if(t)return void e(t);const n=s.application_properties,i=s.scenes,r=s.assets;this._parseApplicationProperties(n,t=>{this._parseScenes(i),this._parseAssets(r),e(t||null)})})}preload(t){this.fire("preload:start");const e=this.assets.list({preload:!0});if(0===e.length)return this.fire("preload:end"),void t();let s=0;const n=()=>{s++,this.fire("preload:progress",s/e.length),s===e.length&&(this.fire("preload:end"),t())};e.forEach(t=>{t.loaded?n():(t.once("load",n),t.once("error",n),this.assets.load(t))})}_preloadScripts(t,e){e()}_parseApplicationProperties(t,e){if("number"==typeof t.maxAssetRetries&&t.maxAssetRetries>0&&this.loader.enableRetry(t.maxAssetRetries),t.useDevicePixelRatio||(t.useDevicePixelRatio=t.use_device_pixel_ratio),t.resolutionMode||(t.resolutionMode=t.resolution_mode),t.fillMode||(t.fillMode=t.fill_mode),this._width=t.width,this._height=t.height,t.useDevicePixelRatio&&(this.graphicsDevice.maxPixelRatio=window.devicePixelRatio),this.setCanvasResolution(t.resolutionMode,this._width,this._height),this.setCanvasFillMode(t.fillMode,this._width,this._height),t.layers&&t.layerOrder){const e=new Ou("application"),s={};for(const e in t.layers){const n=t.layers[e];n.id=parseInt(e,10),n.enabled=1!==n.id,s[e]=new Ru(n)}for(let n=0,i=t.layerOrder.length;n<i;n++){const i=t.layerOrder[n],r=s[i.layer];r&&(i.transparent?e.pushTransparent(r):e.pushOpaque(r),e.subLayerEnabled[n]=i.enabled)}this.scene.layers=e}if(t.batchGroups){const e=this.batcher;if(e)for(let s=0,n=t.batchGroups.length;s<n;s++){const n=t.batchGroups[s];e.addGroup(n.name,n.dynamic,n.maxAabbSize,n.id,n.layers)}}t.i18nAssets&&(this.i18n.assets=t.i18nAssets),this._loadLibraries(t.libraries,e)}_loadLibraries(t,e){const s=t.length;let n=s;const i=/^https?:\/\//;if(s){const r=(t,s)=>{n--,t?e(t):0===n&&(this.onLibrariesLoaded(),e(null))};for(let e=0;e<s;++e){let s=t[e];!i.test(s.toLowerCase())&&this._scriptPrefix&&(s=Me.join(this._scriptPrefix,s)),this.loader.load(s,"script",r)}}else this.onLibrariesLoaded(),e(null)}_parseScenes(t){if(t)for(let e=0;e<t.length;e++)this.scenes.add(t[e].name,t[e].url)}_parseAssets(t){const e=[],s={},n={};for(let n=0;n<this.scriptsOrder.length;n++){const i=this.scriptsOrder[n];t[i]&&(s[i]=!0,e.push(t[i]))}if(this.enableBundles)for(const s in t)"bundle"===t[s].type&&(n[s]=!0,e.push(t[s]));for(const i in t)s[i]||n[i]||e.push(t[i]);for(let t=0;t<e.length;t++){const s=e[t],n=new Fm(s.name,s.type,s.file,s.data);if(n.id=parseInt(s.id,10),n.preload=!!s.preload&&s.preload,n.loaded="script"===s.type&&s.data&&s.data.loadingType>0,n.tags.add(s.tags),s.i18n)for(const t in s.i18n)n.addLocalizedAssetId(t,s.i18n[t]);this.assets.add(n)}}start(){this.frame=0,this.fire("start",{timestamp:Xe(),target:this}),this._librariesLoaded||this.onLibrariesLoaded(),this.systems.fire("initialize",this.root),this.fire("initialize"),this.systems.fire("postInitialize",this.root),this.systems.fire("postPostInitialize",this.root),this.fire("postinitialize"),this.requestAnimationFrame()}requestAnimationFrame(){this.xr?.session?this.frameRequestId=this.xr.session.requestAnimationFrame(this.tick):this.frameRequestId=ze.browser||ze.worker?requestAnimationFrame(this.tick):null}inputUpdate(t){this.controller&&this.controller.update(t),this.mouse&&this.mouse.update(),this.keyboard&&this.keyboard.update(),this.gamepads&&this.gamepads.update()}update(t){this.frame++,this.graphicsDevice.update(),this.systems.fire(this._inTools?"toolsUpdate":"update",t),this.systems.fire("animationUpdate",t),this.systems.fire("postUpdate",t),this.fire("update",t),this.inputUpdate(t)}render(){this.updateCanvasSize(),this.graphicsDevice.frameStart(),this.fire("prerender"),this.root.syncHierarchy(),this._batcher&&this._batcher.updateAll(),this.renderComposition(this.scene.layers),this.fire("postrender"),this.graphicsDevice.frameEnd()}renderComposition(t){this.renderer.update(t),this.renderer.buildFrameGraph(this.frameGraph,t),this.frameGraph.render(this.graphicsDevice)}_fillFrameStatsBasic(t,e,s){const n=this.stats.frame;n.dt=e,n.ms=s,t>n._timeToCountFrames?(n.fps=n._fpsAccum,n._fpsAccum=0,n._timeToCountFrames=t+1e3):n._fpsAccum++,this.stats.drawCalls.total=this.graphicsDevice._drawCallsPerFrame,this.graphicsDevice._drawCallsPerFrame=0,n.gsplats=this.renderer._gsplatCount}_fillFrameStats(){let t=this.stats.frame;t.cameras=this.renderer._camerasRendered,t.materials=this.renderer._materialSwitches,t.shaders=this.graphicsDevice._shaderSwitchesPerFrame,t.shadowMapUpdates=this.renderer._shadowMapUpdates,t.shadowMapTime=this.renderer._shadowMapTime,t.depthMapTime=this.renderer._depthMapTime,t.forwardTime=this.renderer._forwardTime;const e=this.graphicsDevice._primsPerFrame;t.triangles=e[4]/3+Math.max(e[5]-2,0)+Math.max(e[6]-2,0),t.cullTime=this.renderer._cullTime,t.sortTime=this.renderer._sortTime,t.skinTime=this.renderer._skinTime,t.morphTime=this.renderer._morphTime,t.lightClusters=this.renderer._lightClusters,t.lightClustersTime=this.renderer._lightClustersTime,t.otherPrimitives=0;for(let s=0;s<e.length;s++)s<4&&(t.otherPrimitives+=e[s]),e[s]=0;this.renderer._camerasRendered=0,this.renderer._materialSwitches=0,this.renderer._shadowMapUpdates=0,this.graphicsDevice._shaderSwitchesPerFrame=0,this.renderer._cullTime=0,this.renderer._layerCompositionUpdateTime=0,this.renderer._lightClustersTime=0,this.renderer._sortTime=0,this.renderer._skinTime=0,this.renderer._morphTime=0,this.renderer._shadowMapTime=0,this.renderer._depthMapTime=0,this.renderer._forwardTime=0,t=this.stats.drawCalls,t.forward=this.renderer._forwardDrawCalls,t.culled=this.renderer._numDrawCallsCulled,t.depth=0,t.shadow=this.renderer._shadowDrawCalls,t.skinned=this.renderer._skinDrawCalls,t.immediate=0,t.instanced=0,t.removedByInstancing=0,t.misc=t.total-(t.forward+t.shadow),this.renderer._depthDrawCalls=0,this.renderer._shadowDrawCalls=0,this.renderer._forwardDrawCalls=0,this.renderer._numDrawCallsCulled=0,this.renderer._skinDrawCalls=0,this.renderer._immediateRendered=0,this.renderer._instancedDrawCalls=0,this.stats.misc.renderTargetCreationTime=this.graphicsDevice.renderTargetCreationTime,t=this.stats.particles,t.updatesPerFrame=t._updatesPerFrame,t.frameTime=t._frameTime,t._updatesPerFrame=0,t._frameTime=0}setCanvasFillMode(t,e,s){this._fillMode=t,this.resizeCanvas(e,s)}setCanvasResolution(t,e,s){this._resolutionMode=t,t===mm&&void 0===e&&(e=this.graphicsDevice.canvas.clientWidth,s=this.graphicsDevice.canvas.clientHeight),this.graphicsDevice.resizeCanvas(e,s)}isHidden(){return document[this._hiddenAttr]}onVisibilityChange(){this.isHidden()?this._soundManager&&this._soundManager.suspend():this._soundManager&&this._soundManager.resume()}resizeCanvas(t,e){if(!this._allowResize)return;if(this.xr&&this.xr.session)return;const s=window.innerWidth,n=window.innerHeight;if(this._fillMode===pm){const i=this.graphicsDevice.canvas.width/this.graphicsDevice.canvas.height;i>s/n?e=(t=s)/i:t=(e=n)*i}else"FILL_WINDOW"===this._fillMode&&(t=s,e=n);return this.graphicsDevice.canvas.style.width=`${t}px`,this.graphicsDevice.canvas.style.height=`${e}px`,this.updateCanvasSize(),{width:t,height:e}}updateCanvasSize(){if(this._allowResize&&!this.xr?.active&&this._resolutionMode===mm){const t=this.graphicsDevice.canvas;this.graphicsDevice.resizeCanvas(t.clientWidth,t.clientHeight)}}onLibrariesLoaded(){this._librariesLoaded=!0,this.systems.rigidbody&&this.systems.rigidbody.onLibraryLoaded()}applySceneSettings(t){let e;if(this.systems.rigidbody&&"undefined"!=typeof Ammo){const[e,s,n]=t.physics.gravity;this.systems.rigidbody.gravity.set(e,s,n)}this.scene.applySettings(t),t.render.hasOwnProperty("skybox")&&(t.render.skybox?(e=this.assets.get(t.render.skybox),e?this.setSkybox(e):this.assets.once(`add:${t.render.skybox}`,this.setSkybox,this)):this.setSkybox(null))}setAreaLightLuts(t,e){t&&e&&xm.set(this.graphicsDevice,t,e)}setSkybox(t){if(t!==this._skyboxAsset){const e=()=>{this.setSkybox(null)},s=()=>{this.scene.setSkybox(this._skyboxAsset?this._skyboxAsset.resources:null)};this._skyboxAsset&&(this.assets.off(`load:${this._skyboxAsset.id}`,s,this),this.assets.off(`remove:${this._skyboxAsset.id}`,e,this),this._skyboxAsset.off("change",s,this)),this._skyboxAsset=t,this._skyboxAsset&&(this.assets.on(`load:${this._skyboxAsset.id}`,s,this),this.assets.once(`remove:${this._skyboxAsset.id}`,e,this),this._skyboxAsset.on("change",s,this),0!==this.scene.skyboxMip||this._skyboxAsset.loadFaces||(this._skyboxAsset.loadFaces=!0),this.assets.load(this._skyboxAsset)),s()}}_firstBake(){this.lightmapper?.bake(null,this.scene.lightmapMode)}_firstBatch(){this.batcher?.generate()}_processTimestamp(t){return t}drawLine(t,e,s,n,i){this.scene.drawLine(t,e,s,n,i)}drawLines(t,e,s=!0,n=this.scene.defaultDrawLayer){this.scene.drawLines(t,e,s,n)}drawLineArrays(t,e,s=!0,n=this.scene.defaultDrawLayer){this.scene.drawLineArrays(t,e,s,n)}drawWireSphere(t,e,s=Ze.WHITE,n=20,i=!0,r=this.scene.defaultDrawLayer){this.scene.immediate.drawWireSphere(t,e,s,n,i,r)}drawWireAlignedBox(t,e,s=Ze.WHITE,n=!0,i=this.scene.defaultDrawLayer,r){this.scene.immediate.drawWireAlignedBox(t,e,s,n,i,r)}drawMeshInstance(t,e=this.scene.defaultDrawLayer){this.scene.immediate.drawMesh(null,null,null,t,e)}drawMesh(t,e,s,n=this.scene.defaultDrawLayer){this.scene.immediate.drawMesh(e,s,t,null,n)}drawQuad(t,e,s=this.scene.defaultDrawLayer){this.scene.immediate.drawMesh(e,t,this.scene.immediate.getQuadMesh(),null,s)}drawTexture(t,e,s,n,i,r,a=this.scene.defaultDrawLayer,o=!0){if(!1===o&&!this.graphicsDevice.isWebGPU)return;const l=new ps;l.setTRS(new rs(t,e,0),ms.IDENTITY,new rs(s,-n,0)),r||((r=new Ju).cull=0,r.setParameter("colorMap",i),r.shaderDesc=o?this.scene.immediate.getTextureShaderDesc(i.encoding):this.scene.immediate.getUnfilterableTextureShaderDesc(),r.update()),this.drawQuad(l,r,a)}drawDepthTexture(t,e,s,n,i=this.scene.defaultDrawLayer){const r=new Ju;r.cull=0,r.shaderDesc=this.scene.immediate.getDepthTextureShaderDesc(),r.update(),this.drawTexture(t,e,s,n,null,r,i)}destroy(){if(this._inFrameUpdate)return void(this._destroyRequested=!0);const t=this.graphicsDevice.canvas.id;this.fire("destroy",this),this.off("librariesloaded"),"undefined"!=typeof document&&(document.removeEventListener("visibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("msvisibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1)),this._visibilityChangeHandler=null,this.root.destroy(),this.root=null,this.mouse&&(this.mouse.off(),this.mouse.detach(),this.mouse=null),this.keyboard&&(this.keyboard.off(),this.keyboard.detach(),this.keyboard=null),this.touch&&(this.touch.off(),this.touch.detach(),this.touch=null),this.elementInput&&(this.elementInput.detach(),this.elementInput=null),this.gamepads&&(this.gamepads.destroy(),this.gamepads=null),this.controller&&(this.controller=null),this.systems.destroy(),this.scene.layers&&this.scene.layers.destroy(),this.bundles.destroy(),this.bundles=null,this.i18n.destroy(),this.i18n=null;const e=this.loader.getHandler("script");e?.clearCache(),this.loader.destroy(),this.loader=null,this.systems=null,this.context=null,this.scripts.destroy(),this.scripts=null,this.scenes.destroy(),this.scenes=null,this.lightmapper?.destroy(),this.lightmapper=null,this._batcher&&(this._batcher.destroy(),this._batcher=null),this._entityIndex={},this.defaultLayerDepth.onDisable=null,this.defaultLayerDepth.onEnable=null,this.defaultLayerDepth=null,this.defaultLayerWorld=null,this.xr?.end(),this.xr?.destroy(),this.renderer.destroy(),this.renderer=null;const s=this.assets.list();for(let t=0;t<s.length;t++)s[t].unload(),s[t].off();this.assets.off(),this.scene.destroy(),this.scene=null,this.graphicsDevice.destroy(),this.graphicsDevice=null,this.tick=null,this.off(),this._soundManager?.destroy(),this._soundManager=null,ag._applications[t]=null,_m()===this&&vm(null),ag.cancelTick(this)}static cancelTick(t){t.frameRequestId&&(cancelAnimationFrame(t.frameRequestId),t.frameRequestId=void 0)}getEntityFromIndex(t){return this._entityIndex[t]}_registerSceneImmediate(t){this.on("postrender",t.immediate.onPostRender,t.immediate)}}const og=function(t){const e=t;return function(t,s){if(!e.graphicsDevice)return;e.frameRequestId&&(e.xr?.session?.cancelAnimationFrame(e.frameRequestId),cancelAnimationFrame(e.frameRequestId),e.frameRequestId=null),e._inFrameUpdate=!0,vm(e);const n=e._processTimestamp(t)||Xe(),i=n-(e._time||n);let r=i/1e3;if(r=Qe.clamp(r,0,e.maxDeltaTime),r*=e.timeScale,e._time=n,e.requestAnimationFrame(),e.graphicsDevice.contextLost)return;e._fillFrameStatsBasic(n,r,i),e.fire("frameupdate",i);let a=!1;s?(a=!e.xr?.update(s),e.graphicsDevice.defaultFramebuffer=s.session.renderState.baseLayer.framebuffer):e.graphicsDevice.defaultFramebuffer=null,a||(e.update(r),e.fire("framerender"),(e.autoRender||e.renderNextFrame)&&(e.render(),e.renderNextFrame=!1),e.fire("frameend")),e._inFrameUpdate=!1,e._destroyRequested&&e.destroy()}};class lg{constructor(){this.componentSystems=[],this.resourceHandlers=[]}}const hg=new Ts;class cg{constructor(t,e,s){this.scene=t,this.light=e,this.store(),e.numCascades=1,this.scene.clusteredLightingEnabled&&!s.shadowsEnabled&&(e.castShadows=!1),0!==e.type&&(e._node.getWorldTransform(),e.getBoundingSphere(hg),this.lightBounds=new Ss,this.lightBounds.center.copy(hg.center),this.lightBounds.halfExtents.set(hg.radius,hg.radius,hg.radius))}store(){this.mask=this.light.mask,this.shadowUpdateMode=this.light.shadowUpdateMode,this.enabled=this.light.enabled,this.intensity=this.light.intensity,this.rotation=this.light._node.getLocalRotation().clone(),this.numCascades=this.light.numCascades,this.castShadows=this.light._castShadows}restore(){const t=this.light;t.mask=this.mask,t.shadowUpdateMode=this.shadowUpdateMode,t.enabled=this.enabled,t.intensity=this.intensity,t._node.setLocalRotation(this.rotation),t.numCascades=this.numCascades,t._castShadows=this.castShadows}startBake(){this.light.enabled=!0,this.light._destroyShadowMap(),this.light.beginFrame()}endBake(t){const e=this.light;e.enabled=!1,e.shadowMap&&(e.shadowMap.cached&&t.add(e,e.shadowMap),e.shadowMap=null)}}const dg=new os;class ug extends cg{constructor(t,e){super(t.scene,e,t.lightingParams)}get numVirtualLights(){return 0===this.light.type?this.light.bakeNumSamples:1}prepareVirtualLight(t,e){const s=this.light;if(s._node.setLocalRotation(this.rotation),t>0){const n=s.bakeArea;Sf.circlePointDeterministic(dg,t,e),dg.mulScalar(.5*n),s._node.rotateLocal(dg.x,0,dg.y)}s._node.getWorldTransform();const n=Math.pow(this.intensity,2.2);s.intensity=Math.pow(n/e,1/2.2)}}const fg=new rs;class pg extends cg{constructor(t){const e=t.scene,s=new Jm("AmbientLight");s.addComponent("light",{type:"directional",affectDynamic:!0,affectLightmapped:!1,bake:!0,bakeNumSamples:e.ambientBakeNumSamples,castShadows:!0,normalOffsetBias:.05,shadowBias:.2,shadowDistance:1,shadowResolution:2048,shadowType:0,color:Ze.WHITE,intensity:1,bakeDir:!1}),super(e,s.light.light,t.lightingParams)}get numVirtualLights(){return this.light.bakeNumSamples}prepareVirtualLight(t,e){Sf.spherePointDeterministic(fg,t,e,0,this.scene.ambientBakeSpherePart),this.light._node.lookAt(fg.mulScalar(-1)),this.light._node.rotateLocal(90,0,0);const s=2*Math.PI*this.scene.ambientBakeSpherePart,n=Math.pow(s,2.2);this.light.intensity=Math.pow(n/e,1/2.2)}}class mg{constructor(t,e=null){this.node=t,this.component=t.render||t.model,e=e||this.component.meshInstances,this.store(),this.meshInstances=e,this.bounds=null,this.renderTargets=[]}store(){this.castShadows=this.component.castShadows}restore(){this.component.castShadows=this.castShadows}}const gg={glslBilateralDeNoisePS:"\nfloat normpdf3(in vec3 v, in float sigma) {\n\treturn 0.39894 * exp(-0.5 * dot(v, v) / (sigma * sigma)) / sigma;\n}\nvec3 decodeRGBM(vec4 rgbm) {\n\tvec3 color = (8.0 * rgbm.a) * rgbm.rgb;\n\treturn color * color;\n}\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec4 encodeRGBM(vec3 color) {\n\tvec4 encoded;\n\tencoded.rgb = pow(color.rgb, vec3(0.5));\n\tencoded.rgb *= 1.0 / 8.0;\n\tencoded.a = saturate( max( max( encoded.r, encoded.g ), max( encoded.b, 1.0 / 255.0 ) ) );\n\tencoded.a = ceil(encoded.a * 255.0) / 255.0;\n\tencoded.rgb /= encoded.a;\n\treturn encoded;\n}\nvec3 decode(vec4 pixel) {\n\t#if HDR\n\t\treturn pixel.rgb;\n\t#else\n\t\treturn decodeRGBM(pixel);\n\t#endif\n}\nbool isUsed(vec4 pixel) {\n\t#if HDR\n\t\treturn any(greaterThan(pixel.rgb, vec3(0.0)));\n\t#else\n\t\treturn pixel.a > 0.0;\n\t#endif\n}\nvarying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\nuniform vec2 sigmas;\nuniform float bZnorm;\nuniform float kernel[{MSIZE}];\nvoid main(void) {\n\t\n\tvec4 pixel = texture2DLod(source, vUv0, 0.0);\n\tif (!isUsed(pixel)) {\n\t\tgl_FragColor = pixel;\n\t\treturn ;\n\t}\n\tfloat sigma = sigmas.x;\n\tfloat bSigma = sigmas.y;\n\tvec3 pixelHdr = decode(pixel);\n\tvec3 accumulatedHdr = vec3(0.0);\n\tfloat accumulatedFactor = 0.000001;\n\tconst int kSize = ({MSIZE} - 1) / 2;\n\tfor (int i = -kSize; i <= kSize; ++i) {\n\t\tfor (int j = -kSize; j <= kSize; ++j) {\n\t\t\t\n\t\t\tvec2 coord = vUv0 + vec2(float(i), float(j)) * pixelOffset;\n\t\t\tvec4 pix = texture2DLod(source, coord, 0.0);\n\t\t\tif (isUsed(pix)) {\n\t\t\t\tvec3 hdr = decode(pix);\n\t\t\t\tfloat factor = kernel[kSize + j] * kernel[kSize + i];\n\t\t\t\tfactor *= normpdf3(hdr - pixelHdr, bSigma) * bZnorm;\n\t\t\t\taccumulatedHdr += factor * hdr;\n\t\t\t\taccumulatedFactor += factor;\n\t\t\t}\n\t\t}\n\t}\n\tvec3 finalHDR = accumulatedHdr / accumulatedFactor;\n\t#if HDR\n\t\tgl_FragColor = vec4(finalHDR, 1.0);\n\t#else\n\t\tgl_FragColor = encodeRGBM(finalHDR);\n\t#endif\n}\n",glslDilatePS:"\nvarying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\nbool isUsed(vec4 pixel) {\n\t#if HDR\n\t\treturn any(greaterThan(pixel.rgb, vec3(0.0)));\n\t#else\n\t\treturn pixel.a > 0.0;\n\t#endif\n}\nvoid main(void) {\n\tvec4 c = texture2DLod(source, vUv0, 0.0);\n\tc = isUsed(c) ? c : texture2DLod(source, vUv0 - pixelOffset, 0.0);\n\tc = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(0, -pixelOffset.y), 0.0);\n\tc = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(pixelOffset.x, -pixelOffset.y), 0.0);\n\tc = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(-pixelOffset.x, 0), 0.0);\n\tc = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(pixelOffset.x, 0), 0.0);\n\tc = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(-pixelOffset.x, pixelOffset.y), 0.0);\n\tc = isUsed(c) ? c : texture2DLod(source, vUv0 + vec2(0, pixelOffset.y), 0.0);\n\tc = isUsed(c) ? c : texture2DLod(source, vUv0 + pixelOffset, 0.0);\n\tgl_FragColor = c;\n}\n"},_g={wgslBilateralDeNoisePS:"\nfn normpdf3(v: vec3f, sigma: f32) -> f32 {\n\treturn 0.39894 * exp(-0.5 * dot(v, v) / (sigma * sigma)) / sigma;\n}\nfn decodeRGBM(rgbm: vec4f) -> vec3f {\n\tlet color = (8.0 * rgbm.a) * rgbm.rgb;\n\treturn color * color;\n}\nfn saturate(x: f32) -> f32 {\n\treturn clamp(x, 0.0, 1.0);\n}\nfn encodeRGBM(color: vec3f) -> vec4f {\n\tvar encoded: vec4f;\n\tlet rgb_processed = pow(color.rgb, vec3f(0.5)) * (1.0 / 8.0);\n\tencoded = vec4f(rgb_processed, 0.0);\n\tlet max_g_b = max( encoded.g, max( encoded.b, 1.0 / 255.0 ) );\n\tlet max_rgb = max( encoded.r, max_g_b );\n\tencoded.a = clamp(max_rgb, 0.0, 1.0);\n\tencoded.a = ceil(encoded.a * 255.0) / 255.0;\n\tencoded = vec4f(encoded.rgb / encoded.a, encoded.a);\n\treturn encoded;\n}\nfn decode(pixel: vec4f) -> vec3f {\n\t#if HDR\n\t\treturn pixel.rgb;\n\t#else\n\t\treturn decodeRGBM(pixel);\n\t#endif\n}\nfn isUsed(pixel: vec4f) -> bool {\n\t#if HDR\n\t\treturn any(pixel.rgb > vec3f(0.0));\n\t#else\n\t\treturn pixel.a > 0.0;\n\t#endif\n}\nvarying vUv0: vec2f;\nvar source: texture_2d<f32>;\nvar sourceSampler: sampler;\nuniform kernel: array<f32, {MSIZE}>;\nuniform pixelOffset: vec2f;\nuniform sigmas: vec2f;\nuniform bZnorm: f32;\n@fragment\nfn fragmentMain(input: FragmentInput) -> FragmentOutput {\n\tvar output: FragmentOutput;\n\tlet pixel = textureSampleLevel(source, sourceSampler, input.vUv0, 0.0);\n\tif (!isUsed(pixel)) {\n\t\toutput.color = pixel;\n\t\treturn output;\n\t}\n\tlet sigma = uniform.sigmas.x;\n\tlet bSigma = uniform.sigmas.y;\n\tlet pixelHdr = decode(pixel);\n\tvar accumulatedHdr = vec3f(0.0);\n\tvar accumulatedFactor = 0.000001;\n\tconst kSize = ({MSIZE} - 1) / 2;\n\tfor (var i: i32 = -kSize; i <= kSize; i = i + 1) {\n\t\tfor (var j: i32 = -kSize; j <= kSize; j = j + 1) {\n\t\t\tlet coord = input.vUv0 + vec2f(f32(i), f32(j)) * uniform.pixelOffset;\n\t\t\tlet pix = textureSampleLevel(source, sourceSampler, coord, 0.0);\n\t\t\tif (isUsed(pix)) {\n\t\t\t\tlet hdr = decode(pix);\n\t\t\t\tvar factor = uniform.kernel[u32(kSize + j)].element * uniform.kernel[u32(kSize + i)].element;\n\t\t\t\tfactor = factor * normpdf3(hdr - pixelHdr, bSigma) * uniform.bZnorm;\n\t\t\t\taccumulatedHdr = accumulatedHdr + factor * hdr;\n\t\t\t\taccumulatedFactor = accumulatedFactor + factor;\n\t\t\t}\n\t\t}\n\t}\n\tlet finalHDR = accumulatedHdr / accumulatedFactor;\n\t#if HDR\n\t\toutput.color = vec4f(finalHDR, 1.0);\n\t#else\n\t\toutput.color = encodeRGBM(finalHDR);\n\t#endif\n\treturn output;\n}\n",wgslDilatePS:"\nvarying vUv0: vec2f;\nvar source: texture_2d<f32>;\nvar sourceSampler: sampler;\nuniform pixelOffset: vec2f;\nfn isUsed(pixel: vec4f) -> bool {\n\t#ifdef HDR\n\t\treturn any(pixel.rgb > vec3f(0.0));\n\t#else\n\t\treturn pixel.a > 0.0;\n\t#endif\n}\n@fragment\nfn fragmentMain(input: FragmentInput) -> FragmentOutput {\n\tvar c: vec4f = textureSampleLevel(source, sourceSampler, input.vUv0, 0.0);\n\tc = select(textureSampleLevel(source, sourceSampler, input.vUv0 - uniform.pixelOffset, 0.0), c, isUsed(c));\n\tc = select(textureSampleLevel(source, sourceSampler, input.vUv0 + vec2f(0.0, -uniform.pixelOffset.y), 0.0), c, isUsed(c));\n\tc = select(textureSampleLevel(source, sourceSampler, input.vUv0 + vec2f(uniform.pixelOffset.x, -uniform.pixelOffset.y), 0.0), c, isUsed(c));\n\tc = select(textureSampleLevel(source, sourceSampler, input.vUv0 + vec2f(-uniform.pixelOffset.x, 0.0), 0.0), c, isUsed(c));\n\tc = select(textureSampleLevel(source, sourceSampler, input.vUv0 + vec2f(uniform.pixelOffset.x, 0.0), 0.0), c, isUsed(c));\n\tc = select(textureSampleLevel(source, sourceSampler, input.vUv0 + vec2f(-uniform.pixelOffset.x, uniform.pixelOffset.y), 0.0), c, isUsed(c));\n\tc = select(textureSampleLevel(source, sourceSampler, input.vUv0 + vec2f(0.0, uniform.pixelOffset.y), 0.0), c, isUsed(c));\n\tc = select(textureSampleLevel(source, sourceSampler, input.vUv0 + uniform.pixelOffset, 0.0), c, isUsed(c));\n\tvar output: FragmentOutput;\n\toutput.color = c;\n\treturn output;\n}\n"};class vg{constructor(t){this.shaderDilate=[],this.shaderDenoise=[],this.device=t,Fh.get(this.device,In).add(gg),Fh.get(this.device,Rn).add(_g),this.constantTexSource=t.scope.resolve("source"),this.constantPixelOffset=t.scope.resolve("pixelOffset"),this.pixelOffset=new Float32Array(2),this.sigmas=null,this.constantSigmas=null,this.kernel=null}setSourceTexture(t){this.constantTexSource.setValue(t)}prepare(t,e){this.pixelOffset[0]=1/t,this.pixelOffset[1]=1/e,this.constantPixelOffset.setValue(this.pixelOffset)}prepareDenoise(t,e,s){const n=s?0:1;if(!this.shaderDenoise[n]){const t=new Map;t.set("{MSIZE}",15),s&&t.set("HDR",""),this.shaderDenoise[n]=zh.createShader(this.device,{uniqueName:"lmBilateralDeNoise-"+(s?"hdr":"rgbm"),attributes:{vertex_position:Ys},vertexGLSL:Fh.get(this.device,In).get("fullscreenQuadVS"),vertexWGSL:Fh.get(this.device,Rn).get("fullscreenQuadVS"),fragmentGLSL:Fh.get(this.device,In).get("glslBilateralDeNoisePS"),fragmentWGSL:Fh.get(this.device,Rn).get("wgslBilateralDeNoisePS"),fragmentDefines:t}),this.sigmas=new Float32Array(2),this.constantSigmas=this.device.scope.resolve("sigmas"),this.constantKernel=this.device.scope.resolve("kernel[0]"),this.bZnorm=this.device.scope.resolve("bZnorm")}this.sigmas[0]=t,this.sigmas[1]=e,this.constantSigmas.setValue(this.sigmas),this.evaluateDenoiseUniforms(t,e)}getDenoise(t){const e=t?0:1;return this.shaderDenoise[e]}getDilate(t,e){const s=e?0:1;if(!this.shaderDilate[s]){const n=e?"#define HDR\n":"";this.shaderDilate[s]=zh.createShader(t,{uniqueName:"lmDilate-"+(e?"hdr":"rgbm"),attributes:{vertex_position:Ys},vertexGLSL:Fh.get(this.device,In).get("fullscreenQuadVS"),vertexWGSL:Fh.get(this.device,Rn).get("fullscreenQuadVS"),fragmentGLSL:n+Fh.get(this.device,In).get("glslDilatePS"),fragmentWGSL:n+Fh.get(this.device,Rn).get("wgslDilatePS")})}return this.shaderDilate[s]}evaluateDenoiseUniforms(t,e){function s(t,e){return.39894*Math.exp(-.5*t*t/(e*e))/e}this.kernel=this.kernel||new Float32Array(15);const n=this.kernel,i=Math.floor(7);for(let e=0;e<=i;++e){const r=s(e,t);n[i+e]=r,n[i-e]=r}this.constantKernel.setValue(this.kernel);const r=1/s(0,e);this.bZnorm.setValue(r)}}class yg extends Fo{constructor(t,e,s,n,i,r){super(t),this.viewBindGroups=[],this.renderer=e,this.camera=s,this.worldClusters=n,this.receivers=i,this.lightArray=r}destroy(){this.viewBindGroups.forEach(t=>{t.defaultUniformBuffer.destroy(),t.destroy()}),this.viewBindGroups.length=0}execute(){const t=this.device,{renderer:e,camera:s,receivers:n,renderTarget:i,worldClusters:r,lightArray:a}=this;t.supportsUniformBuffers&&!e.viewUniformFormat&&e.initViewBindGroupFormat(e.scene.clusteredLightingEnabled),e.renderForwardLayer(s,i,null,void 0,0,this.viewBindGroups,{meshInstances:n,splitLights:a,lightClusters:r})}}const bg=new rs;class Sg{constructor(t,e,s,n,i){this.device=t,this.root=e,this.scene=s,this.renderer=n,this.assets=i,this.shadowMapCache=n.shadowMapCache,this._tempSet=new Set,this._initCalled=!1,this.passMaterials=[],this.ambientAOMaterial=null,this.fog="",this.ambientLight=new Ze,this.renderTargets=new Map,this.stats={renderPasses:0,lightmapCount:0,totalRenderTime:0,forwardTime:0,fboTime:0,shadowMapTime:0,compileTime:0,shadersLinked:0}}destroy(){ic.decRef(this.blackTex),this.blackTex=null,ic.destroy(),this.device=null,this.root=null,this.scene=null,this.renderer=null,this.assets=null,this.camera?.destroy(),this.camera=null}initBake(t){if(this.bakeHDR=7!==this.scene.lightmapPixelFormat,!this._initCalled){this._initCalled=!0,this.lightmapFilters=new vg(t),this.constantBakeDir=t.scope.resolve("bakeDir"),this.materials=[],this.blackTex=new pi(this.device,{width:4,height:4,format:7,type:bn,name:"lightmapBlack"}),ic.incRef(this.blackTex);const e=new Tc;e.clearColor.set(0,0,0,0),e.clearColorBuffer=!0,e.clearDepthBuffer=!1,e.clearStencilBuffer=!1,e.frustumCulling=!1,e.projection=1,e.aspectRatio=1,e.node=new Hc,this.camera=e,this.camera.shaderParams.gammaCorrection=0,this.camera.shaderParams.toneMapping=0}if(this.scene.clusteredLightingEnabled){const e=new $u(t.supportsAreaLights,t.maxTextureSize,()=>{});this.lightingParams=e;const s=this.scene.lighting;e.shadowsEnabled=s.shadowsEnabled,e.shadowAtlasResolution=s.shadowAtlasResolution,e.cookiesEnabled=s.cookiesEnabled,e.cookieAtlasResolution=s.cookieAtlasResolution,e.areaLightsEnabled=s.areaLightsEnabled,e.cells=new rs(3,3,3),e.maxLightsPerCell=4,this.worldClusters=new od(t),this.worldClusters.name="ClusterLightmapper"}}finishBake(t){function e(t){ic.decRef(t.colorBuffer),t.destroy()}this.materials=[],this.renderTargets.forEach(t=>{e(t)}),this.renderTargets.clear(),t.forEach(t=>{t.renderTargets.forEach(t=>{e(t)}),t.renderTargets.length=0}),this.ambientAOMaterial=null,this.worldClusters&&(this.worldClusters.destroy(),this.worldClusters=null)}createMaterialForPass(t,e,s){const n=new hp;return n.name=`lmMaterial-pass:${e}-ambient:${s}`,n.setDefine("UV1LAYOUT",""),n.setDefine("LIT_LIGHTMAP_BAKING",""),0===e?(n.setDefine("LIT_LIGHTMAP_BAKING_COLOR",""),s?n.setDefine("LIT_LIGHTMAP_BAKING_ADD_AMBIENT",""):n.ambient=new Ze(0,0,0),this.bakeHDR||n.setDefine("LIGHTMAP_RGBM",""),n.lightMap=this.blackTex):(n.setDefine("LIT_LIGHTMAP_BAKING_DIR",""),n.setDefine("STD_LIGHTMAP_DIR","")),n.cull=0,n.forceUv1=!0,n.update(),n}createMaterials(t,e,s){for(let t=0;t<s;t++)this.passMaterials[t]||(this.passMaterials[t]=this.createMaterialForPass(e,t,!1));this.ambientAOMaterial||(this.ambientAOMaterial=this.createMaterialForPass(e,0,!0),this.ambientAOMaterial.onUpdateShader=function(t){return t.litOptions.lightMapWithoutAmbient=!0,t.litOptions.separateAmbient=!0,t})}createTexture(t,e){return new pi(this.device,{width:t,height:t,format:this.scene.lightmapPixelFormat,mipmaps:!1,type:this.bakeHDR?yn:bn,minFilter:0,magFilter:0,addressU:1,addressV:1,name:e})}collectModels(t,e,s){if(!t.enabled)return;let n;if(t.model?.model&&t.model?.enabled&&(s&&s.push(new mg(t)),t.model.lightmapped&&e&&(n=t.model.model.meshInstances)),t.render?.enabled&&(s&&s.push(new mg(t)),t.render.lightmapped&&e&&(n=t.render.meshInstances)),n){let s=!0;for(let t=0;t<n.length;t++)if(!n[t].mesh.vertexBuffer.format.hasUv1){s=!1;break}if(s){const s=[];for(let i=0;i<n.length;i++){const r=n[i].mesh;this._tempSet.has(r)?e.push(new mg(t,[n[i]])):s.push(n[i]),this._tempSet.add(r)}this._tempSet.clear(),s.length>0&&e.push(new mg(t,s))}}for(let n=0;n<t._children.length;n++)this.collectModels(t._children[n],e,s)}prepareShadowCasters(t){const e=[];for(let s=0;s<t.length;s++){const n=t[s].component;if(n.castShadows=n.castShadowsLightmap,n.castShadowsLightmap){const n=t[s].meshInstances;for(let t=0;t<n.length;t++)n[t].visibleThisFrame=!0,e.push(n[t])}}return e}updateTransforms(t){for(let e=0;e<t.length;e++){const s=t[e].meshInstances;for(let t=0;t<s.length;t++)s[t].node.getWorldTransform()}}calculateLightmapSize(t){let e;const s=this.scene.lightmapSizeMultiplier||16,n=bg;let i,r;t.model?(r=t.model.lightmapSizeMultiplier,t.model.asset?(e=this.assets.get(t.model.asset).data,e.area&&(i=e.area)):t.model._area&&(e=t.model,e._area&&(i=e._area))):t.render&&(r=t.render.lightmapSizeMultiplier,"asset"!==t.render.type&&t.render._area&&(e=t.render,e._area&&(i=e._area)));const a={x:1,y:1,z:1,uv:1};i&&(a.x=i.x,a.y=i.y,a.z=i.z,a.uv=i.uv);const o=r||1;a.x*=o,a.y*=o,a.z*=o;const l=t.render||t.model,h=this.computeNodeBounds(l.meshInstances);n.copy(h.halfExtents);let c=a.x*n.y*n.z+a.y*n.x*n.z+a.z*n.x*n.y;c/=a.uv,c=Math.sqrt(c);return Math.min(Qe.nextPowerOfTwo(c*s),this.scene.lightmapMaxResolution||2048)}setLightmapping(t,e,s,n){for(let i=0;i<t.length;i++){const r=t[i],a=r.meshInstances;for(let t=0;t<a.length;t++){const i=a[t];if(i.setLightmapped(e),e){n&&(i._shaderDefs|=n),i.mask=2;for(let t=0;t<s;t++){const e=r.renderTargets[t].colorBuffer;e.minFilter=1,e.magFilter=1,i.setRealtimeLightmap(fc.lightmapParamNames[t],e)}}}}}bake(t,e=1){const s=this.device,n=Xe();this.scene._updateSkyMesh(),this.stats.renderPasses=0,this.stats.shadowMapTime=0,this.stats.forwardTime=0;const i=s._shaderStats.linked,r=s._renderTargetCreationTime,a=s._shaderStats.compileTime,o=[],l=[];if(t){for(let e=0;e<t.length;e++)this.collectModels(t[e],o,null);this.collectModels(this.root,null,l)}else this.collectModels(this.root,o,l);if(o.length>0){this.renderer.shadowRenderer.frameUpdate();const t=1===e?2:1;this.setLightmapping(o,!1,t),this.initBake(s),this.bakeInternal(t,o,l);let n=64;1===e&&(n|=128),this.scene.ambientBake&&(n|=4096),this.setLightmapping(o,!0,t,n),this.finishBake(o)}const h=Xe();this.stats.totalRenderTime=h-n,this.stats.shadersLinked=s._shaderStats.linked-i,this.stats.compileTime=s._shaderStats.compileTime-a,this.stats.fboTime=s._renderTargetCreationTime-r,this.stats.lightmapCount=o.length}allocateTextures(t,e){for(let s=0;s<t.length;s++){const n=t[s],i=this.calculateLightmapSize(n.node);for(let t=0;t<e;t++){const e=this.createTexture(i,`lightmapper_lightmap_${s}`);ic.incRef(e),n.renderTargets[t]=new ji({colorBuffer:e,depth:!1})}if(!this.renderTargets.has(i)){const t=this.createTexture(i,`lightmapper_temp_lightmap_${i}`);ic.incRef(t),this.renderTargets.set(i,new ji({colorBuffer:t,depth:!1}))}}}prepareLightsToBake(t,e){if(this.scene.ambientBake){const t=new pg(this);e.push(t)}const s=this.renderer.lights;for(let n=0;n<s.length;n++){const i=s[n],r=new ug(this,i);t.push(r),i.enabled&&4&i.mask&&(i.mask=7,i.shadowUpdateMode=0===i.type?2:1,e.push(r))}e.sort()}restoreLights(t){for(let e=0;e<t.length;e++)t[e].restore()}setupScene(){this.ambientLight.copy(this.scene.ambientLight),this.scene.ambientBake||this.scene.ambientLight.set(0,0,0),this.renderer.setSceneConstants(),this.device.scope.resolve("ambientBakeOcclusionContrast").setValue(this.scene.ambientBakeOcclusionContrast),this.device.scope.resolve("ambientBakeOcclusionBrightness").setValue(this.scene.ambientBakeOcclusionBrightness)}restoreScene(){this.scene.ambientLight.copy(this.ambientLight)}computeNodeBounds(t){const e=new Ss;if(t.length>0){e.copy(t[0].aabb);for(let s=1;s<t.length;s++)e.add(t[s].aabb)}return e}computeNodesBounds(t){for(let e=0;e<t.length;e++){const s=t[e].meshInstances;t[e].bounds=this.computeNodeBounds(s)}}computeBounds(t){const e=new Ss;for(let s=0;s<t.length;s++){e.copy(t[0].aabb);for(let s=1;s<t.length;s++)e.add(t[s].aabb)}return e}backupMaterials(t){for(let e=0;e<t.length;e++)this.materials[e]=t[e].material}restoreMaterials(t){for(let e=0;e<t.length;e++)t[e].material=this.materials[e]}lightCameraPrepare(t,e){const s=e.light;let n;if(2===s.type){n=s.getRenderData(null,0).shadowCamera,n._node.setPosition(s._node.getPosition()),n._node.setRotation(s._node.getRotation()),n._node.rotateLocal(-90,0,0),n.projection=0,n.nearClip=s.attenuationEnd/1e3,n.farClip=s.attenuationEnd,n.aspectRatio=1,n.fov=2*s._outerConeAngle,this.renderer.updateCameraFrustum(n)}return n}lightCameraPrepareAndCull(t,e,s,n){const i=t.light;let r=!0;if(0===i.type){bg.copy(n.center),bg.y+=n.halfExtents.y,this.camera.node.setPosition(bg),this.camera.node.setEulerAngles(-90,0,0),this.camera.nearClip=0,this.camera.farClip=2*n.halfExtents.y;const t=Math.max(n.halfExtents.x,n.halfExtents.z);this.camera.orthoHeight=t}else t.lightBounds.intersects(e.bounds)||(r=!1);if(2===i.type){let t=!1;const n=e.meshInstances;for(let e=0;e<n.length;e++)if(n[e]._isVisible(s)){t=!0;break}t||(r=!1)}return r}setupLightArray(t,e){t[0].length=0,t[1].length=0,t[2].length=0,t[e.type][0]=e,e.visibleThisFrame=!0}renderShadowMap(t,e,s,n){const i=n.light,r=this.scene.clusteredLightingEnabled,a=i.castShadows&&(!r||this.scene.lighting.shadowsEnabled);if(!e&&a)if(i.shadowMap||r||(i.shadowMap=this.shadowMapCache.get(this.device,i)),0===i.type){this.renderer._shadowRendererDirectional.cull(i,t,this.camera,s);const e=this.renderer._shadowRendererDirectional.getLightRenderPass(i,this.camera);e?.render()}else{if(this.device.isWebGPU)return!0;this.renderer._shadowRendererLocal.cull(i,t,s);const e=!1;this.renderer.shadowRenderer.render(i,this.camera,e)}return!0}postprocessTextures(t,e,s){const n=this.lightmapFilters.getDilate(t,this.bakeHDR);let i;const r=this.scene.lightmapFilterEnabled;r&&(this.lightmapFilters.prepareDenoise(this.scene.lightmapFilterRange,this.scene.lightmapFilterSmoothness,this.bakeHDR),i=this.lightmapFilters.getDenoise(this.bakeHDR)),t.setBlendState(Ti.NOBLEND),t.setDepthState(Ai.NODEPTH),t.setStencilState(null,null);for(let a=0;a<e.length;a++){const o=e[a];for(let e=0;e<s;e++){const s=o.renderTargets[e],a=s.colorBuffer,l=this.renderTargets.get(a.width),h=l.colorBuffer;this.lightmapFilters.prepare(a.width,a.height);for(let o=0;o<1;o++){this.lightmapFilters.setSourceTexture(a);Xh(t,l,r&&0===e&&0===o?i:n),this.lightmapFilters.setSourceTexture(h),Xh(t,s,n)}}}}bakeInternal(t,e,s){const n=this.scene,i=n.layers,r=this.device,a=n.clusteredLightingEnabled;this.createMaterials(r,n,t),this.setupScene(),i._update(),this.computeNodesBounds(e),this.allocateTextures(e,t),this.renderer.collectLights(i);const o=[],l=[];this.prepareLightsToBake(o,l),this.updateTransforms(s);const h=this.prepareShadowCasters(s);this.renderer.updateCpuSkinMatrices(h),this.renderer.gpuUpdate(h);const c=this.computeBounds(h);let d,u,f,p;for(d=0;d<e.length;d++){for(f=e[d].meshInstances,u=0;u<f.length;u++)p=f[u],p.setLightmapped(!1),p.mask=4,p.setRealtimeLightmap(fc.lightmapParamNames[0],this.blackTex),p.setRealtimeLightmap(fc.lightmapParamNames[1],this.blackTex)}for(u=0;u<l.length;u++)l[u].light.enabled=!1;const m=[[],[],[]];let g,_,v=!1;for(d=0;d<l.length;d++){const s=l[d],o=s instanceof pg,y=0===s.light.type;let b=s.numVirtualLights;t>1&&b>1&&s.light.bakeDir&&(b=1);for(let l=0;l<b;l++){b>1&&s.prepareVirtualLight(l,b),s.startBake();let d=!1;const S=this.lightCameraPrepare(r,s);for(_=0;_<e.length;_++){const x=e[_];f=x.meshInstances;if(!this.lightCameraPrepareAndCull(s,x,S,c))continue;this.setupLightArray(m,s.light);const w=y?[]:[s.light];for(a&&this.renderer.lightTextureAtlas.update(w,this.lightingParams),d=this.renderShadowMap(i,d,h,s),a&&this.worldClusters.update(w,this.lightingParams),this.backupMaterials(f),g=0;g<t&&!(g>0&&l>0)&&!(o&&g>0);g++){const t=x.renderTargets[g],e=x.renderTargets[g].colorBuffer.width,i=this.renderTargets.get(e),h=i.colorBuffer;0===g?v=n.updateShaders:v&&(n.updateShaders=!0);let c=this.passMaterials[g];if(o){l+1===b&&0===g&&(c=this.ambientAOMaterial)}for(u=0;u<f.length;u++)f[u].material=c;if(this.renderer.updateShaders(f),1===g&&this.constantBakeDir.setValue(s.light.bakeDir?1:0),r.isWebGPU){const t=new yg(r,this.renderer,this.camera,a?this.worldClusters:null,f,m);t.init(i),t.render(),t.destroy()}else this.renderer.setCamera(this.camera,i,!0),a&&this.worldClusters.activate(),this.renderer._forwardTime=0,this.renderer._shadowMapTime=0,this.renderer.renderForward(this.camera,i,f,m,0),r.updateEnd();for(x.renderTargets[g]=i,this.renderTargets.set(e,t),u=0;u<f.length;u++)p=f[u],p.setRealtimeLightmap(fc.lightmapParamNames[g],h),p._shaderDefs|=64}this.restoreMaterials(f)}s.endBake(this.shadowMapCache)}}for(this.postprocessTextures(r,e,t),_=0;_<s.length;_++)s[_].restore();this.restoreLights(o),this.restoreScene(),a||this.shadowMapCache.clear()}}class xg extends Ve{static{this.order=0}constructor(t,e){super(),this.system=t,this.entity=e,this.system.schema&&!this._accessorsBuilt&&this.buildAccessors(this.system.schema),this.on("set",function(t,e,s){this.fire(`set_${t}`,t,e,s)}),this.on("set_enabled",this.onSetEnabled,this)}static _buildAccessors(t,e){e.forEach(e=>{const s="object"==typeof e?e.name:e;Object.defineProperty(t,s,{get:function(){return this.data[s]},set:function(t){const e=this.data,n=e[s];e[s]=t,this.fire("set",s,n,t)},configurable:!0})}),t._accessorsBuilt=!0}buildAccessors(t){xg._buildAccessors(this,t)}onSetEnabled(t,e,s){e!==s&&this.entity.enabled&&(s?this.onEnable():this.onDisable())}onEnable(){}onDisable(){}onPostStateChange(){}get data(){const t=this.system.store[this.entity.getGuid()];return t?t.data:null}set enabled(t){}get enabled(){return!0}}class wg extends Ve{constructor(t){super(),this.app=t,this.store={},this.schema=[]}addComponent(t,e={}){const s=new this.ComponentType(this,t),n=new this.DataType;return this.store[t.getGuid()]={entity:t,data:n},t[this.id]=s,t.c[this.id]=s,this.initializeComponentData(s,e,[]),this.fire("add",t,s),s}removeComponent(t){const e=this.id,s=this.store[t.getGuid()],n=t.c[e];n.fire("beforeremove"),this.fire("beforeremove",t,n),delete this.store[t.getGuid()],t[e]=void 0,delete t.c[e],this.fire("remove",t,s.data)}cloneComponent(t,e){const s=this.store[t.getGuid()];return this.addComponent(e,s.data)}initializeComponentData(t,e={},s){for(let n=0,i=s.length;n<i;n++){const i=s[n];let r,a;"object"==typeof i?(r=i.name,a=i.type):(r=i,a=void 0);let o=e[r];void 0!==o?(void 0!==a&&(o=Tg(o,a)),t[r]=o):t[r]=t.data[r]}t.enabled&&t.entity.enabled&&t.onEnable()}getPropertiesOfType(t){const e=[];return(this.schema||[]).forEach(s=>{s&&"object"==typeof s&&s.type===t&&e.push(s)}),e}destroy(){this.off()}}function Tg(t,e){if(!t)return t;switch(e){case"rgb":return t instanceof Ze?t.clone():new Ze(t[0],t[1],t[2]);case"rgba":return t instanceof Ze?t.clone():new Ze(t[0],t[1],t[2],t[3]);case"vec2":return t instanceof os?t.clone():new os(t[0],t[1]);case"vec3":return t instanceof rs?t.clone():new rs(t[0],t[1],t[2]);case"vec4":return t instanceof ls?t.clone():new ls(t[0],t[1],t[2],t[3]);case"boolean":case"number":case"string":case"entity":return t;default:throw new Error(`Could not convert unhandled type: ${e}`)}}class Cg{constructor(){this._left=1/0,this._right=-1/0,this._len=0,this._recip=0,this._p0=0,this._p1=0,this._t=0,this._hermite={valid:!1,p0:0,m0:0,p1:0,m1:0}}update(t,e){if(t<this._left||t>=this._right){const s=e.length;if(s)if(t<e[0])this._left=-1/0,this._right=e[0],this._len=0,this._recip=0,this._p0=this._p1=0;else if(t>=e[s-1])this._left=e[s-1],this._right=1/0,this._len=0,this._recip=0,this._p0=this._p1=s-1;else{const s=this._findKey(t,e);this._left=e[s],this._right=e[s+1],this._len=this._right-this._left;const n=1/this._len;this._recip=isFinite(n)?n:0,this._p0=s,this._p1=s+1}else this._left=-1/0,this._right=1/0,this._len=0,this._recip=0,this._p0=this._p1=0}this._t=0===this._recip?0:(t-this._left)*this._recip,this._hermite.valid=!1}_findKey(t,e){let s=0;for(;t>=e[s+1];)s++;return s}eval(t,e,s){const n=s._data,i=s._components,r=this._p0*i;if(0===e)for(let e=0;e<i;++e)t[e]=n[r+e];else{const s=this._t,a=this._p1*i;switch(e){case 1:for(let e=0;e<i;++e)t[e]=Qe.lerp(n[r+e],n[a+e],s);break;case 2:{const e=this._hermite;if(!e.valid){const t=s*s,n=s+s,i=1-s,r=i*i;e.valid=!0,e.p0=(1+n)*r,e.m0=s*r,e.p1=t*(3-n),e.m1=t*(s-1)}const r=(3*this._p0+1)*i,a=(3*this._p0+2)*i,o=(3*this._p1+1)*i,l=(3*this._p1+0)*i;for(let s=0;s<i;++s)t[s]=e.p0*n[r+s]+e.m0*n[a+s]*this._len+e.p1*n[o+s]+e.m1*n[l+s]*this._len;break}}}}}class Eg{constructor(t){this._name=`${t.name}Snapshot`,this._time=-1,this._cache=[],this._results=[];for(let e=0;e<t._inputs.length;++e)this._cache[e]=new Cg;const e=t._curves,s=t._outputs;for(let t=0;t<e.length;++t){const n=s[e[t]._output],i=[];for(let t=0;t<n._components;++t)i[t]=0;this._results[t]=i}}}class Ag{static{this.eventFrame={start:0,end:0,residual:0}}constructor(t,e,s,n,i,r){this._name=t.name,this._track=t,this._snapshot=new Eg(t),this._playing=n,this._time=e,this._speed=s,this._loop=i,this._blendWeight=1,this._blendOrder=0,this._eventHandler=r,this.alignCursorToCurrentTime()}set name(t){this._name=t}get name(){return this._name}set track(t){this._track=t,this._snapshot=new Eg(t)}get track(){return this._track}get snapshot(){return this._snapshot}set time(t){this._time=t,this.alignCursorToCurrentTime()}get time(){return this._time}set speed(t){const e=Math.sign(t)!==Math.sign(this._speed);this._speed=t,e&&this.alignCursorToCurrentTime()}get speed(){return this._speed}set loop(t){this._loop=t}get loop(){return this._loop}set blendWeight(t){this._blendWeight=t}get blendWeight(){return this._blendWeight}set blendOrder(t){this._blendOrder=t}get blendOrder(){return this._blendOrder}set eventCursor(t){this._eventCursor=t}get eventCursor(){return this._eventCursor}get eventCursorEnd(){return this.isReverse?0:this._track.events.length-1}get nextEvent(){return this._track.events[this._eventCursor]}get isReverse(){return this._speed<0}nextEventAheadOfTime(t){return!!this.nextEvent&&(this.isReverse?this.nextEvent.time<=t:this.nextEvent.time>=t)}nextEventBehindTime(t){return!!this.nextEvent&&(t===this.track.duration?this.isReverse?this.nextEvent.time>=t:this.nextEvent.time<=t:this.isReverse?this.nextEvent.time>t:this.nextEvent.time<t)}resetEventCursor(){this._eventCursor=this.isReverse?this._track.events.length-1:0}moveEventCursor(){this._eventCursor+=this.isReverse?-1:1,this._eventCursor>=this.track.events.length?this._eventCursor=0:this._eventCursor<0&&(this._eventCursor=this.track.events.length-1)}clipFrameTime(t){const e=Ag.eventFrame;e.start=0,e.end=t,e.residual=0,this.isReverse?t<0&&(e.start=this.track.duration,e.end=0,e.residual=t+this.track.duration):t>this.track.duration&&(e.start=0,e.end=this.track.duration,e.residual=t-this.track.duration)}alignCursorToCurrentTime(){for(this.resetEventCursor();this.nextEventBehindTime(this._time)&&this._eventCursor!==this.eventCursorEnd;)this.moveEventCursor()}fireNextEvent(){this._eventHandler.fire(this.nextEvent.name,{track:this.track,...this.nextEvent}),this.moveEventCursor()}fireNextEventInFrame(t,e){return!(!this.nextEventAheadOfTime(t)||!this.nextEventBehindTime(e))&&(this.fireNextEvent(),!0)}activeEventsForFrame(t,e){const s=Ag.eventFrame;this.clipFrameTime(e);const n=this.eventCursor;for(;this.fireNextEventInFrame(t,s.end)&&n!==this.eventCursor;);this.loop&&Math.abs(s.residual)>0&&this.activeEventsForFrame(s.start,s.residual)}progressForTime(t){return t*this._speed/this._track.duration}_update(t){if(this._playing){let e=this._time;const s=this._track.duration,n=this._speed,i=this._loop;this._track.events.length>0&&s>0&&this.activeEventsForFrame(e,e+n*t),e+=n*t,n>=0?e>s&&(i?e=e%s||0:(e=this._track.duration,this.pause())):e<0&&(i?e=s+(e%s||0):(e=0,this.pause())),this._time=e}this._time!==this._snapshot._time&&this._track.eval(this._time,this._snapshot)}play(){this._playing=!0,this._time=0}stop(){this._playing=!1,this._time=0}pause(){this._playing=!1}resume(){this._playing=!0}reset(){this._time=0}}const Dg="NONE",Pg="INTEGER",Lg="FLOAT",Ig="BOOLEAN",Rg="TRIGGER",Mg="START",kg="END",Og="ANY",Fg=[Mg,kg,Og],Ng="OVERWRITE";class Bg{static dot(t,e){const s=t.length;let n=0;for(let i=0;i<s;++i)n+=t[i]*e[i];return n}static normalize(t){let e=Bg.dot(t,t);if(e>0){e=1/Math.sqrt(e);const s=t.length;for(let n=0;n<s;++n)t[n]*=e}}static set(t,e,s){const n=t.length;if("quaternion"===s){let s=Bg.dot(e,e);s>0&&(s=1/Math.sqrt(s));for(let i=0;i<n;++i)t[i]=e[i]*s}else for(let s=0;s<n;++s)t[s]=e[s]}static blendVec(t,e,s,n){const i=n?1:1-s,r=t.length;for(let n=0;n<r;++n)t[n]=t[n]*i+e[n]*s}static blendQuat(t,e,s,n){const i=t.length,r=n?1:1-s;Bg.dot(t,e)<0&&(s=-s);for(let n=0;n<i;++n)t[n]=t[n]*r+e[n]*s;n||Bg.normalize(t)}static blend(t,e,s,n,i){"quaternion"===n?Bg.blendQuat(t,e,s,i):Bg.blendVec(t,e,s,i)}static stableSort(t,e){const s=t.length;for(let n=0;n<s-1;++n)for(let i=n+1;i<s;++i)if(e(t[i],t[n])){const e=t[n];t[n]=t[i],t[i]=e}}}class zg{static{this.TYPE_QUAT="quaternion"}static{this.TYPE_VEC3="vector3"}static{this.q1=new ms}static{this.q2=new ms}static{this.q3=new ms}static{this.quatArr=[0,0,0,1]}static{this.vecArr=[0,0,0]}static{this.IDENTITY_QUAT_ARR=[0,0,0,1]}constructor(t,e){this._component=t,this.mask=new Int8Array(t.layers.length),this.weights=new Float32Array(t.layers.length),this.totalWeight=0,this.counter=0,this.layerCounter=0,this.valueType=e,this.dirty=!0,this.value=e===zg.TYPE_QUAT?[0,0,0,1]:[0,0,0],this.baseValue=null,this.setter=null}get _normalizeWeights(){return this._component.normalizeWeights}getWeight(t){return this.dirty&&this.updateWeights(),this._normalizeWeights&&0===this.totalWeight||!this.mask[t]?0:this._normalizeWeights?this.weights[t]/this.totalWeight:Qe.clamp(this.weights[t],0,1)}_layerBlendType(t){return this._component.layers[t].blendType}setMask(t,e){this.mask[t]=e,this._normalizeWeights&&(this._component.layers[t].blendType===Ng&&(this.mask=this.mask.fill(0,0,t)),this.dirty=!0)}updateWeights(){this.totalWeight=0;for(let t=0;t<this.weights.length;t++)this.weights[t]=this._component.layers[t].weight,this.totalWeight+=this.mask[t]*this.weights[t];this.dirty=!1}updateValue(t,e){if(0===this.counter&&(Bg.set(this.value,zg.IDENTITY_QUAT_ARR,this.valueType),this._normalizeWeights||Bg.blend(this.value,this.baseValue,1,this.valueType)),this.mask[t]&&0!==this.getWeight(t)){if("ADDITIVE"!==this._layerBlendType(t)||this._normalizeWeights)Bg.blend(this.value,e,this.getWeight(t),this.valueType);else if(this.valueType===zg.TYPE_QUAT){const s=zg.q1.set(this.value[0],this.value[1],this.value[2],this.value[3]),n=zg.q2.set(this.baseValue[0],this.baseValue[1],this.baseValue[2],this.baseValue[3]),i=zg.q3.set(e[0],e[1],e[2],e[3]),r=n.invert().mul(i);r.slerp(ms.IDENTITY,r,this.getWeight(t)),s.mul(r),zg.quatArr[0]=s.x,zg.quatArr[1]=s.y,zg.quatArr[2]=s.z,zg.quatArr[3]=s.w,Bg.set(this.value,zg.quatArr,this.valueType)}else zg.vecArr[0]=e[0]-this.baseValue[0],zg.vecArr[1]=e[1]-this.baseValue[1],zg.vecArr[2]=e[2]-this.baseValue[2],Bg.blend(this.value,zg.vecArr,this.getWeight(t),this.valueType,!0);this.setter&&this.setter(this.value)}}unbind(){this.setter&&this.setter(this.baseValue)}}class Ug{constructor(t){this._binder=t,this._clips=[],this._inputs=[],this._outputs=[],this._targets={}}get clips(){return this._clips}addClip(t){const e=this._targets,s=this._binder,n=t.track.curves,i=t.snapshot,r=[],a=[];for(let t=0;t<n.length;++t){const o=n[t].paths;for(let n=0;n<o.length;++n){const l=o[n],h=s.resolve(l);let c=e[h&&h.targetPath||null];if(!c&&h){c={target:h,value:[],curves:0,blendCounter:0};for(let t=0;t<c.target.components;++t)c.value.push(0);if(e[h.targetPath]=c,s.animComponent){if(!s.animComponent.targets[h.targetPath]){let t;t="localRotation"===h.targetPath.substring(h.targetPath.length-13)?zg.TYPE_QUAT:zg.TYPE_VEC3,s.animComponent.targets[h.targetPath]=new zg(s.animComponent,t)}s.animComponent.targets[h.targetPath].layerCounter++,s.animComponent.targets[h.targetPath].setMask(s.layerIndex,1)}}c&&(c.curves++,r.push(i._results[t]),a.push(c))}}this._clips.push(t),this._inputs.push(r),this._outputs.push(a)}removeClip(t){const e=this._targets,s=this._binder,n=this._clips,i=n[t].track.curves;for(let t=0;t<i.length;++t){const n=i[t].paths;for(let t=0;t<n.length;++t){const i=n[t],r=this._binder.resolve(i);r&&(r.curves--,0===r.curves&&(s.unresolve(i),delete e[r.targetPath],s.animComponent&&s.animComponent.targets[r.targetPath].layerCounter--))}}n.splice(t,1),this._inputs.splice(t,1),this._outputs.splice(t,1)}removeClips(){for(;this._clips.length>0;)this.removeClip(0)}updateClipTrack(t,e){this._clips.forEach(s=>{s.name.includes(t)&&(s.track=e)}),this.rebind()}findClip(t){const e=this._clips;for(let s=0;s<e.length;++s){const n=e[s];if(n.name===t)return n}return null}rebind(){this._binder.rebind(),this._targets={};const t=[...this.clips];this.removeClips(),t.forEach(t=>{this.addClip(t)})}assignMask(t){return this._binder.assignMask(t)}update(t,e=!0){const s=this._clips,n=s.map((t,e)=>e);Bg.stableSort(n,(t,e)=>s[t].blendOrder<s[e].blendOrder);for(let i=0;i<n.length;++i){const r=n[i],a=s[r],o=this._inputs[r],l=this._outputs[r],h=a.blendWeight;if(h>0&&a._update(t),!e)break;let c,d,u;if(h>=1)for(let t=0;t<o.length;++t)c=o[t],d=l[t],u=d.value,Bg.set(u,c,d.target.type),d.blendCounter++;else if(h>0)for(let t=0;t<o.length;++t)c=o[t],d=l[t],u=d.value,0===d.blendCounter?Bg.set(u,c,d.target.type):Bg.blend(u,c,h,d.target.type),d.blendCounter++}const i=this._targets,r=this._binder;for(const t in i)if(i.hasOwnProperty(t)){const e=i[t];if(r.animComponent&&e.target.usesLayerBlending){const s=r.animComponent.targets[t];s.counter===s.layerCounter&&(s.counter=0),s.path||(s.path=t,s.baseValue=e.target.get(),s.setter=e.target.set),s.updateValue(r.layerIndex,e.value),s.counter++}else e.target.set(e.value);e.blendCounter=0}this._binder.update(t)}}class Vg{constructor(t){this._events=[...t],this._events.sort((t,e)=>t.time-e.time)}get events(){return this._events}}class Hg{static{this.EMPTY=Object.freeze(new Hg("empty",Number.MAX_VALUE,[],[],[]))}constructor(t,e,s,n,i,r=new Vg([])){this._name=t,this._duration=e,this._inputs=s,this._outputs=n,this._curves=i,this._animEvents=r}get name(){return this._name}get duration(){return this._duration}get inputs(){return this._inputs}get outputs(){return this._outputs}get curves(){return this._curves}set events(t){this._animEvents=t}get events(){return this._animEvents.events}eval(t,e){e._time=t;const s=this._inputs,n=this._outputs,i=this._curves,r=e._cache,a=e._results;for(let e=0;e<s.length;++e)r[e].update(t,s[e]._data);for(let t=0;t<i.length;++t){const e=i[t],s=n[e._output],o=a[t];r[e._input].eval(o,e._interpolation,s)}}}class Gg{static joinPath(t,e){e=e||".";return t.map(function(t){return t.replace(/\\/g,"\\\\").replace(new RegExp(`\\${e}`,"g"),`\\${e}`)}).join(e)}static splitPath(t,e){e=e||".";const s=[];let n="",i=0;for(;i<t.length;){let r=t[i++];"\\"===r&&i<t.length?(r=t[i++],n+="\\"===r||r===e?r:`\\${r}`):r===e?(s.push(n),n=""):n+=r}return n.length>0&&s.push(n),s}static encode(t,e,s){return`${Array.isArray(t)?t.join("/"):t}/${e}/${Array.isArray(s)?s.join("/"):s}`}resolve(t){return null}unresolve(t){}update(t){}}class Wg{constructor(t,e,s,n){t.set?(this._set=t.set,this._get=t.get):this._set=t,this._type=e,this._components=s,this._targetPath=n,this._isTransform="localRotation"===this._targetPath.substring(this._targetPath.length-13)||"localPosition"===this._targetPath.substring(this._targetPath.length-13)||"localScale"===this._targetPath.substring(this._targetPath.length-10),this._isWeight=-1!==this._targetPath.indexOf("weight.")}get set(){return this._set}get get(){return this._get}get type(){return this._type}get components(){return this._components}get targetPath(){return this._targetPath}get isTransform(){return this._isTransform}get isWeight(){return this._isWeight}get usesLayerBlending(){return this._isTransform||this._isWeight}}class jg{constructor(t){if(this._isPathInMask=(t,e)=>{const s=this._mask[t];return!!s&&!!(s.children||e&&!1!==s.value)},this.graph=t,!t)return;this._mask=null;const e={},s=function(t){e[t.name]=t;for(let e=0;e<t.children.length;++e)s(t.children[e])};s(t),this.nodes=e,this.targetCache={};const n=function(t){let e,s=t;for(;s&&!(s instanceof Jm);)s=s.parent;return s&&(s.render?e=s.render.meshInstances:s.model&&(e=s.model.meshInstances)),e};this.nodeCounts={},this.activeNodes=[],this.handlers={localPosition:function(t){const e=t.localPosition;return jg.createAnimTarget(function(t){e.set(...t)},"vector",3,t,"localPosition")},localRotation:function(t){const e=t.localRotation;return jg.createAnimTarget(function(t){e.set(...t)},"quaternion",4,t,"localRotation")},localScale:function(t){const e=t.localScale;return jg.createAnimTarget(function(t){e.set(...t)},"vector",3,t,"localScale")},weight:function(t,e){e=0===e.indexOf("name.")?e.replace("name.",""):Number(e);const s=n(t),i=[];if(s)for(let e=0;e<s.length;++e)s[e].node.name===t.name&&s[e].morphInstance&&i.push(s[e].morphInstance);if(i.length>0){const s={set:t=>{for(let s=0;s<i.length;++s)i[s].setWeight(e,t[0])},get:()=>[i[0].getWeight(e)]};return jg.createAnimTarget(s,"number",1,t,`weight.${e}`)}return null},materialTexture:(t,e)=>{const s=n(t);if(s){let n;for(let e=0;e<s.length;++e)if(s[e].node.name===t.name){n=s[e];break}if(n){const s=t=>{const s=this.animComponent.system.app.assets.get(t[0]);s&&s.resource&&"texture"===s.type&&(n.material[e]=s.resource,n.material.update())};return jg.createAnimTarget(s,"vector",1,t,"materialTexture","material")}}return null}}}_isPathActive(t){if(!this._mask)return!0;const e=[t.entityPath[0],this.graph.name];for(let s=0;s<e.length;++s){let n=e[s];if(this._isPathInMask(n,1===t.entityPath.length))return!0;for(let e=1;e<t.entityPath.length;e++)if(n+=`/${t.entityPath[e]}`,this._isPathInMask(n,e===t.entityPath.length-1))return!0}return!1}findNode(t){if(!this._isPathActive(t))return null;let e;return this.graph&&(e=this.graph.findByPath(t.entityPath),e||(e=this.graph.findByPath(t.entityPath.slice(1)))),e||(e=this.nodes[t.entityPath[t.entityPath.length-1]||""]),e}static createAnimTarget(t,e,s,n,i,r){const a=Gg.encode(n.path,r||"entity",i);return new Wg(t,e,s,a)}resolve(t){const e=Gg.encode(t.entityPath,t.component,t.propertyPath);let s=this.targetCache[e];if(s)return s;const n=this.findNode(t);if(!n)return null;const i=this.handlers[t.propertyPath];return i?(s=i(n),s?(this.targetCache[e]=s,this.nodeCounts[n.path]?this.nodeCounts[n.path]++:(this.activeNodes.push(n),this.nodeCounts[n.path]=1),s):null):null}unresolve(t){if("graph"!==t.component)return;const e=this.nodes[t.entityPath[t.entityPath.length-1]||""];if(this.nodeCounts[e.path]--,0===this.nodeCounts[e.path]){const t=this.activeNodes,s=t.indexOf(e.node),n=t.length;s<n-1&&(t[s]=t[n-1]),t.pop()}}update(t){const e=this.activeNodes;for(let t=0;t<e.length;++t)e[t]._dirtifyLocal()}assignMask(t){return t!==this._mask&&(this._mask=t,!0)}}class $g{constructor(t,e,s,n,i=1){this._state=t,this._parent=e,this._name=s,Array.isArray(n)?(this._point=new os(n[0],n[1]),this._pointLength=this._point.length()):(this._point=n,this._pointLength=n),this._speed=i,this._weightedSpeed=1,this._weight=1,this._animTrack=null}get parent(){return this._parent}get name(){return this._name}get path(){return this._parent?`${this._parent.path}.${this._name}`:this._name}get point(){return this._point}get pointLength(){return this._pointLength}set weight(t){this._weight=t}get weight(){return this._parent?this._parent.weight*this._weight:this._weight}get normalizedWeight(){const t=this._state.totalWeight;return 0===t?0:this.weight/t}get speed(){return this._weightedSpeed*this._speed}get absoluteSpeed(){return Math.abs(this._speed)}set weightedSpeed(t){this._weightedSpeed=t}get weightedSpeed(){return this._weightedSpeed}set animTrack(t){this._animTrack=t}get animTrack(){return this._animTrack}}class Xg extends $g{constructor(t,e,s,n,i,r,a,o,l){super(t,e,s,n),this._parameters=i,this._parameterValues=new Array(i.length),this._children=[],this._findParameter=l,this._syncAnimations=!1!==a,this._pointCache={};for(let e=0;e<r.length;e++){const s=r[e];s.children?this._children.push(o(s.type,t,this,s.name,1,s.parameter?[s.parameter]:s.parameters,s.children,s.syncAnimations,o,l)):this._children.push(new $g(t,this,s.name,s.point,s.speed))}}get weight(){return this.calculateWeights(),this._parent?this._parent.weight*this._weight:this._weight}get syncAnimations(){return this._syncAnimations}getChild(t){for(let e=0;e<this._children.length;e++)if(this._children[e].name===t)return this._children[e];return null}updateParameterValues(){let t=!0;for(let e=0;e<this._parameterValues.length;e++){const s=this._findParameter(this._parameters[e]).value;this._parameterValues[e]!==s&&(this._parameterValues[e]=s,t=!1)}return t}getNodeWeightedDuration(t){return this._children[t].animTrack.duration/this._children[t].speedMultiplier*this._children[t].weight}getNodeCount(){let t=0;for(let e=0;e<this._children.length;e++){this._children[e].constructor===Xg?t+=this._children[e].getNodeCount():t++}return t}}class qg extends Xg{constructor(t,e,s,n,i,r,a,o,l){r.sort((t,e)=>t.point-e.point),super(t,e,s,n,i,r,a,o,l)}calculateWeights(){if(this.updateParameterValues())return;let t=0;this._children[0].weight=0;for(let e=0;e<this._children.length;e++){const s=this._children[e];if(e!==this._children.length-1){const t=this._children[e+1];if(s.point===t.point)s.weight=.5,t.weight=.5;else if(Qe.between(this._parameterValues[0],s.point,t.point,!0)){const e=Math.abs(s.point-t.point),n=(e-Math.abs(s.point-this._parameterValues[0]))/e;s.weight=n,t.weight=1-n}else t.weight=0}this._syncAnimations&&(t+=s.animTrack.duration/s.absoluteSpeed*s.weight)}if(this._syncAnimations)for(let e=0;e<this._children.length;e++){const s=this._children[e];s.weightedSpeed=s.animTrack.duration/s.absoluteSpeed/t}}}class Kg extends Xg{static{this._p=new os}static{this._pip=new os}pointDistanceCache(t,e){const s=`${t}${e}`;return this._pointCache[s]||(this._pointCache[s]=this._children[e].point.clone().sub(this._children[t].point)),this._pointCache[s]}calculateWeights(){if(this.updateParameterValues())return;let t,e;Kg._p.set(...this._parameterValues),t=0,e=0;for(let s=0;s<this._children.length;s++){const n=this._children[s],i=n.point;Kg._pip.set(Kg._p.x,Kg._p.y).sub(i);let r=Number.MAX_VALUE;for(let t=0;t<this._children.length;t++){if(s===t)continue;const e=this.pointDistanceCache(s,t),n=Qe.clamp(1-Kg._pip.dot(e)/e.lengthSq(),0,1);n<r&&(r=n)}n.weight=r,t+=r,this._syncAnimations&&(e+=n.animTrack.duration/n.absoluteSpeed*n.weight)}for(let s=0;s<this._children.length;s++){const n=this._children[s];n.weight=n._weight/t,this._syncAnimations&&(n.weightedSpeed=n.animTrack.duration/n.absoluteSpeed/e)}}}class Yg extends Xg{static{this._p=new os}static{this._pip=new os}pointCache(t,e){const s=`${t}${e}`;return this._pointCache[s]||(this._pointCache[s]=new os((this._children[e].pointLength-this._children[t].pointLength)/((this._children[e].pointLength+this._children[t].pointLength)/2),2*os.angleRad(this._children[t].point,this._children[e].point))),this._pointCache[s]}calculateWeights(){if(this.updateParameterValues())return;let t,e;Yg._p.set(...this._parameterValues);const s=Yg._p.length();t=0,e=0;for(let n=0;n<this._children.length;n++){const i=this._children[n],r=i.point,a=i.pointLength;let o=Number.MAX_VALUE;for(let t=0;t<this._children.length;t++){if(n===t)continue;const e=this.pointCache(n,t),i=this._children[t].pointLength;Yg._pip.set((s-a)/((i+a)/2),2*os.angleRad(r,Yg._p));const l=Qe.clamp(1-Math.abs(Yg._pip.dot(e)/e.lengthSq()),0,1);l<o&&(o=l)}i.weight=o,t+=o,this._syncAnimations&&(e+=i.animTrack.duration/i.absoluteSpeed*i.weight)}for(let s=0;s<this._children.length;s++){const n=this._children[s];if(n.weight=n._weight/t,this._syncAnimations){const s=n.animTrack.duration/e*t;n.weightedSpeed=n.absoluteSpeed*s}}}}class Qg extends Xg{calculateWeights(){if(this.updateParameterValues())return;let t=0,e=0;for(let s=0;s<this._children.length;s++)if(t+=Math.max(this._parameterValues[s],0),this._syncAnimations){const t=this._children[s];e+=t.animTrack.duration/t.absoluteSpeed*t.weight}for(let s=0;s<this._children.length;s++){const n=this._children[s],i=Math.max(this._parameterValues[s],0);t?(n.weight=i/t,this._syncAnimations&&(n.weightedSpeed=n.animTrack.duration/n.absoluteSpeed/e)):(n.weight=0,this._syncAnimations&&(n.weightedSpeed=0))}}}class Zg{constructor(t,e,s=1,n=!0,i){this._animations={},this._animationList=[],this._controller=t,this._name=e,this._speed=s,this._loop=n,this._hasAnimations=!1,this._blendTree=i?this._createTree(i.type,this,null,e,1,i.parameter?[i.parameter]:i.parameters,i.children,i.syncAnimations,this._createTree,this._controller.findParameter):new $g(this,null,e,1,s)}_createTree(t,e,s,n,i,r,a,o,l,h){switch(t){case"1D":return new qg(e,s,n,i,r,a,o,l,h);case"2D_CARTESIAN":return new Kg(e,s,n,i,r,a,o,l,h);case"2D_DIRECTIONAL":return new Yg(e,s,n,i,r,a,o,l,h);case"DIRECT":return new Qg(e,s,n,i,r,a,o,l,h)}}_getNodeFromPath(t){let e=this._blendTree;for(let s=1;s<t.length;s++)e=e.getChild(t[s]);return e}addAnimation(t,e){const s=t.join("."),n=this._animationList.findIndex(t=>t.path===s);if(n>=0)this._animationList[n].animTrack=e;else{const s=this._getNodeFromPath(t);s.animTrack=e,this._animationList.push(s)}this._updateHasAnimations()}_updateHasAnimations(){this._hasAnimations=this._animationList.length>0&&this._animationList.every(t=>t.animTrack&&t.animTrack!==Hg.EMPTY)}get name(){return this._name}set animations(t){this._animationList=t,this._updateHasAnimations()}get animations(){return this._animationList}get hasAnimations(){return this._hasAnimations}set speed(t){this._speed=t}get speed(){return this._speed}set loop(t){this._loop=t}get loop(){return this._loop}get nodeCount(){return this._blendTree&&this._blendTree.constructor!==$g?this._blendTree.getNodeCount():1}get playable(){return-1!==Fg.indexOf(this.name)||this.animations.length===this.nodeCount}get looping(){if(this.animations.length>0){const t=`${this.name}.${this.animations[0].animTrack.name}`,e=this._controller.animEvaluator.findClip(t);if(e)return e.loop}return!1}get totalWeight(){let t=0;for(let e=0;e<this.animations.length;e++)t+=this.animations[e].weight;return t}get timelineDuration(){let t=0;for(let e=0;e<this.animations.length;e++){const s=this.animations[e];s.animTrack.duration>t&&(t=s.animTrack.duration)}return t}}class Jg{constructor({from:t,to:e,time:s=0,priority:n=0,conditions:i=[],exitTime:r=null,transitionOffset:a=null,interruptionSource:o=Dg}){this._from=t,this._to=e,this._time=s,this._priority=n,this._conditions=i,this._exitTime=r,this._transitionOffset=a,this._interruptionSource=o}get from(){return this._from}set to(t){this._to=t}get to(){return this._to}get time(){return this._time}get priority(){return this._priority}get conditions(){return this._conditions}get exitTime(){return this._exitTime}get transitionOffset(){return this._transitionOffset}get interruptionSource(){return this._interruptionSource}get hasExitTime(){return!!this.exitTime}}class t_{constructor(t,e,s,n,i,r,a){this._states={},this._stateNames=[],this._findTransitionsFromStateCache={},this._findTransitionsBetweenStatesCache={},this._previousStateName=null,this._activeStateName=Mg,this._activeStateDuration=0,this._activeStateDurationDirty=!0,this._playing=!1,this._currTransitionTime=1,this._totalTransitionTime=1,this._isTransitioning=!1,this._transitionInterruptionSource=Dg,this._transitionPreviousStates=[],this._timeInState=0,this._timeInStateBefore=0,this.findParameter=t=>this._findParameter(t),this._animEvaluator=t,this._eventHandler=i,this._findParameter=r,this._consumeTrigger=a;for(let t=0;t<e.length;t++)this._states[e[t].name]=new Zg(this,e[t].name,e[t].speed,e[t].loop,e[t].blendTree),this._stateNames.push(e[t].name);this._transitions=s.map(t=>new Jg({...t})),this._activate=n}get animEvaluator(){return this._animEvaluator}set activeState(t){this._activeStateName=t}get activeState(){return this._findState(this._activeStateName)}get activeStateName(){return this._activeStateName}get activeStateAnimations(){return this.activeState.animations}set previousState(t){this._previousStateName=t}get previousState(){return this._findState(this._previousStateName)}get previousStateName(){return this._previousStateName}get playable(){let t=!0;for(let e=0;e<this._stateNames.length;e++)this._states[this._stateNames[e]].playable||(t=!1);return t}set playing(t){this._playing=t}get playing(){return this._playing}get activeStateProgress(){return this._getActiveStateProgressForTime(this._timeInState)}get activeStateDuration(){if(this._activeStateDurationDirty){let t=0;for(let e=0;e<this.activeStateAnimations.length;e++){const s=this._animEvaluator.findClip(this.activeStateAnimations[e].name);s&&(t=Math.max(t,s.track.duration))}this._activeStateDuration=t,this._activeStateDurationDirty=!1}return this._activeStateDuration}set activeStateCurrentTime(t){this._timeInStateBefore=t,this._timeInState=t;for(let e=0;e<this.activeStateAnimations.length;e++){const s=this.animEvaluator.findClip(this.activeStateAnimations[e].name);s&&(s.time=t)}}get activeStateCurrentTime(){return this._timeInState}get transitioning(){return this._isTransitioning}get transitionProgress(){return this._currTransitionTime/this._totalTransitionTime}get states(){return this._stateNames}assignMask(t){return this._animEvaluator.assignMask(t)}_findState(t){return this._states[t]}_getActiveStateProgressForTime(t){if(this.activeStateName===Mg||this.activeStateName===kg||this.activeStateName===Og)return 1;const e=this._animEvaluator.findClip(this.activeStateAnimations[0].name);return e?e.progressForTime(t):null}_findTransitionsFromState(t){let e=this._findTransitionsFromStateCache[t];return e||(e=this._transitions.filter(e=>e.from===t),ku(e),this._findTransitionsFromStateCache[t]=e),e}_findTransitionsBetweenStates(t,e){let s=this._findTransitionsBetweenStatesCache[`${t}->${e}`];return s||(s=this._transitions.filter(s=>s.from===t&&s.to===e),ku(s),this._findTransitionsBetweenStatesCache[`${t}->${e}`]=s),s}_transitionHasConditionsMet(t){const e=t.conditions;for(let t=0;t<e.length;t++){const s=e[t],n=this._findParameter(s.parameterName);switch(s.predicate){case"GREATER_THAN":if(!(n.value>s.value))return!1;break;case"LESS_THAN":if(!(n.value<s.value))return!1;break;case"GREATER_THAN_EQUAL_TO":if(!(n.value>=s.value))return!1;break;case"LESS_THAN_EQUAL_TO":if(!(n.value<=s.value))return!1;break;case"EQUAL_TO":if(n.value!==s.value)return!1;break;case"NOT_EQUAL_TO":if(n.value===s.value)return!1}}return!0}_findTransition(t,e){let s=[];if(t&&e)s=s.concat(this._findTransitionsBetweenStates(t,e));else if(this._isTransitioning)switch(this._transitionInterruptionSource){case"PREV_STATE":s=s.concat(this._findTransitionsFromState(this._previousStateName)),s=s.concat(this._findTransitionsFromState(Og));break;case"NEXT_STATE":s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState(Og));break;case"PREV_STATE_NEXT_STATE":s=s.concat(this._findTransitionsFromState(this._previousStateName)),s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState(Og));break;case"NEXT_STATE_PREV_STATE":s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState(this._previousStateName)),s=s.concat(this._findTransitionsFromState(Og))}else s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState(Og));if(s=s.filter(t=>{if(t.to===this.activeStateName)return!1;if(t.hasExitTime){let e=this._getActiveStateProgressForTime(this._timeInStateBefore),s=this._getActiveStateProgressForTime(this._timeInState);if(t.exitTime<1&&this.activeState.loop&&(e-=Math.floor(e),s-=Math.floor(s)),s===e){if(s!==t.exitTime)return null}else if(!(t.exitTime>e&&t.exitTime<=s))return null}return this._transitionHasConditionsMet(t)}),s.length>0){const t=s[0];if(t.to===kg){const e=this._findTransitionsFromState(Mg)[0];t.to=e.to}return t}return null}updateStateFromTransition(t){let e,s,n;this.previousState=t.from?this.activeStateName:null,this.activeState=t.to,this._activeStateDurationDirty=!0;for(let e=0;e<t.conditions.length;e++){const s=t.conditions[e];this._findParameter(s.parameterName).type===Rg&&this._consumeTrigger(s.parameterName)}if(this.previousState){this._isTransitioning||(this._transitionPreviousStates=[]),this._transitionPreviousStates.push({name:this._previousStateName,weight:1});const t=Math.min(0!==this._totalTransitionTime?this._currTransitionTime/this._totalTransitionTime:1,1);for(let i=0;i<this._transitionPreviousStates.length;i++){this._isTransitioning?i!==this._transitionPreviousStates.length-1?this._transitionPreviousStates[i].weight*=1-t:this._transitionPreviousStates[i].weight=t:this._transitionPreviousStates[i].weight=1,e=this._findState(this._transitionPreviousStates[i].name);for(let t=0;t<e.animations.length;t++)s=e.animations[t],n=this._animEvaluator.findClip(`${s.name}.previous.${i}`),n||(n=this._animEvaluator.findClip(s.name),n.name=`${s.name}.previous.${i}`),i!==this._transitionPreviousStates.length-1&&n.pause()}}this._isTransitioning=!0,this._totalTransitionTime=t.time,this._currTransitionTime=0,this._transitionInterruptionSource=t.interruptionSource;const i=this.activeState,r=t.transitionOffset&&t.transitionOffset>0&&t.transitionOffset<1;let a=0,o=0;if(r){const e=i.timelineDuration*t.transitionOffset;a=e,o=e}this._timeInState=a,this._timeInStateBefore=o;for(let e=0;e<i.animations.length;e++){if(n=this._animEvaluator.findClip(i.animations[e].name),n)n.reset();else{const t=Number.isFinite(i.animations[e].speed)?i.animations[e].speed:i.speed;n=new Ag(i.animations[e].animTrack,this._timeInState,t,!0,i.loop,this._eventHandler),n.name=i.animations[e].name,this._animEvaluator.addClip(n)}if(t.time>0?n.blendWeight=0:n.blendWeight=i.animations[e].normalizedWeight,n.play(),r)n.time=i.timelineDuration*t.transitionOffset;else{const t=i.speed>=0?0:this.activeStateDuration;n.time=t}}}_transitionToState(t){if(!this._findState(t))return;let e=this._findTransition(this._activeStateName,t);e||(this._animEvaluator.removeClips(),e=new Jg({from:null,to:t})),this.updateStateFromTransition(e)}assignAnimation(t,e,s,n){const i=t.split(".");let r=this._findState(i[0]);r||(r=new Zg(this,i[0],s),this._states[i[0]]=r,this._stateNames.push(i[0])),r.addAnimation(i,e),this._animEvaluator.updateClipTrack(r.name,e),void 0!==s&&(r.speed=s),void 0!==n&&(r.loop=n),!this._playing&&this._activate&&this.playable&&this.play(),this._activeStateDurationDirty=!0}removeNodeAnimations(t){if(-1!==Fg.indexOf(t))return!1;const e=this._findState(t);return!!e&&(e.animations=[],!0)}play(t){t&&this._transitionToState(t),this._playing=!0}pause(){this._playing=!1}reset(){this._previousStateName=null,this._activeStateName=Mg,this._playing=!1,this._currTransitionTime=1,this._totalTransitionTime=1,this._isTransitioning=!1,this._timeInState=0,this._timeInStateBefore=0,this._animEvaluator.removeClips()}rebind(){this._animEvaluator.rebind()}update(t){if(!this._playing)return;let e,s,n;(this.activeState.loop||this._timeInState<this.activeStateDuration)&&(this._timeInStateBefore=this._timeInState,this._timeInState+=t*this.activeState.speed,!this.activeState.loop&&this._timeInState>this.activeStateDuration&&(this._timeInState=this.activeStateDuration,t=this.activeStateDuration-this._timeInStateBefore));const i=this._findTransition(this._activeStateName);if(i&&this.updateStateFromTransition(i),this._isTransitioning)if(this._currTransitionTime+=t,this._currTransitionTime<=this._totalTransitionTime){const t=0!==this._totalTransitionTime?this._currTransitionTime/this._totalTransitionTime:1;for(let i=0;i<this._transitionPreviousStates.length;i++){e=this._findState(this._transitionPreviousStates[i].name);const r=this._transitionPreviousStates[i].weight;for(let a=0;a<e.animations.length;a++)s=e.animations[a],n=this._animEvaluator.findClip(`${s.name}.previous.${i}`),n&&(n.blendWeight=(1-t)*s.normalizedWeight*r)}e=this.activeState;for(let n=0;n<e.animations.length;n++)s=e.animations[n],this._animEvaluator.findClip(s.name).blendWeight=t*s.normalizedWeight}else{this._isTransitioning=!1;const t=this.activeStateAnimations.length,i=this._animEvaluator.clips.length;for(let e=0;e<i-t;e++)this._animEvaluator.removeClip(0);this._transitionPreviousStates=[],e=this.activeState;for(let t=0;t<e.animations.length;t++)s=e.animations[t],n=this._animEvaluator.findClip(s.name),n&&(n.blendWeight=s.normalizedWeight)}else if(this.activeState._blendTree.constructor!==$g){e=this.activeState;for(let t=0;t<e.animations.length;t++)s=e.animations[t],n=this._animEvaluator.findClip(s.name),n&&(n.blendWeight=s.normalizedWeight,s.parent.syncAnimations&&(n.speed=s.speed))}this._animEvaluator.update(t,this.activeState.hasAnimations)}}const e_=new os,s_=new rs,n_=new ls,i_=new Ze,r_=new ms;class a_ extends jg{constructor(t,e,s,n,i){super(e),this.animComponent=t,this._mask=n,this.layerName=s,this.layerIndex=i}static _packFloat(t){return t[0]}static _packBoolean(t){return!!t[0]}static _packVec2(t){return e_.x=t[0],e_.y=t[1],e_}static _packVec3(t){return s_.x=t[0],s_.y=t[1],s_.z=t[2],s_}static _packVec4(t){return n_.x=t[0],n_.y=t[1],n_.z=t[2],n_.w=t[3],n_}static _packColor(t){return i_.r=t[0],i_.g=t[1],i_.b=t[2],i_.a=t[3],i_}static _packQuat(t){return r_.x=t[0],r_.y=t[1],r_.z=t[2],r_.w=t[3],r_}resolve(t){const e=Gg.encode(t.entityPath,t.component,t.propertyPath);let s,n,i,r=this.targetCache[e];if(r)return r;switch(t.component){case"entity":s=this._getEntityFromHierarchy(t.entityPath),i=Gg.encode(s.path,"entity",t.propertyPath),n=s;break;case"graph":if(n=this.findNode(t),!n)return null;i=Gg.encode(n.path,"graph",t.propertyPath);break;default:if(s=this._getEntityFromHierarchy(t.entityPath),n=s.findComponent(t.component),!n)return null;i=Gg.encode(s.path,t.component,t.propertyPath)}return r=this._createAnimTargetForProperty(n,t.propertyPath,i),this.targetCache[e]=r,r}update(t){const e=this.activeNodes;if(e)for(let t=0;t<e.length;t++)e[t]._dirtifyLocal()}_getEntityFromHierarchy(t){if(!this.animComponent.entity.name===t[0])return null;const e=this.animComponent.entity;return 1===t.length?e:e._parent.findByPath(t)}_resolvePath(t,e,s){const n=e.length-(s?0:1);for(let s=0;s<n;s++)t=t[e[s]];return t}_setter(t,e,s){const n=this._resolvePath(t,e),i=e[e.length-1],r=`set${i.substring(0,1).toUpperCase()}${i.substring(1)}`;if(n[r]){let t=n[`get${i.substring(0,1).toUpperCase()}${i.substring(1)}`].bind(n)();t=[t.x,t.y,t.z,t.w];const e=n[r].bind(n);return{set:t=>{e(s(t))},get:()=>t}}const a=n[i];if("object"==typeof a&&a.hasOwnProperty("copy"))return function(t){a.copy(s(t))};if(-1!==[os,rs,ls,Ze,ms].indexOf(n.constructor)&&e.length>1){const r=e.length>2?this._resolvePath(t,e.slice(0,-1)):t,a=e[e.length-2];return function(t){n[i]=s(t),r[a]=n}}return function(t){n[i]=s(t)}}_createAnimTargetForProperty(t,e,s){if(this.handlers&&e[0].startsWith("weight."))return this.handlers.weight(t,e[0].replace("weight.",""));if(this.handlers&&"material"===e[0]&&2===e.length){const s=e[1];if(s.endsWith("Map"))return this.handlers.materialTexture(t,s)}const n=this._resolvePath(t,e,!0);if(void 0===n)return null;let i,r,a;if("number"==typeof n)i=this._setter(t,e,a_._packFloat),r="vector",a=1;else if("boolean"==typeof n)i=this._setter(t,e,a_._packBoolean),r="vector",a=1;else if("object"==typeof n)switch(n.constructor){case os:i=this._setter(t,e,a_._packVec2),r="vector",a=2;break;case rs:i=this._setter(t,e,a_._packVec3),r="vector",a=3;break;case ls:i=this._setter(t,e,a_._packVec4),r="vector",a=4;break;case Ze:i=this._setter(t,e,a_._packColor),r="vector",a=4;break;case ms:i=this._setter(t,e,a_._packQuat),r="quaternion",a=4;break;default:return null}return-1!==e.indexOf("material")?new Wg(e=>{i(e),t.material.update()},r,a,s):new Wg(i,r,a,s)}rebind(){this.targetCache={},this.animComponent.rootBone?this.graph=this.animComponent.rootBone:this.graph=this.animComponent.entity;const t={},e=function(s){t[s.name]=s;for(let t=0;t<s.children.length;++t)e(s.children[t])};e(this.graph),this.nodes=t}}class o_{constructor(t,e,s,n=1,i=Ng){this._mask=null,this._blendTime=0,this._blendTimeElapsed=0,this._startingWeight=0,this._targetWeight=0,this._name=t,this._controller=e,this._component=s,this._weight=n,this._blendType=i}get name(){return this._name}set playing(t){this._controller.playing=t}get playing(){return this._controller.playing}get playable(){return this._controller.playable}get activeState(){return this._controller.activeStateName}get previousState(){return this._controller.previousStateName}get activeStateProgress(){return this._controller.activeStateProgress}get activeStateDuration(){return this._controller.activeStateDuration}set activeStateCurrentTime(t){const e=this._controller,s=e.playing;e.playing=!0,e.activeStateCurrentTime=t,s||e.update(0),e.playing=s}get activeStateCurrentTime(){return this._controller.activeStateCurrentTime}get transitioning(){return this._controller.transitioning}get transitionProgress(){return this.transitioning?this._controller.transitionProgress:null}get states(){return this._controller.states}set weight(t){this._weight=t,this._component.dirtifyTargets()}get weight(){return this._weight}set blendType(t){t!==this._blendType&&(this._blendType=t,this._controller.normalizeWeights&&this._component.rebind())}get blendType(){return this._blendType}set mask(t){this._controller.assignMask(t)&&this._component.rebind(),this._mask=t}get mask(){return this._mask}play(t){this._controller.play(t)}pause(){this._controller.pause()}reset(){this._controller.reset()}rebind(){this._controller.rebind()}update(t){this._blendTime&&(this._blendTimeElapsed<this._blendTime?(this.weight=Qe.lerp(this._startingWeight,this._targetWeight,this._blendTimeElapsed/this._blendTime),this._blendTimeElapsed+=t):(this.weight=this._targetWeight,this._blendTime=0,this._blendTimeElapsed=0,this._startingWeight=0,this._targetWeight=0)),this._controller.update(t)}blendToWeight(t,e){this._startingWeight=this.weight,this._targetWeight=t,this._blendTime=Math.max(0,e),this._blendTimeElapsed=0}assignAnimation(t,e,s,n){e instanceof Hg&&(this._controller.assignAnimation(t,e,s,n),0===this._controller._transitions.length&&this._controller._transitions.push(new Jg({from:"START",to:t})),this._component.activate&&this._component.playable&&(this._component.playing=!0))}removeNodeAnimations(t){this._controller.removeNodeAnimations(t)&&(this._component.playing=!1)}getAnimationAsset(t){return this._component.animationAssets[`${this.name}:${t}`]}transition(t,e=0,s=null){this._controller.updateStateFromTransition(new Jg({from:this._controller.activeStateName,to:t,time:e,transitionOffset:s}))}}class l_{constructor(t){if(this._layers=[],this._parameters={},Array.isArray(t.layers))this._layers=t.layers;else for(const e in t.layers){const s=t.layers[e],n={name:s.name,blendType:s.blendType,weight:s.weight,states:[],transitions:[]};for(let e=0;e<s.states.length;e++)n.states.push(t.states[s.states[e]]);for(let e=0;e<s.transitions.length;e++){const i=t.transitions[s.transitions[e]];if(i.conditions&&!Array.isArray(i.conditions)){const t=Object.keys(i.conditions),e=[];for(let s=0;s<t.length;s++){const n=i.conditions[t[s]];n.parameterName&&e.push(n)}i.conditions=e}Number.isInteger(i.from)&&(i.from=t.states[i.from].name),Number.isInteger(i.to)&&(i.to=t.states[i.to].name),n.transitions.push(i)}this._layers.push(n)}for(const e in t.parameters){const s=t.parameters[e];this._parameters[s.name]={type:s.type,value:s.value}}}get parameters(){return Object.assign({},this._parameters)}get layers(){return this._layers}}class h_ extends xg{set stateGraphAsset(t){if(null===t)return void this.removeStateGraph();if(this._stateGraphAsset){this.system.app.assets.get(this._stateGraphAsset).off("change",this._onStateGraphAssetChangeEvent,this)}let e,s;t instanceof Fm?(e=t.id,s=this.system.app.assets.get(e),s||(this.system.app.assets.add(t),s=this.system.app.assets.get(e))):(e=t,s=this.system.app.assets.get(e)),s&&this._stateGraphAsset!==e&&(s.resource?(this._stateGraph=s.resource,this.loadStateGraph(this._stateGraph),s.on("change",this._onStateGraphAssetChangeEvent,this)):(s.once("load",t=>{this._stateGraph=t.resource,this.loadStateGraph(this._stateGraph)}),s.on("change",this._onStateGraphAssetChangeEvent,this),this.system.app.assets.load(s)),this._stateGraphAsset=e)}get stateGraphAsset(){return this._stateGraphAsset}set normalizeWeights(t){this._normalizeWeights=t,this.unbind()}get normalizeWeights(){return this._normalizeWeights}set animationAssets(t){this._animationAssets=t,this.loadAnimationAssets()}get animationAssets(){return this._animationAssets}set speed(t){this._speed=t}get speed(){return this._speed}set activate(t){this._activate=t}get activate(){return this._activate}set playing(t){this._playing=t}get playing(){return this._playing}set rootBone(t){if("string"==typeof t){const e=this.entity.root.findByGuid(t);this._rootBone=e}else this._rootBone=t instanceof Jm?t:null;this.rebind()}get rootBone(){return this._rootBone}set stateGraph(t){this._stateGraph=t}get stateGraph(){return this._stateGraph}get layers(){return this._layers}set layerIndices(t){this._layerIndices=t}get layerIndices(){return this._layerIndices}set parameters(t){this._parameters=t}get parameters(){return this._parameters}set targets(t){this._targets=t}get targets(){return this._targets}get playable(){for(let t=0;t<this._layers.length;t++)if(!this._layers[t].playable)return!1;return!0}get baseLayer(){return this._layers.length>0?this._layers[0]:null}_onStateGraphAssetChangeEvent(t){const e=this.animationAssets,s=this.layers.map(t=>t.mask);this.removeStateGraph(),this._stateGraph=new l_(t._data),this.loadStateGraph(this._stateGraph),this.animationAssets=e,this.loadAnimationAssets(),this.layers.forEach((t,e)=>{t.mask=s[e]}),this.rebind()}dirtifyTargets(){const t=Object.values(this._targets);for(let e=0;e<t.length;e++)t[e].dirty=!0}_addLayer({name:t,states:e,transitions:s,weight:n,mask:i,blendType:r}){let a;a=this.rootBone?this.rootBone:this.entity;const o=this._layers.length,l=new a_(this,a,t,i,o),h=new Ug(l),c=new t_(h,e,s,this._activate,this,this.findParameter,this.consumeTrigger);return this._layers.push(new o_(t,c,this,n,r)),this._layerIndices[t]=o,this._layers[o]}addLayer(t,e,s,n){const i=this.findAnimationLayer(t);if(i)return i;return this._addLayer({name:t,states:[{name:"START",speed:1}],transitions:[],weight:e,mask:s,blendType:n})}_assignParameters(t){this._parameters={};const e=Object.keys(t.parameters);for(let s=0;s<e.length;s++){const n=e[s];this._parameters[n]={type:t.parameters[n].type,value:t.parameters[n].value}}}loadStateGraph(t){this._stateGraph=t,this._assignParameters(t),this._layers=[];let e=!1;for(let s=0;s<t.layers.length;s++){const n=t.layers[s];this._addLayer({...n}),n.states.some(t=>t.blendTree)&&(e=!0)}e||this.setupAnimationAssets()}setupAnimationAssets(){for(let t=0;t<this._layers.length;t++){const e=this._layers[t],s=e.name;for(let t=0;t<e.states.length;t++){const n=e.states[t];if(-1===Fg.indexOf(n)){const t=`${s}:${n}`;this._animationAssets[t]||(this._animationAssets[t]={asset:null})}}}this.loadAnimationAssets()}loadAnimationAssets(){for(let t=0;t<this._layers.length;t++){const e=this._layers[t];for(let t=0;t<e.states.length;t++){const s=e.states[t];if(-1!==Fg.indexOf(s))continue;const n=this._animationAssets[`${e.name}:${s}`];if(!n||!n.asset){this.findAnimationLayer(e.name).assignAnimation(s,Hg.EMPTY);continue}const i=n.asset,r=this.system.app.assets.get(i);r&&(r.resource?this.onAnimationAssetLoaded(e.name,s,r):(r.once("load",function(t,e){return function(s){this.onAnimationAssetLoaded(t,e,s)}.bind(this)}.bind(this)(e.name,s)),this.system.app.assets.load(r)))}}}onAnimationAssetLoaded(t,e,s){this.findAnimationLayer(t).assignAnimation(e,s.resource)}removeStateGraph(){this._stateGraph=null,this._stateGraphAsset=null,this._animationAssets={},this._layers=[],this._layerIndices={},this._parameters={},this._playing=!1,this.unbind(),this._targets={}}reset(){this._assignParameters(this._stateGraph);for(let t=0;t<this._layers.length;t++){const e=this._layers[t].playing;this._layers[t].reset(),this._layers[t].playing=e}}unbind(){this._normalizeWeights||Object.keys(this._targets).forEach(t=>{this._targets[t].unbind()})}rebind(){this._targets={};for(let t=0;t<this._layers.length;t++)this._layers[t].rebind()}findAnimationLayer(t){const e=this._layerIndices[t];return this._layers[e]||null}addAnimationState(t,e,s=1,n=!0,i="Base"){this._stateGraph||this.loadStateGraph(new l_({layers:[{name:i,states:[{name:"START",speed:1},{name:t,speed:s,loop:n,defaultState:!0}],transitions:[{from:"START",to:t}]}],parameters:{}}));const r=this.findAnimationLayer(i);r?r.assignAnimation(t,e,s,n):this.addLayer(i)?.assignAnimation(t,e,s,n)}assignAnimation(t,e,s,n=1,i=!0){if(!this._stateGraph&&-1===t.indexOf("."))return this.loadStateGraph(new l_({layers:[{name:"Base",states:[{name:"START",speed:1},{name:t,speed:n,loop:i,defaultState:!0}],transitions:[{from:"START",to:t}]}],parameters:{}})),void this.baseLayer.assignAnimation(t,e);const r=s?this.findAnimationLayer(s):this.baseLayer;r&&r.assignAnimation(t,e,n,i)}removeNodeAnimations(t,e){const s=e?this.findAnimationLayer(e):this.baseLayer;s&&s.removeNodeAnimations(t)}getParameterValue(t,e){const s=this._parameters[t];if(s&&s.type===e)return s.value}setParameterValue(t,e,s){const n=this._parameters[t];n&&n.type===e&&(n.value=s)}getFloat(t){return this.getParameterValue(t,Lg)}setFloat(t,e){this.setParameterValue(t,Lg,e)}getInteger(t){return this.getParameterValue(t,Pg)}setInteger(t,e){"number"==typeof e&&e%1==0&&this.setParameterValue(t,Pg,e)}getBoolean(t){return this.getParameterValue(t,Ig)}setBoolean(t,e){this.setParameterValue(t,Ig,!!e)}getTrigger(t){return this.getParameterValue(t,Rg)}setTrigger(t,e=!1){this.setParameterValue(t,Rg,!0),e&&this._consumedTriggers.add(t)}resetTrigger(t){this.setParameterValue(t,Rg,!1)}onBeforeRemove(){if(Number.isFinite(this._stateGraphAsset)){this.system.app.assets.get(this._stateGraphAsset).off("change",this._onStateGraphAssetChangeEvent,this)}}update(t){for(let e=0;e<this.layers.length;e++)this.layers[e].update(t*this.speed);this._consumedTriggers.forEach(t=>{this.parameters[t].value=!1}),this._consumedTriggers.clear()}resolveDuplicatedEntityReferenceProperties(t,e){t.rootBone&&e[t.rootBone.getGuid()]?this.rootBone=e[t.rootBone.getGuid()]:this.rebind()}constructor(...t){super(...t),this._stateGraphAsset=null,this._animationAssets={},this._speed=1,this._activate=!0,this._playing=!1,this._rootBone=null,this._stateGraph=null,this._layers=[],this._layerIndices={},this._parameters={},this._targets={},this._consumedTriggers=new Set,this._normalizeWeights=!1,this.findParameter=t=>this._parameters[t],this.consumeTrigger=t=>{this._consumedTriggers.add(t)}}}class c_{constructor(){this.enabled=!0}}const d_=["enabled"];class u_ extends wg{constructor(t){super(t),this.id="anim",this.ComponentType=h_,this.DataType=c_,this.schema=d_,this.on("beforeremove",this.onBeforeRemove,this),this.app.systems.on("animationUpdate",this.onAnimationUpdate,this)}initializeComponentData(t,e,s){super.initializeComponentData(t,e,d_);const n=["animationAssets","stateGraph","layers","masks"];Object.keys(e).forEach(s=>{n.includes(s)||(t[s]=e[s])}),e.stateGraph&&(t.stateGraph=e.stateGraph,t.loadStateGraph(t.stateGraph)),e.layers&&e.layers.forEach((e,s)=>{e._controller.states.forEach(n=>{e._controller._states[n]._animationList.forEach(n=>{if(n.animTrack&&n.animTrack!==Hg.EMPTY)t.layers[s].assignAnimation(n.name,n.animTrack);else{const i=this.app.assets.get(e._component._animationAssets[`${e.name}:${n.name}`].asset);i&&!i.loaded&&i.once("load",()=>{t.layers[s].assignAnimation(n.name,i.resource)})}})})}),e.animationAssets&&(t.animationAssets=Object.assign(t.animationAssets,e.animationAssets)),e.masks&&Object.keys(e.masks).forEach(s=>{if(t.layers[s]){const n=e.masks[s].mask,i={};Object.keys(n).forEach(t=>{i[decodeURI(t)]=n[t]}),t.layers[s].mask=i}})}onAnimationUpdate(t){const e=this.store;for(const s in e)if(e.hasOwnProperty(s)){const n=e[s].entity.anim;n.data.enabled&&n.entity.enabled&&n.playing&&n.update(t)}}cloneComponent(t,e){let s;t.anim.rootBone&&t.anim.rootBone!==t||(s={},t.anim.layers.forEach((t,n)=>{if(t.mask){const i={};Object.keys(t.mask).forEach(s=>{const n=s.split("/");n.shift();const r=[e.name,...n].join("/");i[r]=t.mask[s]}),s[n]={mask:i}}}));const n={enabled:t.anim.enabled,stateGraphAsset:t.anim.stateGraphAsset,animationAssets:t.anim.animationAssets,speed:t.anim.speed,activate:t.anim.activate,playing:t.anim.playing,rootBone:t.anim.rootBone,stateGraph:t.anim.stateGraph,layers:t.anim.layers,layerIndices:t.anim.layerIndices,parameters:t.anim.parameters,normalizeWeights:t.anim.normalizeWeights,masks:s};return this.addComponent(e,n)}onBeforeRemove(t,e){e.onBeforeRemove()}destroy(){super.destroy(),this.app.systems.off("animationUpdate",this.onAnimationUpdate,this)}}xg._buildAccessors(h_.prototype,d_);const f_="static",p_="dynamic",m_="kinematic";class g_{destroy(t){this.map.forEach(t=>t.mesh.destroy())}constructor(){this.map=new Map}}const __=new di,v_=(t,e)=>{const s=__.get(t,()=>new g_);let n=s.map.get(e);if(!n){let i,r;switch(e){case"box":i=tc.fromGeometry(t,new lf),r={x:2,y:2,z:2,uv:2/3};break;case"capsule":i=tc.fromGeometry(t,new wp({radius:.5,height:2})),r={x:2*Math.PI,y:Math.PI,z:2*Math.PI,uv:1/3+1/3/3*2};break;case"cone":i=tc.fromGeometry(t,new Tp({baseRadius:.5,peakRadius:0,height:1})),r={x:2.54,y:2.54,z:2.54,uv:1/3+1/3/3};break;case"cylinder":i=tc.fromGeometry(t,new Cp({radius:.5,height:1})),r={x:Math.PI,y:1.58,z:Math.PI,uv:1/3+1/3/3*2};break;case"plane":i=tc.fromGeometry(t,new Ep({halfExtents:new os(.5,.5),widthSegments:1,lengthSegments:1})),r={x:0,y:1,z:0,uv:1};break;case"sphere":i=tc.fromGeometry(t,new hf({radius:.5})),r={x:Math.PI,y:Math.PI,z:Math.PI,uv:1};break;case"torus":i=tc.fromGeometry(t,new Ap({tubeRadius:.2,ringRadius:.3})),r={x:.5*Math.PI*.5-.1*Math.PI*.1,y:.4,z:.4,uv:1};break;default:throw new Error(`Invalid primitive type: ${e}`)}i.incRefCount(),n={mesh:i,area:r},s.map.set(e,n)}return n};class y_ extends gr{constructor(t,e){super(),this.skin=t,this.skinInstance=e}}class b_{static{this._skinInstanceCache=new Map}static createCachedSkinInstance(t,e,s){let n=b_.getCachedSkinInstance(t,e);return n||(n=new Yh(t),n.resolve(e,s),b_.addCachedSkinInstance(t,e,n)),n}static getCachedSkinInstance(t,e){let s=null;const n=b_._skinInstanceCache.get(e);if(n){const e=n.find(e=>e.skin===t);e&&(e.incRefCount(),s=e.skinInstance)}return s}static addCachedSkinInstance(t,e,s){let n=b_._skinInstanceCache.get(e);n||(n=[],b_._skinInstanceCache.set(e,n));let i=n.find(e=>e.skin===t);i||(i=new y_(t,s),n.push(i)),i.incRefCount()}static removeCachedSkinInstance(t){if(t){const e=t.rootBone;if(e){const s=b_._skinInstanceCache.get(e);if(s){const n=s.findIndex(e=>e.skinInstance===t);if(n>=0){const i=s[n];i.decRefCount(),0===i.refCount&&(s.splice(n,1),s.length||b_._skinInstanceCache.delete(e),t&&(t.destroy(),i.skinInstance=null))}}}}}}class S_{constructor(t,e,s,n,i){this._evtLoadById=null,this._evtUnloadById=null,this._evtAddById=null,this._evtRemoveById=null,this._evtLoadByUrl=null,this._evtAddByUrl=null,this._evtRemoveByUrl=null,this.propertyName=t,this.parent=e,this._scope=i,this._registry=s,this.id=null,this.url=null,this.asset=null,this._onAssetLoad=n.load,this._onAssetAdd=n.add,this._onAssetRemove=n.remove,this._onAssetUnload=n.unload}set id(t){if(this.url)throw Error("Can't set id and url");this._unbind(),this._id=t,this.asset=this._registry.get(this._id),this._bind()}get id(){return this._id}set url(t){if(this.id)throw Error("Can't set id and url");this._unbind(),this._url=t,this.asset=this._registry.getByUrl(this._url),this._bind()}get url(){return this._url}_bind(){this.id&&(this._onAssetLoad&&(this._evtLoadById=this._registry.on(`load:${this.id}`,this._onLoad,this)),this._onAssetAdd&&(this._evtAddById=this._registry.once(`add:${this.id}`,this._onAdd,this)),this._onAssetRemove&&(this._evtRemoveById=this._registry.on(`remove:${this.id}`,this._onRemove,this)),this._onAssetUnload&&(this._evtUnloadById=this._registry.on(`unload:${this.id}`,this._onUnload,this))),this.url&&(this._onAssetLoad&&(this._evtLoadByUrl=this._registry.on(`load:url:${this.url}`,this._onLoad,this)),this._onAssetAdd&&(this._evtAddByUrl=this._registry.once(`add:url:${this.url}`,this._onAdd,this)),this._onAssetRemove&&(this._evtRemoveByUrl=this._registry.on(`remove:url:${this.url}`,this._onRemove,this)))}_unbind(){this.id&&(this._evtLoadById?.off(),this._evtLoadById=null,this._evtAddById?.off(),this._evtAddById=null,this._evtRemoveById?.off(),this._evtRemoveById=null,this._evtUnloadById?.off(),this._evtUnloadById=null),this.url&&(this._evtLoadByUrl?.off(),this._evtLoadByUrl=null,this._evtAddByUrl?.off(),this._evtAddByUrl=null,this._evtRemoveByUrl?.off(),this._evtRemoveByUrl=null)}_onLoad(t){this._onAssetLoad.call(this._scope,this.propertyName,this.parent,t)}_onAdd(t){this.asset=t,this._onAssetAdd.call(this._scope,this.propertyName,this.parent,t)}_onRemove(t){this._onAssetRemove.call(this._scope,this.propertyName,this.parent,t),this.asset=null}_onUnload(t){this._onAssetUnload.call(this._scope,this.propertyName,this.parent,t)}}class x_ extends xg{constructor(t,e){super(t,e),this._type="asset",this._castShadows=!0,this._receiveShadows=!0,this._castShadowsLightmap=!0,this._lightmapped=!1,this._lightmapSizeMultiplier=1,this.isStatic=!1,this._batchGroupId=-1,this._layers=[0],this._renderStyle=0,this._meshInstances=[],this._customAabb=null,this._area=null,this._materialReferences=[],this._rootBone=null,this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._evtSetMeshes=null,this._assetReference=new S_("asset",this,t.app.assets,{add:this._onRenderAssetAdded,load:this._onRenderAssetLoad,remove:this._onRenderAssetRemove,unload:this._onRenderAssetUnload},this),this._material=t.defaultMaterial,e.on("remove",this.onRemoveChild,this),e.on("removehierarchy",this.onRemoveChild,this),e.on("insert",this.onInsertChild,this),e.on("inserthierarchy",this.onInsertChild,this)}set renderStyle(t){this._renderStyle!==t&&(this._renderStyle=t,fc._prepareRenderStyleForArray(this._meshInstances,t))}get renderStyle(){return this._renderStyle}set customAabb(t){this._customAabb=t;const e=this._meshInstances;if(e)for(let t=0;t<e.length;t++)e[t].setCustomAabb(this._customAabb)}get customAabb(){return this._customAabb}set type(t){if(this._type!==t&&(this._area=null,this._type=t,this.destroyMeshInstances(),"asset"!==t)){let e=this._material;e&&e!==this.system.defaultMaterial||(e=this._materialReferences[0]&&this._materialReferences[0].asset&&this._materialReferences[0].asset.resource);const s=v_(this.system.app.graphicsDevice,t);this._area=s.area,this.meshInstances=[new fc(s.mesh,e||this.system.defaultMaterial,this.entity)]}}get type(){return this._type}set meshInstances(t){if(this.destroyMeshInstances(),this._meshInstances=t,this._meshInstances){const t=this._meshInstances;for(let e=0;e<t.length;e++)t[e].node||(t[e].node=this.entity),t[e].castShadow=this._castShadows,t[e].receiveShadow=this._receiveShadows,t[e].renderStyle=this._renderStyle,t[e].setLightmapped(this._lightmapped),t[e].setCustomAabb(this._customAabb);this.enabled&&this.entity.enabled&&this.addToLayers()}}get meshInstances(){return this._meshInstances}set lightmapped(t){if(t!==this._lightmapped){this._lightmapped=t;const e=this._meshInstances;if(e)for(let s=0;s<e.length;s++)e[s].setLightmapped(t)}}get lightmapped(){return this._lightmapped}set castShadows(t){if(this._castShadows!==t){const e=this._meshInstances;if(e){const s=this.layers,n=this.system.app.scene;if(this._castShadows&&!t)for(let t=0;t<s.length;t++){const s=n.layers.getLayerById(this.layers[t]);s&&s.removeShadowCasters(e)}for(let s=0;s<e.length;s++)e[s].castShadow=t;if(!this._castShadows&&t)for(let t=0;t<s.length;t++){const i=n.layers.getLayerById(s[t]);i&&i.addShadowCasters(e)}}this._castShadows=t}}get castShadows(){return this._castShadows}set receiveShadows(t){if(this._receiveShadows!==t){this._receiveShadows=t;const e=this._meshInstances;if(e)for(let s=0;s<e.length;s++)e[s].receiveShadow=t}}get receiveShadows(){return this._receiveShadows}set castShadowsLightmap(t){this._castShadowsLightmap=t}get castShadowsLightmap(){return this._castShadowsLightmap}set lightmapSizeMultiplier(t){this._lightmapSizeMultiplier=t}get lightmapSizeMultiplier(){return this._lightmapSizeMultiplier}set layers(t){const e=this.system.app.scene.layers;let s;if(this._meshInstances)for(let t=0;t<this._layers.length;t++)s=e.getLayerById(this._layers[t]),s&&s.removeMeshInstances(this._meshInstances);this._layers.length=0;for(let e=0;e<t.length;e++)this._layers[e]=t[e];if(this.enabled&&this.entity.enabled&&this._meshInstances)for(let t=0;t<this._layers.length;t++)s=e.getLayerById(this._layers[t]),s&&s.addMeshInstances(this._meshInstances)}get layers(){return this._layers}set batchGroupId(t){this._batchGroupId!==t&&(this.entity.enabled&&this._batchGroupId>=0&&this.system.app.batcher?.remove(qh.RENDER,this.batchGroupId,this.entity),this.entity.enabled&&t>=0&&this.system.app.batcher?.insert(qh.RENDER,t,this.entity),t<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&this.addToLayers(),this._batchGroupId=t)}get batchGroupId(){return this._batchGroupId}set material(t){if(this._material!==t&&(this._material=t,this._meshInstances&&"asset"!==this._type))for(let e=0;e<this._meshInstances.length;e++)this._meshInstances[e].material=t}get material(){return this._material}set materialAssets(t=[]){if(this._materialReferences.length>t.length){for(let e=t.length;e<this._materialReferences.length;e++)this._materialReferences[e].id=null;this._materialReferences.length=t.length}for(let e=0;e<t.length;e++)if(this._materialReferences[e]||this._materialReferences.push(new S_(e,this,this.system.app.assets,{add:this._onMaterialAdded,load:this._onMaterialLoad,remove:this._onMaterialRemove,unload:this._onMaterialUnload},this)),t[e]){const s=t[e]instanceof Fm?t[e].id:t[e];this._materialReferences[e].id!==s&&(this._materialReferences[e].id=s),this._materialReferences[e].asset&&this._onMaterialAdded(e,this,this._materialReferences[e].asset)}else this._materialReferences[e].id=null,this._meshInstances[e]&&(this._meshInstances[e].material=this.system.defaultMaterial)}get materialAssets(){return this._materialReferences.map(t=>t.id)}set asset(t){const e=t instanceof Fm?t.id:t;this._assetReference.id!==e&&(this._assetReference.asset&&this._assetReference.asset.resource&&this._onRenderAssetRemove(),this._assetReference.id=e,this._assetReference.asset&&this._onRenderAssetAdded())}get asset(){return this._assetReference.id}assignAsset(t){const e=t instanceof Fm?t.id:t;this._assetReference.id=e}set rootBone(t){if(this._rootBone!==t){const e="string"==typeof t;if(this._rootBone&&e&&this._rootBone.getGuid()===t)return;this._rootBone&&this._clearSkinInstances(),this._rootBone=t instanceof Hc?t:e&&this.system.app.getEntityFromIndex(t)||null,this._rootBone&&this._cloneSkinInstances()}}get rootBone(){return this._rootBone}destroyMeshInstances(){const t=this._meshInstances;if(t){this.removeFromLayers(),this._clearSkinInstances();for(let e=0;e<t.length;e++)t[e].destroy();this._meshInstances.length=0}}addToLayers(){const t=this.system.app.scene.layers;for(let e=0;e<this._layers.length;e++){const s=t.getLayerById(this._layers[e]);s&&s.addMeshInstances(this._meshInstances)}}removeFromLayers(){if(this._meshInstances&&this._meshInstances.length){const t=this.system.app.scene.layers;for(let e=0;e<this._layers.length;e++){const s=t.getLayerById(this._layers[e]);s&&s.removeMeshInstances(this._meshInstances)}}}onRemoveChild(){this.removeFromLayers()}onInsertChild(){this._meshInstances&&this.enabled&&this.entity.enabled&&this.addToLayers()}onRemove(){this.destroyMeshInstances(),this.asset=null,this.materialAsset=null,this._assetReference.id=null;for(let t=0;t<this._materialReferences.length;t++)this._materialReferences[t].id=null;this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this)}onLayersChanged(t,e){this.addToLayers(),t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this)}onLayerAdded(t){this.layers.indexOf(t.id)<0||t.addMeshInstances(this._meshInstances)}onLayerRemoved(t){this.layers.indexOf(t.id)<0||t.removeMeshInstances(this._meshInstances)}onEnable(){const t=this.system.app,e=t.scene,s=e.layers;this._rootBone&&this._cloneSkinInstances(),this._evtLayersChanged=e.on("set:layers",this.onLayersChanged,this),s&&(this._evtLayerAdded=s.on("add",this.onLayerAdded,this),this._evtLayerRemoved=s.on("remove",this.onLayerRemoved,this));const n="asset"===this._type;this._meshInstances&&this._meshInstances.length?this.addToLayers():n&&this.asset&&this._onRenderAssetAdded();for(let t=0;t<this._materialReferences.length;t++)this._materialReferences[t].asset&&this.system.app.assets.load(this._materialReferences[t].asset);this._batchGroupId>=0&&t.batcher?.insert(qh.RENDER,this.batchGroupId,this.entity)}onDisable(){const t=this.system.app,e=t.scene.layers;this._evtLayersChanged?.off(),this._evtLayersChanged=null,this._rootBone&&this._clearSkinInstances(),e&&(this._evtLayerAdded?.off(),this._evtLayerAdded=null,this._evtLayerRemoved?.off(),this._evtLayerRemoved=null),this._batchGroupId>=0&&t.batcher?.remove(qh.RENDER,this.batchGroupId,this.entity),this.removeFromLayers()}hide(){if(this._meshInstances)for(let t=0;t<this._meshInstances.length;t++)this._meshInstances[t].visible=!1}show(){if(this._meshInstances)for(let t=0;t<this._meshInstances.length;t++)this._meshInstances[t].visible=!0}_onRenderAssetAdded(){this._assetReference.asset&&(this._assetReference.asset.resource?this._onRenderAssetLoad():this.enabled&&this.entity.enabled&&this.system.app.assets.load(this._assetReference.asset))}_onRenderAssetLoad(){if(this.destroyMeshInstances(),this._assetReference.asset){const t=this._assetReference.asset.resource;this._evtSetMeshes?.off(),this._evtSetMeshes=t.on("set:meshes",this._onSetMeshes,this),t.meshes&&this._onSetMeshes(t.meshes)}}_onSetMeshes(t){this._cloneMeshes(t)}_clearSkinInstances(){for(let t=0;t<this._meshInstances.length;t++){const e=this._meshInstances[t];b_.removeCachedSkinInstance(e.skinInstance),e.skinInstance=null}}_cloneSkinInstances(){if(this._meshInstances.length&&this._rootBone instanceof Hc)for(let t=0;t<this._meshInstances.length;t++){const e=this._meshInstances[t],s=e.mesh;s.skin&&!e.skinInstance&&(e.skinInstance=b_.createCachedSkinInstance(s.skin,this._rootBone,this.entity))}}_cloneMeshes(t){if(t&&t.length){const e=[];for(let s=0;s<t.length;s++){const n=t[s],i=this._materialReferences[s]&&this._materialReferences[s].asset&&this._materialReferences[s].asset.resource,r=new fc(n,i||this.system.defaultMaterial,this.entity);e.push(r),n.morph&&(r.morphInstance=new Xu(n.morph))}this.meshInstances=e,this._cloneSkinInstances()}}_onRenderAssetUnload(){"asset"===this._type&&this.destroyMeshInstances()}_onRenderAssetRemove(){this._evtSetMeshes?.off(),this._evtSetMeshes=null,this._onRenderAssetUnload()}_onMaterialAdded(t,e,s){s.resource?this._onMaterialLoad(t,e,s):this.enabled&&this.entity.enabled&&this.system.app.assets.load(s)}_updateMainMaterial(t,e){0===t&&(this.material=e)}_onMaterialLoad(t,e,s){this._meshInstances[t]&&(this._meshInstances[t].material=s.resource),this._updateMainMaterial(t,s.resource)}_onMaterialRemove(t,e,s){this._meshInstances[t]&&(this._meshInstances[t].material=this.system.defaultMaterial),this._updateMainMaterial(t,this.system.defaultMaterial)}_onMaterialUnload(t,e,s){this._meshInstances[t]&&(this._meshInstances[t].material=this.system.defaultMaterial),this._updateMainMaterial(t,this.system.defaultMaterial)}resolveDuplicatedEntityReferenceProperties(t,e){t.rootBone&&(this.rootBone=e[t.rootBone.getGuid()])}}class w_{constructor(){this.enabled=!0}}const T_=["enabled"],C_=["material","meshInstances","asset","materialAssets","castShadows","receiveShadows","castShadowsLightmap","lightmapped","lightmapSizeMultiplier","renderStyle","type","layers","isStatic","batchGroupId","rootBone"];class E_ extends wg{constructor(t){super(t),this.id="render",this.ComponentType=x_,this.DataType=w_,this.schema=T_,this.defaultMaterial=sc(t.graphicsDevice),this.on("beforeremove",this.onRemove,this)}initializeComponentData(t,e,s){null!==e.batchGroupId&&void 0!==e.batchGroupId||(e.batchGroupId=-1),e.layers&&e.layers.length&&(e.layers=e.layers.slice(0));for(let s=0;s<C_.length;s++)e.hasOwnProperty(C_[s])&&(t[C_[s]]=e[C_[s]]);e.aabbCenter&&e.aabbHalfExtents&&(t.customAabb=new Ss(new rs(e.aabbCenter),new rs(e.aabbHalfExtents))),super.initializeComponentData(t,e,T_)}cloneComponent(t,e){const s={};for(let e=0;e<C_.length;e++)s[C_[e]]=t.render[C_[e]];s.enabled=t.render.enabled,delete s.meshInstances;const n=this.addComponent(e,s),i=t.render.meshInstances,r=i.map(t=>t.mesh);n._onSetMeshes(r);for(let t=0;t<i.length;t++)n.meshInstances[t].material=i[t].material;return t.render.customAabb&&(n.customAabb=t.render.customAabb.clone()),n}onRemove(t,e){e.onRemove()}}xg._buildAccessors(x_.prototype,T_);class A_{constructor(t,e){this._pool=[],this._count=0,this._constructor=t,this._resize(e)}_resize(t){if(t>this._pool.length)for(let e=this._pool.length;e<t;e++)this._pool[e]=new this._constructor}allocate(){return this._count>=this._pool.length&&this._resize(2*this._pool.length),this._pool[this._count++]}freeAll(){this._count=0}}let D_,P_,L_,I_;const R_=new ms,M_=new ms,k_=new rs;class O_ extends xg{static{this.EVENT_CONTACT="contact"}static{this.EVENT_COLLISIONSTART="collisionstart"}static{this.EVENT_COLLISIONEND="collisionend"}static{this.EVENT_TRIGGERENTER="triggerenter"}static{this.EVENT_TRIGGERLEAVE="triggerleave"}static{this.order=-1}static onLibraryLoaded(){"undefined"!=typeof Ammo&&(D_=new Ammo.btTransform,P_=new Ammo.btVector3,L_=new Ammo.btVector3,I_=new Ammo.btQuaternion)}static onAppDestroy(){Ammo.destroy(D_),Ammo.destroy(P_),Ammo.destroy(L_),Ammo.destroy(I_),D_=null,P_=null,L_=null,I_=null}set angularDamping(t){this._angularDamping!==t&&(this._angularDamping=t,this._body&&this._body.setDamping(this._linearDamping,t))}get angularDamping(){return this._angularDamping}set angularFactor(t){this._angularFactor.equals(t)||(this._angularFactor.copy(t),this._body&&this._type===p_&&(P_.setValue(t.x,t.y,t.z),this._body.setAngularFactor(P_)))}get angularFactor(){return this._angularFactor}set angularVelocity(t){this._body&&this._type===p_&&(this._body.activate(),P_.setValue(t.x,t.y,t.z),this._body.setAngularVelocity(P_),this._angularVelocity.copy(t))}get angularVelocity(){if(this._body&&this._type===p_){const t=this._body.getAngularVelocity();this._angularVelocity.set(t.x(),t.y(),t.z())}return this._angularVelocity}set body(t){this._body!==t&&(this._body=t,t&&this._simulationEnabled&&t.activate())}get body(){return this._body}set friction(t){this._friction!==t&&(this._friction=t,this._body&&this._body.setFriction(t))}get friction(){return this._friction}set group(t){this._group!==t&&(this._group=t,this.enabled&&this.entity.enabled&&(this.disableSimulation(),this.enableSimulation()))}get group(){return this._group}set linearDamping(t){this._linearDamping!==t&&(this._linearDamping=t,this._body&&this._body.setDamping(t,this._angularDamping))}get linearDamping(){return this._linearDamping}set linearFactor(t){this._linearFactor.equals(t)||(this._linearFactor.copy(t),this._body&&this._type===p_&&(P_.setValue(t.x,t.y,t.z),this._body.setLinearFactor(P_)))}get linearFactor(){return this._linearFactor}set linearVelocity(t){this._body&&this._type===p_&&(this._body.activate(),P_.setValue(t.x,t.y,t.z),this._body.setLinearVelocity(P_),this._linearVelocity.copy(t))}get linearVelocity(){if(this._body&&this._type===p_){const t=this._body.getLinearVelocity();this._linearVelocity.set(t.x(),t.y(),t.z())}return this._linearVelocity}set mask(t){this._mask!==t&&(this._mask=t,this.enabled&&this.entity.enabled&&(this.disableSimulation(),this.enableSimulation()))}get mask(){return this._mask}set mass(t){if(this._mass!==t&&(this._mass=t,this._body&&this._type===p_)){const e=this.enabled&&this.entity.enabled;e&&this.disableSimulation(),this._body.getCollisionShape().calculateLocalInertia(t,P_),this._body.setMassProps(t,P_),this._body.updateInertiaTensor(),e&&this.enableSimulation()}}get mass(){return this._mass}set restitution(t){this._restitution!==t&&(this._restitution=t,this._body&&this._body.setRestitution(t))}get restitution(){return this._restitution}set rollingFriction(t){this._rollingFriction!==t&&(this._rollingFriction=t,this._body&&this._body.setRollingFriction(t))}get rollingFriction(){return this._rollingFriction}set type(t){if(this._type!==t){switch(this._type=t,this.disableSimulation(),t){case p_:this._group=1,this._mask=65535;break;case m_:this._group=4,this._mask=65535;break;default:this._group=2,this._mask=65533}this.createBody()}}get type(){return this._type}createBody(){const t=this.entity;let e;if(t.collision&&(e=t.collision.shape,t.trigger&&(t.trigger.destroy(),delete t.trigger)),e){this._body&&(this.system.removeBody(this._body),this.system.destroyBody(this._body),this._body=null);const s=this._type===p_?this._mass:0;this._getEntityTransform(D_);const n=this.system.createBody(s,e,D_);if(n.setRestitution(this._restitution),n.setFriction(this._friction),n.setRollingFriction(this._rollingFriction),n.setDamping(this._linearDamping,this._angularDamping),this._type===p_){const t=this._linearFactor;P_.setValue(t.x,t.y,t.z),n.setLinearFactor(P_);const e=this._angularFactor;P_.setValue(e.x,e.y,e.z),n.setAngularFactor(P_)}else this._type===m_&&(n.setCollisionFlags(2|n.getCollisionFlags()),n.setActivationState(4));n.entity=t,this.body=n,this.enabled&&t.enabled&&this.enableSimulation()}}isActive(){return!!this._body&&this._body.isActive()}activate(){this._body&&this._body.activate()}enableSimulation(){const t=this.entity;if(t.collision&&t.collision.enabled&&!this._simulationEnabled){const e=this._body;if(e){switch(this.system.addBody(e,this._group,this._mask),this._type){case p_:this.system._dynamic.push(this),e.forceActivationState(1),this.syncEntityToBody();break;case m_:this.system._kinematic.push(this),e.forceActivationState(4);break;case f_:e.forceActivationState(1),this.syncEntityToBody()}"compound"===t.collision.type&&this.system._compounds.push(t.collision),e.activate(),this._simulationEnabled=!0}}}disableSimulation(){const t=this._body;if(t&&this._simulationEnabled){const e=this.system;let s=e._compounds.indexOf(this.entity.collision);s>-1&&e._compounds.splice(s,1),s=e._dynamic.indexOf(this),s>-1&&e._dynamic.splice(s,1),s=e._kinematic.indexOf(this),s>-1&&e._kinematic.splice(s,1),e.removeBody(t),t.forceActivationState(5),this._simulationEnabled=!1}}applyForce(t,e,s,n,i,r){const a=this._body;a&&(a.activate(),t instanceof rs?P_.setValue(t.x,t.y,t.z):P_.setValue(t,e,s),e instanceof rs?L_.setValue(e.x,e.y,e.z):void 0!==n?L_.setValue(n,i,r):L_.setValue(0,0,0),a.applyForce(P_,L_))}applyTorque(t,e,s){const n=this._body;n&&(n.activate(),t instanceof rs?P_.setValue(t.x,t.y,t.z):P_.setValue(t,e,s),n.applyTorque(P_))}applyImpulse(t,e,s,n,i,r){const a=this._body;a&&(a.activate(),t instanceof rs?P_.setValue(t.x,t.y,t.z):P_.setValue(t,e,s),e instanceof rs?L_.setValue(e.x,e.y,e.z):void 0!==n?L_.setValue(n,i,r):L_.setValue(0,0,0),a.applyImpulse(P_,L_))}applyTorqueImpulse(t,e,s){const n=this._body;n&&(n.activate(),t instanceof rs?P_.setValue(t.x,t.y,t.z):P_.setValue(t,e,s),n.applyTorqueImpulse(P_))}isStatic(){return this._type===f_}isStaticOrKinematic(){return this._type===f_||this._type===m_}isKinematic(){return this._type===m_}_getEntityTransform(t){const e=this.entity,s=e.collision;if(s){const t=s.getShapePosition(),e=s.getShapeRotation();P_.setValue(t.x,t.y,t.z),I_.setValue(e.x,e.y,e.z,e.w)}else{const t=e.getPosition(),s=e.getRotation();P_.setValue(t.x,t.y,t.z),I_.setValue(s.x,s.y,s.z,s.w)}t.setOrigin(P_),t.setRotation(I_)}syncEntityToBody(){const t=this._body;if(t){if(this._getEntityTransform(D_),t.setWorldTransform(D_),this._type===m_){const e=t.getMotionState();e&&e.setWorldTransform(D_)}t.activate()}}_updateDynamic(){const t=this._body;if(t.isActive()){const e=t.getMotionState();if(e){const t=this.entity;e.getWorldTransform(D_);const s=D_.getOrigin(),n=D_.getRotation(),i=t.collision;if(i&&i._hasOffset){const e=i.data.linearOffset,r=i.data.angularOffset,a=M_.copy(r).invert(),o=R_.set(n.x(),n.y(),n.z(),n.w()).mul(a);o.transformVector(e,k_),t.setPosition(s.x()-k_.x,s.y()-k_.y,s.z()-k_.z),t.setRotation(o)}else t.setPosition(s.x(),s.y(),s.z()),t.setRotation(n.x(),n.y(),n.z(),n.w())}}}_updateKinematic(){const t=this._body.getMotionState();t&&(this._getEntityTransform(D_),t.setWorldTransform(D_))}teleport(t,e,s,n,i,r){t instanceof rs?this.entity.setPosition(t):this.entity.setPosition(t,e,s),e instanceof ms?this.entity.setRotation(e):e instanceof rs?this.entity.setEulerAngles(e):void 0!==n&&this.entity.setEulerAngles(n,i,r),this.syncEntityToBody()}onEnable(){this._body||this.createBody(),this.enableSimulation()}onDisable(){this.disableSimulation()}constructor(...t){super(...t),this._angularDamping=0,this._angularFactor=new rs(1,1,1),this._angularVelocity=new rs,this._body=null,this._friction=.5,this._group=2,this._linearDamping=0,this._linearFactor=new rs(1,1,1),this._linearVelocity=new rs,this._mask=65533,this._mass=1,this._restitution=0,this._rollingFriction=0,this._simulationEnabled=!1,this._type=f_}}class F_{constructor(){this.enabled=!0}}let N_,B_;class z_{constructor(t,e,s,n){this.entity=t,this.point=e,this.normal=s,this.hitFraction=n}}class U_{constructor(t,e,s){0!==arguments.length?(this.a=t,this.b=e,this.impulse=s.impulse,this.localPointA=s.localPoint,this.localPointB=s.localPointOther,this.pointA=s.point,this.pointB=s.pointOther,this.normal=s.normal):(this.a=null,this.b=null,this.impulse=0,this.localPointA=new rs,this.localPointB=new rs,this.pointA=new rs,this.pointB=new rs,this.normal=new rs)}}class V_{constructor(t=new rs,e=new rs,s=new rs,n=new rs,i=new rs,r=0){this.localPoint=t,this.localPointOther=e,this.point=s,this.pointOther=n,this.normal=i,this.impulse=r}}class H_{constructor(t,e){this.other=t,this.contacts=e}}const G_=["enabled"];class W_ extends wg{static{this.EVENT_CONTACT="contact"}constructor(t){super(t),this.maxSubSteps=10,this.fixedTimeStep=1/60,this.gravity=new rs(0,-9.81,0),this._gravityFloat32=new Float32Array(3),this._dynamic=[],this._kinematic=[],this._triggers=[],this._compounds=[],this.id="rigidbody",this._stats=t.stats.frame,this.ComponentType=O_,this.DataType=F_,this.contactPointPool=null,this.contactResultPool=null,this.singleContactResultPool=null,this.schema=G_,this.collisions={},this.frameCollisions={},this.on("beforeremove",this.onBeforeRemove,this)}onLibraryLoaded(){if("undefined"!=typeof Ammo){if(this.collisionConfiguration=new Ammo.btDefaultCollisionConfiguration,this.dispatcher=new Ammo.btCollisionDispatcher(this.collisionConfiguration),this.overlappingPairCache=new Ammo.btDbvtBroadphase,this.solver=new Ammo.btSequentialImpulseConstraintSolver,this.dynamicsWorld=new Ammo.btDiscreteDynamicsWorld(this.dispatcher,this.overlappingPairCache,this.solver,this.collisionConfiguration),this.dynamicsWorld.setInternalTickCallback){const t=Ammo.addFunction(this._checkForCollisions.bind(this),"vif");this.dynamicsWorld.setInternalTickCallback(t)}N_=new Ammo.btVector3,B_=new Ammo.btVector3,O_.onLibraryLoaded(),this.contactPointPool=new A_(V_,1),this.contactResultPool=new A_(H_,1),this.singleContactResultPool=new A_(U_,1),this.app.systems.on("update",this.onUpdate,this)}else this.app.systems.off("update",this.onUpdate,this)}initializeComponentData(t,e,s){const n=["mass","linearDamping","angularDamping","linearFactor","angularFactor","friction","rollingFriction","restitution","type","group","mask"];for(const s of n)if(e.hasOwnProperty(s)){const n=e[s];Array.isArray(n)?t[s]=new rs(n[0],n[1],n[2]):t[s]=n}super.initializeComponentData(t,e,["enabled"])}cloneComponent(t,e){const s=t.rigidbody,n={enabled:s.enabled,mass:s.mass,linearDamping:s.linearDamping,angularDamping:s.angularDamping,linearFactor:[s.linearFactor.x,s.linearFactor.y,s.linearFactor.z],angularFactor:[s.angularFactor.x,s.angularFactor.y,s.angularFactor.z],friction:s.friction,rollingFriction:s.rollingFriction,restitution:s.restitution,type:s.type,group:s.group,mask:s.mask};return this.addComponent(e,n)}onBeforeRemove(t,e){e.enabled&&(e.enabled=!1),e.body&&(this.destroyBody(e.body),e.body=null)}addBody(t,e,s){void 0!==e&&void 0!==s?this.dynamicsWorld.addRigidBody(t,e,s):this.dynamicsWorld.addRigidBody(t)}removeBody(t){this.dynamicsWorld.removeRigidBody(t)}createBody(t,e,s){const n=new Ammo.btVector3(0,0,0);0!==t&&e.calculateLocalInertia(t,n);const i=new Ammo.btDefaultMotionState(s),r=new Ammo.btRigidBodyConstructionInfo(t,i,e,n),a=new Ammo.btRigidBody(r);return Ammo.destroy(r),Ammo.destroy(n),a}destroyBody(t){const e=t.getMotionState();e&&Ammo.destroy(e),Ammo.destroy(t)}raycastFirst(t,e,s={}){if(s.filterTags||s.filterCallback)return s.sort=!0,this.raycastAll(t,e,s)[0]||null;let n=null;N_.setValue(t.x,t.y,t.z),B_.setValue(e.x,e.y,e.z);const i=new Ammo.ClosestRayResultCallback(N_,B_);if("number"==typeof s.filterCollisionGroup&&i.set_m_collisionFilterGroup(s.filterCollisionGroup),"number"==typeof s.filterCollisionMask&&i.set_m_collisionFilterMask(s.filterCollisionMask),this.dynamicsWorld.rayTest(N_,B_,i),i.hasHit()){const t=i.get_m_collisionObject(),e=Ammo.castObject(t,Ammo.btRigidBody);if(e){const t=i.get_m_hitPointWorld(),s=i.get_m_hitNormalWorld();n=new z_(e.entity,new rs(t.x(),t.y(),t.z()),new rs(s.x(),s.y(),s.z()),i.get_m_closestHitFraction())}}return Ammo.destroy(i),n}raycastAll(t,e,s={}){const n=[];N_.setValue(t.x,t.y,t.z),B_.setValue(e.x,e.y,e.z);const i=new Ammo.AllHitsRayResultCallback(N_,B_);if("number"==typeof s.filterCollisionGroup&&i.set_m_collisionFilterGroup(s.filterCollisionGroup),"number"==typeof s.filterCollisionMask&&i.set_m_collisionFilterMask(s.filterCollisionMask),this.dynamicsWorld.rayTest(N_,B_,i),i.hasHit()){const t=i.get_m_collisionObjects(),e=i.get_m_hitPointWorld(),r=i.get_m_hitNormalWorld(),a=i.get_m_hitFractions(),o=t.size();for(let i=0;i<o;i++){const o=Ammo.castObject(t.at(i),Ammo.btRigidBody);if(o&&o.entity){if(s.filterTags&&!o.entity.tags.has(...s.filterTags)||s.filterCallback&&!s.filterCallback(o.entity))continue;const t=e.at(i),l=r.at(i),h=new z_(o.entity,new rs(t.x(),t.y(),t.z()),new rs(l.x(),l.y(),l.z()),a.at(i));n.push(h)}}s.sort&&n.sort((t,e)=>t.hitFraction-e.hitFraction)}return Ammo.destroy(i),n}_storeCollision(t,e){let s=!1;const n=t.getGuid();return this.collisions[n]=this.collisions[n]||{others:[],entity:t},this.collisions[n].others.indexOf(e)<0&&(this.collisions[n].others.push(e),s=!0),this.frameCollisions[n]=this.frameCollisions[n]||{others:[],entity:t},this.frameCollisions[n].others.push(e),s}_createContactPointFromAmmo(t){const e=t.get_m_localPointA(),s=t.get_m_localPointB(),n=t.getPositionWorldOnA(),i=t.getPositionWorldOnB(),r=t.get_m_normalWorldOnB(),a=this.contactPointPool.allocate();return a.localPoint.set(e.x(),e.y(),e.z()),a.localPointOther.set(s.x(),s.y(),s.z()),a.point.set(n.x(),n.y(),n.z()),a.pointOther.set(i.x(),i.y(),i.z()),a.normal.set(r.x(),r.y(),r.z()),a.impulse=t.getAppliedImpulse(),a}_createReverseContactPointFromAmmo(t){const e=t.get_m_localPointA(),s=t.get_m_localPointB(),n=t.getPositionWorldOnA(),i=t.getPositionWorldOnB(),r=t.get_m_normalWorldOnB(),a=this.contactPointPool.allocate();return a.localPointOther.set(e.x(),e.y(),e.z()),a.localPoint.set(s.x(),s.y(),s.z()),a.pointOther.set(n.x(),n.y(),n.z()),a.point.set(i.x(),i.y(),i.z()),a.normal.set(r.x(),r.y(),r.z()),a.impulse=t.getAppliedImpulse(),a}_createSingleContactResult(t,e,s){const n=this.singleContactResultPool.allocate();return n.a=t,n.b=e,n.localPointA=s.localPoint,n.localPointB=s.localPointOther,n.pointA=s.point,n.pointB=s.pointOther,n.normal=s.normal,n.impulse=s.impulse,n}_createContactResult(t,e){const s=this.contactResultPool.allocate();return s.other=t,s.contacts=e,s}_cleanOldCollisions(){for(const t in this.collisions)if(this.collisions.hasOwnProperty(t)){const e=this.frameCollisions[t],s=this.collisions[t],n=s.entity,i=n.collision,r=n.rigidbody,a=s.others;let o=a.length;for(;o--;){const t=a[o];(!e||e.others.indexOf(t)<0)&&(a.splice(o,1),n.trigger?(i&&i.fire("triggerleave",t),t.rigidbody&&t.rigidbody.fire("triggerleave",n)):t.trigger||(r&&r.fire("collisionend",t),i&&i.fire("collisionend",t)))}0===a.length&&delete this.collisions[t]}}_hasContactEvent(t){const e=t.collision;if(e&&(e.hasEvent("collisionstart")||e.hasEvent("collisionend")||e.hasEvent("contact")))return!0;const s=t.rigidbody;return s&&(s.hasEvent("collisionstart")||s.hasEvent("collisionend")||s.hasEvent("contact"))}_checkForCollisions(t,e){const s=Ammo.wrapPointer(t,Ammo.btDynamicsWorld).getDispatcher(),n=s.getNumManifolds();this.frameCollisions={};for(let t=0;t<n;t++){const e=s.getManifoldByIndexInternal(t),n=e.getBody0(),i=e.getBody1(),r=Ammo.castObject(n,Ammo.btRigidBody),a=Ammo.castObject(i,Ammo.btRigidBody),o=r.entity,l=a.entity;if(!o||!l)continue;const h=r.getCollisionFlags(),c=a.getCollisionFlags(),d=e.getNumContacts(),u=[],f=[];let p;if(d>0)if(4&h||4&c){const t=o.collision&&(o.collision.hasEvent("triggerenter")||o.collision.hasEvent("triggerleave")),e=l.collision&&(l.collision.hasEvent("triggerenter")||l.collision.hasEvent("triggerleave")),s=o.rigidbody&&(o.rigidbody.hasEvent("triggerenter")||o.rigidbody.hasEvent("triggerleave")),n=l.rigidbody&&(l.rigidbody.hasEvent("triggerenter")||l.rigidbody.hasEvent("triggerleave"));t&&(p=this._storeCollision(o,l),!p||4&c||o.collision.fire("triggerenter",l)),e&&(p=this._storeCollision(l,o),!p||4&h||l.collision.fire("triggerenter",o)),s&&(p||(p=this._storeCollision(l,o)),p&&o.rigidbody.fire("triggerenter",l)),n&&(p||(p=this._storeCollision(o,l)),p&&l.rigidbody.fire("triggerenter",o))}else{const t=this._hasContactEvent(o),s=this._hasContactEvent(l),n=this.hasEvent("contact");if(n||t||s){for(let i=0;i<d;i++){const r=e.getContactPoint(i),a=this._createContactPointFromAmmo(r);if(t||s){u.push(a);const t=this._createReverseContactPointFromAmmo(r);f.push(t)}if(n){const t=this._createSingleContactResult(o,l,a);this.fire("contact",t)}}if(t){const t=this._createContactResult(l,u);p=this._storeCollision(o,l),o.collision&&(o.collision.fire("contact",t),p&&o.collision.fire("collisionstart",t)),o.rigidbody&&(o.rigidbody.fire("contact",t),p&&o.rigidbody.fire("collisionstart",t))}if(s){const t=this._createContactResult(o,f);p=this._storeCollision(l,o),l.collision&&(l.collision.fire("contact",t),p&&l.collision.fire("collisionstart",t)),l.rigidbody&&(l.rigidbody.fire("contact",t),p&&l.rigidbody.fire("collisionstart",t))}}}}this._cleanOldCollisions(),this.contactPointPool.freeAll(),this.contactResultPool.freeAll(),this.singleContactResultPool.freeAll()}onUpdate(t){let e,s;this._gravityFloat32[0]=this.gravity.x,this._gravityFloat32[1]=this.gravity.y,this._gravityFloat32[2]=this.gravity.z;const n=this.dynamicsWorld.getGravity();n.x()===this._gravityFloat32[0]&&n.y()===this._gravityFloat32[1]&&n.z()===this._gravityFloat32[2]||(n.setValue(this.gravity.x,this.gravity.y,this.gravity.z),this.dynamicsWorld.setGravity(n));const i=this._triggers;for(e=0,s=i.length;e<s;e++)i[e].updateTransform();const r=this._compounds;for(e=0,s=r.length;e<s;e++)r[e]._updateCompound();const a=this._kinematic;for(e=0,s=a.length;e<s;e++)a[e]._updateKinematic();this.dynamicsWorld.stepSimulation(t,this.maxSubSteps,this.fixedTimeStep);const o=this._dynamic;for(e=0,s=o.length;e<s;e++)o[e]._updateDynamic();this.dynamicsWorld.setInternalTickCallback||this._checkForCollisions(Ammo.getPointer(this.dynamicsWorld),t)}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this),"undefined"!=typeof Ammo&&(Ammo.destroy(this.dynamicsWorld),Ammo.destroy(this.solver),Ammo.destroy(this.overlappingPairCache),Ammo.destroy(this.dispatcher),Ammo.destroy(this.collisionConfiguration),Ammo.destroy(N_),Ammo.destroy(B_),this.dynamicsWorld=null,this.solver=null,this.overlappingPairCache=null,this.dispatcher=null,this.collisionConfiguration=null,N_=null,B_=null,O_.onAppDestroy())}}xg._buildAccessors(O_.prototype,G_);class j_{constructor(t,e){this.effect=t,this.inputTarget=e,this.outputTarget=null,this.name=t.constructor.name}}class $_{constructor(t,e){this.app=t,this.camera=e,this.destinationRenderTarget=null,this.effects=[],this.enabled=!1,this.depthTarget=null,e.on("set:rect",this.onCameraRectChanged,this)}_allocateColorBuffer(t,e){const s=this.camera.rect,n=this.destinationRenderTarget,i=this.app.graphicsDevice,r=Math.floor(s.z*(n?.width??i.width)),a=Math.floor(s.w*(n?.height??i.height));return new pi(i,{name:e,format:t,width:r,height:a,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1})}_createOffscreenTarget(t,e){const s=this.app.graphicsDevice,n=(this.destinationRenderTarget??s.backBuffer).isColorBufferSrgb(0),i=(e&&s.getRenderableHdrFormat([Ls,Is],!0))??(n?Fs:7),r=`${this.camera.entity.name}-posteffect-${this.effects.length}`,a=this._allocateColorBuffer(i,r);return new ji({colorBuffer:a,depth:t,stencil:t&&this.app.graphicsDevice.supportsStencil,samples:t?s.samples:1})}_resizeOffscreenTarget(t){const e=t.colorBuffer.format,s=t.colorBuffer.name;t.destroyFrameBuffers(),t.destroyTextureBuffers(),t._colorBuffer=this._allocateColorBuffer(e,s),t._colorBuffers=[t._colorBuffer],t.evaluateDimensions()}_destroyOffscreenTarget(t){t.destroyTextureBuffers(),t.destroy()}addEffect(t){const e=this.effects,s=0===e.length,n=this._createOffscreenTarget(s,t.hdr),i=new j_(t,n);e.push(i),this._sourceTarget=i.inputTarget,e.length>1&&(e[e.length-2].outputTarget=i.inputTarget),this._newPostEffect=t,t.needsDepthBuffer&&this._requestDepthMap(),this.enable(),this._newPostEffect=void 0}removeEffect(t){let e=-1;for(let s=0,n=this.effects.length;s<n;s++)if(this.effects[s].effect===t){e=s;break}e>=0&&(e>0?this.effects[e-1].outputTarget=e+1<this.effects.length?this.effects[e+1].inputTarget:null:this.effects.length>1&&(this.effects[1].inputTarget._depth||(this._destroyOffscreenTarget(this.effects[1].inputTarget),this.effects[1].inputTarget=this._createOffscreenTarget(!0,this.effects[1].hdr),this._sourceTarget=this.effects[1].inputTarget),this.camera.renderTarget=this.effects[1].inputTarget),this._destroyOffscreenTarget(this.effects[e].inputTarget),this.effects.splice(e,1)),this.enabled&&t.needsDepthBuffer&&this._releaseDepthMap(),0===this.effects.length&&this.disable()}_requestDepthMaps(){for(let t=0,e=this.effects.length;t<e;t++){const e=this.effects[t].effect;this._newPostEffect!==e&&(e.needsDepthBuffer&&this._requestDepthMap())}}_releaseDepthMaps(){for(let t=0,e=this.effects.length;t<e;t++){this.effects[t].effect.needsDepthBuffer&&this._releaseDepthMap()}}_requestDepthMap(){const t=this.app.scene.layers.getLayerById(1);t&&(t.incrementCounter(),this.camera.requestSceneDepthMap(!0))}_releaseDepthMap(){const t=this.app.scene.layers.getLayerById(1);t&&(t.decrementCounter(),this.camera.requestSceneDepthMap(!1))}destroy(){for(let t=0,e=this.effects.length;t<e;t++)this.effects[t].inputTarget.destroy();this.effects.length=0,this.disable()}enable(){!this.enabled&&this.effects.length&&(this.enabled=!0,this._requestDepthMaps(),this.app.graphicsDevice.on("resizecanvas",this._onCanvasResized,this),this.destinationRenderTarget=this.camera.renderTarget,this.camera.renderTarget=this.effects[0].inputTarget,this.camera.onPostprocessing=()=>{if(this.enabled){let t=null;const e=this.effects.length;if(e)for(let s=0;s<e;s++){const n=this.effects[s];let i=n.outputTarget;s===e-1&&(t=this.camera.rect,this.destinationRenderTarget&&(i=this.destinationRenderTarget)),n.effect.render(n.inputTarget,i,t)}}})}disable(){this.enabled&&(this.enabled=!1,this.app.graphicsDevice.off("resizecanvas",this._onCanvasResized,this),this._releaseDepthMaps(),this._destroyOffscreenTarget(this._sourceTarget),this.camera.renderTarget=this.destinationRenderTarget,this.camera.onPostprocessing=null)}_onCanvasResized(t,e){const s=this.camera.rect,n=this.destinationRenderTarget;t=n?.width??t,e=n?.height??e,this.camera.camera.aspectRatio=t*s.z/(e*s.w),this.resizeRenderTargets()}resizeRenderTargets(){const t=this.app.graphicsDevice,e=this.destinationRenderTarget,s=e?.width??t.width,n=e?.height??t.height,i=this.camera.rect,r=Math.floor(i.z*s),a=Math.floor(i.w*n),o=this.effects;for(let t=0,e=o.length;t<e;t++){const e=o[t];e.inputTarget.width===r&&e.inputTarget.height===a||this._resizeOffscreenTarget(e.inputTarget)}}onCameraRectChanged(t,e,s){this.enabled&&this.resizeRenderTargets()}}class X_ extends xg{constructor(t,e){super(t,e),this.onPostprocessing=null,this._renderSceneDepthMap=0,this._renderSceneColorMap=0,this._sceneDepthMapRequested=!1,this._sceneColorMapRequested=!1,this._priority=0,this._disablePostEffectsLayer=4,this._camera=new Tc,this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._camera.node=e,this._postEffects=new $_(t.app,this)}setShaderPass(t){const e=Mh.get(this.system.app.graphicsDevice),s=t?e.allocate(t,{isForward:!0}):null;return this._camera.shaderPassInfo=s,s.index}getShaderPass(){return this._camera.shaderPassInfo?.name}set renderPasses(t){this._camera.renderPasses=t||[],this.dirtyLayerCompositionCameras(),this.system.app.scene.updateShaders=!0}get renderPasses(){return this._camera.renderPasses}get shaderParams(){return this._camera.shaderParams}set gammaCorrection(t){this.camera.shaderParams.gammaCorrection=t}get gammaCorrection(){return this.camera.shaderParams.gammaCorrection}set toneMapping(t){this.camera.shaderParams.toneMapping=t}get toneMapping(){return this.camera.shaderParams.toneMapping}set fog(t){this._camera.fogParams=t}get fog(){return this._camera.fogParams}set aperture(t){this._camera.aperture=t}get aperture(){return this._camera.aperture}set aspectRatio(t){this._camera.aspectRatio=t}get aspectRatio(){return this._camera.aspectRatio}set aspectRatioMode(t){this._camera.aspectRatioMode=t}get aspectRatioMode(){return this._camera.aspectRatioMode}set calculateProjection(t){this._camera.calculateProjection=t}get calculateProjection(){return this._camera.calculateProjection}set calculateTransform(t){this._camera.calculateTransform=t}get calculateTransform(){return this._camera.calculateTransform}get camera(){return this._camera}set clearColor(t){this._camera.clearColor=t}get clearColor(){return this._camera.clearColor}set clearColorBuffer(t){this._camera.clearColorBuffer=t,this.dirtyLayerCompositionCameras()}get clearColorBuffer(){return this._camera.clearColorBuffer}set clearDepth(t){this._camera.clearDepth=t}get clearDepth(){return this._camera.clearDepth}set clearDepthBuffer(t){this._camera.clearDepthBuffer=t,this.dirtyLayerCompositionCameras()}get clearDepthBuffer(){return this._camera.clearDepthBuffer}set clearStencilBuffer(t){this._camera.clearStencilBuffer=t,this.dirtyLayerCompositionCameras()}get clearStencilBuffer(){return this._camera.clearStencilBuffer}set cullFaces(t){this._camera.cullFaces=t}get cullFaces(){return this._camera.cullFaces}set disablePostEffectsLayer(t){this._disablePostEffectsLayer=t,this.dirtyLayerCompositionCameras()}get disablePostEffectsLayer(){return this._disablePostEffectsLayer}set farClip(t){this._camera.farClip=t}get farClip(){return this._camera.farClip}set flipFaces(t){this._camera.flipFaces=t}get flipFaces(){return this._camera.flipFaces}set fov(t){this._camera.fov=t}get fov(){return this._camera.fov}get frustum(){return this._camera.frustum}set frustumCulling(t){this._camera.frustumCulling=t}get frustumCulling(){return this._camera.frustumCulling}set horizontalFov(t){this._camera.horizontalFov=t}get horizontalFov(){return this._camera.horizontalFov}set layers(t){const e=this._camera.layers,s=this.system.app.scene;e.forEach(t=>{const e=s.layers.getLayerById(t);e?.removeCamera(this)}),this._camera.layers=t,this.enabled&&this.entity.enabled&&t.forEach(t=>{const e=s.layers.getLayerById(t);e?.addCamera(this)}),this.fire("set:layers")}get layers(){return this._camera.layers}get layersSet(){return this._camera.layersSet}set jitter(t){this._camera.jitter=t}get jitter(){return this._camera.jitter}set nearClip(t){this._camera.nearClip=t}get nearClip(){return this._camera.nearClip}set orthoHeight(t){this._camera.orthoHeight=t}get orthoHeight(){return this._camera.orthoHeight}get postEffects(){return this._postEffects}get postEffectsEnabled(){return this._postEffects.enabled}set priority(t){this._priority=t,this.dirtyLayerCompositionCameras()}get priority(){return this._priority}set projection(t){this._camera.projection=t}get projection(){return this._camera.projection}get projectionMatrix(){return this._camera.projectionMatrix}set rect(t){this._camera.rect=t,this.fire("set:rect",this._camera.rect)}get rect(){return this._camera.rect}set renderSceneColorMap(t){t&&!this._sceneColorMapRequested?(this.requestSceneColorMap(!0),this._sceneColorMapRequested=!0):this._sceneColorMapRequested&&(this.requestSceneColorMap(!1),this._sceneColorMapRequested=!1)}get renderSceneColorMap(){return this._renderSceneColorMap>0}set renderSceneDepthMap(t){t&&!this._sceneDepthMapRequested?(this.requestSceneDepthMap(!0),this._sceneDepthMapRequested=!0):this._sceneDepthMapRequested&&(this.requestSceneDepthMap(!1),this._sceneDepthMapRequested=!1)}get renderSceneDepthMap(){return this._renderSceneDepthMap>0}set renderTarget(t){this._camera.renderTarget=t,this.dirtyLayerCompositionCameras()}get renderTarget(){return this._camera.renderTarget}set scissorRect(t){this._camera.scissorRect=t}get scissorRect(){return this._camera.scissorRect}set sensitivity(t){this._camera.sensitivity=t}get sensitivity(){return this._camera.sensitivity}set shutter(t){this._camera.shutter=t}get shutter(){return this._camera.shutter}get viewMatrix(){return this._camera.viewMatrix}_enableDepthLayer(t){if(this.layers.find(t=>1===t)){const e=this.system.app.scene.layers.getLayerById(1);t?e?.incrementCounter():e?.decrementCounter()}else if(t)return!1;return!0}requestSceneColorMap(t){this._renderSceneColorMap+=t?1:-1,this._enableDepthLayer(t),this.camera._enableRenderPassColorGrab(this.system.app.graphicsDevice,this.renderSceneColorMap),this.system.app.scene.layers.markDirty()}requestSceneDepthMap(t){this._renderSceneDepthMap+=t?1:-1,this._enableDepthLayer(t),this.camera._enableRenderPassDepthGrab(this.system.app.graphicsDevice,this.system.app.renderer,this.renderSceneDepthMap),this.system.app.scene.layers.markDirty()}dirtyLayerCompositionCameras(){this.system.app.scene.layers._dirty=!0}screenToWorld(t,e,s,n){const i=this.system.app.graphicsDevice,{width:r,height:a}=i.clientRect;return this._camera.screenToWorld(t,e,s,r,a,n)}worldToScreen(t,e){const s=this.system.app.graphicsDevice,{width:n,height:i}=s.clientRect;return this._camera.worldToScreen(t,n,i,e)}onAppPrerender(){this._camera._viewMatDirty=!0,this._camera._viewProjMatDirty=!0}addCameraToLayers(){const t=this.layers;for(let e=0;e<t.length;e++){const s=this.system.app.scene.layers.getLayerById(t[e]);s&&s.addCamera(this)}}removeCameraFromLayers(){const t=this.layers;for(let e=0;e<t.length;e++){const s=this.system.app.scene.layers.getLayerById(t[e]);s&&s.removeCamera(this)}}onLayersChanged(t,e){this.addCameraToLayers(),t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this)}onLayerAdded(t){this.layers.indexOf(t.id)<0||t.addCamera(this)}onLayerRemoved(t){this.layers.indexOf(t.id)<0||t.removeCamera(this)}onEnable(){const t=this.system.app.scene,e=t.layers;this.system.addCamera(this),this._evtLayersChanged?.off(),this._evtLayersChanged=t.on("set:layers",this.onLayersChanged,this),e&&(this._evtLayerAdded?.off(),this._evtLayerAdded=e.on("add",this.onLayerAdded,this),this._evtLayerRemoved?.off(),this._evtLayerRemoved=e.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&this.addCameraToLayers(),this.postEffects.enable()}onDisable(){const t=this.system.app.scene.layers;this.postEffects.disable(),this.removeCameraFromLayers(),this._evtLayersChanged?.off(),this._evtLayersChanged=null,t&&(this._evtLayerAdded?.off(),this._evtLayerAdded=null,this._evtLayerRemoved?.off(),this._evtLayerRemoved=null),this.system.removeCamera(this)}onRemove(){this.onDisable(),this.off(),this.camera.destroy()}calculateAspectRatio(t){const e=this.system.app.graphicsDevice,s=t?t.width:e.width,n=t?t.height:e.height;return s*this.rect.z/(n*this.rect.w)}frameUpdate(t){0===this.aspectRatioMode&&(this.aspectRatio=this.calculateAspectRatio(t))}startXr(t,e,s){this.system.app.xr.start(this,t,e,s)}endXr(t){this._camera.xr?this._camera.xr.end(t):t&&t(new Error("Camera is not in XR"))}copy(t){this.aperture=t.aperture,this.aspectRatio=t.aspectRatio,this.aspectRatioMode=t.aspectRatioMode,this.calculateProjection=t.calculateProjection,this.calculateTransform=t.calculateTransform,this.clearColor=t.clearColor,this.clearColorBuffer=t.clearColorBuffer,this.clearDepthBuffer=t.clearDepthBuffer,this.clearStencilBuffer=t.clearStencilBuffer,this.cullFaces=t.cullFaces,this.disablePostEffectsLayer=t.disablePostEffectsLayer,this.farClip=t.farClip,this.flipFaces=t.flipFaces,this.fov=t.fov,this.frustumCulling=t.frustumCulling,this.horizontalFov=t.horizontalFov,this.layers=t.layers,this.nearClip=t.nearClip,this.orthoHeight=t.orthoHeight,this.priority=t.priority,this.projection=t.projection,this.rect=t.rect,this.renderTarget=t.renderTarget,this.scissorRect=t.scissorRect,this.sensitivity=t.sensitivity,this.shutter=t.shutter}}class q_{constructor(){this.enabled=!0}}const K_=["enabled"];class Y_ extends wg{constructor(t){super(t),this.cameras=[],this.id="camera",this.ComponentType=X_,this.DataType=q_,this.schema=K_,this.on("beforeremove",this.onBeforeRemove,this),this.app.on("prerender",this.onAppPrerender,this)}initializeComponentData(t,e,s){s=["aspectRatio","aspectRatioMode","calculateProjection","calculateTransform","clearColor","clearColorBuffer","clearDepth","clearDepthBuffer","clearStencilBuffer","renderSceneColorMap","renderSceneDepthMap","cullFaces","farClip","flipFaces","fog","fov","frustumCulling","horizontalFov","layers","renderTarget","nearClip","orthoHeight","projection","priority","rect","scissorRect","aperture","shutter","sensitivity","gammaCorrection","toneMapping"];for(let n=0;n<s.length;n++){const i=s[n];if(e.hasOwnProperty(i)){const s=e[i];switch(i){case"rect":case"scissorRect":Array.isArray(s)?t[i]=new ls(s[0],s[1],s[2],s[3]):t[i]=s;break;case"clearColor":Array.isArray(s)?t[i]=new Ze(s[0],s[1],s[2],s[3]):t[i]=s;break;default:t[i]=s}}}super.initializeComponentData(t,e,["enabled"])}cloneComponent(t,e){const s=t.camera;return this.addComponent(e,{aspectRatio:s.aspectRatio,aspectRatioMode:s.aspectRatioMode,calculateProjection:s.calculateProjection,calculateTransform:s.calculateTransform,clearColor:s.clearColor,clearColorBuffer:s.clearColorBuffer,clearDepthBuffer:s.clearDepthBuffer,clearStencilBuffer:s.clearStencilBuffer,renderSceneDepthMap:s.renderSceneDepthMap,renderSceneColorMap:s.renderSceneColorMap,cullFaces:s.cullFaces,enabled:s.enabled,farClip:s.farClip,flipFaces:s.flipFaces,fov:s.fov,frustumCulling:s.frustumCulling,horizontalFov:s.horizontalFov,layers:s.layers,renderTarget:s.renderTarget,nearClip:s.nearClip,orthoHeight:s.orthoHeight,projection:s.projection,priority:s.priority,rect:s.rect,scissorRect:s.scissorRect,aperture:s.aperture,sensitivity:s.sensitivity,shutter:s.shutter,gammaCorrection:s.gammaCorrection,toneMapping:s.toneMapping})}onBeforeRemove(t,e){this.removeCamera(e),e.onRemove()}onAppPrerender(){for(let t=0,e=this.cameras.length;t<e;t++)this.cameras[t].onAppPrerender()}addCamera(t){this.cameras.push(t),ku(this.cameras)}removeCamera(t){const e=this.cameras.indexOf(t);e>=0&&(this.cameras.splice(e,1),ku(this.cameras))}destroy(){this.app.off("prerender",this.onAppPrerender,this),super.destroy()}}xg._buildAccessors(X_.prototype,K_);class Q_{constructor(){this.enabled=!0,this.type="directional",this.color=new Ze(1,1,1),this.intensity=1,this.luminance=0,this.shape=0,this.affectSpecularity=!0,this.castShadows=!1,this.shadowDistance=40,this.shadowIntensity=1,this.shadowResolution=1024,this.shadowBias=.05,this.numCascades=1,this.cascadeBlend=0,this.bakeNumSamples=1,this.bakeArea=0,this.cascadeDistribution=.5,this.normalOffsetBias=0,this.range=10,this.innerConeAngle=40,this.outerConeAngle=45,this.falloffMode=0,this.shadowType=0,this.vsmBlurSize=11,this.vsmBlurMode=1,this.vsmBias=.0025,this.cookieAsset=null,this.cookie=null,this.cookieIntensity=1,this.cookieFalloff=!0,this.cookieChannel="rgb",this.cookieAngle=0,this.cookieScale=null,this.cookieOffset=null,this.shadowUpdateMode=2,this.mask=1,this.affectDynamic=!0,this.affectLightmapped=!1,this.bake=!1,this.bakeDir=!0,this.isStatic=!1,this.layers=[0],this.penumbraSize=1,this.penumbraFalloff=1,this.shadowSamples=16,this.shadowBlockerSamples=16}}const Z_=Object.keys(new Q_);class J_ extends xg{get data(){const t=this.system.store[this.entity.getGuid()];return t?t.data:null}set enabled(t){this._setValue("enabled",t,function(t,e){this.onSetEnabled(null,e,t)})}get enabled(){return this.data.enabled}set light(t){this._setValue("light",t)}get light(){return this.data.light}set type(t){this._setValue("type",t,function(t,e){this.system.changeType(this,e,t),this.refreshProperties()})}get type(){return this.data.type}set color(t){this._setValue("color",t,function(t,e){this.light.setColor(t)},!0)}get color(){return this.data.color}set intensity(t){this._setValue("intensity",t,function(t,e){this.light.intensity=t})}get intensity(){return this.data.intensity}set luminance(t){this._setValue("luminance",t,function(t,e){this.light.luminance=t})}get luminance(){return this.data.luminance}set shape(t){this._setValue("shape",t,function(t,e){this.light.shape=t})}get shape(){return this.data.shape}set affectSpecularity(t){this._setValue("affectSpecularity",t,function(t,e){this.light.affectSpecularity=t})}get affectSpecularity(){return this.data.affectSpecularity}set castShadows(t){this._setValue("castShadows",t,function(t,e){this.light.castShadows=t})}get castShadows(){return this.data.castShadows}set shadowDistance(t){this._setValue("shadowDistance",t,function(t,e){this.light.shadowDistance=t})}get shadowDistance(){return this.data.shadowDistance}set shadowIntensity(t){this._setValue("shadowIntensity",t,function(t,e){this.light.shadowIntensity=t})}get shadowIntensity(){return this.data.shadowIntensity}set shadowResolution(t){this._setValue("shadowResolution",t,function(t,e){this.light.shadowResolution=t})}get shadowResolution(){return this.data.shadowResolution}set shadowBias(t){this._setValue("shadowBias",t,function(t,e){this.light.shadowBias=-.01*Qe.clamp(t,0,1)})}get shadowBias(){return this.data.shadowBias}set numCascades(t){this._setValue("numCascades",t,function(t,e){this.light.numCascades=Qe.clamp(Math.floor(t),1,4)})}get numCascades(){return this.data.numCascades}set cascadeBlend(t){this._setValue("cascadeBlend",t,function(t,e){this.light.cascadeBlend=Qe.clamp(t,0,1)})}get cascadeBlend(){return this.data.cascadeBlend}set bakeNumSamples(t){this._setValue("bakeNumSamples",t,function(t,e){this.light.bakeNumSamples=Qe.clamp(Math.floor(t),1,255)})}get bakeNumSamples(){return this.data.bakeNumSamples}set bakeArea(t){this._setValue("bakeArea",t,function(t,e){this.light.bakeArea=Qe.clamp(t,0,180)})}get bakeArea(){return this.data.bakeArea}set cascadeDistribution(t){this._setValue("cascadeDistribution",t,function(t,e){this.light.cascadeDistribution=Qe.clamp(t,0,1)})}get cascadeDistribution(){return this.data.cascadeDistribution}set normalOffsetBias(t){this._setValue("normalOffsetBias",t,function(t,e){this.light.normalOffsetBias=Qe.clamp(t,0,1)})}get normalOffsetBias(){return this.data.normalOffsetBias}set range(t){this._setValue("range",t,function(t,e){this.light.attenuationEnd=t})}get range(){return this.data.range}set innerConeAngle(t){this._setValue("innerConeAngle",t,function(t,e){this.light.innerConeAngle=t})}get innerConeAngle(){return this.data.innerConeAngle}set outerConeAngle(t){this._setValue("outerConeAngle",t,function(t,e){this.light.outerConeAngle=t})}get outerConeAngle(){return this.data.outerConeAngle}set falloffMode(t){this._setValue("falloffMode",t,function(t,e){this.light.falloffMode=t})}get falloffMode(){return this.data.falloffMode}set shadowType(t){this._setValue("shadowType",t,function(t,e){this.light.shadowType=t})}get shadowType(){return this.data.shadowType}set vsmBlurSize(t){this._setValue("vsmBlurSize",t,function(t,e){this.light.vsmBlurSize=t})}get vsmBlurSize(){return this.data.vsmBlurSize}set vsmBlurMode(t){this._setValue("vsmBlurMode",t,function(t,e){this.light.vsmBlurMode=t})}get vsmBlurMode(){return this.data.vsmBlurMode}set vsmBias(t){this._setValue("vsmBias",t,function(t,e){this.light.vsmBias=Qe.clamp(t,0,1)})}get vsmBias(){return this.data.vsmBias}set cookieAsset(t){this._setValue("cookieAsset",t,function(t,e){if(!this._cookieAssetId||!(t instanceof Fm&&t.id===this._cookieAssetId||t===this._cookieAssetId))if(this.onCookieAssetRemove(),this._cookieAssetId=null,t instanceof Fm)this.data.cookieAsset=t.id,this._cookieAssetId=t.id,this.onCookieAssetAdd(t);else if("number"==typeof t){this._cookieAssetId=t;const e=this.system.app.assets.get(t);e?this.onCookieAssetAdd(e):(this._cookieAssetAdd=!0,this.system.app.assets.on(`add:${this._cookieAssetId}`,this.onCookieAssetAdd,this))}})}get cookieAsset(){return this.data.cookieAsset}set cookie(t){this._setValue("cookie",t,function(t,e){this.light.cookie=t})}get cookie(){return this.data.cookie}set cookieIntensity(t){this._setValue("cookieIntensity",t,function(t,e){this.light.cookieIntensity=Qe.clamp(t,0,1)})}get cookieIntensity(){return this.data.cookieIntensity}set cookieFalloff(t){this._setValue("cookieFalloff",t,function(t,e){this.light.cookieFalloff=t})}get cookieFalloff(){return this.data.cookieFalloff}set cookieChannel(t){this._setValue("cookieChannel",t,function(t,e){this.light.cookieChannel=t})}get cookieChannel(){return this.data.cookieChannel}set cookieAngle(t){this._setValue("cookieAngle",t,function(t,e){if(0!==t||null!==this.cookieScale){this._cookieMatrix||(this._cookieMatrix=new ls);let e=1,s=1;this.cookieScale&&(e=this.cookieScale.x,s=this.cookieScale.y);const n=Math.cos(t*Qe.DEG_TO_RAD),i=Math.sin(t*Qe.DEG_TO_RAD);this._cookieMatrix.set(n/e,-i/e,i/s,n/s),this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null})}get cookieAngle(){return this.data.cookieAngle}set cookieScale(t){this._setValue("cookieScale",t,function(t,e){if(null!==t||0!==this.cookieAngle){this._cookieMatrix||(this._cookieMatrix=new ls);const e=t.x,s=t.y,n=Math.cos(this.cookieAngle*Qe.DEG_TO_RAD),i=Math.sin(this.cookieAngle*Qe.DEG_TO_RAD);this._cookieMatrix.set(n/e,-i/e,i/s,n/s),this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null},!0)}get cookieScale(){return this.data.cookieScale}set cookieOffset(t){this._setValue("cookieOffset",t,function(t,e){this.light.cookieOffset=t},!0)}get cookieOffset(){return this.data.cookieOffset}set shadowUpdateMode(t){this._setValue("shadowUpdateMode",t,function(t,e){this.light.shadowUpdateMode=t},!0)}get shadowUpdateMode(){return this.data.shadowUpdateMode}set mask(t){this._setValue("mask",t,function(t,e){this.light.mask=t})}get mask(){return this.data.mask}set affectDynamic(t){this._setValue("affectDynamic",t,function(t,e){t?this.light.mask|=1:this.light.mask&=-2,this.light.layersDirty()})}get affectDynamic(){return this.data.affectDynamic}set affectLightmapped(t){this._setValue("affectLightmapped",t,function(t,e){t?(this.light.mask|=2,this.bake&&(this.light.mask&=-5)):(this.light.mask&=-3,this.bake&&(this.light.mask|=4))})}get affectLightmapped(){return this.data.affectLightmapped}set bake(t){this._setValue("bake",t,function(t,e){t?(this.light.mask|=4,this.affectLightmapped&&(this.light.mask&=-3)):(this.light.mask&=-5,this.affectLightmapped&&(this.light.mask|=2)),this.light.layersDirty()})}get bake(){return this.data.bake}set bakeDir(t){this._setValue("bakeDir",t,function(t,e){this.light.bakeDir=t})}get bakeDir(){return this.data.bakeDir}set isStatic(t){this._setValue("isStatic",t,function(t,e){this.light.isStatic=t})}get isStatic(){return this.data.isStatic}set layers(t){this._setValue("layers",t,function(t,e){for(let t=0;t<e.length;t++){const s=this.system.app.scene.layers.getLayerById(e[t]);s&&(s.removeLight(this),this.light.removeLayer(s))}for(let e=0;e<t.length;e++){const s=this.system.app.scene.layers.getLayerById(t[e]);s&&(this.enabled&&this.entity.enabled&&(s.addLight(this),this.light.addLayer(s)))}})}get layers(){return this.data.layers}set shadowUpdateOverrides(t){this.light.shadowUpdateOverrides=t}get shadowUpdateOverrides(){return this.light.shadowUpdateOverrides}set shadowSamples(t){this.light.shadowSamples=t}get shadowSamples(){return this.light.shadowSamples}set shadowBlockerSamples(t){this.light.shadowBlockerSamples=t}get shadowBlockerSamples(){return this.light.shadowBlockerSamples}set penumbraSize(t){this.light.penumbraSize=t}get penumbraSize(){return this.light.penumbraSize}set penumbraFalloff(t){this.light.penumbraFalloff=t}get penumbraFalloff(){return this.light.penumbraFalloff}_setValue(t,e,s,n){const i=this.data,r=i[t];(n||r!==e)&&(i[t]=e,s&&s.call(this,e,r))}addLightToLayers(){for(let t=0;t<this.layers.length;t++){const e=this.system.app.scene.layers.getLayerById(this.layers[t]);e&&(e.addLight(this),this.light.addLayer(e))}}removeLightFromLayers(){for(let t=0;t<this.layers.length;t++){const e=this.system.app.scene.layers.getLayerById(this.layers[t]);e&&(e.removeLight(this),this.light.removeLayer(e))}}onLayersChanged(t,e){this.enabled&&this.entity.enabled&&this.addLightToLayers(),t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this)}onLayerAdded(t){this.layers.indexOf(t.id)>=0&&this.enabled&&this.entity.enabled&&(t.addLight(this),this.light.addLayer(t))}onLayerRemoved(t){this.layers.indexOf(t.id)>=0&&(t.removeLight(this),this.light.removeLayer(t))}refreshProperties(){for(let t=0;t<Z_.length;t++){const e=Z_[t];this[e]=this[e]}this.enabled&&this.entity.enabled&&this.onEnable()}onCookieAssetSet(){let t=!1;"cubemap"!==this._cookieAsset.type||this._cookieAsset.loadFaces||(this._cookieAsset.loadFaces=!0,t=!0),this._cookieAsset.resource&&!t||this.system.app.assets.load(this._cookieAsset),this._cookieAsset.resource&&this.onCookieAssetLoad()}onCookieAssetAdd(t){this._cookieAssetId===t.id&&(this._cookieAsset=t,this.light.enabled&&this.onCookieAssetSet(),this._cookieAsset.on("load",this.onCookieAssetLoad,this),this._cookieAsset.on("remove",this.onCookieAssetRemove,this))}onCookieAssetLoad(){this._cookieAsset&&this._cookieAsset.resource&&(this.cookie=this._cookieAsset.resource)}onCookieAssetRemove(){this._cookieAssetId&&(this._cookieAssetAdd&&(this.system.app.assets.off(`add:${this._cookieAssetId}`,this.onCookieAssetAdd,this),this._cookieAssetAdd=!1),this._cookieAsset&&(this._cookieAsset.off("load",this.onCookieAssetLoad,this),this._cookieAsset.off("remove",this.onCookieAssetRemove,this),this._cookieAsset=null),this.cookie=null)}onEnable(){const t=this.system.app.scene,e=t.layers;this.light.enabled=!0,this._evtLayersChanged=t.on("set:layers",this.onLayersChanged,this),e&&(this._evtLayerAdded=e.on("add",this.onLayerAdded,this),this._evtLayerRemoved=e.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&this.addLightToLayers(),this._cookieAsset&&!this.cookie&&this.onCookieAssetSet()}onDisable(){const t=this.system.app.scene.layers;this.light.enabled=!1,this._evtLayersChanged?.off(),this._evtLayersChanged=null,t&&(this._evtLayerAdded?.off(),this._evtLayerAdded=null,this._evtLayerRemoved?.off(),this._evtLayerRemoved=null),this.removeLightFromLayers()}onRemove(){this.onDisable(),this.light.destroy(),this.cookieAsset=null}constructor(...t){super(...t),this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._cookieAsset=null,this._cookieAssetId=null,this._cookieAssetAdd=!1,this._cookieMatrix=null}}class tv extends wg{constructor(t){super(t),this.id="light",this.ComponentType=J_,this.DataType=Q_,this.on("beforeremove",this._onRemoveComponent,this)}initializeComponentData(t,e){const s={...e};s.type||(s.type=t.data.type),t.data.type=s.type,s.layers&&Array.isArray(s.layers)&&(s.layers=s.layers.slice(0)),s.color&&Array.isArray(s.color)&&(s.color=new Ze(s.color[0],s.color[1],s.color[2])),s.cookieOffset&&s.cookieOffset instanceof Array&&(s.cookieOffset=new os(s.cookieOffset[0],s.cookieOffset[1])),s.cookieScale&&s.cookieScale instanceof Array&&(s.cookieScale=new os(s.cookieScale[0],s.cookieScale[1])),s.enable&&(console.warn("WARNING: enable: Property is deprecated. Set enabled property instead."),s.enabled=s.enable),s.shape||(s.shape=0);const n=new ju(this.app.graphicsDevice,this.app.scene.clusteredLightingEnabled);n.type=Uu[s.type],n._node=t.entity,t.data.light=n,super.initializeComponentData(t,s,Z_)}_onRemoveComponent(t,e){e.onRemove()}cloneComponent(t,e){const s=t.light,n=[];let i;for(let t=0;t<Z_.length;t++)i=Z_[t],"light"!==i&&(s[i]&&s[i].clone?n[i]=s[i].clone():n[i]=s[i]);return this.addComponent(e,n)}changeType(t,e,s){e!==s&&(t.light.type=Uu[s])}}const ev=["x","y","z","w"],sv=[void 0,void 0,os,rs,ls];function nv(t,e,s,n){switch(e.type){case"boolean":return!!s;case"number":if("number"==typeof s)return s;if("string"==typeof s){const t=parseInt(s,10);return isNaN(t)?null:t}return"boolean"==typeof s?0+s:null;case"json":{const n={};if(Array.isArray(e.schema)){s&&"object"==typeof s||(s={});for(let i=0;i<e.schema.length;i++){const r=e.schema[i];if(r.name)if(r.array){n[r.name]=[];const e=Array.isArray(s[r.name])?s[r.name]:[];for(let s=0;s<e.length;s++)n[r.name].push(nv(t,r,e[s]))}else{const e=s.hasOwnProperty(r.name)?s[r.name]:r.default;n[r.name]=nv(t,r,e)}}}return n}case"asset":return s instanceof Fm?s:"number"==typeof s?t.assets.get(s)||null:"string"==typeof s&&t.assets.get(parseInt(s,10))||null;case"entity":return s instanceof Hc?s:"string"==typeof s?t.getEntityFromIndex(s):null;case"rgb":case"rgba":if(s instanceof Ze)return n instanceof Ze?(n.copy(s),n):s.clone();if(s instanceof Array&&s.length>=3&&s.length<=4){for(let t=0;t<s.length;t++)if("number"!=typeof s[t])return null;return n||(n=new Ze),n.r=s[0],n.g=s[1],n.b=s[2],n.a=3===s.length?1:s[3],n}return"string"==typeof s&&/#(?:[0-9a-f]{2}){3,4}/i.test(s)?(n||(n=new Ze),n.fromString(s),n):null;case"vec2":case"vec3":case"vec4":{const t=parseInt(e.type.slice(3),10),i=sv[t];if(s instanceof i)return n instanceof i?(n.copy(s),n):s.clone();if(s instanceof Array&&s.length===t){for(let t=0;t<s.length;t++)if("number"!=typeof s[t])return null;n||(n=new i);for(let e=0;e<t;e++)n[ev[e]]=s[e];return n}return null}case"curve":if(s){let t;if(s instanceof ts||s instanceof es)t=s.clone();else{t=new(s.keys[0]instanceof Array?es:ts)(s.keys),t.type=s.type}return t}}return s}function iv(t,e,s,n){return e.array?s.map((s,i)=>nv(t,e,s,n?n[i]:null)):nv(t,e,s,n)}function rv(t,e,s,n){if(s)for(const i in e){const r=e[i],a=s[i];void 0!==a&&(n[i]=iv(t,r,a,n[i]))}}class av{static{this.assignAttributesToScript=rv}static{this.attributeToValue=iv}constructor(t){this.scriptType=t,this.index={}}static{this.reservedNames=new Set(["app","entity","enabled","_enabled","_enabledOld","_destroyed","__attributes","__attributesRaw","__scriptType","__executionOrder","_callbacks","_callbackActive","has","get","on","off","fire","once","hasEvent"])}add(t,e){e&&e.type&&(this.index[t]||av.reservedNames.has(t)||(this.index[t]=e,Object.defineProperty(this.scriptType.prototype,t,{get:function(){return this.__attributes[t]},set:function(s){const n="attr",i=`attr:${t}`,r=this.__attributes[t];let a=r;if(r&&"json"!==e.type&&"entity"!==e.type&&r.clone&&(this.hasEvent(n)||this.hasEvent(i))&&(a=r.clone()),e.array){if(this.__attributes[t]=[],s)for(let n=0,i=s.length;n<i;n++)this.__attributes[t].push(nv(this.app,e,s[n],r?r[n]:null))}else this.__attributes[t]=nv(this.app,e,s,r);this.fire(n,t,this.__attributes[t],a),this.fire(i,this.__attributes[t],a)}})))}remove(t){return!!this.index[t]&&(delete this.index[t],delete this.scriptType.prototype[t],!0)}has(t){return!!this.index[t]}get(t){return this.index[t]||null}}const ov="initialize",lv="postInitialize";class hv extends Ve{static{this.EVENT_ENABLE="enable"}static{this.EVENT_DISABLE="disable"}static{this.EVENT_STATE="state"}static{this.EVENT_DESTROY="destroy"}static{this.EVENT_ATTR="attr"}static{this.EVENT_ERROR="error"}constructor(t){super(),this.initScript(t)}set enabled(t){this._enabled=!!t,this.enabled!==this._enabledOld&&(this._enabledOld=this.enabled,this.fire(this.enabled?"enable":"disable"),this.fire("state",this.enabled),!this._initialized&&this.enabled&&(this._initialized=!0,this.fire("preInitialize"),this.initialize&&this.entity.script._scriptMethod(this,ov)),this._initialized&&!this._postInitialized&&this.enabled&&!this.entity.script._beingEnabled&&(this._postInitialized=!0,this.postInitialize&&this.entity.script._scriptMethod(this,lv)))}get enabled(){return this._enabled&&!this._destroyed&&this.entity.script.enabled&&this.entity.enabled}initScript(t){const e=this.constructor;this.app=t.app,this.entity=t.entity,this._enabled="boolean"!=typeof t.enabled||t.enabled,this._enabledOld=this.enabled,this.__destroyed=!1,this.__scriptType=e,this.__executionOrder=-1}static{this.__name=null}static{this.__getScriptName=dv}static get scriptName(){return this.__name}}const cv=/^\s*function(?:\s|\s*\/\*.*\*\/\s*)+([^(\s\/]*)\s*/;function dv(t){if("function"!=typeof t)return;if(t.scriptName)return t.scriptName;if("name"in Function.prototype)return t.name;if(t===Function||t===Function.prototype.constructor)return"Function";const e=`${t}`.match(cv);return e?e[1]:void 0}class uv extends hv{constructor(t){super(t),this.initScriptType(t)}static get attributes(){return this.hasOwnProperty("__attributes")||(this.__attributes=new av(this)),this.__attributes}initScript(t){hv.prototype.initScript.call(this,t),this.__attributes={},this.__attributesRaw=t.attributes||{}}initScriptType(t){this.initScript(t)}__initializeAttributes(t){if(t||this.__attributesRaw){for(const t in this.__scriptType.attributes.index)this.__attributesRaw&&this.__attributesRaw.hasOwnProperty(t)?this[t]=this.__attributesRaw[t]:this.__attributes.hasOwnProperty(t)||(this.__scriptType.attributes.index[t].hasOwnProperty("default")?this[t]=this.__scriptType.attributes.index[t].default:this[t]=null);this.__attributesRaw=null}}static extend(t){for(const e in t)t.hasOwnProperty(e)&&(this.prototype[e]=t[e])}}class fv extends xg{static{this.EVENT_CREATE="create"}static{this.EVENT_DESTROY="destroy"}static{this.EVENT_ENABLE="enable"}static{this.EVENT_DISABLE="disable"}static{this.EVENT_REMOVE="remove"}static{this.EVENT_STATE="state"}static{this.EVENT_MOVE="move"}static{this.EVENT_ERROR="error"}constructor(t,e){super(t,e),this._attributeDataMap=new Map,this._scripts=[],this._updateList=new je({sortBy:"__executionOrder"}),this._postUpdateList=new je({sortBy:"__executionOrder"}),this._scriptsIndex={},this._destroyedScripts=[],this._destroyed=!1,this._scriptsData=null,this._oldState=!0,this._enabled=!0,this._beingEnabled=!1,this._isLoopingThroughScripts=!1,this._executionOrder=-1,this.on("set_enabled",this._onSetEnabled,this)}set scripts(t){this._scriptsData=t;for(const e in t){if(!t.hasOwnProperty(e))continue;const s=this._scriptsIndex[e];if(s){if("boolean"==typeof t[e].enabled&&(s.once("preInitialize",()=>{this.initializeAttributes(s)}),s.enabled=!!t[e].enabled),"object"==typeof t[e].attributes)for(const n in t[e].attributes)if(!av.reservedNames.has(n)){if(!s.__attributes.hasOwnProperty(n)){const t=this.system.app.scripts.get(e);t&&t.attributes.add(n,{})}s[n]=t[e].attributes[n]}}else console.log(this.order)}}get scripts(){return this._scripts}set enabled(t){const e=this._enabled;this._enabled=t,this.fire("set","enabled",e,t)}get enabled(){return this._enabled}onEnable(){this._beingEnabled=!0,this._checkState(),this.entity._beingEnabled||this.onPostStateChange(),this._beingEnabled=!1}onDisable(){this._checkState()}onPostStateChange(){const t=this._beginLooping();for(let t=0,e=this.scripts.length;t<e;t++){const e=this.scripts[t];e._initialized&&!e._postInitialized&&e.enabled&&(e._postInitialized=!0,e.postInitialize&&this._scriptMethod(e,lv))}this._endLooping(t)}_beginLooping(){const t=this._isLoopingThroughScripts;return this._isLoopingThroughScripts=!0,t}_endLooping(t){this._isLoopingThroughScripts=t,this._isLoopingThroughScripts||this._removeDestroyedScripts()}_onSetEnabled(t,e,s){this._beingEnabled=!0,this._checkState(),this._beingEnabled=!1}_checkState(){const t=this.enabled&&this.entity.enabled;if(t===this._oldState)return;this._oldState=t,this.fire(t?"enable":"disable"),this.fire("state",t),t?this.system._addComponentToEnabled(this):this.system._removeComponentFromEnabled(this);const e=this._beginLooping();for(let t=0,e=this.scripts.length;t<e;t++){const e=this.scripts[t];e.once("preInitialize",()=>{this.initializeAttributes(e)}),e.enabled=e._enabled}this._endLooping(e)}_onBeforeRemove(){this.fire("remove");const t=this._beginLooping();for(let t=0;t<this.scripts.length;t++){const e=this.scripts[t];e&&this.destroy(e.__scriptType.__name)}this._endLooping(t)}_removeDestroyedScripts(){const t=this._destroyedScripts.length;if(t){for(let e=0;e<t;e++){const t=this._destroyedScripts[e];this._removeScriptInstance(t)}this._destroyedScripts.length=0,this._resetExecutionOrder(0,this._scripts.length)}}_onInitializeAttributes(){for(let t=0,e=this.scripts.length;t<e;t++){const e=this.scripts[t];this.initializeAttributes(e)}}initializeAttributes(t){if(t instanceof uv)t.__initializeAttributes();else{const e=t.__scriptType.__name,s=this._attributeDataMap.get(e);if(!s)return;const n=this.system.app.scripts?.getSchema(e);rv(this.system.app,n.attributes,s,t)}}_scriptMethod(t,e,s){t[e](s)}_onInitialize(){const t=this._scripts,e=this._beginLooping();for(let e=0,s=t.length;e<s;e++){const s=t[e];!s._initialized&&s.enabled&&(s._initialized=!0,s.initialize&&this._scriptMethod(s,ov))}this._endLooping(e)}_onPostInitialize(){this.onPostStateChange()}_onUpdate(t){const e=this._updateList;if(!e.length)return;const s=this._beginLooping();for(e.loopIndex=0;e.loopIndex<e.length;e.loopIndex++){const s=e.items[e.loopIndex];s.enabled&&this._scriptMethod(s,"update",t)}this._endLooping(s)}_onPostUpdate(t){const e=this._postUpdateList;if(!e.length)return;const s=this._beginLooping();for(e.loopIndex=0;e.loopIndex<e.length;e.loopIndex++){const s=e.items[e.loopIndex];s.enabled&&this._scriptMethod(s,"postUpdate",t)}this._endLooping(s)}_insertScriptInstance(t,e,s){-1===e?(this._scripts.push(t),t.__executionOrder=s,t.update&&this._updateList.append(t),t.postUpdate&&this._postUpdateList.append(t)):(this._scripts.splice(e,0,t),t.__executionOrder=e,this._resetExecutionOrder(e+1,s+1),t.update&&this._updateList.insert(t),t.postUpdate&&this._postUpdateList.insert(t))}_removeScriptInstance(t){const e=this._scripts.indexOf(t);return-1===e||(this._scripts.splice(e,1),t.update&&this._updateList.remove(t),t.postUpdate&&this._postUpdateList.remove(t)),e}_resetExecutionOrder(t,e){for(let s=t;s<e;s++)this._scripts[s].__executionOrder=s}_resolveEntityScriptAttribute(t,e,s,n,i,r){if(t.array){const t=s.length;if(!t)return;const a=s.slice();for(let e=0;e<t;e++){const t=a[e]instanceof Jm?a[e].getGuid():a[e];r[t]&&(a[e]=n?r[t].getGuid():r[t])}i[e]=a}else{if(s instanceof Jm)s=s.getGuid();else if("string"!=typeof s)return;r[s]&&(i[e]=r[s])}}has(t){if("string"==typeof t)return!!this._scriptsIndex[t];if(!t)return!1;const e=t,s=e.__name,n=this._scriptsIndex[s];return(n&&n.instance)instanceof e}get(t){if("string"==typeof t){const e=this._scriptsIndex[t];return e?e.instance:null}if(!t)return null;const e=t,s=e.__name,n=this._scriptsIndex[s],i=n&&n.instance;return i instanceof e?i:null}create(t,e={}){const s=this;let n=t,i=t;if("string"==typeof n)n=this.system.app.scripts.get(n);else if(n){const t=dv(n),e=(r=t)[0].toLowerCase()+r.substring(1);n.__name??=n.scriptName??e,i=n.__name}var r;if(n){if(!this._scriptsIndex[i]||!this._scriptsIndex[i].instance){const t=new n({app:this.system.app,entity:this.entity,enabled:!e.hasOwnProperty("enabled")||e.enabled,attributes:e.attributes||{}});e.properties&&"object"==typeof e.properties&&Object.assign(t,e.properties),t instanceof uv||!e.attributes||this._attributeDataMap.set(i,{...e.attributes});const r=this._scripts.length;let a=-1;return"number"==typeof e.ind&&-1!==e.ind&&r>e.ind&&(a=e.ind),this._insertScriptInstance(t,a,r),this._scriptsIndex[i]={instance:t,onSwap:function(){s.swap(i)}},this[i]=t,e.preloading||this.initializeAttributes(t),this.fire("create",i,t),this.fire(`create:${i}`,t),this.system.app.scripts.on(`swap:${i}`,this._scriptsIndex[i].onSwap),e.preloading||(t.enabled&&!t._initialized&&(t._initialized=!0,t.initialize&&this._scriptMethod(t,ov)),t.enabled&&!t._postInitialized&&(t._postInitialized=!0,t.postInitialize&&this._scriptMethod(t,lv))),t}}else this._scriptsIndex[i]={awaiting:!0,ind:this._scripts.length};return null}destroy(t){let e=t,s=t;"string"==typeof s?s=this.system.app.scripts.get(s):s&&(e=s.__name);const n=this._scriptsIndex[e];if(delete this._scriptsIndex[e],!n)return!1;this._attributeDataMap.delete(e);const i=n.instance;if(i&&!i._destroyed)if(i.enabled=!1,i._destroyed=!0,this._isLoopingThroughScripts)this._destroyedScripts.push(i);else{const t=this._removeScriptInstance(i);t>=0&&this._resetExecutionOrder(t,this._scripts.length)}return this.system.app.scripts.off(`swap:${e}`,n.onSwap),delete this[e],this.fire("destroy",e,i||null),this.fire(`destroy:${e}`,i||null),i&&i.fire("destroy"),!0}swap(t){let e=t,s=t;"string"==typeof s?s=this.system.app.scripts.get(s):s&&(e=s.__name);const n=this._scriptsIndex[e];if(!n||!n.instance)return!1;const i=n.instance,r=this._scripts.indexOf(i),a=new s({app:this.system.app,entity:this.entity,enabled:i.enabled,attributes:i.__attributes});return!!a.swap&&(this.initializeAttributes(a),this._scripts[r]=a,this._scriptsIndex[e].instance=a,this[e]=a,a.__executionOrder=r,i.update&&this._updateList.remove(i),i.postUpdate&&this._postUpdateList.remove(i),a.update&&this._updateList.insert(a),a.postUpdate&&this._postUpdateList.insert(a),this._scriptMethod(a,"swap",i),this.fire("swap",e,a),this.fire(`swap:${e}`,a),!0)}resolveDuplicatedEntityReferenceProperties(t,e){const s=this.entity.script;for(const n in t._scriptsIndex){const i=this.system.app.scripts.get(n);if(!i)continue;const r=t._scriptsIndex[n];if(!r||!r.instance)continue;const a=s[n].__attributesRaw??s._attributeDataMap.get(n),o=s[n].__attributes;if(!a&&!o)continue;const l=!!a,h=r.instance.__attributes??s._attributeDataMap.get(n);for(const t in h){if(!h[t])continue;const s=i.attributes?.get(t)??this.system.app.scripts.getSchema(n)?.attributes?.[t];if(s)if("entity"===s.type)this._resolveEntityScriptAttribute(s,t,h[t],l,a||o,e);else if("json"===s.type&&Array.isArray(s.schema)){const n=h[t],i=a?a[t]:o[t];for(let t=0;t<s.schema.length;t++){const r=s.schema[t];if("entity"===r.type)if(s.array)for(let t=0;t<n.length;t++)this._resolveEntityScriptAttribute(r,r.name,n[t][r.name],l,i[t],e);else this._resolveEntityScriptAttribute(r,r.name,n[r.name],l,i,e)}}}}}move(t,e){const s=this._scripts.length;if(e>=s||e<0)return!1;let n=t,i=t;"string"!=typeof i?i=t.__name:n=null;const r=this._scriptsIndex[i];if(!r||!r.instance)return!1;const a=r.instance;if(n&&!(a instanceof n))return!1;const o=this._scripts.indexOf(a);return-1!==o&&o!==e&&(this._scripts.splice(e,0,this._scripts.splice(o,1)[0]),this._resetExecutionOrder(0,s),this._updateList.sort(),this._postUpdateList.sort(),this.fire("move",i,a,e,o),this.fire(`move:${i}`,a,e,o),!0)}}class pv{constructor(){this.enabled=!0}}let mv=0;class gv extends wg{constructor(t){super(t),this.id="script",this.ComponentType=fv,this.DataType=pv,this._components=new je({sortBy:"_executionOrder"}),this._enabledComponents=new je({sortBy:"_executionOrder"}),this.preloading=!0,this.on("beforeremove",this._onBeforeRemove,this),this.app.systems.on("initialize",this._onInitialize,this),this.app.systems.on("postInitialize",this._onPostInitialize,this),this.app.systems.on("update",this._onUpdate,this),this.app.systems.on("postUpdate",this._onPostUpdate,this)}initializeComponentData(t,e){if(t._executionOrder=mv++,this._components.append(t),mv>Number.MAX_SAFE_INTEGER&&this._resetExecutionOrder(),t.enabled=!e.hasOwnProperty("enabled")||!!e.enabled,t.enabled&&t.entity.enabled&&this._enabledComponents.append(t),e.hasOwnProperty("order")&&e.hasOwnProperty("scripts")){t._scriptsData=e.scripts;for(let s=0;s<e.order.length;s++)t.create(e.order[s],{enabled:e.scripts[e.order[s]].enabled,attributes:e.scripts[e.order[s]].attributes,preloading:this.preloading})}}cloneComponent(t,e){const s=[],n={};for(let e=0;e<t.script._scripts.length;e++){const i=t.script._scripts[e],r=i.__scriptType.__name;s.push(r);const a=t.script._attributeDataMap?.get(r)||{};for(const t in i.__attributes)a[t]=i.__attributes[t];n[r]={enabled:i._enabled,attributes:a}}for(const e in t.script._scriptsIndex)e.awaiting&&s.splice(e.ind,0,e);const i={enabled:t.script.enabled,order:s,scripts:n};return this.addComponent(e,i)}_resetExecutionOrder(){mv=0;for(let t=0,e=this._components.length;t<e;t++)this._components.items[t]._executionOrder=mv++}_callComponentMethod(t,e,s){for(t.loopIndex=0;t.loopIndex<t.length;t.loopIndex++)t.items[t.loopIndex][e](s)}_onInitialize(){this.preloading=!1,this._callComponentMethod(this._components,"_onInitializeAttributes"),this._callComponentMethod(this._enabledComponents,"_onInitialize")}_onPostInitialize(){this._callComponentMethod(this._enabledComponents,"_onPostInitialize")}_onUpdate(t){this._callComponentMethod(this._enabledComponents,"_onUpdate",t)}_onPostUpdate(t){this._callComponentMethod(this._enabledComponents,"_onPostUpdate",t)}_addComponentToEnabled(t){this._enabledComponents.insert(t)}_removeComponentFromEnabled(t){this._enabledComponents.remove(t)}_onBeforeRemove(t,e){this._components.items.indexOf(e)>=0&&e._onBeforeRemove(),this._removeComponentFromEnabled(e),this._components.remove(e)}destroy(){super.destroy(),this.app.systems.off("initialize",this._onInitialize,this),this.app.systems.off("postInitialize",this._onPostInitialize,this),this.app.systems.off("update",this._onUpdate,this),this.app.systems.off("postUpdate",this._onPostUpdate,this)}}class _v{constructor(t){this.texture=null,this.rt=null,this.intervalsDataTexture=null,this.shader=null,this.device=t}destroy(){this.texture?.destroy(),this.texture=null,this.rt?.destroy(),this.rt=null,this.intervalsDataTexture?.destroy(),this.intervalsDataTexture=null,this.shader=null}getShader(){return this.shader||(this.shader=zh.createShader(this.device,{uniqueName:"GSplatIntervalsShader",attributes:{aPosition:Ys},vertexChunk:"quadVS",fragmentGLSL:"\nprecision highp usampler2D;\nuniform usampler2D uIntervalsTexture;\nuniform int uNumIntervals;\nuniform int uTextureWidth;\nuniform int uActiveSplats;\nivec2 getCoordFromIndex(int index, int textureWidth) {\n\treturn ivec2(index % textureWidth, index / textureWidth);\n}\nvoid main() {\n\tivec2 coord = ivec2(gl_FragCoord.xy);\n\tint targetIndex = coord.y * uTextureWidth + coord.x;\n\t\n\tif (targetIndex >= uActiveSplats) {\n\t\tgl_FragColor = 0u;\n\t\treturn;\n\t}\n\t\n\tint left = 0;\n\tint right = uNumIntervals - 1;\n\tint intervalIndex = 0;\n\t\n\twhile (left <= right) {\n\t\tint mid = (left + right) / 2;\n\t\t\n\t\tint textureWidth = textureSize(uIntervalsTexture, 0).x;\n\t\tivec2 intervalCoord = getCoordFromIndex(mid, textureWidth);\n\t\tuvec2 intervalData = texelFetch(uIntervalsTexture, intervalCoord, 0).rg;\n\t\t\n\t\tuint accumulatedSum = intervalData.g;\n\t\t\n\t\tif (uint(targetIndex) < accumulatedSum) {\n\t\t\tintervalIndex = mid;\n\t\t\tright = mid - 1;\n\t\t} else {\n\t\t\tleft = mid + 1;\n\t\t}\n\t}\n\t\n\tint textureWidth = textureSize(uIntervalsTexture, 0).x;\n\tivec2 intervalCoord = getCoordFromIndex(intervalIndex, textureWidth);\n\tuvec2 intervalData = texelFetch(uIntervalsTexture, intervalCoord, 0).rg;\n\t\n\tuint intervalStart = intervalData.r;\n\tuint currentAccSum = intervalData.g;\n\t\n\tuint prevAccSum = 0u;\n\tif (intervalIndex > 0) {\n\t\tivec2 prevCoord = getCoordFromIndex(intervalIndex - 1, textureWidth);\n\t\tprevAccSum = texelFetch(uIntervalsTexture, prevCoord, 0).g;\n\t}\n\t\n\tuint offsetInInterval = uint(targetIndex) - prevAccSum;\n\tuint originalIndex = intervalStart + offsetInInterval;\n\t\n\tgl_FragColor = originalIndex;\n}\n",fragmentWGSL:"\nvar uIntervalsTexture: texture_2d<u32>;\nuniform uNumIntervals: i32;\nuniform uTextureWidth: i32;\nuniform uActiveSplats: i32;\nfn getCoordFromIndex(index: i32, textureWidth: i32) -> vec2i {\n\treturn vec2i(index % textureWidth, index / textureWidth);\n}\n@fragment\nfn fragmentMain(input: FragmentInput) -> FragmentOutput {\n\tvar output: FragmentOutput;\n\t\n\tlet coord = vec2i(i32(input.position.x), i32(input.position.y));\n\tlet targetIndex = coord.y * uniform.uTextureWidth + coord.x;\n\t\n\tif (targetIndex >= uniform.uActiveSplats) {\n\t\toutput.color = 0u;\n\t\treturn output;\n\t}\n\t\n\tvar left = 0i;\n\tvar right = uniform.uNumIntervals - 1;\n\tvar intervalIndex = 0i;\n\t\n\twhile (left <= right) {\n\t\tlet mid = (left + right) / 2;\n\t\t\n\t\tlet textureWidth = i32(textureDimensions(uIntervalsTexture, 0).x);\n\t\tlet intervalCoord = getCoordFromIndex(mid, textureWidth);\n\t\tlet intervalData = textureLoad(uIntervalsTexture, intervalCoord, 0).rg;\n\t\t\n\t\tlet accumulatedSum = intervalData.g;\n\t\t\n\t\tif (u32(targetIndex) < accumulatedSum) {\n\t\t\tintervalIndex = mid;\n\t\t\tright = mid - 1;\n\t\t} else {\n\t\t\tleft = mid + 1;\n\t\t}\n\t}\n\t\n\tlet textureWidth = i32(textureDimensions(uIntervalsTexture, 0).x);\n\tlet intervalCoord = getCoordFromIndex(intervalIndex, textureWidth);\n\tlet intervalData = textureLoad(uIntervalsTexture, intervalCoord, 0).rg;\n\t\n\tlet intervalStart = intervalData.r;\n\tlet currentAccSum = intervalData.g;\n\t\n\tvar prevAccSum = 0u;\n\tif (intervalIndex > 0) {\n\t\tlet prevCoord = getCoordFromIndex(intervalIndex - 1, textureWidth);\n\t\tprevAccSum = textureLoad(uIntervalsTexture, prevCoord, 0).g;\n\t}\n\t\n\tlet offsetInInterval = u32(targetIndex) - prevAccSum;\n\tlet originalIndex = intervalStart + offsetInInterval;\n\t\n\toutput.color = originalIndex;\n\treturn output;\n}\n",fragmentOutputTypes:["uint"]})),this.shader}createTexture(t,e,s,n){return new pi(this.device,{name:t,width:s,height:n,format:e,cubemap:!1,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1})}update(t,e){const s=this.device.maxTextureSize;let n=Math.ceil(Math.sqrt(e));n=Math.min(n,s);const i=Math.ceil(e/n);this.texture=this.createTexture("intervalsTexture",zs,n,i),this.rt=new ji({colorBuffer:this.texture,depth:!1});const r=t.length/2,a=Math.ceil(Math.sqrt(r));this.intervalsDataTexture=this.createTexture("intervalsData",Us,a,a);const o=this.intervalsDataTexture.lock();let l=0;for(let e=0;e<r;e++){const s=t[2*e];l+=t[2*e+1]-s,o[2*e]=s,o[2*e+1]=l}this.intervalsDataTexture.unlock();const h=this.device.scope;return h.resolve("uIntervalsTexture").setValue(this.intervalsDataTexture),h.resolve("uNumIntervals").setValue(r),h.resolve("uTextureWidth").setValue(n),h.resolve("uActiveSplats").setValue(e),this.device.setCullMode(0),this.device.setBlendState(Ti.NOBLEND),this.device.setDepthState(Ai.NODEPTH),Xh(this.device,this.rt,this.getShader()),e}}const vv=[];class yv{constructor(t,e,s){this.activeSplats=0,this.intervals=[],this.lineStart=0,this.lineCount=0,this.padding=0,this.viewport=new ls,this.previousWorldTransform=new ps,this.aabb=new Ss,this.intervalTexture=null,this.colorAccumulatedRotation=0,this.colorAccumulatedTranslation=0,this.device=t,this.resource=e,this.node=s.node,this.lodIndex=s.lodIndex,this.numSplats=e.numSplats,this.aabb.copy(s.aabb),this.updateIntervals(s.intervals)}destroy(){this.intervals.length=0,this.intervalTexture?.destroy()}setLines(t,e,s,n){this.lineStart=t,this.lineCount=e,this.padding=s*e-n,this.viewport.set(0,t,s,e)}updateIntervals(t){const e=this.resource;if(this.intervals.length=0,this.activeSplats=e.numSplats,t.size>0){let e=0,s=0;for(const n of t.values())e+=n.y-n.x+1,vv[s++]=n;if(e!==this.numSplats){vv.length=s,vv.sort((t,e)=>t.x-e.x),this.intervals.length=2*s;let t=0,n=vv[0].x,i=vv[0].y;for(let e=1;e<s;e++){const s=vv[e];s.x===i+1||(this.intervals[t++]=n,this.intervals[t++]=i+1,n=s.x),i=s.y}this.intervals[t++]=n,this.intervals[t++]=i+1,this.intervals.length=t,this.intervalTexture=new _v(this.device),this.activeSplats=this.intervalTexture.update(this.intervals,e)}vv.length=0}}update(){const t=this.node.getWorldTransform(),e=!this.previousWorldTransform.equals(t);return e&&this.previousWorldTransform.copy(t),e}resetColorAccumulators(t,e){const s=Math.random();this.colorAccumulatedRotation=s*t,this.colorAccumulatedTranslation=s*e}get hasSphericalHarmonics(){return this.resource.gsplatData?.shBands>0}}function bv(){const t="undefined"!=typeof self&&self||require("node:worker_threads").parentPort,e=new Map;let s,n,i,r=!1;const a=32,o=new Array(a).fill(0),l=new Array(a).fill(0),h=[{maxDistance:0,weight:40},{maxDistance:2,weight:20},{maxDistance:5,weight:8},{maxDistance:10,weight:3},{maxDistance:1/0,weight:1}],c=new Array(a);for(let t=0;t<a;++t){let e=1;for(let s=0;s<h.length;++s)if(t<=h[s].maxDistance){e=h[s].weight;break}c[t]=e}const d=(t,s,n,i,r,o,l)=>{const{ids:h,lineStarts:c,padding:d,intervals:u,textureSize:f}=o,p=a/n;for(let a=0;a<t.length;a++){const o=t[a],m=h[a],g=e.get(m);g||console.error("UnifiedSortWorker: No centers found for id",m);let _=c[a]*f;const v=u[a].length>0?u[a]:[0,g.length/3];for(let t=0;t<v.length;t+=2){_=l(g,o,3*v[t],3*v[t+1],_,p,s,n,i,r)}const y=d[a];r[0]+=y,i.fill(0,_,_+y),_+=y}},u=(e,s,h)=>{const{minDist:u,maxDist:f}=r?(t=>{let e=-1/0;for(let s=0;s<t.length;s++){const n=t[s],{transformedPosition:i,scale:r,aabbMin:a,aabbMax:o}=n,l=i.x,h=i.y,c=i.z;for(let t=0;t<8;t++){const s=(1&t?o[0]:a[0])-l,n=(2&t?o[1]:a[1])-h,i=(4&t?o[2]:a[2])-c,d=s*s+n*n+i*i,u=Math.sqrt(d)*r;u>e&&(e=u)}}return e<0&&(e=0),{minDist:0,maxDist:e}})(e):(t=>{let e=1/0,s=-1/0;for(let n=0;n<t.length;n++){const i=t[n],{transformedDirection:r,offset:a,scale:o,aabbMin:l,aabbMax:h}=i,c=r.x,d=r.y,u=r.z,f=((c>=0?l[0]:h[0])*c+(d>=0?l[1]:h[1])*d+(u>=0?l[2]:h[2])*u)*o+a,p=((c>=0?h[0]:l[0])*c+(d>=0?h[1]:l[1])*d+(u>=0?h[2]:l[2])*u)*o+a,m=Math.min(f,p),g=Math.max(f,p);m<e&&(e=m),g>s&&(s=g)}return e===1/0&&(e=0,s=0),{minDist:e,maxDist:s}})(e),p=h.totalUsedPixels,m=2**Math.max(10,Math.min(20,Math.round(Math.log2(p/4))))+1;n?.length!==p&&(n=new Uint32Array(p)),i&&i.length===m?i.fill(0):i=new Uint32Array(m);const g=f-u;let _;if(r)_=31;else{const t=(0-u)/g*a;_=Math.max(0,Math.min(31,Math.floor(t)))}((t,e)=>{const s=e,n=[];for(let e=0;e<a;++e){const s=Math.abs(e-t);n[e]=c[s]}const i=n.reduce((t,e)=>t+e,0);let r=0;for(let t=0;t<a;++t)l[t]=Math.max(1,Math.floor(n[t]/i*s)),o[t]=r,r+=l[t];if(r>e){const t=r-e;l[31]=Math.max(1,l[31]-t)}o[32]=o[31]+l[31],l[32]=0})(_,m),r?((t,e,s,n,i,r)=>{d(t,e,s,n,i,r,(t,e,s,n,i,r,a,h,c,d)=>{const{transformedPosition:u,scale:f}=e,p=u.x,m=u.y,g=u.z;for(let e=s;e<n;e+=3){const s=t[e]-p,n=t[e+1]-m,a=t[e+2]-g,u=s*s+n*n+a*a,_=(h-Math.sqrt(u)*f)*r,v=_>>>0,y=o[v]+l[v]*(_-v)>>>0;c[i++]=y,d[y]++}return i})})(e,u,g,n,i,h):((t,e,s,n,i,r)=>{d(t,e,s,n,i,r,(t,e,s,n,i,r,a,h,c,d)=>{const{transformedDirection:u,offset:f,scale:p}=e,m=u.x*p,g=u.y*p,_=u.z*p,v=f-a;for(let e=s;e<n;e+=3){const s=(t[e]*m+t[e+1]*g+t[e+2]*_+v)*r,n=s>>>0,a=o[n]+l[n]*(s-n)>>>0;c[i++]=a,d[a]++}return i})})(e,u,g,n,i,h),((t,e,s,n,i)=>{for(let s=1;s<t;s++)e[s]+=e[s-1];for(let t=0;t<s;t++)i[--e[n[t]]]=t})(m,i,p,n,s);const v=p,y=[s.buffer],b={order:s.buffer,count:v,version:h.version};t.postMessage(b,y)};t.addEventListener("message",t=>{const n=t.data??t;switch(n.command){case"addCenters":e.set(n.id,new Float32Array(n.centers));break;case"removeCenters":e.delete(n.id);break;case"sort":{r=n.radialSorting||!1;const t=new Uint32Array(n.order);u(n.sortParams,t,s);break}case"intervals":s=n}})}const Sv=new Set;class xv extends Ve{constructor(){super(),this.bufferLength=0,this.availableOrderData=[],this.jobsInFlight=0,this.hasNewVersion=!1,this.pendingSorted=null,this.centersSet=new Set,this._destroyed=!1;const t=`(${bv.toString()})()`;"node"===ze.environment?(this.worker=new Worker(t,{eval:!0}),this.worker.on("message",this.onSorted.bind(this))):(this.worker=new Worker(URL.createObjectURL(new Blob([t],{type:"application/javascript"}))),this.worker.addEventListener("message",this.onSorted.bind(this)))}onSorted(t){if(this._destroyed)return;const e=t.data??t,s=new Uint32Array(e.order);this.jobsInFlight--,this.pendingSorted&&this.releaseOrderData(this.pendingSorted.orderData),this.pendingSorted={count:e.count,version:e.version,orderData:s}}applyPendingSorted(){if(this.pendingSorted){const{count:t,version:e,orderData:s}=this.pendingSorted;this.pendingSorted=null,this.fire("sorted",t,e,s),this.releaseOrderData(s)}}releaseOrderData(t){t.length===this.bufferLength&&this.availableOrderData.push(t)}destroy(){this._destroyed=!0,this.pendingSorted=null,this.worker.terminate(),this.worker=null}setCenters(t,e){if(e){if(!this.centersSet.has(t)){this.centersSet.add(t);const s=e.buffer.slice();this.worker.postMessage({command:"addCenters",id:t,centers:s},[s])}}else this.centersSet.has(t)&&(this.centersSet.delete(t),this.worker.postMessage({command:"removeCenters",id:t}))}updateCentersForSplats(t){for(const e of t){const t=e.resource.id;Sv.add(t),this.centersSet.has(t)||this.setCenters(t,e.resource.centers)}for(const t of this.centersSet)Sv.has(t)||this.setCenters(t,null);Sv.clear()}setSortParameters(t){this.hasNewVersion=!0;const{textureSize:e}=t,s=e*e;s!==this.bufferLength&&(this.bufferLength=s,this.availableOrderData.length=0),this.worker.postMessage(t)}setSortParams(t,e){if(this.hasNewVersion||0===this.jobsInFlight){let s=this.availableOrderData.pop();s||(s=new Uint32Array(this.bufferLength)),this.jobsInFlight++,this.hasNewVersion=!1,this.worker.postMessage({command:"sort",sortParams:t,radialSorting:e,order:s.buffer},[s.buffer])}}}class wv{constructor(t,e,s,n,i){this.instanceIndices=null,this.instanceIndicesCount=0,this.viewportParams=[0,0],this.originalBlendType=1,this.device=t,this.node=e,this.cameraNode=s,this.layer=n,this.workBuffer=i,this._material=new Ju({uniqueName:"UnifiedSplatMaterial",vertexGLSL:'#include "gsplatVS"',fragmentGLSL:'#include "gsplatPS"',vertexWGSL:'#include "gsplatVS"',fragmentWGSL:'#include "gsplatPS"',attributes:{vertex_position:Ys,vertex_id_attrib:gn}}),this.configureMaterial(),this.meshInstance=this.createMeshInstance(),n.addMeshInstances([this.meshInstance])}destroy(){this.layer.removeMeshInstances([this.meshInstance]),this._material.destroy(),this.meshInstance.destroy()}get material(){return this._material}configureMaterial(){const{device:t,workBuffer:e}=this;this._material.setDefine("GSPLAT_WORKBUFFER_DATA",!0),this._material.setDefine("STORAGE_ORDER",t.isWebGPU);const s=e.colorTextureFormat===Vs;this._material.setDefine("GSPLAT_COLOR_UINT",s),this._material.setParameter("splatColor",e.colorTexture),this._material.setParameter("splatTexture0",e.splatTexture0),this._material.setParameter("splatTexture1",e.splatTexture1),this._material.setDefine("SH_BANDS","0"),this._material.setParameter("numSplats",0),e.orderTexture&&this._material.setParameter("splatOrder",e.orderTexture),this._material.setParameter("alphaClip",.3),this._material.setDefine("DITHER_NONE",""),this._material.cull=0,this._material.blendType=4,this._material.depthWrite=!1,this._material.update()}update(t,e){this.meshInstance.instancingCount=Math.ceil(t/Xp.instanceSize),this._material.setParameter("numSplats",t),this._material.setParameter("splatTextureSize",e),this.meshInstance.visible=t>0}frameUpdate(t){this.device.isWebGPU?this._material.setParameter("splatOrder",this.workBuffer.orderBuffer):this._material.setParameter("splatOrder",this.workBuffer.orderTexture),t.colorRamp&&this._material.setParameter("colorRampIntensity",t.colorRampIntensity)}updateOverdrawMode(t){const e=!!t.colorRamp,s=this._material.getDefine("GSPLAT_OVERDRAW");e&&(this._material.setParameter("colorRamp",t.colorRamp),this._material.setParameter("colorRampIntensity",t.colorRampIntensity)),e!==s&&(this._material.setDefine("GSPLAT_OVERDRAW",e),e?(this.originalBlendType=this._material.blendType,this._material.blendType=1):this._material.blendType=this.originalBlendType,this._material.update())}setMaxNumSplats(t){const e=Qe.roundUp(t,Xp.instanceSize);this.instanceIndicesCount<e&&(this.instanceIndicesCount=e,this.instanceIndices?.destroy(),this.instanceIndices=Xp.createInstanceIndices(this.device,t),this.meshInstance.setInstancing(this.instanceIndices,!0),this._material.setParameter("splatTextureSize",this.workBuffer.textureSize))}createMeshInstance(){const t=Xp.createMesh(this.device),e=this.workBuffer.textureSize,s=Xp.createInstanceIndices(this.device,e*e),n=new fc(t,this._material);n.node=this.node,n.setInstancing(s,!0),n.instancingCount=0;const i=this.cameraNode.camera;return n.isVisibleFunc=t=>i.camera===t,n}updateViewport(t){const e=t.camera,s=e.rect,n=e?.renderTarget,{width:i,height:r}=n??this.device,a=this.viewportParams;a[0]=i*s.z,a[1]=r*s.w;const o=e?.camera?.xr;o?.active&&2===o.views.list.length&&(a[0]*=.5),this._material.setParameter("viewport",a)}}class Tv{constructor(t,e,s=0){this.intervals=new Map,this.lodIndex=0,this._lodDistances=null,this.splatBudget=0,this._aabb=new Ss,this.resource=t,this.node=e,this.lodIndex=s}set aabb(t){this._aabb.copy(t)}get aabb(){return this._aabb}set lodDistances(t){!(!this.resource||!this.resource.octree)&&(this._lodDistances=t?t.slice():null)}get lodDistances(){return this._lodDistances?this._lodDistances.slice():null}}const Cv=new ps,Ev=new rs,Av=new rs,Dv=new rs,Pv=[];new Ss;class Lv{reset(){this.currentLod=-1,this.optimalLod=-1,this.importance=0}constructor(){this.currentLod=-1,this.optimalLod=-1,this.importance=0}}class Iv{get pendingLoadCount(){let t=this.pending.size+this.prefetchPending.size;return this.octree.environmentUrl&&!this.environmentPlacement&&t++,t}constructor(t,e,s){this.activePlacements=new Set,this.dirtyModifiedPlacements=!1,this.pending=new Set,this.pendingDecrements=new Map,this.removedCandidates=new Set,this.previousPosition=new rs,this.needsLodUpdate=!1,this.prefetchPending=new Set,this.pendingVisibleAdds=new Map,this.splatBudget=0,this._nodeIndices=null,this.environmentPlacement=null,this._deviceLostEvent=null,this.device=t,this.octree=e,this.placement=s,this.nodeInfos=new Array(e.nodes.length);for(let t=0;t<e.nodes.length;t++)this.nodeInfos[t]=new Lv;const n=e.files.length;this.filePlacements=new Array(n).fill(null),e.environmentUrl&&(e.incEnvironmentRefCount(),e.ensureEnvironmentResource()),this._deviceLostEvent=t.on("devicelost",this._onDeviceLost,this)}destroy(){if(this.octree&&!this.octree.destroyed){const t=this.getFileDecrements();for(const e of t)this.octree.decRefCount(e,0);for(const t of this.pending)this.filePlacements[t]||this.octree.unloadResource(t);for(const t of this.prefetchPending)this.filePlacements[t]||this.octree.unloadResource(t);this.environmentPlacement&&this.octree.decEnvironmentRefCount()}this.pending.clear(),this.pendingDecrements.clear(),this.filePlacements.length=0,this.environmentPlacement&&(this.activePlacements.delete(this.environmentPlacement),this.environmentPlacement=null),this._deviceLostEvent?.off(),this._deviceLostEvent=null}_onDeviceLost(){for(let t=0;t<this.filePlacements.length;t++)this.filePlacements[t]&&this.octree.decRefCount(t,0);this.filePlacements.fill(null),this.activePlacements.clear(),this.pending.clear(),this.pendingDecrements.clear(),this.removedCandidates.clear(),this.prefetchPending.clear(),this.pendingVisibleAdds.clear();for(const t of this.nodeInfos)t.reset();this.environmentPlacement&&(this.activePlacements.delete(this.environmentPlacement),this.environmentPlacement=null,this.octree.unloadEnvironmentResource()),this.dirtyModifiedPlacements=!0,this.needsLodUpdate=!0}getFileDecrements(){const t=[];for(let e=0;e<this.filePlacements.length;e++)this.filePlacements[e]&&t.push(e);return t}calculateNodeLod(t,e,s,n,i,r){this.octree.nodes[s].bounds.closestPoint(t,Dv),Dv.sub(t);let a=Dv.length();if(r>1&&a>.01){const t=e.dot(Dv)/a;if(t<0){a*=1+-t*(r-1)}}for(let t=0;t<n;t++)if(a<i[t])return t;return n}selectDesiredLodIndex(t,e,s,n){if(n>0){const i=Math.min(s,e+n);for(let s=e;s<=i;s++){const e=t.lods[s].fileIndex;if(-1!==e&&this.octree.getFileResource(e))return s}for(let s=i;s>=e;s--){if(-1!==t.lods[s].fileIndex)return s}}return e}prefetchNextLod(t,e,s){if(-1===e||-1===s)return;if(e===s){const e=t.lods[s].fileIndex;return void(-1!==e&&(this.octree.ensureFileResource(e),this.octree.getFileResource(e)||this.prefetchPending.add(e)))}for(let n=Math.max(s,e-1);n>=s;n--){const e=t.lods[n].fileIndex;if(-1!==e){this.octree.ensureFileResource(e),this.octree.getFileResource(e)||this.prefetchPending.add(e);break}}}updateLod(t,e){const s=this.octree.lodLevels-1,n=this.placement.lodDistances||[5,10,15,20,25,30,35,40,45,50,55,60],{lodRangeMin:i,lodRangeMax:r}=e,a=Math.max(0,Math.min(i??0,s)),o=Math.max(a,Math.min(r??s,s)),l=this.evaluateNodeLods(t,s,n,a,o,e);this.splatBudget>0&&this.enforceSplatBudget(l,this.splatBudget,a,o),this.applyLodChanges(s,e)}evaluateNodeLods(t,e,s,n,i,r){const{lodBehindPenalty:a}=r,o=t.getPosition(),l=this.placement.node.getWorldTransform();Cv.copy(l).invert();const h=Cv.transformPoint(o,Ev),c=t.forward,d=Cv.transformVector(c,Av).normalize(),u=this.octree.nodes,f=this.nodeInfos;let p=0;const m=s[i]||100;for(let t=0;t<u.length;t++){u[t].bounds.closestPoint(h,Dv),Dv.sub(h);const r=Dv.length();let o=r,l=1;if(a>1&&r>.01){const t=d.dot(Dv)/r;if(t<0){const e=1+-t*(a-1);o=r*e,l=1/e}}let c=e;for(let t=0;t<e;t++)if(o<s[t]){c=t;break}c<n&&(c=n),c>i&&(c=i);const g=(1-Math.min(r/m,1))*l;f[t].optimalLod=c,f[t].importance=g;const _=u[t].lods[c];_&&_.count&&(p+=_.count)}return p}enforceSplatBudget(t,e,s,n){const i=this.octree.nodes,r=this.nodeInfos;if(!this._nodeIndices){this._nodeIndices=new Uint32Array(i.length);for(let t=0;t<i.length;t++)this._nodeIndices[t]=t}const a=this._nodeIndices;a.sort((t,e)=>r[t].importance-r[e].importance);let o=t;if(o===e)return;const l=o>e,h=l?1:-1;for(;l?o>e:o<e;){let t=!1;if(l)for(let s=0;s<a.length;s++){const l=a[s],c=r[l],d=i[l],u=c.optimalLod;if(u<n){const s=d.lods[u],n=d.lods[u+1],i=s.count-n.count;if(c.optimalLod+=h,o-=i,t=!0,o<=e)break}}else for(let n=a.length-1;n>=0;n--){const l=a[n],c=r[l],d=i[l],u=c.optimalLod;if(u>s){const s=d.lods[u],n=d.lods[u-1].count-s.count;if(o+n<=e&&(c.optimalLod+=h,o+=n,t=!0,o>=e))break}}if(!t)break}}applyLodChanges(t,e){const s=this.octree.nodes,{lodUnderfillLimit:n=0}=e;for(let e=0;e<s.length;e++){const i=s[e],r=this.nodeInfos[e],a=r.optimalLod,o=r.currentLod,l=this.selectDesiredLodIndex(i,a,t,n);if(l!==o){const t=o>=0?i.lods[o].fileIndex:-1,s=l>=0?i.lods[l].fileIndex:-1,n=-1!==t,a=-1!==s,h=this.pendingDecrements.get(e);if(h&&h.newFileIndex!==s){this.filePlacements[h.newFileIndex]&&this.decrementFileRef(h.newFileIndex,e),n&&a?this.pendingDecrements.set(e,{oldFileIndex:h.oldFileIndex,newFileIndex:s}):this.pendingDecrements.delete(e)}if(!n&&a){const t=this.pendingVisibleAdds.get(e);void 0!==t&&t!==s&&(this.decrementFileRef(t,e),this.pendingVisibleAdds.delete(e)),this.incrementFileRef(s,e,l);const n=this.filePlacements[s];n?.resource?(r.currentLod=l,this.pendingVisibleAdds.delete(e)):this.pendingVisibleAdds.set(e,s)}else if(n&&!a){const s=this.pendingDecrements.get(e);s&&(this.decrementFileRef(s.newFileIndex,e),this.pendingDecrements.delete(e)),this.decrementFileRef(t,e),r.currentLod=-1,this.pendingVisibleAdds.delete(e)}else if(n&&a){this.incrementFileRef(s,e,l);const n=this.filePlacements[s];n?.resource?(this.decrementFileRef(t,e),this.pendingDecrements.delete(e),r.currentLod=l,this.pendingVisibleAdds.delete(e)):(this.pendingDecrements.set(e,{oldFileIndex:t,newFileIndex:s}),this.pendingVisibleAdds.delete(e))}}this.prefetchNextLod(i,l,a)}}incrementFileRef(t,e,s){if(-1===t)return;let n=this.filePlacements[t];if(!n){n=new Tv(null,this.placement.node,s),this.filePlacements[t]=n;this.removedCandidates.delete(t)||this.octree.incRefCount(t),this.addFilePlacement(t)||(this.octree.ensureFileResource(t),this.pending.add(t))}const i=this.octree.nodes[e].lods[s],r=new os(i.offset,i.offset+i.count-1);n.intervals.set(e,r),this.dirtyModifiedPlacements=!0}decrementFileRef(t,e){if(-1===t)return;const s=this.filePlacements[t];s&&s&&(s.intervals.delete(e),this.dirtyModifiedPlacements=!0,0===s.intervals.size&&(s.resource&&this.activePlacements.delete(s),this.removedCandidates.add(t),this.filePlacements[t]=null,this.pending.delete(t)))}addFilePlacement(t){const e=this.octree.getFileResource(t);if(e){const s=this.filePlacements[t];if(s)return s.resource=e,s.aabb.copy(e.aabb),this.activePlacements.add(s),this.dirtyModifiedPlacements=!0,this.removedCandidates.delete(t),!0}return!1}testMoved(t){return this.placement.node.getPosition().distance(this.previousPosition)>t}updateMoved(){this.previousPosition.copy(this.placement.node.getPosition())}update(t){const e=this.placement.splatBudget;if(e!==this.splatBudget&&(this.splatBudget=e,this.needsLodUpdate=!0),this.pending.size){for(const t of this.pending)if(this.octree.ensureFileResource(t),this.addFilePlacement(t)){Pv.push(t);for(const[e,{oldFileIndex:s,newFileIndex:n}]of this.pendingDecrements)if(n===t){this.decrementFileRef(s,e),this.pendingDecrements.delete(e);let t=0;const i=this.octree.nodes[e].lods;for(let e=0;e<i.length;e++)if(i[e].fileIndex===n){t=e;break}this.nodeInfos[e].currentLod=t}}Pv.length>0&&(this.needsLodUpdate=!0);for(const t of Pv)this.pending.delete(t);Pv.length=0}if(this.pollPrefetchCompletions(),this.octree.environmentUrl&&!this.environmentPlacement){this.octree.ensureEnvironmentResource();const t=this.octree.environmentResource;t&&(this.environmentPlacement=new Tv(t,this.placement.node,0),this.environmentPlacement.aabb.copy(t.aabb),this.activePlacements.add(this.environmentPlacement),this.dirtyModifiedPlacements=!0)}const s=this.dirtyModifiedPlacements;return this.dirtyModifiedPlacements=!1,s}debugRender(t){}consumeNeedsLodUpdate(){const t=this.needsLodUpdate;return this.needsLodUpdate=!1,t}pollPrefetchCompletions(){if(this.prefetchPending.size){for(const t of this.prefetchPending)this.octree.ensureFileResource(t),this.octree.getFileResource(t)&&Pv.push(t);Pv.length>0&&(this.needsLodUpdate=!0);for(const t of Pv)this.prefetchPending.delete(t);Pv.length=0}}}const Rv=new rs,Mv=new rs;class kv{constructor(t,e){this.bounds=new Ss,this.lods=t,Rv.set(e.min[0],e.min[1],e.min[2]),Mv.set(e.max[0],e.max[1],e.max[2]),this.bounds.setMinMax(Rv,Mv)}}const Ov=[];class Fv{constructor(t,e){this.fileResources=new Map,this.cooldowns=new Map,this.environmentUrl=null,this.environmentResource=null,this.environmentRefCount=0,this.assetLoader=null,this.destroyed=!1,this.cooldownTicks=100,this.lodLevels=e.lodLevels,this.assetFileUrl=t;const s=Me.getDirectory(t);this.files=e.filenames.map(t=>({url:Me.isRelativePath(t)?Me.join(s,t):t,lodLevel:-1})),this.fileRefCounts=new Int32Array(this.files.length),e.environment&&(this.environmentUrl=Me.isRelativePath(e.environment)?Me.join(s,e.environment):e.environment);const n=[];this._extractLeafNodes(e.tree,n),this.nodes=n.map(t=>{const e=[];for(let s=0;s<this.lodLevels;s++){const n=t.lods[s.toString()];n?(e.push({file:this.files[n.file].url||"",fileIndex:n.file,offset:n.offset||0,count:n.count||0}),this.files[n.file].lodLevel=s):e.push({file:"",fileIndex:-1,offset:0,count:0})}return new kv(e,t.bound)})}destroy(){this.destroyed=!0,this.fileResources.clear(),this.cooldowns.clear(),this.assetLoader?.destroy(),this.assetLoader=null,this.environmentResource=null}_traceLodCounts(){}_extractLeafNodes(t,e){if(t.lods)e.push({lods:t.lods,bound:t.bound});else if(t.children)for(const s of t.children)this._extractLeafNodes(s,e)}getFileResource(t){return this.fileResources.get(t)}incRefCount(t){const e=this.fileRefCounts[t]+1;this.fileRefCounts[t]=e,this.cooldowns.delete(t)}decRefCount(t,e){const s=this.fileRefCounts[t]-1;this.fileRefCounts[t]=s,0===s&&(0===e?this.unloadResource(t):this.cooldowns.set(t,e))}unloadResource(t){if(!this.assetLoader)return;const e=this.files[t].url;this.assetLoader.unload(e),this.fileResources.has(t)&&(this.fileResources.delete(t),this._traceLodCounts())}updateCooldownTick(t){this.cooldownTicks=t,this.cooldowns.size>0&&(this.cooldowns.forEach((t,e)=>{t<=1?(0===this.fileRefCounts[e]&&this.unloadResource(e),Ov.push(e)):this.cooldowns.set(e,t-1)}),Ov.forEach(t=>this.cooldowns.delete(t)),Ov.length=0)}ensureFileResource(t){if(this.fileResources.has(t))return;const e=this.files[t].url,s=this.assetLoader?.getResource(e);if(s)return this.fileResources.set(t,s),0===this.fileRefCounts[t]&&this.cooldowns.set(t,this.cooldownTicks),void this._traceLodCounts();this.assetLoader?.load(e)}incEnvironmentRefCount(){this.environmentRefCount++}decEnvironmentRefCount(){this.environmentRefCount--,0===this.environmentRefCount&&this.unloadEnvironmentResource()}ensureEnvironmentResource(){if(!this.assetLoader)return;if(!this.environmentUrl)return;if(this.environmentResource)return;const t=this.assetLoader.getResource(this.environmentUrl);if(t)return this.environmentResource=t,void(0===this.environmentRefCount&&this.unloadEnvironmentResource());this.assetLoader.load(this.environmentUrl)}unloadEnvironmentResource(){this.assetLoader&&this.environmentResource&&this.environmentUrl&&(this.assetLoader.unload(this.environmentUrl),this.environmentResource=null)}}class Nv{constructor(t,e,s){this.aabb=new Ss,this.octree=new Fv(t,e),this.octree.assetLoader=s,this.aabb.setMinMax(new rs(e.tree.bound.min),new rs(e.tree.bound.max))}destroy(){this.octree?.destroy(),this.octree=null}}class Bv{constructor(t,e,s){this.version=0,this.sortParametersSet=!1,this.sortedBefore=!1,this.splats=[],this.textureSize=0,this.totalUsedPixels=0,this.pendingReleases=[],this.version=e,this.splats=s,this.estimateTextureSize(this.splats,t.maxTextureSize),this.assignLines(this.splats,this.textureSize)}estimateTextureSize(t,e){const s=e=>{let s=0;for(const n of t)if(s+=Math.ceil(n.activeSplats/e),s>e)return!1;return!0};let n=1,i=e,r=null;for(;n<=i;){const t=Math.floor((n+i)/2);s(t)?(r=t,i=t-1):n=t+1}return null===r?(this.textureSize=0,!1):(this.textureSize=r,!0)}destroy(){this.splats.forEach(t=>t.destroy()),this.splats.length=0}assignLines(t,e){if(0===t.length)return void(this.totalUsedPixels=0);let s=0;for(const n of t){const t=n.activeSplats,i=Math.ceil(t/e);n.setLines(s,i,e,t),s+=i}this.totalUsedPixels=s*e}}const zv=new rs,Uv=new rs,Vv=new rs,Hv=new ps,Gv=new Set,Wv=new Set,jv=[],$v=[],Xv={rotationDelta:0,translationDelta:0},qv=new Set,Kv=[[1,0,0],[0,1,0],[0,0,1],[1,1,0],[1,0,1],[0,1,1],[1,.5,0],[.5,0,1]];let Yv=null;class Qv{constructor(t,e,s,n){this.node=new Hc("GSplatManager"),this.worldStates=new Map,this.lastWorldStateVersion=0,this.sortedVersion=0,this.framesTillFullUpdate=0,this.lastLodCameraPos=new rs(1/0,1/0,1/0),this.lastLodCameraFwd=new rs(1/0,1/0,1/0),this.lastSortCameraPos=new rs(1/0,1/0,1/0),this.lastSortCameraFwd=new rs(1/0,1/0,1/0),this.sortNeeded=!0,this.lastColorUpdateCameraPos=new rs(1/0,1/0,1/0),this.lastColorUpdateCameraFwd=new rs(1/0,1/0,1/0),this.layerPlacements=[],this.layerPlacementsDirty=!1,this.octreeInstances=new Map,this.octreeInstancesToDestroy=[],this.hasNewOctreeInstances=!1,this.device=t,this.scene=e.scene,this.director=e,this.cameraNode=n,this.workBuffer=new Wp(t),this.renderer=new wv(t,this.node,this.cameraNode,s,this.workBuffer),this.sorter=this.createSorter()}destroy(){this._destroyed=!0;for(const[,t]of this.worldStates){for(const e of t.splats)e.resource.decRefCount();t.destroy()}this.worldStates.clear();for(const[,t]of this.octreeInstances)t.destroy();this.octreeInstances.clear();for(const t of this.octreeInstancesToDestroy)t.destroy();this.octreeInstancesToDestroy.length=0,this.workBuffer.destroy(),this.renderer.destroy(),this.sorter.destroy()}get material(){return this.renderer.material}createSorter(){const t=new xv;return t.on("sorted",(t,e,s)=>{this.onSorted(t,e,s)}),t}reconcile(t){Gv.clear();for(const e of t)e.resource instanceof Nv?(this.octreeInstances.has(e)||(this.octreeInstances.set(e,new Iv(this.device,e.resource.octree,e)),this.hasNewOctreeInstances=!0),Wv.add(e)):Gv.add(e);for(const[t,e]of this.octreeInstances)Wv.has(t)||(this.octreeInstances.delete(t),this.layerPlacementsDirty=!0,this.octreeInstancesToDestroy.push(e));if(this.layerPlacementsDirty=this.layerPlacements.length!==Gv.size,!this.layerPlacementsDirty)for(let t=0;t<this.layerPlacements.length;t++){const e=this.layerPlacements[t];if(!Gv.has(e)){this.layerPlacementsDirty=!0;break}}this.layerPlacements.length=0;for(const t of Gv)this.layerPlacements.push(t);Gv.clear(),Wv.clear()}updateWorldState(){if(this.layerPlacementsDirty||0===this.worldStates.size){this.lastWorldStateVersion++;const t=[],{colorUpdateAngle:e,colorUpdateDistance:s}=this.scene.gsplat;for(const n of this.layerPlacements){const i=new yv(this.device,n.resource,n);i.resetColorAccumulators(e,s),t.push(i)}for(const[,n]of this.octreeInstances)n.activePlacements.forEach(n=>{if(n.resource){const i=new yv(this.device,n.resource,n);i.resetColorAccumulators(e,s),t.push(i)}});this.sorter.updateCentersForSplats(t);const n=new Bv(this.device,this.lastWorldStateVersion,t);for(const t of n.splats)t.resource.incRefCount();for(const[,t]of this.octreeInstances)if(t.removedCandidates&&t.removedCandidates.size){for(const e of t.removedCandidates)n.pendingReleases.push([t.octree,e]);t.removedCandidates.clear()}if(this.octreeInstancesToDestroy.length){for(const t of this.octreeInstancesToDestroy){const e=t.getFileDecrements();for(const s of e)n.pendingReleases.push([t.octree,s]);t.destroy()}this.octreeInstancesToDestroy.length=0}this.worldStates.set(this.lastWorldStateVersion,n),this.layerPlacementsDirty=!1,this.sortNeeded=!0}}onSorted(t,e,s){for(let t=this.sortedVersion;t<e;t++){const e=this.worldStates.get(t);if(e){for(const t of e.splats)t.resource.decRefCount();this.worldStates.delete(t),e.destroy()}}this.sortedVersion=e;const n=this.worldStates.get(e);if(n){if(!n.sortedBefore){n.sortedBefore=!0;const e=n.textureSize;e!==this.workBuffer.textureSize&&(this.workBuffer.resize(e),this.renderer.setMaxNumSplats(e*e)),this.workBuffer.render(n.splats,this.cameraNode,this.getDebugColors());const{colorUpdateAngle:s,colorUpdateDistance:i}=this.scene.gsplat;if(n.splats.forEach(t=>{t.update(),t.resetColorAccumulators(s,i)}),this.updateColorCameraTracking(),n.pendingReleases&&n.pendingReleases.length){const t=this.scene.gsplat.cooldownTicks;for(const[e,s]of n.pendingReleases)e.decRefCount(s,t);n.pendingReleases.length=0}this.renderer.update(t,e)}this.workBuffer.setOrderData(s),this.renderer.frameUpdate(this.scene.gsplat)}}testCameraMovedForLod(){const t=this.scene.gsplat.lodUpdateDistance,e=this.cameraNode.getPosition(),s=this.lastLodCameraPos.distance(e)>t;if(s)return!0;let n=!1;const i=this.scene.gsplat.lodUpdateAngle;if(i>0)if(Number.isFinite(this.lastLodCameraFwd.x)){const t=this.cameraNode.forward,e=Math.min(1,Math.max(-1,this.lastLodCameraFwd.dot(t)));n=Math.acos(e)>i*Qe.DEG_TO_RAD}else n=!0;return s||n}testCameraMovedForSort(){if(this.scene.gsplat.radialSorting){const t=this.cameraNode.getPosition();return this.lastSortCameraPos.distance(t)>.001}if(Number.isFinite(this.lastSortCameraFwd.x)){const t=this.cameraNode.forward,e=Math.min(1,Math.max(-1,this.lastSortCameraFwd.dot(t)));return Math.acos(e)>.001}return!0}updateColorCameraTracking(){this.lastColorUpdateCameraPos.copy(this.cameraNode.getPosition()),this.lastColorUpdateCameraFwd.copy(this.cameraNode.forward)}getDebugColors(){if(this.scene.gsplat.colorizeColorUpdate){Yv??=[];const t=Math.random(),e=Math.random(),s=Math.random();for(let n=0;n<Kv.length;n++)Yv[n]??=[0,0,0],Yv[n][0]=t,Yv[n][1]=e,Yv[n][2]=s;return Yv}if(this.scene.gsplat.colorizeLod)return Kv}calculateColorCameraDeltas(){if(Xv.rotationDelta=0,Xv.translationDelta=0,isFinite(this.lastColorUpdateCameraPos.x)){const t=this.cameraNode.forward,e=Math.min(1,Math.max(-1,this.lastColorUpdateCameraFwd.dot(t)));Xv.rotationDelta=Math.acos(e)*Qe.RAD_TO_DEG;const s=this.cameraNode.getPosition();Xv.translationDelta=this.lastColorUpdateCameraPos.distance(s)}return Xv}fireFrameReadyEvent(){const t=this.sortedVersion===this.lastWorldStateVersion;let e=0;for(const[,t]of this.octreeInstances)e+=t.pendingLoadCount;this.director.eventHandler.fire("frame:ready",this.cameraNode.camera,this.renderer.layer,t,e)}update(){this.sorter.applyPendingSorted(),this.renderer.updateViewport(this.cameraNode);let t=!1;this.framesTillFullUpdate--,this.framesTillFullUpdate<=0&&(this.framesTillFullUpdate=10,this.sorter.jobsInFlight<3&&(t=!0));const e=this.hasNewOctreeInstances&&this.sorter.jobsInFlight<3;e&&(this.hasNewOctreeInstances=!1);let s=!1,n=!1,i=!1;if(t){for(const[,t]of this.octreeInstances){const e=t.update(this.scene);this.layerPlacementsDirty||=e;const n=t.consumeNeedsLodUpdate();s||=n}const t=this.scene.gsplat.lodUpdateDistance;for(const[,e]of this.octreeInstances){const s=e.testMoved(t);n||=s}i=this.testCameraMovedForLod()}if(this.testCameraMovedForSort()&&(this.sortNeeded=!0),this.scene.gsplat.dirty&&(this.layerPlacementsDirty=!0,this.renderer.updateOverdrawMode(this.scene.gsplat)),i||n||this.scene.gsplat.dirty||s||e){for(const[,t]of this.octreeInstances)t.updateMoved();this.lastLodCameraPos.copy(this.cameraNode.getPosition()),this.lastLodCameraFwd.copy(this.cameraNode.forward);for(const[,t]of this.octreeInstances)t.updateLod(this.cameraNode,this.scene.gsplat)}this.updateWorldState();const r=this.worldStates.get(this.lastWorldStateVersion);if(r){if(!r.sortParametersSet){r.sortParametersSet=!0;const t=this.prepareSortParameters(r);this.sorter.setSortParameters(t)}this.sortNeeded&&(this.sort(r),this.sortNeeded=!1,this.lastSortCameraPos.copy(this.cameraNode.getPosition()),this.lastSortCameraFwd.copy(this.cameraNode.forward))}const a=this.worldStates.get(this.sortedVersion);if(a){const{colorUpdateAngle:t,colorUpdateDistance:e,colorUpdateDistanceLodScale:s,colorUpdateAngleLodScale:n}=this.scene.gsplat,{rotationDelta:i,translationDelta:r}=this.calculateColorCameraDeltas();a.splats.forEach(a=>{if(a.update())jv.push(a),a.resetColorAccumulators(t,e),this.sortNeeded=!0;else if(a.hasSphericalHarmonics){a.colorAccumulatedRotation+=i,a.colorAccumulatedTranslation+=r;const o=a.lodIndex??0,l=e*Math.pow(s,o),h=t*Math.pow(n,o);(a.colorAccumulatedRotation>=h||a.colorAccumulatedTranslation>=l)&&($v.push(a),a.resetColorAccumulators(h,l))}}),jv.length>0&&(this.workBuffer.render(jv,this.cameraNode,this.getDebugColors()),jv.length=0),$v.length>0&&(this.workBuffer.renderColor($v,this.cameraNode,this.getDebugColors()),$v.length=0),this.updateColorCameraTracking()}if(this.octreeInstances.size){const t=this.scene.gsplat.cooldownTicks;for(const[,e]of this.octreeInstances){const s=e.octree;qv.has(s)||(qv.add(s),s.updateCooldownTick(t))}qv.clear()}this.fireFrameReadyEvent();const{textureSize:o}=this.workBuffer;return o*o}sort(t){const e=this.cameraNode.getWorldTransform();e.getTranslation(zv),e.getZ(Uv).normalize();const s=[];t.splats.forEach(t=>{const e=t.node.getWorldTransform();Hv.copy(e).invert();const n=e.getScale().x,i=Hv.transformVector(Uv).normalize(),r=Hv.transformPoint(zv);e.getTranslation(Vv);const a=Vv.sub(zv).dot(Uv),o=t.aabb.getMin(),l=t.aabb.getMax();s.push({transformedDirection:i,transformedPosition:r,offset:a,scale:n,modelMat:e.data.slice(),aabbMin:[o.x,o.y,o.z],aabbMax:[l.x,l.y,l.z]})}),this.sorter.setSortParams(s,this.scene.gsplat.radialSorting)}prepareSortParameters(t){return{command:"intervals",textureSize:t.textureSize,totalUsedPixels:t.totalUsedPixels,version:t.version,ids:t.splats.map(t=>t.resource.id),lineStarts:t.splats.map(t=>t.lineStart),padding:t.splats.map(t=>t.padding),intervals:t.splats.map(t=>t.intervals)}}}const Zv=[];class Jv{constructor(t,e,s,n){this.gsplatManager=new Qv(t,e,s,n)}destroy(){this.gsplatManager.destroy()}}class ty{destroy(){this.layersMap.forEach(t=>t.destroy()),this.layersMap.clear()}removeLayerData(t){const e=this.layersMap.get(t);e&&(e.destroy(),this.layersMap.delete(t))}getLayerData(t,e,s,n){let i=this.layersMap.get(s);if(!i){i=new Jv(t,e,s,n),this.layersMap.set(s,i);const r=i.gsplatManager.material;r&&e.eventHandler&&e.eventHandler.fire("material:created",r,n.camera,s)}return i}constructor(){this.layersMap=new Map}}class ey{constructor(t,e,s,n){this.camerasMap=new Map,this.device=t,this.renderer=e,this.scene=s,this.eventHandler=n}destroy(){this.camerasMap.forEach(t=>t.destroy()),this.camerasMap.clear()}getCameraData(t){let e=this.camerasMap.get(t);return e||(e=new ty,this.camerasMap.set(t,e)),e}update(t){this.camerasMap.forEach((e,s)=>{if(t.camerasSet.has(s)){e.layersMap.forEach((t,e)=>{s.layersSet.has(e.id)&&e.enabled||Zv.push(e)});for(let t=0;t<Zv.length;t++){const s=Zv[t],n=e.layersMap.get(s);n&&(n.destroy(),e.layersMap.delete(s))}Zv.length=0}else e.destroy(),this.camerasMap.delete(s)});let e=0;const s=t.cameras;for(let n=0;n<s.length;n++){const i=s[n].camera;let r=this.camerasMap.get(i);const a=i.layers;for(let e=0;e<a.length;e++){const s=t.getLayerById(a[e]);if(s?.enabled&&(s.gsplatPlacementsDirty||!r)){const t=s.gsplatPlacements;if(0===t.length)r&&r.removeLayerData(s);else{r??=this.getCameraData(i);r.getLayerData(this.device,this,s,i.node).gsplatManager.reconcile(t)}}}if(r)for(const t of r.layersMap.values())e+=t.gsplatManager.update()}this.renderer._gsplatCount=e,this.scene.gsplat.dirty=!1;for(let e=0;e<t.layerList.length;e++)t.layerList[e].gsplatPlacementsDirty=!1}}class sy extends xg{constructor(t,e){super(t,e),this._layers=[0],this._instance=null,this._placement=null,this._materialTmp=null,this._highQualitySH=!0,this._lodDistances=[5,10,15,20,25,30,35,40,45,50,55,60],this._splatBudget=0,this._customAabb=null,this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._castShadows=!1,this._unified=!1,this._assetReference=new S_("asset",this,t.app.assets,{add:this._onGSplatAssetAdded,load:this._onGSplatAssetLoad,remove:this._onGSplatAssetRemove,unload:this._onGSplatAssetUnload},this),e.on("remove",this.onRemoveChild,this),e.on("removehierarchy",this.onRemoveChild,this),e.on("insert",this.onInsertChild,this),e.on("inserthierarchy",this.onInsertChild,this)}set customAabb(t){this._customAabb=t,this._instance?.meshInstance?.setCustomAabb(this._customAabb),this._placement&&this._customAabb&&(this._placement.aabb=this._customAabb)}get customAabb(){return this._customAabb}set instance(t){if(this.destroyInstance(),this._instance=t,this._instance){const t=this._instance.meshInstance;t.node||(t.node=this.entity),t.castShadow=this._castShadows,t.setCustomAabb(this._customAabb),this.enabled&&this.entity.enabled&&this.addToLayers()}}get instance(){return this._instance}set material(t){this.unified||(this._instance?this._instance.material=t:this._materialTmp=t)}get material(){return this.unified?null:this._instance?.material??this._materialTmp??null}set highQualitySH(t){t!==this._highQualitySH&&(this._highQualitySH=t,this._instance?.setHighQualitySH(t))}get highQualitySH(){return this._highQualitySH}set castShadows(t){if(this._castShadows!==t){const e=this.instance?.meshInstance;if(e){const s=this.layers,n=this.system.app.scene;if(this._castShadows&&!t)for(let t=0;t<s.length;t++){const s=n.layers.getLayerById(this.layers[t]);s&&s.removeShadowCasters([e])}if(e.castShadow=t,!this._castShadows&&t)for(let t=0;t<s.length;t++){const i=n.layers.getLayerById(s[t]);i&&i.addShadowCasters([e])}}this._castShadows=t}}get castShadows(){return this._castShadows}set lodDistances(t){this._lodDistances=Array.isArray(t)?t.slice():null,this._placement&&(this._placement.lodDistances=this._lodDistances)}get lodDistances(){return this._lodDistances?this._lodDistances.slice():null}set splatBudget(t){this._splatBudget=t,this._placement&&(this._placement.splatBudget=this._splatBudget)}get splatBudget(){return this._splatBudget}set unified(t){this.enabled&&this.entity.enabled||(this._unified=t,this._onGSplatAssetAdded())}get unified(){return this._unified}set layers(t){this.removeFromLayers(),this._layers.length=0;for(let e=0;e<t.length;e++)this._layers[e]=t[e];this.enabled&&this.entity.enabled&&this.addToLayers()}get layers(){return this._layers}set asset(t){const e=t instanceof Fm?t.id:t;this._assetReference.id!==e&&(this._assetReference.asset&&this._assetReference.asset.resource&&this._onGSplatAssetRemove(),this._assetReference.id=e,this._assetReference.asset&&this._onGSplatAssetAdded())}get asset(){return this._assetReference.id}destroyInstance(){this._placement&&(this.removeFromLayers(),this._placement=null),this._instance&&(this.removeFromLayers(),this._instance?.destroy(),this._instance=null)}addToLayers(){if(this._placement){const t=this.system.app.scene.layers;for(let e=0;e<this._layers.length;e++)t.getLayerById(this._layers[e])?.addGSplatPlacement(this._placement);return}const t=this.instance?.meshInstance;if(t){const e=this.system.app.scene.layers;for(let s=0;s<this._layers.length;s++)e.getLayerById(this._layers[s])?.addMeshInstances([t])}}removeFromLayers(){if(this._placement){const t=this.system.app.scene.layers;for(let e=0;e<this._layers.length;e++)t.getLayerById(this._layers[e])?.removeGSplatPlacement(this._placement);return}const t=this.instance?.meshInstance;if(t){const e=this.system.app.scene.layers;for(let s=0;s<this._layers.length;s++)e.getLayerById(this._layers[s])?.removeMeshInstances([t])}}onRemoveChild(){this.removeFromLayers()}onInsertChild(){this.enabled&&this.entity.enabled&&(this._instance||this._placement)&&this.addToLayers()}onRemove(){this.destroyInstance(),this.asset=null,this._assetReference.id=null,this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this)}onLayersChanged(t,e){this.addToLayers(),t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this)}onLayerAdded(t){this.layers.indexOf(t.id)<0||this._instance&&t.addMeshInstances(this._instance.meshInstance)}onLayerRemoved(t){this.layers.indexOf(t.id)<0||this._instance&&t.removeMeshInstances(this._instance.meshInstance)}onEnable(){const t=this.system.app.scene,e=t.layers;this._evtLayersChanged=t.on("set:layers",this.onLayersChanged,this),e&&(this._evtLayerAdded=e.on("add",this.onLayerAdded,this),this._evtLayerRemoved=e.on("remove",this.onLayerRemoved,this)),this._instance||this._placement?this.addToLayers():this.asset&&this._onGSplatAssetAdded()}onDisable(){const t=this.system.app.scene.layers;this._evtLayersChanged?.off(),this._evtLayersChanged=null,t&&(this._evtLayerAdded?.off(),this._evtLayerAdded=null,this._evtLayerRemoved?.off(),this._evtLayerRemoved=null),this.removeFromLayers()}hide(){this._instance&&(this._instance.meshInstance.visible=!1)}show(){this._instance&&(this._instance.meshInstance.visible=!0)}_onGSplatAssetAdded(){this._assetReference.asset&&(this._assetReference.asset.resource?this._onGSplatAssetLoad():this.enabled&&this.entity.enabled&&this.system.app.assets.load(this._assetReference.asset))}_onGSplatAssetLoad(){this.destroyInstance();const t=this._assetReference.asset;this.unified?(this._placement=null,t&&(this._placement=new Tv(t.resource,this.entity),this._placement.lodDistances=this._lodDistances,this._placement.splatBudget=this._splatBudget,this.enabled&&this.entity.enabled&&this.addToLayers())):t&&(this.instance=new um(t.resource,{material:this._materialTmp,highQualitySH:this._highQualitySH}),this._materialTmp=null),t&&(this.customAabb=t.resource.aabb.clone())}_onGSplatAssetUnload(){this.destroyInstance()}_onGSplatAssetRemove(){this._onGSplatAssetUnload()}}class ny{constructor(){this.enabled=!0}}const iy={gsplatCenterVS:"\nuniform mat4 matrix_model;\nuniform mat4 matrix_view;\n#ifndef GSPLAT_CENTER_NOPROJ\n\tuniform mat4 matrix_projection;\n#endif\nbool initCenter(vec3 modelCenter, inout SplatCenter center) {\n\tmat4 modelView = matrix_view * matrix_model;\n\tvec4 centerView = modelView * vec4(modelCenter, 1.0);\n\t#ifndef GSPLAT_CENTER_NOPROJ\n\t\tif (centerView.z > 0.0) {\n\t\t\treturn false;\n\t\t}\n\t\tvec4 centerProj = matrix_projection * centerView;\n\t\t#if WEBGPU\n\t\t\tcenterProj.z = clamp(centerProj.z, 0, abs(centerProj.w));\n\t\t#else\n\t\t\tcenterProj.z = clamp(centerProj.z, -abs(centerProj.w), abs(centerProj.w));\n\t\t#endif\n\t\tcenter.proj = centerProj;\n\t\tcenter.projMat00 = matrix_projection[0][0];\n\t#endif\n\tcenter.view = centerView.xyz / centerView.w;\n\tcenter.modelView = modelView;\n\treturn true;\n}\n",gsplatCornerVS:"\nuniform vec2 viewport;\nuniform vec4 camera_params;\nbool initCornerCov(SplatSource source, SplatCenter center, out SplatCorner corner, vec3 covA, vec3 covB) {\n\tmat3 Vrk = mat3(\n\t\tcovA.x, covA.y, covA.z, \n\t\tcovA.y, covB.x, covB.y,\n\t\tcovA.z, covB.y, covB.z\n\t);\n\tfloat focal = viewport.x * center.projMat00;\n\tvec3 v = camera_params.w == 1.0 ? vec3(0.0, 0.0, 1.0) : center.view.xyz;\n\tfloat J1 = focal / v.z;\n\tvec2 J2 = -J1 / v.z * v.xy;\n\tmat3 J = mat3(\n\t\tJ1, 0.0, J2.x, \n\t\t0.0, J1, J2.y, \n\t\t0.0, 0.0, 0.0\n\t);\n\tmat3 W = transpose(mat3(center.modelView));\n\tmat3 T = W * J;\n\tmat3 cov = transpose(T) * Vrk * T;\n\t#if GSPLAT_AA\n\t\tfloat detOrig = cov[0][0] * cov[1][1] - cov[0][1] * cov[0][1];\n\t\tfloat detBlur = (cov[0][0] + 0.3) * (cov[1][1] + 0.3) - cov[0][1] * cov[0][1];\n\t\tcorner.aaFactor = sqrt(max(detOrig / detBlur, 0.0));\n\t#endif\n\tfloat diagonal1 = cov[0][0] + 0.3;\n\tfloat offDiagonal = cov[0][1];\n\tfloat diagonal2 = cov[1][1] + 0.3;\n\tfloat mid = 0.5 * (diagonal1 + diagonal2);\n\tfloat radius = length(vec2((diagonal1 - diagonal2) / 2.0, offDiagonal));\n\tfloat lambda1 = mid + radius;\n\tfloat lambda2 = max(mid - radius, 0.1);\n\tfloat vmin = min(1024.0, min(viewport.x, viewport.y));\n\tfloat l1 = 2.0 * min(sqrt(2.0 * lambda1), vmin);\n\tfloat l2 = 2.0 * min(sqrt(2.0 * lambda2), vmin);\n\tif (l1 < 2.0 && l2 < 2.0) {\n\t\treturn false;\n\t}\n\tvec2 c = center.proj.ww / viewport;\n\tif (any(greaterThan(abs(center.proj.xy) - vec2(max(l1, l2)) * c, center.proj.ww))) {\n\t\treturn false;\n\t}\n\tvec2 diagonalVector = normalize(vec2(offDiagonal, lambda1 - diagonal1));\n\tvec2 v1 = l1 * diagonalVector;\n\tvec2 v2 = l2 * vec2(diagonalVector.y, -diagonalVector.x);\n\tcorner.offset = (source.cornerUV.x * v1 + source.cornerUV.y * v2) * c;\n\tcorner.uv = source.cornerUV;\n\treturn true;\n}\nbool initCorner(SplatSource source, SplatCenter center, out SplatCorner corner) {\n\tvec3 covA, covB;\n\treadCovariance(source, covA, covB);\n\tmodifyCovariance(center.modelCenterOriginal, center.modelCenterModified, covA, covB);\n\treturn initCornerCov(source, center, corner, covA, covB);\n}\n",gsplatColorVS:"\nuniform mediump sampler2D splatColor;\nvec4 readColor(in SplatSource source) {\n\treturn texelFetch(splatColor, source.uv, 0);\n}\n",gsplatCommonVS:'\n#include "gsplatHelpersVS"\n#include "gsplatCustomizeVS"\n#include "gsplatStructsVS"\n#include "gsplatEvalSHVS"\n#include "gsplatQuatToMat3VS"\n#include "gsplatSourceFormatVS"\n#include "gsplatSourceVS"\n#include "gsplatCenterVS"\n#include "gsplatCornerVS"\n#include "gsplatOutputVS"\nvoid clipCorner(inout SplatCorner corner, float alpha) {\n\tfloat clip = min(1.0, sqrt(-log(1.0 / (255.0 * alpha))) / 2.0);\n\tcorner.offset *= clip;\n\tcorner.uv *= clip;\n}\n',gsplatCompressedDataVS:'\n#include "gsplatPackingPS"\nuniform highp usampler2D packedTexture;\nuniform highp sampler2D chunkTexture;\nvec4 chunkDataA;\nvec4 chunkDataB;\nvec4 chunkDataC;\nvec4 chunkDataD;\nvec4 chunkDataE;\nuvec4 packedData;\nvec3 unpack111011(uint bits) {\n\treturn vec3(\n\t\tfloat(bits >> 21u) / 2047.0,\n\t\tfloat((bits >> 11u) & 0x3ffu) / 1023.0,\n\t\tfloat(bits & 0x7ffu) / 2047.0\n\t);\n}\nconst float norm = sqrt(2.0);\nvec4 unpackRotation(uint bits) {\n\tfloat a = (float((bits >> 20u) & 0x3ffu) / 1023.0 - 0.5) * norm;\n\tfloat b = (float((bits >> 10u) & 0x3ffu) / 1023.0 - 0.5) * norm;\n\tfloat c = (float(bits & 0x3ffu) / 1023.0 - 0.5) * norm;\n\tfloat m = sqrt(1.0 - (a * a + b * b + c * c));\n\tuint mode = bits >> 30u;\n\tif (mode == 0u) return vec4(m, a, b, c);\n\tif (mode == 1u) return vec4(a, m, b, c);\n\tif (mode == 2u) return vec4(a, b, m, c);\n\treturn vec4(a, b, c, m);\n}\nvec3 readCenter(SplatSource source) {\n\tuint w = uint(textureSize(chunkTexture, 0).x) / 5u;\n\tuint chunkId = source.id / 256u;\n\tivec2 chunkUV = ivec2((chunkId % w) * 5u, chunkId / w);\n\tchunkDataA = texelFetch(chunkTexture, chunkUV, 0);\n\tchunkDataB = texelFetch(chunkTexture, chunkUV + ivec2(1, 0), 0);\n\tchunkDataC = texelFetch(chunkTexture, chunkUV + ivec2(2, 0), 0);\n\tchunkDataD = texelFetch(chunkTexture, chunkUV + ivec2(3, 0), 0);\n\tchunkDataE = texelFetch(chunkTexture, chunkUV + ivec2(4, 0), 0);\n\tpackedData = texelFetch(packedTexture, source.uv, 0);\n\treturn mix(chunkDataA.xyz, vec3(chunkDataA.w, chunkDataB.xy), unpack111011(packedData.x));\n}\nvec4 readColor(in SplatSource source) {\n\tvec4 r = unpack8888(packedData.w);\n\treturn vec4(mix(chunkDataD.xyz, vec3(chunkDataD.w, chunkDataE.xy), r.rgb), r.w);\n}\nvec4 getRotation() {\n\treturn unpackRotation(packedData.y);\n}\nvec3 getScale() {\n\treturn exp(mix(vec3(chunkDataB.zw, chunkDataC.x), chunkDataC.yzw, unpack111011(packedData.z)));\n}\nvoid readCovariance(in SplatSource source, out vec3 covA, out vec3 covB) {\n\tmat3 rot = quatToMat3(getRotation());\n\tvec3 scale = getScale();\n\tmat3 M = transpose(mat3(\n\t\tscale.x * rot[0],\n\t\tscale.y * rot[1],\n\t\tscale.z * rot[2]\n\t));\n\tcovA = vec3(dot(M[0], M[0]), dot(M[0], M[1]), dot(M[0], M[2]));\n\tcovB = vec3(dot(M[1], M[1]), dot(M[1], M[2]), dot(M[2], M[2]));\n}\n',gsplatCompressedSHVS:"\n#if SH_BANDS > 0\nuniform highp usampler2D shTexture0;\nuniform highp usampler2D shTexture1;\nuniform highp usampler2D shTexture2;\nvec4 unpack8888s(in uint bits) {\n\treturn vec4((uvec4(bits) >> uvec4(0u, 8u, 16u, 24u)) & 0xffu) * (8.0 / 255.0) - 4.0;\n}\nvoid readSHData(in SplatSource source, out vec3 sh[15], out float scale) {\n\tuvec4 shData0 = texelFetch(shTexture0, source.uv, 0);\n\tuvec4 shData1 = texelFetch(shTexture1, source.uv, 0);\n\tuvec4 shData2 = texelFetch(shTexture2, source.uv, 0);\n\tvec4 r0 = unpack8888s(shData0.x);\n\tvec4 r1 = unpack8888s(shData0.y);\n\tvec4 r2 = unpack8888s(shData0.z);\n\tvec4 r3 = unpack8888s(shData0.w);\n\tvec4 g0 = unpack8888s(shData1.x);\n\tvec4 g1 = unpack8888s(shData1.y);\n\tvec4 g2 = unpack8888s(shData1.z);\n\tvec4 g3 = unpack8888s(shData1.w);\n\tvec4 b0 = unpack8888s(shData2.x);\n\tvec4 b1 = unpack8888s(shData2.y);\n\tvec4 b2 = unpack8888s(shData2.z);\n\tvec4 b3 = unpack8888s(shData2.w);\n\tsh[0] =  vec3(r0.x, g0.x, b0.x);\n\tsh[1] =  vec3(r0.y, g0.y, b0.y);\n\tsh[2] =  vec3(r0.z, g0.z, b0.z);\n\tsh[3] =  vec3(r0.w, g0.w, b0.w);\n\tsh[4] =  vec3(r1.x, g1.x, b1.x);\n\tsh[5] =  vec3(r1.y, g1.y, b1.y);\n\tsh[6] =  vec3(r1.z, g1.z, b1.z);\n\tsh[7] =  vec3(r1.w, g1.w, b1.w);\n\tsh[8] =  vec3(r2.x, g2.x, b2.x);\n\tsh[9] =  vec3(r2.y, g2.y, b2.y);\n\tsh[10] = vec3(r2.z, g2.z, b2.z);\n\tsh[11] = vec3(r2.w, g2.w, b2.w);\n\tsh[12] = vec3(r3.x, g3.x, b3.x);\n\tsh[13] = vec3(r3.y, g3.y, b3.y);\n\tsh[14] = vec3(r3.z, g3.z, b3.z);\n\tscale = 1.0;\n}\n#endif\n",gsplatCustomizeVS:"\nvoid modifyCenter(inout vec3 center) {\n}\nvoid modifyCovariance(vec3 originalCenter, vec3 modifiedCenter, inout vec3 covA, inout vec3 covB) {\n}\nvoid modifyColor(vec3 center, inout vec4 color) {\n}\n",gsplatEvalSHVS:"\n\t#if SH_BANDS == 1\n\t\t#define SH_COEFFS 3\n\t#elif SH_BANDS == 2\n\t\t#define SH_COEFFS 8\n\t#elif SH_BANDS == 3\n\t\t#define SH_COEFFS 15\n\t#else\n\t\t#define SH_COEFFS 0\n\t#endif\n\t#if SH_BANDS > 0\n\tconst float SH_C1 = 0.4886025119029199f;\n\t#if SH_BANDS > 1\n\t\tconst float SH_C2_0 = 1.0925484305920792f;\n\t\tconst float SH_C2_1 = -1.0925484305920792f;\n\t\tconst float SH_C2_2 = 0.31539156525252005f;\n\t\tconst float SH_C2_3 = -1.0925484305920792f;\n\t\tconst float SH_C2_4 = 0.5462742152960396f;\n\t#endif\n\t#if SH_BANDS > 2\n\t\tconst float SH_C3_0 = -0.5900435899266435f;\n\t\tconst float SH_C3_1 = 2.890611442640554f;\n\t\tconst float SH_C3_2 = -0.4570457994644658f;\n\t\tconst float SH_C3_3 = 0.3731763325901154f;\n\t\tconst float SH_C3_4 = -0.4570457994644658f;\n\t\tconst float SH_C3_5 = 1.445305721320277f;\n\t\tconst float SH_C3_6 = -0.5900435899266435f;\n\t#endif\n\tvec3 evalSH(in vec3 sh[SH_COEFFS], in vec3 dir) {\n\t\tfloat x = dir.x;\n\t\tfloat y = dir.y;\n\t\tfloat z = dir.z;\n\t\tvec3 result = SH_C1 * (-sh[0] * y + sh[1] * z - sh[2] * x);\n\t\t#if SH_BANDS > 1\n\t\t\tfloat xx = x * x;\n\t\t\tfloat yy = y * y;\n\t\t\tfloat zz = z * z;\n\t\t\tfloat xy = x * y;\n\t\t\tfloat yz = y * z;\n\t\t\tfloat xz = x * z;\n\t\t\tresult +=\n\t\t\t\tsh[3] * (SH_C2_0 * xy) +\n\t\t\t\tsh[4] * (SH_C2_1 * yz) +\n\t\t\t\tsh[5] * (SH_C2_2 * (2.0 * zz - xx - yy)) +\n\t\t\t\tsh[6] * (SH_C2_3 * xz) +\n\t\t\t\tsh[7] * (SH_C2_4 * (xx - yy));\n\t\t#endif\n\t\t#if SH_BANDS > 2\n\t\t\tresult +=\n\t\t\t\tsh[8]  * (SH_C3_0 * y * (3.0 * xx - yy)) +\n\t\t\t\tsh[9]  * (SH_C3_1 * xy * z) +\n\t\t\t\tsh[10] * (SH_C3_2 * y * (4.0 * zz - xx - yy)) +\n\t\t\t\tsh[11] * (SH_C3_3 * z * (2.0 * zz - 3.0 * xx - 3.0 * yy)) +\n\t\t\t\tsh[12] * (SH_C3_4 * x * (4.0 * zz - xx - yy)) +\n\t\t\t\tsh[13] * (SH_C3_5 * z * (xx - yy)) +\n\t\t\t\tsh[14] * (SH_C3_6 * x * (xx - 3.0 * yy));\n\t\t#endif\n\t\treturn result;\n\t}\n\t#endif\n",gsplatHelpersVS:"\nfloat gsplatExtractSize(vec3 covA, vec3 covB) {\n\tfloat tr = covA.x + covB.x + covB.z;\n\treturn sqrt(max(tr, 0.0) / 3.0);\n}\nvoid gsplatApplyUniformScale(inout vec3 covA, inout vec3 covB, float scale) {\n\tfloat s2 = scale * scale;\n\tcovA *= s2;\n\tcovB *= s2;\n}\nvoid gsplatMakeRound(inout vec3 covA, inout vec3 covB, float size) {\n\tfloat s2 = size * size;\n\tcovA = vec3(s2, 0.0, 0.0);\n\tcovB = vec3(s2, 0.0, s2);\n}\n",gsplatQuatToMat3VS:"\nmat3 quatToMat3(vec4 R) {\n\tvec4 R2 = R + R;\n\tfloat X = R2.x * R.w;\n\tvec4 Y  = R2.y * R;\n\tvec4 Z  = R2.z * R;\n\tfloat W = R2.w * R.w;\n\treturn mat3(\n\t\t1.0 - Z.z - W,\n\t\t\t  Y.z + X,\n\t\t\t  Y.w - Z.x,\n\t\t\t  Y.z - X,\n\t\t1.0 - Y.y - W,\n\t\t\t  Z.w + Y.x,\n\t\t\t  Y.w + Z.x,\n\t\t\t  Z.w - Y.x,\n\t\t1.0 - Y.y - Z.z\n\t);\n}\n",gsplatSogsColorVS:"\nuniform highp sampler2D packedSh0;\nuniform float sh0_mins;\nuniform float sh0_maxs;\nconst float SH_C0 = 0.28209479177387814;\nvec4 readColor(in SplatSource source) {\n\tvec3 clr = mix(vec3(sh0_mins), vec3(sh0_maxs), unpack111110(pack8888(texelFetch(packedSh0, source.uv, 0))));\n\tfloat alpha = float(packedSample.z & 0xffu) / 255.0;\n\treturn vec4(vec3(0.5) + clr.xyz * SH_C0, alpha);\n}\n",gsplatSogsDataVS:'\n#include "gsplatPackingPS"\nuniform highp usampler2D packedTexture;\nuniform vec3 means_mins;\nuniform vec3 means_maxs;\nuniform float scales_mins;\nuniform float scales_maxs;\nuvec4 packedSample;\nvec3 readCenter(SplatSource source) {\n\tpackedSample = texelFetch(packedTexture, source.uv, 0);\n\tvec3 l = unpack8888(packedSample.x).xyz;\n\tvec3 u = unpack8888(packedSample.y).xyz;\n\tvec3 n = (l + u * 256.0) / 257.0;\n\tvec3 v = mix(means_mins, means_maxs, n);\n\treturn sign(v) * (exp(abs(v)) - 1.0);\n}\nconst float norm = sqrt(2.0);\nvoid readCovariance(in SplatSource source, out vec3 covA, out vec3 covB) {\n\tvec3 qdata = unpack8888(packedSample.z).xyz;\n\tvec3 sdata = unpack101010(packedSample.w >> 2u);\n\tuint qmode = packedSample.w & 0x3u;\n\tvec3 abc = (qdata - 0.5) * norm;\n\tfloat d = sqrt(max(0.0, 1.0 - dot(abc, abc)));\n\tvec4 quat = (qmode == 0u) ? vec4(d, abc) :\n\t\t\t\t((qmode == 1u) ? vec4(abc.x, d, abc.yz) :\n\t\t\t\t((qmode == 2u) ? vec4(abc.xy, d, abc.z) : vec4(abc, d)));\n\tmat3 rot = quatToMat3(quat);\n\tvec3 scale = exp(mix(vec3(scales_mins), vec3(scales_maxs), sdata));\n\tmat3 M = transpose(mat3(\n\t\tscale.x * rot[0],\n\t\tscale.y * rot[1],\n\t\tscale.z * rot[2]\n\t));\n\tcovA = vec3(dot(M[0], M[0]), dot(M[0], M[1]), dot(M[0], M[2]));\n\tcovB = vec3(dot(M[1], M[1]), dot(M[1], M[2]), dot(M[2], M[2]));\n}\n',gsplatSogsSHVS:"\nuniform highp sampler2D packedShN;\nuniform float shN_mins;\nuniform float shN_maxs;\nvoid readSHData(in SplatSource source, out vec3 sh[SH_COEFFS], out float scale) {\n\tivec2 t = ivec2(packedSample.xy & 255u);\n\tint n = t.x + t.y * 256;\n\tint u = (n % 64) * SH_COEFFS;\n\tint v = n / 64;\n\tfor (int i = 0; i < SH_COEFFS; i++) {\n\t\tsh[i] = mix(vec3(shN_mins), vec3(shN_maxs), unpack111110(pack8888(texelFetch(packedShN, ivec2(u + i, v), 0))));\n\t}\n\tscale = 1.0;\n}\n",gsplatSourceFormatVS:'\n#if defined(GSPLAT_WORKBUFFER_DATA)\n\t#include "gsplatWorkBufferVS"\n#elif GSPLAT_COMPRESSED_DATA == true\n\t#include "gsplatCompressedDataVS"\n\t#if SH_COEFFS > 0\n\t\t#include "gsplatCompressedSHVS"\n\t#endif\n#elif GSPLAT_SOGS_DATA == true\n\t#include "gsplatSogsDataVS"\n\t#include "gsplatSogsColorVS"\n\t#if SH_COEFFS > 0\n\t\t#include "gsplatSogsSHVS"\n\t#endif\n#else\n\t#include "gsplatDataVS"\n\t#include "gsplatColorVS"\n\t#if SH_COEFFS > 0\n\t\t#include "gsplatSHVS"\n\t#endif\n#endif\n',gsplatStructsVS:"\nstruct SplatSource {\n\tuint order;\n\tuint id;\n\tivec2 uv;\n\tvec2 cornerUV;\n};\nstruct SplatCenter {\n\tvec3 view;\n\tvec4 proj;\n\tmat4 modelView;\n\tfloat projMat00;\n\tvec3 modelCenterOriginal;\n\tvec3 modelCenterModified;\n};\nstruct SplatCorner {\n\tvec2 offset;\n\tvec2 uv;\n\t#if GSPLAT_AA\n\t\tfloat aaFactor;\n\t#endif\n\tvec2 v;\n\tfloat dlen;\n};\n",gsplatDataVS:"\nuniform highp usampler2D transformA;\nuniform highp sampler2D transformB;\nuint tAw;\nvec3 readCenter(SplatSource source) {\n\tuvec4 tA = texelFetch(transformA, source.uv, 0);\n\ttAw = tA.w;\n\treturn uintBitsToFloat(tA.xyz);\n}\nvec4 unpackRotation(vec3 packed) {\n\treturn vec4(packed.xyz, sqrt(max(0.0, 1.0 - dot(packed, packed))));\n}\nvoid readCovariance(in SplatSource source, out vec3 covA, out vec3 covB) {\n\tvec4 tB = texelFetch(transformB, source.uv, 0);\n\tmat3 rot = quatToMat3(unpackRotation(vec3(unpackHalf2x16(tAw), tB.w)).wxyz);\n\tvec3 scale = tB.xyz;\n\t\n\tmat3 M = transpose(mat3(\n\t\tscale.x * rot[0],\n\t\tscale.y * rot[1],\n\t\tscale.z * rot[2]\n\t));\n\tcovA = vec3(dot(M[0], M[0]), dot(M[0], M[1]), dot(M[0], M[2]));\n\tcovB = vec3(dot(M[1], M[1]), dot(M[1], M[2]), dot(M[2], M[2]));\n}\n",gsplatOutputVS:'\n#include "tonemappingPS"\n#include "decodePS"\n#include "gammaPS"\nvec3 prepareOutputFromGamma(vec3 gammaColor) {\n\t#if TONEMAP == NONE\n\t\t#if GAMMA == NONE\n\t\t\treturn decodeGamma(gammaColor);\n\t\t#else\n\t\t\treturn gammaColor;\n\t\t#endif\n\t#else\n\t\treturn gammaCorrectOutput(toneMap(decodeGamma(gammaColor)));\n\t#endif\n}\n',gsplatPS:'\n#ifndef DITHER_NONE\n\t#include "bayerPS"\n\t#include "opacityDitherPS"\n\tvarying float id;\n#endif\n#ifdef PICK_PASS\n\t#include "pickPS"\n#endif\n#if defined(SHADOW_PASS) || defined(PICK_PASS) || defined(PREPASS_PASS)\n\tuniform float alphaClip;\n#endif\n#ifdef PREPASS_PASS\n\tvarying float vLinearDepth;\n\t#include "floatAsUintPS"\n#endif\nvarying mediump vec2 gaussianUV;\nvarying mediump vec4 gaussianColor;\nconst float EXP4 = exp(-4.0);\nconst float INV_EXP4 = 1.0 / (1.0 - EXP4);\nfloat normExp(float x) {\n\treturn (exp(x * -4.0) - EXP4) * INV_EXP4;\n}\nvoid main(void) {\n\tmediump float A = dot(gaussianUV, gaussianUV);\n\tif (A > 1.0) {\n\t\tdiscard;\n\t}\n\tmediump float alpha = normExp(A) * gaussianColor.a;\n\t#if defined(SHADOW_PASS) || defined(PICK_PASS) || defined(PREPASS_PASS)\n\t\tif (alpha < alphaClip) {\n\t\t\tdiscard;\n\t\t}\n\t#endif\n\t#ifdef PICK_PASS\n\t\tpcFragColor0 = getPickOutput();\n\t\t#ifdef DEPTH_PICK_PASS\n\t\t\tpcFragColor1 = getPickDepth();\n\t\t#endif\n\t#elif SHADOW_PASS\n\t\tgl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n\t#elif PREPASS_PASS\n\t\tgl_FragColor = float2vec4(vLinearDepth);\n\t#else\n\t\tif (alpha < 1.0 / 255.0) {\n\t\t\tdiscard;\n\t\t}\n\t\t#ifndef DITHER_NONE\n\t\t\topacityDither(alpha, id * 0.013);\n\t\t#endif\n\t\tgl_FragColor = vec4(gaussianColor.xyz * alpha, alpha);\n\t#endif\n}\n',gsplatSHVS:"\n#if SH_BANDS > 0\nvec3 unpack111011s(uint bits) {\n\treturn vec3((uvec3(bits) >> uvec3(21u, 11u, 0u)) & uvec3(0x7ffu, 0x3ffu, 0x7ffu)) / vec3(2047.0, 1023.0, 2047.0) * 2.0 - 1.0;\n}\nvoid fetchScale(in uvec4 t, out float scale, out vec3 a, out vec3 b, out vec3 c) {\n\tscale = uintBitsToFloat(t.x);\n\ta = unpack111011s(t.y);\n\tb = unpack111011s(t.z);\n\tc = unpack111011s(t.w);\n}\nvoid fetch(in uvec4 t, out vec3 a, out vec3 b, out vec3 c, out vec3 d) {\n\ta = unpack111011s(t.x);\n\tb = unpack111011s(t.y);\n\tc = unpack111011s(t.z);\n\td = unpack111011s(t.w);\n}\nvoid fetch(in uint t, out vec3 a) {\n\ta = unpack111011s(t);\n}\n#if SH_BANDS == 1\n\tuniform highp usampler2D splatSH_1to3;\n\tvoid readSHData(in SplatSource source, out vec3 sh[3], out float scale) {\n\t\tfetchScale(texelFetch(splatSH_1to3, source.uv, 0), scale, sh[0], sh[1], sh[2]);\n\t}\n#elif SH_BANDS == 2\n\tuniform highp usampler2D splatSH_1to3;\n\tuniform highp usampler2D splatSH_4to7;\n\tuniform highp usampler2D splatSH_8to11;\n\tvoid readSHData(in SplatSource source, out vec3 sh[8], out float scale) {\n\t\tfetchScale(texelFetch(splatSH_1to3, source.uv, 0), scale, sh[0], sh[1], sh[2]);\n\t\tfetch(texelFetch(splatSH_4to7, source.uv, 0), sh[3], sh[4], sh[5], sh[6]);\n\t\tfetch(texelFetch(splatSH_8to11, source.uv, 0).x, sh[7]);\n\t}\n#else\n\tuniform highp usampler2D splatSH_1to3;\n\tuniform highp usampler2D splatSH_4to7;\n\tuniform highp usampler2D splatSH_8to11;\n\tuniform highp usampler2D splatSH_12to15;\n\tvoid readSHData(in SplatSource source, out vec3 sh[15], out float scale) {\n\t\tfetchScale(texelFetch(splatSH_1to3, source.uv, 0), scale, sh[0], sh[1], sh[2]);\n\t\tfetch(texelFetch(splatSH_4to7, source.uv, 0), sh[3], sh[4], sh[5], sh[6]);\n\t\tfetch(texelFetch(splatSH_8to11, source.uv, 0), sh[7], sh[8], sh[9], sh[10]);\n\t\tfetch(texelFetch(splatSH_12to15, source.uv, 0), sh[11], sh[12], sh[13], sh[14]);\n\t}\n#endif\n#endif\n",gsplatSourceVS:"\nattribute vec3 vertex_position;\nattribute uint vertex_id_attrib;\nuniform uint numSplats;\nuniform uint splatTextureSize;\nuniform highp usampler2D splatOrder;\nbool initSource(out SplatSource source) {\n\tsource.order = vertex_id_attrib + uint(vertex_position.z);\n\tif (source.order >= numSplats) {\n\t\treturn false;\n\t}\n\tivec2 orderUV = ivec2(source.order % splatTextureSize, source.order / splatTextureSize);\n\tsource.id = texelFetch(splatOrder, orderUV, 0).r;\n\tsource.uv = ivec2(source.id % splatTextureSize, source.id / splatTextureSize);\n\tsource.cornerUV = vertex_position.xy;\n\treturn true;\n}\n",gsplatVS:'\n#include "gsplatCommonVS"\nvarying mediump vec2 gaussianUV;\nvarying mediump vec4 gaussianColor;\n#ifndef DITHER_NONE\n\tvarying float id;\n#endif\nmediump vec4 discardVec = vec4(0.0, 0.0, 2.0, 1.0);\n#ifdef PREPASS_PASS\n\tvarying float vLinearDepth;\n#endif\n#ifdef GSPLAT_OVERDRAW\n\tuniform sampler2D colorRamp;\n\tuniform float colorRampIntensity;\n#endif\nvoid main(void) {\n\tSplatSource source;\n\tif (!initSource(source)) {\n\t\tgl_Position = discardVec;\n\t\treturn;\n\t}\n\t#ifdef GSPLAT_WORKBUFFER_DATA\n\t\tloadSplatTextures(source);\n\t#endif\n\tvec3 modelCenter = readCenter(source);\n\tSplatCenter center;\n\tcenter.modelCenterOriginal = modelCenter;\n\t\n\tmodifyCenter(modelCenter);\n\tcenter.modelCenterModified = modelCenter;\n\tif (!initCenter(modelCenter, center)) {\n\t\tgl_Position = discardVec;\n\t\treturn;\n\t}\n\tSplatCorner corner;\n\tif (!initCorner(source, center, corner)) {\n\t\tgl_Position = discardVec;\n\t\treturn;\n\t}\n\tvec4 clr = readColor(source);\n\t#if GSPLAT_AA\n\t\tclr.a *= corner.aaFactor;\n\t#endif\n\t#if SH_BANDS > 0\n\t\tvec3 dir = normalize(center.view * mat3(center.modelView));\n\t\tvec3 sh[SH_COEFFS];\n\t\tfloat scale;\n\t\treadSHData(source, sh, scale);\n\t\tclr.xyz += evalSH(sh, dir) * scale;\n\t#endif\n\tmodifyColor(modelCenter, clr);\n\tclipCorner(corner, clr.w);\n\tgl_Position = center.proj + vec4(corner.offset, 0, 0);\n\tgaussianUV = corner.uv;\n\t#ifdef GSPLAT_OVERDRAW\n\t\tfloat t = clamp(modelCenter.y / 20.0, 0.0, 1.0);\n\t\tvec3 rampColor = textureLod(colorRamp, vec2(t, 0.5), 0.0).rgb;\n\t\tclr.a *= (1.0 / 32.0) * colorRampIntensity;\n\t\tgaussianColor = vec4(rampColor, clr.a);\n\t#else\n\t\tgaussianColor = vec4(prepareOutputFromGamma(max(clr.xyz, 0.0)), clr.w);\n\t#endif\n\t#ifndef DITHER_NONE\n\t\tid = float(source.id);\n\t#endif\n\t#ifdef PREPASS_PASS\n\t\tvLinearDepth = -center.view.z;\n\t#endif\n}\n',gsplatWorkBufferVS:"\nuniform highp usampler2D splatTexture0;\nuniform highp usampler2D splatTexture1;\n#ifdef GSPLAT_COLOR_UINT\n\tuniform highp usampler2D splatColor;\n#else\n\tuniform mediump sampler2D splatColor;\n#endif\nuvec4 cachedSplatTexture0Data;\nuvec2 cachedSplatTexture1Data;\nvoid loadSplatTextures(SplatSource source) {\n\tcachedSplatTexture0Data = texelFetch(splatTexture0, source.uv, 0);\n\tcachedSplatTexture1Data = texelFetch(splatTexture1, source.uv, 0).xy;\n}\nvec3 readCenter(SplatSource source) {\n\treturn vec3(uintBitsToFloat(cachedSplatTexture0Data.r), uintBitsToFloat(cachedSplatTexture0Data.g), uintBitsToFloat(cachedSplatTexture0Data.b));\n}\nvoid readCovariance(in SplatSource source, out vec3 cov_A, out vec3 cov_B) {\n\tvec2 covAxy = unpackHalf2x16(cachedSplatTexture1Data.x);\n\tvec2 covBxy = unpackHalf2x16(cachedSplatTexture1Data.y);\n\tvec2 covAzBz = unpackHalf2x16(cachedSplatTexture0Data.a);\n\tcov_A = vec3(covAxy, covAzBz.x);\n\tcov_B = vec3(covBxy, covAzBz.y);\n}\nvec4 readColor(in SplatSource source) {\n\t#ifdef GSPLAT_COLOR_UINT\n\t\tuvec4 packed = texelFetch(splatColor, source.uv, 0);\n\t\tuint packed_rg = packed.r | (packed.g << 16u);\n\t\tuint packed_ba = packed.b | (packed.a << 16u);\n\t\treturn vec4(unpackHalf2x16(packed_rg), unpackHalf2x16(packed_ba));\n\t#else\n\t\treturn texelFetch(splatColor, source.uv, 0);\n\t#endif\n}\n",gsplatPackingPS:em};const ry={gsplatCenterVS:"\nuniform matrix_model: mat4x4f;\nuniform matrix_view: mat4x4f;\n#ifndef GSPLAT_CENTER_NOPROJ\n\tuniform matrix_projection: mat4x4f;\n#endif\nfn initCenter(modelCenter: vec3f, center: ptr<function, SplatCenter>) -> bool {\n\tlet modelView: mat4x4f = uniform.matrix_view * uniform.matrix_model;\n\tlet centerView: vec4f = modelView * vec4f(modelCenter, 1.0);\n\t#ifndef GSPLAT_CENTER_NOPROJ\n\t\tif (centerView.z > 0.0) {\n\t\t\treturn false;\n\t\t}\n\t\tvar centerProj: vec4f = uniform.matrix_projection * centerView;\n\t\tcenterProj.z = clamp(centerProj.z, 0.0, abs(centerProj.w));\n\t\tcenter.proj = centerProj;\n\t\tcenter.projMat00 = uniform.matrix_projection[0][0];\n\t#endif\n\tcenter.view = centerView.xyz / centerView.w;\n\tcenter.modelView = modelView;\n\treturn true;\n}\n",gsplatCornerVS:"\nuniform viewport: vec2f;\nuniform camera_params: vec4f;\nfn initCornerCov(source: ptr<function, SplatSource>, center: ptr<function, SplatCenter>, corner: ptr<function, SplatCorner>, covA: vec3f, covB: vec3f) -> bool {\n\tlet Vrk = mat3x3f(\n\t\tvec3f(covA.x, covA.y, covA.z),\n\t\tvec3f(covA.y, covB.x, covB.y),\n\t\tvec3f(covA.z, covB.y, covB.z)\n\t);\n\tlet focal = uniform.viewport.x * center.projMat00;\n\tlet v = select(center.view.xyz, vec3f(0.0, 0.0, 1.0), uniform.camera_params.w == 1.0);\n\tlet J1 = focal / v.z;\n\tlet J2 = -J1 / v.z * v.xy;\n\tlet J = mat3x3f(\n\t\tvec3f(J1, 0.0, J2.x),\n\t\tvec3f(0.0, J1, J2.y),\n\t\tvec3f(0.0, 0.0, 0.0)\n\t);\n\tlet W = transpose(mat3x3f(center.modelView[0].xyz, center.modelView[1].xyz, center.modelView[2].xyz));\n\tlet T = W * J;\n\tlet cov = transpose(T) * Vrk * T;\n\t#if GSPLAT_AA\n\t\tlet detOrig = cov[0][0] * cov[1][1] - cov[0][1] * cov[1][0];\n\t\tlet detBlur = (cov[0][0] + 0.3) * (cov[1][1] + 0.3) - cov[0][1] * cov[1][0];\n\t\tcorner.aaFactor = sqrt(detOrig / detBlur);\n\t#endif\n\tlet diagonal1 = cov[0][0] + 0.3;\n\tlet offDiagonal = cov[0][1];\n\tlet diagonal2 = cov[1][1] + 0.3;\n\tlet mid = 0.5 * (diagonal1 + diagonal2);\n\tlet radius = length(vec2f((diagonal1 - diagonal2) / 2.0, offDiagonal));\n\tlet lambda1 = mid + radius;\n\tlet lambda2 = max(mid - radius, 0.1);\n\tlet vmin = min(1024.0, min(uniform.viewport.x, uniform.viewport.y));\n\tlet l1 = 2.0 * min(sqrt(2.0 * lambda1), vmin);\n\tlet l2 = 2.0 * min(sqrt(2.0 * lambda2), vmin);\n\tif (l1 < 2.0 && l2 < 2.0) {\n\t\treturn false;\n\t}\n\tlet c = center.proj.ww / uniform.viewport;\n\tif (any((abs(center.proj.xy) - vec2f(max(l1, l2)) * c) > center.proj.ww)) {\n\t\treturn false;\n\t}\n\tlet diagonalVector = normalize(vec2f(offDiagonal, lambda1 - diagonal1));\n\tlet v1 = l1 * diagonalVector;\n\tlet v2 = l2 * vec2f(diagonalVector.y, -diagonalVector.x);\n\tcorner.offset = (source.cornerUV.x * v1 + source.cornerUV.y * v2) * c;\n\tcorner.uv = source.cornerUV;\n\treturn true;\n}\nfn initCorner(source: ptr<function, SplatSource>, center: ptr<function, SplatCenter>, corner: ptr<function, SplatCorner>) -> bool {\n\tvar covA: vec3f;\n\tvar covB: vec3f;\n\treadCovariance(source, &covA, &covB);\n\tmodifyCovariance(center.modelCenterOriginal, center.modelCenterModified, &covA, &covB);\n\treturn initCornerCov(source, center, corner, covA, covB);\n}\n",gsplatColorVS:"\nvar splatColor: texture_2d<uff>;\nfn readColor(source: ptr<function, SplatSource>) -> vec4f {\n\treturn textureLoad(splatColor, source.uv, 0);\n}\n",gsplatCommonVS:'\n#include "gsplatHelpersVS"\n#include "gsplatCustomizeVS"\n#include "gsplatStructsVS"\n#include "gsplatEvalSHVS"\n#include "gsplatQuatToMat3VS"\n#include "gsplatSourceFormatVS"\n#include "gsplatSourceVS"\n#include "gsplatCenterVS"\n#include "gsplatCornerVS"\n#include "gsplatOutputVS"\nfn clipCorner(corner: ptr<function, SplatCorner>, alpha: f32) {\n\tlet clip: f32 = min(1.0, sqrt(-log(1.0 / (255.0 * alpha))) / 2.0);\n\tcorner.offset = corner.offset * clip;\n\tcorner.uv = corner.uv * clip;\n}\n',gsplatCompressedDataVS:'\n#include "gsplatPackingPS"\nvar packedTexture: texture_2d<u32>;\nvar chunkTexture: texture_2d<uff>;\nvar<private> chunkDataA: vec4f;\nvar<private> chunkDataB: vec4f;\nvar<private> chunkDataC: vec4f;\nvar<private> chunkDataD: vec4f;\nvar<private> chunkDataE: vec4f;\nvar<private> packedData: vec4u;\nfn unpack111011(bits: u32) -> vec3f {\n\treturn (vec3f((vec3<u32>(bits) >> vec3<u32>(21u, 11u, 0u)) & vec3<u32>(0x7ffu, 0x3ffu, 0x7ffu))) / vec3f(2047.0, 1023.0, 2047.0);\n}\nconst norm_const: f32 = sqrt(2.0);\nfn unpackRotation(bits: u32) -> vec4f {\n\tlet a = (f32((bits >> 20u) & 0x3ffu) / 1023.0 - 0.5) * norm_const;\n\tlet b = (f32((bits >> 10u) & 0x3ffu) / 1023.0 - 0.5) * norm_const;\n\tlet c = (f32(bits & 0x3ffu) / 1023.0 - 0.5) * norm_const;\n\tlet m = sqrt(1.0 - (a * a + b * b + c * c));\n\tlet mode = bits >> 30u;\n\tif (mode == 0u) { return vec4f(m, a, b, c); }\n\tif (mode == 1u) { return vec4f(a, m, b, c); }\n\tif (mode == 2u) { return vec4f(a, b, m, c); }\n\treturn vec4f(a, b, c, m);\n}\nfn readCenter(source: ptr<function, SplatSource>) -> vec3f {\n\tlet tex_size_u = textureDimensions(chunkTexture, 0);\n\tlet w: u32 = tex_size_u.x / 5u;\n\tlet chunkId: u32 = source.id / 256u;\n\tlet chunkUV: vec2<i32> = vec2<i32>(i32((chunkId % w) * 5u), i32(chunkId / w));\n\tchunkDataA = textureLoad(chunkTexture, chunkUV + vec2<i32>(0, 0), 0);\n\tchunkDataB = textureLoad(chunkTexture, chunkUV + vec2<i32>(1, 0), 0);\n\tchunkDataC = textureLoad(chunkTexture, chunkUV + vec2<i32>(2, 0), 0);\n\tchunkDataD = textureLoad(chunkTexture, chunkUV + vec2<i32>(3, 0), 0);\n\tchunkDataE = textureLoad(chunkTexture, chunkUV + vec2<i32>(4, 0), 0);\n\tpackedData = textureLoad(packedTexture, source.uv, 0);\n\treturn mix(chunkDataA.xyz, vec3f(chunkDataA.w, chunkDataB.xy), unpack111011(packedData.x));\n}\nfn readColor(source: ptr<function, SplatSource>) -> vec4f {\n\tlet r = unpack8888(packedData.w);\n\treturn vec4f(mix(chunkDataD.xyz, vec3f(chunkDataD.w, chunkDataE.xy), r.rgb), r.w);\n}\nfn getRotation() -> vec4f {\n\treturn unpackRotation(packedData.y);\n}\nfn getScale() -> vec3f {\n\treturn exp(mix(vec3f(chunkDataB.zw, chunkDataC.x), chunkDataC.yzw, unpack111011(packedData.z)));\n}\nfn readCovariance(source: ptr<function, SplatSource>, covA_ptr: ptr<function, vec3f>, covB_ptr: ptr<function, vec3f>) {\n\tlet rot = quatToMat3(getRotation());\n\tlet scale = getScale();\n\tlet M = transpose(mat3x3f(\n\t\tscale.x * rot[0],\n\t\tscale.y * rot[1],\n\t\tscale.z * rot[2]\n\t));\n\t*covA_ptr = vec3f(dot(M[0], M[0]), dot(M[0], M[1]), dot(M[0], M[2]));\n\t*covB_ptr = vec3f(dot(M[1], M[1]), dot(M[1], M[2]), dot(M[2], M[2]));\n}\n',gsplatCompressedSHVS:"\n#if SH_BANDS > 0\nvar shTexture0: texture_2d<u32>;\nvar shTexture1: texture_2d<u32>;\nvar shTexture2: texture_2d<u32>;\nfn unpack8888s(bits: u32) -> vec4f {\n\tlet unpacked_u = (vec4<u32>(bits) >> vec4<u32>(0u, 8u, 16u, 24u)) & vec4<u32>(0xffu);\n\treturn vec4f(unpacked_u) * (8.0 / 255.0) - 4.0;\n}\nfn readSHData(source: ptr<function, SplatSource>, sh: ptr<function, array<vec3f, 15>>, scale: ptr<function, f32>) {\n\tlet shData0: vec4<u32> = textureLoad(shTexture0, source.uv, 0);\n\tlet shData1: vec4<u32> = textureLoad(shTexture1, source.uv, 0);\n\tlet shData2: vec4<u32> = textureLoad(shTexture2, source.uv, 0);\n\tlet r0 = unpack8888s(shData0.x);\n\tlet r1 = unpack8888s(shData0.y);\n\tlet r2 = unpack8888s(shData0.z);\n\tlet r3 = unpack8888s(shData0.w);\n\tlet g0 = unpack8888s(shData1.x);\n\tlet g1 = unpack8888s(shData1.y);\n\tlet g2 = unpack8888s(shData1.z);\n\tlet g3 = unpack8888s(shData1.w);\n\tlet b0 = unpack8888s(shData2.x);\n\tlet b1 = unpack8888s(shData2.y);\n\tlet b2 = unpack8888s(shData2.z);\n\tlet b3 = unpack8888s(shData2.w);\n\tsh[0] =  vec3f(r0.x, g0.x, b0.x);\n\tsh[1] =  vec3f(r0.y, g0.y, b0.y);\n\tsh[2] =  vec3f(r0.z, g0.z, b0.z);\n\tsh[3] =  vec3f(r0.w, g0.w, b0.w);\n\tsh[4] =  vec3f(r1.x, g1.x, b1.x);\n\tsh[5] =  vec3f(r1.y, g1.y, b1.y);\n\tsh[6] =  vec3f(r1.z, g1.z, b1.z);\n\tsh[7] =  vec3f(r1.w, g1.w, b1.w);\n\tsh[8] =  vec3f(r2.x, g2.x, b2.x);\n\tsh[9] =  vec3f(r2.y, g2.y, b2.y);\n\tsh[10] = vec3f(r2.z, g2.z, b2.z);\n\tsh[11] = vec3f(r2.w, g2.w, b2.w);\n\tsh[12] = vec3f(r3.x, g3.x, b3.x);\n\tsh[13] = vec3f(r3.y, g3.y, b3.y);\n\tsh[14] = vec3f(r3.z, g3.z, b3.z);\n\t*scale = 1.0;\n}\n#endif\n",gsplatCustomizeVS:"\nfn modifyCenter(center: ptr<function, vec3f>) {\n}\nfn modifyCovariance(originalCenter: vec3f, modifiedCenter: vec3f, covA: ptr<function, vec3f>, covB: ptr<function, vec3f>) {\n}\nfn modifyColor(center: vec3f, color: ptr<function, vec4f>) {\n}\n",gsplatEvalSHVS:"\n\t#if SH_BANDS == 1\n\t\tconst SH_COEFFS: i32 = 3;\n\t#elif SH_BANDS == 2\n\t\tconst SH_COEFFS: i32 = 8;\n\t#elif SH_BANDS == 3\n\t\tconst SH_COEFFS: i32 = 15;\n\t#else\n\t\tconst SH_COEFFS: i32 = 0;\n\t#endif\n\t#if SH_BANDS > 0\n\tconst SH_C1: f32 = 0.4886025119029199;\n\t#if SH_BANDS > 1\n\t\tconst SH_C2_0: f32 = 1.0925484305920792;\n\t\tconst SH_C2_1: f32 = -1.0925484305920792;\n\t\tconst SH_C2_2: f32 = 0.31539156525252005;\n\t\tconst SH_C2_3: f32 = -1.0925484305920792;\n\t\tconst SH_C2_4: f32 = 0.5462742152960396;\n\t#endif\n\t#if SH_BANDS > 2\n\t\tconst SH_C3_0: f32 = -0.5900435899266435;\n\t\tconst SH_C3_1: f32 = 2.890611442640554;\n\t\tconst SH_C3_2: f32 = -0.4570457994644658;\n\t\tconst SH_C3_3: f32 = 0.3731763325901154;\n\t\tconst SH_C3_4: f32 = -0.4570457994644658;\n\t\tconst SH_C3_5: f32 = 1.445305721320277;\n\t\tconst SH_C3_6: f32 = -0.5900435899266435;\n\t#endif\n\tfn evalSH(sh: ptr<function, array<vec3f, SH_COEFFS>>, dir: vec3f) -> vec3f {\n\t\tlet x = dir.x;\n\t\tlet y = dir.y;\n\t\tlet z = dir.z;\n\t\tvar result = SH_C1 * (-sh[0] * y + sh[1] * z - sh[2] * x);\n\t\t#if SH_BANDS > 1\n\t\t\tlet xx = x * x;\n\t\t\tlet yy = y * y;\n\t\t\tlet zz = z * z;\n\t\t\tlet xy = x * y;\n\t\t\tlet yz = y * z;\n\t\t\tlet xz = x * z;\n\t\t\tresult = result + (\n\t\t\t\tsh[3] * (SH_C2_0 * xy) +\n\t\t\t\tsh[4] * (SH_C2_1 * yz) +\n\t\t\t\tsh[5] * (SH_C2_2 * (2.0 * zz - xx - yy)) +\n\t\t\t\tsh[6] * (SH_C2_3 * xz) +\n\t\t\t\tsh[7] * (SH_C2_4 * (xx - yy))\n\t\t\t);\n\t\t#endif\n\t\t#if SH_BANDS > 2\n\t\t\tresult = result + (\n\t\t\t\tsh[8]  * (SH_C3_0 * y * (3.0 * xx - yy)) +\n\t\t\t\tsh[9]  * (SH_C3_1 * xy * z) +\n\t\t\t\tsh[10] * (SH_C3_2 * y * (4.0 * zz - xx - yy)) +\n\t\t\t\tsh[11] * (SH_C3_3 * z * (2.0 * zz - 3.0 * xx - 3.0 * yy)) +\n\t\t\t\tsh[12] * (SH_C3_4 * x * (4.0 * zz - xx - yy)) +\n\t\t\t\tsh[13] * (SH_C3_5 * z * (xx - yy)) +\n\t\t\t\tsh[14] * (SH_C3_6 * x * (xx - 3.0 * yy))\n\t\t\t);\n\t\t#endif\n\t\treturn result;\n\t}\n\t#endif\n",gsplatHelpersVS:"\nfn gsplatExtractSize(covA: vec3f, covB: vec3f) -> f32 {\n\tlet tr = covA.x + covB.x + covB.z;\n\treturn sqrt(max(tr, 0.0) / 3.0);\n}\nfn gsplatApplyUniformScale(covA: ptr<function, vec3f>, covB: ptr<function, vec3f>, scale: f32) {\n\tlet s2 = scale * scale;\n\t*covA = *covA * s2;\n\t*covB = *covB * s2;\n}\nfn gsplatMakeRound(covA: ptr<function, vec3f>, covB: ptr<function, vec3f>, size: f32) {\n\tlet s2 = size * size;\n\t*covA = vec3f(s2, 0.0, 0.0);\n\t*covB = vec3f(s2, 0.0, s2);\n}\n",gsplatSourceFormatVS:'\n#if defined(GSPLAT_WORKBUFFER_DATA)\n\t#include "gsplatWorkBufferVS"\n#elif GSPLAT_COMPRESSED_DATA == true\n\t#include "gsplatCompressedDataVS"\n\t#if SH_BANDS > 0\n\t\t#include "gsplatCompressedSHVS"\n\t#endif\n#elif GSPLAT_SOGS_DATA\n\t#include "gsplatSogsDataVS"\n\t#include "gsplatSogsColorVS"\n\t#if SH_BANDS > 0\n\t\t#include "gsplatSogsSHVS"\n\t#endif\n#else\n\t#include "gsplatDataVS"\n\t#include "gsplatColorVS"\n\t#if SH_BANDS > 0\n\t\t#include "gsplatSHVS"\n\t#endif\n#endif\n',gsplatStructsVS:"\nstruct SplatSource {\n\torder: u32,\n\tid: u32,\n\tuv: vec2<i32>,\n\tcornerUV: vec2f,\n}\nstruct SplatCenter {\n\tview: vec3f,\n\tproj: vec4f,\n\tmodelView: mat4x4f,\n\tprojMat00: f32,\n\tmodelCenterOriginal: vec3f,\n\tmodelCenterModified: vec3f,\n}\nstruct SplatCorner {\n\toffset: vec2f,\n\tuv: vec2f,\n\t#if GSPLAT_AA\n\t\taaFactor: f32,\n\t#endif\n}\n",gsplatQuatToMat3VS:"\nfn quatToMat3(R: vec4<f32>) -> mat3x3<f32> {\n\tlet R2: vec4<f32> = R + R;\n\tlet X: f32\t   = R2.x * R.w;\n\tlet Y: vec4<f32> = R2.y * R;\n\tlet Z: vec4<f32> = R2.z * R;\n\tlet W: f32\t   = R2.w * R.w;\n\treturn mat3x3<f32>(\n\t\t1.0 - Z.z - W,  Y.z + X,\t  Y.w - Z.x,\n\t\tY.z - X,\t\t1.0 - Y.y - W, Z.w + Y.x,\n\t\tY.w + Z.x,\t  Z.w - Y.x,\t 1.0 - Y.y - Z.z\n\t);\n}\n",gsplatSogsColorVS:"\nvar packedSh0: texture_2d<f32>;\nuniform sh0_mins: f32;\nuniform sh0_maxs: f32;\nconst SH_C0: f32 = 0.28209479177387814;\nfn readColor(source: ptr<function, SplatSource>) -> vec4f {\n\tlet clr = mix(vec3f(uniform.sh0_mins), vec3f(uniform.sh0_maxs), unpack111110(pack8888(textureLoad(packedSh0, source.uv, 0))));\n\tlet alpha = f32(packedSample.z & 0xffu) / 255.0;\n\treturn vec4f(vec3f(0.5) + clr.xyz * SH_C0, alpha);\n}\n",gsplatSogsDataVS:'\n#include "gsplatPackingPS"\nvar packedTexture: texture_2d<u32>;\nuniform means_mins: vec3f;\nuniform means_maxs: vec3f;\nuniform scales_mins: f32;\nuniform scales_maxs: f32;\nvar<private> packedSample: vec4<u32>;\nfn readCenter(source: ptr<function, SplatSource>) -> vec3f {\n\tpackedSample = textureLoad(packedTexture, source.uv, 0);\n\tlet l = unpack8888(packedSample.x).xyz;\n\tlet u = unpack8888(packedSample.y).xyz;\n\tlet n = (l + u * 256.0) / 257.0;\n\tlet v = mix(uniform.means_mins, uniform.means_maxs, n);\n\treturn sign(v) * (exp(abs(v)) - 1.0);\n}\nconst norm: f32 = sqrt(2.0);\nfn readCovariance(source: ptr<function, SplatSource>, covA_ptr: ptr<function, vec3f>, covB_ptr: ptr<function, vec3f>) {\n\tlet qdata = unpack8888(packedSample.z).xyz;\n\tlet sdata = unpack101010(packedSample.w >> 2u);\n\tlet qmode = packedSample.w & 0x3u;\n\tlet abc = (qdata - 0.5) * norm;\n\tlet d = sqrt(max(0.0, 1.0 - dot(abc, abc)));\n\tvar quat: vec4f;\n\tif (qmode == 0u) {\n\t\tquat = vec4f(d, abc);\n\t} else if (qmode == 1u) {\n\t\tquat = vec4f(abc.x, d, abc.y, abc.z);\n\t} else if (qmode == 2u) {\n\t\tquat = vec4f(abc.x, abc.y, d, abc.z);\n\t} else {\n\t\tquat = vec4f(abc.x, abc.y, abc.z, d);\n\t}\n\tlet rot = quatToMat3(quat);\n\tlet scale = exp(mix(vec3f(uniform.scales_mins), vec3f(uniform.scales_maxs), sdata));\n\tlet M = transpose(mat3x3f(\n\t\tscale.x * rot[0],\n\t\tscale.y * rot[1],\n\t\tscale.z * rot[2]\n\t));\n\t*covA_ptr = vec3f(dot(M[0], M[0]), dot(M[0], M[1]), dot(M[0], M[2]));\n\t*covB_ptr = vec3f(dot(M[1], M[1]), dot(M[1], M[2]), dot(M[2], M[2]));\n}\n',gsplatSogsSHVS:"\nvar packedShN: texture_2d<f32>;\nuniform shN_mins: f32;\nuniform shN_maxs: f32;\nfn readSHData(source: ptr<function, SplatSource>, sh: ptr<function, array<vec3f, SH_COEFFS>>, scale: ptr<function, f32>) {\n\tlet t = vec2i(packedSample.xy & vec2u(255u));\n\tlet n = t.x + t.y * 256;\n\tlet u = (n % 64) * SH_COEFFS;\n\tlet v = n / 64;\n\tfor (var i: i32 = 0; i < SH_COEFFS; i = i + 1) {\n\t\tsh[i] = mix(vec3f(uniform.shN_mins), vec3f(uniform.shN_maxs), unpack111110(pack8888(textureLoad(packedShN, vec2i(u + i, v), 0))));\n\t}\n\t*scale = 1.0;\n}\n",gsplatDataVS:"\nvar transformA: texture_2d<u32>;\nvar transformB: texture_2d<uff>;\nvar<private> tAw: u32;\nfn readCenter(source: ptr<function, SplatSource>) -> vec3f {\n\tlet tA: vec4<u32> = textureLoad(transformA, source.uv, 0);\n\ttAw = tA.w;\n\treturn bitcast<vec3f>(tA.xyz);\n}\nfn unpackRotation(packed: vec3f) -> vec4f {\n\treturn vec4f(packed.xyz, sqrt(max(0.0, 1.0 - dot(packed, packed))));\n}\nfn readCovariance(source: ptr<function, SplatSource>, covA_ptr: ptr<function, vec3f>, covB_ptr: ptr<function, vec3f>) {\n\tlet tB: vec4f = textureLoad(transformB, source.uv, 0);\n\tlet rot: mat3x3f = quatToMat3(unpackRotation(vec3f(unpack2x16float(bitcast<u32>(tAw)), tB.w)).wxyz);\n\tlet scale: vec3f = tB.xyz;\n\tlet M = transpose(mat3x3f(\n\t\tscale.x * rot[0],\n\t\tscale.y * rot[1],\n\t\tscale.z * rot[2]\n\t));\n\t*covA_ptr = vec3f(dot(M[0], M[0]), dot(M[0], M[1]), dot(M[0], M[2]));\n\t*covB_ptr = vec3f(dot(M[1], M[1]), dot(M[1], M[2]), dot(M[2], M[2]));\n}\n",gsplatOutputVS:'\n#include "tonemappingPS"\n#include "decodePS"\n#include "gammaPS"\nfn prepareOutputFromGamma(gammaColor: vec3f) -> vec3f {\n\t#if TONEMAP == NONE\n\t\t#if GAMMA == NONE\n\t\t\treturn decodeGamma3(gammaColor);\n\t\t#else \n\t\t\treturn gammaColor;\n\t\t#endif\n\t#else\n\t\treturn gammaCorrectOutput(toneMap(decodeGamma3(gammaColor)));\n\t#endif\n}\n',gsplatPS:'\n#ifndef DITHER_NONE\n\t#include "bayerPS"\n\t#include "opacityDitherPS"\n\tvarying id: f32;\n#endif\n#ifdef PICK_PASS\n\t#include "pickPS"\n#endif\n#if defined(SHADOW_PASS) || defined(PICK_PASS) || defined(PREPASS_PASS)\n\tuniform alphaClip: f32;\n#endif\n#ifdef PREPASS_PASS\n\tvarying vLinearDepth: f32;\n\t#include "floatAsUintPS"\n#endif\nconst EXP4\t  = exp(-4.0);\nconst INV_EXP4  = 1.0 / (1.0 - EXP4);\nfn normExp(x: f32) -> f32 {\n\treturn (exp(x * -4.0) - EXP4) * INV_EXP4;\n}\nvarying gaussianUV: vec2f;\nvarying gaussianColor: vec4f;\n@fragment\nfn fragmentMain(input: FragmentInput) -> FragmentOutput {\n\tvar output: FragmentOutput;\n\tlet A: f32 = dot(gaussianUV, gaussianUV);\n\tif (A > 1.0) {\n\t\tdiscard;\n\t\treturn output;\n\t}\n\tvar alpha = normExp(A) * gaussianColor.a;\n\t#if defined(SHADOW_PASS) || defined(PICK_PASS) || defined(PREPASS_PASS)\n\t\tif (alpha < uniform.alphaClip) {\n\t\t\tdiscard;\n\t\t\treturn output;\n\t\t}\n\t#endif\n\t#ifdef PICK_PASS\n\t\toutput.color = getPickOutput();\n\t\t#ifdef DEPTH_PICK_PASS\n\t\t\toutput.color1 = getPickDepth();\n\t\t#endif\n\t#elif SHADOW_PASS\n\t\toutput.color = vec4f(0.0, 0.0, 0.0, 1.0);\n\t#elif PREPASS_PASS\n\t\toutput.color = float2vec4(vLinearDepth);\n\t#else\n\t\tif (alpha < (1.0 / 255.0)) {\n\t\t\tdiscard;\n\t\t\treturn output;\n\t\t}\n\t\t#ifndef DITHER_NONE\n\t\t\topacityDither(&alpha, id * 0.013);\n\t\t#endif\n\t\toutput.color = vec4f(input.gaussianColor.xyz * alpha, alpha);\n\t#endif\n\treturn output;\n}',gsplatSHVS:"\n#if SH_BANDS > 0\nfn unpack111011s(bits: u32) -> vec3f {\n\treturn (vec3f((vec3<u32>(bits) >> vec3<u32>(21u, 11u, 0u)) & vec3<u32>(0x7ffu, 0x3ffu, 0x7ffu)) / vec3f(2047.0, 1023.0, 2047.0)) * 2.0 - 1.0;\n}\nstruct ScaleAndSH {\n\tscale: f32,\n\ta: vec3f,\n\tb: vec3f,\n\tc: vec3f\n};\nfn fetchScale(t_in: vec4<u32>) -> ScaleAndSH {\n\tvar result: ScaleAndSH;\n\tresult.scale = bitcast<f32>(t_in.x);\n\tresult.a = unpack111011s(t_in.y);\n\tresult.b = unpack111011s(t_in.z);\n\tresult.c = unpack111011s(t_in.w);\n\treturn result;\n}\nstruct SH {\n\ta: vec3f,\n\tb: vec3f,\n\tc: vec3f,\n\td: vec3f\n};\nfn fetch4(t_in: vec4<u32>) -> SH {\n\tvar result: SH;\n\tresult.a = unpack111011s(t_in.x);\n\tresult.b = unpack111011s(t_in.y);\n\tresult.c = unpack111011s(t_in.z);\n\tresult.d = unpack111011s(t_in.w);\n\treturn result;\n}\nfn fetch1(t_in: u32) -> vec3f {\n\treturn unpack111011s(t_in);\n}\n#if SH_BANDS == 1\n\tvar splatSH_1to3: texture_2d<u32>;\n\tfn readSHData(source: ptr<function, SplatSource>, sh: ptr<function, array<vec3f, 3>>, scale: ptr<function, f32>) {\n\t\tlet result = fetchScale(textureLoad(splatSH_1to3, source.uv, 0));\n\t\t*scale = result.scale;\n\t\tsh[0] = result.a;\n\t\tsh[1] = result.b;\n\t\tsh[2] = result.c;\n\t}\n#elif SH_BANDS == 2\n\tvar splatSH_1to3: texture_2d<u32>;\n\tvar splatSH_4to7: texture_2d<u32>;\n\tvar splatSH_8to11: texture_2d<u32>;\n\tfn readSHData(source: ptr<function, SplatSource>, sh: ptr<function, array<vec3f, 8>>, scale: ptr<function, f32>) {\n\t\tlet first: ScaleAndSH = fetchScale(textureLoad(splatSH_1to3, source.uv, 0));\n\t\t*scale = first.scale;\n\t\tsh[0] = first.a;\n\t\tsh[1] = first.b;\n\t\tsh[2] = first.c;\n\t\tlet second: SH = fetch4(textureLoad(splatSH_4to7, source.uv, 0));\n\t\tsh[3] = second.a;\n\t\tsh[4] = second.b;\n\t\tsh[5] = second.c;\n\t\tsh[6] = second.d;\n\t\tsh[7] = fetch1(textureLoad(splatSH_8to11, source.uv, 0).x);\n\t}\n#else\n\tvar splatSH_1to3: texture_2d<u32>;\n\tvar splatSH_4to7: texture_2d<u32>;\n\tvar splatSH_8to11: texture_2d<u32>;\n\tvar splatSH_12to15: texture_2d<u32>;\n\tfn readSHData(source: ptr<function, SplatSource>, sh: ptr<function, array<vec3f, 15>>, scale: ptr<function, f32>) {\n\t\tlet first: ScaleAndSH = fetchScale(textureLoad(splatSH_1to3, source.uv, 0));\n\t\t*scale = first.scale;\n\t\tsh[0] = first.a;\n\t\tsh[1] = first.b;\n\t\tsh[2] = first.c;\n\t\tlet second: SH = fetch4(textureLoad(splatSH_4to7, source.uv, 0));\n\t\tsh[3] = second.a;\n\t\tsh[4] = second.b;\n\t\tsh[5] = second.c;\n\t\tsh[6] = second.d;\n\t\tlet third: SH = fetch4(textureLoad(splatSH_8to11, source.uv, 0));\n\t\tsh[7] = third.a;\n\t\tsh[8] = third.b;\n\t\tsh[9] = third.c;\n\t\tsh[10] = third.d;\n\t\tlet fourth: SH = fetch4(textureLoad(splatSH_12to15, source.uv, 0));\n\t\tsh[11] = fourth.a;\n\t\tsh[12] = fourth.b;\n\t\tsh[13] = fourth.c;\n\t\tsh[14] = fourth.d;\n\t}\n#endif\n#endif\n",gsplatSourceVS:"\nattribute vertex_position: vec3f;\nattribute vertex_id_attrib: u32;\nuniform numSplats: u32;\nuniform splatTextureSize: u32;\n#ifdef STORAGE_ORDER\n\tvar<storage, read> splatOrder: array<u32>;\n#else\n\tvar splatOrder: texture_2d<u32>;\n#endif\nfn initSource(source: ptr<function, SplatSource>) -> bool {\n\tsource.order = vertex_id_attrib + u32(vertex_position.z);\n\tif (source.order >= uniform.numSplats) {\n\t\treturn false;\n\t}\n\t#ifdef STORAGE_ORDER\n\t\tsource.id = splatOrder[source.order];\n\t#else\n\t\tlet uv = vec2u(source.order % uniform.splatTextureSize, source.order / uniform.splatTextureSize);\n\t\tsource.id = textureLoad(splatOrder, vec2i(uv), 0).r;\n\t#endif\n\tsource.uv = vec2i(vec2u(source.id % uniform.splatTextureSize, source.id / uniform.splatTextureSize));\n\tsource.cornerUV = vertex_position.xy;\n\treturn true;\n}\n",gsplatVS:'\n#include "gsplatCommonVS"\nvarying gaussianUV: vec2f;\nvarying gaussianColor: vec4f;\n#ifndef DITHER_NONE\n\tvarying id: f32;\n#endif\nconst discardVec: vec4f = vec4f(0.0, 0.0, 2.0, 1.0);\n#ifdef PREPASS_PASS\n\tvarying vLinearDepth: f32;\n#endif\n#ifdef GSPLAT_OVERDRAW\n\tuniform colorRampIntensity: f32;\n\tvar colorRamp: texture_2d<f32>;\n\tvar colorRampSampler: sampler;\n#endif\n@vertex\nfn vertexMain(input: VertexInput) -> VertexOutput {\n\tvar output: VertexOutput;\n\tvar source: SplatSource;\n\tif (!initSource(&source)) {\n\t\toutput.position = discardVec;\n\t\treturn output;\n\t}\n\t#ifdef GSPLAT_WORKBUFFER_DATA\n\t\tloadSplatTextures(&source);\n\t#endif\n\tvar modelCenter: vec3f = readCenter(&source);\n\tvar center: SplatCenter;\n\tcenter.modelCenterOriginal = modelCenter;\n\t\n\tmodifyCenter(&modelCenter);\n\tcenter.modelCenterModified = modelCenter;\n\tif (!initCenter(modelCenter, &center)) {\n\t\toutput.position = discardVec;\n\t\treturn output;\n\t}\n\tvar corner: SplatCorner;\n\tif (!initCorner(&source, &center, &corner)) {\n\t\toutput.position = discardVec;\n\t\treturn output;\n\t}\n\tvar clr: vec4f = readColor(&source);\n\t#if GSPLAT_AA\n\t\tclr.a = clr.a * corner.aaFactor;\n\t#endif\n\t#if SH_BANDS > 0\n\t\tlet modelView3x3 = mat3x3f(center.modelView[0].xyz, center.modelView[1].xyz, center.modelView[2].xyz);\n\t\tlet dir = normalize(center.view * modelView3x3);\n\t\tvar sh: array<vec3f, SH_COEFFS>;\n\t\tvar scale: f32;\n\t\treadSHData(&source, &sh, &scale);\n\t\tclr = vec4f(clr.xyz + evalSH(&sh, dir) * scale, clr.a);\n\t#endif\n\tmodifyColor(modelCenter, &clr);\n\tclipCorner(&corner, clr.w);\n\toutput.position = center.proj + vec4f(corner.offset, 0.0, 0.0);\n\toutput.gaussianUV = corner.uv;\n\t#ifdef GSPLAT_OVERDRAW\n\t\tlet t: f32 = clamp(originalCenter.y / 20.0, 0.0, 1.0);\n\t\tlet rampColor: vec3f = textureSampleLevel(colorRamp, colorRampSampler, vec2f(t, 0.5), 0.0).rgb;\n\t\tclr.a = clr.a * (1.0 / 32.0) * uniform.colorRampIntensity;\n\t\toutput.gaussianColor = vec4f(rampColor, clr.a);\n\t#else\n\t\toutput.gaussianColor = vec4f(prepareOutputFromGamma(max(clr.xyz, vec3f(0.0))), clr.w);\n\t#endif\n\t#ifndef DITHER_NONE\n\t\toutput.id = f32(source.id);\n\t#endif\n\t#ifdef PREPASS_PASS\n\t\toutput.vLinearDepth = -center.view.z;\n\t#endif\n\treturn output;\n}\n',gsplatWorkBufferVS:"\nvar splatTexture0: texture_2d<u32>;\nvar splatTexture1: texture_2d<u32>;\nvar splatColor: texture_2d<uff>;\nvar<private> cachedSplatTexture0Data: vec4u;\nvar<private> cachedSplatTexture1Data: vec2u;\nfn loadSplatTextures(source: ptr<function, SplatSource>) {\n\tcachedSplatTexture0Data = textureLoad(splatTexture0, source.uv, 0);\n\tcachedSplatTexture1Data = textureLoad(splatTexture1, source.uv, 0).xy;\n}\nfn readCenter(source: ptr<function, SplatSource>) -> vec3f {\n\treturn vec3f(bitcast<f32>(cachedSplatTexture0Data.r), bitcast<f32>(cachedSplatTexture0Data.g), bitcast<f32>(cachedSplatTexture0Data.b));\n}\nfn readCovariance(source: ptr<function, SplatSource>, cov_A: ptr<function, vec3f>, cov_B: ptr<function, vec3f>) {\n\tlet covAxy = unpack2x16float(cachedSplatTexture1Data.x);\n\tlet covBxy = unpack2x16float(cachedSplatTexture1Data.y);\n\tlet covAzBz = unpack2x16float(cachedSplatTexture0Data.a);\n\t*cov_A = vec3f(covAxy, covAzBz.x);\n\t*cov_B = vec3f(covBxy, covAzBz.y);\n}\nfn readColor(source: ptr<function, SplatSource>) -> vec4f {\n\treturn textureLoad(splatColor, source.uv, 0);\n}   \n",gsplatPackingPS:sm},ay=["enabled"],oy=["unified","lodDistances","castShadows","material","highQualitySH","asset","layers"];class ly extends wg{static{this.EVENT_MATERIALCREATED="material:created"}static{this.EVENT_FRAMEREADY="frame:ready"}constructor(t){super(t),this.id="gsplat",this.ComponentType=sy,this.DataType=ny,this.schema=ay,t.renderer.gsplatDirector=new ey(t.graphicsDevice,t.renderer,t.scene,this),Fh.get(t.graphicsDevice,In).add(iy),Fh.get(t.graphicsDevice,Rn).add(ry),this.on("beforeremove",this.onRemove,this)}initializeComponentData(t,e,s){e.layers&&e.layers.length&&(e.layers=e.layers.slice(0));for(let s=0;s<oy.length;s++)e.hasOwnProperty(oy[s])&&(t[oy[s]]=e[oy[s]]);e.aabbCenter&&e.aabbHalfExtents&&(t.customAabb=new Ss(new rs(e.aabbCenter),new rs(e.aabbHalfExtents))),super.initializeComponentData(t,e,ay)}cloneComponent(t,e){const s=t.gsplat,n={};oy.forEach(t=>{if("material"===t){if(!s.unified){const e=s[t];e&&(n[t]=e.clone())}}else n[t]=s[t]}),n.enabled=s.enabled;const i=this.addComponent(e,n);return s.customAabb&&(i.customAabb=s.customAabb.clone()),i}onRemove(t,e){e.onRemove()}getGSplatMaterial(t,e){const s=this.app.renderer.gsplatDirector;if(!s)return null;const n=s.camerasMap.get(t);if(!n)return null;const i=n.layersMap.get(e);return i?.gsplatManager?.material??null}}xg._buildAccessors(sy.prototype,ay);class hy extends Ve{static{this.EVENT_SETMESHES="set:meshes"}set meshes(t){this.decRefMeshes(),this._meshes=t,this.incRefMeshes(),this.fire("set:meshes",t)}get meshes(){return this._meshes}destroy(){this.meshes=null}decRefMeshes(){this._meshes?.forEach((t,e)=>{t&&(t.decRefCount(),t.refCount<1&&(t.destroy(),this._meshes[e]=null))})}incRefMeshes(){this._meshes?.forEach(t=>{t?.incRefCount()})}constructor(...t){super(...t),this._meshes=null}}function cy(t){const e=this;if(!e.resource)return;const s=t.resource,n=s.renders&&s.renders[e.data.renderIndex];n&&(e.resource.meshes=n.resource.meshes)}function dy(t){const e=this;e.registry.off(`load:${t.id}`,cy,e),e.registry.on(`load:${t.id}`,cy,e),e.registry.off(`remove:${t.id}`,uy,e),e.registry.once(`remove:${t.id}`,uy,e),t.resource?cy.call(e,t):e.registry.load(t)}function uy(t){const e=this;e.registry.off(`load:${t.id}`,cy,e),e.resource&&e.resource.destroy()}class fy extends Gm{constructor(t){super(t,"render"),this._registry=t.assets}open(t,e){return new hy}patch(t,e){if(!t.data.containerAsset)return;const s=e.get(t.data.containerAsset);s?dy.call(t,s):e.once(`add:${t.data.containerAsset}`,dy,t)}}class py{constructor(t,e,s,n){this._paths=t,this._input=e,this._output=s,this._interpolation=n}get paths(){return this._paths}get input(){return this._input}get output(){return this._output}get interpolation(){return this._interpolation}}class my{constructor(t,e){this._components=t,this._data=e}get components(){return this._components}get data(){return this._data}}function gy(t,e){let s;const n=(t,e)=>{switch(e){case s.DT_INT8:return new Int8Array(t.buffer,t.byteOffset,t.byteLength);case s.DT_INT16:return new Int16Array(t.buffer,t.byteOffset,t.byteLength/2);case s.DT_INT32:return new Int32Array(t.buffer,t.byteOffset,t.byteLength/4);case s.DT_UINT8:return new Uint8Array(t.buffer,t.byteOffset,t.byteLength);case s.DT_UINT16:return new Uint16Array(t.buffer,t.byteOffset,t.byteLength/2);case s.DT_UINT32:return new Uint32Array(t.buffer,t.byteOffset,t.byteLength/4);case s.DT_FLOAT32:return new Float32Array(t.buffer,t.byteOffset,t.byteLength/4)}return null},i=t=>t.num_components()*(t=>{switch(t){case s.DT_INT8:return 1;case s.DT_INT16:return 2;case s.DT_INT32:return 4;case s.DT_UINT8:return 1;case s.DT_UINT16:return 2;case s.DT_UINT32:case s.DT_FLOAT32:return 4}return 1})(t.data_type()),r={0:0,1:1,5:2,2:3,7:4,8:5,4:6,3:7},a=(t,e)=>{const s=(t,e,s)=>{t[0]=e[0]-s[0],t[1]=e[1]-s[1],t[2]=e[2]-s[2]},n=(t,e,s)=>{t[0]=e[1]*s[2]-s[1]*e[2],t[1]=e[2]*s[0]-s[2]*e[0],t[2]=e[0]*s[1]-s[0]*e[1]},i=(t,e)=>{const s=t[e+0],n=t[e+1],i=t[e+2],r=1/Math.sqrt(s*s+n*n+i*i);t[e+0]*=r,t[e+1]*=r,t[e+2]*=r},r=(t,e,s)=>{for(let n=0;n<3;++n)t[n]=e[s+n]},a=e.length/3,o=t.length/3,l=new Float32Array(t.length),h=[0,0,0],c=[0,0,0],d=[0,0,0],u=[0,0,0],f=[0,0,0],p=[0,0,0];for(let o=0;o<a;++o){const a=3*e[3*o+0],m=3*e[3*o+1],g=3*e[3*o+2];r(h,t,a),r(c,t,m),r(d,t,g),s(u,c,h),s(f,d,h),n(p,u,f),i(p,0);for(let t=0;t<3;++t)l[a+t]+=p[t],l[m+t]+=p[t],l[g+t]+=p[t]}for(let t=0;t<o;++t)i(l,3*t);return new Uint8Array(l.buffer)},o=t=>{const e=(t=>{const e={},o=new s.DecoderBuffer;o.Init(t,t.length);const l=new s.Decoder;if(l.GetEncodedGeometryType(o)!==s.TRIANGULAR_MESH)return e.error="Failed to decode draco mesh: not a mesh",e;const h=new s.Mesh,c=l.DecodeBufferToMesh(o,h);if(!c||!c.ok()||0===s.getPointer(h))return e.error="Failed to decode draco asset",e;const d=3*h.num_faces(),u=h.num_points()<=65535,f=d*(u?2:4),p=s._malloc(f);u?(l.GetTrianglesUInt16Array(h,f,p),e.indices=new Uint16Array(s.HEAPU16.buffer,p,d).slice().buffer):(l.GetTrianglesUInt32Array(h,f,p),e.indices=new Uint32Array(s.HEAPU32.buffer,p,d).slice().buffer),s._free(p);const m=[];for(let t=0;t<h.num_attributes();++t)m.push(l.GetAttribute(h,t));m.sort((t,e)=>(r[t.attribute_type()]??r.length)-(r[e.attribute_type()]??r.length)),e.attributes=m.map(t=>t.unique_id());let g=0;const _=m.map(t=>{const e=g;return g+=4*Math.ceil(i(t)/4),e}),v=m.some(t=>1===t.attribute_type()),y=_[1];if(!v){for(let t=1;t<_.length;++t)_[t]+=12;g+=12}e.vertices=new ArrayBuffer(h.num_points()*g);const b=new Uint8Array(e.vertices);for(let t=0;t<h.num_attributes();++t){const r=m[t],o=i(r),c=h.num_points()*o,d=s._malloc(c);l.GetAttributeDataArrayForAllPoints(h,r,r.data_type(),c,d);const f=new Uint8Array(s.HEAPU8.buffer,d,c);for(let e=0;e<h.num_points();++e)for(let s=0;s<o;++s)b[e*g+_[t]+s]=f[e*o+s];if(!v&&0===r.attribute_type()){const t=a(n(f,r.data_type()),u?new Uint16Array(e.indices):new Uint32Array(e.indices));for(let e=0;e<h.num_points();++e)for(let s=0;s<12;++s)b[e*g+y+s]=t[12*e+s]}s._free(d)}return s.destroy(h),s.destroy(l),s.destroy(o),e})(new Uint8Array(t.buffer));self.postMessage({jobId:t.jobId,error:e.error,indices:e.indices,vertices:e.vertices,attributes:e.attributes},[e.indices,e.vertices].filter(t=>null!=t))},l=[];self.onmessage=t=>{const e=t.data;switch(e.type){case"init":self.DracoDecoderModule({instantiateWasm:(t,s)=>(WebAssembly.instantiate(e.module,t).then(t=>s(t)).catch(t=>console.error(`instantiate failed + ${t}`)),{})}).then(t=>{s=t,l.forEach(t=>o(t))});break;case"decodeMesh":s?o(e):l.push(e)}}}class _y{constructor(){this.workers=[[],[],[]],this.jobId=0,this.jobQueue=[],this.jobCallbacks=new Map,this.run=(t,e)=>{t.postMessage({type:"decodeMesh",jobId:e.jobId,buffer:e.buffer},[e.buffer])}}init(t){for(t.forEach(t=>{t.addEventListener("message",e=>{const s=e.data,n=this.jobCallbacks.get(s.jobId);if(n&&n(s.error,{indices:s.indices,vertices:s.vertices,attributes:s.attributes}),this.jobCallbacks.delete(s.jobId),this.jobQueue.length>0){const e=this.jobQueue.shift();this.run(t,e)}else{const e=this.workers[2].indexOf(t);if(-1!==e)this.workers[2].splice(e,1),this.workers[1].push(t);else{const e=this.workers[1].indexOf(t);-1!==e&&(this.workers[1].splice(e,1),this.workers[0].push(t))}}})}),this.workers[0]=t;this.jobQueue.length&&(this.workers[0].length||this.workers[1].length);){const t=this.jobQueue.shift();if(this.workers[0].length>0){const e=this.workers[0].shift();this.workers[1].push(e),this.run(e,t)}else{const e=this.workers[1].shift();this.workers[2].push(e),this.run(e,t)}}}enqueueJob(t,e){const s={jobId:this.jobId++,buffer:t};if(this.jobCallbacks.set(s.jobId,e),this.workers[0].length>0){const t=this.workers[0].shift();this.workers[1].push(t),this.run(t,s)}else if(this.workers[1].length>0){const t=this.workers[1].shift();this.workers[2].push(t),this.run(t,s)}else this.jobQueue.push(s)}}const vy=t=>{const e=()=>fetch(t).then(t=>t.arrayBuffer()).then(t=>WebAssembly.compile(t));return WebAssembly.compileStreaming?WebAssembly.compileStreaming(fetch(t)).catch(t=>e()):e()};let yy;const by=(t,e)=>!!(t=>{if(yy)return!0;if(!t){const e=Ge.getConfig("DracoDecoderModule");t=e?{jsUrl:e.glueUrl,wasmUrl:e.wasmUrl,numWorkers:e.numWorkers}:{jsUrl:"draco.wasm.js",wasmUrl:"draco.wasm.wasm",numWorkers:1}}return!(!t.jsUrl||!t.wasmUrl||(yy=new _y,Promise.all([(e=t.jsUrl,new Promise((t,s)=>{const n={cache:!0,responseType:"text",retry:!0,maxRetries:3};hl.get(e,n,(e,n)=>{e?s(e):t(n)})})),vy(t.wasmUrl)]).then(([e,s])=>{const n=["/* draco */",e,"/* worker */",`(\n${gy.toString()}\n)()\n\n`].join("\n"),i=new Blob([n],{type:"application/javascript"}),r=URL.createObjectURL(i),a=Math.max(1,Math.min(16,t.numWorkers||1)),o=[];for(let t=0;t<a;++t){const t=new Worker(r);t.postMessage({type:"init",module:s}),o.push(t)}yy.init(o)}),0));var e})()&&(yy.enqueueJob(t,e),!0);class Sy{destroy(){this.renders&&this.renders.forEach(t=>{t.meshes=null})}}const xy=t=>/^data:[^\n\r,\u2028\u2029]*,.*$/i.test(t),wy=t=>{switch(t){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":default:return 3;case"VEC4":case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16}},Ty=t=>{switch(t){case 5120:default:return 0;case 5121:return 1;case 5122:return 2;case 5123:return 3;case 5124:return 4;case 5125:return 5;case 5126:return 6}},Cy=t=>{switch(t){case 5120:case 5121:return 1;case 5122:case 5123:return 2;case 5124:case 5125:case 5126:return 4;default:return 0}},Ey={POSITION:Ys,NORMAL:Qs,TANGENT:Zs,COLOR_0:en,JOINTS_0:tn,WEIGHTS_0:Js,TEXCOORD_0:nn,TEXCOORD_1:rn,TEXCOORD_2:an,TEXCOORD_3:on,TEXCOORD_4:ln,TEXCOORD_5:hn,TEXCOORD_6:cn,TEXCOORD_7:dn},Ay={[Ys]:0,[Qs]:1,[Zs]:2,[en]:3,[tn]:4,[Js]:5,[nn]:6,[rn]:7,[an]:8,[on]:9,[ln]:10,[hn]:11,[cn]:12,[dn]:13},Dy=(t,e,s)=>{const n=(t=>{switch(t){case 0:return t=>Math.max(t/127,-1);case 1:return t=>t/255;case 2:return t=>Math.max(t/32767,-1);case 3:return t=>t/65535;default:return t=>t}})(s),i=e.length;for(let s=0;s<i;++s)t[s]=n(e[s]);return t},Py=(t,e,s=!1)=>{const n=wy(t.type),i=(t=>{switch(t){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5124:return Int32Array;case 5125:return Uint32Array;case 5126:return Float32Array;default:return null}})(t.componentType);if(!i)return null;let r;if(t.sparse){const s=t.sparse,a={count:s.count,type:"SCALAR"},o=Py(Object.assign(a,s.indices),e,!0),l={count:s.count,type:t.type,componentType:t.componentType},h=Py(Object.assign(l,s.values),e,!0);if(t.hasOwnProperty("bufferView")){const s={bufferView:t.bufferView,byteOffset:t.byteOffset,componentType:t.componentType,count:t.count,type:t.type};r=Py(s,e,!0).slice()}else r=new i(t.count*n);for(let t=0;t<s.count;++t){const e=o[t];for(let s=0;s<n;++s)r[e*n+s]=h[t*n+s]}}else if(t.hasOwnProperty("bufferView")){const a=e[t.bufferView];if(s&&a.hasOwnProperty("byteStride")){const e=n*i.BYTES_PER_ELEMENT,s=new ArrayBuffer(t.count*e),o=new Uint8Array(s);let l=0;for(let s=0;s<t.count;++s){let n=(t.byteOffset||0)+s*a.byteStride;for(let t=0;t<e;++t)o[l++]=a[n++]}r=new i(s)}else r=new i(a.buffer,a.byteOffset+(t.byteOffset||0),t.count*n)}else r=new i(t.count*n);return r},Ly=(t,e)=>{const s=Py(t,e,!0);if(s instanceof Float32Array||!t.normalized)return s;const n=new Float32Array(s.length);return Dy(n,s,Ty(t.componentType)),n},Iy=t=>{let e=t.min,s=t.max;if(!e||!s)return null;if(t.normalized){const n=Ty(t.componentType);e=Dy([],e,n),s=Dy([],s,n)}return new Ss(new rs(.5*(s[0]+e[0]),.5*(s[1]+e[1]),.5*(s[2]+e[2])),new rs(.5*(s[0]-e[0]),.5*(s[1]-e[1]),.5*(s[2]-e[2])))},Ry=t=>{if(!t.hasOwnProperty("mode"))return 4;switch(t.mode){case 0:return 0;case 1:return 1;case 2:return 2;case 3:return 3;case 4:default:return 4;case 5:return 5;case 6:return 6}},My=(t,e)=>{const s=t[Ys];if(!s||3!==s.components)return;let n;if(s.size!==s.stride){const t=s.stride/Jn[s.type],e=new Zn[s.type](s.buffer,s.offset,s.count*t);n=new Zn[s.type](3*s.count);for(let i=0;i<s.count;++i)n[3*i+0]=e[i*t+0],n[3*i+1]=e[i*t+1],n[3*i+2]=e[i*t+2]}else n=new Zn[s.type](s.buffer,s.offset,3*s.count);const i=s.count;e||(e=(t=>{const e=new Uint16Array(t);for(let s=0;s<t;s++)e[s]=s;return e})(i));const r=nf(n,e),a=new Float32Array(r.length);a.set(r),t[Qs]={buffer:a.buffer,size:12,offset:0,stride:12,count:i,components:3,type:6}},ky=t=>{const e=new Fm(`${t.name}_clone`,t.type,t.file,t.data,t.options);return e.loaded=!0,e.resource=(t=>{const e=new pi(t.device,t);return e._levels=(t=>{const e=[];for(let s=0;s<t._levels.length;++s){let n=[];if(t.cubemap)for(let e=0;e<6;++e)n.push(t._levels[s][e]);else n=t._levels[s];e.push(n)}return e})(t),e})(t.resource),t.registry.add(e),e},Oy=(t,e,s,n,i,r)=>{const a={},o=[];for(const t in e)e.hasOwnProperty(t)&&Ey.hasOwnProperty(t)&&(a[t]=e[t],o.push(`${t}:${e[t]}`));o.sort();const l=o.join();let h=r[l];if(!h){const o={};for(const t in a){const s=n[e[t]],r=Py(s,i),a=i[s.bufferView],l=Ey[t],h=wy(s.type)*Cy(s.componentType),c=a&&a.hasOwnProperty("byteStride")?a.byteStride:h;o[l]={buffer:r.buffer,size:h,offset:r.byteOffset,stride:c,count:s.count,components:wy(s.type),type:Ty(s.componentType),normalize:s.normalized}}o.hasOwnProperty(Qs)||My(o,s),h=((t,e)=>{const s=e[Ys];if(!s)return null;const n=s.count,i=[];for(const s in e)if(e.hasOwnProperty(s)){const n={semantic:s,components:e[s].components,type:e[s].type,normalize:!!e[s].normalize};Ui.isElementValid(t,n)||n.components++,i.push(n)}let r,a,o,l,h,c;i.sort((t,e)=>Ay[t.semantic]-Ay[e.semantic]);const d=new Ui(t,i);let u=!0;for(r=0;r<d.elements.length;++r)if(h=d.elements[r],l=e[h.name],c=l.offset-s.offset,l.buffer!==s.buffer||l.stride!==h.stride||l.size!==h.size||c!==h.offset){u=!1;break}const f=new ki(t,d,n),p=f.lock(),m=new Uint32Array(p);let g;if(u)g=new Uint32Array(s.buffer,s.offset,n*f.format.size/4),m.set(g);else{let t,s;for(r=0;r<f.format.elements.length;++r){h=f.format.elements[r],t=h.stride/4,l=e[h.name],s=l.stride/4,g=new Uint32Array(l.buffer,l.offset,(l.count-1)*s+(l.size+3)/4);let i=0,c=h.offset/4;const d=Math.floor((l.size+3)/4);for(a=0;a<n;++a){for(o=0;o<d;++o)m[c+o]=g[i+o];i+=s,c+=t}}}return f.unlock(),f})(t,o),r[l]=h}return h},Fy=(t,e,s,n,i,r,a,o,l)=>{const h=[];return e.primitives.forEach(c=>{if(c.extensions?.KHR_draco_mesh_compression)h.push(((t,e,s,n,i,r,a)=>{const o=new tc(t);o.aabb=Iy(s[e.attributes.POSITION]);const l=[];for(const[t,n]of Object.entries(e.attributes)){const e=s[n],i=Ey[t],r=Ty(e.componentType);l.push({semantic:i,components:wy(e.type),type:r,normalize:e.normalized??(i===en&&(1===r||3===r))})}if(a.push(new Promise((s,i)=>{const r=e.extensions.KHR_draco_mesh_compression;by(n[r.bufferView].slice().buffer,(n,a)=>{if(n)console.log(n),i(n);else{const n={};for(const[t,e]of Object.entries(r.attributes))n[Ey[t]]=a.attributes.indexOf(e);l.sort((t,e)=>n[t.semantic]-n[e.semantic]),e.attributes?.NORMAL||l.splice(1,0,{semantic:"NORMAL",components:3,type:6});const i=new Ui(t,l),h=a.vertices.byteLength/i.size,c=h<=65535?1:2,d=a.indices.byteLength/(h<=65535?2:4),u=new ki(t,i,h,{data:a.vertices}),f=new Mo(t,c,d,0,a.indices);o.vertexBuffer=u,o.indexBuffer[0]=f,o.primitive[0].type=Ry(e),o.primitive[0].base=0,o.primitive[0].count=f?d:h,o.primitive[0].indexed=!!f,s()}})})),e?.extensions?.KHR_materials_variants){const t=e.extensions.KHR_materials_variants,s={};t.mappings.forEach(t=>{t.variants.forEach(e=>{s[e]=t.material})}),i[o.id]=s}return r[o.id]=e.material,o})(t,c,s,n,r,a,l));else{let l=c.hasOwnProperty("indices")?Py(s[c.indices],n,!0):null;const d=Oy(t,c.attributes,l,s,n,i),u=Ry(c),f=new tc(t);if(f.vertexBuffer=d,f.primitive[0].type=u,f.primitive[0].base=0,f.primitive[0].indexed=null!==l,null!==l){let e;e=l instanceof Uint8Array?0:l instanceof Uint16Array?1:2,0===e&&t.isWebGPU&&(e=1,l=new Uint16Array(l));const s=new Mo(t,e,l.length,0,l);f.indexBuffer[0]=s,f.primitive[0].count=l.length}else f.primitive[0].count=d.numVertices;if(c.hasOwnProperty("extensions")&&c.extensions.hasOwnProperty("KHR_materials_variants")){const t=c.extensions.KHR_materials_variants,e={};t.mappings.forEach(t=>{t.variants.forEach(s=>{e[s]=t.material})}),r[f.id]=e}a[f.id]=c.material;let p=s[c.attributes.POSITION];if(f.aabb=Iy(p),c.hasOwnProperty("targets")){const i=[];c.targets.forEach((t,r)=>{const a={};t.hasOwnProperty("POSITION")&&(p=s[t.POSITION],a.deltaPositions=Ly(p,n),a.aabb=Iy(p)),t.hasOwnProperty("NORMAL")&&(p=s[t.NORMAL],a.deltaNormals=Ly(p,n)),e.hasOwnProperty("extras")&&e.extras.hasOwnProperty("targetNames")?a.name=e.extras.targetNames[r]:a.name=r.toString(10),e.hasOwnProperty("weights")&&(a.defaultWeight=e.weights[r]),a.preserveData=o.morphPreserveData,i.push(new Yu(a))}),f.morph=new Ku(i,t,{preferHighPrecision:o.morphPreferHighPrecision})}h.push(f)}}),h},Ny=(t,e,s)=>{let n;const i=t.texCoord;if(i)for(n=0;n<s.length;++n)e[`${s[n]}MapUv`]=i;const r=[0,0],a=[1,1],o=t.extensions?.KHR_texture_transform;if(o){const t=o.offset||r,i=o.scale||a,l=o.rotation?-o.rotation*Qe.RAD_TO_DEG:0,h=new os(i[0],i[1]),c=new os(t[0],1-i[1]-t[1]);for(n=0;n<s.length;++n)e[`${s[n]}MapTiling`]=h,e[`${s[n]}MapOffset`]=c,e[`${s[n]}MapRotation`]=l}},By=(t,e,s)=>{let n;if(t.hasOwnProperty("diffuseFactor")){const[s,n,i,r]=t.diffuseFactor;e.diffuse.set(s,n,i).gamma(),e.opacity=r}else e.diffuse.set(1,1,1),e.opacity=1;if(t.hasOwnProperty("diffuseTexture")){const i=t.diffuseTexture;n=s[i.index],e.diffuseMap=n,e.diffuseMapChannel="rgb",e.opacityMap=n,e.opacityMapChannel="a",Ny(i,e,["diffuse","opacity"])}if(e.useMetalness=!1,t.hasOwnProperty("specularFactor")){const[s,n,i]=t.specularFactor;e.specular.set(s,n,i).gamma()}else e.specular.set(1,1,1);if(t.hasOwnProperty("glossinessFactor")?e.gloss=t.glossinessFactor:e.gloss=1,t.hasOwnProperty("specularGlossinessTexture")){const n=t.specularGlossinessTexture;e.specularMap=e.glossMap=s[n.index],e.specularMapChannel="rgb",e.glossMapChannel="a",Ny(n,e,["gloss","metalness"])}},zy=(t,e,s)=>{if(t.hasOwnProperty("clearcoatFactor")?e.clearCoat=.25*t.clearcoatFactor:e.clearCoat=0,t.hasOwnProperty("clearcoatTexture")){const n=t.clearcoatTexture;e.clearCoatMap=s[n.index],e.clearCoatMapChannel="r",Ny(n,e,["clearCoat"])}if(t.hasOwnProperty("clearcoatRoughnessFactor")?e.clearCoatGloss=t.clearcoatRoughnessFactor:e.clearCoatGloss=0,t.hasOwnProperty("clearcoatRoughnessTexture")){const n=t.clearcoatRoughnessTexture;e.clearCoatGlossMap=s[n.index],e.clearCoatGlossMapChannel="g",Ny(n,e,["clearCoatGloss"])}if(t.hasOwnProperty("clearcoatNormalTexture")){const n=t.clearcoatNormalTexture;e.clearCoatNormalMap=s[n.index],Ny(n,e,["clearCoatNormal"]),n.hasOwnProperty("scale")?e.clearCoatBumpiness=n.scale:e.clearCoatBumpiness=1}e.clearCoatGlossInvert=!0},Uy=(t,e,s)=>{e.useLighting=!1,e.emissive.copy(e.diffuse),e.emissiveMap=e.diffuseMap,e.emissiveMapUv=e.diffuseMapUv,e.emissiveMapTiling.copy(e.diffuseMapTiling),e.emissiveMapOffset.copy(e.diffuseMapOffset),e.emissiveMapRotation=e.diffuseMapRotation,e.emissiveMapChannel=e.diffuseMapChannel,e.emissiveVertexColor=e.diffuseVertexColor,e.emissiveVertexColorChannel=e.diffuseVertexColorChannel,e.useLighting=!1,e.useSkybox=!1,e.diffuse.set(1,1,1),e.diffuseMap=null,e.diffuseVertexColor=!1},Vy=(t,e,s)=>{if(e.useMetalnessSpecularColor=!0,t.hasOwnProperty("specularColorTexture")&&(e.specularMap=s[t.specularColorTexture.index],e.specularMapChannel="rgb",Ny(t.specularColorTexture,e,["specular"])),t.hasOwnProperty("specularColorFactor")){const[s,n,i]=t.specularColorFactor;e.specular.set(s,n,i).gamma()}else e.specular.set(1,1,1);t.hasOwnProperty("specularFactor")?e.specularityFactor=t.specularFactor:e.specularityFactor=1,t.hasOwnProperty("specularTexture")&&(e.specularityFactorMapChannel="a",e.specularityFactorMap=s[t.specularTexture.index],Ny(t.specularTexture,e,["specularityFactor"]))},Hy=(t,e,s)=>{t.hasOwnProperty("ior")&&(e.refractionIndex=1/t.ior)},Gy=(t,e,s)=>{t.hasOwnProperty("dispersion")&&(e.dispersion=t.dispersion)},Wy=(t,e,s)=>{e.blendType=2,e.useDynamicRefraction=!0,t.hasOwnProperty("transmissionFactor")&&(e.refraction=t.transmissionFactor),t.hasOwnProperty("transmissionTexture")&&(e.refractionMapChannel="r",e.refractionMap=s[t.transmissionTexture.index],Ny(t.transmissionTexture,e,["refraction"]))},jy=(t,e,s)=>{if(e.useSheen=!0,t.hasOwnProperty("sheenColorFactor")){const[s,n,i]=t.sheenColorFactor;e.sheen.set(s,n,i).gamma()}else e.sheen.set(1,1,1);t.hasOwnProperty("sheenColorTexture")&&(e.sheenMap=s[t.sheenColorTexture.index],Ny(t.sheenColorTexture,e,["sheen"])),e.sheenGloss=t.hasOwnProperty("sheenRoughnessFactor")?t.sheenRoughnessFactor:0,t.hasOwnProperty("sheenRoughnessTexture")&&(e.sheenGlossMap=s[t.sheenRoughnessTexture.index],e.sheenGlossMapChannel="a",Ny(t.sheenRoughnessTexture,e,["sheenGloss"])),e.sheenGlossInvert=!0},$y=(t,e,s)=>{if(e.blendType=2,e.useDynamicRefraction=!0,t.hasOwnProperty("thicknessFactor")&&(e.thickness=t.thicknessFactor),t.hasOwnProperty("thicknessTexture")&&(e.thicknessMap=s[t.thicknessTexture.index],e.thicknessMapChannel="g",Ny(t.thicknessTexture,e,["thickness"])),t.hasOwnProperty("attenuationDistance")&&(e.attenuationDistance=t.attenuationDistance),t.hasOwnProperty("attenuationColor")){const[s,n,i]=t.attenuationColor;e.attenuation.set(s,n,i).gamma()}},Xy=(t,e,s)=>{t.hasOwnProperty("emissiveStrength")&&(e.emissiveIntensity=t.emissiveStrength)},qy=(t,e,s)=>{e.useIridescence=!0,t.hasOwnProperty("iridescenceFactor")&&(e.iridescence=t.iridescenceFactor),t.hasOwnProperty("iridescenceTexture")&&(e.iridescenceMapChannel="r",e.iridescenceMap=s[t.iridescenceTexture.index],Ny(t.iridescenceTexture,e,["iridescence"])),t.hasOwnProperty("iridescenceIor")&&(e.iridescenceRefractionIndex=t.iridescenceIor),t.hasOwnProperty("iridescenceThicknessMinimum")&&(e.iridescenceThicknessMin=t.iridescenceThicknessMinimum),t.hasOwnProperty("iridescenceThicknessMaximum")&&(e.iridescenceThicknessMax=t.iridescenceThicknessMaximum),t.hasOwnProperty("iridescenceThicknessTexture")&&(e.iridescenceThicknessMapChannel="g",e.iridescenceThicknessMap=s[t.iridescenceThicknessTexture.index],Ny(t.iridescenceThicknessTexture,e,["iridescenceThickness"]))},Ky=(t,e,s)=>{if(e.enableGGXSpecular=!0,t.hasOwnProperty("anisotropyStrength")?e.anisotropyIntensity=t.anisotropyStrength:e.anisotropyIntensity=0,t.hasOwnProperty("anisotropyTexture")){const n=t.anisotropyTexture;e.anisotropyMap=s[n.index],Ny(n,e,["anisotropy"])}t.hasOwnProperty("anisotropyRotation")?e.anisotropyRotation=t.anisotropyRotation*Qe.RAD_TO_DEG:e.anisotropyRotation=0},Yy=(t,e)=>{const s=new hp;let n;if(t.hasOwnProperty("name")&&(s.name=t.name),s.occludeSpecular=1,s.diffuseVertexColor=!0,s.specularTint=!0,s.specularVertexColor=!0,s.specular.set(1,1,1),s.gloss=1,s.glossInvert=!0,s.useMetalness=!0,t.hasOwnProperty("pbrMetallicRoughness")){const i=t.pbrMetallicRoughness;if(i.hasOwnProperty("baseColorFactor")){const[t,e,n,r]=i.baseColorFactor;s.diffuse.set(t,e,n).gamma(),s.opacity=r}if(i.hasOwnProperty("baseColorTexture")){const t=i.baseColorTexture;n=e[t.index],s.diffuseMap=n,s.diffuseMapChannel="rgb",s.opacityMap=n,s.opacityMapChannel="a",Ny(t,s,["diffuse","opacity"])}if(i.hasOwnProperty("metallicFactor")&&(s.metalness=i.metallicFactor),i.hasOwnProperty("roughnessFactor")&&(s.gloss=i.roughnessFactor),i.hasOwnProperty("metallicRoughnessTexture")){const t=i.metallicRoughnessTexture;s.metalnessMap=s.glossMap=e[t.index],s.metalnessMapChannel="b",s.glossMapChannel="g",Ny(t,s,["gloss","metalness"])}}if(t.hasOwnProperty("normalTexture")){const n=t.normalTexture;s.normalMap=e[n.index],Ny(n,s,["normal"]),n.hasOwnProperty("scale")&&(s.bumpiness=n.scale)}if(t.hasOwnProperty("occlusionTexture")){const n=t.occlusionTexture;s.aoMap=e[n.index],s.aoMapChannel="r",Ny(n,s,["ao"])}if(t.hasOwnProperty("emissiveFactor")){const[e,n,i]=t.emissiveFactor;s.emissive.set(e,n,i).gamma()}if(t.hasOwnProperty("emissiveTexture")){const n=t.emissiveTexture;s.emissiveMap=e[n.index],Ny(n,s,["emissive"])}if(t.hasOwnProperty("alphaMode"))switch(t.alphaMode){case"MASK":s.blendType=3,t.hasOwnProperty("alphaCutoff")?s.alphaTest=t.alphaCutoff:s.alphaTest=.5;break;case"BLEND":s.blendType=2,s.depthWrite=!1;break;default:s.blendType=3}else s.blendType=3;t.hasOwnProperty("doubleSided")?(s.twoSidedLighting=t.doubleSided,s.cull=t.doubleSided?0:1):(s.twoSidedLighting=!1,s.cull=1);const i={KHR_materials_clearcoat:zy,KHR_materials_emissive_strength:Xy,KHR_materials_ior:Hy,KHR_materials_dispersion:Gy,KHR_materials_iridescence:qy,KHR_materials_pbrSpecularGlossiness:By,KHR_materials_sheen:jy,KHR_materials_specular:Vy,KHR_materials_transmission:Wy,KHR_materials_unlit:Uy,KHR_materials_volume:$y,KHR_materials_anisotropy:Ky};if(t.hasOwnProperty("extensions"))for(const n in t.extensions){const r=i[n];void 0!==r&&r(t.extensions[n],s,e)}return s.update(),s},Qy=new ps,Zy=new rs,Jy=(t,e,s)=>{const n=new Hc;if(t.hasOwnProperty("name")&&t.name.length>0?n.name=t.name:n.name=`node_${e}`,t.hasOwnProperty("matrix")&&(Qy.data.set(t.matrix),Qy.getTranslation(Zy),n.setLocalPosition(Zy),Qy.getEulerAngles(Zy),n.setLocalEulerAngles(Zy),Qy.getScale(Zy),n.setLocalScale(Zy)),t.hasOwnProperty("rotation")){const e=t.rotation;n.setLocalRotation(e[0],e[1],e[2],e[3])}if(t.hasOwnProperty("translation")){const e=t.translation;n.setLocalPosition(e[0],e[1],e[2])}if(t.hasOwnProperty("scale")){const e=t.scale;n.setLocalScale(e[0],e[1],e[2])}return t.hasOwnProperty("extensions")&&t.extensions.EXT_mesh_gpu_instancing&&s.set(t,{ext:t.extensions.EXT_mesh_gpu_instancing}),n},tb=(t,e)=>{const s="orthographic"===t.type?1:0,n=1===s?t.orthographic:t.perspective,i={enabled:!1,projection:s,nearClip:n.znear,aspectRatioMode:0};n.zfar&&(i.farClip=n.zfar),1===s?(i.orthoHeight=.5*n.ymag,n.ymag&&(i.aspectRatioMode=1,i.aspectRatio=n.xmag/n.ymag)):(i.fov=n.yfov*Qe.RAD_TO_DEG,n.aspectRatio&&(i.aspectRatioMode=1,i.aspectRatio=n.aspectRatio));const r=new Jm(t.name);return r.addComponent("camera",i),r},eb=(t,e)=>{const s={enabled:!1,type:"point"===t.type?"omni":t.type,color:t.hasOwnProperty("color")?new Ze(t.color):Ze.WHITE,range:t.hasOwnProperty("range")?t.range:9999,falloffMode:1,intensity:t.hasOwnProperty("intensity")?Qe.clamp(t.intensity,0,2):1};t.hasOwnProperty("spot")&&(s.innerConeAngle=t.spot.hasOwnProperty("innerConeAngle")?t.spot.innerConeAngle*Qe.RAD_TO_DEG:0,s.outerConeAngle=t.spot.hasOwnProperty("outerConeAngle")?t.spot.outerConeAngle*Qe.RAD_TO_DEG:Math.PI/4),t.hasOwnProperty("intensity")&&(s.luminance=t.intensity*ju.getLightUnitConversion(Uu[s.type],s.outerConeAngle,s.innerConeAngle));const n=new Jm(e.name);return n.rotateLocal(90,0,0),n.addComponent("light",s),n},sb=(t,e,s,n)=>{if(!e.hasOwnProperty("skins")||0===e.skins.length)return[];const i=new Map;return e.skins.map(r=>((t,e,s,n,i,r)=>{let a,o,l;const h=e.joints,c=h.length,d=[];if(e.hasOwnProperty("inverseBindMatrices")){const t=e.inverseBindMatrices,i=Py(s[t],n,!0),r=[];for(a=0;a<c;a++){for(o=0;o<16;o++)r[o]=i[16*a+o];l=new ps,l.set(r),d.push(l)}}else for(a=0;a<c;a++)l=new ps,d.push(l);const u=[];for(a=0;a<c;a++)u[a]=i[h[a]].name;const f=u.join("#");let p=r.get(f);return p||(p=new Hf(t,d,u),r.set(f,p)),p})(t,r,e.accessors,n,s,i))},nb=(t,e,s,n)=>{if(!t.hasOwnProperty("animations")||0===t.animations.length)return[];const i=n?.animation?.preprocess,r=n?.animation?.postprocess;return t.animations.map((n,a)=>{i&&i(n);const o=((t,e,s,n,i,r,a)=>{const o=t=>new my(wy(t.type),Ly(t,n)),l={STEP:0,LINEAR:1,CUBICSPLINE:2},h={},c={},d={};let u,f=1;for(u=0;u<t.samplers.length;++u){const e=t.samplers[u];h.hasOwnProperty(e.input)||(h[e.input]=o(s[e.input])),c.hasOwnProperty(e.output)||(c[e.output]=o(s[e.output]));const n=e.hasOwnProperty("interpolation")&&l.hasOwnProperty(e.interpolation)?l[e.interpolation]:1,i={paths:[],input:e.input,output:e.output,interpolation:n};d[u]=i}const p=[],m={translation:"localPosition",rotation:"localRotation",scale:"localScale"},g=t=>{const e=[];for(;t;)e.unshift(t.name),t=t.parent;return e},_=(t,e,s)=>{const n=c[t.output];if(!n)return;let i;if(r&&r[e.mesh]){const t=r[e.mesh];t.hasOwnProperty("extras")&&t.extras.hasOwnProperty("targetNames")&&(i=t.extras.targetNames)}const a=n.data,o=a.length/h[t.input].data.length,l=a.length/o,p=4*l,m=new ArrayBuffer(p*o);for(let e=0;e<o;e++){const n=new Float32Array(m,p*e,l);for(let t=0;t<l;t++)n[t]=a[t*o+e];const r=new my(1,n),h=i?.[e]?`name.${i[e]}`:e;c[-f]=r;const g={paths:[{entityPath:s,component:"graph",propertyPath:[`weight.${h}`]}],input:t.input,output:-f,interpolation:t.interpolation};f++,d[`morphCurve-${u}-${e}`]=g}};for(u=0;u<t.channels.length;++u){const e=t.channels[u],s=e.target,n=d[e.sampler],r=i[s.node],o=a[s.node],l=g(r);s.path.startsWith("weights")?(_(n,o,l),d[e.sampler].morphCurve=!0):n.paths.push({entityPath:l,component:"graph",propertyPath:[m[s.path]]})}const v=[],y=[],b=[];for(const t in h)v.push(h[t]),h[t]=v.length-1;for(const t in c)y.push(c[t]),c[t]=y.length-1;for(const t in d){const e=d[t];e.morphCurve||(b.push(new py(e.paths,h[e.input],c[e.output],e.interpolation)),e.paths.length>0&&"localRotation"===e.paths[0].propertyPath[0]&&2!==e.interpolation&&p.push(b[b.length-1].output))}p.sort();let S,x=null;for(u=0;u<p.length;++u){const t=p[u];if(0===u||t!==x){if(S=y[t],4===S.components){const t=S.data,e=t.length-4;for(let s=0;s<e;s+=4)t[s+0]*t[s+4]+t[s+1]*t[s+5]+t[s+2]*t[s+6]+t[s+3]*t[s+7]<0&&(t[s+4]*=-1,t[s+5]*=-1,t[s+6]*=-1,t[s+7]*=-1)}x=t}}let w=0;for(u=0;u<v.length;u++)S=v[u]._data,w=Math.max(w,0===S.length?0:S[S.length-1]);return new Hg(t.hasOwnProperty("name")?t.name:`animation_${e}`,w,v,y,b)})(n,a,t.accessors,s,e,t.meshes,t.nodes);return r&&r(n,o),o})},ib=async(t,e,s,n,i)=>{const r=i?.global?.preprocess,a=i?.global?.postprocess;r&&r(e);const o=new Map,l=((t,e,s)=>{if(!t.hasOwnProperty("nodes")||0===t.nodes.length)return[];const n=e?.node?.preprocess,i=e?.node?.process??Jy,r=e?.node?.postprocess,a=t.nodes.map((t,e)=>{n&&n(t);const a=i(t,e,s);return r&&r(t,a),a});for(let e=0;e<t.nodes.length;++e){const s=t.nodes[e];if(s.hasOwnProperty("children")){const t=a[e],n={};for(let e=0;e<s.children.length;++e){const i=a[s.children[e]];i.parent||(n.hasOwnProperty(i.name)?i.name+=n[i.name]++:n[i.name]=1,t.addChild(i))}}}return a})(e,i,o),h=((t,e)=>{const s=[],n=t.scenes.length;if(1===n&&1===t.scenes[0].nodes?.length){const n=t.scenes[0].nodes[0];s.push(e[n])}else for(let i=0;i<n;i++){const n=t.scenes[i];if(n.nodes){const t=new Hc(n.name);for(let s=0;s<n.nodes.length;s++){const i=e[n.nodes[s]];t.addChild(i)}s.push(t)}}return s})(e,l),c=((t,e,s)=>{let n=null;if(t.hasOwnProperty("nodes")&&t.hasOwnProperty("extensions")&&t.extensions.hasOwnProperty("KHR_lights_punctual")&&t.extensions.KHR_lights_punctual.hasOwnProperty("lights")){const i=t.extensions.KHR_lights_punctual.lights;if(i.length){const r=s?.light?.preprocess,a=s?.light?.process??eb,o=s?.light?.postprocess;t.nodes.forEach((t,s)=>{if(t.hasOwnProperty("extensions")&&t.extensions.hasOwnProperty("KHR_lights_punctual")&&t.extensions.KHR_lights_punctual.hasOwnProperty("light")){const l=t.extensions.KHR_lights_punctual.light,h=i[l];if(h){r&&r(h);const i=a(h,e[s]);o&&o(h,i),i&&(n||(n=new Map),n.set(t,i))}}})}}return n})(e,l,i),d=((t,e,s)=>{let n=null;if(t.hasOwnProperty("nodes")&&t.hasOwnProperty("cameras")&&t.cameras.length>0){const i=s?.camera?.preprocess,r=s?.camera?.process??tb,a=s?.camera?.postprocess;t.nodes.forEach((s,o)=>{if(s.hasOwnProperty("camera")){const l=t.cameras[s.camera];if(l){i&&i(l);const t=r(l,e[o]);a&&a(l,t),t&&(n||(n=new Map),n.set(s,t))}}})}return n})(e,l,i),u=(t=>{if(!t.hasOwnProperty("extensions")||!t.extensions.hasOwnProperty("KHR_materials_variants"))return null;const e=t.extensions.KHR_materials_variants.variants,s={};for(let t=0;t<e.length;t++)s[e[t].name]=t;return s})(e),f=await Promise.all(s),{meshes:p,meshVariants:m,meshDefaultMaterials:g,promises:_}=((t,e,s,n)=>{const i={},r={},a={},o=[];return{meshes:!n.skipMeshes&&e?.meshes?.length&&e?.accessors?.length&&e?.bufferViews?.length?e.meshes.map(l=>Fy(t,l,e.accessors,s,i,r,a,n,o)):[],meshVariants:r,meshDefaultMaterials:a,promises:o}})(t,e,f,i),v=nb(e,l,f,i);((t,e,s,n)=>{const i=e.accessors;s.forEach((t,e)=>{const s=t.ext.attributes;let r,a,o;if(s.hasOwnProperty("TRANSLATION")){const t=i[s.TRANSLATION];r=Ly(t,n)}if(s.hasOwnProperty("ROTATION")){const t=i[s.ROTATION];a=Ly(t,n)}if(s.hasOwnProperty("SCALE")){const t=i[s.SCALE];o=Ly(t,n)}const l=(r?r.length/3:0)||(a?a.length/4:0)||(o?o.length/3:0);if(l){const e=new Float32Array(16*l),s=new rs,n=new ms,i=new rs(1,1,1),h=new ps;let c=0;for(let t=0;t<l;t++){const l=3*t;if(r&&s.set(r[l],r[l+1],r[l+2]),a){const e=4*t;n.set(a[e],a[e+1],a[e+2],a[e+3])}o&&i.set(o[l],o[l+1],o[l+2]),h.setTRS(s,n,i);for(let t=0;t<16;t++)e[c++]=h.data[t]}t.matrices=e}})})(0,e,o,f);const y=await Promise.all(n),b=((t,e,s)=>{if(!t.hasOwnProperty("materials")||0===t.materials.length)return[];const n=s?.material?.preprocess,i=s?.material?.process??Yy,r=s?.material?.postprocess;return t.materials.map(t=>{n&&n(t);const s=i(t,e);return r&&r(t,s),s})})(e,y.map(t=>t.resource),i),S=sb(t,e,l,f),x=[];for(let t=0;t<p.length;t++)x[t]=new hy,x[t].meshes=p[t];((t,e,s)=>{t.nodes.forEach(t=>{t.hasOwnProperty("mesh")&&t.hasOwnProperty("skin")&&e[t.mesh].meshes.forEach(e=>{e.skin=s[t.skin]})})})(e,x,S);const w=new Sy;return w.gltf=e,w.nodes=l,w.scenes=h,w.animations=v,w.textures=y,w.materials=b,w.variants=u,w.meshVariants=m,w.meshDefaultMaterials=g,w.renders=x,w.skins=S,w.lights=c,w.cameras=d,w.nodeInstancingMap=o,a&&a(e,w),await Promise.all(_),w};let rb=0;const ab=t=>t.extensions?.KHR_texture_basisu?.source??t.extensions?.EXT_texture_webp?.source??t.source,ob=(t,e,s)=>{t&&t.toLowerCase().endsWith(".glb")||(()=>{const t=new Uint8Array(e);return 103===t[0]&&108===t[1]&&84===t[2]&&70===t[3]})()?((t,e)=>{const s=t instanceof ArrayBuffer?new DataView(t):new DataView(t.buffer,t.byteOffset,t.byteLength),n=s.getUint32(0,!0),i=s.getUint32(4,!0),r=s.getUint32(8,!0);if(1179937895!==n)return void e(`Invalid magic number found in glb header. Expected 0x46546C67, found 0x${n.toString(16)}`);if(2!==i)return void e(`Invalid version number found in glb header. Expected 2, found ${i}`);if(r<=0||r>s.byteLength)return void e(`Invalid length found in glb header. Found ${r}`);const a=[];let o=12;for(;o<r;){const t=s.getUint32(o,!0);o+t+8>s.byteLength&&e(`Invalid chunk length found in glb. Found ${t}`);const n=s.getUint32(o+4,!0),i=new Uint8Array(s.buffer,s.byteOffset+o+8,t);a.push({length:t,type:n,data:i}),o+=t+8}1===a.length||2===a.length?1313821514===a[0].type?a.length>1&&5130562!==a[1].type?e(`Invalid chunk type found in glb file. Expected 0x004E4942, found 0x${a[1].type.toString(16)}`):e(null,{gltfChunk:a[0].data,binaryChunk:2===a.length?a[1].data:null}):e(`Invalid chunk type found in glb file. Expected 0x4E4F534A, found 0x${a[0].type.toString(16)}`):e("Invalid number of chunks found in glb file.")})(e,s):s(null,{gltfChunk:e,binaryChunk:null})};class lb{static parse(t,e,s,n,i,r,a){ob(t,s,(t,s)=>{t?a(t):((t,e)=>{const s=JSON.parse((t=>{if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(t);let e="";for(let s=0;s<t.length;s++)e+=String.fromCharCode(t[s]);return decodeURIComponent(escape(e))})(t));s.asset&&s.asset.version&&parseFloat(s.asset.version)<2?e(`Invalid gltf version. Expected version 2.0 or above but found version '${s.asset.version}'.`):e(null,s)})(s.gltfChunk,(t,o)=>{if(t)return void a(t);const l=((t,e,s,n)=>{if(!t.buffers||0===t.buffers.length)return[];const i=n?.buffer?.preprocess,r=n?.buffer?.processAsync,a=n?.buffer?.postprocess;return t.buffers.map((n,o)=>{let l;return i&&i(n),l=new Promise(r?(t,e)=>{r(n,(s,n)=>{s?e(s):t(n)})}:t=>{t(null)}),l=l.then(t=>{if(t)return t;if(n.hasOwnProperty("uri")){if(xy(n.uri)){const t=atob(n.uri.split(",")[1]),e=new Uint8Array(t.length);for(let s=0;s<t.length;s++)e[s]=t.charCodeAt(s);return e}return new Promise((t,e)=>{hl.get(Im.test(n.uri)?n.uri:Me.join(s,n.uri),{cache:!0,responseType:"arraybuffer",retry:!1},(s,n)=>{s?e(s):t(new Uint8Array(n))})})}return e}),a&&(l=l.then(e=>(a(t.buffers[o],e),e))),l})})(o,s.binaryChunk,e,r),h=((t,e,s)=>{const n=[],i=s?.bufferView?.preprocess,r=s?.bufferView?.processAsync,a=s?.bufferView?.postprocess;if(!t.bufferViews?.length)return n;for(let s=0;s<t.bufferViews.length;++s){const o=t.bufferViews[s];let l;i&&i(o),l=new Promise(r?(t,s)=>{r(o,e,(e,n)=>{e?s(e):t(n)})}:t=>{t(null)}),l=l.then(t=>t||e[o.buffer].then(t=>new Uint8Array(t.buffer,t.byteOffset+(o.byteOffset||0),o.byteLength))),o.hasOwnProperty("byteStride")&&(l=l.then(t=>(t.byteStride=o.byteStride,t))),a&&(l=l.then(t=>(a(o,t),t))),n.push(l)}return n})(o,l,r),c=((t,e,s,n,i)=>{if(!t.images||0===t.images.length)return[];const r=i?.image?.preprocess,a=i?.image?.processAsync,o=i?.image?.postprocess,l={"image/png":"png","image/jpeg":"jpg","image/basis":"basis","image/ktx":"ktx","image/ktx2":"ktx2","image/vnd-ms.dds":"dds"},h=(t,e,s,i,r,a)=>new Promise((o,h)=>{const c=s=>{const c=`${t.name||"gltf-texture"}-${rb++}`,d={url:e||c};if(s&&(d.contents=s.slice(0).buffer),i){const t=l[i];t&&(d.filename=`${d.url}.${t}`)}const u=new Fm(c,"texture",d,{srgb:a},r);u.on("load",t=>o(t)),u.on("error",t=>h(t)),n.add(u),n.load(u)};s?s.then(t=>c(t)):c(null)}),c=(t=>{const e=new Set;return t.hasOwnProperty("materials")&&t.materials.forEach(s=>{if(s.hasOwnProperty("pbrMetallicRoughness")){const n=s.pbrMetallicRoughness;if(n.hasOwnProperty("baseColorTexture")){const s=t.textures[n.baseColorTexture.index];e.add(ab(s))}}if(s.hasOwnProperty("emissiveTexture")){const n=t.textures[s.emissiveTexture.index];e.add(ab(n))}if(s.hasOwnProperty("extensions")){const n=s.extensions.KHR_materials_sheen;if(n&&n.hasOwnProperty("sheenColorTexture")){const s=t.textures[n.sheenColorTexture.index];e.add(ab(s))}const i=s.extensions.KHR_materials_pbrSpecularGlossiness;if(i&&i.hasOwnProperty("specularGlossinessTexture")){const s=t.textures[i.specularGlossinessTexture.index];e.add(ab(s))}const r=s.extensions.KHR_materials_specular;if(r&&r.hasOwnProperty("specularColorTexture")){const s=t.textures[r.specularColorTexture.index];e.add(ab(s))}}}),e})(t);return t.images.map((t,n)=>{let i;return r&&r(t),i=new Promise(a?(e,s)=>{a(t,(t,n)=>{t?s(t):e(n)})}:t=>{t(null)}),i=i.then(i=>{const r=c.has(n);return i||(t.hasOwnProperty("uri")?xy(t.uri)?h(t,t.uri,null,(a=t.uri).substring(a.indexOf(":")+1,a.indexOf(";")),null,r):h(t,Im.test(t.uri)?t.uri:Me.join(s,t.uri),null,null,{crossOrigin:"anonymous"},r):t.hasOwnProperty("bufferView")&&t.hasOwnProperty("mimeType")?h(t,null,e[t.bufferView],t.mimeType,null,r):Promise.reject(new Error(`Invalid image found in gltf (neither uri or bufferView found). index=${n}`)));var a}),o&&(i=i.then(e=>(o(t,e),e))),i})})(o,h,e,i,r),d=((t,e,s)=>{if(!t?.images?.length||!t?.textures?.length)return[];const n=s?.texture?.preprocess,i=s?.texture?.processAsync,r=s?.texture?.postprocess,a=new Set;return t.textures.map(s=>{let o;return n&&n(s),o=new Promise(i?(e,n)=>{i(s,t.images,(t,s)=>{t?n(t):e(s)})}:t=>{t(null)}),o=o.then(n=>{n=n??ab(s);const i=a.has(n);return a.add(n),e[n].then(e=>{const n=i?ky(e):e;return((t,e)=>{const s=(t,e)=>{switch(t){case 9728:return 0;case 9729:return 1;case 9984:return 2;case 9985:return 4;case 9986:return 3;case 9987:return 5;default:return e}},n=(t,e)=>{switch(t){case 33071:return 1;case 33648:return 2;case 10497:return 0;default:return e}};t&&(e=e??{},t.minFilter=s(e.minFilter,5),t.magFilter=s(e.magFilter,1),t.addressU=n(e.wrapS,0),t.addressV=n(e.wrapT,0))})(n.resource,(t.samplers??[])[s.sampler]),n})}),r&&(o=o.then(t=>(r(s,t),t))),o})})(o,c,r);ib(n,o,h,d,r).then(t=>a(null,t)).catch(t=>a(t))})})}static createDefaultMaterial(){return Yy({name:"defaultGlbMaterial"},[])}}class hb extends Gm{constructor(t){super(t,"animclip")}load(t,e){"string"==typeof t&&(t={load:t,original:t});const s={retry:this.maxRetries>0,maxRetries:this.maxRetries};t.load.startsWith("blob:")&&(s.responseType=ll.ResponseType.JSON),hl.get(t.load,s,(s,n)=>{s?e(`Error loading animation clip resource: ${t.original} [${s}]`):e(null,n)})}open(t,e){const s=e.name,n=e.duration,i=e.inputs.map(t=>new my(1,t)),r=e.outputs.map(t=>new my(t.components,t.data)),a=e.curves.map(t=>new py([t.path],t.inputIndex,t.outputIndex,t.interpolation));return new Hg(s,n,i,r,a)}}class cb extends Gm{constructor(t){super(t,"animstategraph")}load(t,e){"string"==typeof t&&(t={load:t,original:t});const s={retry:this.maxRetries>0,maxRetries:this.maxRetries};t.load.startsWith("blob:")&&(s.responseType=ll.ResponseType.JSON),hl.get(t.load,s,(s,n)=>{s?e(`Error loading animation state graph resource: ${t.original} [${s}]`):e(null,n)})}open(t,e){return new l_(e)}}class db extends Gm{constructor(t){super(t,"binary")}load(t,e){"string"==typeof t&&(t={load:t,original:t}),hl.get(t.load,{responseType:ll.ResponseType.ARRAY_BUFFER,retry:this.maxRetries>0,maxRetries:this.maxRetries},(s,n)=>{s?e(`Error loading binary resource: ${t.original} [${s}]`):e(null,n)})}openBinary(t){return t.buffer}}class ub{constructor(t,e,s,n){const i=function(t,n,i){const r=ub.createAsset(e.name,t,n,i);return s.add(r),r},r=[];for(let e=0;e<t.renders.length;++e)r.push(i("render",t.renders[e],e));const a=[];for(let e=0;e<t.materials.length;++e)a.push(i("material",t.materials[e],e));const o=[];for(let e=0;e<t.animations.length;++e)o.push(i("animation",t.animations[e],e));this.data=t,this._model=null,this._assetName=e.name,this._assets=s,this._defaultMaterial=n,this.renders=r,this.materials=a,this.textures=t.textures,this.animations=o}get model(){if(!this._model){const t=ub.createModel(this.data,this._defaultMaterial),e=ub.createAsset(this._assetName,"model",t,0);this._assets.add(e),this._model=e}return this._model}static createAsset(t,e,s,n){const i=new Fm(`${t}/${e}/${n}`,e,{url:""});return i.resource=s,i.loaded=!0,i}instantiateModelEntity(t){const e=new Jm(void 0,this._assets._loader._app);return e.addComponent("model",Object.assign({type:"asset",asset:this.model},t)),e}instantiateRenderEntity(t){const e=this._defaultMaterial,s=[],n=function(t,n,i,r,a,o,l,h){const c=a[i.id],d=void 0===c?e:r[c],u=new fc(i,d);i.morph&&(u.morphInstance=new Xu(i.morph)),l.hasOwnProperty("skin")&&s.push({meshInstance:u,rootBone:t,entity:n});const f=h.get(l);if(f){const t=f.matrices,e=Ui.getDefaultInstancingFormat(i.device),s=new ki(i.device,e,t.length/16,{data:t});u.setInstancing(s),u.instancingData._destroyVertexBuffer=!0}return u},i=(e,s,r)=>{const a=new Jm(void 0,this._assets._loader._app);s._cloneInternal(a),e||(e=a);let o=null,l=null;for(let t=0;t<r.nodes.length;t++){if(r.nodes[t]===s){const s=r.gltf.nodes[t];if(s.hasOwnProperty("mesh")){const t=r.renders[s.mesh].meshes;l=this.renders[s.mesh];for(let i=0;i<t.length;i++){const l=t[i];if(l){const t=n(e,a,l,r.materials,r.meshDefaultMaterials,r.skins,s,r.nodeInstancingMap);o||(o=[]),o.push(t)}}}if(r.lights){const t=r.lights.get(s);t&&a.addChild(t.clone())}if(r.cameras){const t=r.cameras.get(s);t&&t.camera.system.cloneComponent(t,a)}}}o&&(a.addComponent("render",Object.assign({type:"asset",meshInstances:o},t)),a.render.assignAsset(l));const h=s.children;for(let t=0;t<h.length;t++){const s=i(e,h[t],r);a.addChild(s)}return a},r=[];for(const t of this.data.scenes)r.push(i(null,t,this.data));return s.forEach(t=>{t.meshInstance.skinInstance=b_.createCachedSkinInstance(t.meshInstance.mesh.skin,t.rootBone,t.entity),t.meshInstance.node.render.rootBone=t.rootBone}),ub.createSceneHierarchy(r,Jm)}getMaterialVariants(){return this.data.variants?Object.keys(this.data.variants):[]}applyMaterialVariant(t,e){const s=e?this.data.variants[e]:null;if(void 0===s)return;const n=t.findComponents("render");for(let t=0;t<n.length;t++){const e=n[t];this._applyMaterialVariant(s,e.meshInstances)}}applyMaterialVariantInstances(t,e){const s=e?this.data.variants[e]:null;void 0!==s&&this._applyMaterialVariant(s,t)}_applyMaterialVariant(t,e){e.forEach(e=>{if(null===t)e.material=this._defaultMaterial;else{const s=this.data.meshVariants[e.mesh.id];s&&(e.material=this.data.materials[s[t]])}})}static createSceneHierarchy(t,e){let s=null;if(1===t.length)s=t[0];else{s=new e("SceneGroup");for(const e of t)s.addChild(e)}return s}static createModel(t,e){const s=function(s,n,i,r,a,o,l){const h=t.meshDefaultMaterials[n.id],c=void 0===h?e:a[h],d=new fc(n,c,o);if(n.morph){const t=new Xu(n.morph);d.morphInstance=t,s.morphInstances.push(t)}if(l.hasOwnProperty("skin")){const t=l.skin,e=i[t];n.skin=e;const a=r[t];d.skinInstance=a,s.skinInstances.push(a)}s.meshInstances.push(d)},n=new qu,i=[];for(const e of t.skins){const t=new Yh(e);t.bones=e.bones,i.push(t)}n.graph=ub.createSceneHierarchy(t.scenes,Hc);for(let e=0;e<t.nodes.length;e++){const r=t.nodes[e];if(r.root===n.graph){const a=t.gltf.nodes[e];if(a.hasOwnProperty("mesh")){const e=t.renders[a.mesh].meshes;for(let o=0;o<e.length;o++){const l=e[o];l&&s(n,l,t.skins,i,t.materials,r,a)}}}}return n}destroy(){const t=this._assets,e=function(e){t.remove(e),e.unload()},s=function(t){t.forEach(t=>{e(t)})};this.animations&&(s(this.animations),this.animations=null),this.textures&&(s(this.textures),this.textures=null),this.materials&&(s(this.materials),this.materials=null),this.renders&&(s(this.renders),this.renders=null),this._model&&(e(this._model),this._model=null),this.data=null,this.assets=null}}class fb{constructor(t,e,s){this._device=t,this._assets=e,this._defaultMaterial=lb.createDefaultMaterial(),this.maxRetries=s}_getUrlWithoutParams(t){return t.indexOf("?")>=0?t.split("?")[0]:t}load(t,e,s){Fm.fetchArrayBuffer(t.load,(n,i)=>{n?e(n):lb.parse(this._getUrlWithoutParams(t.original),Me.extractPath(t.load),i,this._device,s.registry,s.options,(t,n)=>{t?e(t):e(null,new ub(n,s,this._assets,this._defaultMaterial))})},s,this.maxRetries)}open(t,e,s){return e}patch(t,e){}}class pb extends Gm{constructor(t){super(t,"container"),this.glbContainerParser=new fb(t.graphicsDevice,t.assets,0),this.parsers={}}set maxRetries(t){this.glbContainerParser.maxRetries=t;for(const e in this.parsers)this.parsers.hasOwnProperty(e)&&(this.parsers[e].maxRetries=t)}get maxRetries(){return this.glbContainerParser.maxRetries}_getUrlWithoutParams(t){return t.indexOf("?")>=0?t.split("?")[0]:t}_getParser(t){const e=t?Me.getExtension(this._getUrlWithoutParams(t)).toLowerCase().replace(".",""):null;return this.parsers[e]||this.glbContainerParser}load(t,e,s){"string"==typeof t&&(t={load:t,original:t}),this._getParser(t.original).load(t,e,s)}open(t,e,s){return this._getParser(t).open(t,e,s)}}class mb extends Gm{constructor(t){super(t,"cubemap"),this._device=t.graphicsDevice,this._registry=t.assets,this._loader=t.loader}load(t,e,s){this.loadAssets(s,e)}open(t,e,s){return s?s.resource:null}patch(t,e){this.loadAssets(t,(s,n)=>{s&&(e.fire("error",t),e.fire(`error:${t.id}`,s,t),t.fire("error",t))})}getAssetIds(t){const e=[];if(e[0]=t.file,(t.loadFaces||!t.file)&&t.data&&t.data.textures)for(let s=0;s<6;++s)e[s+1]=t.data.textures[s];else e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=null;return e}compareAssetIds(t,e){return t&&e?parseInt(t,10)===t||"string"==typeof t?t===e:t.url===e.url:null!==t==(null!==e)}update(t,e,s){const n=t.data||{},i=t._handlerState.assets,r=t._resources;let a,o,l;const h=[null,null,null,null,null,null,null],c=function(){return n.hasOwnProperty("type")?n.type:n.hasOwnProperty("rgbm")?n.rgbm?bn:yn:null};if(t.loaded&&s[0]===i[0])h[1]=r[1]||null,h[2]=r[2]||null,h[3]=r[3]||null,h[4]=r[4]||null,h[5]=r[5]||null,h[6]=r[6]||null;else if(s[0])if(a=s[0].resource,a.cubemap)for(l=0;l<6;++l)h[l+1]=new pi(this._device,{name:`${t.name}_prelitCubemap${a.width>>l}`,cubemap:!0,type:c()||a.type,width:a.width>>l,height:a.height>>l,format:a.format,levels:[a._levels[l]],addressU:1,addressV:1,mipmaps:0===l});else h[1]=a;const d=s.slice(1);if(t.loaded&&this.cmpArrays(d,i.slice(1)))h[0]=r[0]||null;else if(-1===d.indexOf(null)){const e=d.map(t=>t.resource),s=[];for(o=0;o<e[0]._levels.length;++o)s.push(e.map(t=>t._levels[o]));const i=e[0].format,r=new pi(this._device,{name:`${t.name}_faces`,cubemap:!0,type:c()||e[0].type,width:e[0].width,height:e[0].height,format:6===i?7:i,mipmaps:n.mipmaps??!0,levels:s,minFilter:n.hasOwnProperty("minFilter")?n.minFilter:e[0].minFilter,magFilter:n.hasOwnProperty("magFilter")?n.magFilter:e[0].magFilter,anisotropy:n.hasOwnProperty("anisotropy")?n.anisotropy:1,addressU:1,addressV:1});h[0]=r}if(!this.cmpArrays(h,r))for(t.resources=h,t._handlerState.assetIds=e,t._handlerState.assets=s,l=0;l<r.length;++l)null!==r[l]&&-1===h.indexOf(r[l])&&r[l].destroy();for(l=0;l<i.length;++l)null!==i[l]&&-1===s.indexOf(i[l])&&i[l].unload()}cmpArrays(t,e){if(t.length!==e.length)return!1;for(let s=0;s<t.length;++s)if(t[s]!==e[s])return!1;return!0}resolveId(t){const e=parseInt(t,10);return e===t||e.toString()===t?e:t}loadAssets(t,e){t.hasOwnProperty("_handlerState")||(t._handlerState={assetIds:[null,null,null,null,null,null,null],assets:[null,null,null,null,null,null,null]});const s=this,n=s.getAssetIds(t),i=[null,null,null,null,null,null,null],r=t._handlerState.assetIds,a=t._handlerState.assets,o=s._registry;let l=7;const h=function(r,a){i[r]=a,l--,0===l&&(s.update(t,n,i),e(null,t.resources))},c=function(t,s,n){e(s)},d=function(t,e){e.loaded?h(t,e):(o.once(`load:${e.id}`,h.bind(s,t)),o.once(`error:${e.id}`,c.bind(s,t)),e.loading||o.load(e))};let u;for(let e=0;e<7;++e){const i=this.resolveId(n[e]);if(i)if(s.compareAssetIds(i,r[e]))d(e,a[e]);else if(parseInt(i,10)===i)u=o.get(i),u?d(e,u):setTimeout(((t,e)=>{const s=o.get(e);s?d(t,s):c(0,`failed to find dependent cubemap asset=${e}`)}).bind(null,e,i));else{const s="string"==typeof i?{url:i,filename:i}:i,n=-1===s.url.search(".dds")?{type:"rgbp",addressu:"clamp",addressv:"clamp",mipmaps:!1}:null;u=new Fm(`${t.name}_part_${e}`,"texture",s,n),o.add(u),d(e,u)}else h(e,null)}}}const gb=.28209479177387814;class _b{constructor(t,e,s,n,i,r){const a=(t,e)=>{const s=(1<<e)-1;return(t&s)/s},o=(t,e)=>{t.x=a(e>>>21,11),t.y=a(e>>>11,10),t.z=a(e,11)},l=(t,e,s)=>t*(1-s)+e*s,{chunkData:h,chunkSize:c,vertexData:d,shData0:u,shData1:f,shData2:p,shBands:m}=t,g=[3,8,15][m-1];this.read=t=>{const _=Math.floor(t/256)*c;var v,y;if(e&&(o(e,d[4*t+0]),e.x=l(h[_+0],h[_+3],e.x),e.y=l(h[_+1],h[_+4],e.y),e.z=l(h[_+2],h[_+5],e.z)),s&&((t,e)=>{const s=Math.SQRT2,n=(a(e>>>20,10)-.5)*s,i=(a(e>>>10,10)-.5)*s,r=(a(e,10)-.5)*s,o=Math.sqrt(1-(n*n+i*i+r*r));switch(e>>>30){case 0:t.set(n,i,r,o);break;case 1:t.set(o,i,r,n);break;case 2:t.set(i,o,r,n);break;case 3:t.set(i,r,o,n)}})(s,d[4*t+1]),n&&(o(n,d[4*t+2]),n.x=l(h[_+6],h[_+9],n.x),n.y=l(h[_+7],h[_+10],n.y),n.z=l(h[_+8],h[_+11],n.z)),i&&(v=i,y=d[4*t+3],v.x=a(y>>>24,8),v.y=a(y>>>16,8),v.z=a(y>>>8,8),v.w=a(y,8),c>12&&(i.x=l(h[_+12],h[_+15],i.x),i.y=l(h[_+13],h[_+16],i.y),i.z=l(h[_+14],h[_+17],i.z))),r&&m>0){const e=[u,f,p];for(let s=0;s<3;++s)for(let n=0;n<15;++n)r[15*s+n]=n<g?e[s][16*t+n]*(8/255)-4:0}}}}class vb{createIter(t,e,s,n,i){return new _b(this,t,e,s,n,i)}calcAabb(t){const{chunkData:e,numChunks:s,chunkSize:n}=this;let i=Math.exp(Math.max(e[9],e[10],e[11])),r=e[0]-i,a=e[1]-i,o=e[2]-i,l=e[3]+i,h=e[4]+i,c=e[5]+i;for(let t=1;t<s;++t){const s=t*n;i=Math.exp(Math.max(e[s+9],e[s+10],e[s+11])),r=Math.min(r,e[s+0]-i),a=Math.min(a,e[s+1]-i),o=Math.min(o,e[s+2]-i),l=Math.max(l,e[s+3]+i),h=Math.max(h,e[s+4]+i),c=Math.max(c,e[s+5]+i)}return t.center.set(.5*(r+l),.5*(a+h),.5*(o+c)),t.halfExtents.set(.5*(l-r),.5*(h-a),.5*(c-o)),!0}getCenters(){const{vertexData:t,chunkData:e,numChunks:s,chunkSize:n}=this,i=new Float32Array(3*this.numSplats);let r,a,o,l,h,c;for(let d=0;d<s;++d){const s=d*n;r=e[s+0],a=e[s+1],o=e[s+2],l=e[s+3],h=e[s+4],c=e[s+5];const u=Math.min(this.numSplats,256*(d+1));for(let e=256*d;e<u;++e){const s=t[4*e],n=(s>>>21)/2047,d=(s>>>11&1023)/1023,u=(2047&s)/2047;i[3*e+0]=(1-n)*r+n*l,i[3*e+1]=(1-d)*a+d*h,i[3*e+2]=(1-u)*o+u*c}}return i}getChunks(t){const{chunkData:e,numChunks:s,chunkSize:n}=this;let i,r,a,o,l,h;for(let c=0;c<s;++c){const s=c*n;i=e[s+0],r=e[s+1],a=e[s+2],o=e[s+3],l=e[s+4],h=e[s+5],t[6*c+0]=i,t[6*c+1]=r,t[6*c+2]=a,t[6*c+3]=o,t[6*c+4]=l,t[6*c+5]=h}}calcFocalPoint(t){const{chunkData:e,numChunks:s,chunkSize:n}=this;t.x=0,t.y=0,t.z=0;for(let i=0;i<s;++i){const s=i*n;t.x+=e[s+0]+e[s+3],t.y+=e[s+1]+e[s+4],t.z+=e[s+2]+e[s+5]}t.mulScalar(.5/s)}get isCompressed(){return!0}get numChunks(){return Math.ceil(this.numSplats/256)}get chunkSize(){return this.chunkData.length/this.numChunks}decompress(){const t=["x","y","z","f_dc_0","f_dc_1","f_dc_2","opacity","scale_0","scale_1","scale_2","rot_0","rot_1","rot_2","rot_3"],{shBands:e}=this;if(e>0){const e=[];for(let t=0;t<45;++t)e.push(`f_rest_${t}`);const s=Math.max(...["f_dc_0","f_dc_1","f_dc_2"].map(e=>t.indexOf(e)));t.splice(s+1,0,...e)}const s={};t.forEach(t=>{s[t]=new Float32Array(this.numSplats)});const n=new rs,i=new ms,r=new rs,a=new ls,o=e>0?new Float32Array(45):null,l=this.createIter(n,i,r,a,o);for(let t=0;t<this.numSplats;++t)if(l.read(t),s.x[t]=n.x,s.y[t]=n.y,s.z[t]=n.z,s.rot_1[t]=i.x,s.rot_2[t]=i.y,s.rot_3[t]=i.z,s.rot_0[t]=i.w,s.scale_0[t]=r.x,s.scale_1[t]=r.y,s.scale_2[t]=r.z,s.f_dc_0[t]=(a.x-.5)/gb,s.f_dc_1[t]=(a.y-.5)/gb,s.f_dc_2[t]=(a.z-.5)/gb,s.opacity[t]=a.w<=0?-40:a.w>=1?40:-Math.log(1/a.w-1),o)for(let e=0;e<45;++e)s[`f_rest_${e}`][t]=o[e];return new Np([{name:"vertex",count:this.numSplats,properties:t.map(t=>({name:t,type:"float",byteSize:4,storage:s[t]}))}],this.comments)}}class yb extends Xp{constructor(t,e){super(t,e);const{chunkData:s,chunkSize:n,numChunks:i,numSplats:r,vertexData:a,shBands:o}=e;this.chunks=new Float32Array(6*i),e.getChunks(this.chunks),this.packedTexture=this.createTexture("packedData",Hs,this.evalTextureSize(r),a);const l=this.evalTextureSize(i);l.x*=5,this.chunkTexture=this.createTexture("chunkData",Is,l);const h=this.chunkTexture.lock();if(((t,e,s,n,i)=>{for(let r=0;r<i;++r)for(let i=0;i<n;++i)t[r*e+i]=s[r*n+i]})(h,20,s,n,i),12===n)for(let t=0;t<i;++t)h[20*t+15]=1,h[20*t+16]=1,h[20*t+17]=1;if(this.chunkTexture.unlock(),o>0){const t=this.evalTextureSize(r);this.shTexture0=this.createTexture("shTexture0",Hs,t,new Uint32Array(e.shData0.buffer)),this.shTexture1=this.createTexture("shTexture1",Hs,t,new Uint32Array(e.shData1.buffer)),this.shTexture2=this.createTexture("shTexture2",Hs,t,new Uint32Array(e.shData2.buffer))}else this.shTexture0=null,this.shTexture1=null,this.shTexture2=null}destroy(){this.packedTexture?.destroy(),this.chunkTexture?.destroy(),this.shTexture0?.destroy(),this.shTexture1?.destroy(),this.shTexture2?.destroy(),super.destroy()}configureMaterialDefines(t){t.set("GSPLAT_COMPRESSED_DATA",!0),t.set("SH_BANDS",this.shTexture0?3:0)}configureMaterial(t){this.configureMaterialDefines(t.defines),t.setParameter("packedTexture",this.packedTexture),t.setParameter("chunkTexture",this.chunkTexture),this.shTexture0&&(t.setParameter("shTexture0",this.shTexture0),t.setParameter("shTexture1",this.shTexture1),t.setParameter("shTexture2",this.shTexture2))}evalTextureSize(t){const e=Math.ceil(Math.sqrt(t)),s=Math.ceil(t/e);return new os(e,s)}}const bb=new Uint8Array([112,108,121,10]),Sb=new Uint8Array([10,101,110,100,95,104,101,97,100,101,114,10]),xb=new Map([["char",Int8Array],["uchar",Uint8Array],["short",Int16Array],["ushort",Uint16Array],["int",Int32Array],["uint",Uint32Array],["float",Float32Array],["double",Float64Array]]);class wb{constructor(t,e){this.head=0,this.tail=0,this.reader=t,this.progressFunc=e}async read(){const{value:t,done:e}=await this.reader.read();if(e)throw new Error("Stream finished before end of header");this.push(t),this.progressFunc?.(t.byteLength)}push(t){if(this.data){const e=this.tail-this.head,s=e+t.length;if(this.data.length>=s)this.head>0?(this.data.copyWithin(0,this.head,this.tail),this.data.set(t,e),this.head=0,this.tail=s):(this.data.set(t,this.tail),this.tail+=t.length);else{const n=new Uint8Array(s);this.head>0||this.tail<this.data.length?n.set(this.data.subarray(this.head,this.tail),0):n.set(this.data,0),n.set(t,e),this.data=n,this.view=new DataView(this.data.buffer),this.head=0,this.tail=s}}else this.data=t,this.view=new DataView(this.data.buffer),this.tail=t.length}compact(){this.head>0&&(this.data.copyWithin(0,this.head,this.tail),this.tail-=this.head,this.head=0)}get remaining(){return this.tail-this.head}getInt8(){const t=this.view.getInt8(this.head);return this.head++,t}getUint8(){const t=this.view.getUint8(this.head);return this.head++,t}getInt16(){const t=this.view.getInt16(this.head,!0);return this.head+=2,t}getUint16(){const t=this.view.getUint16(this.head,!0);return this.head+=2,t}getInt32(){const t=this.view.getInt32(this.head,!0);return this.head+=4,t}getUint32(){const t=this.view.getUint32(this.head,!0);return this.head+=4,t}getFloat32(){const t=this.view.getFloat32(this.head,!0);return this.head+=4,t}getFloat64(){const t=this.view.getFloat64(this.head,!0);return this.head+=8,t}}const Tb=async(t,e=null,s=null)=>{const n=(t,e)=>{const s=t.length-e.length;let n,i;for(n=0;n<=s;++n){for(i=0;i<e.length&&t[n+i]===e[i];++i);if(i===e.length)return n}return-1},i=(t,e)=>{if(t.length<e.length)return!1;for(let s=0;s<e.length;++s)if(t[s]!==e[s])return!1;return!0},r=new wb(t,s);let a;for(;;){if(await r.read(),r.tail>=bb.length&&!i(r.data,bb))throw new Error("Invalid ply header");if(a=n(r.data,Sb),-1!==a)break}const o=new TextDecoder("ascii").decode(r.data.subarray(0,a)).split("\n"),{elements:l,format:h,comments:c}=(t=>{const e=[],s=[];let n;for(let i=1;i<t.length;++i){const r=t[i].split(" ");switch(r[0]){case"comment":s.push(r.slice(1).join(" "));break;case"format":n=r[1];break;case"element":e.push({name:r[1],count:parseInt(r[2],10),properties:[]});break;case"property":if(!xb.has(r[1]))throw new Error(`Unrecognized property data type '${r[1]}' in ply header`);e[e.length-1].properties.push({type:r[1],name:r[2],storage:null,byteSize:xb.get(r[1]).BYTES_PER_ELEMENT});break;default:throw new Error(`Unrecognized header value '${r[0]}' in ply header`)}}return{elements:e,format:n,comments:s}})(o);if("binary_little_endian"!==h)throw new Error("Unsupported ply format");r.head=a+Sb.length,r.compact();return await(async()=>(t=>{const e=["min_x","min_y","min_z","max_x","max_y","max_z","min_scale_x","min_scale_y","min_scale_z","max_scale_x","max_scale_y","max_scale_z","min_r","min_g","min_b","max_r","max_g","max_b"],s=["packed_position","packed_rotation","packed_scale","packed_color"],n=new Array(45).fill("").map((t,e)=>`f_rest_${e}`),i=()=>"chunk"===t[0].name&&t[0].properties.every((t,s)=>t.name===e[s]&&"float"===t.type)&&"vertex"===t[1].name&&t[1].properties.every((t,e)=>t.name===s[e]&&"uint"===t.type);return 2===t.length&&i()||3===t.length&&i()&&"sh"===t[2].name&&-1!==[9,24,45].indexOf(t[2].properties.length)&&t[2].properties.every((t,e)=>t.name===n[e]&&"uchar"===t.type)})(l)?await(async(t,e,s)=>{const n=new vb;n.comments=s;const i=e[0].count,r=e[0].properties.length,a=e[1].count,o=(t=>{const e=Math.ceil(Math.sqrt(t));return e*Math.ceil(t/e)})(a);n.numSplats=a,n.chunkData=new Float32Array(i*r),n.vertexData=new Uint32Array(4*o);const l=async(e,s)=>{const n=new Uint8Array(e);let i=0;for(;i<s;){for(;0===t.remaining;)await t.read();const e=Math.min(s-i,t.remaining),r=t.data;for(let s=0;s<e;++s)n[i++]=r[t.head++]}};if(await l(n.chunkData.buffer,i*r*4),await l(n.vertexData.buffer,4*a*4),3===e.length){const t=16*o,s=new Uint8Array(t),i=new Uint8Array(t),r=new Uint8Array(t),a=1024,h=e[2].properties.length/3,c=new Uint8Array(a*h*3);for(let t=0;t<n.numSplats;t+=a){const e=Math.min(a,n.numSplats-t);await l(c.buffer,e*h*3);for(let n=0;n<e;++n)for(let e=0;e<15;++e){const a=16*(t+n)+e;e<h?(s[a]=c[(3*n+0)*h+e],i[a]=c[(3*n+1)*h+e],r[a]=c[(3*n+2)*h+e]):(s[a]=127,i[a]=127,r[a]=127)}}n.shData0=s,n.shData1=i,n.shData2=r,n.shBands={3:1,8:2,15:3}[h]}else n.shBands=0;return n})(r,l,c):(l.forEach(t=>{t.properties.forEach(s=>{const n=xb.get(s.type);if(n){const i=!e||e(s.name)?new n(t.count):null;s.storage=i}})}),(t=>1===t.length&&"vertex"===t[0].name&&t[0].properties.every(t=>"float"===t.type))(l)?await(async(t,e,s)=>{const n=e[0],i=n.properties,r=i.length,a=i.map(t=>t.storage),o=i.reduce((t,e)=>t+e.byteSize,0);let l,h=0;const c=()=>{const e=t.data.buffer;l?.buffer!==e&&(l=new Float32Array(e,0,e.byteLength/4))};for(c();h<n.count;){for(;t.remaining<o;)await t.read(),c();const e=Math.min(n.count-h,Math.floor(t.remaining/o));for(let t=0;t<r;++t){const s=a[t];for(let n=0;n<e;++n)s[n+h]=l[n*r+t]}h+=e,t.head+=e*o}return new Np(e,s)})(r,l,c):await(async(t,e,s)=>{for(let s=0;s<e.length;++s){const n=e[s],i=n.properties.reduce((t,e)=>t+e.byteSize,0),r=n.properties.map(t=>{if(!t.storage)return e=>{e.head+=t.byteSize};switch(t.type){case"char":return(e,s)=>{t.storage[s]=e.getInt8()};case"uchar":return(e,s)=>{t.storage[s]=e.getUint8()};case"short":return(e,s)=>{t.storage[s]=e.getInt16()};case"ushort":return(e,s)=>{t.storage[s]=e.getUint16()};case"int":return(e,s)=>{t.storage[s]=e.getInt32()};case"uint":return(e,s)=>{t.storage[s]=e.getUint32()};case"float":return(e,s)=>{t.storage[s]=e.getFloat32()};case"double":return(e,s)=>{t.storage[s]=e.getFloat64()};default:throw new Error(`Unsupported property data type '${t.type}' in ply header`)}});let a=0;for(;a<n.count;){for(;t.remaining<i;)await t.read();const e=Math.min(n.count-a,Math.floor(t.remaining/i));for(let s=0;s<e;++s){for(let e=0;e<n.properties.length;++e)r[e](t,a);a++}}}return new Np(e,s)})(r,l,c)))()},Cb=t=>!0;class Eb{constructor(t,e){this.app=t,this.maxRetries=e}async load(t,e,s){try{const n=await(s.file?.contents??fetch(t.load));if(n&&n.body){const t=parseInt(n.headers.get("content-length")??"0",10);let i=0;const r=await Tb(n.body.getReader(),s.data.elementFilter??Cb,e=>{i+=e,s&&s.fire("progress",i,t)});s.fire("load:data",r),r.isCompressed||(s.data.reorder??1)&&r.reorderData();e(null,r.isCompressed&&!s.data.decompress?new yb(this.app.graphicsDevice,r):new qp(this.app.graphicsDevice,r.isCompressed?r.decompress():r))}else e("Error loading resource",null)}catch(t){e(t,null)}}open(t,e){return e}}const Ab=(t,e)=>{const s=new Map;e.forEach(e=>{const n=(n,i)=>{s.set(e,{loaded:n,total:i}),(()=>{let e=0,n=0;s.forEach(t=>{e+=t.loaded,n+=t.total}),t.fire("progress",e,n)})()},i=()=>{e.off("progress",n),e.off("load",i),e.off("error",i)};e.on("progress",n),e.on("load",i),e.on("error",i)})};class Db{constructor(t,e){this.app=t,this.maxRetries=e}_shouldAbort(t,e){return!(!e&&this.app.assets.get(t.id))||!(this.app?.graphicsDevice&&!this.app.graphicsDevice._destroyed)}async loadTextures(t,e,s,n){2!==n.version&&(n=(t=>{const e={version:1,count:t.means.shape[0],means:{mins:t.means.mins,maxs:t.means.maxs,files:t.means.files},scales:{mins:t.scales.mins,maxs:t.scales.maxs,files:t.scales.files},quats:{files:t.quats.files},sh0:{mins:t.sh0.mins,maxs:t.sh0.maxs,files:t.sh0.files}};return t.shN&&(e.shN={mins:t.shN.mins,maxs:t.shN.maxs,files:t.shN.files}),e})(n));const{assets:i}=this.app,r=["means","quats","scales","sh0","shN"],a={},o=[];r.forEach(e=>{const r=n[e]?.files??[];a[e]=r.map(e=>{const n=new Fm(e,"texture",{url:s.options?.mapUrl?.(e)??new URL(e,new URL(t.load,window.location.href).toString()).toString(),filename:e},{mipmaps:!1},{crossOrigin:"anonymous"}),r=new Promise((t,e)=>{n.on("load",()=>t(null)),n.on("error",t=>e(t))});return i.add(n),o.push(r),n})});const l=r.map(t=>a[t]).flat();let h=!1;if(s.once("unload",()=>{h=!0,l.forEach(t=>{i.remove(t),t.unload()})}),Ab(s,l),l.forEach(t=>i.load(t)),await Promise.allSettled(o),this._shouldAbort(s,h))return l.forEach(t=>{i.remove(t),t.unload()}),void e(null,null);const c=new om;c.url=t.original,c.meta=n,c.numSplats=n.count,c.means_l=a.means[0].resource,c.means_u=a.means[1].resource,c.quats=a.quats[0].resource,c.scales=a.scales[0].resource,c.sh0=a.sh0[0].resource,c.sh_centroids=a.shN?.[0]?.resource,c.sh_labels=a.shN?.[1]?.resource,c.shBands=om.calcBands(c.sh_centroids?.width);const d=s.data?.decompress,u=s.options?.minimalMemory??!1;if(c.minimalMemory=u,!d){if(this._shouldAbort(s,h))return c.destroy(),void e(null,null);await c.prepareGpuData()}if(this._shouldAbort(s,h))return c.destroy(),void e(null,null);const f=d?new qp(this.app.graphicsDevice,await c.decompress()):new fm(this.app.graphicsDevice,c);if(this._shouldAbort(s,h))return f.destroy(),void e(null,null);e(null,f)}load(t,e,s){if(s.data?.means)this.loadTextures(t,e,s,s.data);else{"string"==typeof t&&(t={load:t,original:t});const n={retry:this.maxRetries>0,maxRetries:this.maxRetries,responseType:ll.ResponseType.JSON};hl.get(t.load,n,(n,i)=>{this._shouldAbort(s,!1)?e(null,null):n?e(`Error loading gsplat meta: ${t.original} [${n}]`):this.loadTextures(t,e,s,i)})}}}const Pb=async t=>{const e=new DecompressionStream("deflate-raw"),s=new Blob([t]).stream().pipeThrough(e),n=await new Response(s).arrayBuffer();return new Uint8Array(n)};class Lb{constructor(t,e=3){this.app=t,this.maxRetries=e}async load(t,e,s){try{const n=await(async(t,e)=>{const s=await(e.file?.contents??fetch(t.load));if(!s)throw new Error("Error loading resource");if(s instanceof Response){if(!s.ok)throw new Error(`Error loading resource: ${s.status} ${s.statusText}`);const t=parseInt(s.headers.get("content-length")??"0",10);if(!s.body||!s.body.getReader){const n=await s.arrayBuffer();return e.fire("progress",n.byteLength,t),n}const n=s.body.getReader(),i=[];let r=0;try{for(;;){const{done:s,value:a}=await n.read();if(s)break;i.push(a),r+=a.byteLength,e.fire("progress",r,t)}}finally{n.releaseLock()}return new Blob(i).arrayBuffer()}return s})(t,s),i=(t=>{const e=new DataView(t),s=t=>e.getUint16(t,!0),n=t=>e.getUint32(t,!0),i=e=>{const i=s(e+28),r=s(e+30),a=s(e+32);return{magic:n(e),compressionMethod:s(e+10),compressedSizeBytes:n(e+20),uncompressedSizeBytes:n(e+24),lfhOffsetBytes:n(e+42),filename:(new TextDecoder).decode(new Uint8Array(t,e+46,i)),recordSizeBytes:46+i+r+a}},r=t=>{const e=s(t+26),i=s(t+28);return{magic:n(t),offsetBytes:t+30+e+i}},a=(t=>({magic:n(t),numFiles:s(t+8),cdSizeBytes:n(t+12),cdOffsetBytes:n(t+16)}))(e.byteLength-22);if(101010256!==a.magic)throw new Error("Invalid zip file: EOCDR not found");if(4294967295===a.cdOffsetBytes||4294967295===a.cdSizeBytes)throw new Error("Invalid zip file: Zip64 not supported");const o=[];let l=a.cdOffsetBytes;for(let e=0;e<a.numFiles;e++){const e=i(l);if(33639248!==e.magic)throw new Error("Invalid zip file: CDR not found");const s=r(e.lfhOffsetBytes);if(67324752!==s.magic)throw new Error("Invalid zip file: LFH not found");o.push({filename:e.filename,compression:{0:"none",8:"deflate"}[e.compressionMethod]??"unknown",data:new Uint8Array(t,s.offsetBytes,e.compressedSizeBytes)}),l+=e.recordSizeBytes}return o})(n);for(const t of i)"deflate"===t.compression&&(t.data=await Pb(t.data));const r=i.find(t=>"meta.json"===t.filename);if(!r)return void e("Error: meta.json not found");let a;try{a=JSON.parse((new TextDecoder).decode(r.data))}catch(t){return void e(`Error parsing meta.json: ${t}`)}const o=["means","scales","quats","sh0","shN"].map(t=>a[t]?.files??[]).flat(),l={},h=[];for(const e of o){const s=i.find(t=>t.filename===e);let n;if(s)n=new Fm(e,"texture",{url:`${t.load}/${e}`,filename:e,contents:s.data},{mipmaps:!1},{crossOrigin:"anonymous"});else{const t=new URL(e,new URL(e,window.location.href).toString()).toString();n=new Fm(e,"texture",{url:t,filename:e},{mipmaps:!1},{crossOrigin:"anonymous"})}const r=new Promise((t,e)=>{n.on("load",()=>t(null)),n.on("error",t=>e(t))});this.app.assets.add(n),l[e]=n,h.push(r)}Object.values(l).forEach(t=>this.app.assets.load(t)),await Promise.allSettled(h);const{assets:c}=this.app;s.once("unload",()=>{Object.values(l).forEach(t=>{c.remove(t),t.unload()})});const d=s.data?.decompress,u=s.options?.minimalMemory??!1,f=new om;f.url=t.original,f.minimalMemory=u,f.meta=a,f.numSplats=a.count,f.means_l=l[a.means.files[0]].resource,f.means_u=l[a.means.files[1]].resource,f.quats=l[a.quats.files[0]].resource,f.scales=l[a.scales.files[0]].resource,f.sh0=l[a.sh0.files[0]].resource,f.sh_centroids=l[a.shN?.files[0]]?.resource,f.sh_labels=l[a.shN?.files[1]]?.resource,f.shBands=om.calcBands(f.sh_centroids?.width),d||await f.prepareGpuData();e(null,d?new qp(this.app.graphicsDevice,await f.decompress()):new fm(this.app.graphicsDevice,f))}catch(t){e(t)}}}class Ib{load(t){}unload(t){}getResource(t){}destroy(){}}class Rb extends Ib{constructor(t){super(),this._urlToAsset=new Map,this.maxConcurrentLoads=2,this.maxRetries=2,this._currentlyLoading=new Set,this._loadQueue=[],this._retryCount=new Map,this._destroyed=!1,this._registry=t}destroy(){this._destroyed=!0;for(const t of this._urlToAsset.values())t.fire("unload",t),t.off("load"),t.off("error"),this._registry.remove(t),t.unload();this._urlToAsset.clear(),this._loadQueue.length=0,this._currentlyLoading.clear(),this._retryCount.clear()}_canLoad(){return!!this._registry.loader?.getHandler("gsplat")}load(t){const e=this._urlToAsset.get(t);e?.loaded||this._currentlyLoading.has(t)||this._loadQueue.includes(t)||(this._currentlyLoading.size<this.maxConcurrentLoads?this._startLoading(t):this._loadQueue.push(t))}_startLoading(t){this._currentlyLoading.add(t);let e=this._urlToAsset.get(t);e||(e=new Fm(t,"gsplat",{url:t},{},{minimalMemory:!0}),this._registry.add(e),this._urlToAsset.set(t,e)),e.once("load",()=>this._onAssetLoadSuccess(t,e)),e.once("error",s=>this._onAssetLoadError(t,e,s)),e.loaded||e.loading||this._registry.load(e)}_onAssetLoadSuccess(t,e){!this._destroyed&&this._urlToAsset.has(t)&&(this._currentlyLoading.delete(t),this._retryCount.delete(t),this._processQueue())}_onAssetLoadError(t,e,s){if(this._destroyed||!this._canLoad()||!this._urlToAsset.has(t))return;const n=this._retryCount.get(t)||0;n<this.maxRetries?(this._retryCount.set(t,n+1),e.loaded=!1,e.loading=!1,this._registry.load(e)):(this._currentlyLoading.delete(t),this._retryCount.delete(t),this._processQueue())}_processQueue(){if(!this._destroyed&&this._canLoad())for(;this._currentlyLoading.size<this.maxConcurrentLoads&&this._loadQueue.length>0;){const t=this._loadQueue.shift();t&&this._startLoading(t)}}unload(t){this._currentlyLoading.delete(t);const e=this._loadQueue.indexOf(t);-1!==e&&this._loadQueue.splice(e,1),this._retryCount.delete(t);const s=this._urlToAsset.get(t);s&&(s.fire("unload",s),s.off("load"),s.off("error"),this._registry.remove(s),s.unload(),this._urlToAsset.delete(t)),this._processQueue()}getResource(t){const e=this._urlToAsset.get(t);return e?.resource}}class Mb{constructor(t,e){this.app=t,this.maxRetries=e}load(t,e,s){"string"==typeof t&&(t={load:t,original:t});const n={retry:this.maxRetries>0,maxRetries:this.maxRetries,responseType:ll.ResponseType.JSON};hl.get(t.load,n,(n,i)=>{if(n)e(`Error loading gsplat octree: ${t.original} [${n}]`);else{const t=new Rb(this.app.assets),n=new Nv(s.file.url,i,t);e(null,n)}})}}class kb extends Gm{constructor(t){super(t,"gsplat"),this.parsers={ply:new Eb(t,3),sog:new Lb(t),json:new Db(t,3),octree:new Mb(t,3)}}_getUrlWithoutParams(t){return t.indexOf("?")>=0?t.split("?")[0]:t}_getParser(t){const e=Me.getBasename(this._getUrlWithoutParams(t)).toLowerCase();if("lod-meta.json"===e)return this.parsers.octree;const s=Me.getExtension(e).replace(".","");return this.parsers[s]||this.parsers.ply}load(t,e,s){"string"==typeof t&&(t={load:t,original:t}),this._getParser(t.original).load(t,e,s)}open(t,e,s){return e}}function Ob(){const t=0,e=1,s=2,n=3,i=8,r=9,a=10,o=11,l=12,h=13,c=14,d=16,u={astc:a,dxt:s,etc1:t,etc2:t,pvr:i,atc:o,none:c},f={astc:a,dxt:n,etc1:d,etc2:e,pvr:r,atc:l,none:d},p=21,m=22,g=23,_=8,v=10,y=26,b=27,S=28,x=29,w=30,T=7,C=3,E=5,A=(u,f)=>{switch(u){case t:return f.formats.etc2?m:p;case e:return g;case s:return _;case n:return v;case i:return y;case r:return b;case a:return S;case o:return x;case l:return w;case h:return T;case c:return C;case d:return E}},D=t=>{const e=function(t,e){const s=t*(2/255)-1,n=e*(2/255)-1,i=Math.sqrt(1-Math.min(1,s*s+n*n));return Math.max(0,Math.min(255,Math.floor(.5*(i+1)*255)))};for(let s=0;s<t.length;s+=4){const n=t[s+3],i=t[s+1];t[s+0]=n,t[s+2]=e(n,i),t[s+3]=255}return t},P=t=>{const e=new Uint16Array(t.length/4);for(let s=0;s<t.length;s+=4){const n=t[s+0],i=t[s+1],r=t[s+2];e[s/4]=(248&n)<<8|(252&i)<<3|r>>3}return e},L=()=>"undefined"!=typeof performance?performance.now():0;let I,R,M;const k=(t,e,s)=>{if(s){if(t.formats.astc)return"astc"}else if(e){if(t.formats.etc2)return"etc2"}else{if(t.formats.etc2)return"etc2";if(t.formats.etc1)return"etc1"}return(e=>{for(let s=0;s<e.length;++s){const n=e[s];if(t.formats[n])return n}return"none"})(e?M:R)},O=(h,c,d)=>{switch(d){case t:case e:return!0;case s:case n:return!(3&h||3&c);case i:case r:return((t,e)=>!(t&t-1||e&e-1))(h,c);case a:case o:case l:return!0}return!1},F=(t,e,s)=>s.isKTX2?((t,e,s)=>{if(!I.KTX2File)throw new Error("Basis transcoder module does not include support for KTX2.");const n=L(),i=new I.KTX2File(new Uint8Array(e)),r=i.getWidth(),a=i.getHeight(),o=i.getLevels(),l=!!i.getHasAlpha(),p=i.isUASTC&&i.isUASTC();if(!r||!a||!o)throw i.close(),i.delete(),new Error(`Invalid image dimensions url=${t} width=${r} height=${a} levels=${o}`);const m=k(s.deviceDetails,l,p),g=!!s.isGGGR&&"pvr"===m;let _,v;if(g?_=h:(_=l?f[m]:u[m],O(r,a,_)||(_=l?h:c)),!i.startTranscoding())throw i.close(),i.delete(),new Error(`Failed to start transcoding url=${t}`);const y=[];for(let e=0;e<o;++e){const s=i.getImageTranscodedSizeInBytes(e,0,0,_),n=new Uint8Array(s);if(!i.transcodeImage(n,e,0,0,_,0,-1,-1))throw i.close(),i.delete(),new Error(`Failed to transcode image url=${t}`);const r=_===c||_===d;y.push(r?new Uint16Array(n.buffer):n)}if(i.close(),i.delete(),g)for(_=c,v=0;v<y.length;++v)y[v]=P(D(y[v]));return{format:A(_,s.deviceDetails),width:r,height:a,levels:y,cubemap:!1,transcodeTime:L()-n,url:t,unswizzledGGGR:g}})(t,e,s):((t,e,s)=>{const n=L(),i=new I.BasisFile(new Uint8Array(e)),r=i.getImageWidth(0,0),a=i.getImageHeight(0,0),o=i.getNumImages(),l=i.getNumLevels(0),p=!!i.getHasAlpha(),m=i.isUASTC&&i.isUASTC();if(!(r&&a&&o&&l))throw i.close(),i.delete(),new Error(`Invalid image dimensions url=${t} width=${r} height=${a} images=${o} levels=${l}`);const g=k(s.deviceDetails,p,m),_=!!s.isGGGR&&"pvr"===g;let v,y;if(_?v=h:(v=p?f[g]:u[g],O(r,a,v)||(v=p?h:c)),!i.startTranscoding())throw i.close(),i.delete(),new Error(`Failed to start transcoding url=${t}`);const b=[];for(let e=0;e<l;++e){const s=i.getImageTranscodedSizeInBytes(0,e,v),n=new Uint8Array(s);if(!i.transcodeImage(n,0,e,v,0,0)){if(e!==l-1||s!==b[e-1].buffer.byteLength)throw i.close(),i.delete(),new Error(`Failed to transcode image url=${t}`);n.set(new Uint8Array(b[e-1].buffer)),console.warn(`Failed to transcode last mipmap level, using previous level instead url=${t}`)}const r=v===c||v===d;b.push(r?new Uint16Array(n.buffer):n)}if(i.close(),i.delete(),_)for(v=c,y=0;y<b.length;++y)b[y]=P(D(b[y]));return{format:A(v,s.deviceDetails),width:r,height:a,levels:b,cubemap:!1,transcodeTime:L()-n,url:t,unswizzledGGGR:_}})(t,e,s),N=(t,e,s)=>{try{const n=F(t,e,s);n.levels=n.levels.map(t=>t.buffer),self.postMessage({url:t,data:n},n.levels)}catch(e){self.postMessage({url:t,err:e},null)}},B=[];self.onmessage=t=>{const e=t.data;switch(e.type){case"init":s=e.config,n=()=>{for(let t=0;t<B.length;++t)N(B[t].url,B[t].data,B[t].options);B.length=0},self.BASIS(s.module?{instantiateWasm:(t,e)=>(WebAssembly.instantiate(s.module,t).then(t=>{e(t)}).catch(t=>{console.error(`instantiate failed + ${t}`)}),{})}:null).then(t=>{t.initializeBasis(),I=t,R=s.rgbPriority,M=s.rgbaPriority,n(null)});break;case"transcode":I?N(e.url,e.data,e.options):B.push(e)}var s,n}}const Fb=t=>({astc:!!t.extCompressedTextureASTC,atc:!!t.extCompressedTextureATC,dxt:!!t.extCompressedTextureS3TC,etc1:!!t.extCompressedTextureETC1,etc2:!!t.extCompressedTextureETC,pvr:!!t.extCompressedTexturePVRTC});class Nb{constructor(t,e,s){this.queue=t,this.worker=new Worker(e.workerUrl),this.worker.addEventListener("message",t=>{const e=t.data;this.queue.handleResponse(e.url,e.err,e.data),this.eager||this.queue.enqueueClient(this)}),this.worker.postMessage({type:"init",config:e}),this.eager=s}run(t){const e=[];t.data instanceof ArrayBuffer&&e.push(t.data),this.worker.postMessage({type:"transcode",url:t.url,format:t.format,data:t.data,options:t.options},e),this.eager&&this.queue.enqueueClient(this)}}const Bb=["etc2","etc1","astc","dxt","pvr","atc"],zb=["astc","dxt","etc2","pvr","atc"],Ub=new class{constructor(){this.callbacks={},this.queue=[],this.clients=[]}enqueueJob(t,e,s,n){if(this.callbacks.hasOwnProperty(t))this.callbacks[t].push(s);else{this.callbacks[t]=[s];const i={url:t,data:e,options:n};this.clients.length>0?this.clients.shift().run(i):this.queue.push(i)}}enqueueClient(t){this.queue.length>0?t.run(this.queue.shift()):this.clients.push(t)}handleResponse(t,e,s){const n=this.callbacks[t];if(e)for(let t=0;t<n.length;++t)n[t](e);else{3===s.format||5===s.format?s.levels=s.levels.map(t=>new Uint16Array(t)):s.levels=s.levels.map(t=>new Uint8Array(t));for(let t=0;t<n.length;++t)n[t](null,s)}delete this.callbacks[t]}};let Vb=null,Hb=!1;function Gb(t){if(!Hb){if(t){if(t.lazyInit)return void(Vb=t)}else t=Vb||{};if(!t.glueUrl||!t.wasmUrl||!t.fallbackUrl){const e=Ge.getConfig("BASIS");e&&(t={glueUrl:e.glueUrl,wasmUrl:e.wasmUrl,fallbackUrl:e.fallbackUrl,numWorkers:e.numWorkers})}if(t.glueUrl||t.wasmUrl||t.fallbackUrl){Hb=!0;const e=Math.max(1,Math.min(16,t.numWorkers||1)),s=1===t.numWorkers||!t.hasOwnProperty("eagerWorkers")||t.eagerWorkers;t.rgbPriority=t.rgbPriority||Bb,t.rgbaPriority=t.rgbaPriority||zb,t.maxRetries=t.hasOwnProperty("maxRetries")?t.maxRetries:5,((t,e)=>{const s=t=>{const e=["/* basis */",t,"",`(${Ob.toString()})()\n\n`].join("\n");return new Blob([e],{type:"application/javascript"})},n=(n,i)=>{e(null,{workerUrl:URL.createObjectURL(s(n)),module:i,rgbPriority:t.rgbPriority,rgbaPriority:t.rgbaPriority})},i={cache:!0,responseType:"text",retry:t.maxRetries>0,maxRetries:t.maxRetries};if(t.glueUrl&&t.wasmUrl&&(()=>{try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){const t=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(t instanceof WebAssembly.Module)return new WebAssembly.Instance(t)instanceof WebAssembly.Instance}}catch(t){}return!1})()){let s=null,r=null;hl.get(t.glueUrl,i,(t,i)=>{t?e(t):r?n(i,r):s=i});const a=fetch(t.wasmUrl),o=()=>{a.then(t=>t.arrayBuffer()).then(t=>WebAssembly.compile(t)).then(t=>{s?n(s,t):r=t}).catch(t=>{e(t,null)})};WebAssembly.compileStreaming?WebAssembly.compileStreaming(a).then(t=>{s?n(s,t):r=t}).catch(t=>{o()}):o()}else hl.get(t.fallbackUrl,i,(t,s)=>{t?e(t,null):n(s,null)})})(t,(t,n)=>{if(t)console.error(`failed to initialize basis worker: ${t}`);else for(let t=0;t<e;++t)Ub.enqueueClient(new Nb(Ub,n,s))})}}}let Wb=null;function jb(t,e,s,n,i){return Gb(),Wb||(Wb={formats:Fb(t)}),Ub.enqueueJob(e,s,n,{deviceDetails:Wb,isGGGR:!!i?.isGGGR,isKTX2:!!i?.isKTX2}),Hb}class $b{load(t,e,s){throw new Error("not implemented")}open(t,e,s){throw new Error("not implemented")}}class Xb extends $b{constructor(t,e){super(),this.device=e,this.maxRetries=0}load(t,e,s){const n=this.device;Fm.fetchArrayBuffer(t.load,(i,r)=>{i?e(i):(i=>{jb(n,t.load,i,e,{isGGGR:!!(8&s?.file?.variants?.basis?.opt)})||e(`Basis module not found. Asset [${s.name}](${s.getFileUrl()}) basis texture variant will not be loaded.`)})(r)},s,this.maxRetries)}open(t,e,s,n={}){const i=n.srgb?qs(e.format):e.format,r=new pi(s,{name:t,addressU:e.cubemap?1:0,addressV:e.cubemap?1:0,width:e.width,height:e.height,format:i,cubemap:e.cubemap,levels:e.levels,...n});return r.upload(),r}}class qb extends $b{constructor(t,e){super(),this.crossOrigin=t.prefix?"anonymous":null,this.maxRetries=0,this.device=e}load(t,e,s){const n=!!s?.file?.contents;if(n){if(this.device.supportsImageBitmap)return void this._loadImageBitmapFromBlob(new Blob([s.file.contents]),e);t={load:URL.createObjectURL(new Blob([s.file.contents])),original:t.original}}const i=(s,i)=>{n&&URL.revokeObjectURL(t.load),e(s,i)};let r;s&&s.options&&s.options.hasOwnProperty("crossOrigin")?r=s.options.crossOrigin:Im.test(t.load)&&(r=this.crossOrigin),this.device.supportsImageBitmap?this._loadImageBitmap(t.load,t.original,r,i,s):this._loadImage(t.load,t.original,r,i,s)}open(t,e,s,n={}){const i=new pi(s,{name:t,width:e.width,height:e.height,format:n.srgb?Fs:7,...n});return i.setSource(e),i}_loadImage(t,e,s,n,i){const r=new Image;s&&(r.crossOrigin=s);let a=0;const o=this.maxRetries;let l;const h=1048576;i?.fire("progress",0,h),r.onload=function(){i?.fire("progress",h,h),n(null,r)},r.onerror=function(){if(!l)if(o>0&&++a<=o){const s=100*Math.pow(2,a);console.log(`Error loading Texture from: '${e}' - Retrying in ${s}ms...`);const n=t.indexOf("?")>=0?"&":"?";l=setTimeout(()=>{r.src=`${t+n}retry=${Date.now()}`,l=null},s)}else n(`Error loading Texture from: '${e}'`)},r.src=t}_loadImageBitmap(t,e,s,n,i){const r={cache:!0,responseType:"blob",retry:this.maxRetries>0,maxRetries:this.maxRetries,progress:i};hl.get(t,r,(t,e)=>{t?n(t):this._loadImageBitmapFromBlob(e,n)})}_loadImageBitmapFromBlob(t,e){createImageBitmap(t,{premultiplyAlpha:"none",colorSpaceConversion:"none"}).then(t=>e(null,t)).catch(t=>e(t))}}const Kb=[1481919403,3140563232,169478669],Yb={33776:8,33778:9,33779:Ps,36196:21,37492:22,37496:23,35840:26,35841:Ns,35842:27,35843:Bs,32849:6,32856:7,35905:19,35907:Fs,35898:Os,34843:11,34842:Ls};function Qb(t,e,s,n){return t===Os?new Uint32Array(e,s,n/4):new Uint8Array(e,s,n)}class Zb extends $b{constructor(t){super(),this.maxRetries=0}load(t,e,s){Fm.fetchArrayBuffer(t.load,e,s,this.maxRetries)}open(t,e,s,n={}){const i=this.parse(e);if(!i)return null;const r=n.srgb?qs(i.format):i.format,a=new pi(s,{name:t,addressU:i.cubemap?1:0,addressV:i.cubemap?1:0,width:i.width,height:i.height,format:r,cubemap:i.cubemap,levels:i.levels,...n});return a.upload(),a}parse(t){const e=new Uint32Array(t);if(Kb[0]!==e[0]||Kb[1]!==e[1]||Kb[2]!==e[2])return null;const s={glInternalFormat:e[7],pixelWidth:e[9],pixelHeight:e[10],pixelDepth:e[11],numberOfArrayElements:e[12],numberOfFaces:e[13],numberOfMipmapLevels:e[14],bytesOfKeyValueData:e[15]};if(s.pixelDepth>1)return null;if(0!==s.numberOfArrayElements)return null;const n=Yb[s.glInternalFormat];if(void 0===n)return null;let i=16+s.bytesOfKeyValueData/4;const r=s.numberOfFaces>1,a=[];for(let o=0;o<(s.numberOfMipmapLevels||1);o++){const s=e[i++];r&&a.push([]);const l=r?a[o]:a;for(let e=0;e<(r?6:1);++e)l.push(Qb(n,t,4*i,s)),i+=s+3>>2}return{format:n,width:s.pixelWidth,height:s.pixelHeight,levels:a,cubemap:r}}}const Jb=166;class tS extends $b{constructor(t,e){super(),this.maxRetries=0,this.device=e}load(t,e,s){Fm.fetchArrayBuffer(t.load,(n,i)=>{n?e(n,i):this.parse(i,t,e,s)},s,this.maxRetries)}open(t,e,s,n={}){const i=n.srgb?qs(e.format):e.format,r=new pi(s,{name:t,addressU:e.cubemap?1:0,addressV:e.cubemap?1:0,width:e.width,height:e.height,format:i,cubemap:e.cubemap,levels:e.levels,...n});return r.upload(),r}parse(t,e,s,n){const i=new We(t),r=[i.readU32be(),i.readU32be(),i.readU32be()];if(2873840728!==r[0]||540160187!==r[1]||218765834!==r[2])return null;const a={vkFormat:i.readU32(),typeSize:i.readU32(),pixelWidth:i.readU32(),pixelHeight:i.readU32(),pixelDepth:i.readU32(),layerCount:i.readU32(),faceCount:i.readU32(),levelCount:i.readU32(),supercompressionScheme:i.readU32()},o={dfdByteOffset:i.readU32(),dfdByteLength:i.readU32(),kvdByteOffset:i.readU32(),kvdByteLength:i.readU32(),sgdByteOffset:i.readU64(),sgdByteLength:i.readU64()},l=[];for(let t=0;t<Math.max(1,a.levelCount);++t)l.push({byteOffset:i.readU64(),byteLength:i.readU64(),uncompressedByteLength:i.readU64()});if(i.readU32()!==o.kvdByteOffset-o.dfdByteOffset)return null;i.skip(8);const h=i.readU8();if(i.skip(o.dfdByteLength-9),i.skip(o.kvdByteLength),1===a.supercompressionScheme||h===Jb){jb(this.device,e.load,t,s,{isGGGR:!!(8&n?.file?.variants?.basis?.opt),isKTX2:!0})||s(`Basis module not found. Asset [${n.name}](${n.getFileUrl()}) basis texture variant will not be loaded.`)}else s("unsupported KTX2 pixel format")}}class eS extends $b{constructor(t){super(),this.maxRetries=0}load(t,e,s){Fm.fetchArrayBuffer(t.load,e,s,this.maxRetries)}open(t,e,s,n={}){const i=new Uint32Array(e,0,32),r=i[4],a=i[3],o=Math.max(i[7],1),l=4===i[20],h=i[21],c=i[22],d=65024===i[28],u=827611204,f=825438800,p=825439312;let m,g=!1,_=!1,v=!1,y=!1,b=null,S=1;if(l?h===u?(b=8,g=!0):894720068===h?(b=Ps,g=!0):113===h?(b=Ls,S=2):116===h?(b=Is,S=4):826496069===h?(b=21,g=!0,_=!0):h===f||825504336===h?(b=h===f?Ns:Bs,g=!0,v=!0):h!==p&&825504848!==h||(b=h===p?26:27,g=!0,y=!0):32===c&&(b=7),!b)return m=new pi(s,{width:4,height:4,format:6,name:"dds-legacy-empty"}),m;m=new pi(s,{name:t,addressU:d?1:0,addressV:d?1:0,width:r,height:a,format:b,cubemap:d,mipmaps:o>1,...n});let x=128;const w=d?6:1;let T;const C=h===u?8:16;let E,A,D;for(let t=0;t<w;t++){let s=r,n=a;for(let i=0;i<o;i++){g?_?T=Math.floor((s+3)/4)*Math.floor((n+3)/4)*8:v?T=Math.max(s,16)*Math.max(n,8)/4:y?T=Math.max(s,8)*Math.max(n,8)/2:(E=Math.floor((s+4-1)/4),A=Math.floor((n+4-1)/4),D=E*A,T=D*C):T=s*n*4;const r=b===Is?new Float32Array(e,x,T):b===Ls?new Uint16Array(e,x,T):new Uint8Array(e,x,T);d?(m._levels[i]||(m._levels[i]=[]),m._levels[i][t]=r):m._levels[i]=r,x+=T*S,s=Math.max(.5*s,1),n=Math.max(.5*n,1)}}return m.upload(),m}}class sS extends $b{constructor(t){super(),this.maxRetries=0}load(t,e,s){Fm.fetchArrayBuffer(t.load,e,s,this.maxRetries),s.data&&!s.data.type&&(s.data.type=Sn)}open(t,e,s,n={}){const i=this.parse(e);if(!i)return null;const r=new pi(s,{name:t,addressU:0,addressV:1,minFilter:0,magFilter:0,width:i.width,height:i.height,levels:i.levels,format:7,type:Sn,mipmaps:!1,...n});return r.upload(),r}parse(t){const e=new We(t);if(!e.readLine().startsWith("#?RADIANCE"))return null;const s={};for(;;){const t=e.readLine();if(0===t.length)break;{const e=t.split("=");2===e.length&&(s[e[0]]=e[1])}}if(!s.hasOwnProperty("FORMAT"))return null;const n=e.readLine().split(" ");if(4!==n.length)return null;const i=parseInt(n[1],10),r=parseInt(n[3],10),a=this._readPixels(e,r,i,"-Y"===n[0]);return a?{width:r,height:i,levels:[a]}:null}_readPixels(t,e,s,n){if(e<8||e>32767)return this._readPixelsFlat(t,e,s);const i=[0,0,0,0];if(t.readArray(i),2!==i[0]||2!==i[1]||128&i[2])return t.skip(-4),this._readPixelsFlat(t,e,s);const r=new ArrayBuffer(e*s*4),a=new Uint8Array(r);let o,l,h,c,d,u,f=n?0:4*e*(s-1);for(l=0;l<s;++l){if(l&&t.readArray(i),(i[2]<<8)+i[3]!==e)return null;for(c=0;c<4;++c)for(o=0;o<e;)if(d=t.readU8(),d>128){if(d-=128,o+d>e)return null;for(u=t.readU8(),h=0;h<d;++h)a[f+c+4*o++]=u}else{if(0===d||o+d>e)return null;for(h=0;h<d;++h)a[f+c+4*o++]=t.readU8()}f+=4*e*(n?1:-1)}return a}_readPixelsFlat(t,e,s){return t.remainingBytes===e*s*4?new Uint8Array(t.arraybuffer,t.offset):null}}const nS={repeat:0,clamp:1,mirror:2},iS={nearest:0,linear:1,nearest_mip_nearest:2,linear_mip_nearest:4,nearest_mip_linear:3,linear_mip_linear:5},rS={default:yn,rgbm:bn,rgbe:Sn,rgbp:xn,swizzleGGGR:wn};class aS extends Gm{constructor(t){super(t,"texture");const e=t.assets,s=t.graphicsDevice;this._device=s,this._assets=e,this.imgParser=new qb(e,s),this.parsers={dds:new eS(e),ktx:new Zb(e),ktx2:new tS(e,s),basis:new Xb(e,s),hdr:new sS(e)}}set crossOrigin(t){this.imgParser.crossOrigin=t}get crossOrigin(){return this.imgParser.crossOrigin}set maxRetries(t){this.imgParser.maxRetries=t;for(const e in this.parsers)this.parsers.hasOwnProperty(e)&&(this.parsers[e].maxRetries=t)}get maxRetries(){return this.imgParser.maxRetries}_getUrlWithoutParams(t){return t.indexOf("?")>=0?t.split("?")[0]:t}_getParser(t){const e=Me.getExtension(this._getUrlWithoutParams(t)).toLowerCase().replace(".","");return this.parsers[e]||this.imgParser}_getTextureOptions(t){const e={};if(t){t.name?.length>0&&(e.name=t.name);const s=t.data;s.hasOwnProperty("minfilter")&&(e.minFilter=iS[s.minfilter]),s.hasOwnProperty("magfilter")&&(e.magFilter=iS[s.magfilter]),s.hasOwnProperty("addressu")&&(e.addressU=nS[s.addressu]),s.hasOwnProperty("addressv")&&(e.addressV=nS[s.addressv]),s.hasOwnProperty("mipmaps")&&(e.mipmaps=s.mipmaps),s.hasOwnProperty("anisotropy")&&(e.anisotropy=s.anisotropy),s.hasOwnProperty("flipY")&&(e.flipY=!!s.flipY),s.hasOwnProperty("srgb")&&(e.srgb=!!s.srgb),e.type=yn,s.hasOwnProperty("type")?e.type=rS[s.type]:s.hasOwnProperty("rgbm")&&s.rgbm?e.type=bn:t.file&&8&t.file.opt&&(e.type=wn)}return e}load(t,e,s){"string"==typeof t&&(t={load:t,original:t}),this._getParser(t.original).load(t,e,s)}open(t,e,s){if(!t)return;const n=this._getTextureOptions(s);let i=this._getParser(t).open(t,e,this._device,n);return null===i?i=new pi(this._device,{width:4,height:4,format:6}):(!function(t){const e=ui.calcMipLevelsCount(t._width,t._height);if(7!==t._format&&t._format!==Is||t._volume||t._compressed||1===t._levels.length||t._levels.length===e||(s=t._cubemap?t._levels[0][0]:t._levels[0])instanceof HTMLCanvasElement||s instanceof HTMLImageElement||s instanceof HTMLVideoElement)return;var s;const n=function(t,e,s){const n=Math.max(1,t>>1),i=Math.max(1,e>>1),r=new s.constructor(n*i*4),a=Math.floor(t/n),o=Math.floor(e/i),l=a*o;for(let e=0;e<i;++e)for(let i=0;i<n;++i)for(let h=0;h<4;++h){let c=0;for(let n=0;n<o;++n)for(let r=0;r<a;++r)c+=s[4*(i*a+r+(e*o+n)*t)+h];r[4*(i+e*n)+h]=c/l}return r};for(let s=t._levels.length;s<e;++s){const e=Math.max(1,t._width>>s-1),i=Math.max(1,t._height>>s-1);if(t._cubemap){const r=[];for(let a=0;a<6;++a)r.push(n(e,i,t._levels[s-1][a]));t._levels.push(r)}else t._levels.push(n(e,i,t._levels[s-1]))}t._levelsUpdated=t._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0]}(i),e.unswizzledGGGR&&(s.file.variants.basis.opt&=-9)),i}patch(t,e){const s=t.resource;if(!s)return;const n=this._getTextureOptions(t);for(const t of Object.keys(n))s[t]=n[t]}}const oS="immersive-ar",lS="viewer",hS="point",cS="plane",dS="mesh",uS="gpu-optimized",fS="luminance-alpha",pS="unsigned-short",mS="float32";class gS{constructor(t){this._supported=ze.browser&&!!window.XRDOMOverlayState,this._root=null,this._manager=t}get supported(){return this._supported}get available(){return this._supported&&this._manager.active&&null!==this._manager._session.domOverlayState}get state(){return this._supported&&this._manager.active&&this._manager._session.domOverlayState?this._manager._session.domOverlayState.type:null}set root(t){this._supported&&!this._manager.active&&(this._root=t)}get root(){return this._root}}const _S=[],vS=[];class yS extends Ve{static{this.EVENT_REMOVE="remove"}static{this.EVENT_RESULT="result"}constructor(t,e,s,n=null){super(),this.manager=t,this._xrHitTestSource=e,this._transient=s,this._inputSource=n}remove(){if(!this._xrHitTestSource)return;const t=this.manager.hitTest.sources,e=t.indexOf(this);-1!==e&&t.splice(e,1),this.onStop()}onStop(){this._xrHitTestSource.cancel(),this._xrHitTestSource=null,this.fire("remove"),this.manager.hitTest.fire("remove",this)}update(t){if(this._transient){const e=t.getHitTestResultsForTransientInput(this._xrHitTestSource);for(let t=0;t<e.length;t++){const s=e[t];if(!s.results.length)continue;let n;s.inputSource&&(n=this.manager.input._getByInputSource(s.inputSource)),this.updateHitResults(s.results,n)}}else{const e=t.getHitTestResults(this._xrHitTestSource);if(!e.length)return;this.updateHitResults(e)}}updateHitResults(t,e){if(this._inputSource&&this._inputSource!==e)return;const s=_S.pop()??new rs;e?s.copy(e.getOrigin()):s.copy(this.manager.camera.getPosition());let n=1/0,i=null;const r=_S.pop()??new rs,a=vS.pop()??new ms;for(let e=0;e<t.length;e++){const o=t[e].getPose(this.manager._referenceSpace),l=s.distance(o.transform.position);l>=n||(n=l,i=t[e],r.copy(o.transform.position),a.copy(o.transform.orientation))}this.fire("result",r,a,e||this._inputSource,i),this.manager.hitTest.fire("result",this,r,a,e||this._inputSource,i),_S.push(s),_S.push(r),vS.push(a)}}class bS extends Ve{static{this.EVENT_AVAILABLE="available"}static{this.EVENT_UNAVAILABLE="unavailable"}static{this.EVENT_ADD="add"}static{this.EVENT_REMOVE="remove"}static{this.EVENT_RESULT="result"}static{this.EVENT_ERROR="error"}constructor(t){super(),this._supported=ze.browser&&!(!window.XRSession||!window.XRSession.prototype.requestHitTestSource),this._available=!1,this._checkingAvailability=!1,this.sources=[],this.manager=t,this._supported&&(this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,this))}_onSessionStart(){if(this.manager.session.enabledFeatures){const t=-1!==this.manager.session.enabledFeatures.indexOf("hit-test");if(!t)return;this._available=t,this.fire("available")}else this._checkingAvailability||(this._checkingAvailability=!0,this.manager.session.requestReferenceSpace(lS).then(t=>{this.manager.session.requestHitTestSource({space:t}).then(t=>{t.cancel(),this.manager.active&&(this._available=!0,this.fire("available"))}).catch(()=>{})}).catch(()=>{}))}_onSessionEnd(){if(this._available){this._available=!1;for(let t=0;t<this.sources.length;t++)this.sources[t].onStop();this.sources=[],this.fire("unavailable")}}start(t={}){if(!this._supported)return void t.callback?.(new Error("XR HitTest is not supported"),null);if(!this._available)return void t.callback?.(new Error("XR HitTest is not available"),null);let e;t.profile||t.spaceType||(t.spaceType=lS);const s=t.offsetRay;if(s){const t=new DOMPoint(s.origin.x,s.origin.y,s.origin.z,1),n=new DOMPoint(s.direction.x,s.direction.y,s.direction.z,0);e=new XRRay(t,n)}const n=t.callback;t.spaceType?this.manager.session.requestReferenceSpace(t.spaceType).then(s=>{if(!this.manager.session){const t=new Error("XR Session is not started (2)");return n&&n(t),void this.fire("error",t)}this.manager.session.requestHitTestSource({space:s,entityTypes:t.entityTypes||void 0,offsetRay:e}).then(e=>{this._onHitTestSource(e,!1,t.inputSource,n)}).catch(t=>{n&&n(t),this.fire("error",t)})}).catch(t=>{n&&n(t),this.fire("error",t)}):this.manager.session.requestHitTestSourceForTransientInput({profile:t.profile,entityTypes:t.entityTypes||void 0,offsetRay:e}).then(e=>{this._onHitTestSource(e,!0,t.inputSource,n)}).catch(t=>{n&&n(t),this.fire("error",t)})}_onHitTestSource(t,e,s,n){if(!this.manager.session){t.cancel();const e=new Error("XR Session is not started (3)");return n&&n(e),void this.fire("error",e)}const i=new yS(this.manager,t,e,s??null);this.sources.push(i),n&&n(null,i),this.fire("add",i)}update(t){if(this._available)for(let e=0;e<this.sources.length;e++)this.sources[e].update(t)}get supported(){return this._supported}get available(){return this._available}}class SS extends Ve{static{this.EVENT_TRACKED="tracked"}static{this.EVENT_UNTRACKED="untracked"}constructor(t,e){super(),this._bitmap=null,this._measuredWidth=0,this._trackable=!1,this._tracking=!1,this._emulated=!1,this._pose=null,this._position=new rs,this._rotation=new ms,this._image=t,this._width=e}get image(){return this._image}set width(t){this._width=t}get width(){return this._width}get trackable(){return this._trackable}get tracking(){return this._tracking}get emulated(){return this._emulated}prepare(){return this._bitmap?{image:this._bitmap,widthInMeters:this._width}:createImageBitmap(this._image).then(t=>(this._bitmap=t,{image:this._bitmap,widthInMeters:this._width}))}destroy(){this._image=null,this._pose=null,this._bitmap&&(this._bitmap.close(),this._bitmap=null)}getPosition(){return this._pose&&this._position.copy(this._pose.transform.position),this._position}getRotation(){return this._pose&&this._rotation.copy(this._pose.transform.orientation),this._rotation}}class xS extends Ve{static{this.EVENT_ERROR="error"}constructor(t){super(),this._supported=ze.browser&&!!window.XRImageTrackingResult,this._available=!1,this._images=[],this._manager=t,this._supported&&(this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this))}add(t,e){if(!this._supported||this._manager.active)return null;const s=new SS(t,e);return this._images.push(s),s}remove(t){if(this._manager.active)return;const e=this._images.indexOf(t);-1!==e&&(t.destroy(),this._images.splice(e,1))}_onSessionStart(){this._manager.session.getTrackedImageScores().then(t=>{this._available=!0;for(let e=0;e<t.length;e++)this._images[e]._trackable="trackable"===t[e]}).catch(t=>{this._available=!1,this.fire("error",t)})}_onSessionEnd(){this._available=!1;for(let t=0;t<this._images.length;t++){const e=this._images[t];e._pose=null,e._measuredWidth=0,e._tracking&&(e._tracking=!1,e.fire("untracked"))}}prepareImages(t){this._images.length?Promise.all(this._images.map(t=>t.prepare())).then(e=>{t(null,e)}).catch(e=>{t(e,null)}):t(null,null)}update(t){if(!this._available)return;const e=t.getImageTrackingResults(),s={};for(let n=0;n<e.length;n++){s[e[n].index]=e[n];const i=this._images[e[n].index];i._emulated="emulated"===e[n].trackingState,i._measuredWidth=e[n].measuredWidthInMeters,i._pose=t.getPose(e[n].imageSpace,this._manager._referenceSpace)}for(let t=0;t<this._images.length;t++)this._images[t]._tracking&&!s[t]?(this._images[t]._tracking=!1,this._images[t].fire("untracked")):!this._images[t]._tracking&&s[t]&&(this._images[t]._tracking=!0,this._images[t].fire("tracked"))}get supported(){return this._supported}get available(){return this._available}get images(){return this._images}}class wS{constructor(t,e){this._joints=[],this._tip=null,this._index=t,this._hand=e,this._hand._fingers.push(this)}get index(){return this._index}get hand(){return this._hand}get joints(){return this._joints}get tip(){return this._tip}}const TS=ze.browser&&window.XRHand?["thumb-tip","index-finger-tip","middle-finger-tip","ring-finger-tip","pinky-finger-tip"]:[],CS={};for(let t=0;t<TS.length;t++)CS[TS[t]]=!0;class ES{constructor(t,e,s,n=null){this._radius=null,this._localTransform=new ps,this._worldTransform=new ps,this._localPosition=new rs,this._localRotation=new ms,this._position=new rs,this._rotation=new ms,this._dirtyLocal=!0,this._index=t,this._id=e,this._hand=s,this._finger=n,this._wrist="wrist"===e,this._tip=this._finger&&!!CS[e]}update(t){this._dirtyLocal=!0,this._radius=t.radius,this._localPosition.copy(t.transform.position),this._localRotation.copy(t.transform.orientation)}_updateTransforms(){this._dirtyLocal&&(this._dirtyLocal=!1,this._localTransform.setTRS(this._localPosition,this._localRotation,rs.ONE));const t=this._hand._manager.camera.parent;t?this._worldTransform.mul2(t.getWorldTransform(),this._localTransform):this._worldTransform.copy(this._localTransform)}getPosition(){return this._updateTransforms(),this._worldTransform.getTranslation(this._position),this._position}getRotation(){return this._updateTransforms(),this._rotation.setFromMat4(this._worldTransform),this._rotation}get id(){return this._id}get index(){return this._index}get hand(){return this._hand}get finger(){return this._finger}get wrist(){return this._wrist}get tip(){return this._tip}get radius(){return this._radius||.005}}let AS=[];const DS=new rs,PS=new rs,LS=new rs;ze.browser&&window.XRHand&&(AS=[["thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip"],["index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip"],["middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip"],["ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip"],["pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"]]);class IS extends Ve{static{this.EVENT_TRACKING="tracking"}static{this.EVENT_TRACKINGLOST="trackinglost"}constructor(t){super(),this._tracking=!1,this._fingers=[],this._joints=[],this._jointsById={},this._tips=[],this._wrist=null;const e=t._xrInputSource.hand;if(this._manager=t._manager,this._inputSource=t,e.get("wrist")){const t=new ES(0,"wrist",this,null);this._wrist=t,this._joints.push(t),this._jointsById.wrist=t}for(let t=0;t<AS.length;t++){const s=new wS(t,this);for(let n=0;n<AS[t].length;n++){const i=AS[t][n];if(!e.get(i))continue;const r=new ES(n,i,this,s);this._joints.push(r),this._jointsById[i]=r,r.tip&&(this._tips.push(r),s._tip=r),s._joints.push(r)}}}update(t){const e=this._inputSource._xrInputSource;for(let s=0;s<this._joints.length;s++){const n=this._joints[s],i=e.hand.get(n._id);if(i){let e;if("hidden"!==t.session.visibilityState&&(e=t.getJointPose(i,this._manager._referenceSpace)),e)n.update(e),n.wrist&&!this._tracking&&(this._tracking=!0,this.fire("tracking"));else if(n.wrist){this._tracking&&(this._tracking=!1,this.fire("trackinglost"));break}}}const s=this._jointsById["thumb-metacarpal"],n=this._jointsById["thumb-tip"],i=this._jointsById["index-finger-phalanx-proximal"],r=this._jointsById["index-finger-tip"],a=this._jointsById["ring-finger-phalanx-proximal"],o=this._jointsById["pinky-finger-phalanx-proximal"];if(s&&n&&i&&r&&a&&o){this._inputSource._dirtyRay=!0,this._inputSource._rayLocal.origin.lerp(n._localPosition,r._localPosition,.5);let t=s,e=o;if("left"===this._inputSource.handedness){const s=t;t=e,e=s}DS.sub2(t._localPosition,this._wrist._localPosition),PS.sub2(e._localPosition,this._wrist._localPosition),LS.cross(DS,PS).normalize(),DS.lerp(i._localPosition,a._localPosition,.5),DS.sub(this._wrist._localPosition).normalize(),this._inputSource._rayLocal.direction.lerp(LS,DS,.5).normalize()}this._fingerIsClosed(1)&&this._fingerIsClosed(2)&&this._fingerIsClosed(3)&&this._fingerIsClosed(4)?this._inputSource._squeezing||(this._inputSource._squeezing=!0,this._inputSource.fire("squeezestart"),this._manager.input.fire("squeezestart",this._inputSource)):this._inputSource._squeezing&&(this._inputSource._squeezing=!1,this._inputSource.fire("squeeze"),this._manager.input.fire("squeeze",this._inputSource),this._inputSource.fire("squeezeend"),this._manager.input.fire("squeezeend",this._inputSource))}_fingerIsClosed(t){const e=this._fingers[t];return DS.sub2(e.joints[0]._localPosition,e.joints[1]._localPosition).normalize(),PS.sub2(e.joints[2]._localPosition,e.joints[3]._localPosition).normalize(),DS.dot(PS)<-.8}getJointById(t){return this._jointsById[t]||null}get fingers(){return this._fingers}get joints(){return this._joints}get tips(){return this._tips}get wrist(){return this._wrist}get tracking(){return this._tracking}}const RS=new rs,MS=new ms;let kS=0;class OS extends Ve{static{this.EVENT_REMOVE="remove"}static{this.EVENT_SELECT="select"}static{this.EVENT_SELECTSTART="selectstart"}static{this.EVENT_SELECTEND="selectend"}static{this.EVENT_SQUEEZE="squeeze"}static{this.EVENT_SQUEEZESTART="squeezestart"}static{this.EVENT_SQUEEZEEND="squeezeend"}static{this.EVENT_HITTESTADD="hittest:add"}static{this.EVENT_HITTESTREMOVE="hittest:remove"}static{this.EVENT_HITTESTRESULT="hittest:result"}constructor(t,e){super(),this._ray=new As,this._rayLocal=new As,this._grip=!1,this._hand=null,this._velocitiesAvailable=!1,this._velocitiesTimestamp=Xe(),this._localTransform=null,this._worldTransform=null,this._position=new rs,this._rotation=new ms,this._localPosition=null,this._localPositionLast=null,this._localRotation=null,this._linearVelocity=null,this._dirtyLocal=!0,this._dirtyRay=!1,this._selecting=!1,this._squeezing=!1,this._elementInput=!0,this._elementEntity=null,this._hitTestSources=[],this._id=++kS,this._manager=t,this._xrInputSource=e,e.hand&&(this._hand=new IS(this))}get id(){return this._id}get inputSource(){return this._xrInputSource}get targetRayMode(){return this._xrInputSource.targetRayMode}get handedness(){return this._xrInputSource.handedness}get profiles(){return this._xrInputSource.profiles}get grip(){return this._grip}get hand(){return this._hand}get gamepad(){return this._xrInputSource.gamepad||null}get selecting(){return this._selecting}get squeezing(){return this._squeezing}set elementInput(t){this._elementInput!==t&&(this._elementInput=t,this._elementInput||(this._elementEntity=null))}get elementInput(){return this._elementInput}get elementEntity(){return this._elementEntity}get hitTestSources(){return this._hitTestSources}update(t){if(this._hand)this._hand.update(t);else{const e=this._xrInputSource.gripSpace;if(e){const s=t.getPose(e,this._manager._referenceSpace);if(s){this._grip||(this._grip=!0,this._localTransform=new ps,this._worldTransform=new ps,this._localPositionLast=new rs,this._localPosition=new rs,this._localRotation=new ms,this._linearVelocity=new rs);const t=Xe(),e=(t-this._velocitiesTimestamp)/1e3;this._velocitiesTimestamp=t,this._dirtyLocal=!0,this._localPositionLast.copy(this._localPosition),this._localPosition.copy(s.transform.position),this._localRotation.copy(s.transform.orientation),this._velocitiesAvailable=!0,this._manager.input.velocitiesSupported&&s.linearVelocity?this._linearVelocity.copy(s.linearVelocity):e>0&&(RS.sub2(this._localPosition,this._localPositionLast).divScalar(e),this._linearVelocity.lerp(this._linearVelocity,RS,.15))}else this._velocitiesAvailable=!1}const s=t.getPose(this._xrInputSource.targetRaySpace,this._manager._referenceSpace);s&&(this._dirtyRay=!0,this._rayLocal.origin.copy(s.transform.position),this._rayLocal.direction.set(0,0,-1),MS.copy(s.transform.orientation),MS.transformVector(this._rayLocal.direction,this._rayLocal.direction))}}_updateTransforms(){this._dirtyLocal&&(this._dirtyLocal=!1,this._localTransform.setTRS(this._localPosition,this._localRotation,rs.ONE));const t=this._manager.camera.parent;t?this._worldTransform.mul2(t.getWorldTransform(),this._localTransform):this._worldTransform.copy(this._localTransform)}_updateRayTransforms(){const t=this._dirtyRay;this._dirtyRay=!1;if(this._manager.camera.parent){const t=this._manager.camera.parent.getWorldTransform();t.getTranslation(this._position),this._rotation.setFromMat4(t),this._rotation.transformVector(this._rayLocal.origin,this._ray.origin),this._ray.origin.add(this._position),this._rotation.transformVector(this._rayLocal.direction,this._ray.direction)}else t&&(this._ray.origin.copy(this._rayLocal.origin),this._ray.direction.copy(this._rayLocal.direction))}getPosition(){return this._position?(this._updateTransforms(),this._worldTransform.getTranslation(this._position),this._position):null}getLocalPosition(){return this._localPosition}getRotation(){return this._rotation?(this._updateTransforms(),this._rotation.setFromMat4(this._worldTransform),this._rotation):null}getLocalRotation(){return this._localRotation}getLinearVelocity(){return this._velocitiesAvailable?this._linearVelocity:null}getOrigin(){return this._updateRayTransforms(),this._ray.origin}getDirection(){return this._updateRayTransforms(),this._ray.direction}hitTestStart(t={}){t.inputSource=this,t.profile=this._xrInputSource.profiles[0];const e=t.callback;t.callback=(t,s)=>{s&&this.onHitTestSourceAdd(s),e&&e(t,s)},this._manager.hitTest.start(t)}onHitTestSourceAdd(t){this._hitTestSources.push(t),this.fire("hittest:add",t),t.on("result",(e,s,n,i)=>{n===this&&this.fire("hittest:result",t,e,s,i)}),t.once("remove",()=>{this.onHitTestSourceRemove(t),this.fire("hittest:remove",t)})}onHitTestSourceRemove(t){const e=this._hitTestSources.indexOf(t);-1!==e&&this._hitTestSources.splice(e,1)}}class FS extends Ve{static{this.EVENT_ADD="add"}static{this.EVENT_REMOVE="remove"}static{this.EVENT_SELECT="select"}static{this.EVENT_SELECTSTART="selectstart"}static{this.EVENT_SELECTEND="selectend"}static{this.EVENT_SQUEEZE="squeeze"}static{this.EVENT_SQUEEZESTART="squeezestart"}static{this.EVENT_SQUEEZEEND="squeezeend"}constructor(t){super(),this._inputSources=[],this.velocitiesSupported=!1,this.manager=t,this.velocitiesSupported=!(!ze.browser||!window.XRPose?.prototype?.hasOwnProperty("linearVelocity")),this._onInputSourcesChangeEvt=t=>{this._onInputSourcesChange(t)},this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,this)}_onSessionStart(){const t=this.manager.session;t.addEventListener("inputsourceschange",this._onInputSourcesChangeEvt),t.addEventListener("select",t=>{const e=this._getByInputSource(t.inputSource);e.update(t.frame),e.fire("select",t),this.fire("select",e,t)}),t.addEventListener("selectstart",t=>{const e=this._getByInputSource(t.inputSource);e.update(t.frame),e._selecting=!0,e.fire("selectstart",t),this.fire("selectstart",e,t)}),t.addEventListener("selectend",t=>{const e=this._getByInputSource(t.inputSource);e.update(t.frame),e._selecting=!1,e.fire("selectend",t),this.fire("selectend",e,t)}),t.addEventListener("squeeze",t=>{const e=this._getByInputSource(t.inputSource);e.update(t.frame),e.fire("squeeze",t),this.fire("squeeze",e,t)}),t.addEventListener("squeezestart",t=>{const e=this._getByInputSource(t.inputSource);e.update(t.frame),e._squeezing=!0,e.fire("squeezestart",t),this.fire("squeezestart",e,t)}),t.addEventListener("squeezeend",t=>{const e=this._getByInputSource(t.inputSource);e.update(t.frame),e._squeezing=!1,e.fire("squeezeend",t),this.fire("squeezeend",e,t)});const e=t.inputSources;for(let t=0;t<e.length;t++)this._addInputSource(e[t])}_onSessionEnd(){let t=this._inputSources.length;for(;t--;){const e=this._inputSources[t];this._inputSources.splice(t,1),e.fire("remove"),this.fire("remove",e)}this.manager.session.removeEventListener("inputsourceschange",this._onInputSourcesChangeEvt)}_onInputSourcesChange(t){for(let e=0;e<t.removed.length;e++)this._removeInputSource(t.removed[e]);for(let e=0;e<t.added.length;e++)this._addInputSource(t.added[e])}_getByInputSource(t){for(let e=0;e<this._inputSources.length;e++)if(this._inputSources[e].inputSource===t)return this._inputSources[e];return null}_addInputSource(t){if(this._getByInputSource(t))return;const e=new OS(this.manager,t);this._inputSources.push(e),this.fire("add",e)}_removeInputSource(t){for(let e=0;e<this._inputSources.length;e++){if(this._inputSources[e].inputSource!==t)continue;const s=this._inputSources[e];this._inputSources.splice(e,1);let n=s.hitTestSources.length;for(;n--;)s.hitTestSources[n].remove();return s.fire("remove"),void this.fire("remove",s)}}update(t){for(let e=0;e<this._inputSources.length;e++)this._inputSources[e].update(t)}get inputSources(){return this._inputSources}}const NS=new rs,BS=new rs,zS=new ps,US=new ps;class VS extends Ve{static{this.EVENT_AVAILABLE="available"}static{this.EVENT_ERROR="error"}constructor(t){super(),this._supported=!1,this._available=!1,this._lightProbeRequested=!1,this._lightProbe=null,this._intensity=0,this._rotation=new ms,this._color=new Ze,this._sphericalHarmonics=new Float32Array(27),this._manager=t,this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this)}_onSessionStart(){!!this._manager.session.requestLightProbe&&(this._supported=!0)}_onSessionEnd(){this._supported=!1,this._available=!1,this._lightProbeRequested=!1,this._lightProbe=null}start(){let t;this._manager.session||(t=new Error("XR session is not running")),t||this._manager.type===oS||(t=new Error("XR session type is not AR")),t||this._supported||(t=new Error("light-estimation is not supported")),(!t&&this._lightProbe||this._lightProbeRequested)&&(t=new Error("light estimation is already requested")),t?this.fire("error",t):(this._lightProbeRequested=!0,this._manager.session.requestLightProbe().then(t=>{const e=this._lightProbeRequested;this._lightProbeRequested=!1,this._manager.active?e&&(this._lightProbe=t):this.fire("error",new Error("XR session is not active"))}).catch(t=>{this._lightProbeRequested=!1,this.fire("error",t)}))}end(){this._lightProbeRequested=!1,this._lightProbe=null,this._available=!1}update(t){if(!this._lightProbe)return;const e=t.getLightEstimate(this._lightProbe);if(!e)return;this._available||(this._available=!0,this.fire("available"));const s=e.primaryLightIntensity;this._intensity=Math.max(1,Math.max(s.x,Math.max(s.y,s.z))),NS.copy(s).mulScalar(1/this._intensity),this._color.set(NS.x,NS.y,NS.z),NS.set(0,0,0),BS.copy(e.primaryLightDirection),zS.setLookAt(BS,NS,rs.UP),US.setFromAxisAngle(rs.RIGHT,90),zS.mul(US),this._rotation.setFromMat4(zS),this._sphericalHarmonics.set(e.sphericalHarmonicsCoefficients)}get supported(){return this._supported}get available(){return this._available}get intensity(){return this._available?this._intensity:null}get color(){return this._available?this._color:null}get rotation(){return this._available?this._rotation:null}get sphericalHarmonics(){return this._available?this._sphericalHarmonics:null}}let HS=0;class GS extends Ve{static{this.EVENT_REMOVE="remove"}static{this.EVENT_CHANGE="change"}constructor(t,e){super(),this._position=new rs,this._rotation=new ms,this._id=++HS,this._planeDetection=t,this._xrPlane=e,this._lastChangedTime=e.lastChangedTime,this._orientation=e.orientation}destroy(){this._xrPlane&&(this._xrPlane=null,this.fire("remove"))}update(t){const e=this._planeDetection._manager,s=t.getPose(this._xrPlane.planeSpace,e._referenceSpace);s&&(this._position.copy(s.transform.position),this._rotation.copy(s.transform.orientation)),this._lastChangedTime!==this._xrPlane.lastChangedTime&&(this._lastChangedTime=this._xrPlane.lastChangedTime,this.fire("change"))}getPosition(){return this._position}getRotation(){return this._rotation}get id(){return this._id}get orientation(){return this._orientation}get points(){return this._xrPlane.polygon}get label(){return this._xrPlane.semanticLabel||""}}class WS extends Ve{static{this.EVENT_AVAILABLE="available"}static{this.EVENT_UNAVAILABLE="unavailable"}static{this.EVENT_ADD="add"}static{this.EVENT_REMOVE="remove"}constructor(t){super(),this._supported=ze.browser&&!!window.XRPlane,this._available=!1,this._planesIndex=new Map,this._planes=[],this._manager=t,this._supported&&(this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this))}_onSessionStart(){if(this._manager.session.enabledFeatures){-1!==this._manager.session.enabledFeatures.indexOf("plane-detection")&&(this._available=!0,this.fire("available"))}}_onSessionEnd(){for(let t=0;t<this._planes.length;t++)this._planes[t].destroy(),this.fire("remove",this._planes[t]);this._planesIndex.clear(),this._planes.length=0,this._available&&(this._available=!1,this.fire("unavailable"))}update(t){if(!this._available){if(this._manager.session.enabledFeatures||!t.detectedPlanes.size)return;this._available=!0,this.fire("available")}const e=t.detectedPlanes;for(const[t,s]of this._planesIndex)e.has(t)||(this._planesIndex.delete(t),this._planes.splice(this._planes.indexOf(s),1),s.destroy(),this.fire("remove",s));for(const s of e){let e=this._planesIndex.get(s);e?e.update(t):(e=new GS(this,s),this._planesIndex.set(s,e),this._planes.push(e),e.update(t),this.fire("add",e))}}get supported(){return this._supported}get available(){return this._available}get planes(){return this._planes}}class jS extends Ve{static{this.EVENT_DESTROY="destroy"}static{this.EVENT_CHANGE="change"}static{this.EVENT_PERSIST="persist"}static{this.EVENT_FORGET="forget"}constructor(t,e,s=null){super(),this._position=new rs,this._rotation=new ms,this._uuid=null,this._uuidRequests=null,this._anchors=t,this._xrAnchor=e,this._uuid=s}destroy(){if(!this._xrAnchor)return;const t=this._xrAnchor;this._xrAnchor.delete(),this._xrAnchor=null,this.fire("destroy",t,this)}update(t){if(!this._xrAnchor)return;const e=t.getPose(this._xrAnchor.anchorSpace,this._anchors.manager._referenceSpace);if(e){if(this._position.equals(e.transform.position)&&this._rotation.equals(e.transform.orientation))return;this._position.copy(e.transform.position),this._rotation.copy(e.transform.orientation),this.fire("change")}}getPosition(){return this._position}getRotation(){return this._rotation}persist(t){this._anchors.persistence?this._uuid?t?.(null,this._uuid):this._uuidRequests?t&&this._uuidRequests.push(t):(this._uuidRequests=[],this._xrAnchor.requestPersistentHandle().then(e=>{this._uuid=e,this._anchors._indexByUuid.set(this._uuid,this),t?.(null,e);for(const t of this._uuidRequests)t(null,e);this._uuidRequests=null,this.fire("persist",e)}).catch(e=>{t?.(e,null);for(const t of this._uuidRequests)t(e,null);this._uuidRequests=null})):t?.(new Error("Persistent Anchors are not supported"),null)}forget(t){this._uuid?this._anchors.forget(this._uuid,e=>{this._uuid=null,t?.(e),this.fire("forget")}):t?.(new Error("Anchor is not persistent"))}get uuid(){return this._uuid}get persistent(){return!!this._uuid}}class $S extends Ve{static{this.EVENT_AVAILABLE="available"}static{this.EVENT_UNAVAILABLE="unavailable"}static{this.EVENT_ERROR="error"}static{this.EVENT_ADD="add"}static{this.EVENT_DESTROY="destroy"}constructor(t){super(),this._supported=ze.browser&&!!window.XRAnchor,this._available=!1,this._checkingAvailability=!1,this._persistence=ze.browser&&!!window?.XRSession?.prototype.restorePersistentAnchor,this._creationQueue=[],this._index=new Map,this._indexByUuid=new Map,this._list=[],this._callbacksAnchors=new Map,this.manager=t,this._supported&&(this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,this))}_onSessionStart(){const t=this.manager.session.enabledFeatures?.indexOf("anchors")>=0;t&&(this._available=t,this.fire("available"))}_onSessionEnd(){if(!this._available)return;this._available=!1;for(let t=0;t<this._creationQueue.length;t++)this._creationQueue[t].callback&&this._creationQueue[t].callback(new Error("session ended"),null);this._creationQueue.length=0,this._index.clear(),this._indexByUuid.clear();let t=this._list.length;for(;t--;)this._list[t].destroy();this._list.length=0,this.fire("unavailable")}_createAnchor(t,e=null){const s=new jS(this,t,e);return this._index.set(t,s),e&&this._indexByUuid.set(e,s),this._list.push(s),s.once("destroy",this._onAnchorDestroy,this),s}_onAnchorDestroy(t,e){this._index.delete(t),e.uuid&&this._indexByUuid.delete(e.uuid);const s=this._list.indexOf(e);-1!==s&&this._list.splice(s,1),this.fire("destroy",e)}create(t,e,s){if(this._available)if(window.XRHitTestResult&&t instanceof XRHitTestResult){const n=t;if(s=e,!this._supported)return void s?.(new Error("Anchors API is not supported"),null);if(!n.createAnchor)return void s?.(new Error("Creating Anchor from Hit Test is not supported"),null);n.createAnchor().then(t=>{const e=this._createAnchor(t);s?.(null,e),this.fire("add",e)}).catch(t=>{s?.(t,null),this.fire("error",t)})}else this._creationQueue.push({transform:new XRRigidTransform(t,e),callback:s});else s?.(new Error("Anchors API is not available"),null)}restore(t,e){this._available?this._persistence?this.manager.active?this.manager.session.restorePersistentAnchor(t).then(s=>{const n=this._createAnchor(s,t);e?.(null,n),this.fire("add",n)}).catch(t=>{e?.(t,null),this.fire("error",t)}):e?.(new Error("WebXR session is not active"),null):e?.(new Error("Anchor Persistence is not supported"),null):e?.(new Error("Anchors API is not available"),null)}forget(t,e){this._available?this._persistence?this.manager.active?this.manager.session.deletePersistentAnchor(t).then(()=>{e?.(null)}).catch(t=>{e?.(t),this.fire("error",t)}):e?.(new Error("WebXR session is not active")):e?.(new Error("Anchor Persistence is not supported")):e?.(new Error("Anchors API is not available"))}update(t){if(this._available){if(this._creationQueue.length){for(let e=0;e<this._creationQueue.length;e++){const s=this._creationQueue[e];t.createAnchor(s.transform,this.manager._referenceSpace).then(t=>{s.callback&&this._callbacksAnchors.set(t,s.callback)}).catch(t=>{s.callback&&s.callback(t,null),this.fire("error",t)})}this._creationQueue.length=0}for(const[e,s]of this._index)t.trackedAnchors.has(e)||(this._index.delete(e),s.destroy());for(let e=0;e<this._list.length;e++)this._list[e].update(t);for(const e of t.trackedAnchors){if(this._index.has(e))continue;const s=this._createAnchor(e);s.update(t);const n=this._callbacksAnchors.get(e);n&&(this._callbacksAnchors.delete(e),n(null,s)),this.fire("add",s)}}else this.manager.session.enabledFeatures||this._checkingAvailability||(this._checkingAvailability=!0,t.createAnchor(new XRRigidTransform,this.manager._referenceSpace).then(t=>{t.delete(),this.manager.active&&(this._available=!0,this.fire("available"))}).catch(()=>{}))}get supported(){return this._supported}get available(){return this._available}get persistence(){return this._persistence}get uuids(){return this._available&&this._persistence&&this.manager.active?this.manager.session.persistentAnchors:null}get list(){return this._list}}class XS extends Ve{static{this.EVENT_REMOVE="remove"}static{this.EVENT_CHANGE="change"}constructor(t,e){super(),this._lastChanged=0,this._position=new rs,this._rotation=new ms,this._meshDetection=t,this._xrMesh=e,this._lastChanged=this._xrMesh.lastChangedTime}get xrMesh(){return this._xrMesh}get label(){return this._xrMesh.semanticLabel||""}get vertices(){return this._xrMesh.vertices}get indices(){return this._xrMesh.indices}destroy(){this._xrMesh&&(this._xrMesh=null,this.fire("remove"))}update(t){const e=this._meshDetection._manager,s=t.getPose(this._xrMesh.meshSpace,e._referenceSpace);s&&(this._position.copy(s.transform.position),this._rotation.copy(s.transform.orientation)),this._lastChanged!==this._xrMesh.lastChangedTime&&(this._lastChanged=this._xrMesh.lastChangedTime,this.fire("change"))}getPosition(){return this._position}getRotation(){return this._rotation}}class qS extends Ve{static{this.EVENT_AVAILABLE="available"}static{this.EVENT_UNAVAILABLE="unavailable"}static{this.EVENT_ADD="add"}static{this.EVENT_REMOVE="remove"}constructor(t){super(),this._supported=ze.browser&&!!window.XRMesh,this._available=!1,this._index=new Map,this._list=[],this._manager=t,this._supported&&(this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this))}update(t){if(!this._available){if(this._manager.session.enabledFeatures||!t.detectedMeshes.size)return;this._available=!0,this.fire("available")}for(const e of t.detectedMeshes){let s=this._index.get(e);s?s.update(t):(s=new XS(this,e),this._index.set(e,s),this._list.push(s),s.update(t),this.fire("add",s))}for(const e of this._index.values())t.detectedMeshes.has(e.xrMesh)||this._removeMesh(e)}_removeMesh(t){this._index.delete(t.xrMesh),this._list.splice(this._list.indexOf(t),1),t.destroy(),this.fire("remove",t)}_onSessionStart(){if(this._manager.session.enabledFeatures){const t=-1!==this._manager.session.enabledFeatures.indexOf("mesh-detection");if(!t)return;this._available=t,this.fire("available")}}_onSessionEnd(){if(this._available){this._available=!1;for(const t of this._index.values())this._removeMesh(t);this.fire("unavailable")}}get supported(){return this._supported}get available(){return this._available}get meshes(){return this._list}}class KS extends Ve{static{this.EVENT_DEPTHRESIZE="depth:resize"}constructor(t,e,s){super(),this._positionData=new Float32Array(3),this._viewport=new ls,this._projMat=new ps,this._projViewOffMat=new ps,this._viewMat=new ps,this._viewOffMat=new ps,this._viewMat3=new as,this._viewInvMat=new ps,this._viewInvOffMat=new ps,this._xrCamera=null,this._textureColor=null,this._textureDepth=null,this._depthInfo=null,this._emptyDepthBuffer=new Uint8Array(32),this._depthMatrix=new ps,this._manager=t,this._xrView=e;const n=this._manager.app.graphicsDevice;if(this._manager.views.supportedColor&&(this._xrCamera=this._xrView.camera,this._manager.views.availableColor&&this._xrCamera&&(this._textureColor=new pi(n,{format:6,mipmaps:!1,addressU:1,addressV:1,minFilter:1,magFilter:1,width:this._xrCamera.width,height:this._xrCamera.height,name:`XrView-${this._xrView.eye}-Color`}))),this._manager.views.supportedDepth&&this._manager.views.availableDepth){const t=this._manager.views.depthGpuOptimized?0:1;this._textureDepth=new pi(n,{format:this._manager.views.depthPixelFormat,arrayLength:1===s?0:s,mipmaps:!1,addressU:1,addressV:1,minFilter:t,magFilter:t,width:4,height:4,name:`XrView-${this._xrView.eye}-Depth`});for(let t=0;t<this._textureDepth._levels.length;t++)this._textureDepth._levels[t]=this._emptyDepthBuffer;this._textureDepth.upload()}(this._textureColor||this._textureDepth)&&n.on("devicelost",this._onDeviceLost,this)}get textureColor(){return this._textureColor}get textureDepth(){return this._textureDepth}get depthUvMatrix(){return this._depthMatrix}get depthValueToMeters(){return this._depthInfo?.rawValueToMeters||0}get eye(){return this._xrView.eye}get viewport(){return this._viewport}get projMat(){return this._projMat}get projViewOffMat(){return this._projViewOffMat}get viewOffMat(){return this._viewOffMat}get viewInvOffMat(){return this._viewInvOffMat}get viewMat3(){return this._viewMat3}get positionData(){return this._positionData}update(t,e){this._xrView=e,this._manager.views.availableColor&&(this._xrCamera=this._xrView.camera);const s=t.session.renderState.baseLayer.getViewport(this._xrView);this._viewport.x=s.x,this._viewport.y=s.y,this._viewport.z=s.width,this._viewport.w=s.height,this._projMat.set(this._xrView.projectionMatrix),this._viewMat.set(this._xrView.transform.inverse.matrix),this._viewInvMat.set(this._xrView.transform.matrix),this._updateTextureColor(),this._updateDepth(t)}_updateTextureColor(){if(!this._manager.views.availableColor||!this._xrCamera||!this._textureColor)return;const t=this._manager.webglBinding;if(!t)return;const e=t.getCameraImage(this._xrCamera);if(!e)return;const s=this._manager.app.graphicsDevice,n=s.gl;if(this._frameBufferSource){const t=n.COLOR_ATTACHMENT0,i=this._xrCamera.width,r=this._xrCamera.height;s.setFramebuffer(this._frameBufferSource),n.framebufferTexture2D(n.FRAMEBUFFER,t,n.TEXTURE_2D,e,0),s.setFramebuffer(this._frameBuffer),n.framebufferTexture2D(n.FRAMEBUFFER,t,n.TEXTURE_2D,this._textureColor.impl._glTexture,0),n.bindFramebuffer(n.READ_FRAMEBUFFER,this._frameBufferSource),n.bindFramebuffer(n.DRAW_FRAMEBUFFER,this._frameBuffer),n.blitFramebuffer(0,r,i,0,0,0,i,r,n.COLOR_BUFFER_BIT,n.NEAREST)}else this._frameBufferSource=n.createFramebuffer(),this._frameBuffer=n.createFramebuffer()}_updateDepth(t){if(!this._manager.views.availableDepth||!this._textureDepth)return;const e=this._manager.views.depthGpuOptimized,s=e?this._manager.webglBinding:t;if(!s)return void(this._depthInfo=null);const n=s.getDepthInformation(this._xrView);if(!n)return void(this._depthInfo=null);let i=!this._depthInfo!=!n;this._depthInfo=n;const r=this._depthInfo?.width||4,a=this._depthInfo?.height||4;let o=!1;if(this._textureDepth.width===r&&this._textureDepth.height===a||(this._textureDepth._width=r,this._textureDepth._height=a,i=!0,o=!0),i&&(this._depthInfo?this._depthMatrix.data.set(this._depthInfo.normDepthBufferFromNormView.matrix):this._depthMatrix.setIdentity()),this._depthInfo)if(e){if(this._depthInfo.texture){const t=this._manager.app.graphicsDevice.gl;switch(this._textureDepth.impl._glTexture=this._depthInfo.texture,"texture-array"===this._depthInfo.textureType?this._textureDepth.impl._glTarget=t.TEXTURE_2D_ARRAY:this._textureDepth.impl._glTarget=t.TEXTURE_2D,this._manager.views.depthPixelFormat){case Rs:this._textureDepth.impl._glInternalFormat=t.R32F,this._textureDepth.impl._glPixelType=t.FLOAT,this._textureDepth.impl._glFormat=t.RED;break;case Ms:this._textureDepth.impl._glInternalFormat=t.DEPTH_COMPONENT16,this._textureDepth.impl._glPixelType=t.UNSIGNED_SHORT,this._textureDepth.impl._glFormat=t.DEPTH_COMPONENT}this._textureDepth.impl._glCreated=!0}}else this._textureDepth._levels[0]=new Uint8Array(this._depthInfo.data),this._textureDepth.upload();else this._textureDepth._levels[0]=this._emptyDepthBuffer,this._textureDepth.upload();o&&this.fire("depth:resize",r,a)}updateTransforms(t){t?(this._viewInvOffMat.mul2(t,this._viewInvMat),this.viewOffMat.copy(this._viewInvOffMat).invert()):(this._viewInvOffMat.copy(this._viewInvMat),this.viewOffMat.copy(this._viewMat)),this._viewMat3.setFromMat4(this._viewOffMat),this._projViewOffMat.mul2(this._projMat,this._viewOffMat),this._positionData[0]=this._viewInvOffMat.data[12],this._positionData[1]=this._viewInvOffMat.data[13],this._positionData[2]=this._viewInvOffMat.data[14]}_onDeviceLost(){this._frameBufferSource=null,this._frameBuffer=null,this._depthInfo=null}getDepth(t,e){return this._manager.views.depthGpuOptimized?null:this._depthInfo?.getDepthInMeters(t,e)??null}destroy(){if(this._depthInfo=null,this._textureColor&&(this._textureColor.destroy(),this._textureColor=null),this._textureDepth&&(this._textureDepth.destroy(),this._textureDepth=null),this._frameBufferSource){const t=this._manager.app.graphicsDevice.gl;t.deleteFramebuffer(this._frameBufferSource),this._frameBufferSource=null,t.deleteFramebuffer(this._frameBuffer),this._frameBuffer=null}}}class YS extends Ve{static{this.EVENT_ADD="add"}static{this.EVENT_REMOVE="remove"}constructor(t){super(),this._index=new Map,this._indexTmp=new Map,this._list=[],this._supportedColor=ze.browser&&!!window.XRCamera&&!!window.XRWebGLBinding,this._supportedDepth=ze.browser&&!!window.XRDepthInformation,this._availableColor=!1,this._availableDepth=!1,this._depthUsage="",this._depthFormat="",this._depthFormats={[fS]:2,[pS]:Ms,[mS]:Rs},this._manager=t,this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this)}get list(){return this._list}get supportedColor(){return this._supportedColor}get supportedDepth(){return this._supportedDepth}get availableColor(){return this._availableColor}get availableDepth(){return this._availableDepth}get depthUsage(){return this._depthUsage}get depthGpuOptimized(){return this._depthUsage===uS}get depthFormat(){return this._depthFormat}get depthPixelFormat(){return this._depthFormats[this._depthFormat]??null}update(t,e){for(let t=0;t<e.length;t++)this._indexTmp.set(e[t].eye,e[t]);for(const[s,n]of this._indexTmp){let i=this._index.get(s);i?i.update(t,n):(i=new KS(this._manager,n,e.length),this._index.set(s,i),this._list.push(i),i.update(t,n),this.fire("add",i))}for(const[t,e]of this._index){if(this._indexTmp.has(t))continue;e.destroy(),this._index.delete(t);const s=this._list.indexOf(e);-1!==s&&this._list.splice(s,1),this.fire("remove",e)}this._indexTmp.clear()}get(t){return this._index.get(t)||null}_onSessionStart(){if(this._manager.type===oS&&this._manager.session.enabledFeatures&&(this._availableColor=-1!==this._manager.session.enabledFeatures.indexOf("camera-access"),this._availableDepth=-1!==this._manager.session.enabledFeatures.indexOf("depth-sensing"),this._availableDepth)){const t=this._manager.session;this._depthUsage=t.depthUsage,this._depthFormat=t.depthDataFormat}}_onSessionEnd(){for(const t of this._index.values())t.destroy();this._index.clear(),this._availableColor=!1,this._availableDepth=!1,this._depthUsage="",this._depthFormat="",this._list.length=0}}class QS extends Ve{static{this.EVENT_AVAILABLE="available"}static{this.EVENT_START="start"}static{this.EVENT_END="end"}static{this.EVENT_UPDATE="update"}static{this.EVENT_ERROR="error"}constructor(t){super(),this._supported=ze.browser&&!!navigator.xr,this._available={},this._type=null,this._spaceType=null,this._session=null,this._baseLayer=null,this.webglBinding=null,this._referenceSpace=null,this._camera=null,this._localPosition=new rs,this._localRotation=new ms,this._depthNear=.1,this._depthFar=1e3,this._supportedFrameRates=null,this._width=0,this._height=0,this._framebufferScaleFactor=1,this.app=t,this._available.inline=!1,this._available["immersive-vr"]=!1,this._available[oS]=!1,this.views=new YS(this),this.domOverlay=new gS(this),this.hitTest=new bS(this),this.imageTracking=new xS(this),this.planeDetection=new WS(this),this.meshDetection=new qS(this),this.input=new FS(this),this.lightEstimation=new VS(this),this.anchors=new $S(this),this.views=new YS(this),this._supported&&(navigator.xr.addEventListener("devicechange",()=>{this._deviceAvailabilityCheck()}),this._deviceAvailabilityCheck(),this.app.graphicsDevice.on("devicelost",this._onDeviceLost,this),this.app.graphicsDevice.on("devicerestored",this._onDeviceRestored,this))}destroy(){}start(t,e,s,n){let i=n;if("object"==typeof n&&(i=n.callback),!this._available[e])return void(i&&i(new Error("XR is not available")));if(this._session)return void(i&&i(new Error("XR session is already started")));this._camera=t,this._camera.camera.xr=this,this._type=e,this._spaceType=s,this._framebufferScaleFactor=n?.framebufferScaleFactor??1,this._setClipPlanes(t.nearClip,t.farClip);const r={requiredFeatures:[s],optionalFeatures:[]},a=this.app.graphicsDevice;a?.isWebGPU&&r.requiredFeatures.push("webgpu");const o=a?.isWebGL2;if(e===oS){if(r.optionalFeatures.push("light-estimation"),r.optionalFeatures.push("hit-test"),n&&(n.imageTracking&&this.imageTracking.supported&&r.optionalFeatures.push("image-tracking"),n.planeDetection&&r.optionalFeatures.push("plane-detection"),n.meshDetection&&r.optionalFeatures.push("mesh-detection")),this.domOverlay.supported&&this.domOverlay.root&&(r.optionalFeatures.push("dom-overlay"),r.domOverlay={root:this.domOverlay.root}),n&&n.anchors&&this.anchors.supported&&r.optionalFeatures.push("anchors"),n&&n.depthSensing&&this.views.supportedDepth){r.optionalFeatures.push("depth-sensing");const t=[],e=[];if(t.push(uS,"cpu-optimized"),e.push(mS,fS,pS),n.depthSensing.usagePreference){const e=t.indexOf(n.depthSensing.usagePreference);-1!==e&&t.splice(e,1),t.unshift(n.depthSensing.usagePreference)}if(n.depthSensing.dataFormatPreference){const t=e.indexOf(n.depthSensing.dataFormatPreference);-1!==t&&e.splice(t,1),e.unshift(n.depthSensing.dataFormatPreference)}r.depthSensing={usagePreference:t,dataFormatPreference:e}}o&&n&&n.cameraColor&&this.views.supportedColor&&r.optionalFeatures.push("camera-access")}r.optionalFeatures.push("hand-tracking"),n&&n.optionalFeatures&&(r.optionalFeatures=r.optionalFeatures.concat(n.optionalFeatures)),this.imageTracking.supported&&this.imageTracking.images.length?this.imageTracking.prepareImages((t,n)=>{if(t)return i&&i(t),void this.fire("error",t);null!==n&&(r.trackedImages=n),this._onStartOptionsReady(e,s,r,i)}):this._onStartOptionsReady(e,s,r,i)}_onStartOptionsReady(t,e,s,n){navigator.xr.requestSession(t,s).then(t=>{this._onSessionStart(t,e,n)}).catch(t=>{this._camera.camera.xr=null,this._camera=null,this._type=null,this._spaceType=null,n&&n(t),this.fire("error",t)})}end(t){this._session?(this.webglBinding=null,t&&this.once("end",t),this._session.end()):t&&t(new Error("XR Session is not initialized"))}isAvailable(t){return this._available[t]}_deviceAvailabilityCheck(){for(const t in this._available)this._sessionSupportCheck(t)}initiateRoomCapture(t){this._session?this._session.initiateRoomCapture?this._session.initiateRoomCapture().then(()=>{t&&t(null)}).catch(e=>{t&&t(e)}):t(new Error("Session does not support manual room capture")):t(new Error("Session is not active"))}updateTargetFrameRate(t,e){this._session?.updateTargetFrameRate?this._session.updateTargetFrameRate(t).then(()=>{e?.()}).catch(t=>{e?.(t)}):e?.(new Error("unable to update frameRate"))}_sessionSupportCheck(t){navigator.xr.isSessionSupported(t).then(e=>{this._available[t]!==e&&(this._available[t]=e,this.fire("available",t,e),this.fire(`available:${t}`,e))}).catch(t=>{this.fire("error",t)})}_onSessionStart(t,e,s){let n=!1;this._session=t;const i=()=>{this.fire("visibility:change",t.visibilityState)},r=()=>{this._setClipPlanes(this._camera.nearClip,this._camera.farClip)},a=()=>{this._camera&&(this._camera.off("set_nearClip",r),this._camera.off("set_farClip",r),this._camera.camera.xr=null,this._camera=null),t.removeEventListener("end",a),t.removeEventListener("visibilitychange",i),n||this.fire("end"),this._session=null,this._referenceSpace=null,this._width=0,this._height=0,this._type=null,this._spaceType=null,this.app.systems&&this.app.requestAnimationFrame()};t.addEventListener("end",a),t.addEventListener("visibilitychange",i),this._camera.on("set_nearClip",r),this._camera.on("set_farClip",r),this._createBaseLayer(),this.session.supportedFrameRates?this._supportedFrameRates=Array.from(this.session.supportedFrameRates):this._supportedFrameRates=null,this._session.addEventListener("frameratechange",()=>{this.fire("frameratechange",this._session?.frameRate)}),t.requestReferenceSpace(e).then(t=>{this._referenceSpace=t,this.app.requestAnimationFrame(),s&&s(null),this.fire("start")}).catch(e=>{n=!0,t.end(),s&&s(e),this.fire("error",e)})}_setClipPlanes(t,e){this._depthNear===t&&this._depthFar===e||(this._depthNear=t,this._depthFar=e,this._session&&this._session.updateRenderState({depthNear:this._depthNear,depthFar:this._depthFar}))}_createBaseLayer(){const t=this.app.graphicsDevice,e=t.maxPixelRatio/window.devicePixelRatio*this._framebufferScaleFactor;if(this._baseLayer=new XRWebGLLayer(this._session,t.gl,{alpha:!0,depth:!0,stencil:!0,framebufferScaleFactor:e,antialias:!1}),t?.isWebGL2&&window.XRWebGLBinding)try{this.webglBinding=new XRWebGLBinding(this._session,t.gl)}catch(t){this.fire("error",t)}this._session.updateRenderState({baseLayer:this._baseLayer,depthNear:this._depthNear,depthFar:this._depthFar})}_onDeviceLost(){this._session&&(this.webglBinding&&(this.webglBinding=null),this._baseLayer=null,this._session.updateRenderState({baseLayer:this._baseLayer,depthNear:this._depthNear,depthFar:this._depthFar}))}_onDeviceRestored(){this._session&&setTimeout(()=>{this.app.graphicsDevice.gl.makeXRCompatible().then(()=>{this._createBaseLayer()}).catch(t=>{this.fire("error",t)})},0)}update(t){if(!this._session)return!1;const e=t.session.renderState.baseLayer.framebufferWidth,s=t.session.renderState.baseLayer.framebufferHeight;this._width===e&&this._height===s||(this._width=e,this._height=s,this.app.graphicsDevice.setResolution(e,s));const n=t.getViewerPose(this._referenceSpace);if(!n)return!1;const i=this.views.list.length;this.views.update(t,n.views);const r=n.transform.position,a=n.transform.orientation;if(this._localPosition.set(r.x,r.y,r.z),this._localRotation.set(a.x,a.y,a.z,a.w),0===i&&this.views.list.length>0){const t=new ps,e=this.views.list[0];t.copy(e.projMat);const s=t.data,n=2*Math.atan(1/s[5])*180/Math.PI,i=s[5]/s[0],r=s[14]/(s[10]+1),a=s[14]/(s[10]-1),o=!1;this._camera.camera.setXrProperties({aspectRatio:i,farClip:r,fov:n,horizontalFov:o,nearClip:a})}return this._camera.camera._node.setLocalPosition(this._localPosition),this._camera.camera._node.setLocalRotation(this._localRotation),this.input.update(t),this._type===oS&&(this.hitTest.supported&&this.hitTest.update(t),this.lightEstimation.supported&&this.lightEstimation.update(t),this.imageTracking.supported&&this.imageTracking.update(t),this.anchors.supported&&this.anchors.update(t),this.planeDetection.supported&&this.planeDetection.update(t),this.meshDetection.supported&&this.meshDetection.update(t)),this.fire("update",t),!0}get supported(){return this._supported}get active(){return!!this._session}get type(){return this._type}get spaceType(){return this._spaceType}get session(){return this._session}get frameRate(){return this._session?.frameRate??null}get supportedFrameRates(){return this._supportedFrameRates}get framebufferScaleFactor(){return this._framebufferScaleFactor}set fixedFoveation(t){null!==(this._baseLayer?.fixedFoveation??null)&&(this._baseLayer.fixedFoveation=t)}get fixedFoveation(){return this._baseLayer?.fixedFoveation??null}get camera(){return this._camera?this._camera.entity:null}get visibilityState(){return this._session?this._session.visibilityState:null}}const ZS=[],JS=[[],[],[]];class tx extends Fo{constructor(t,e){super(t),this.viewBindGroups=[],this.renderer=e}destroy(){this.viewBindGroups.forEach(t=>{t.defaultUniformBuffer.destroy(),t.destroy()}),this.viewBindGroups.length=0}update(t,e,s,n,i){this.camera=t,this.scene=e,this.layers=s,this.mapping=n,this.depth=i,e.clusteredLightingEnabled&&(this.emptyWorldClusters=this.renderer.worldClustersAllocator.empty)}execute(){const t=this.device,{renderer:e,camera:s,scene:n,layers:i,mapping:r,renderTarget:a}=this,o=n.layers.layerList,l=n.layers.subLayerEnabled,h=n.layers.subLayerList;for(let c=0;c<o.length;c++){const d=o[c];if(!(i&&i.indexOf(d)<0)&&(d.enabled&&l[c]&&d.camerasSet.has(s.camera))){const i=h[c];d._clearDepthBuffer&&e.clear(s.camera,!1,!0,!1);const o=d.meshInstances;for(let t=0;t<o.length;t++){const e=o[t];e.pick&&e.transparent===i&&(ZS.push(e),r.set(e.id,e))}if(ZS.length>0){const i=n.clusteredLightingEnabled;if(i){this.emptyWorldClusters.activate()}e.setCameraUniforms(s.camera,a),t.supportsUniformBuffers&&(e.initViewBindGroupFormat(i),e.setupViewUniformBuffers(this.viewBindGroups,e.viewUniformFormat,e.viewBindGroupFormat,null));const r=this.depth?4:3;e.renderForward(s.camera,a,ZS,JS,r,e=>{t.setBlendState(Ti.NOBLEND)}),ZS.length=0}}}}}const ex=new Set,sx=new ls,nx=new Float32Array(1),ix=new Int32Array(nx.buffer);let rx=class{constructor(t,e,s,n=!1){this.renderTarget=null,this.colorBuffer=null,this.depthBuffer=null,this.renderTargetDepth=null,this.mapping=new Map,this.deviceValid=!0,this.device=t.graphicsDevice,this.renderPass=new tx(this.device,t.renderer),this.depth=n,this.width=0,this.height=0,this.resize(e,s),this.allocateRenderTarget(),this.device.on("destroy",()=>{this.deviceValid=!1})}destroy(){this.releaseRenderTarget(),this.renderPass?.destroy()}getSelection(t,e,s=1,n=1){const i=this.device;if(i.isWebGPU)return[];e=this.renderTarget.height-(e+n);const r=this.sanitizeRect(t,e,s,n);i.setRenderTarget(this.renderTarget),i.updateBegin();const a=new Uint8Array(4*r.z*r.w);return i.readPixels(r.x,r.y,r.z,r.w,a),i.updateEnd(),this.decodePixels(a,this.mapping)}getSelectionAsync(t,e,s=1,n=1){return this.renderTarget&&this.renderTarget.colorBuffer?this._readTexture(this.renderTarget.colorBuffer,t,e,s,n,this.renderTarget).then(t=>this.decodePixels(t,this.mapping)):Promise.resolve([])}_readTexture(t,e,s,n,i,r){this.device?.isWebGL2&&(s=r.height-(s+i));const a=this.sanitizeRect(e,s,n,i);return t.read(a.x,a.y,a.z,a.w,{immediate:!0,renderTarget:r})}async getWorldPointAsync(t,e){const s=this.renderPass.camera;if(!s)return null;const n=(new ps).mul2(s.camera.projectionMatrix,s.camera.viewMatrix).invert(),i=await this.getPointDepthAsync(t,e);if(null===i)return null;const r=new ls(t/this.width*2-1,2*(1-e/this.height)-1,2*i-1,1);return n.transformVec4(r,r),r.mulScalar(1/r.w),new rs(r.x,r.y,r.z)}async getPointDepthAsync(t,e){if(!this.depthBuffer)return null;const s=await this._readTexture(this.depthBuffer,t,e,1,1,this.renderTargetDepth),n=s[0]<<24|s[1]<<16|s[2]<<8|s[3];return 4294967295===n?null:(ix[0]=n,nx[0])}sanitizeRect(t,e,s,n){const i=this.renderTarget.width,r=this.renderTarget.height;return t=Qe.clamp(Math.floor(t),0,i-1),e=Qe.clamp(Math.floor(e),0,r-1),s=Math.floor(Math.max(s,1)),s=Math.min(s,i-t),n=Math.floor(Math.max(n,1)),n=Math.min(n,r-e),sx.set(t,e,s,n)}decodePixels(t,e){const s=[];if(this.deviceValid){const n=t.length;for(let s=0;s<n;s+=4){const n=t[s+0],i=t[s+1],r=t[s+2],a=(t[s+3]<<24|n<<16|i<<8|r)>>>0;4294967295!==a&&ex.add(e.get(a))}ex.forEach(t=>{t&&s.push(t)}),ex.clear()}return s}createTexture(t){return new pi(this.device,{format:7,width:this.width,height:this.height,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1,name:t})}allocateRenderTarget(){this.colorBuffer=this.createTexture("pick");const t=[this.colorBuffer];this.depth&&(this.depthBuffer=this.createTexture("pick-depth"),t.push(this.depthBuffer),this.renderTargetDepth=new ji({colorBuffer:this.depthBuffer,depth:!1})),this.renderTarget=new ji({colorBuffers:t,depth:!0})}releaseRenderTarget(){this.renderTarget?.destroyTextureBuffers(),this.renderTarget?.destroy(),this.renderTarget=null,this.renderTargetDepth?.destroy(),this.renderTargetDepth=null,this.colorBuffer=null,this.depthBuffer=null}prepare(t,e,s){s instanceof Ru&&(s=[s]),this.renderTarget?.resize(this.width,this.height),this.renderTargetDepth?.resize(this.width,this.height),this.mapping.clear();const n=this.renderPass;n.init(this.renderTarget),n.setClearColor(Ze.WHITE),n.depthStencilOps.clearDepth=!0,n.update(t,e,s,this.mapping,this.depth),n.render()}resize(t,e){this.width=Math.floor(t),this.height=Math.floor(e)}};os.prototype.scale=os.prototype.mulScalar,rs.prototype.scale=rs.prototype.mulScalar,ls.prototype.scale=ls.prototype.mulScalar,Object.defineProperties(ji.prototype,{_glFrameBuffer:{get:function(){return this.impl._glFrameBuffer},set:function(t){}}}),Object.defineProperty(Ui,"defaultInstancingFormat",{get:function(){return null}}),Object.defineProperties(pi.prototype,{rgbm:{get:function(){return this.type===bn},set:function(t){this.type=t?bn:yn}},swizzleGGGR:{get:function(){return this.type===wn},set:function(t){this.type=t?wn:yn}},_glTexture:{get:function(){return this.impl._glTexture}}}),Object.defineProperty(Gi.prototype,"boneLimit",{get:function(){return 1024}}),Object.defineProperty(Gi.prototype,"webgl2",{get:function(){return this.isWebGL2}}),Object.defineProperty(Gi.prototype,"textureFloatHighPrecision",{get:function(){return!0}}),Object.defineProperty(Gi.prototype,"extBlendMinmax",{get:function(){return!0}}),Object.defineProperty(Gi.prototype,"extTextureHalfFloat",{get:function(){return!0}}),Object.defineProperty(Gi.prototype,"extTextureLod",{get:function(){return!0}}),Object.defineProperty(Gi.prototype,"textureHalfFloatFilterable",{get:function(){return!0}}),Object.defineProperty(Gi.prototype,"supportsMrt",{get:function(){return!0}}),Object.defineProperty(Gi.prototype,"supportsVolumeTextures",{get:function(){return!0}}),Object.defineProperty(Gi.prototype,"supportsInstancing",{get:function(){return!0}}),Object.defineProperty(Gi.prototype,"textureHalfFloatUpdatable",{get:function(){return!0}}),Object.defineProperty(Gi.prototype,"extTextureFloat",{get:function(){return!0}}),Object.defineProperty(Gi.prototype,"extStandardDerivatives",{get:function(){return!0}}),Ti.DEFAULT=Object.freeze(new Ti);const ax=new Ti,ox=new Ai;function lx(t,e,s=""){Object.defineProperty(t.prototype,e,{set:function(t){},get:function(){}})}function hx(t,e){Object.defineProperty(hp.prototype,e,{get:function(){return this[t]},set:function(e){this[t]=e}})}function cx(t){Object.defineProperty(hp.prototype,t,{get:function(){return!0},set:function(t){}})}function dx(t,e){"pass"!==t&&Object.defineProperty(Kf.prototype,t,{get:function(){return this.litOptions[e||t]},set:function(s){this.litOptions[e||t]=s}})}Gi.prototype.setBlendFunction=function(t,e){const s=this.blendState;ax.copy(s),ax.setColorBlend(s.colorOp,t,e),ax.setAlphaBlend(s.alphaOp,t,e),this.setBlendState(ax)},Gi.prototype.setBlendFunctionSeparate=function(t,e,s,n){const i=this.blendState;ax.copy(i),ax.setColorBlend(i.colorOp,t,e),ax.setAlphaBlend(i.alphaOp,s,n),this.setBlendState(ax)},Gi.prototype.setBlendEquation=function(t){const e=this.blendState;ax.copy(e),ax.setColorBlend(t,e.colorSrcFactor,e.colorDstFactor),ax.setAlphaBlend(t,e.alphaSrcFactor,e.alphaDstFactor),this.setBlendState(ax)},Gi.prototype.setBlendEquationSeparate=function(t,e){const s=this.blendState;ax.copy(s),ax.setColorBlend(t,s.colorSrcFactor,s.colorDstFactor),ax.setAlphaBlend(e,s.alphaSrcFactor,s.alphaDstFactor),this.setBlendState(ax)},Gi.prototype.setColorWrite=function(t,e,s,n){const i=this.blendState;ax.copy(i),ax.setColorWrite(t,e,s,n),this.setBlendState(ax)},Gi.prototype.getBlending=function(){return this.blendState.blend},Gi.prototype.setBlending=function(t){ax.copy(this.blendState),ax.blend=t,this.setBlendState(ax)},Gi.prototype.setDepthWrite=function(t){ox.copy(this.depthState),ox.write=t,this.setDepthState(ox)},Gi.prototype.setDepthFunc=function(t){ox.copy(this.depthState),ox.func=t,this.setDepthState(ox)},Gi.prototype.setDepthTest=function(t){ox.copy(this.depthState),ox.test=t,this.setDepthState(ox)},Gi.prototype.getCullMode=function(){return this.cullMode},new Proxy({},{get:(t,e)=>Fh.get(_m().graphicsDevice,In).get(e),set:(t,e,s)=>(Fh.get(_m().graphicsDevice,In).set(e,s),!0)}),Object.defineProperty(Vf.prototype,"defaultMaterial",{get:function(){return sc(_m().graphicsDevice)}}),Object.defineProperty(Vf.prototype,"fogColor",{set:function(t){this.fog.color=t},get:function(){return this.fog.color}}),Object.defineProperty(Vf.prototype,"fogEnd",{set:function(t){this.fog.end=t},get:function(){return this.fog.end}}),Object.defineProperty(Vf.prototype,"fogStart",{set:function(t){this.fog.start=t},get:function(){return this.fog.start}}),Object.defineProperty(Vf.prototype,"fogDensity",{set:function(t){this.fog.density=t},get:function(){return this.fog.density}}),Object.defineProperty(Vf.prototype,"toneMapping",{set:function(t){},get:function(){}}),Object.defineProperty(Vf.prototype,"gammaCorrection",{set:function(t){},get:function(){}}),Object.defineProperty(Vf.prototype,"rendering",{set:function(t){},get:function(){}}),Object.defineProperty(Ou.prototype,"_meshInstances",{get:function(){return null}}),Object.defineProperty(Vf.prototype,"drawCalls",{get:function(){return null}}),["128","64","32","16","8","4"].forEach((t,e)=>{Object.defineProperty(Vf.prototype,`skyboxPrefiltered${t}`,{get:function(){return this._prefilteredCubemaps[e]},set:function(t){this._prefilteredCubemaps[e]=t,this.updateShaders=!0}})}),Object.defineProperty(Vf.prototype,"models",{get:function(){return this._models||(this._models=[]),this._models}}),lx(Ru,"renderTarget"),lx(Ru,"onPreCull"),lx(Ru,"onPreRender"),lx(Ru,"onPreRenderOpaque"),lx(Ru,"onPreRenderTransparent"),lx(Ru,"onPostCull"),lx(Ru,"onPostRender"),lx(Ru,"onPostRenderOpaque"),lx(Ru,"onPostRenderTransparent"),lx(Ru,"onDrawCall"),lx(Ru,"layerReference"),lx(X_,"onPreCull","Use Scene#EVENT_PRECULL event instead."),lx(X_,"onPostCull","Use Scene#EVENT_POSTCULL event instead."),lx(X_,"onPreRender","Use Scene#EVENT_PRERENDER event instead."),lx(X_,"onPostRender","Use Scene#EVENT_POSTRENDER event instead."),lx(X_,"onPreRenderLayer","Use Scene#EVENT_PRERENDER_LAYER event instead."),lx(X_,"onPostRenderLayer","Use Scene#EVENT_POSTRENDER_LAYER event instead."),Eu.prototype.renderComposition=function(t){_m().renderComposition(t)},fc.prototype.syncAabb=function(){},Ku.prototype.getTarget=function(t){return this.targets[t]},Hc.prototype.getChildren=function(){return this.children},Hc.prototype.getName=function(){return this.name},Hc.prototype.getPath=function(){return this.path},Hc.prototype.getRoot=function(){return this.root},Hc.prototype.getParent=function(){return this.parent},Hc.prototype.setName=function(t){this.name=t},Object.defineProperty(Cd.prototype,"shader",{set:function(t){},get:function(){return null}}),Object.defineProperty(Cd.prototype,"blend",{set:function(t){this.blendState.blend=t},get:function(){return this.blendState.blend}}),Object.defineProperty(hp.prototype,"shininess",{get:function(){return 100*this.gloss},set:function(t){this.gloss=.01*t}}),Object.defineProperty(hp.prototype,"useGammaTonemap",{get:function(){return this.useTonemap},set:function(t){this.useTonemap=t}}),Object.defineProperty(hp.prototype,"anisotropy",{get:function(){const t=Math.sign(Math.cos(this.anisotropyRotation*Qe.DEG_TO_RAD*2));return this.anisotropyIntensity*t},set:function(t){this.anisotropyIntensity=Math.abs(t),this.anisotropyRotation=t>=0?0:90}}),cx("sheenTint"),cx("diffuseTint"),cx("emissiveTint"),cx("ambientTint"),hx("specularTint","specularMapTint"),hx("aoVertexColor","aoMapVertexColor"),hx("diffuseVertexColor","diffuseMapVertexColor"),hx("specularVertexColor","specularMapVertexColor"),hx("emissiveVertexColor","emissiveMapVertexColor"),hx("metalnessVertexColor","metalnessMapVertexColor"),hx("glossVertexColor","glossMapVertexColor"),hx("opacityVertexColor","opacityMapVertexColor"),hx("lightVertexColor","lightMapVertexColor"),hx("sheenGloss","sheenGlossiess"),hx("clearCoatGloss","clearCostGlossiness"),dx("refraction","useRefraction");const ux=new Wf,fx=Object.getOwnPropertyNames(ux);for(const t in fx)dx(fx[t]);Bm.prototype.getAssetById=function(t){return this.get(t)},Object.defineProperty(OS.prototype,"ray",{get:function(){return this._rayLocal}}),Object.defineProperty(OS.prototype,"position",{get:function(){return this._localPosition}}),Object.defineProperty(OS.prototype,"rotation",{get:function(){return this._localRotation}});Object.defineProperty(nl.prototype,"wheel",{get:function(){return-2*this.wheelDelta}}),ag.prototype.isFullscreen=function(){return!!document.fullscreenElement},ag.prototype.enableFullscreen=function(t,e,s){t=t||this.graphicsDevice.canvas;const n=function(){e(),document.removeEventListener("fullscreenchange",n)},i=function(){s(),document.removeEventListener("fullscreenerror",i)};e&&document.addEventListener("fullscreenchange",n,!1),s&&document.addEventListener("fullscreenerror",i,!1),t.requestFullscreen?t.requestFullscreen(Element.ALLOW_KEYBOARD_INPUT):s()},ag.prototype.disableFullscreen=function(t){const e=function(){t(),document.removeEventListener("fullscreenchange",e)};t&&document.addEventListener("fullscreenchange",e,!1),document.exitFullscreen()},ag.prototype.getSceneUrl=function(t){const e=this.scenes.find(t);return e?e.url:null},ag.prototype.loadScene=function(t,e){this.scenes.loadScene(t,e)},ag.prototype.loadSceneHierarchy=function(t,e){this.scenes.loadSceneHierarchy(t,e)},ag.prototype.loadSceneSettings=function(t,e){this.scenes.loadSceneSettings(t,e)},class extends xg{constructor(t,e){super(t,e),this._type="asset",this._asset=null,this._model=null,this._mapping={},this._castShadows=!0,this._receiveShadows=!0,this._materialAsset=null,this._castShadowsLightmap=!0,this._lightmapped=!1,this._lightmapSizeMultiplier=1,this.isStatic=!1,this._layers=[0],this._batchGroupId=-1,this._customAabb=null,this._area=null,this._materialEvents=null,this._clonedModel=!1,this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._material=t.defaultMaterial,e.on("remove",this.onRemoveChild,this),e.on("removehierarchy",this.onRemoveChild,this),e.on("insert",this.onInsertChild,this),e.on("inserthierarchy",this.onInsertChild,this)}set meshInstances(t){this._model&&(this._model.meshInstances=t)}get meshInstances(){return this._model?this._model.meshInstances:null}set customAabb(t){if(this._customAabb=t,this._model){const t=this._model.meshInstances;if(t)for(let e=0;e<t.length;e++)t[e].setCustomAabb(this._customAabb)}}get customAabb(){return this._customAabb}set type(t){if(this._type!==t)if(this._area=null,this._type=t,"asset"===t)null!==this._asset?this._bindModelAsset(this._asset):this.model=null;else{const e=v_(this.system.app.graphicsDevice,t);this._area=e.area;const s=e.mesh,n=new Hc,i=new qu;i.graph=n,i.meshInstances=[new fc(s,this._material,n)],this.model=i,this._asset=null}}get type(){return this._type}set asset(t){const e=this.system.app.assets;let s=t;if(t instanceof Fm&&(s=t.id),this._asset!==s){if(this._asset){e.off(`add:${this._asset}`,this._onModelAssetAdded,this);const t=e.get(this._asset);t&&this._unbindModelAsset(t)}if(this._asset=s,this._asset){const t=e.get(this._asset);t?this._bindModelAsset(t):(this.model=null,e.on(`add:${this._asset}`,this._onModelAssetAdded,this))}else this.model=null}}get asset(){return this._asset}set model(t){if(this._model!==t&&(!t||!t._immutable)&&(this._model&&(this._model._immutable=!1,this.removeModelFromLayers(),this._model.getGraph().destroy(),delete this._model._entity,this._clonedModel&&(this._model.destroy(),this._clonedModel=!1)),this._model=t,this._model)){this._model._immutable=!0;const t=this._model.meshInstances;for(let e=0;e<t.length;e++)t[e].castShadow=this._castShadows,t[e].receiveShadow=this._receiveShadows,t[e].setCustomAabb(this._customAabb);this.lightmapped=this._lightmapped,this.entity.addChild(this._model.graph),this.enabled&&this.entity.enabled&&this.addModelToLayers(),this._model._entity=this.entity,this.entity.animation&&this.entity.animation.setModel(this._model),this.entity.anim&&this.entity.anim.rebind(),"asset"===this.type?this.mapping=this._mapping:this._unsetMaterialEvents()}}get model(){return this._model}set lightmapped(t){if(t!==this._lightmapped&&(this._lightmapped=t,this._model)){const e=this._model.meshInstances;for(let s=0;s<e.length;s++)e[s].setLightmapped(t)}}get lightmapped(){return this._lightmapped}set castShadows(t){if(this._castShadows===t)return;const e=this._model;if(e){const s=this.layers,n=this.system.app.scene;if(this._castShadows&&!t)for(let t=0;t<s.length;t++){const s=this.system.app.scene.layers.getLayerById(this.layers[t]);s&&s.removeShadowCasters(e.meshInstances)}const i=e.meshInstances;for(let e=0;e<i.length;e++)i[e].castShadow=t;if(!this._castShadows&&t)for(let t=0;t<s.length;t++){const i=n.layers.getLayerById(s[t]);i&&i.addShadowCasters(e.meshInstances)}}this._castShadows=t}get castShadows(){return this._castShadows}set receiveShadows(t){if(this._receiveShadows!==t&&(this._receiveShadows=t,this._model)){const e=this._model.meshInstances;for(let s=0,n=e.length;s<n;s++)e[s].receiveShadow=t}}get receiveShadows(){return this._receiveShadows}set castShadowsLightmap(t){this._castShadowsLightmap=t}get castShadowsLightmap(){return this._castShadowsLightmap}set lightmapSizeMultiplier(t){this._lightmapSizeMultiplier=t}get lightmapSizeMultiplier(){return this._lightmapSizeMultiplier}set layers(t){const e=this.system.app.scene.layers;if(this.meshInstances)for(let t=0;t<this._layers.length;t++){const s=e.getLayerById(this._layers[t]);s&&s.removeMeshInstances(this.meshInstances)}this._layers.length=0;for(let e=0;e<t.length;e++)this._layers[e]=t[e];if(this.enabled&&this.entity.enabled&&this.meshInstances)for(let t=0;t<this._layers.length;t++){const s=e.getLayerById(this._layers[t]);s&&s.addMeshInstances(this.meshInstances)}}get layers(){return this._layers}set batchGroupId(t){this._batchGroupId!==t&&(this.entity.enabled&&this._batchGroupId>=0&&this.system.app.batcher?.remove(qh.MODEL,this.batchGroupId,this.entity),this.entity.enabled&&t>=0&&this.system.app.batcher?.insert(qh.MODEL,t,this.entity),t<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&this.addModelToLayers(),this._batchGroupId=t)}get batchGroupId(){return this._batchGroupId}set materialAsset(t){let e=t;t instanceof Fm&&(e=t.id);const s=this.system.app.assets;if(e!==this._materialAsset){if(this._materialAsset){s.off(`add:${this._materialAsset}`,this._onMaterialAssetAdd,this);const t=s.get(this._materialAsset);t&&this._unbindMaterialAsset(t)}if(this._materialAsset=e,this._materialAsset){const t=s.get(this._materialAsset);t?this._bindMaterialAsset(t):(this._setMaterial(this.system.defaultMaterial),s.on(`add:${this._materialAsset}`,this._onMaterialAssetAdd,this))}else this._setMaterial(this.system.defaultMaterial)}}get materialAsset(){return this._materialAsset}set material(t){this._material!==t&&(this.materialAsset=null,this._setMaterial(t))}get material(){return this._material}set mapping(t){if("asset"!==this._type)return;if(this._unsetMaterialEvents(),t||(t={}),this._mapping=t,!this._model)return;const e=this._model.meshInstances,s=this.asset?this.system.app.assets.get(this.asset):null,n=s?s.data.mapping:null;let i=null;for(let s=0,r=e.length;s<r;s++)if(void 0!==t[s])t[s]?(i=this.system.app.assets.get(t[s]),this._loadAndSetMeshInstanceMaterial(i,e[s],s)):e[s].material=this.system.defaultMaterial;else if(n)if(n[s]&&(n[s].material||n[s].path)){if(void 0!==n[s].material)i=this.system.app.assets.get(n[s].material);else if(void 0!==n[s].path){const t=this._getMaterialAssetUrl(n[s].path);t&&(i=this.system.app.assets.getByUrl(t))}this._loadAndSetMeshInstanceMaterial(i,e[s],s)}else e[s].material=this.system.defaultMaterial}get mapping(){return this._mapping}addModelToLayers(){const t=this.system.app.scene.layers;for(let e=0;e<this._layers.length;e++){const s=t.getLayerById(this._layers[e]);s&&s.addMeshInstances(this.meshInstances)}}removeModelFromLayers(){const t=this.system.app.scene.layers;for(let e=0;e<this._layers.length;e++){const s=t.getLayerById(this._layers[e]);s&&s.removeMeshInstances(this.meshInstances)}}onRemoveChild(){this._model&&this.removeModelFromLayers()}onInsertChild(){this._model&&this.enabled&&this.entity.enabled&&this.addModelToLayers()}onRemove(){this.asset=null,this.model=null,this.materialAsset=null,this._unsetMaterialEvents(),this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this)}onLayersChanged(t,e){this.addModelToLayers(),t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this)}onLayerAdded(t){this.layers.indexOf(t.id)<0||t.addMeshInstances(this.meshInstances)}onLayerRemoved(t){this.layers.indexOf(t.id)<0||t.removeMeshInstances(this.meshInstances)}_setMaterialEvent(t,e,s,n){const i=`${e}:${s}`;this.system.app.assets.on(i,n,this),this._materialEvents||(this._materialEvents=[]),this._materialEvents[t]||(this._materialEvents[t]={}),this._materialEvents[t][i]={id:s,handler:n}}_unsetMaterialEvents(){const t=this.system.app.assets,e=this._materialEvents;if(e){for(let s=0,n=e.length;s<n;s++){if(!e[s])continue;const n=e[s];for(const e in n)t.off(e,n[e].handler,this)}this._materialEvents=null}}_getAssetByIdOrPath(t){let e=null;if(isNaN(parseInt(t,10))){if(this.asset){const s=this._getMaterialAssetUrl(t);s&&(e=this.system.app.assets.getByUrl(s))}}else e=this.system.app.assets.get(t);return e}_getMaterialAssetUrl(t){if(!this.asset)return null;const e=this.system.app.assets.get(this.asset);return e?e.getAbsoluteUrl(t):null}_loadAndSetMeshInstanceMaterial(t,e,s){const n=this.system.app.assets;t&&(t.resource?(e.material=t.resource,this._setMaterialEvent(s,"remove",t.id,function(){e.material=this.system.defaultMaterial})):(this._setMaterialEvent(s,"load",t.id,function(n){e.material=n.resource,this._setMaterialEvent(s,"remove",t.id,function(){e.material=this.system.defaultMaterial})}),this.enabled&&this.entity.enabled&&n.load(t)))}onEnable(){const t=this.system.app,e=t.scene,s=e?.layers;this._evtLayersChanged=e.on("set:layers",this.onLayersChanged,this),s&&(this._evtLayerAdded=s.on("add",this.onLayerAdded,this),this._evtLayerRemoved=s.on("remove",this.onLayerRemoved,this));const n="asset"===this._type;let i;if(this._model?this.addModelToLayers():n&&this._asset&&(i=t.assets.get(this._asset),i&&i.resource!==this._model&&this._bindModelAsset(i)),this._materialAsset&&(i=t.assets.get(this._materialAsset),i&&i.resource!==this._material&&this._bindMaterialAsset(i)),n&&this._mapping)for(const e in this._mapping)this._mapping[e]&&(i=this._getAssetByIdOrPath(this._mapping[e]),i&&!i.resource&&t.assets.load(i));this._batchGroupId>=0&&t.batcher?.insert(qh.MODEL,this.batchGroupId,this.entity)}onDisable(){const t=this.system.app,e=t.scene.layers;this._evtLayersChanged?.off(),this._evtLayersChanged=null,e&&(this._evtLayerAdded?.off(),this._evtLayerAdded=null,this._evtLayerRemoved?.off(),this._evtLayerRemoved=null),this._batchGroupId>=0&&t.batcher?.remove(qh.MODEL,this.batchGroupId,this.entity),this._model&&this.removeModelFromLayers()}hide(){if(this._model){const t=this._model.meshInstances;for(let e=0,s=t.length;e<s;e++)t[e].visible=!1}}show(){if(this._model){const t=this._model.meshInstances;for(let e=0,s=t.length;e<s;e++)t[e].visible=!0}}_bindMaterialAsset(t){if(t.on("load",this._onMaterialAssetLoad,this),t.on("unload",this._onMaterialAssetUnload,this),t.on("remove",this._onMaterialAssetRemove,this),t.on("change",this._onMaterialAssetChange,this),t.resource)this._onMaterialAssetLoad(t);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(t)}}_unbindMaterialAsset(t){t.off("load",this._onMaterialAssetLoad,this),t.off("unload",this._onMaterialAssetUnload,this),t.off("remove",this._onMaterialAssetRemove,this),t.off("change",this._onMaterialAssetChange,this)}_onMaterialAssetAdd(t){this.system.app.assets.off(`add:${t.id}`,this._onMaterialAssetAdd,this),this._materialAsset===t.id&&this._bindMaterialAsset(t)}_onMaterialAssetLoad(t){this._setMaterial(t.resource)}_onMaterialAssetUnload(t){this._setMaterial(this.system.defaultMaterial)}_onMaterialAssetRemove(t){this._onMaterialAssetUnload(t)}_onMaterialAssetChange(t){}_bindModelAsset(t){if(this._unbindModelAsset(t),t.on("load",this._onModelAssetLoad,this),t.on("unload",this._onModelAssetUnload,this),t.on("change",this._onModelAssetChange,this),t.on("remove",this._onModelAssetRemove,this),t.resource)this._onModelAssetLoad(t);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(t)}}_unbindModelAsset(t){t.off("load",this._onModelAssetLoad,this),t.off("unload",this._onModelAssetUnload,this),t.off("change",this._onModelAssetChange,this),t.off("remove",this._onModelAssetRemove,this)}_onModelAssetAdded(t){this.system.app.assets.off(`add:${t.id}`,this._onModelAssetAdded,this),t.id===this._asset&&this._bindModelAsset(t)}_onModelAssetLoad(t){this.model=t.resource.clone(),this._clonedModel=!0}_onModelAssetUnload(t){this.model=null}_onModelAssetChange(t,e,s,n){"data"===e&&(this.mapping=this._mapping)}_onModelAssetRemove(t){this.model=null}_setMaterial(t){if(this._material===t)return;this._material=t;const e=this._model;if(e&&"asset"!==this._type){const s=e.meshInstances;for(let e=0,n=s.length;e<n;e++)s[e].material=t}}}.prototype.setVisible=function(t){this.enabled=t},Object.defineProperty(O_.prototype,"bodyType",{get:function(){return this.type},set:function(t){this.type=t}}),O_.prototype.syncBodyToEntity=function(){this._updateDynamic()},W_.prototype.setGravity=function(){1===arguments.length?this.gravity.copy(arguments[0]):this.gravity.set(arguments[0],arguments[1],arguments[2])};class px{constructor(t){this._frameIndex=0,this._frameTimings=[],this._timings=[],this._prevTimings=[],this.unitsName="ms",this.decimalPlaces=1,this.enabled=!0,t.on("frameupdate",this.begin.bind(this,"update")),t.on("framerender",this.mark.bind(this,"render")),t.on("frameend",this.mark.bind(this,"other"))}begin(t){if(!this.enabled)return;this._frameIndex<this._frameTimings.length&&this._frameTimings.splice(this._frameIndex);const e=this._prevTimings;this._prevTimings=this._timings,this._timings=this._frameTimings,this._frameTimings=e,this._frameIndex=0,this.mark(t)}mark(t){if(!this.enabled)return;const e=Xe();if(this._frameIndex>0){const t=this._frameTimings[this._frameIndex-1];t[1]=e-t[1]}else if(this._timings.length>0){const t=this._timings[this._timings.length-1];t[1]=e-t[1]}if(this._frameIndex>=this._frameTimings.length)this._frameTimings.push([t,e]);else{const s=this._frameTimings[this._frameIndex];s[0]=t,s[1]=e}this._frameIndex++}get timings(){return this._timings.slice(0,-1).map(t=>t[1])}}class mx{constructor(t){this.device=t,t.gpuProfiler&&(t.gpuProfiler.enabled=!0),this.enabled=!0,this.unitsName="ms",this.decimalPlaces=1,this._timings=[]}get timings(){return this._timings[0]=this.device.gpuProfiler?._frameTime??0,this._timings}}class gx{constructor(t,e,s,n,i){this.app=t,this.values=[],this.statNames=e,this.statNames.length>3&&(this.statNames.length=3),this.unitsName=n,this.decimalPlaces=s,this.multiplier=i||1;const r=(t,e)=>t.split(".").reduce((t,e)=>t?t[e]:null,e||this);t.on("frameupdate",t=>{for(let t=0;t<this.statNames.length;t++)this.values[t]=r(this.statNames[t],this.app.stats)*this.multiplier})}get timings(){return this.values}}class _x{constructor(t,e,s,n,i){this.app=e,this.name=t,this.device=e.graphicsDevice,this.timer=i,this.watermark=s,this.enabled=!1,this.textRefreshRate=n,this.avgTotal=0,this.avgTimer=0,this.avgCount=0,this.timingText="",this.texture=null,this.yOffset=0,this.cursor=0,this.sample=new Uint8ClampedArray(4),this.sample.set([0,0,0,255]),this.counter=0,this.app.on("frameupdate",this.update,this)}destroy(){this.app.off("frameupdate",this.update,this)}loseContext(){this.timer&&"function"==typeof this.timer.loseContext&&this.timer.loseContext()}update(t){const e=this.timer.timings,s=e.reduce((t,e)=>t+e,0);if(this.avgTotal+=s,this.avgTimer+=t,this.avgCount++,this.avgTimer>this.textRefreshRate&&(this.timingText=(this.avgTotal/this.avgCount).toFixed(this.timer.decimalPlaces),this.avgTimer=0,this.avgTotal=0,this.avgCount=0),this.enabled){let t=0;const s=1.5*this.watermark;for(let n=0;n<e.length;++n)t+=Math.floor(e[n]/s*255),this.sample[n]=t;this.sample[3]=this.watermark/s*255;this.texture.lock().set(this.sample,4*(this.cursor+this.yOffset*this.texture.width)),this.texture.unlock(),this.cursor++,this.cursor===this.texture.width&&(this.cursor=0)}}render(t,e,s,n,i){t.quad(e+n,s,-n,i,this.enabled?this.cursor:0,this.enabled?.5+this.yOffset:this.texture.height-1,-n,0,this.texture,0)}}class vx{constructor(t,e){const s=t=>{t.font='10px "Lucida Console", Monaco, monospace',t.textAlign="left",t.textBaseline="alphabetic"},n=document.createElement("canvas"),i=n.getContext("2d",{alpha:!0});s(i);const r=new Map;let a=5,o=5;e.forEach(t=>{const e=i.measureText(t),s=Math.ceil(-e.actualBoundingBoxLeft),n=Math.ceil(e.actualBoundingBoxRight),l=Math.ceil(e.actualBoundingBoxAscent),h=Math.ceil(e.actualBoundingBoxDescent),c=s+n,d=l+h;a+c+5>=512&&(a=5,o+=16),r.set(t,{l:s,r:n,a:l,d:h,w:c,h:d,x:a,y:o}),a+=c+5}),n.width=512,n.height=Qe.nextPowerOfTwo(o+16+5),s(i),i.fillStyle="rgb(0, 0, 0)",i.fillRect(0,0,n.width,n.height),r.forEach((t,e)=>{i.fillStyle=(t=>"."===t||1===t.length&&t.charCodeAt(0)>=48&&t.charCodeAt(0)<=57)(e)?"rgb(255, 255, 255)":"rgb(170, 170, 170)",i.fillText(e,t.x-t.l,t.y+t.a)}),this.placements=r;const l=i.getImageData(0,0,n.width,n.height).data;for(let t=0;t<l.length;t+=4)l[t+3]=l[t+0],l[t+0]=255,l[t+1]=255,l[t+2]=255;this.texture=new pi(t,{name:"mini-stats-word-atlas",width:n.width,height:n.height,mipmaps:!1,minFilter:0,magFilter:0,levels:[l]})}destroy(){this.texture.destroy(),this.texture=null}render(t,e,s,n){const i=this.placements.get(e);if(i){const e=1;return t.quad(s+i.l-e,n-i.d+e,i.w+2*e,i.h+2*e,i.x-e,this.texture.height-i.y-i.h-e,void 0,void 0,this.texture,1),i.w}return 0}}class yx{constructor(t,e=512){const s=new Ui(t,[{semantic:Ys,components:3,type:6},{semantic:nn,components:4,type:6}]),n=new Uint16Array(6*e);for(let t=0;t<e;++t)n[6*t+0]=4*t,n[6*t+1]=4*t+1,n[6*t+2]=4*t+2,n[6*t+3]=4*t,n[6*t+4]=4*t+2,n[6*t+5]=4*t+3;this.device=t,this.buffer=new ki(t,s,4*e,{usage:2}),this.data=new Float32Array(this.buffer.numBytes/4),this.indexBuffer=new Mo(t,1,6*e,0,n),this.prim={type:4,indexed:!0,base:0,baseVertex:0,count:0},this.quads=0,this.mesh=new tc(t),this.mesh.vertexBuffer=this.buffer,this.mesh.indexBuffer[0]=this.indexBuffer,this.mesh.primitive=[this.prim];const i=new Ju({uniqueName:"MiniStats",vertexGLSL:"\n\tattribute vec3 vertex_position;\n\tattribute vec4 vertex_texCoord0;\n\tvarying vec4 uv0;\n\tvarying float wordFlag;\n\tvoid main(void) {\n\t\tgl_Position = vec4(vertex_position.xy * 2.0 - 1.0, 0.5, 1.0);\n\t\tuv0 = vertex_texCoord0;\n\t\twordFlag = vertex_position.z;\n\t}\n",fragmentGLSL:"\n\tvarying vec4 uv0;\n\tvarying float wordFlag;\n\tuniform vec4 clr;\n\tuniform sampler2D graphTex;\n\tuniform sampler2D wordsTex;\n\tvoid main (void) {\n\t\tvec4 graphSample = texture2D(graphTex, uv0.xy);\n\t\tvec4 graph;\n\t\tif (uv0.w < graphSample.r)\n\t\t\tgraph = vec4(0.7, 0.2, 0.2, 1.0);\n\t\telse if (uv0.w < graphSample.g)\n\t\t\tgraph = vec4(0.2, 0.7, 0.2, 1.0);\n\t\telse if (uv0.w < graphSample.b)\n\t\t\tgraph = vec4(0.2, 0.2, 0.7, 1.0);\n\t\telse\n\t\t\tgraph = vec4(0.0, 0.0, 0.0, 1.0 - 0.25 * sin(uv0.w * 3.14159));\n\t\tvec4 words = texture2D(wordsTex, vec2(uv0.x, 1.0 - uv0.y));\n\t\tgl_FragColor = mix(graph, words, wordFlag) * clr;\n\t}\n",vertexWGSL:"\n\tattribute vertex_position: vec3f;\n\tattribute vertex_texCoord0: vec4f;\n\tvarying uv0: vec4f;\n\tvarying wordFlag: f32;\n\t@vertex fn vertexMain(input : VertexInput) -> VertexOutput {\n\t\tvar output : VertexOutput;\n\t\toutput.position = vec4(input.vertex_position.xy * 2.0 - 1.0, 0.5, 1.0);\n\t\toutput.uv0 = input.vertex_texCoord0;\n\t\toutput.wordFlag = input.vertex_position.z;\n\t\treturn output;\n\t}\n",fragmentWGSL:"\n\tvarying uv0: vec4f;\n\tvarying wordFlag: f32;\n\tuniform clr: vec4f;\n\tvar graphTex : texture_2d<f32>;\n\tvar graphTex_sampler : sampler;\n\tvar wordsTex : texture_2d<f32>;\n\tvar wordsTex_sampler : sampler;\n\t@fragment fn fragmentMain(input : FragmentInput) -> FragmentOutput {\n\t\tvar uv0: vec4f = input.uv0;\n\t\tvar graphSample: vec4f = textureSample(graphTex, graphTex_sampler, uv0.xy);\n\t\tvar graph: vec4f;\n\t\tif (uv0.w < graphSample.r) {\n\t\t\tgraph = vec4f(0.7, 0.2, 0.2, 1.0);\n\t\t} else if (uv0.w < graphSample.g) {\n\t\t\tgraph = vec4f(0.2, 0.7, 0.2, 1.0);\n\t\t} else if (uv0.w < graphSample.b) {\n\t\t\tgraph = vec4f(0.2, 0.2, 0.7, 1.0);\n\t\t} else {\n\t\t\tgraph = vec4f(0.0, 0.0, 0.0, 1.0 - 0.25 * sin(uv0.w * 3.14159));\n\t\t}\n\t\tvar words: vec4f = textureSample(wordsTex, wordsTex_sampler, vec2f(uv0.x, 1.0 - uv0.y));\n\t\tvar output: FragmentOutput;\n\t\toutput.color = mix(graph, words, input.wordFlag) * uniform.clr;\n\t\treturn output;\n\t}\n",attributes:{vertex_position:Ys,vertex_texCoord0:nn}});this.material=i,i.cull=0,i.depthState=Ai.NODEPTH,i.blendState=new Ti(!0,0,6,8,0,1,1),i.update(),this.meshInstance=new fc(this.mesh,i,new Hc("MiniStatsMesh")),this.uniforms={clr:new Float32Array(4)},this.targetSize={width:t.width,height:t.height}}quad(t,e,s,n,i,r,a,o,l,h=0){const c=this.targetSize.width,d=this.targetSize.height,u=t/c,f=e/d,p=(t+s)/c,m=(e+n)/d,g=l.width,_=l.height,v=i/g,y=r/_,b=(i+(a??s))/g,S=(r+(o??n))/_;this.data.set([u,f,h,v,y,0,0,p,f,h,b,y,1,0,p,m,h,b,S,1,1,u,m,h,v,S,0,1],28*this.quads),this.quads++,this.prim.count+=6}startFrame(){this.quads=0,this.prim.count=0,this.targetSize.width=this.device.canvas.scrollWidth,this.targetSize.height=this.device.canvas.scrollHeight}render(t,e,s,n,i,r){this.buffer.setData(this.data.buffer),this.uniforms.clr.set(i,0),this.material.setParameter("clr",this.uniforms.clr),this.material.setParameter("graphTex",s),this.material.setParameter("wordsTex",n),t.drawMeshInstance(this.meshInstance,e)}}class bx{constructor(t,e){const s=t.graphicsDevice;e=e||bx.getDefaultOptions(),this.initGraphs(t,s,e);const n=new Set(["","ms","0","1","2","3","4","5","6","7","8","9",".","-"].concat(this.graphs.map(t=>t.name)).concat(e.stats?e.stats.map(t=>t.unitsName):[]).filter(t=>!!t));this.wordAtlas=new vx(s,n),this.sizes=e.sizes,this._activeSizeIndex=e.startSizeIndex;const i=document.createElement("div");i.setAttribute("id","mini-stats"),i.style.cssText="position:fixed;bottom:0;left:0;background:transparent;",document.body.appendChild(i),i.addEventListener("mouseenter",t=>{this.opacity=1}),i.addEventListener("mouseleave",t=>{this.opacity=.7}),i.addEventListener("click",t=>{t.preventDefault(),this._enabled&&(this.activeSizeIndex=(this.activeSizeIndex+1)%this.sizes.length,this.resize(this.sizes[this.activeSizeIndex].width,this.sizes[this.activeSizeIndex].height,this.sizes[this.activeSizeIndex].graphs))}),s.on("resizecanvas",this.updateDiv,this),s.on("losecontext",this.loseContext,this),t.on("postrender",this.postRender,this),this.app=t,this.drawLayer=t.scene.layers.getLayerById(4),this.device=s,this.render2d=new yx(s),this.div=i,this.width=0,this.height=0,this.gspacing=2,this.clr=[1,1,1,.5],this._enabled=!0,this.activeSizeIndex=this._activeSizeIndex}destroy(){this.device.off("resizecanvas",this.updateDiv,this),this.device.off("losecontext",this.loseContext,this),this.app.off("postrender",this.postRender,this),this.graphs.forEach(t=>t.destroy()),this.wordAtlas.destroy(),this.texture.destroy(),this.div.remove()}static getDefaultOptions(){return{sizes:[{width:100,height:16,spacing:0,graphs:!1},{width:128,height:32,spacing:2,graphs:!0},{width:256,height:64,spacing:2,graphs:!0}],startSizeIndex:0,textRefreshRate:500,cpu:{enabled:!0,watermark:33},gpu:{enabled:!0,watermark:33},stats:[{name:"Frame",stats:["frame.ms"],decimalPlaces:1,unitsName:"ms",watermark:33},{name:"DrawCalls",stats:["drawCalls.total"],watermark:1e3}]}}set activeSizeIndex(t){this._activeSizeIndex=t,this.gspacing=this.sizes[t].spacing,this.resize(this.sizes[t].width,this.sizes[t].height,this.sizes[t].graphs)}get activeSizeIndex(){return this._activeSizeIndex}set opacity(t){this.clr[3]=t}get opacity(){return this.clr[3]}get overallHeight(){const t=this.graphs,e=this.gspacing;return this.height*t.length+e*(t.length-1)}set enabled(t){if(t!==this._enabled){this._enabled=t;for(let e=0;e<this.graphs.length;++e)this.graphs[e].enabled=t,this.graphs[e].timer.enabled=t}}get enabled(){return this._enabled}initGraphs(t,e,s){if(this.graphs=[],s.cpu.enabled){const e=new px(t),n=new _x("CPU",t,s.cpu.watermark,s.textRefreshRate,e);this.graphs.push(n)}if(s.gpu.enabled){const n=new mx(e),i=new _x("GPU",t,s.gpu.watermark,s.textRefreshRate,n);this.graphs.push(i)}s.stats&&s.stats.forEach(e=>{const n=new gx(t,e.stats,e.decimalPlaces,e.unitsName,e.multiplier),i=new _x(e.name,t,e.watermark,s.textRefreshRate,n);this.graphs.push(i)});const n=s.sizes.reduce((t,e)=>e.width>t?e.width:t,0);this.texture=new pi(e,{name:"mini-stats-graph-texture",width:Qe.nextPowerOfTwo(n),height:Qe.nextPowerOfTwo(this.graphs.length),mipmaps:!1,minFilter:0,magFilter:0,addressU:0,addressV:0}),this.graphs.forEach((t,e)=>{t.texture=this.texture,t.yOffset=e})}render(){const t=this.graphs,e=this.wordAtlas,s=this.render2d,n=this.width,i=this.height,r=this.gspacing;s.startFrame();for(let a=0;a<t.length;++a){const o=t[a];let l=a*(i+r);o.render(s,0,l,n,i);let h=1;l+=i-13,h+=e.render(s,o.name,h,l)+10;const c=o.timingText;for(let t=0;t<c.length;++t)h+=e.render(s,c[t],h,l);o.timer.unitsName&&(h+=3,e.render(s,o.timer.unitsName,h,l))}s.render(this.app,this.drawLayer,this.texture,this.wordAtlas.texture,this.clr,i)}resize(t,e,s){const n=this.graphs;for(let t=0;t<n.length;++t)n[t].enabled=s;this.width=t,this.height=e,this.updateDiv()}updateDiv(){const t=this.device.canvas.getBoundingClientRect();this.div.style.left=`${t.left}px`,this.div.style.bottom=window.innerHeight-t.bottom+"px",this.div.style.width=`${this.width}px`,this.div.style.height=`${this.overallHeight}px`}loseContext(){this.graphs.forEach(t=>t.loseContext())}postRender(){this._enabled&&this.render()}}class Sx{constructor(){}textureToCanvas(t,e={}){const s=t.getSource();if("undefined"!=typeof HTMLImageElement&&s instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&s instanceof HTMLCanvasElement||"undefined"!=typeof OffscreenCanvas&&s instanceof OffscreenCanvas||"undefined"!=typeof ImageBitmap&&s instanceof ImageBitmap){const{width:t,height:n}=this.calcTextureSize(s.width,s.height,e.maxTextureSize),i=document.createElement("canvas");i.width=t,i.height=n;const r=i.getContext("2d");if(null===r)return Promise.resolve(void 0);if(r.drawImage(s,0,0,i.width,i.height),e.color){const{r:s,g:i,b:a}=e.color,o=r.getImageData(0,0,t,n),l=o.data;for(let t=0;t<l.length;t+=4)l[t+0]=l[t+0]*s,l[t+1]=l[t+1]*i,l[t+2]=l[t+2]*a;r.putImageData(o,0,0)}return Promise.resolve(i)}const n=t.device,{width:i,height:r}=this.calcTextureSize(t.width,t.height,e.maxTextureSize),a=js(t.format)?7:t.format,o=new pi(n,{name:"ExtractedTexture",width:i,height:r,format:a,cubemap:!1,mipmaps:!1,minFilter:1,magFilter:1,addressU:1,addressV:1}),l=new ji({colorBuffer:o,depth:!1}),h=zh.createShader(n,{uniqueName:"ShaderCoreExporterBlit",attributes:{vertex_position:Ys},vertexChunk:"fullscreenQuadVS",fragmentChunk:"outputTex2DPS"});return n.scope.resolve("source").setValue(t),n.setBlendState(Ti.NOBLEND),Xh(n,l,h),o.read(0,0,i,r,{renderTarget:l,immediate:!0}).then(t=>{o.destroy(),l.destroy();const e=new Uint8ClampedArray(i*r*4);e.set(t);const s=new ImageData(e,i,r),n=document.createElement("canvas");n.width=i,n.height=r;const a=n.getContext("2d");return a?(a.putImageData(s,0,0),Promise.resolve(n)):Promise.resolve(void 0)})}calcTextureSize(t,e,s){if(s){const n=Math.min(s/Math.max(t,e),1);t=Math.round(t*n),e=Math.round(e*n)}return{width:t,height:e}}}var xx=Uint8Array,wx=Uint16Array,Tx=Int32Array,Cx=new xx([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),Ex=new xx([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),Ax=new xx([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Dx=function(t,e){for(var s=new wx(31),n=0;n<31;++n)s[n]=e+=1<<t[n-1];var i=new Tx(s[30]);for(n=1;n<30;++n)for(var r=s[n];r<s[n+1];++r)i[r]=r-s[n]<<5|n;return{b:s,r:i}},Px=Dx(Cx,2),Lx=Px.b,Ix=Px.r;Lx[28]=258,Ix[258]=28;for(var Rx=Dx(Ex,0).r,Mx=new wx(32768),kx=0;kx<32768;++kx){var Ox=(43690&kx)>>1|(21845&kx)<<1;Ox=(61680&(Ox=(52428&Ox)>>2|(13107&Ox)<<2))>>4|(3855&Ox)<<4,Mx[kx]=((65280&Ox)>>8|(255&Ox)<<8)>>1}var Fx=function(t,e,s){for(var n=t.length,i=0,r=new wx(e);i<n;++i)t[i]&&++r[t[i]-1];var a,o=new wx(e);for(i=1;i<e;++i)o[i]=o[i-1]+r[i-1]<<1;if(s){a=new wx(1<<e);var l=15-e;for(i=0;i<n;++i)if(t[i])for(var h=i<<4|t[i],c=e-t[i],d=o[t[i]-1]++<<c,u=d|(1<<c)-1;d<=u;++d)a[Mx[d]>>l]=h}else for(a=new wx(n),i=0;i<n;++i)t[i]&&(a[i]=Mx[o[t[i]-1]++]>>15-t[i]);return a},Nx=new xx(288);for(kx=0;kx<144;++kx)Nx[kx]=8;for(kx=144;kx<256;++kx)Nx[kx]=9;for(kx=256;kx<280;++kx)Nx[kx]=7;for(kx=280;kx<288;++kx)Nx[kx]=8;var Bx=new xx(32);for(kx=0;kx<32;++kx)Bx[kx]=5;var zx=Fx(Nx,9,0);Fx(Nx,9,1);var Ux=Fx(Bx,5,0);Fx(Bx,5,1);var Vx=function(t){return(t+7)/8|0},Hx=function(t,e,s){return(null==s||s>t.length)&&(s=t.length),new xx(t.subarray(e,s))},Gx=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],Wx=function(t,e,s){var n=new Error(e||Gx[t]);if(n.code=t,Error.captureStackTrace&&Error.captureStackTrace(n,Wx),!s)throw n;return n},jx=function(t,e,s){s<<=7&e;var n=e/8|0;t[n]|=s,t[n+1]|=s>>8},$x=function(t,e,s){s<<=7&e;var n=e/8|0;t[n]|=s,t[n+1]|=s>>8,t[n+2]|=s>>16},Xx=function(t,e){for(var s=[],n=0;n<t.length;++n)t[n]&&s.push({s:n,f:t[n]});var i=s.length,r=s.slice();if(!i)return{t:tw,l:0};if(1==i){var a=new xx(s[0].s+1);return a[s[0].s]=1,{t:a,l:1}}s.sort(function(t,e){return t.f-e.f}),s.push({s:-1,f:25001});var o=s[0],l=s[1],h=0,c=1,d=2;for(s[0]={s:-1,f:o.f+l.f,l:o,r:l};c!=i-1;)o=s[s[h].f<s[d].f?h++:d++],l=s[h!=c&&s[h].f<s[d].f?h++:d++],s[c++]={s:-1,f:o.f+l.f,l:o,r:l};var u=r[0].s;for(n=1;n<i;++n)r[n].s>u&&(u=r[n].s);var f=new wx(u+1),p=qx(s[c-1],f,0);if(p>e){n=0;var m=0,g=p-e,_=1<<g;for(r.sort(function(t,e){return f[e.s]-f[t.s]||t.f-e.f});n<i;++n){var v=r[n].s;if(!(f[v]>e))break;m+=_-(1<<p-f[v]),f[v]=e}for(m>>=g;m>0;){var y=r[n].s;f[y]<e?m-=1<<e-f[y]++-1:++n}for(;n>=0&&m;--n){var b=r[n].s;f[b]==e&&(--f[b],++m)}p=e}return{t:new xx(f),l:p}},qx=function(t,e,s){return-1==t.s?Math.max(qx(t.l,e,s+1),qx(t.r,e,s+1)):e[t.s]=s},Kx=function(t){for(var e=t.length;e&&!t[--e];);for(var s=new wx(++e),n=0,i=t[0],r=1,a=function(t){s[n++]=t},o=1;o<=e;++o)if(t[o]==i&&o!=e)++r;else{if(!i&&r>2){for(;r>138;r-=138)a(32754);r>2&&(a(r>10?r-11<<5|28690:r-3<<5|12305),r=0)}else if(r>3){for(a(i),--r;r>6;r-=6)a(8304);r>2&&(a(r-3<<5|8208),r=0)}for(;r--;)a(i);r=1,i=t[o]}return{c:s.subarray(0,n),n:e}},Yx=function(t,e){for(var s=0,n=0;n<e.length;++n)s+=t[n]*e[n];return s},Qx=function(t,e,s){var n=s.length,i=Vx(e+2);t[i]=255&n,t[i+1]=n>>8,t[i+2]=255^t[i],t[i+3]=255^t[i+1];for(var r=0;r<n;++r)t[i+r+4]=s[r];return 8*(i+4+n)},Zx=function(t,e,s,n,i,r,a,o,l,h,c){jx(e,c++,s),++i[256];for(var d=Xx(i,15),u=d.t,f=d.l,p=Xx(r,15),m=p.t,g=p.l,_=Kx(u),v=_.c,y=_.n,b=Kx(m),S=b.c,x=b.n,w=new wx(19),T=0;T<v.length;++T)++w[31&v[T]];for(T=0;T<S.length;++T)++w[31&S[T]];for(var C=Xx(w,7),E=C.t,A=C.l,D=19;D>4&&!E[Ax[D-1]];--D);var P,L,I,R,M=h+5<<3,k=Yx(i,Nx)+Yx(r,Bx)+a,O=Yx(i,u)+Yx(r,m)+a+14+3*D+Yx(w,E)+2*w[16]+3*w[17]+7*w[18];if(l>=0&&M<=k&&M<=O)return Qx(e,c,t.subarray(l,l+h));if(jx(e,c,1+(O<k)),c+=2,O<k){P=Fx(u,f,0),L=u,I=Fx(m,g,0),R=m;var F=Fx(E,A,0);jx(e,c,y-257),jx(e,c+5,x-1),jx(e,c+10,D-4),c+=14;for(T=0;T<D;++T)jx(e,c+3*T,E[Ax[T]]);c+=3*D;for(var N=[v,S],B=0;B<2;++B){var z=N[B];for(T=0;T<z.length;++T){var U=31&z[T];jx(e,c,F[U]),c+=E[U],U>15&&(jx(e,c,z[T]>>5&127),c+=z[T]>>12)}}}else P=zx,L=Nx,I=Ux,R=Bx;for(T=0;T<o;++T){var V=n[T];if(V>255){$x(e,c,P[(U=V>>18&31)+257]),c+=L[U+257],U>7&&(jx(e,c,V>>23&31),c+=Cx[U]);var H=31&V;$x(e,c,I[H]),c+=R[H],H>3&&($x(e,c,V>>5&8191),c+=Ex[H])}else $x(e,c,P[V]),c+=L[V]}return $x(e,c,P[256]),c+L[256]},Jx=new Tx([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),tw=new xx(0),ew=function(){for(var t=new Int32Array(256),e=0;e<256;++e){for(var s=e,n=9;--n;)s=(1&s&&-306674912)^s>>>1;t[e]=s}return t}(),sw=function(){var t=-1;return{p:function(e){for(var s=t,n=0;n<e.length;++n)s=ew[255&s^e[n]]^s>>>8;t=s},d:function(){return~t}}},nw=function(t,e,s,n,i){if(!i&&(i={l:1},e.dictionary)){var r=e.dictionary.subarray(-32768),a=new xx(r.length+t.length);a.set(r),a.set(t,r.length),t=a,i.w=r.length}return function(t,e,s,n,i,r){var a=r.z||t.length,o=new xx(n+a+5*(1+Math.ceil(a/7e3))+i),l=o.subarray(n,o.length-i),h=r.l,c=7&(r.r||0);if(e){c&&(l[0]=r.r>>3);for(var d=Jx[e-1],u=d>>13,f=8191&d,p=(1<<s)-1,m=r.p||new wx(32768),g=r.h||new wx(p+1),_=Math.ceil(s/3),v=2*_,y=function(e){return(t[e]^t[e+1]<<_^t[e+2]<<v)&p},b=new Tx(25e3),S=new wx(288),x=new wx(32),w=0,T=0,C=r.i||0,E=0,A=r.w||0,D=0;C+2<a;++C){var P=y(C),L=32767&C,I=g[P];if(m[L]=I,g[P]=L,A<=C){var R=a-C;if((w>7e3||E>24576)&&(R>423||!h)){c=Zx(t,l,0,b,S,x,T,E,D,C-D,c),E=w=T=0,D=C;for(var M=0;M<286;++M)S[M]=0;for(M=0;M<30;++M)x[M]=0}var k=2,O=0,F=f,N=L-I&32767;if(R>2&&P==y(C-N))for(var B=Math.min(u,R)-1,z=Math.min(32767,C),U=Math.min(258,R);N<=z&&--F&&L!=I;){if(t[C+k]==t[C+k-N]){for(var V=0;V<U&&t[C+V]==t[C+V-N];++V);if(V>k){if(k=V,O=N,V>B)break;var H=Math.min(N,V-2),G=0;for(M=0;M<H;++M){var W=C-N+M&32767,j=W-m[W]&32767;j>G&&(G=j,I=W)}}}N+=(L=I)-(I=m[L])&32767}if(O){b[E++]=268435456|Ix[k]<<18|Rx[O];var $=31&Ix[k],X=31&Rx[O];T+=Cx[$]+Ex[X],++S[257+$],++x[X],A=C+k,++w}else b[E++]=t[C],++S[t[C]]}}for(C=Math.max(C,A);C<a;++C)b[E++]=t[C],++S[t[C]];c=Zx(t,l,h,b,S,x,T,E,D,C-D,c),h||(r.r=7&c|l[c/8|0]<<3,c-=7,r.h=g,r.p=m,r.i=C,r.w=A)}else{for(C=r.w||0;C<a+h;C+=65535){var q=C+65535;q>=a&&(l[c/8|0]=h,q=a),c=Qx(l,c+1,t.subarray(C,q))}r.i=a}return Hx(o,0,n+Vx(c)+i)}(t,null==e.level?6:e.level,null==e.mem?i.l?Math.ceil(1.5*Math.max(8,Math.min(13,Math.log(t.length)))):20:12+e.mem,s,n,i)},iw=function(t,e){var s={};for(var n in t)s[n]=t[n];for(var n in e)s[n]=e[n];return s},rw=function(t,e,s){for(;s;++e)t[e]=s,s>>>=8};function aw(t,e){return nw(t,e||{},0,0)}var ow=function(t,e,s,n){for(var i in t){var r=t[i],a=e+i,o=n;Array.isArray(r)&&(o=iw(n,r[1]),r=r[0]),r instanceof xx?s[a]=[r,o]:(s[a+="/"]=[new xx(0),o],ow(r,a,s,n))}},lw="undefined"!=typeof TextEncoder&&new TextEncoder,hw="undefined"!=typeof TextDecoder&&new TextDecoder;try{hw.decode(tw,{stream:!0})}catch(t){}function cw(t,e){if(lw)return lw.encode(t);for(var s=t.length,n=new xx(t.length+(t.length>>1)),i=0,r=function(t){n[i++]=t},a=0;a<s;++a){if(i+5>n.length){var o=new xx(i+8+(s-a<<1));o.set(n),n=o}var l=t.charCodeAt(a);l<128||e?r(l):l<2048?(r(192|l>>6),r(128|63&l)):l>55295&&l<57344?(r(240|(l=65536+(1047552&l)|1023&t.charCodeAt(++a))>>18),r(128|l>>12&63),r(128|l>>6&63),r(128|63&l)):(r(224|l>>12),r(128|l>>6&63),r(128|63&l))}return Hx(n,0,i)}var dw=function(t){var e=0;if(t)for(var s in t){var n=t[s].length;n>65535&&Wx(9),e+=n+4}return e},uw=function(t,e,s,n,i,r,a,o){var l=n.length,h=s.extra,c=o&&o.length,d=dw(h);rw(t,e,null!=a?33639248:67324752),e+=4,null!=a&&(t[e++]=20,t[e++]=s.os),t[e]=20,e+=2,t[e++]=s.flag<<1|(r<0&&8),t[e++]=i&&8,t[e++]=255&s.compression,t[e++]=s.compression>>8;var u=new Date(null==s.mtime?Date.now():s.mtime),f=u.getFullYear()-1980;if((f<0||f>119)&&Wx(10),rw(t,e,f<<25|u.getMonth()+1<<21|u.getDate()<<16|u.getHours()<<11|u.getMinutes()<<5|u.getSeconds()>>1),e+=4,-1!=r&&(rw(t,e,s.crc),rw(t,e+4,r<0?-r-2:r),rw(t,e+8,s.size)),rw(t,e+12,l),rw(t,e+14,d),e+=16,null!=a&&(rw(t,e,c),rw(t,e+6,s.attrs),rw(t,e+10,a),e+=14),t.set(n,e),e+=l,d)for(var p in h){var m=h[p],g=m.length;rw(t,e,+p),rw(t,e+2,g),t.set(m,e+4),e+=4+g}return c&&(t.set(o,e),e+=c),e};function fw(t,e){e||(e={});var s={},n=[];ow(t,"",s,e);var i=0,r=0;for(var a in s){var o=s[a],l=o[0],h=o[1],c=0==h.level?0:8,d=(w=cw(a)).length,u=h.comment,f=u&&cw(u),p=f&&f.length,m=dw(h.extra);d>65535&&Wx(11);var g=c?aw(l,h):l,_=g.length,v=sw();v.p(l),n.push(iw(h,{size:l.length,crc:v.d(),c:g,f:w,m:f,u:d!=a.length||f&&u.length!=p,o:i,compression:c})),i+=30+d+m+_,r+=76+2*(d+m)+(p||0)+_}for(var y=new xx(r+22),b=i,S=r-i,x=0;x<n.length;++x){var w=n[x];uw(y,w.o,w,w.f,w.u,w.c.length);var T=30+w.f.length+dw(w.extra);y.set(w.c,w.o+T),uw(y,i,w,w.f,w.u,w.c.length,w.o,w.m),i+=16+T+(w.m?w.m.length:0)}return function(t,e,s,n,i){rw(t,e,101010256),rw(t,e+8,s),rw(t,e+10,s),rw(t,e+12,n),rw(t,e+16,i)}(y,i,n.length,S,b),y}const pw="root",mw=(t,e,s)=>`                    ${t} inputs:${e} = ${s}`;class gw extends Sx{init(){this.meshMap=new Map,this.textureMap=new Map,this.materialMap=new Map,this.materials=[],this.files={},this.nodeNames=new Set}done(){this.meshMap=null,this.textureMap=null,this.materialMap=null,this.materials=null,this.files=null,this.nodeNames=null}build(t,e={}){this.init(),this.addFile(null,pw);const s=[];if(t){t.findComponents("render").forEach(t=>{s.push(...t.meshInstances)})}let n="";s.forEach(t=>{n+=this.buildMeshInstance(t)}),n+=`\ndef "Materials"\n{\n\t\t${this.materials.join("\n")}\n}\n`,this.addFile(null,pw,"",n);const i={maxTextureSize:e.maxTextureSize},r=Array.from(this.textureMap.keys()),a=[];for(let t=0;t<r.length;t++){const e="image/png",s=r[t],n=this.textureToCanvas(s,i).then(t=>t?new Promise(s=>t.toBlob(s,e,1)).then(t=>t.arrayBuffer()):(console.warn(`Export of texture ${s.name} is not currently supported.`),new Promise(t=>t(null))));a.push(n)}const o=Promise.all(a).then(t=>{t.forEach((t,e)=>{const s=r[e],n=this.getTextureFileIds(s);this.files[n.fileName]=new Uint8Array(t)}),this.alignFiles();const e=fw(this.files,{level:0});return this.done(),e});return o}alignFiles(){let t=0;for(const e in this.files){const s=this.files[e];t+=34+e.length;const n=63&t;if(4!==n){const t=new Uint8Array(64-n);this.files[e]=[s,{extra:{12345:t}}]}t=s.length}}getFileIds(t,e,s,n="usda"){const i=`${t?`${t}/`:""}${e}.${n}`;return{name:e,fileName:i,refName:`@./${i}@</${s}>`}}getTextureFileIds(t){return this.getFileIds("texture",`Texture_${t.id}`,"Texture","png")}addFile(t,e,s="",n=""){let i=null;n&&(i=cw(n=`#usda 1.0\n(\n\t\tcustomLayerData = {\n\t\t\t\tstring creator = "PlayCanvas UsdzExporter"\n\t\t}\n\t\tmetersPerUnit = 1\n\t\tupAxis = "Y"\n)\n\n${n}`));const r=this.getFileIds(t,e,s);return this.files[r.fileName]=i,r.refName}getMaterialRef(t){let e=this.materialMap.get(t);return e||(e=this.buildMaterial(t),this.materialMap.set(t,e)),e}getMeshRef(t){let e=this.meshMap.get(t);return e||(e=this.buildMesh(t),this.meshMap.set(t,e)),e}buildArray2(t){const e=[],s=t.length;for(let n=0;n<s;n+=2)e.push(`(${t[n]}, ${1-t[n+1]})`);return e.join(", ")}buildArray3(t){const e=[],s=t.length;for(let n=0;n<s;n+=3)e.push(`(${t[n]}, ${t[n+1]}, ${t[n+2]})`);return e.join(", ")}buildMat4(t){const e=t.data,s=[];for(let t=0;t<16;t+=4)s.push(`(${e[t]}, ${e[t+1]}, ${e[t+2]}, ${e[t+3]})`);return`( ${s.join(", ")} )`}buildMaterial(t){const e=`Material_${t.id}`,s=`/Materials/${e}`,n=t=>`<${s}${t}>`,i=[],r=[],a=(e,s,a,o,l,h=!1,c=!1)=>{const d=t[e];if(d){const h=this.getTextureFileIds(d);this.textureMap.set(d,h.refName);const u=t[`${e}Channel`]||"rgb",f=n(`/${h.name}_${l}.outputs:${u}`);i.push(mw(a,`${o}.connect`,f));const p=t[`${e}Tiling`],m=t[`${e}Offset`],g=t[`${e}Rotation`],_=1===t[`${e}Uv`]?"st1":"st",v=c&&s?s:Ze.WHITE;r.push(((t,e,s,i,r,a,o,l)=>`\n\t\t\t\t\t\t\t\tdef Shader "Transform2d_${s}" (\n\t\t\t\t\t\t\t\t\t\tsdrMetadata = {\n\t\t\t\t\t\t\t\t\t\t\t\tstring role = "math"\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tuniform token info:id = "UsdTransform2d"\n\t\t\t\t\t\t\t\t\t\tfloat2 inputs:in.connect = ${n(`/uvReader_${i}.outputs:result`)}\n\t\t\t\t\t\t\t\t\t\tfloat inputs:rotation = ${o}\n\t\t\t\t\t\t\t\t\t\tfloat2 inputs:scale = (${r.x}, ${r.y})\n\t\t\t\t\t\t\t\t\t\tfloat2 inputs:translation = (${a.x}, ${a.y})\n\t\t\t\t\t\t\t\t\t\tfloat2 outputs:result\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tdef Shader "Texture_${t.id}_${s}"\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tuniform token info:id = "UsdUVTexture"\n\t\t\t\t\t\t\t\t\t\tasset inputs:file = @${e.fileName}@\n\t\t\t\t\t\t\t\t\t\tfloat2 inputs:st.connect = ${n(`/Transform2d_${s}.outputs:result`)}\n\t\t\t\t\t\t\t\t\t\ttoken inputs:wrapS = "repeat"\n\t\t\t\t\t\t\t\t\t\ttoken inputs:wrapT = "repeat"\n\t\t\t\t\t\t\t\t\t\tfloat4 inputs:scale = (${l.r}, ${l.g}, ${l.b}, ${l.a})\n\t\t\t\t\t\t\t\t\t\tfloat outputs:r\n\t\t\t\t\t\t\t\t\t\tfloat outputs:g\n\t\t\t\t\t\t\t\t\t\tfloat outputs:b\n\t\t\t\t\t\t\t\t\t\tfloat3 outputs:rgb\n\t\t\t\t\t\t\t\t\t\tfloat outputs:a\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t`)(d,h,l,_,p,m,g,v))}else if(s){const t="float"===a?`${s}`:`(${s.r}, ${s.g}, ${s.b})`;i.push(mw(a,o,t))}};a("diffuseMap",t.diffuse,"color3f","diffuseColor","diffuse",!1,!0),(t.transparent||t.alphaTest>0)&&a("opacityMap",t.opacity,"float","opacity","opacity",!0),a("normalMap",null,"normal3f","normal","normal"),a("emissiveMap",t.emissive,"color3f","emissiveColor","emissive",!1,!0),a("aoMap",null,"float","occlusion","occlusion");a("metalnessMap",t.useMetalness?t.metalness:0,"float","metallic","metallic");a("glossMap",t.glossInvert?t.gloss:1-t.gloss,"float","roughness","roughness");const o=`\n\t\t\t\t\t\tdef Material "${e}"\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tdef Shader "PreviewSurface"\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tuniform token info:id = "UsdPreviewSurface"\n${i.join("\n")}\n\t\t\t\t\t\t\t\t\t\tint inputs:useSpecularWorkflow = 0\n\t\t\t\t\t\t\t\t\t\ttoken outputs:surface\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\ttoken outputs:surface.connect = ${n("/PreviewSurface.outputs:surface")}\n\n\t\t\t\t\t\t\t\tdef Shader "uvReader_st"\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tuniform token info:id = "UsdPrimvarReader_float2"\n\t\t\t\t\t\t\t\t\t\ttoken inputs:varname = "st"\n\t\t\t\t\t\t\t\t\t\tfloat2 inputs:fallback = (0.0, 0.0)\n\t\t\t\t\t\t\t\t\t\tfloat2 outputs:result\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tdef Shader "uvReader_st1"\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tuniform token info:id = "UsdPrimvarReader_float2"\n\t\t\t\t\t\t\t\t\t\ttoken inputs:varname = "st1"\n\t\t\t\t\t\t\t\t\t\tfloat2 inputs:fallback = (0.0, 0.0)\n\t\t\t\t\t\t\t\t\t\tfloat2 outputs:result\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t${r.join("\n")}\n\t\t\t\t\t\t}\n\t\t\t\t`;return this.materials.push(o),n("")}buildMesh(t){let e=[];const s=[];let n=[],i=[],r=[];t.getVertexStream(Ys,e),t.getVertexStream(Qs,n),t.getVertexStream(nn,i),t.getVertexStream(rn,r),t.getIndices(s);const a=s.length||e.length,o=Array(a/3).fill(3).join(", ");if(!s.length)for(let t=0;t<a;t++)s[t]=t;const l=e.length/3;n=n.length?n:Array(3*l).fill(0),i=i.length?i:Array(2*l).fill(0),r=r.length?r:Array(2*l).fill(0),e=this.buildArray3(e),n=this.buildArray3(n),i=this.buildArray2(i),r=this.buildArray2(r);const h=((t,e,s,n,i,r)=>`\ndef "Mesh"\n{\n\t\tdef Mesh "Mesh"\n\t\t{\n\t\t\t\tint[] faceVertexCounts = [${t}]\n\t\t\t\tint[] faceVertexIndices = [${e}]\n\t\t\t\tnormal3f[] normals = [${s}] (\n\t\t\t\t\t\tinterpolation = "vertex"\n\t\t\t\t)\n\t\t\t\tpoint3f[] points = [${n}]\n\t\t\t\ttexCoord2f[] primvars:st = [${i}] (\n\t\t\t\t\t\tinterpolation = "vertex"\n\t\t\t\t)\n\t\t\t\ttexCoord2f[] primvars:st1 = [${r}] (\n\t\t\t\t\t\tinterpolation = "vertex"\n\t\t\t\t)\n\t\t\t\tuniform token subdivisionScheme = "none"\n\t\t}\n}\n`)(o,s,n,e,i,r);return this.addFile("mesh",`Mesh_${t.id}`,"Mesh",h)}buildMeshInstance(t){const e=this.getMeshRef(t.mesh),s=this.getMaterialRef(t.material),n=this.buildMat4(t.node.getWorldTransform()),i=t.node.name.replace(/[^a-z0-9]/gi,"_");let r=i;for(;this.nodeNames.has(r);)r=`${i}_${Math.random().toString(36).slice(2,7)}`;return this.nodeNames.add(r),((t,e,s,n)=>`\ndef Xform "${t}" (\n\t\tprepend references = ${e}\n)\n{\n\t\tmatrix4d xformOp:transform = ${s}\n\t\tuniform token[] xformOpOrder = ["xformOp:transform"]\n\n\t\trel material:binding = ${n}\n}\n`)(r,e,n,s)}}const _w=new rs,vw=new ms;class yw{constructor(t=rs.ZERO,e=rs.ZERO,s=0){this.position=new rs,this.angles=new rs,this.distance=0,this.pitchRange=new os(-1/0,1/0),this.yawRange=new os(-1/0,1/0),this.xRange=new os(-1/0,1/0),this.yRange=new os(-1/0,1/0),this.zRange=new os(-1/0,1/0),this.set(t,e,s)}copy(t){return this.set(t.position,t.angles,t.distance)}clone(){return new yw(this.position.clone(),this.angles.clone(),this.distance)}equalsApprox(t,e=1e-6){return this.position.equalsApprox(t.position,e)&&this.angles.equalsApprox(t.angles,e)&&Math.abs(this.distance-t.distance)<e}lerp(t,e,s,n=s,i=s){return this.position.lerp(t.position,e.position,s),this.angles.x=Qe.lerpAngle(t.angles.x,e.angles.x,n)%360,this.angles.y=Qe.lerpAngle(t.angles.y,e.angles.y,n)%360,this.angles.z=Qe.lerpAngle(t.angles.z,e.angles.z,n)%360,this.distance=Qe.lerp(t.distance,e.distance,i),this}move(t){return this.position.add(t),this.position.x=Qe.clamp(this.position.x,this.xRange.x,this.xRange.y),this.position.y=Qe.clamp(this.position.y,this.yRange.x,this.yRange.y),this.position.z=Qe.clamp(this.position.z,this.zRange.x,this.zRange.y),this}rotate(t){return this.angles.add(t),this.angles.x%=360,this.angles.y%=360,this.angles.z%=360,this.angles.x=Qe.clamp(this.angles.x,this.pitchRange.x,this.pitchRange.y),this.angles.y=Qe.clamp(this.angles.y,this.yawRange.x,this.yawRange.y),this}set(t,e,s){return this.position.copy(t),this.angles.copy(e),this.distance=s,this}look(t,e){this.position.copy(t),this.distance=t.distance(e);const s=_w.sub2(e,t).normalize(),n=Math.atan2(-s.y,Math.sqrt(s.x*s.x+s.z*s.z))*Qe.RAD_TO_DEG,i=Math.atan2(-s.x,-s.z)*Qe.RAD_TO_DEG;return this.angles.set(-n,i,0),this}getFocus(t){return vw.setFromEulerAngles(this.angles).transformVector(rs.FORWARD,t).mulScalar(this.distance).add(this.position)}}class bw{constructor(t){Array.isArray(t)?this._value=t.slice():this._value=new Array(+t).fill(0)}add(t){for(let e=0;e<this._value.length;e++)this._value[e]+=t._value[e]||0;return this}append(t){for(let e=0;e<this._value.length;e++)this._value[e]+=t[e]||0;return this}copy(t){for(let e=0;e<this._value.length;e++)this._value[e]=t._value[e]||0;return this}length(){let t=0;for(const e of this._value)t+=e*e;return Math.sqrt(t)}read(){const t=this._value.slice();return this._value.fill(0),t}}class Sw{constructor(t){this.deltas={};for(const e in t)this.deltas[e]=new bw(t[e])}read(){const t={};for(const e in this.deltas)t[e]=this.deltas[e].read();return t}}class xw extends Sw{on(t,e){this._events.on(t,e)}off(t,e){this._events.off(t,e)}fire(t,...e){this._events.fire(t,...e)}attach(t){this._element&&this.detach(),this._element=t}detach(){this._element&&(this._element=null,this.read())}destroy(){this.detach(),this._events.off()}constructor(...t){super(...t),this._element=null,this._events=new Ve}}class ww{update(t,e){t.read()}}class Tw extends ww{attach(t,e=!0){}detach(){}update(t,e){return super.update(t,e),this._pose}destroy(){this.detach()}constructor(...t){super(...t),this._pose=new yw}}const Cw=()=>{const t=new Map;return{down:e=>{t.set(e.pointerId,[e.screenX,e.screenY])},move:e=>{if(!t.has(e.pointerId))return[0,0];const s=t.get(e.pointerId),n=e.screenX-s[0],i=e.screenY-s[1];return s[0]=e.screenX,s[1]=e.screenY,[n,i]},up:e=>{t.delete(e.pointerId)}}},Ew=new os;class Aw{constructor({range:t}={}){this._range=70,this._position=new os,this._value=new os,this._range=t??this._range}get value(){return this._value}down(t,e){return this._position.set(t,e),this._value.set(0,0),[t,e,t,e]}move(t,e){Ew.set(t-this._position.x,e-this._position.y),Ew.length()>this._range&&Ew.normalize().mulScalar(this._range),this._value.set(Qe.clamp(Ew.x/this._range,-1,1),Qe.clamp(Ew.y/this._range,-1,1));const{x:s,y:n}=this._position;return[s,n,s+Ew.x,n+Ew.y]}up(){return this._position.set(0,0),this._value.set(0,0),[-1,-1,-1,-1]}}const Dw=(t,e)=>0===t.indexOf(e),Pw=(t,e)=>-1!==t.indexOf(e,t.length-e.length);class Lw extends xw{constructor(t){super({leftInput:[0,0],rightInput:[0,0],doubleTap:[0]}),this._movementState=Cw(),this._layout="joystick-touch",this._pointerData=new Map,this._lastPointer={x:0,y:0,time:0},t&&(this.layout=t),this._leftJoystick=new Aw,this._rightJoystick=new Aw,this._onPointerDown=this._onPointerDown.bind(this),this._onPointerMove=this._onPointerMove.bind(this),this._onPointerUp=this._onPointerUp.bind(this)}set layout(t){this._layout!==t&&(this._layout=t,this.read(),this._pointerData.clear())}get layout(){return this._layout}get leftJoystick(){return this._leftJoystick}get rightJoystick(){return this._rightJoystick}_onPointerDown(t){const{pointerType:e,pointerId:s,clientX:n,clientY:i}=t;if(this._movementState.down(t),"touch"!==e)return;this._element?.setPointerCapture(s);const r=n<.5*window.innerWidth;this._pointerData.set(s,{x:n,y:i,left:r});const a=Date.now();(this._lastPointer.x-n)**2+(this._lastPointer.y-i)**2<100&&a-this._lastPointer.time<250&&this.deltas.doubleTap.append([1]),this._lastPointer.x=n,this._lastPointer.y=i,this._lastPointer.time=a,r&&Dw(this._layout,"joystick")&&this.fire("joystick:position:left",this._leftJoystick.down(n,i)),!r&&Pw(this._layout,"joystick")&&this.fire("joystick:position:right",this._rightJoystick.down(n,i))}_onPointerMove(t){const{pointerType:e,pointerId:s,target:n,clientX:i,clientY:r}=t,[a,o]=this._movementState.move(t);if("touch"!==e)return;if(n!==this._element)return;const l=this._pointerData.get(s);if(!l)return;const{left:h}=l;l.x=i,l.y=r,h?Dw(this._layout,"joystick")?this.fire("joystick:position:left",this._leftJoystick.move(i,r)):this.deltas.leftInput.append([a,o]):Pw(this._layout,"joystick")?this.fire("joystick:position:right",this._rightJoystick.move(i,r)):this.deltas.rightInput.append([a,o])}_onPointerUp(t){const{pointerType:e,pointerId:s}=t;if(this._movementState.up(t),"touch"!==e)return;this._element?.releasePointerCapture(s);const n=this._pointerData.get(s);if(!n)return;const{left:i}=n;this._pointerData.delete(s),i&&Dw(this._layout,"joystick")&&this.fire("joystick:position:left",this._leftJoystick.up()),!i&&Pw(this._layout,"joystick")&&this.fire("joystick:position:right",this._rightJoystick.up())}attach(t){super.attach(t),this._element=t,this._element.addEventListener("pointerdown",this._onPointerDown),this._element.addEventListener("pointermove",this._onPointerMove),this._element.addEventListener("pointerup",this._onPointerUp),this._element.addEventListener("pointercancel",this._onPointerUp)}detach(){this._element&&(this._element.removeEventListener("pointerdown",this._onPointerDown),this._element.removeEventListener("pointermove",this._onPointerMove),this._element.removeEventListener("pointerup",this._onPointerUp),this._element.removeEventListener("pointercancel",this._onPointerUp),this._pointerData.clear(),super.detach())}read(){return this.deltas.leftInput.append([this._leftJoystick.value.x,this._leftJoystick.value.y]),this.deltas.rightInput.append([this._rightJoystick.value.x,this._rightJoystick.value.y]),super.read()}destroy(){this._leftJoystick.up(),this._rightJoystick.up(),super.destroy()}}const Iw=new os;class Rw extends xw{constructor(){super({touch:[0,0],count:[0],pinch:[0]}),this._movementState=Cw(),this._pointerEvents=new Map,this._pointerPos=new os,this._pinchDist=-1,this._onPointerDown=this._onPointerDown.bind(this),this._onPointerMove=this._onPointerMove.bind(this),this._onPointerUp=this._onPointerUp.bind(this),this._onContextMenu=this._onContextMenu.bind(this)}_onPointerDown(t){const{pointerId:e,pointerType:s}=t;this._movementState.down(t),"touch"===s&&(this._element?.setPointerCapture(e),this._pointerEvents.set(e,t),this.deltas.count.append([1]),this._pointerEvents.size>1&&(this._getMidPoint(this._pointerPos),this._pinchDist=this._getPinchDist()))}_onPointerMove(t){const{pointerType:e,target:s,pointerId:n}=t,[i,r]=this._movementState.move(t);if("touch"===e&&s===this._element&&0!==this._pointerEvents.size)if(this._pointerEvents.set(n,t),this._pointerEvents.size>1){const t=this._getMidPoint(Iw);this.deltas.touch.append([t.x-this._pointerPos.x,t.y-this._pointerPos.y]),this._pointerPos.copy(t);const e=this._getPinchDist();this._pinchDist>0&&this.deltas.pinch.append([this._pinchDist-e]),this._pinchDist=e}else this.deltas.touch.append([i,r])}_onPointerUp(t){const{pointerType:e,pointerId:s}=t;this._movementState.up(t),"touch"===e&&(this._element?.releasePointerCapture(s),this._pointerEvents.delete(s),this.deltas.count.append([-1]),this._pointerEvents.size<2&&(this._pinchDist=-1),this._pointerPos.set(0,0))}_onContextMenu(t){t.preventDefault()}_getMidPoint(t){if(this._pointerEvents.size<2)return t.set(0,0);const[e,s]=this._pointerEvents.values(),n=e.clientX-s.clientX,i=e.clientY-s.clientY;return t.set(s.clientX+.5*n,s.clientY+.5*i)}_getPinchDist(){if(this._pointerEvents.size<2)return 0;const[t,e]=this._pointerEvents.values(),s=t.clientX-e.clientX,n=t.clientY-e.clientY;return Math.sqrt(s*s+n*n)}attach(t){super.attach(t),this._element=t,this._element.addEventListener("pointerdown",this._onPointerDown),this._element.addEventListener("pointermove",this._onPointerMove),this._element.addEventListener("pointerup",this._onPointerUp),this._element.addEventListener("pointercancel",this._onPointerUp),this._element.addEventListener("contextmenu",this._onContextMenu)}detach(){this._element&&(this._element.removeEventListener("pointerdown",this._onPointerDown),this._element.removeEventListener("pointermove",this._onPointerMove),this._element.removeEventListener("pointerup",this._onPointerUp),this._element.removeEventListener("pointercancel",this._onPointerUp),this._element.removeEventListener("contextmenu",this._onContextMenu),this._pointerEvents.clear(),super.detach())}}const Mw={passive:!1},kw={A:0,B:1,C:2,D:3,E:4,F:5,G:6,H:7,I:8,J:9,K:10,L:11,M:12,N:13,O:14,P:15,Q:16,R:17,S:18,T:19,U:20,V:21,W:22,X:23,Y:24,Z:25,0:26,1:27,2:28,3:29,4:30,5:31,6:32,7:33,8:34,9:35,UP:36,DOWN:37,LEFT:38,RIGHT:39,SPACE:40,SHIFT:41,CTRL:42},Ow=Object.keys(kw).length,Fw=Array(Ow).fill(0);class Nw extends xw{static{this.keyCode=kw}constructor({pointerLock:t=!1}={}){super({key:Array(Ow).fill(0),button:[0,0,0],mouse:[0,0],wheel:[0]}),this._movementState=Cw(),this._pointerId=-1,this._keyMap=new Map,this._keyPrev=Array(Ow).fill(0),this._keyNow=Array(Ow).fill(0),this._button=Array(3).fill(0),this._pointerLock=t??!1;const{keyCode:e}=Nw;for(let t=0;t<26;t++){const s=`Key${String.fromCharCode("A".charCodeAt(0)+t)}`;this._keyMap.set(s,e.A+t)}for(let t=0;t<10;t++){const s=`Digit${t}`;this._keyMap.set(s,e[0]+t)}this._keyMap.set("ArrowUp",e.UP),this._keyMap.set("ArrowDown",e.DOWN),this._keyMap.set("ArrowLeft",e.LEFT),this._keyMap.set("ArrowRight",e.RIGHT),this._keyMap.set("Space",e.SPACE),this._keyMap.set("ShiftLeft",e.SHIFT),this._keyMap.set("ShiftRight",e.SHIFT),this._keyMap.set("ControlLeft",e.CTRL),this._keyMap.set("ControlRight",e.CTRL),this._onWheel=this._onWheel.bind(this),this._onPointerDown=this._onPointerDown.bind(this),this._onPointerMove=this._onPointerMove.bind(this),this._onPointerUp=this._onPointerUp.bind(this),this._onContextMenu=this._onContextMenu.bind(this),this._onKeyDown=this._onKeyDown.bind(this),this._onKeyUp=this._onKeyUp.bind(this)}_onWheel(t){t.preventDefault(),this.deltas.wheel.append([t.deltaY])}_onPointerDown(t){this._movementState.down(t),"mouse"===t.pointerType&&(this._pointerLock?document.pointerLockElement!==this._element&&this._element?.requestPointerLock():this._element?.setPointerCapture(t.pointerId),this._clearButtons(),this._button[t.button]=1,this.deltas.button.append(this._button),-1===this._pointerId&&(this._pointerId=t.pointerId))}_onPointerMove(t){const[e,s]=this._pointerLock&&document.pointerLockElement===this._element?[t.movementX,t.movementY]:this._movementState.move(t);if("mouse"===t.pointerType&&t.target===this._element){if(this._pointerLock){if(document.pointerLockElement!==this._element)return}else if(this._pointerId!==t.pointerId)return;this.deltas.mouse.append([e,s])}}_onPointerUp(t){this._movementState.up(t),"mouse"===t.pointerType&&(this._pointerLock||this._element?.releasePointerCapture(t.pointerId),this._clearButtons(),this.deltas.button.append(this._button),this._pointerId===t.pointerId&&(this._pointerId=-1))}_onContextMenu(t){t.preventDefault()}_onKeyDown(t){this._pointerLock&&document.pointerLockElement!==this._element||(t.stopPropagation(),this._setKey(t.code,1))}_onKeyUp(t){t.stopPropagation(),this._setKey(t.code,0)}_clearButtons(){for(let t=0;t<this._button.length;t++)1!==this._button[t]?this._button[t]=0:this._button[t]=-1}_setKey(t,e){this._keyMap.has(t)&&(this._keyNow[this._keyMap.get(t)??0]=e)}attach(t){super.attach(t),this._element=t,this._element.addEventListener("wheel",this._onWheel,Mw),this._element.addEventListener("pointerdown",this._onPointerDown),this._element.addEventListener("pointermove",this._onPointerMove),this._element.addEventListener("pointerup",this._onPointerUp),this._element.addEventListener("pointercancel",this._onPointerUp),this._element.addEventListener("pointerleave",this._onPointerUp),this._element.addEventListener("contextmenu",this._onContextMenu),window.addEventListener("keydown",this._onKeyDown,!1),window.addEventListener("keyup",this._onKeyUp,!1)}detach(){this._element&&(this._element.removeEventListener("wheel",this._onWheel,Mw),this._element.removeEventListener("pointerdown",this._onPointerDown),this._element.removeEventListener("pointermove",this._onPointerMove),this._element.removeEventListener("pointerup",this._onPointerUp),this._element.removeEventListener("pointercancel",this._onPointerUp),this._element.removeEventListener("pointerleave",this._onPointerUp),this._element.removeEventListener("contextmenu",this._onContextMenu),window.removeEventListener("keydown",this._onKeyDown,!1),window.removeEventListener("keyup",this._onKeyUp,!1),this._keyNow.fill(0),this._keyPrev.fill(0),super.detach())}read(){for(let t=0;t<Fw.length;t++)Fw[t]=this._keyNow[t]-this._keyPrev[t],this._keyPrev[t]=this._keyNow[t];return this.deltas.key.append(Fw),super.read()}}const Bw={A:0,B:1,X:2,Y:3,LB:4,RB:5,LT:6,RT:7,SELECT:8,START:9,LEFT_STICK:10,RIGHT_STICK:11},zw=Object.keys(Bw).length;class Uw extends xw{static{this.buttonCode=Bw}constructor(){super({buttons:Array(zw).fill(0),leftStick:[0,0],rightStick:[0,0]}),this._buttonPrev=Array(zw).fill(0)}read(){const t=navigator.getGamepads();for(let e=0;e<t.length;e++){const s=t[e];if(!s)continue;if("standard"!==s.mapping)continue;if(s.axes.length<4)continue;if(s.buttons.length<zw)continue;const{buttons:n,axes:i}=s;for(let t=0;t<this._buttonPrev.length;t++){const e=+n[t].pressed;this.deltas.buttons[t]=e-this._buttonPrev[t],this._buttonPrev[t]=e}this.deltas.leftStick.append([i[0],i[1]]),this.deltas.rightStick.append([i[2],i[3]])}return super.read()}}const Vw=(t,e)=>1-Math.pow(t,1e3*e),Hw=new rs,Gw=new rs,Ww=new rs,jw=new rs,$w=new rs,Xw=new ms;class qw extends Tw{set pitchRange(t){this._targetPose.pitchRange.copy(t),this._pose.copy(this._targetPose.rotate(rs.ZERO))}get pitchRange(){return this._targetPose.pitchRange}set yawRange(t){this._targetPose.yawRange.copy(t),this._pose.copy(this._targetPose.rotate(rs.ZERO))}get yawRange(){return this._targetPose.yawRange}attach(t,e=!0){this._targetPose.copy(t),e||this._pose.copy(this._targetPose)}detach(){this._targetPose.copy(this._pose)}update(t,e){const{move:s,rotate:n}=t.read();return this._targetPose.rotate(Gw.set(-n[1],-n[0],0)),Xw.setFromEulerAngles(this._pose.angles),Xw.transformVector(rs.FORWARD,Ww),Xw.transformVector(rs.RIGHT,jw),Xw.transformVector(rs.UP,$w),Hw.set(0,0,0),Hw.add(Ww.mulScalar(s[2])),Hw.add(jw.mulScalar(s[0])),Hw.add($w.mulScalar(s[1])),this._targetPose.move(Hw),this._pose.lerp(this._pose,this._targetPose,Vw(this.moveDamping,e),Vw(this.rotateDamping,e))}destroy(){this.detach()}constructor(...t){super(...t),this._targetPose=new yw,this.rotateDamping=.98,this.moveDamping=.98}}const Kw=new rs,Yw=new rs,Qw=new rs,Zw=new ms;class Jw extends Tw{set pitchRange(t){this._targetRootPose.pitchRange.copy(t),this._rootPose.copy(this._targetRootPose.rotate(rs.ZERO))}get pitchRange(){return this._targetRootPose.pitchRange}set yawRange(t){this._targetRootPose.yawRange.copy(t),this._rootPose.copy(this._targetRootPose.rotate(rs.ZERO))}get yawRange(){return this._targetRootPose.yawRange}set zoomRange(t){this._targetChildPose.zRange.copy(t),this._childPose.copy(this._targetChildPose.move(rs.ZERO))}get zoomRange(){return this._targetRootPose.zRange}attach(t,e=!0){this._targetRootPose.set(t.getFocus(Kw),t.angles,0),this._targetChildPose.position.set(0,0,t.distance),e||(this._rootPose.copy(this._targetRootPose),this._childPose.copy(this._targetChildPose))}detach(){this._targetRootPose.copy(this._rootPose),this._targetChildPose.copy(this._childPose)}update(t,e){const{move:s,rotate:n}=t.read();Yw.set(s[0],s[1],0),Zw.setFromEulerAngles(this._rootPose.angles).transformVector(Yw,Yw),this._targetRootPose.move(Yw);const{z:i}=this._targetChildPose.position;return this._targetChildPose.move(Yw.set(0,0,i*(1+s[2])-i)),this._targetRootPose.rotate(Qw.set(-n[1],-n[0],0)),this._rootPose.lerp(this._rootPose,this._targetRootPose,Vw(this.moveDamping,e),Vw(this.rotateDamping,e),1),this._childPose.lerp(this._childPose,this._targetChildPose,Vw(this.zoomDamping,e),1,1),Zw.setFromEulerAngles(this._rootPose.angles).transformVector(this._childPose.position,Yw).add(this._rootPose.position),this._pose.set(Yw,this._rootPose.angles,this._childPose.position.z)}destroy(){this.detach()}constructor(...t){super(...t),this._targetRootPose=new yw,this._rootPose=new yw,this._targetChildPose=new yw,this._childPose=new yw,this.rotateDamping=.98,this.moveDamping=.98,this.zoomDamping=.98}}let tT;function eT(t){if(tT.call(this,t),3===t);else this._blendState.setAlphaBlend(0,1,8)}const sT=()=>{const t=Object.getOwnPropertyDescriptor(Cd.prototype,"blendType");tT=t.set,Object.defineProperty(Cd.prototype,"blendType",{set(t){eT.call(this,t)},get(){return t.get.call(this)}})};var nT,iT,rT={exports:{}},aT={};function oT(){if(nT)return aT;nT=1;var t=c();function e(t){var e="https://react.dev/errors/"+t;if(1<arguments.length){e+="?args[]="+encodeURIComponent(arguments[1]);for(var s=2;s<arguments.length;s++)e+="&args[]="+encodeURIComponent(arguments[s])}return"Minified React error #"+t+"; visit "+e+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}function s(){}var n={d:{f:s,r:function(){throw Error(e(522))},D:s,C:s,L:s,m:s,X:s,S:s,M:s},p:0,findDOMNode:null},i=Symbol.for("react.portal");var r=t.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE;function a(t,e){return"font"===t?"":"string"==typeof e?"use-credentials"===e?e:"":void 0}return aT.__DOM_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE=n,aT.createPortal=function(t,s){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;if(!s||1!==s.nodeType&&9!==s.nodeType&&11!==s.nodeType)throw Error(e(299));return function(t,e,s){var n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;return{$$typeof:i,key:null==n?null:""+n,children:t,containerInfo:e,implementation:s}}(t,s,null,n)},aT.flushSync=function(t){var e=r.T,s=n.p;try{if(r.T=null,n.p=2,t)return t()}finally{r.T=e,n.p=s,n.d.f()}},aT.preconnect=function(t,e){"string"==typeof t&&(e?e="string"==typeof(e=e.crossOrigin)?"use-credentials"===e?e:"":void 0:e=null,n.d.C(t,e))},aT.prefetchDNS=function(t){"string"==typeof t&&n.d.D(t)},aT.preinit=function(t,e){if("string"==typeof t&&e&&"string"==typeof e.as){var s=e.as,i=a(s,e.crossOrigin),r="string"==typeof e.integrity?e.integrity:void 0,o="string"==typeof e.fetchPriority?e.fetchPriority:void 0;"style"===s?n.d.S(t,"string"==typeof e.precedence?e.precedence:void 0,{crossOrigin:i,integrity:r,fetchPriority:o}):"script"===s&&n.d.X(t,{crossOrigin:i,integrity:r,fetchPriority:o,nonce:"string"==typeof e.nonce?e.nonce:void 0})}},aT.preinitModule=function(t,e){if("string"==typeof t)if("object"==typeof e&&null!==e){if(null==e.as||"script"===e.as){var s=a(e.as,e.crossOrigin);n.d.M(t,{crossOrigin:s,integrity:"string"==typeof e.integrity?e.integrity:void 0,nonce:"string"==typeof e.nonce?e.nonce:void 0})}}else null==e&&n.d.M(t)},aT.preload=function(t,e){if("string"==typeof t&&"object"==typeof e&&null!==e&&"string"==typeof e.as){var s=e.as,i=a(s,e.crossOrigin);n.d.L(t,s,{crossOrigin:i,integrity:"string"==typeof e.integrity?e.integrity:void 0,nonce:"string"==typeof e.nonce?e.nonce:void 0,type:"string"==typeof e.type?e.type:void 0,fetchPriority:"string"==typeof e.fetchPriority?e.fetchPriority:void 0,referrerPolicy:"string"==typeof e.referrerPolicy?e.referrerPolicy:void 0,imageSrcSet:"string"==typeof e.imageSrcSet?e.imageSrcSet:void 0,imageSizes:"string"==typeof e.imageSizes?e.imageSizes:void 0,media:"string"==typeof e.media?e.media:void 0})}},aT.preloadModule=function(t,e){if("string"==typeof t)if(e){var s=a(e.as,e.crossOrigin);n.d.m(t,{as:"string"==typeof e.as&&"script"!==e.as?e.as:void 0,crossOrigin:s,integrity:"string"==typeof e.integrity?e.integrity:void 0})}else n.d.m(t)},aT.requestFormReset=function(t){n.d.r(t)},aT.unstable_batchedUpdates=function(t,e){return t(e)},aT.useFormState=function(t,e,s){return r.H.useFormState(t,e,s)},aT.useFormStatus=function(){return r.H.useHostTransitionStatus()},aT.version="19.2.3",aT}function lT(){if(iT)return rT.exports;return iT=1,function t(){if("undefined"!=typeof __REACT_DEVTOOLS_GLOBAL_HOOK__&&"function"==typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE)try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(t)}catch(t){console.error(t)}}(),rT.exports=oT(),rT.exports}var hT,cT,dT,uT,fT=lT(),pT={exports:{}},mT={},gT={exports:{}},_T={};function vT(){return hT||(hT=1,function(t){function e(t,e){var s=t.length;t.push(e);t:for(;0<s;){var n=s-1>>>1,r=t[n];if(!(0<i(r,e)))break t;t[n]=e,t[s]=r,s=n}}function s(t){return 0===t.length?null:t[0]}function n(t){if(0===t.length)return null;var e=t[0],s=t.pop();if(s!==e){t[0]=s;t:for(var n=0,r=t.length,a=r>>>1;n<a;){var o=2*(n+1)-1,l=t[o],h=o+1,c=t[h];if(0>i(l,s))h<r&&0>i(c,l)?(t[n]=c,t[h]=s,n=h):(t[n]=l,t[o]=s,n=o);else{if(!(h<r&&0>i(c,s)))break t;t[n]=c,t[h]=s,n=h}}}return e}function i(t,e){var s=t.sortIndex-e.sortIndex;return 0!==s?s:t.id-e.id}if(t.unstable_now=void 0,"object"==typeof performance&&"function"==typeof performance.now){var r=performance;t.unstable_now=function(){return r.now()}}else{var a=Date,o=a.now();t.unstable_now=function(){return a.now()-o}}var l=[],h=[],c=1,d=null,u=3,f=!1,p=!1,m=!1,g=!1,_="function"==typeof setTimeout?setTimeout:null,v="function"==typeof clearTimeout?clearTimeout:null,y="undefined"!=typeof setImmediate?setImmediate:null;function b(t){for(var i=s(h);null!==i;){if(null===i.callback)n(h);else{if(!(i.startTime<=t))break;n(h),i.sortIndex=i.expirationTime,e(l,i)}i=s(h)}}function S(t){if(m=!1,b(t),!p)if(null!==s(l))p=!0,w||(w=!0,x());else{var e=s(h);null!==e&&I(S,e.startTime-t)}}var x,w=!1,T=-1,C=5,E=-1;function A(){return!!g||!(t.unstable_now()-E<C)}function D(){if(g=!1,w){var e=t.unstable_now();E=e;var i=!0;try{t:{p=!1,m&&(m=!1,v(T),T=-1),f=!0;var r=u;try{e:{for(b(e),d=s(l);null!==d&&!(d.expirationTime>e&&A());){var a=d.callback;if("function"==typeof a){d.callback=null,u=d.priorityLevel;var o=a(d.expirationTime<=e);if(e=t.unstable_now(),"function"==typeof o){d.callback=o,b(e),i=!0;break e}d===s(l)&&n(l),b(e)}else n(l);d=s(l)}if(null!==d)i=!0;else{var c=s(h);null!==c&&I(S,c.startTime-e),i=!1}}break t}finally{d=null,u=r,f=!1}i=void 0}}finally{i?x():w=!1}}}if("function"==typeof y)x=function(){y(D)};else if("undefined"!=typeof MessageChannel){var P=new MessageChannel,L=P.port2;P.port1.onmessage=D,x=function(){L.postMessage(null)}}else x=function(){_(D,0)};function I(e,s){T=_(function(){e(t.unstable_now())},s)}t.unstable_IdlePriority=5,t.unstable_ImmediatePriority=1,t.unstable_LowPriority=4,t.unstable_NormalPriority=3,t.unstable_Profiling=null,t.unstable_UserBlockingPriority=2,t.unstable_cancelCallback=function(t){t.callback=null},t.unstable_forceFrameRate=function(t){0>t||125<t?console.error("forceFrameRate takes a positive int between 0 and 125, forcing frame rates higher than 125 fps is not supported"):C=0<t?Math.floor(1e3/t):5},t.unstable_getCurrentPriorityLevel=function(){return u},t.unstable_next=function(t){switch(u){case 1:case 2:case 3:var e=3;break;default:e=u}var s=u;u=e;try{return t()}finally{u=s}},t.unstable_requestPaint=function(){g=!0},t.unstable_runWithPriority=function(t,e){switch(t){case 1:case 2:case 3:case 4:case 5:break;default:t=3}var s=u;u=t;try{return e()}finally{u=s}},t.unstable_scheduleCallback=function(n,i,r){var a=t.unstable_now();switch("object"==typeof r&&null!==r?r="number"==typeof(r=r.delay)&&0<r?a+r:a:r=a,n){case 1:var o=-1;break;case 2:o=250;break;case 5:o=1073741823;break;case 4:o=1e4;break;default:o=5e3}return n={id:c++,callback:i,priorityLevel:n,startTime:r,expirationTime:o=r+o,sortIndex:-1},r>a?(n.sortIndex=r,e(h,n),null===s(l)&&n===s(h)&&(m?(v(T),T=-1):m=!0,I(S,r-a))):(n.sortIndex=o,e(l,n),p||f||(p=!0,w||(w=!0,x()))),n},t.unstable_shouldYield=A,t.unstable_wrapCallback=function(t){var e=u;return function(){var s=u;u=e;try{return t.apply(this,arguments)}finally{u=s}}}}(_T)),_T}function yT(){return cT||(cT=1,gT.exports=vT()),gT.exports}
/**
 * @license React
 * react-dom-client.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */function bT(){if(dT)return mT;dT=1;var t=yT(),e=c(),s=lT();function n(t){var e="https://react.dev/errors/"+t;if(1<arguments.length){e+="?args[]="+encodeURIComponent(arguments[1]);for(var s=2;s<arguments.length;s++)e+="&args[]="+encodeURIComponent(arguments[s])}return"Minified React error #"+t+"; visit "+e+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}function i(t){return!(!t||1!==t.nodeType&&9!==t.nodeType&&11!==t.nodeType)}function r(t){var e=t,s=t;if(t.alternate)for(;e.return;)e=e.return;else{t=e;do{!!(4098&(e=t).flags)&&(s=e.return),t=e.return}while(t)}return 3===e.tag?s:null}function a(t){if(13===t.tag){var e=t.memoizedState;if(null===e&&(null!==(t=t.alternate)&&(e=t.memoizedState)),null!==e)return e.dehydrated}return null}function o(t){if(31===t.tag){var e=t.memoizedState;if(null===e&&(null!==(t=t.alternate)&&(e=t.memoizedState)),null!==e)return e.dehydrated}return null}function l(t){if(r(t)!==t)throw Error(n(188))}function h(t){var e=t.tag;if(5===e||26===e||27===e||6===e)return t;for(t=t.child;null!==t;){if(null!==(e=h(t)))return e;t=t.sibling}return null}var d=Object.assign,u=Symbol.for("react.element"),f=Symbol.for("react.transitional.element"),p=Symbol.for("react.portal"),m=Symbol.for("react.fragment"),g=Symbol.for("react.strict_mode"),_=Symbol.for("react.profiler"),v=Symbol.for("react.consumer"),y=Symbol.for("react.context"),b=Symbol.for("react.forward_ref"),S=Symbol.for("react.suspense"),x=Symbol.for("react.suspense_list"),w=Symbol.for("react.memo"),T=Symbol.for("react.lazy"),C=Symbol.for("react.activity"),E=Symbol.for("react.memo_cache_sentinel"),A=Symbol.iterator;function D(t){return null===t||"object"!=typeof t?null:"function"==typeof(t=A&&t[A]||t["@@iterator"])?t:null}var P=Symbol.for("react.client.reference");function L(t){if(null==t)return null;if("function"==typeof t)return t.$$typeof===P?null:t.displayName||t.name||null;if("string"==typeof t)return t;switch(t){case m:return"Fragment";case _:return"Profiler";case g:return"StrictMode";case S:return"Suspense";case x:return"SuspenseList";case C:return"Activity"}if("object"==typeof t)switch(t.$$typeof){case p:return"Portal";case y:return t.displayName||"Context";case v:return(t._context.displayName||"Context")+".Consumer";case b:var e=t.render;return(t=t.displayName)||(t=""!==(t=e.displayName||e.name||"")?"ForwardRef("+t+")":"ForwardRef"),t;case w:return null!==(e=t.displayName||null)?e:L(t.type)||"Memo";case T:e=t._payload,t=t._init;try{return L(t(e))}catch(t){}}return null}var I=Array.isArray,R=e.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE,M=s.__DOM_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE,k={pending:!1,data:null,method:null,action:null},O=[],F=-1;function N(t){return{current:t}}function B(t){0>F||(t.current=O[F],O[F]=null,F--)}function z(t,e){F++,O[F]=t.current,t.current=e}var U,V,H=N(null),G=N(null),W=N(null),j=N(null);function $(t,e){switch(z(W,e),z(G,t),z(H,null),e.nodeType){case 9:case 11:t=(t=e.documentElement)&&(t=t.namespaceURI)?md(t):0;break;default:if(t=e.tagName,e=e.namespaceURI)t=gd(e=md(e),t);else switch(t){case"svg":t=1;break;case"math":t=2;break;default:t=0}}B(H),z(H,t)}function X(){B(H),B(G),B(W)}function q(t){null!==t.memoizedState&&z(j,t);var e=H.current,s=gd(e,t.type);e!==s&&(z(G,t),z(H,s))}function K(t){G.current===t&&(B(H),B(G)),j.current===t&&(B(j),lu._currentValue=k)}function Y(t){if(void 0===U)try{throw Error()}catch(t){var e=t.stack.trim().match(/\n( *(at )?)/);U=e&&e[1]||"",V=-1<t.stack.indexOf("\n    at")?" (<anonymous>)":-1<t.stack.indexOf("@")?"@unknown:0:0":""}return"\n"+U+t+V}var Q=!1;function Z(t,e){if(!t||Q)return"";Q=!0;var s=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{var n={DetermineComponentFrameRoot:function(){try{if(e){var s=function(){throw Error()};if(Object.defineProperty(s.prototype,"props",{set:function(){throw Error()}}),"object"==typeof Reflect&&Reflect.construct){try{Reflect.construct(s,[])}catch(t){var n=t}Reflect.construct(t,[],s)}else{try{s.call()}catch(t){n=t}t.call(s.prototype)}}else{try{throw Error()}catch(t){n=t}(s=t())&&"function"==typeof s.catch&&s.catch(function(){})}}catch(t){if(t&&n&&"string"==typeof t.stack)return[t.stack,n.stack]}return[null,null]}};n.DetermineComponentFrameRoot.displayName="DetermineComponentFrameRoot";var i=Object.getOwnPropertyDescriptor(n.DetermineComponentFrameRoot,"name");i&&i.configurable&&Object.defineProperty(n.DetermineComponentFrameRoot,"name",{value:"DetermineComponentFrameRoot"});var r=n.DetermineComponentFrameRoot(),a=r[0],o=r[1];if(a&&o){var l=a.split("\n"),h=o.split("\n");for(i=n=0;n<l.length&&!l[n].includes("DetermineComponentFrameRoot");)n++;for(;i<h.length&&!h[i].includes("DetermineComponentFrameRoot");)i++;if(n===l.length||i===h.length)for(n=l.length-1,i=h.length-1;1<=n&&0<=i&&l[n]!==h[i];)i--;for(;1<=n&&0<=i;n--,i--)if(l[n]!==h[i]){if(1!==n||1!==i)do{if(n--,0>--i||l[n]!==h[i]){var c="\n"+l[n].replace(" at new "," at ");return t.displayName&&c.includes("<anonymous>")&&(c=c.replace("<anonymous>",t.displayName)),c}}while(1<=n&&0<=i);break}}}finally{Q=!1,Error.prepareStackTrace=s}return(s=t?t.displayName||t.name:"")?Y(s):""}function J(t,e){switch(t.tag){case 26:case 27:case 5:return Y(t.type);case 16:return Y("Lazy");case 13:return t.child!==e&&null!==e?Y("Suspense Fallback"):Y("Suspense");case 19:return Y("SuspenseList");case 0:case 15:return Z(t.type,!1);case 11:return Z(t.type.render,!1);case 1:return Z(t.type,!0);case 31:return Y("Activity");default:return""}}function tt(t){try{var e="",s=null;do{e+=J(t,s),s=t,t=t.return}while(t);return e}catch(t){return"\nError generating stack: "+t.message+"\n"+t.stack}}var et=Object.prototype.hasOwnProperty,st=t.unstable_scheduleCallback,nt=t.unstable_cancelCallback,it=t.unstable_shouldYield,rt=t.unstable_requestPaint,at=t.unstable_now,ot=t.unstable_getCurrentPriorityLevel,lt=t.unstable_ImmediatePriority,ht=t.unstable_UserBlockingPriority,ct=t.unstable_NormalPriority,dt=t.unstable_LowPriority,ut=t.unstable_IdlePriority,ft=t.log,pt=t.unstable_setDisableYieldValue,mt=null,gt=null;function _t(t){if("function"==typeof ft&&pt(t),gt&&"function"==typeof gt.setStrictMode)try{gt.setStrictMode(mt,t)}catch(t){}}var vt=Math.clz32?Math.clz32:function(t){return t>>>=0,0===t?32:31-(yt(t)/bt|0)|0},yt=Math.log,bt=Math.LN2;var St=256,xt=262144,wt=4194304;function Tt(t){var e=42&t;if(0!==e)return e;switch(t&-t){case 1:return 1;case 2:return 2;case 4:return 4;case 8:return 8;case 16:return 16;case 32:return 32;case 64:return 64;case 128:return 128;case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:return 261888&t;case 262144:case 524288:case 1048576:case 2097152:return 3932160&t;case 4194304:case 8388608:case 16777216:case 33554432:return 62914560&t;case 67108864:return 67108864;case 134217728:return 134217728;case 268435456:return 268435456;case 536870912:return 536870912;case 1073741824:return 0;default:return t}}function Ct(t,e,s){var n=t.pendingLanes;if(0===n)return 0;var i=0,r=t.suspendedLanes,a=t.pingedLanes;t=t.warmLanes;var o=134217727&n;return 0!==o?0!==(n=o&~r)?i=Tt(n):0!==(a&=o)?i=Tt(a):s||0!==(s=o&~t)&&(i=Tt(s)):0!==(o=n&~r)?i=Tt(o):0!==a?i=Tt(a):s||0!==(s=n&~t)&&(i=Tt(s)),0===i?0:0!==e&&e!==i&&0===(e&r)&&((r=i&-i)>=(s=e&-e)||32===r&&4194048&s)?e:i}function Et(t,e){return 0===(t.pendingLanes&~(t.suspendedLanes&~t.pingedLanes)&e)}function At(t,e){switch(t){case 1:case 2:case 4:case 8:case 64:return e+250;case 16:case 32:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return e+5e3;default:return-1}}function Dt(){var t=wt;return!(62914560&(wt<<=1))&&(wt=4194304),t}function Pt(t){for(var e=[],s=0;31>s;s++)e.push(t);return e}function Lt(t,e){t.pendingLanes|=e,268435456!==e&&(t.suspendedLanes=0,t.pingedLanes=0,t.warmLanes=0)}function It(t,e,s){t.pendingLanes|=e,t.suspendedLanes&=~e;var n=31-vt(e);t.entangledLanes|=e,t.entanglements[n]=1073741824|t.entanglements[n]|261930&s}function Rt(t,e){var s=t.entangledLanes|=e;for(t=t.entanglements;s;){var n=31-vt(s),i=1<<n;i&e|t[n]&e&&(t[n]|=e),s&=~i}}function Mt(t,e){var s=e&-e;return 0!==((s=42&s?1:kt(s))&(t.suspendedLanes|e))?0:s}function kt(t){switch(t){case 2:t=1;break;case 8:t=4;break;case 32:t=16;break;case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:case 4194304:case 8388608:case 16777216:case 33554432:t=128;break;case 268435456:t=134217728;break;default:t=0}return t}function Ot(t){return 2<(t&=-t)?8<t?134217727&t?32:268435456:8:2}function Ft(){var t=M.p;return 0!==t?t:void 0===(t=window.event)?32:Tu(t.type)}function Nt(t,e){var s=M.p;try{return M.p=t,e()}finally{M.p=s}}var Bt=Math.random().toString(36).slice(2),zt="__reactFiber$"+Bt,Ut="__reactProps$"+Bt,Vt="__reactContainer$"+Bt,Ht="__reactEvents$"+Bt,Gt="__reactListeners$"+Bt,Wt="__reactHandles$"+Bt,jt="__reactResources$"+Bt,$t="__reactMarker$"+Bt;function Xt(t){delete t[zt],delete t[Ut],delete t[Ht],delete t[Gt],delete t[Wt]}function qt(t){var e=t[zt];if(e)return e;for(var s=t.parentNode;s;){if(e=s[Vt]||s[zt]){if(s=e.alternate,null!==e.child||null!==s&&null!==s.child)for(t=kd(t);null!==t;){if(s=t[zt])return s;t=kd(t)}return e}s=(t=s).parentNode}return null}function Kt(t){if(t=t[zt]||t[Vt]){var e=t.tag;if(5===e||6===e||13===e||31===e||26===e||27===e||3===e)return t}return null}function Yt(t){var e=t.tag;if(5===e||26===e||27===e||6===e)return t.stateNode;throw Error(n(33))}function Qt(t){var e=t[jt];return e||(e=t[jt]={hoistableStyles:new Map,hoistableScripts:new Map}),e}function Zt(t){t[$t]=!0}var Jt=new Set,te={};function ee(t,e){se(t,e),se(t+"Capture",e)}function se(t,e){for(te[t]=e,t=0;t<e.length;t++)Jt.add(e[t])}var ne=RegExp("^[:A-Z_a-z\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD][:A-Z_a-z\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD\\-.0-9\\u00B7\\u0300-\\u036F\\u203F-\\u2040]*$"),ie={},re={};function ae(t,e,s){if(i=e,et.call(re,i)||!et.call(ie,i)&&(ne.test(i)?re[i]=!0:(ie[i]=!0,0)))if(null===s)t.removeAttribute(e);else{switch(typeof s){case"undefined":case"function":case"symbol":return void t.removeAttribute(e);case"boolean":var n=e.toLowerCase().slice(0,5);if("data-"!==n&&"aria-"!==n)return void t.removeAttribute(e)}t.setAttribute(e,""+s)}var i}function oe(t,e,s){if(null===s)t.removeAttribute(e);else{switch(typeof s){case"undefined":case"function":case"symbol":case"boolean":return void t.removeAttribute(e)}t.setAttribute(e,""+s)}}function le(t,e,s,n){if(null===n)t.removeAttribute(s);else{switch(typeof n){case"undefined":case"function":case"symbol":case"boolean":return void t.removeAttribute(s)}t.setAttributeNS(e,s,""+n)}}function he(t){switch(typeof t){case"bigint":case"boolean":case"number":case"string":case"undefined":case"object":return t;default:return""}}function ce(t){var e=t.type;return(t=t.nodeName)&&"input"===t.toLowerCase()&&("checkbox"===e||"radio"===e)}function de(t){if(!t._valueTracker){var e=ce(t)?"checked":"value";t._valueTracker=function(t,e,s){var n=Object.getOwnPropertyDescriptor(t.constructor.prototype,e);if(!t.hasOwnProperty(e)&&void 0!==n&&"function"==typeof n.get&&"function"==typeof n.set){var i=n.get,r=n.set;return Object.defineProperty(t,e,{configurable:!0,get:function(){return i.call(this)},set:function(t){s=""+t,r.call(this,t)}}),Object.defineProperty(t,e,{enumerable:n.enumerable}),{getValue:function(){return s},setValue:function(t){s=""+t},stopTracking:function(){t._valueTracker=null,delete t[e]}}}}(t,e,""+t[e])}}function ue(t){if(!t)return!1;var e=t._valueTracker;if(!e)return!0;var s=e.getValue(),n="";return t&&(n=ce(t)?t.checked?"true":"false":t.value),(t=n)!==s&&(e.setValue(t),!0)}function fe(t){if(void 0===(t=t||("undefined"!=typeof document?document:void 0)))return null;try{return t.activeElement||t.body}catch(e){return t.body}}var pe=/[\n"\\]/g;function me(t){return t.replace(pe,function(t){return"\\"+t.charCodeAt(0).toString(16)+" "})}function ge(t,e,s,n,i,r,a,o){t.name="",null!=a&&"function"!=typeof a&&"symbol"!=typeof a&&"boolean"!=typeof a?t.type=a:t.removeAttribute("type"),null!=e?"number"===a?(0===e&&""===t.value||t.value!=e)&&(t.value=""+he(e)):t.value!==""+he(e)&&(t.value=""+he(e)):"submit"!==a&&"reset"!==a||t.removeAttribute("value"),null!=e?ve(t,a,he(e)):null!=s?ve(t,a,he(s)):null!=n&&t.removeAttribute("value"),null==i&&null!=r&&(t.defaultChecked=!!r),null!=i&&(t.checked=i&&"function"!=typeof i&&"symbol"!=typeof i),null!=o&&"function"!=typeof o&&"symbol"!=typeof o&&"boolean"!=typeof o?t.name=""+he(o):t.removeAttribute("name")}function _e(t,e,s,n,i,r,a,o){if(null!=r&&"function"!=typeof r&&"symbol"!=typeof r&&"boolean"!=typeof r&&(t.type=r),null!=e||null!=s){if(("submit"===r||"reset"===r)&&null==e)return void de(t);s=null!=s?""+he(s):"",e=null!=e?""+he(e):s,o||e===t.value||(t.value=e),t.defaultValue=e}n="function"!=typeof(n=null!=n?n:i)&&"symbol"!=typeof n&&!!n,t.checked=o?t.checked:!!n,t.defaultChecked=!!n,null!=a&&"function"!=typeof a&&"symbol"!=typeof a&&"boolean"!=typeof a&&(t.name=a),de(t)}function ve(t,e,s){"number"===e&&fe(t.ownerDocument)===t||t.defaultValue===""+s||(t.defaultValue=""+s)}function ye(t,e,s,n){if(t=t.options,e){e={};for(var i=0;i<s.length;i++)e["$"+s[i]]=!0;for(s=0;s<t.length;s++)i=e.hasOwnProperty("$"+t[s].value),t[s].selected!==i&&(t[s].selected=i),i&&n&&(t[s].defaultSelected=!0)}else{for(s=""+he(s),e=null,i=0;i<t.length;i++){if(t[i].value===s)return t[i].selected=!0,void(n&&(t[i].defaultSelected=!0));null!==e||t[i].disabled||(e=t[i])}null!==e&&(e.selected=!0)}}function be(t,e,s){null==e||((e=""+he(e))!==t.value&&(t.value=e),null!=s)?t.defaultValue=null!=s?""+he(s):"":t.defaultValue!==e&&(t.defaultValue=e)}function Se(t,e,s,i){if(null==e){if(null!=i){if(null!=s)throw Error(n(92));if(I(i)){if(1<i.length)throw Error(n(93));i=i[0]}s=i}null==s&&(s=""),e=s}s=he(e),t.defaultValue=s,(i=t.textContent)===s&&""!==i&&null!==i&&(t.value=i),de(t)}function xe(t,e){if(e){var s=t.firstChild;if(s&&s===t.lastChild&&3===s.nodeType)return void(s.nodeValue=e)}t.textContent=e}var we=new Set("animationIterationCount aspectRatio borderImageOutset borderImageSlice borderImageWidth boxFlex boxFlexGroup boxOrdinalGroup columnCount columns flex flexGrow flexPositive flexShrink flexNegative flexOrder gridArea gridRow gridRowEnd gridRowSpan gridRowStart gridColumn gridColumnEnd gridColumnSpan gridColumnStart fontWeight lineClamp lineHeight opacity order orphans scale tabSize widows zIndex zoom fillOpacity floodOpacity stopOpacity strokeDasharray strokeDashoffset strokeMiterlimit strokeOpacity strokeWidth MozAnimationIterationCount MozBoxFlex MozBoxFlexGroup MozLineClamp msAnimationIterationCount msFlex msZoom msFlexGrow msFlexNegative msFlexOrder msFlexPositive msFlexShrink msGridColumn msGridColumnSpan msGridRow msGridRowSpan WebkitAnimationIterationCount WebkitBoxFlex WebKitBoxFlexGroup WebkitBoxOrdinalGroup WebkitColumnCount WebkitColumns WebkitFlex WebkitFlexGrow WebkitFlexPositive WebkitFlexShrink WebkitLineClamp".split(" "));function Te(t,e,s){var n=0===e.indexOf("--");null==s||"boolean"==typeof s||""===s?n?t.setProperty(e,""):"float"===e?t.cssFloat="":t[e]="":n?t.setProperty(e,s):"number"!=typeof s||0===s||we.has(e)?"float"===e?t.cssFloat=s:t[e]=(""+s).trim():t[e]=s+"px"}function Ce(t,e,s){if(null!=e&&"object"!=typeof e)throw Error(n(62));if(t=t.style,null!=s){for(var i in s)!s.hasOwnProperty(i)||null!=e&&e.hasOwnProperty(i)||(0===i.indexOf("--")?t.setProperty(i,""):"float"===i?t.cssFloat="":t[i]="");for(var r in e)i=e[r],e.hasOwnProperty(r)&&s[r]!==i&&Te(t,r,i)}else for(var a in e)e.hasOwnProperty(a)&&Te(t,a,e[a])}function Ee(t){if(-1===t.indexOf("-"))return!1;switch(t){case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":return!1;default:return!0}}var Ae=new Map([["acceptCharset","accept-charset"],["htmlFor","for"],["httpEquiv","http-equiv"],["crossOrigin","crossorigin"],["accentHeight","accent-height"],["alignmentBaseline","alignment-baseline"],["arabicForm","arabic-form"],["baselineShift","baseline-shift"],["capHeight","cap-height"],["clipPath","clip-path"],["clipRule","clip-rule"],["colorInterpolation","color-interpolation"],["colorInterpolationFilters","color-interpolation-filters"],["colorProfile","color-profile"],["colorRendering","color-rendering"],["dominantBaseline","dominant-baseline"],["enableBackground","enable-background"],["fillOpacity","fill-opacity"],["fillRule","fill-rule"],["floodColor","flood-color"],["floodOpacity","flood-opacity"],["fontFamily","font-family"],["fontSize","font-size"],["fontSizeAdjust","font-size-adjust"],["fontStretch","font-stretch"],["fontStyle","font-style"],["fontVariant","font-variant"],["fontWeight","font-weight"],["glyphName","glyph-name"],["glyphOrientationHorizontal","glyph-orientation-horizontal"],["glyphOrientationVertical","glyph-orientation-vertical"],["horizAdvX","horiz-adv-x"],["horizOriginX","horiz-origin-x"],["imageRendering","image-rendering"],["letterSpacing","letter-spacing"],["lightingColor","lighting-color"],["markerEnd","marker-end"],["markerMid","marker-mid"],["markerStart","marker-start"],["overlinePosition","overline-position"],["overlineThickness","overline-thickness"],["paintOrder","paint-order"],["panose-1","panose-1"],["pointerEvents","pointer-events"],["renderingIntent","rendering-intent"],["shapeRendering","shape-rendering"],["stopColor","stop-color"],["stopOpacity","stop-opacity"],["strikethroughPosition","strikethrough-position"],["strikethroughThickness","strikethrough-thickness"],["strokeDasharray","stroke-dasharray"],["strokeDashoffset","stroke-dashoffset"],["strokeLinecap","stroke-linecap"],["strokeLinejoin","stroke-linejoin"],["strokeMiterlimit","stroke-miterlimit"],["strokeOpacity","stroke-opacity"],["strokeWidth","stroke-width"],["textAnchor","text-anchor"],["textDecoration","text-decoration"],["textRendering","text-rendering"],["transformOrigin","transform-origin"],["underlinePosition","underline-position"],["underlineThickness","underline-thickness"],["unicodeBidi","unicode-bidi"],["unicodeRange","unicode-range"],["unitsPerEm","units-per-em"],["vAlphabetic","v-alphabetic"],["vHanging","v-hanging"],["vIdeographic","v-ideographic"],["vMathematical","v-mathematical"],["vectorEffect","vector-effect"],["vertAdvY","vert-adv-y"],["vertOriginX","vert-origin-x"],["vertOriginY","vert-origin-y"],["wordSpacing","word-spacing"],["writingMode","writing-mode"],["xmlnsXlink","xmlns:xlink"],["xHeight","x-height"]]),De=/^[\u0000-\u001F ]*j[\r\n\t]*a[\r\n\t]*v[\r\n\t]*a[\r\n\t]*s[\r\n\t]*c[\r\n\t]*r[\r\n\t]*i[\r\n\t]*p[\r\n\t]*t[\r\n\t]*:/i;function Pe(t){return De.test(""+t)?"javascript:throw new Error('React has blocked a javascript: URL as a security precaution.')":t}function Le(){}var Ie=null;function Re(t){return(t=t.target||t.srcElement||window).correspondingUseElement&&(t=t.correspondingUseElement),3===t.nodeType?t.parentNode:t}var Me=null,ke=null;function Oe(t){var e=Kt(t);if(e&&(t=e.stateNode)){var s=t[Ut]||null;t:switch(t=e.stateNode,e.type){case"input":if(ge(t,s.value,s.defaultValue,s.defaultValue,s.checked,s.defaultChecked,s.type,s.name),e=s.name,"radio"===s.type&&null!=e){for(s=t;s.parentNode;)s=s.parentNode;for(s=s.querySelectorAll('input[name="'+me(""+e)+'"][type="radio"]'),e=0;e<s.length;e++){var i=s[e];if(i!==t&&i.form===t.form){var r=i[Ut]||null;if(!r)throw Error(n(90));ge(i,r.value,r.defaultValue,r.defaultValue,r.checked,r.defaultChecked,r.type,r.name)}}for(e=0;e<s.length;e++)(i=s[e]).form===t.form&&ue(i)}break t;case"textarea":be(t,s.value,s.defaultValue);break t;case"select":null!=(e=s.value)&&ye(t,!!s.multiple,e,!1)}}}var Fe=!1;function Ne(t,e,s){if(Fe)return t(e,s);Fe=!0;try{return t(e)}finally{if(Fe=!1,(null!==Me||null!==ke)&&(Qh(),Me&&(e=Me,t=ke,ke=Me=null,Oe(e),t)))for(e=0;e<t.length;e++)Oe(t[e])}}function Be(t,e){var s=t.stateNode;if(null===s)return null;var i=s[Ut]||null;if(null===i)return null;s=i[e];t:switch(e){case"onClick":case"onClickCapture":case"onDoubleClick":case"onDoubleClickCapture":case"onMouseDown":case"onMouseDownCapture":case"onMouseMove":case"onMouseMoveCapture":case"onMouseUp":case"onMouseUpCapture":case"onMouseEnter":(i=!i.disabled)||(i=!("button"===(t=t.type)||"input"===t||"select"===t||"textarea"===t)),t=!i;break t;default:t=!1}if(t)return null;if(s&&"function"!=typeof s)throw Error(n(231,e,typeof s));return s}var ze=!("undefined"==typeof window||void 0===window.document||void 0===window.document.createElement),Ue=!1;if(ze)try{var Ve={};Object.defineProperty(Ve,"passive",{get:function(){Ue=!0}}),window.addEventListener("test",Ve,Ve),window.removeEventListener("test",Ve,Ve)}catch(t){Ue=!1}var He=null,Ge=null,We=null;function je(){if(We)return We;var t,e,s=Ge,n=s.length,i="value"in He?He.value:He.textContent,r=i.length;for(t=0;t<n&&s[t]===i[t];t++);var a=n-t;for(e=1;e<=a&&s[n-e]===i[r-e];e++);return We=i.slice(t,1<e?1-e:void 0)}function $e(t){var e=t.keyCode;return"charCode"in t?0===(t=t.charCode)&&13===e&&(t=13):t=e,10===t&&(t=13),32<=t||13===t?t:0}function Xe(){return!0}function qe(){return!1}function Ke(t){function e(e,s,n,i,r){for(var a in this._reactName=e,this._targetInst=n,this.type=s,this.nativeEvent=i,this.target=r,this.currentTarget=null,t)t.hasOwnProperty(a)&&(e=t[a],this[a]=e?e(i):i[a]);return this.isDefaultPrevented=(null!=i.defaultPrevented?i.defaultPrevented:!1===i.returnValue)?Xe:qe,this.isPropagationStopped=qe,this}return d(e.prototype,{preventDefault:function(){this.defaultPrevented=!0;var t=this.nativeEvent;t&&(t.preventDefault?t.preventDefault():"unknown"!=typeof t.returnValue&&(t.returnValue=!1),this.isDefaultPrevented=Xe)},stopPropagation:function(){var t=this.nativeEvent;t&&(t.stopPropagation?t.stopPropagation():"unknown"!=typeof t.cancelBubble&&(t.cancelBubble=!0),this.isPropagationStopped=Xe)},persist:function(){},isPersistent:Xe}),e}var Ye,Qe,Ze,Je={eventPhase:0,bubbles:0,cancelable:0,timeStamp:function(t){return t.timeStamp||Date.now()},defaultPrevented:0,isTrusted:0},ts=Ke(Je),es=d({},Je,{view:0,detail:0}),ss=Ke(es),ns=d({},es,{screenX:0,screenY:0,clientX:0,clientY:0,pageX:0,pageY:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,getModifierState:ps,button:0,buttons:0,relatedTarget:function(t){return void 0===t.relatedTarget?t.fromElement===t.srcElement?t.toElement:t.fromElement:t.relatedTarget},movementX:function(t){return"movementX"in t?t.movementX:(t!==Ze&&(Ze&&"mousemove"===t.type?(Ye=t.screenX-Ze.screenX,Qe=t.screenY-Ze.screenY):Qe=Ye=0,Ze=t),Ye)},movementY:function(t){return"movementY"in t?t.movementY:Qe}}),is=Ke(ns),rs=Ke(d({},ns,{dataTransfer:0})),as=Ke(d({},es,{relatedTarget:0})),os=Ke(d({},Je,{animationName:0,elapsedTime:0,pseudoElement:0})),ls=Ke(d({},Je,{clipboardData:function(t){return"clipboardData"in t?t.clipboardData:window.clipboardData}})),hs=Ke(d({},Je,{data:0})),cs={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},ds={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",224:"Meta"},us={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"};function fs(t){var e=this.nativeEvent;return e.getModifierState?e.getModifierState(t):!!(t=us[t])&&!!e[t]}function ps(){return fs}var ms=Ke(d({},es,{key:function(t){if(t.key){var e=cs[t.key]||t.key;if("Unidentified"!==e)return e}return"keypress"===t.type?13===(t=$e(t))?"Enter":String.fromCharCode(t):"keydown"===t.type||"keyup"===t.type?ds[t.keyCode]||"Unidentified":""},code:0,location:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,repeat:0,locale:0,getModifierState:ps,charCode:function(t){return"keypress"===t.type?$e(t):0},keyCode:function(t){return"keydown"===t.type||"keyup"===t.type?t.keyCode:0},which:function(t){return"keypress"===t.type?$e(t):"keydown"===t.type||"keyup"===t.type?t.keyCode:0}})),gs=Ke(d({},ns,{pointerId:0,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,pointerType:0,isPrimary:0})),_s=Ke(d({},es,{touches:0,targetTouches:0,changedTouches:0,altKey:0,metaKey:0,ctrlKey:0,shiftKey:0,getModifierState:ps})),vs=Ke(d({},Je,{propertyName:0,elapsedTime:0,pseudoElement:0})),ys=Ke(d({},ns,{deltaX:function(t){return"deltaX"in t?t.deltaX:"wheelDeltaX"in t?-t.wheelDeltaX:0},deltaY:function(t){return"deltaY"in t?t.deltaY:"wheelDeltaY"in t?-t.wheelDeltaY:"wheelDelta"in t?-t.wheelDelta:0},deltaZ:0,deltaMode:0})),bs=Ke(d({},Je,{newState:0,oldState:0})),Ss=[9,13,27,32],xs=ze&&"CompositionEvent"in window,ws=null;ze&&"documentMode"in document&&(ws=document.documentMode);var Ts=ze&&"TextEvent"in window&&!ws,Cs=ze&&(!xs||ws&&8<ws&&11>=ws),Es=String.fromCharCode(32),As=!1;function Ds(t,e){switch(t){case"keyup":return-1!==Ss.indexOf(e.keyCode);case"keydown":return 229!==e.keyCode;case"keypress":case"mousedown":case"focusout":return!0;default:return!1}}function Ps(t){return"object"==typeof(t=t.detail)&&"data"in t?t.data:null}var Ls=!1;var Is={color:!0,date:!0,datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0};function Rs(t){var e=t&&t.nodeName&&t.nodeName.toLowerCase();return"input"===e?!!Is[t.type]:"textarea"===e}function Ms(t,e,s,n){Me?ke?ke.push(n):ke=[n]:Me=n,0<(e=ed(e,"onChange")).length&&(s=new ts("onChange","change",null,s,n),t.push({event:s,listeners:e}))}var ks=null,Os=null;function Fs(t){Xc(t,0)}function Ns(t){if(ue(Yt(t)))return t}function Bs(t,e){if("change"===t)return e}var zs=!1;if(ze){var Us;if(ze){var Vs="oninput"in document;if(!Vs){var Hs=document.createElement("div");Hs.setAttribute("oninput","return;"),Vs="function"==typeof Hs.oninput}Us=Vs}else Us=!1;zs=Us&&(!document.documentMode||9<document.documentMode)}function Gs(){ks&&(ks.detachEvent("onpropertychange",Ws),Os=ks=null)}function Ws(t){if("value"===t.propertyName&&Ns(Os)){var e=[];Ms(e,Os,t,Re(t)),Ne(Fs,e)}}function js(t,e,s){"focusin"===t?(Gs(),Os=s,(ks=e).attachEvent("onpropertychange",Ws)):"focusout"===t&&Gs()}function $s(t){if("selectionchange"===t||"keyup"===t||"keydown"===t)return Ns(Os)}function Xs(t,e){if("click"===t)return Ns(e)}function qs(t,e){if("input"===t||"change"===t)return Ns(e)}var Ks="function"==typeof Object.is?Object.is:function(t,e){return t===e&&(0!==t||1/t==1/e)||t!=t&&e!=e};function Ys(t,e){if(Ks(t,e))return!0;if("object"!=typeof t||null===t||"object"!=typeof e||null===e)return!1;var s=Object.keys(t),n=Object.keys(e);if(s.length!==n.length)return!1;for(n=0;n<s.length;n++){var i=s[n];if(!et.call(e,i)||!Ks(t[i],e[i]))return!1}return!0}function Qs(t){for(;t&&t.firstChild;)t=t.firstChild;return t}function Zs(t,e){var s,n=Qs(t);for(t=0;n;){if(3===n.nodeType){if(s=t+n.textContent.length,t<=e&&s>=e)return{node:n,offset:e-t};t=s}t:{for(;n;){if(n.nextSibling){n=n.nextSibling;break t}n=n.parentNode}n=void 0}n=Qs(n)}}function Js(t,e){return!(!t||!e)&&(t===e||(!t||3!==t.nodeType)&&(e&&3===e.nodeType?Js(t,e.parentNode):"contains"in t?t.contains(e):!!t.compareDocumentPosition&&!!(16&t.compareDocumentPosition(e))))}function tn(t){for(var e=fe((t=null!=t&&null!=t.ownerDocument&&null!=t.ownerDocument.defaultView?t.ownerDocument.defaultView:window).document);e instanceof t.HTMLIFrameElement;){try{var s="string"==typeof e.contentWindow.location.href}catch(t){s=!1}if(!s)break;e=fe((t=e.contentWindow).document)}return e}function en(t){var e=t&&t.nodeName&&t.nodeName.toLowerCase();return e&&("input"===e&&("text"===t.type||"search"===t.type||"tel"===t.type||"url"===t.type||"password"===t.type)||"textarea"===e||"true"===t.contentEditable)}var sn=ze&&"documentMode"in document&&11>=document.documentMode,nn=null,rn=null,an=null,on=!1;function ln(t,e,s){var n=s.window===s?s.document:9===s.nodeType?s:s.ownerDocument;on||null==nn||nn!==fe(n)||("selectionStart"in(n=nn)&&en(n)?n={start:n.selectionStart,end:n.selectionEnd}:n={anchorNode:(n=(n.ownerDocument&&n.ownerDocument.defaultView||window).getSelection()).anchorNode,anchorOffset:n.anchorOffset,focusNode:n.focusNode,focusOffset:n.focusOffset},an&&Ys(an,n)||(an=n,0<(n=ed(rn,"onSelect")).length&&(e=new ts("onSelect","select",null,e,s),t.push({event:e,listeners:n}),e.target=nn)))}function hn(t,e){var s={};return s[t.toLowerCase()]=e.toLowerCase(),s["Webkit"+t]="webkit"+e,s["Moz"+t]="moz"+e,s}var cn={animationend:hn("Animation","AnimationEnd"),animationiteration:hn("Animation","AnimationIteration"),animationstart:hn("Animation","AnimationStart"),transitionrun:hn("Transition","TransitionRun"),transitionstart:hn("Transition","TransitionStart"),transitioncancel:hn("Transition","TransitionCancel"),transitionend:hn("Transition","TransitionEnd")},dn={},un={};function fn(t){if(dn[t])return dn[t];if(!cn[t])return t;var e,s=cn[t];for(e in s)if(s.hasOwnProperty(e)&&e in un)return dn[t]=s[e];return t}ze&&(un=document.createElement("div").style,"AnimationEvent"in window||(delete cn.animationend.animation,delete cn.animationiteration.animation,delete cn.animationstart.animation),"TransitionEvent"in window||delete cn.transitionend.transition);var pn=fn("animationend"),mn=fn("animationiteration"),gn=fn("animationstart"),_n=fn("transitionrun"),vn=fn("transitionstart"),yn=fn("transitioncancel"),bn=fn("transitionend"),Sn=new Map,xn="abort auxClick beforeToggle cancel canPlay canPlayThrough click close contextMenu copy cut drag dragEnd dragEnter dragExit dragLeave dragOver dragStart drop durationChange emptied encrypted ended error gotPointerCapture input invalid keyDown keyPress keyUp load loadedData loadedMetadata loadStart lostPointerCapture mouseDown mouseMove mouseOut mouseOver mouseUp paste pause play playing pointerCancel pointerDown pointerMove pointerOut pointerOver pointerUp progress rateChange reset resize seeked seeking stalled submit suspend timeUpdate touchCancel touchEnd touchStart volumeChange scroll toggle touchMove waiting wheel".split(" ");function wn(t,e){Sn.set(t,e),ee(e,[t])}xn.push("scrollEnd");var Tn="function"==typeof reportError?reportError:function(t){if("object"==typeof window&&"function"==typeof window.ErrorEvent){var e=new window.ErrorEvent("error",{bubbles:!0,cancelable:!0,message:"object"==typeof t&&null!==t&&"string"==typeof t.message?String(t.message):String(t),error:t});if(!window.dispatchEvent(e))return}else if("object"==typeof process&&"function"==typeof process.emit)return void process.emit("uncaughtException",t);console.error(t)},Cn=[],En=0,An=0;function Dn(){for(var t=En,e=An=En=0;e<t;){var s=Cn[e];Cn[e++]=null;var n=Cn[e];Cn[e++]=null;var i=Cn[e];Cn[e++]=null;var r=Cn[e];if(Cn[e++]=null,null!==n&&null!==i){var a=n.pending;null===a?i.next=i:(i.next=a.next,a.next=i),n.pending=i}0!==r&&Rn(s,i,r)}}function Pn(t,e,s,n){Cn[En++]=t,Cn[En++]=e,Cn[En++]=s,Cn[En++]=n,An|=n,t.lanes|=n,null!==(t=t.alternate)&&(t.lanes|=n)}function Ln(t,e,s,n){return Pn(t,e,s,n),Mn(t)}function In(t,e){return Pn(t,null,null,e),Mn(t)}function Rn(t,e,s){t.lanes|=s;var n=t.alternate;null!==n&&(n.lanes|=s);for(var i=!1,r=t.return;null!==r;)r.childLanes|=s,null!==(n=r.alternate)&&(n.childLanes|=s),22===r.tag&&(null===(t=r.stateNode)||1&t._visibility||(i=!0)),t=r,r=r.return;return 3===t.tag?(r=t.stateNode,i&&null!==e&&(i=31-vt(s),null===(n=(t=r.hiddenUpdates)[i])?t[i]=[e]:n.push(e),e.lane=536870912|s),r):null}function Mn(t){if(50<Hh)throw Hh=0,Gh=null,Error(n(185));for(var e=t.return;null!==e;)e=(t=e).return;return 3===t.tag?t.stateNode:null}var kn={};function On(t,e,s,n){this.tag=t,this.key=s,this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null,this.index=0,this.refCleanup=this.ref=null,this.pendingProps=e,this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null,this.mode=n,this.subtreeFlags=this.flags=0,this.deletions=null,this.childLanes=this.lanes=0,this.alternate=null}function Fn(t,e,s,n){return new On(t,e,s,n)}function Nn(t){return!(!(t=t.prototype)||!t.isReactComponent)}function Bn(t,e){var s=t.alternate;return null===s?((s=Fn(t.tag,e,t.key,t.mode)).elementType=t.elementType,s.type=t.type,s.stateNode=t.stateNode,s.alternate=t,t.alternate=s):(s.pendingProps=e,s.type=t.type,s.flags=0,s.subtreeFlags=0,s.deletions=null),s.flags=65011712&t.flags,s.childLanes=t.childLanes,s.lanes=t.lanes,s.child=t.child,s.memoizedProps=t.memoizedProps,s.memoizedState=t.memoizedState,s.updateQueue=t.updateQueue,e=t.dependencies,s.dependencies=null===e?null:{lanes:e.lanes,firstContext:e.firstContext},s.sibling=t.sibling,s.index=t.index,s.ref=t.ref,s.refCleanup=t.refCleanup,s}function zn(t,e){t.flags&=65011714;var s=t.alternate;return null===s?(t.childLanes=0,t.lanes=e,t.child=null,t.subtreeFlags=0,t.memoizedProps=null,t.memoizedState=null,t.updateQueue=null,t.dependencies=null,t.stateNode=null):(t.childLanes=s.childLanes,t.lanes=s.lanes,t.child=s.child,t.subtreeFlags=0,t.deletions=null,t.memoizedProps=s.memoizedProps,t.memoizedState=s.memoizedState,t.updateQueue=s.updateQueue,t.type=s.type,e=s.dependencies,t.dependencies=null===e?null:{lanes:e.lanes,firstContext:e.firstContext}),t}function Un(t,e,s,i,r,a){var o=0;if(i=t,"function"==typeof t)Nn(t)&&(o=1);else if("string"==typeof t)o=function(t,e,s){if(1===s||null!=e.itemProp)return!1;switch(t){case"meta":case"title":return!0;case"style":if("string"!=typeof e.precedence||"string"!=typeof e.href||""===e.href)break;return!0;case"link":if("string"!=typeof e.rel||"string"!=typeof e.href||""===e.href||e.onLoad||e.onError)break;return"stylesheet"!==e.rel||(t=e.disabled,"string"==typeof e.precedence&&null==t);case"script":if(e.async&&"function"!=typeof e.async&&"symbol"!=typeof e.async&&!e.onLoad&&!e.onError&&e.src&&"string"==typeof e.src)return!0}return!1}(t,s,H.current)?26:"html"===t||"head"===t||"body"===t?27:5;else t:switch(t){case C:return(t=Fn(31,s,e,r)).elementType=C,t.lanes=a,t;case m:return Vn(s.children,r,a,e);case g:o=8,r|=24;break;case _:return(t=Fn(12,s,e,2|r)).elementType=_,t.lanes=a,t;case S:return(t=Fn(13,s,e,r)).elementType=S,t.lanes=a,t;case x:return(t=Fn(19,s,e,r)).elementType=x,t.lanes=a,t;default:if("object"==typeof t&&null!==t)switch(t.$$typeof){case y:o=10;break t;case v:o=9;break t;case b:o=11;break t;case w:o=14;break t;case T:o=16,i=null;break t}o=29,s=Error(n(130,null===t?"null":typeof t,"")),i=null}return(e=Fn(o,s,e,r)).elementType=t,e.type=i,e.lanes=a,e}function Vn(t,e,s,n){return(t=Fn(7,t,n,e)).lanes=s,t}function Hn(t,e,s){return(t=Fn(6,t,null,e)).lanes=s,t}function Gn(t){var e=Fn(18,null,null,0);return e.stateNode=t,e}function Wn(t,e,s){return(e=Fn(4,null!==t.children?t.children:[],t.key,e)).lanes=s,e.stateNode={containerInfo:t.containerInfo,pendingChildren:null,implementation:t.implementation},e}var jn=new WeakMap;function $n(t,e){if("object"==typeof t&&null!==t){var s=jn.get(t);return void 0!==s?s:(e={value:t,source:e,stack:tt(e)},jn.set(t,e),e)}return{value:t,source:e,stack:tt(e)}}var Xn=[],qn=0,Kn=null,Yn=0,Qn=[],Zn=0,Jn=null,ti=1,ei="";function si(t,e){Xn[qn++]=Yn,Xn[qn++]=Kn,Kn=t,Yn=e}function ni(t,e,s){Qn[Zn++]=ti,Qn[Zn++]=ei,Qn[Zn++]=Jn,Jn=t;var n=ti;t=ei;var i=32-vt(n)-1;n&=~(1<<i),s+=1;var r=32-vt(e)+i;if(30<r){var a=i-i%5;r=(n&(1<<a)-1).toString(32),n>>=a,i-=a,ti=1<<32-vt(e)+i|s<<i|n,ei=r+t}else ti=1<<r|s<<i|n,ei=t}function ii(t){null!==t.return&&(si(t,1),ni(t,1,0))}function ri(t){for(;t===Kn;)Kn=Xn[--qn],Xn[qn]=null,Yn=Xn[--qn],Xn[qn]=null;for(;t===Jn;)Jn=Qn[--Zn],Qn[Zn]=null,ei=Qn[--Zn],Qn[Zn]=null,ti=Qn[--Zn],Qn[Zn]=null}function ai(t,e){Qn[Zn++]=ti,Qn[Zn++]=ei,Qn[Zn++]=Jn,ti=e.id,ei=e.overflow,Jn=t}var oi=null,li=null,hi=!1,ci=null,di=!1,ui=Error(n(519));function fi(t){throw yi($n(Error(n(418,1<arguments.length&&void 0!==arguments[1]&&arguments[1]?"text":"HTML","")),t)),ui}function pi(t){var e=t.stateNode,s=t.type,n=t.memoizedProps;switch(e[zt]=t,e[Ut]=n,s){case"dialog":qc("cancel",e),qc("close",e);break;case"iframe":case"object":case"embed":qc("load",e);break;case"video":case"audio":for(s=0;s<jc.length;s++)qc(jc[s],e);break;case"source":qc("error",e);break;case"img":case"image":case"link":qc("error",e),qc("load",e);break;case"details":qc("toggle",e);break;case"input":qc("invalid",e),_e(e,n.value,n.defaultValue,n.checked,n.defaultChecked,n.type,n.name,!0);break;case"select":qc("invalid",e);break;case"textarea":qc("invalid",e),Se(e,n.value,n.defaultValue,n.children)}"string"!=typeof(s=n.children)&&"number"!=typeof s&&"bigint"!=typeof s||e.textContent===""+s||!0===n.suppressHydrationWarning||od(e.textContent,s)?(null!=n.popover&&(qc("beforetoggle",e),qc("toggle",e)),null!=n.onScroll&&qc("scroll",e),null!=n.onScrollEnd&&qc("scrollend",e),null!=n.onClick&&(e.onclick=Le),e=!0):e=!1,e||fi(t,!0)}function mi(t){for(oi=t.return;oi;)switch(oi.tag){case 5:case 31:case 13:return void(di=!1);case 27:case 3:return void(di=!0);default:oi=oi.return}}function gi(t){if(t!==oi)return!1;if(!hi)return mi(t),hi=!0,!1;var e,s=t.tag;if((e=3!==s&&27!==s)&&((e=5===s)&&(e=!("form"!==(e=t.type)&&"button"!==e)||_d(t.type,t.memoizedProps)),e=!e),e&&li&&fi(t),mi(t),13===s){if(!(t=null!==(t=t.memoizedState)?t.dehydrated:null))throw Error(n(317));li=Md(t)}else if(31===s){if(!(t=null!==(t=t.memoizedState)?t.dehydrated:null))throw Error(n(317));li=Md(t)}else 27===s?(s=li,Td(t.type)?(t=Rd,Rd=null,li=t):li=s):li=oi?Id(t.stateNode.nextSibling):null;return!0}function _i(){li=oi=null,hi=!1}function vi(){var t=ci;return null!==t&&(null===Dh?Dh=t:Dh.push.apply(Dh,t),ci=null),t}function yi(t){null===ci?ci=[t]:ci.push(t)}var bi=N(null),Si=null,xi=null;function wi(t,e,s){z(bi,e._currentValue),e._currentValue=s}function Ti(t){t._currentValue=bi.current,B(bi)}function Ci(t,e,s){for(;null!==t;){var n=t.alternate;if((t.childLanes&e)!==e?(t.childLanes|=e,null!==n&&(n.childLanes|=e)):null!==n&&(n.childLanes&e)!==e&&(n.childLanes|=e),t===s)break;t=t.return}}function Ei(t,e,s,i){var r=t.child;for(null!==r&&(r.return=t);null!==r;){var a=r.dependencies;if(null!==a){var o=r.child;a=a.firstContext;t:for(;null!==a;){var l=a;a=r;for(var h=0;h<e.length;h++)if(l.context===e[h]){a.lanes|=s,null!==(l=a.alternate)&&(l.lanes|=s),Ci(a.return,s,t),i||(o=null);break t}a=l.next}}else if(18===r.tag){if(null===(o=r.return))throw Error(n(341));o.lanes|=s,null!==(a=o.alternate)&&(a.lanes|=s),Ci(o,s,t),o=null}else o=r.child;if(null!==o)o.return=r;else for(o=r;null!==o;){if(o===t){o=null;break}if(null!==(r=o.sibling)){r.return=o.return,o=r;break}o=o.return}r=o}}function Ai(t,e,s,i){t=null;for(var r=e,a=!1;null!==r;){if(!a)if(524288&r.flags)a=!0;else if(262144&r.flags)break;if(10===r.tag){var o=r.alternate;if(null===o)throw Error(n(387));if(null!==(o=o.memoizedProps)){var l=r.type;Ks(r.pendingProps.value,o.value)||(null!==t?t.push(l):t=[l])}}else if(r===j.current){if(null===(o=r.alternate))throw Error(n(387));o.memoizedState.memoizedState!==r.memoizedState.memoizedState&&(null!==t?t.push(lu):t=[lu])}r=r.return}null!==t&&Ei(e,t,s,i),e.flags|=262144}function Di(t){for(t=t.firstContext;null!==t;){if(!Ks(t.context._currentValue,t.memoizedValue))return!0;t=t.next}return!1}function Pi(t){Si=t,xi=null,null!==(t=t.dependencies)&&(t.firstContext=null)}function Li(t){return Ri(Si,t)}function Ii(t,e){return null===Si&&Pi(t),Ri(t,e)}function Ri(t,e){var s=e._currentValue;if(e={context:e,memoizedValue:s,next:null},null===xi){if(null===t)throw Error(n(308));xi=e,t.dependencies={lanes:0,firstContext:e},t.flags|=524288}else xi=xi.next=e;return s}var Mi="undefined"!=typeof AbortController?AbortController:function(){var t=[],e=this.signal={aborted:!1,addEventListener:function(e,s){t.push(s)}};this.abort=function(){e.aborted=!0,t.forEach(function(t){return t()})}},ki=t.unstable_scheduleCallback,Oi=t.unstable_NormalPriority,Fi={$$typeof:y,Consumer:null,Provider:null,_currentValue:null,_currentValue2:null,_threadCount:0};function Ni(){return{controller:new Mi,data:new Map,refCount:0}}function Bi(t){t.refCount--,0===t.refCount&&ki(Oi,function(){t.controller.abort()})}var zi=null,Ui=0,Vi=0,Hi=null;function Gi(){if(0===--Ui&&null!==zi){null!==Hi&&(Hi.status="fulfilled");var t=zi;zi=null,Vi=0,Hi=null;for(var e=0;e<t.length;e++)(0,t[e])()}}var Wi=R.S;R.S=function(t,e){Ih=at(),"object"==typeof e&&null!==e&&"function"==typeof e.then&&function(t,e){if(null===zi){var s=zi=[];Ui=0,Vi=Uc(),Hi={status:"pending",value:void 0,then:function(t){s.push(t)}}}Ui++,e.then(Gi,Gi)}(0,e),null!==Wi&&Wi(t,e)};var ji=N(null);function $i(){var t=ji.current;return null!==t?t:uh.pooledCache}function Xi(t,e){z(ji,null===e?ji.current:e.pool)}function qi(){var t=$i();return null===t?null:{parent:Fi._currentValue,pool:t}}var Ki=Error(n(460)),Yi=Error(n(474)),Qi=Error(n(542)),Zi={then:function(){}};function Ji(t){return"fulfilled"===(t=t.status)||"rejected"===t}function tr(t,e,s){switch(void 0===(s=t[s])?t.push(e):s!==e&&(e.then(Le,Le),e=s),e.status){case"fulfilled":return e.value;case"rejected":throw ir(t=e.reason),t;default:if("string"==typeof e.status)e.then(Le,Le);else{if(null!==(t=uh)&&100<t.shellSuspendCounter)throw Error(n(482));(t=e).status="pending",t.then(function(t){if("pending"===e.status){var s=e;s.status="fulfilled",s.value=t}},function(t){if("pending"===e.status){var s=e;s.status="rejected",s.reason=t}})}switch(e.status){case"fulfilled":return e.value;case"rejected":throw ir(t=e.reason),t}throw sr=e,Ki}}function er(t){try{return(0,t._init)(t._payload)}catch(t){if(null!==t&&"object"==typeof t&&"function"==typeof t.then)throw sr=t,Ki;throw t}}var sr=null;function nr(){if(null===sr)throw Error(n(459));var t=sr;return sr=null,t}function ir(t){if(t===Ki||t===Qi)throw Error(n(483))}var rr=null,ar=0;function or(t){var e=ar;return ar+=1,null===rr&&(rr=[]),tr(rr,t,e)}function lr(t,e){e=e.props.ref,t.ref=void 0!==e?e:null}function hr(t,e){if(e.$$typeof===u)throw Error(n(525));throw t=Object.prototype.toString.call(e),Error(n(31,"[object Object]"===t?"object with keys {"+Object.keys(e).join(", ")+"}":t))}function cr(t){function e(e,s){if(t){var n=e.deletions;null===n?(e.deletions=[s],e.flags|=16):n.push(s)}}function s(s,n){if(!t)return null;for(;null!==n;)e(s,n),n=n.sibling;return null}function i(t){for(var e=new Map;null!==t;)null!==t.key?e.set(t.key,t):e.set(t.index,t),t=t.sibling;return e}function r(t,e){return(t=Bn(t,e)).index=0,t.sibling=null,t}function a(e,s,n){return e.index=n,t?null!==(n=e.alternate)?(n=n.index)<s?(e.flags|=67108866,s):n:(e.flags|=67108866,s):(e.flags|=1048576,s)}function o(e){return t&&null===e.alternate&&(e.flags|=67108866),e}function l(t,e,s,n){return null===e||6!==e.tag?((e=Hn(s,t.mode,n)).return=t,e):((e=r(e,s)).return=t,e)}function h(t,e,s,n){var i=s.type;return i===m?d(t,e,s.props.children,n,s.key):null!==e&&(e.elementType===i||"object"==typeof i&&null!==i&&i.$$typeof===T&&er(i)===e.type)?(lr(e=r(e,s.props),s),e.return=t,e):(lr(e=Un(s.type,s.key,s.props,null,t.mode,n),s),e.return=t,e)}function c(t,e,s,n){return null===e||4!==e.tag||e.stateNode.containerInfo!==s.containerInfo||e.stateNode.implementation!==s.implementation?((e=Wn(s,t.mode,n)).return=t,e):((e=r(e,s.children||[])).return=t,e)}function d(t,e,s,n,i){return null===e||7!==e.tag?((e=Vn(s,t.mode,n,i)).return=t,e):((e=r(e,s)).return=t,e)}function u(t,e,s){if("string"==typeof e&&""!==e||"number"==typeof e||"bigint"==typeof e)return(e=Hn(""+e,t.mode,s)).return=t,e;if("object"==typeof e&&null!==e){switch(e.$$typeof){case f:return lr(s=Un(e.type,e.key,e.props,null,t.mode,s),e),s.return=t,s;case p:return(e=Wn(e,t.mode,s)).return=t,e;case T:return u(t,e=er(e),s)}if(I(e)||D(e))return(e=Vn(e,t.mode,s,null)).return=t,e;if("function"==typeof e.then)return u(t,or(e),s);if(e.$$typeof===y)return u(t,Ii(t,e),s);hr(t,e)}return null}function g(t,e,s,n){var i=null!==e?e.key:null;if("string"==typeof s&&""!==s||"number"==typeof s||"bigint"==typeof s)return null!==i?null:l(t,e,""+s,n);if("object"==typeof s&&null!==s){switch(s.$$typeof){case f:return s.key===i?h(t,e,s,n):null;case p:return s.key===i?c(t,e,s,n):null;case T:return g(t,e,s=er(s),n)}if(I(s)||D(s))return null!==i?null:d(t,e,s,n,null);if("function"==typeof s.then)return g(t,e,or(s),n);if(s.$$typeof===y)return g(t,e,Ii(t,s),n);hr(t,s)}return null}function _(t,e,s,n,i){if("string"==typeof n&&""!==n||"number"==typeof n||"bigint"==typeof n)return l(e,t=t.get(s)||null,""+n,i);if("object"==typeof n&&null!==n){switch(n.$$typeof){case f:return h(e,t=t.get(null===n.key?s:n.key)||null,n,i);case p:return c(e,t=t.get(null===n.key?s:n.key)||null,n,i);case T:return _(t,e,s,n=er(n),i)}if(I(n)||D(n))return d(e,t=t.get(s)||null,n,i,null);if("function"==typeof n.then)return _(t,e,s,or(n),i);if(n.$$typeof===y)return _(t,e,s,Ii(e,n),i);hr(e,n)}return null}function v(l,h,c,d){if("object"==typeof c&&null!==c&&c.type===m&&null===c.key&&(c=c.props.children),"object"==typeof c&&null!==c){switch(c.$$typeof){case f:t:{for(var b=c.key;null!==h;){if(h.key===b){if((b=c.type)===m){if(7===h.tag){s(l,h.sibling),(d=r(h,c.props.children)).return=l,l=d;break t}}else if(h.elementType===b||"object"==typeof b&&null!==b&&b.$$typeof===T&&er(b)===h.type){s(l,h.sibling),lr(d=r(h,c.props),c),d.return=l,l=d;break t}s(l,h);break}e(l,h),h=h.sibling}c.type===m?((d=Vn(c.props.children,l.mode,d,c.key)).return=l,l=d):(lr(d=Un(c.type,c.key,c.props,null,l.mode,d),c),d.return=l,l=d)}return o(l);case p:t:{for(b=c.key;null!==h;){if(h.key===b){if(4===h.tag&&h.stateNode.containerInfo===c.containerInfo&&h.stateNode.implementation===c.implementation){s(l,h.sibling),(d=r(h,c.children||[])).return=l,l=d;break t}s(l,h);break}e(l,h),h=h.sibling}(d=Wn(c,l.mode,d)).return=l,l=d}return o(l);case T:return v(l,h,c=er(c),d)}if(I(c))return function(n,r,o,l){for(var h=null,c=null,d=r,f=r=0,p=null;null!==d&&f<o.length;f++){d.index>f?(p=d,d=null):p=d.sibling;var m=g(n,d,o[f],l);if(null===m){null===d&&(d=p);break}t&&d&&null===m.alternate&&e(n,d),r=a(m,r,f),null===c?h=m:c.sibling=m,c=m,d=p}if(f===o.length)return s(n,d),hi&&si(n,f),h;if(null===d){for(;f<o.length;f++)null!==(d=u(n,o[f],l))&&(r=a(d,r,f),null===c?h=d:c.sibling=d,c=d);return hi&&si(n,f),h}for(d=i(d);f<o.length;f++)null!==(p=_(d,n,f,o[f],l))&&(t&&null!==p.alternate&&d.delete(null===p.key?f:p.key),r=a(p,r,f),null===c?h=p:c.sibling=p,c=p);return t&&d.forEach(function(t){return e(n,t)}),hi&&si(n,f),h}(l,h,c,d);if(D(c)){if("function"!=typeof(b=D(c)))throw Error(n(150));return function(r,o,l,h){if(null==l)throw Error(n(151));for(var c=null,d=null,f=o,p=o=0,m=null,v=l.next();null!==f&&!v.done;p++,v=l.next()){f.index>p?(m=f,f=null):m=f.sibling;var y=g(r,f,v.value,h);if(null===y){null===f&&(f=m);break}t&&f&&null===y.alternate&&e(r,f),o=a(y,o,p),null===d?c=y:d.sibling=y,d=y,f=m}if(v.done)return s(r,f),hi&&si(r,p),c;if(null===f){for(;!v.done;p++,v=l.next())null!==(v=u(r,v.value,h))&&(o=a(v,o,p),null===d?c=v:d.sibling=v,d=v);return hi&&si(r,p),c}for(f=i(f);!v.done;p++,v=l.next())null!==(v=_(f,r,p,v.value,h))&&(t&&null!==v.alternate&&f.delete(null===v.key?p:v.key),o=a(v,o,p),null===d?c=v:d.sibling=v,d=v);return t&&f.forEach(function(t){return e(r,t)}),hi&&si(r,p),c}(l,h,c=b.call(c),d)}if("function"==typeof c.then)return v(l,h,or(c),d);if(c.$$typeof===y)return v(l,h,Ii(l,c),d);hr(l,c)}return"string"==typeof c&&""!==c||"number"==typeof c||"bigint"==typeof c?(c=""+c,null!==h&&6===h.tag?(s(l,h.sibling),(d=r(h,c)).return=l,l=d):(s(l,h),(d=Hn(c,l.mode,d)).return=l,l=d),o(l)):s(l,h)}return function(t,e,s,n){try{ar=0;var i=v(t,e,s,n);return rr=null,i}catch(e){if(e===Ki||e===Qi)throw e;var r=Fn(29,e,null,t.mode);return r.lanes=n,r.return=t,r}}}var dr=cr(!0),ur=cr(!1),fr=!1;function pr(t){t.updateQueue={baseState:t.memoizedState,firstBaseUpdate:null,lastBaseUpdate:null,shared:{pending:null,lanes:0,hiddenCallbacks:null},callbacks:null}}function mr(t,e){t=t.updateQueue,e.updateQueue===t&&(e.updateQueue={baseState:t.baseState,firstBaseUpdate:t.firstBaseUpdate,lastBaseUpdate:t.lastBaseUpdate,shared:t.shared,callbacks:null})}function gr(t){return{lane:t,tag:0,payload:null,callback:null,next:null}}function _r(t,e,s){var n=t.updateQueue;if(null===n)return null;if(n=n.shared,2&dh){var i=n.pending;return null===i?e.next=e:(e.next=i.next,i.next=e),n.pending=e,e=Mn(t),Rn(t,null,s),e}return Pn(t,n,e,s),Mn(t)}function vr(t,e,s){if(null!==(e=e.updateQueue)&&(e=e.shared,4194048&s)){var n=e.lanes;s|=n&=t.pendingLanes,e.lanes=s,Rt(t,s)}}function yr(t,e){var s=t.updateQueue,n=t.alternate;if(null!==n&&s===(n=n.updateQueue)){var i=null,r=null;if(null!==(s=s.firstBaseUpdate)){do{var a={lane:s.lane,tag:s.tag,payload:s.payload,callback:null,next:null};null===r?i=r=a:r=r.next=a,s=s.next}while(null!==s);null===r?i=r=e:r=r.next=e}else i=r=e;return s={baseState:n.baseState,firstBaseUpdate:i,lastBaseUpdate:r,shared:n.shared,callbacks:n.callbacks},void(t.updateQueue=s)}null===(t=s.lastBaseUpdate)?s.firstBaseUpdate=e:t.next=e,s.lastBaseUpdate=e}var br=!1;function Sr(){if(br){if(null!==Hi)throw Hi}}function xr(t,e,s,n){br=!1;var i=t.updateQueue;fr=!1;var r=i.firstBaseUpdate,a=i.lastBaseUpdate,o=i.shared.pending;if(null!==o){i.shared.pending=null;var l=o,h=l.next;l.next=null,null===a?r=h:a.next=h,a=l;var c=t.alternate;null!==c&&((o=(c=c.updateQueue).lastBaseUpdate)!==a&&(null===o?c.firstBaseUpdate=h:o.next=h,c.lastBaseUpdate=l))}if(null!==r){var u=i.baseState;for(a=0,c=h=l=null,o=r;;){var f=-536870913&o.lane,p=f!==o.lane;if(p?(ph&f)===f:(n&f)===f){0!==f&&f===Vi&&(br=!0),null!==c&&(c=c.next={lane:0,tag:o.tag,payload:o.payload,callback:null,next:null});t:{var m=t,g=o;f=e;var _=s;switch(g.tag){case 1:if("function"==typeof(m=g.payload)){u=m.call(_,u,f);break t}u=m;break t;case 3:m.flags=-65537&m.flags|128;case 0:if(null==(f="function"==typeof(m=g.payload)?m.call(_,u,f):m))break t;u=d({},u,f);break t;case 2:fr=!0}}null!==(f=o.callback)&&(t.flags|=64,p&&(t.flags|=8192),null===(p=i.callbacks)?i.callbacks=[f]:p.push(f))}else p={lane:f,tag:o.tag,payload:o.payload,callback:o.callback,next:null},null===c?(h=c=p,l=u):c=c.next=p,a|=f;if(null===(o=o.next)){if(null===(o=i.shared.pending))break;o=(p=o).next,p.next=null,i.lastBaseUpdate=p,i.shared.pending=null}}null===c&&(l=u),i.baseState=l,i.firstBaseUpdate=h,i.lastBaseUpdate=c,null===r&&(i.shared.lanes=0),xh|=a,t.lanes=a,t.memoizedState=u}}function wr(t,e){if("function"!=typeof t)throw Error(n(191,t));t.call(e)}function Tr(t,e){var s=t.callbacks;if(null!==s)for(t.callbacks=null,t=0;t<s.length;t++)wr(s[t],e)}var Cr=N(null),Er=N(0);function Ar(t,e){z(Er,t=bh),z(Cr,e),bh=t|e.baseLanes}function Dr(){z(Er,bh),z(Cr,Cr.current)}function Pr(){bh=Er.current,B(Cr),B(Er)}var Lr=N(null),Ir=null;function Rr(t){var e=t.alternate;z(Nr,1&Nr.current),z(Lr,t),null===Ir&&(null===e||null!==Cr.current||null!==e.memoizedState)&&(Ir=t)}function Mr(t){z(Nr,Nr.current),z(Lr,t),null===Ir&&(Ir=t)}function kr(t){22===t.tag?(z(Nr,Nr.current),z(Lr,t),null===Ir&&(Ir=t)):Or()}function Or(){z(Nr,Nr.current),z(Lr,Lr.current)}function Fr(t){B(Lr),Ir===t&&(Ir=null),B(Nr)}var Nr=N(0);function Br(t){for(var e=t;null!==e;){if(13===e.tag){var s=e.memoizedState;if(null!==s&&(null===(s=s.dehydrated)||Pd(s)||Ld(s)))return e}else if(19!==e.tag||"forwards"!==e.memoizedProps.revealOrder&&"backwards"!==e.memoizedProps.revealOrder&&"unstable_legacy-backwards"!==e.memoizedProps.revealOrder&&"together"!==e.memoizedProps.revealOrder){if(null!==e.child){e.child.return=e,e=e.child;continue}}else if(128&e.flags)return e;if(e===t)break;for(;null===e.sibling;){if(null===e.return||e.return===t)return null;e=e.return}e.sibling.return=e.return,e=e.sibling}return null}var zr=0,Ur=null,Vr=null,Hr=null,Gr=!1,Wr=!1,jr=!1,$r=0,Xr=0,qr=null,Kr=0;function Yr(){throw Error(n(321))}function Qr(t,e){if(null===e)return!1;for(var s=0;s<e.length&&s<t.length;s++)if(!Ks(t[s],e[s]))return!1;return!0}function Zr(t,e,s,n,i,r){return zr=r,Ur=e,e.memoizedState=null,e.updateQueue=null,e.lanes=0,R.H=null===t||null===t.memoizedState?po:mo,jr=!1,r=s(n,i),jr=!1,Wr&&(r=ta(e,s,n,i)),Jr(t),r}function Jr(t){R.H=fo;var e=null!==Vr&&null!==Vr.next;if(zr=0,Hr=Vr=Ur=null,Gr=!1,Xr=0,qr=null,e)throw Error(n(300));null===t||Io||null!==(t=t.dependencies)&&Di(t)&&(Io=!0)}function ta(t,e,s,i){Ur=t;var r=0;do{if(Wr&&(qr=null),Xr=0,Wr=!1,25<=r)throw Error(n(301));if(r+=1,Hr=Vr=null,null!=t.updateQueue){var a=t.updateQueue;a.lastEffect=null,a.events=null,a.stores=null,null!=a.memoCache&&(a.memoCache.index=0)}R.H=go,a=e(s,i)}while(Wr);return a}function ea(){var t=R.H,e=t.useState()[0];return e="function"==typeof e.then?oa(e):e,t=t.useState()[0],(null!==Vr?Vr.memoizedState:null)!==t&&(Ur.flags|=1024),e}function sa(){var t=0!==$r;return $r=0,t}function na(t,e,s){e.updateQueue=t.updateQueue,e.flags&=-2053,t.lanes&=~s}function ia(t){if(Gr){for(t=t.memoizedState;null!==t;){var e=t.queue;null!==e&&(e.pending=null),t=t.next}Gr=!1}zr=0,Hr=Vr=Ur=null,Wr=!1,Xr=$r=0,qr=null}function ra(){var t={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};return null===Hr?Ur.memoizedState=Hr=t:Hr=Hr.next=t,Hr}function aa(){if(null===Vr){var t=Ur.alternate;t=null!==t?t.memoizedState:null}else t=Vr.next;var e=null===Hr?Ur.memoizedState:Hr.next;if(null!==e)Hr=e,Vr=t;else{if(null===t){if(null===Ur.alternate)throw Error(n(467));throw Error(n(310))}t={memoizedState:(Vr=t).memoizedState,baseState:Vr.baseState,baseQueue:Vr.baseQueue,queue:Vr.queue,next:null},null===Hr?Ur.memoizedState=Hr=t:Hr=Hr.next=t}return Hr}function oa(t){var e=Xr;return Xr+=1,null===qr&&(qr=[]),t=tr(qr,t,e),e=Ur,null===(null===Hr?e.memoizedState:Hr.next)&&(e=e.alternate,R.H=null===e||null===e.memoizedState?po:mo),t}function la(t){if(null!==t&&"object"==typeof t){if("function"==typeof t.then)return oa(t);if(t.$$typeof===y)return Li(t)}throw Error(n(438,String(t)))}function ha(t){var e=null,s=Ur.updateQueue;if(null!==s&&(e=s.memoCache),null==e){var n=Ur.alternate;null!==n&&(null!==(n=n.updateQueue)&&(null!=(n=n.memoCache)&&(e={data:n.data.map(function(t){return t.slice()}),index:0})))}if(null==e&&(e={data:[],index:0}),null===s&&(s={lastEffect:null,events:null,stores:null,memoCache:null},Ur.updateQueue=s),s.memoCache=e,void 0===(s=e.data[e.index]))for(s=e.data[e.index]=Array(t),n=0;n<t;n++)s[n]=E;return e.index++,s}function ca(t,e){return"function"==typeof e?e(t):e}function da(t){return ua(aa(),Vr,t)}function ua(t,e,s){var i=t.queue;if(null===i)throw Error(n(311));i.lastRenderedReducer=s;var r=t.baseQueue,a=i.pending;if(null!==a){if(null!==r){var o=r.next;r.next=a.next,a.next=o}e.baseQueue=r=a,i.pending=null}if(a=t.baseState,null===r)t.memoizedState=a;else{var l=o=null,h=null,c=e=r.next,d=!1;do{var u=-536870913&c.lane;if(u!==c.lane?(ph&u)===u:(zr&u)===u){var f=c.revertLane;if(0===f)null!==h&&(h=h.next={lane:0,revertLane:0,gesture:null,action:c.action,hasEagerState:c.hasEagerState,eagerState:c.eagerState,next:null}),u===Vi&&(d=!0);else{if((zr&f)===f){c=c.next,f===Vi&&(d=!0);continue}u={lane:0,revertLane:c.revertLane,gesture:null,action:c.action,hasEagerState:c.hasEagerState,eagerState:c.eagerState,next:null},null===h?(l=h=u,o=a):h=h.next=u,Ur.lanes|=f,xh|=f}u=c.action,jr&&s(a,u),a=c.hasEagerState?c.eagerState:s(a,u)}else f={lane:u,revertLane:c.revertLane,gesture:c.gesture,action:c.action,hasEagerState:c.hasEagerState,eagerState:c.eagerState,next:null},null===h?(l=h=f,o=a):h=h.next=f,Ur.lanes|=u,xh|=u;c=c.next}while(null!==c&&c!==e);if(null===h?o=a:h.next=l,!Ks(a,t.memoizedState)&&(Io=!0,d&&null!==(s=Hi)))throw s;t.memoizedState=a,t.baseState=o,t.baseQueue=h,i.lastRenderedState=a}return null===r&&(i.lanes=0),[t.memoizedState,i.dispatch]}function fa(t){var e=aa(),s=e.queue;if(null===s)throw Error(n(311));s.lastRenderedReducer=t;var i=s.dispatch,r=s.pending,a=e.memoizedState;if(null!==r){s.pending=null;var o=r=r.next;do{a=t(a,o.action),o=o.next}while(o!==r);Ks(a,e.memoizedState)||(Io=!0),e.memoizedState=a,null===e.baseQueue&&(e.baseState=a),s.lastRenderedState=a}return[a,i]}function pa(t,e,s){var i=Ur,r=aa(),a=hi;if(a){if(void 0===s)throw Error(n(407));s=s()}else s=e();var o=!Ks((Vr||r).memoizedState,s);if(o&&(r.memoizedState=s,Io=!0),r=r.queue,za(_a.bind(null,i,r,t),[t]),r.getSnapshot!==e||o||null!==Hr&&1&Hr.memoizedState.tag){if(i.flags|=2048,ka(9,{destroy:void 0},ga.bind(null,i,r,s,e),null),null===uh)throw Error(n(349));a||127&zr||ma(i,e,s)}return s}function ma(t,e,s){t.flags|=16384,t={getSnapshot:e,value:s},null===(e=Ur.updateQueue)?(e={lastEffect:null,events:null,stores:null,memoCache:null},Ur.updateQueue=e,e.stores=[t]):null===(s=e.stores)?e.stores=[t]:s.push(t)}function ga(t,e,s,n){e.value=s,e.getSnapshot=n,va(e)&&ya(t)}function _a(t,e,s){return s(function(){va(e)&&ya(t)})}function va(t){var e=t.getSnapshot;t=t.value;try{var s=e();return!Ks(t,s)}catch(t){return!0}}function ya(t){var e=In(t,2);null!==e&&$h(e,t,2)}function ba(t){var e=ra();if("function"==typeof t){var s=t;if(t=s(),jr){_t(!0);try{s()}finally{_t(!1)}}}return e.memoizedState=e.baseState=t,e.queue={pending:null,lanes:0,dispatch:null,lastRenderedReducer:ca,lastRenderedState:t},e}function Sa(t,e,s,n){return t.baseState=s,ua(t,Vr,"function"==typeof n?n:ca)}function xa(t,e,s,i,r){if(ho(t))throw Error(n(485));if(null!==(t=e.action)){var a={payload:r,action:t,next:null,isTransition:!0,status:"pending",value:null,reason:null,listeners:[],then:function(t){a.listeners.push(t)}};null!==R.T?s(!0):a.isTransition=!1,i(a),null===(s=e.pending)?(a.next=e.pending=a,wa(e,a)):(a.next=s.next,e.pending=s.next=a)}}function wa(t,e){var s=e.action,n=e.payload,i=t.state;if(e.isTransition){var r=R.T,a={};R.T=a;try{var o=s(i,n),l=R.S;null!==l&&l(a,o),Ta(t,e,o)}catch(s){Ea(t,e,s)}finally{null!==r&&null!==a.types&&(r.types=a.types),R.T=r}}else try{Ta(t,e,r=s(i,n))}catch(s){Ea(t,e,s)}}function Ta(t,e,s){null!==s&&"object"==typeof s&&"function"==typeof s.then?s.then(function(s){Ca(t,e,s)},function(s){return Ea(t,e,s)}):Ca(t,e,s)}function Ca(t,e,s){e.status="fulfilled",e.value=s,Aa(e),t.state=s,null!==(e=t.pending)&&((s=e.next)===e?t.pending=null:(s=s.next,e.next=s,wa(t,s)))}function Ea(t,e,s){var n=t.pending;if(t.pending=null,null!==n){n=n.next;do{e.status="rejected",e.reason=s,Aa(e),e=e.next}while(e!==n)}t.action=null}function Aa(t){t=t.listeners;for(var e=0;e<t.length;e++)(0,t[e])()}function Da(t,e){return e}function Pa(t,e){if(hi){var s=uh.formState;if(null!==s){t:{var n=Ur;if(hi){if(li){e:{for(var i=li,r=di;8!==i.nodeType;){if(!r){i=null;break e}if(null===(i=Id(i.nextSibling))){i=null;break e}}i="F!"===(r=i.data)||"F"===r?i:null}if(i){li=Id(i.nextSibling),n="F!"===i.data;break t}}fi(n)}n=!1}n&&(e=s[0])}}return(s=ra()).memoizedState=s.baseState=e,n={pending:null,lanes:0,dispatch:null,lastRenderedReducer:Da,lastRenderedState:e},s.queue=n,s=ao.bind(null,Ur,n),n.dispatch=s,n=ba(!1),r=lo.bind(null,Ur,!1,n.queue),i={state:e,dispatch:null,action:t,pending:null},(n=ra()).queue=i,s=xa.bind(null,Ur,i,r,s),i.dispatch=s,n.memoizedState=t,[e,s,!1]}function La(t){return Ia(aa(),Vr,t)}function Ia(t,e,s){if(e=ua(t,e,Da)[0],t=da(ca)[0],"object"==typeof e&&null!==e&&"function"==typeof e.then)try{var n=oa(e)}catch(t){if(t===Ki)throw Qi;throw t}else n=e;var i=(e=aa()).queue,r=i.dispatch;return s!==e.memoizedState&&(Ur.flags|=2048,ka(9,{destroy:void 0},Ra.bind(null,i,s),null)),[n,r,t]}function Ra(t,e){t.action=e}function Ma(t){var e=aa(),s=Vr;if(null!==s)return Ia(e,s,t);aa(),e=e.memoizedState;var n=(s=aa()).queue.dispatch;return s.memoizedState=t,[e,n,!1]}function ka(t,e,s,n){return t={tag:t,create:s,deps:n,inst:e,next:null},null===(e=Ur.updateQueue)&&(e={lastEffect:null,events:null,stores:null,memoCache:null},Ur.updateQueue=e),null===(s=e.lastEffect)?e.lastEffect=t.next=t:(n=s.next,s.next=t,t.next=n,e.lastEffect=t),t}function Oa(){return aa().memoizedState}function Fa(t,e,s,n){var i=ra();Ur.flags|=t,i.memoizedState=ka(1|e,{destroy:void 0},s,void 0===n?null:n)}function Na(t,e,s,n){var i=aa();n=void 0===n?null:n;var r=i.memoizedState.inst;null!==Vr&&null!==n&&Qr(n,Vr.memoizedState.deps)?i.memoizedState=ka(e,r,s,n):(Ur.flags|=t,i.memoizedState=ka(1|e,r,s,n))}function Ba(t,e){Fa(8390656,8,t,e)}function za(t,e){Na(2048,8,t,e)}function Ua(t){var e=aa().memoizedState;return function(t){Ur.flags|=4;var e=Ur.updateQueue;if(null===e)e={lastEffect:null,events:null,stores:null,memoCache:null},Ur.updateQueue=e,e.events=[t];else{var s=e.events;null===s?e.events=[t]:s.push(t)}}({ref:e,nextImpl:t}),function(){if(2&dh)throw Error(n(440));return e.impl.apply(void 0,arguments)}}function Va(t,e){return Na(4,2,t,e)}function Ha(t,e){return Na(4,4,t,e)}function Ga(t,e){if("function"==typeof e){t=t();var s=e(t);return function(){"function"==typeof s?s():e(null)}}if(null!=e)return t=t(),e.current=t,function(){e.current=null}}function Wa(t,e,s){s=null!=s?s.concat([t]):null,Na(4,4,Ga.bind(null,e,t),s)}function ja(){}function $a(t,e){var s=aa();e=void 0===e?null:e;var n=s.memoizedState;return null!==e&&Qr(e,n[1])?n[0]:(s.memoizedState=[t,e],t)}function Xa(t,e){var s=aa();e=void 0===e?null:e;var n=s.memoizedState;if(null!==e&&Qr(e,n[1]))return n[0];if(n=t(),jr){_t(!0);try{t()}finally{_t(!1)}}return s.memoizedState=[n,e],n}function qa(t,e,s){return void 0===s||1073741824&zr&&!(261930&ph)?t.memoizedState=e:(t.memoizedState=s,t=jh(),Ur.lanes|=t,xh|=t,s)}function Ka(t,e,s,n){return Ks(s,e)?s:null!==Cr.current?(t=qa(t,s,n),Ks(t,e)||(Io=!0),t):42&zr&&(!(1073741824&zr)||261930&ph)?(t=jh(),Ur.lanes|=t,xh|=t,e):(Io=!0,t.memoizedState=s)}function Ya(t,e,s,n,i){var r=M.p;M.p=0!==r&&8>r?r:8;var a,o,l,h=R.T,c={};R.T=c,lo(t,!1,e,s);try{var d=i(),u=R.S;if(null!==u&&u(c,d),null!==d&&"object"==typeof d&&"function"==typeof d.then){var f=(a=n,o=[],l={status:"pending",value:null,reason:null,then:function(t){o.push(t)}},d.then(function(){l.status="fulfilled",l.value=a;for(var t=0;t<o.length;t++)(0,o[t])(a)},function(t){for(l.status="rejected",l.reason=t,t=0;t<o.length;t++)(0,o[t])(void 0)}),l);oo(t,e,f,Wh())}else oo(t,e,n,Wh())}catch(s){oo(t,e,{then:function(){},status:"rejected",reason:s},Wh())}finally{M.p=r,null!==h&&null!==c.types&&(h.types=c.types),R.T=h}}function Qa(){}function Za(t,e,s,i){if(5!==t.tag)throw Error(n(476));var r=Ja(t).queue;Ya(t,r,e,k,null===s?Qa:function(){return to(t),s(i)})}function Ja(t){var e=t.memoizedState;if(null!==e)return e;var s={};return(e={memoizedState:k,baseState:k,baseQueue:null,queue:{pending:null,lanes:0,dispatch:null,lastRenderedReducer:ca,lastRenderedState:k},next:null}).next={memoizedState:s,baseState:s,baseQueue:null,queue:{pending:null,lanes:0,dispatch:null,lastRenderedReducer:ca,lastRenderedState:s},next:null},t.memoizedState=e,null!==(t=t.alternate)&&(t.memoizedState=e),e}function to(t){var e=Ja(t);null===e.next&&(e=t.alternate.memoizedState),oo(t,e.next.queue,{},Wh())}function eo(){return Li(lu)}function so(){return aa().memoizedState}function no(){return aa().memoizedState}function io(t){for(var e=t.return;null!==e;){switch(e.tag){case 24:case 3:var s=Wh(),n=_r(e,t=gr(s),s);return null!==n&&($h(n,e,s),vr(n,e,s)),e={cache:Ni()},void(t.payload=e)}e=e.return}}function ro(t,e,s){var n=Wh();s={lane:n,revertLane:0,gesture:null,action:s,hasEagerState:!1,eagerState:null,next:null},ho(t)?co(e,s):null!==(s=Ln(t,e,s,n))&&($h(s,t,n),uo(s,e,n))}function ao(t,e,s){oo(t,e,s,Wh())}function oo(t,e,s,n){var i={lane:n,revertLane:0,gesture:null,action:s,hasEagerState:!1,eagerState:null,next:null};if(ho(t))co(e,i);else{var r=t.alternate;if(0===t.lanes&&(null===r||0===r.lanes)&&null!==(r=e.lastRenderedReducer))try{var a=e.lastRenderedState,o=r(a,s);if(i.hasEagerState=!0,i.eagerState=o,Ks(o,a))return Pn(t,e,i,0),null===uh&&Dn(),!1}catch(t){}if(null!==(s=Ln(t,e,i,n)))return $h(s,t,n),uo(s,e,n),!0}return!1}function lo(t,e,s,i){if(i={lane:2,revertLane:Uc(),gesture:null,action:i,hasEagerState:!1,eagerState:null,next:null},ho(t)){if(e)throw Error(n(479))}else null!==(e=Ln(t,s,i,2))&&$h(e,t,2)}function ho(t){var e=t.alternate;return t===Ur||null!==e&&e===Ur}function co(t,e){Wr=Gr=!0;var s=t.pending;null===s?e.next=e:(e.next=s.next,s.next=e),t.pending=e}function uo(t,e,s){if(4194048&s){var n=e.lanes;s|=n&=t.pendingLanes,e.lanes=s,Rt(t,s)}}var fo={readContext:Li,use:la,useCallback:Yr,useContext:Yr,useEffect:Yr,useImperativeHandle:Yr,useLayoutEffect:Yr,useInsertionEffect:Yr,useMemo:Yr,useReducer:Yr,useRef:Yr,useState:Yr,useDebugValue:Yr,useDeferredValue:Yr,useTransition:Yr,useSyncExternalStore:Yr,useId:Yr,useHostTransitionStatus:Yr,useFormState:Yr,useActionState:Yr,useOptimistic:Yr,useMemoCache:Yr,useCacheRefresh:Yr};fo.useEffectEvent=Yr;var po={readContext:Li,use:la,useCallback:function(t,e){return ra().memoizedState=[t,void 0===e?null:e],t},useContext:Li,useEffect:Ba,useImperativeHandle:function(t,e,s){s=null!=s?s.concat([t]):null,Fa(4194308,4,Ga.bind(null,e,t),s)},useLayoutEffect:function(t,e){return Fa(4194308,4,t,e)},useInsertionEffect:function(t,e){Fa(4,2,t,e)},useMemo:function(t,e){var s=ra();e=void 0===e?null:e;var n=t();if(jr){_t(!0);try{t()}finally{_t(!1)}}return s.memoizedState=[n,e],n},useReducer:function(t,e,s){var n=ra();if(void 0!==s){var i=s(e);if(jr){_t(!0);try{s(e)}finally{_t(!1)}}}else i=e;return n.memoizedState=n.baseState=i,t={pending:null,lanes:0,dispatch:null,lastRenderedReducer:t,lastRenderedState:i},n.queue=t,t=t.dispatch=ro.bind(null,Ur,t),[n.memoizedState,t]},useRef:function(t){return t={current:t},ra().memoizedState=t},useState:function(t){var e=(t=ba(t)).queue,s=ao.bind(null,Ur,e);return e.dispatch=s,[t.memoizedState,s]},useDebugValue:ja,useDeferredValue:function(t,e){return qa(ra(),t,e)},useTransition:function(){var t=ba(!1);return t=Ya.bind(null,Ur,t.queue,!0,!1),ra().memoizedState=t,[!1,t]},useSyncExternalStore:function(t,e,s){var i=Ur,r=ra();if(hi){if(void 0===s)throw Error(n(407));s=s()}else{if(s=e(),null===uh)throw Error(n(349));127&ph||ma(i,e,s)}r.memoizedState=s;var a={value:s,getSnapshot:e};return r.queue=a,Ba(_a.bind(null,i,a,t),[t]),i.flags|=2048,ka(9,{destroy:void 0},ga.bind(null,i,a,s,e),null),s},useId:function(){var t=ra(),e=uh.identifierPrefix;if(hi){var s=ei;e="_"+e+"R_"+(s=(ti&~(1<<32-vt(ti)-1)).toString(32)+s),0<(s=$r++)&&(e+="H"+s.toString(32)),e+="_"}else e="_"+e+"r_"+(s=Kr++).toString(32)+"_";return t.memoizedState=e},useHostTransitionStatus:eo,useFormState:Pa,useActionState:Pa,useOptimistic:function(t){var e=ra();e.memoizedState=e.baseState=t;var s={pending:null,lanes:0,dispatch:null,lastRenderedReducer:null,lastRenderedState:null};return e.queue=s,e=lo.bind(null,Ur,!0,s),s.dispatch=e,[t,e]},useMemoCache:ha,useCacheRefresh:function(){return ra().memoizedState=io.bind(null,Ur)},useEffectEvent:function(t){var e=ra(),s={impl:t};return e.memoizedState=s,function(){if(2&dh)throw Error(n(440));return s.impl.apply(void 0,arguments)}}},mo={readContext:Li,use:la,useCallback:$a,useContext:Li,useEffect:za,useImperativeHandle:Wa,useInsertionEffect:Va,useLayoutEffect:Ha,useMemo:Xa,useReducer:da,useRef:Oa,useState:function(){return da(ca)},useDebugValue:ja,useDeferredValue:function(t,e){return Ka(aa(),Vr.memoizedState,t,e)},useTransition:function(){var t=da(ca)[0],e=aa().memoizedState;return["boolean"==typeof t?t:oa(t),e]},useSyncExternalStore:pa,useId:so,useHostTransitionStatus:eo,useFormState:La,useActionState:La,useOptimistic:function(t,e){return Sa(aa(),0,t,e)},useMemoCache:ha,useCacheRefresh:no};mo.useEffectEvent=Ua;var go={readContext:Li,use:la,useCallback:$a,useContext:Li,useEffect:za,useImperativeHandle:Wa,useInsertionEffect:Va,useLayoutEffect:Ha,useMemo:Xa,useReducer:fa,useRef:Oa,useState:function(){return fa(ca)},useDebugValue:ja,useDeferredValue:function(t,e){var s=aa();return null===Vr?qa(s,t,e):Ka(s,Vr.memoizedState,t,e)},useTransition:function(){var t=fa(ca)[0],e=aa().memoizedState;return["boolean"==typeof t?t:oa(t),e]},useSyncExternalStore:pa,useId:so,useHostTransitionStatus:eo,useFormState:Ma,useActionState:Ma,useOptimistic:function(t,e){var s=aa();return null!==Vr?Sa(s,0,t,e):(s.baseState=t,[t,s.queue.dispatch])},useMemoCache:ha,useCacheRefresh:no};function _o(t,e,s,n){s=null==(s=s(n,e=t.memoizedState))?e:d({},e,s),t.memoizedState=s,0===t.lanes&&(t.updateQueue.baseState=s)}go.useEffectEvent=Ua;var vo={enqueueSetState:function(t,e,s){t=t._reactInternals;var n=Wh(),i=gr(n);i.payload=e,null!=s&&(i.callback=s),null!==(e=_r(t,i,n))&&($h(e,t,n),vr(e,t,n))},enqueueReplaceState:function(t,e,s){t=t._reactInternals;var n=Wh(),i=gr(n);i.tag=1,i.payload=e,null!=s&&(i.callback=s),null!==(e=_r(t,i,n))&&($h(e,t,n),vr(e,t,n))},enqueueForceUpdate:function(t,e){t=t._reactInternals;var s=Wh(),n=gr(s);n.tag=2,null!=e&&(n.callback=e),null!==(e=_r(t,n,s))&&($h(e,t,s),vr(e,t,s))}};function yo(t,e,s,n,i,r,a){return"function"==typeof(t=t.stateNode).shouldComponentUpdate?t.shouldComponentUpdate(n,r,a):!e.prototype||!e.prototype.isPureReactComponent||(!Ys(s,n)||!Ys(i,r))}function bo(t,e,s,n){t=e.state,"function"==typeof e.componentWillReceiveProps&&e.componentWillReceiveProps(s,n),"function"==typeof e.UNSAFE_componentWillReceiveProps&&e.UNSAFE_componentWillReceiveProps(s,n),e.state!==t&&vo.enqueueReplaceState(e,e.state,null)}function So(t,e){var s=e;if("ref"in e)for(var n in s={},e)"ref"!==n&&(s[n]=e[n]);if(t=t.defaultProps)for(var i in s===e&&(s=d({},s)),t)void 0===s[i]&&(s[i]=t[i]);return s}function xo(t){Tn(t)}function wo(t){console.error(t)}function To(t){Tn(t)}function Co(t,e){try{(0,t.onUncaughtError)(e.value,{componentStack:e.stack})}catch(t){setTimeout(function(){throw t})}}function Eo(t,e,s){try{(0,t.onCaughtError)(s.value,{componentStack:s.stack,errorBoundary:1===e.tag?e.stateNode:null})}catch(t){setTimeout(function(){throw t})}}function Ao(t,e,s){return(s=gr(s)).tag=3,s.payload={element:null},s.callback=function(){Co(t,e)},s}function Do(t){return(t=gr(t)).tag=3,t}function Po(t,e,s,n){var i=s.type.getDerivedStateFromError;if("function"==typeof i){var r=n.value;t.payload=function(){return i(r)},t.callback=function(){Eo(e,s,n)}}var a=s.stateNode;null!==a&&"function"==typeof a.componentDidCatch&&(t.callback=function(){Eo(e,s,n),"function"!=typeof i&&(null===kh?kh=new Set([this]):kh.add(this));var t=n.stack;this.componentDidCatch(n.value,{componentStack:null!==t?t:""})})}var Lo=Error(n(461)),Io=!1;function Ro(t,e,s,n){e.child=null===t?ur(e,null,s,n):dr(e,t.child,s,n)}function Mo(t,e,s,n,i){s=s.render;var r=e.ref;if("ref"in n){var a={};for(var o in n)"ref"!==o&&(a[o]=n[o])}else a=n;return Pi(e),n=Zr(t,e,s,a,r,i),o=sa(),null===t||Io?(hi&&o&&ii(e),e.flags|=1,Ro(t,e,n,i),e.child):(na(t,e,i),sl(t,e,i))}function ko(t,e,s,n,i){if(null===t){var r=s.type;return"function"!=typeof r||Nn(r)||void 0!==r.defaultProps||null!==s.compare?((t=Un(s.type,null,n,e,e.mode,i)).ref=e.ref,t.return=e,e.child=t):(e.tag=15,e.type=r,Oo(t,e,r,n,i))}if(r=t.child,!nl(t,i)){var a=r.memoizedProps;if((s=null!==(s=s.compare)?s:Ys)(a,n)&&t.ref===e.ref)return sl(t,e,i)}return e.flags|=1,(t=Bn(r,n)).ref=e.ref,t.return=e,e.child=t}function Oo(t,e,s,n,i){if(null!==t){var r=t.memoizedProps;if(Ys(r,n)&&t.ref===e.ref){if(Io=!1,e.pendingProps=n=r,!nl(t,i))return e.lanes=t.lanes,sl(t,e,i);131072&t.flags&&(Io=!0)}}return Ho(t,e,s,n,i)}function Fo(t,e,s,n){var i=n.children,r=null!==t?t.memoizedState:null;if(null===t&&null===e.stateNode&&(e.stateNode={_visibility:1,_pendingMarkers:null,_retryCache:null,_transitions:null}),"hidden"===n.mode){if(128&e.flags){if(r=null!==r?r.baseLanes|s:s,null!==t){for(n=e.child=t.child,i=0;null!==n;)i=i|n.lanes|n.childLanes,n=n.sibling;n=i&~r}else n=0,e.child=null;return Bo(t,e,r,s,n)}if(!(536870912&s))return n=e.lanes=536870912,Bo(t,e,null!==r?r.baseLanes|s:s,s,n);e.memoizedState={baseLanes:0,cachePool:null},null!==t&&Xi(0,null!==r?r.cachePool:null),null!==r?Ar(e,r):Dr(),kr(e)}else null!==r?(Xi(0,r.cachePool),Ar(e,r),Or(),e.memoizedState=null):(null!==t&&Xi(0,null),Dr(),Or());return Ro(t,e,i,s),e.child}function No(t,e){return null!==t&&22===t.tag||null!==e.stateNode||(e.stateNode={_visibility:1,_pendingMarkers:null,_retryCache:null,_transitions:null}),e.sibling}function Bo(t,e,s,n,i){var r=$i();return r=null===r?null:{parent:Fi._currentValue,pool:r},e.memoizedState={baseLanes:s,cachePool:r},null!==t&&Xi(0,null),Dr(),kr(e),null!==t&&Ai(t,e,n,!0),e.childLanes=i,null}function zo(t,e){return(e=Qo({mode:e.mode,children:e.children},t.mode)).ref=t.ref,t.child=e,e.return=t,e}function Uo(t,e,s){return dr(e,t.child,null,s),(t=zo(e,e.pendingProps)).flags|=2,Fr(e),e.memoizedState=null,t}function Vo(t,e){var s=e.ref;if(null===s)null!==t&&null!==t.ref&&(e.flags|=4194816);else{if("function"!=typeof s&&"object"!=typeof s)throw Error(n(284));null!==t&&t.ref===s||(e.flags|=4194816)}}function Ho(t,e,s,n,i){return Pi(e),s=Zr(t,e,s,n,void 0,i),n=sa(),null===t||Io?(hi&&n&&ii(e),e.flags|=1,Ro(t,e,s,i),e.child):(na(t,e,i),sl(t,e,i))}function Go(t,e,s,n,i,r){return Pi(e),e.updateQueue=null,s=ta(e,n,s,i),Jr(t),n=sa(),null===t||Io?(hi&&n&&ii(e),e.flags|=1,Ro(t,e,s,r),e.child):(na(t,e,r),sl(t,e,r))}function Wo(t,e,s,n,i){if(Pi(e),null===e.stateNode){var r=kn,a=s.contextType;"object"==typeof a&&null!==a&&(r=Li(a)),r=new s(n,r),e.memoizedState=null!==r.state&&void 0!==r.state?r.state:null,r.updater=vo,e.stateNode=r,r._reactInternals=e,(r=e.stateNode).props=n,r.state=e.memoizedState,r.refs={},pr(e),a=s.contextType,r.context="object"==typeof a&&null!==a?Li(a):kn,r.state=e.memoizedState,"function"==typeof(a=s.getDerivedStateFromProps)&&(_o(e,s,a,n),r.state=e.memoizedState),"function"==typeof s.getDerivedStateFromProps||"function"==typeof r.getSnapshotBeforeUpdate||"function"!=typeof r.UNSAFE_componentWillMount&&"function"!=typeof r.componentWillMount||(a=r.state,"function"==typeof r.componentWillMount&&r.componentWillMount(),"function"==typeof r.UNSAFE_componentWillMount&&r.UNSAFE_componentWillMount(),a!==r.state&&vo.enqueueReplaceState(r,r.state,null),xr(e,n,r,i),Sr(),r.state=e.memoizedState),"function"==typeof r.componentDidMount&&(e.flags|=4194308),n=!0}else if(null===t){r=e.stateNode;var o=e.memoizedProps,l=So(s,o);r.props=l;var h=r.context,c=s.contextType;a=kn,"object"==typeof c&&null!==c&&(a=Li(c));var d=s.getDerivedStateFromProps;c="function"==typeof d||"function"==typeof r.getSnapshotBeforeUpdate,o=e.pendingProps!==o,c||"function"!=typeof r.UNSAFE_componentWillReceiveProps&&"function"!=typeof r.componentWillReceiveProps||(o||h!==a)&&bo(e,r,n,a),fr=!1;var u=e.memoizedState;r.state=u,xr(e,n,r,i),Sr(),h=e.memoizedState,o||u!==h||fr?("function"==typeof d&&(_o(e,s,d,n),h=e.memoizedState),(l=fr||yo(e,s,l,n,u,h,a))?(c||"function"!=typeof r.UNSAFE_componentWillMount&&"function"!=typeof r.componentWillMount||("function"==typeof r.componentWillMount&&r.componentWillMount(),"function"==typeof r.UNSAFE_componentWillMount&&r.UNSAFE_componentWillMount()),"function"==typeof r.componentDidMount&&(e.flags|=4194308)):("function"==typeof r.componentDidMount&&(e.flags|=4194308),e.memoizedProps=n,e.memoizedState=h),r.props=n,r.state=h,r.context=a,n=l):("function"==typeof r.componentDidMount&&(e.flags|=4194308),n=!1)}else{r=e.stateNode,mr(t,e),c=So(s,a=e.memoizedProps),r.props=c,d=e.pendingProps,u=r.context,h=s.contextType,l=kn,"object"==typeof h&&null!==h&&(l=Li(h)),(h="function"==typeof(o=s.getDerivedStateFromProps)||"function"==typeof r.getSnapshotBeforeUpdate)||"function"!=typeof r.UNSAFE_componentWillReceiveProps&&"function"!=typeof r.componentWillReceiveProps||(a!==d||u!==l)&&bo(e,r,n,l),fr=!1,u=e.memoizedState,r.state=u,xr(e,n,r,i),Sr();var f=e.memoizedState;a!==d||u!==f||fr||null!==t&&null!==t.dependencies&&Di(t.dependencies)?("function"==typeof o&&(_o(e,s,o,n),f=e.memoizedState),(c=fr||yo(e,s,c,n,u,f,l)||null!==t&&null!==t.dependencies&&Di(t.dependencies))?(h||"function"!=typeof r.UNSAFE_componentWillUpdate&&"function"!=typeof r.componentWillUpdate||("function"==typeof r.componentWillUpdate&&r.componentWillUpdate(n,f,l),"function"==typeof r.UNSAFE_componentWillUpdate&&r.UNSAFE_componentWillUpdate(n,f,l)),"function"==typeof r.componentDidUpdate&&(e.flags|=4),"function"==typeof r.getSnapshotBeforeUpdate&&(e.flags|=1024)):("function"!=typeof r.componentDidUpdate||a===t.memoizedProps&&u===t.memoizedState||(e.flags|=4),"function"!=typeof r.getSnapshotBeforeUpdate||a===t.memoizedProps&&u===t.memoizedState||(e.flags|=1024),e.memoizedProps=n,e.memoizedState=f),r.props=n,r.state=f,r.context=l,n=c):("function"!=typeof r.componentDidUpdate||a===t.memoizedProps&&u===t.memoizedState||(e.flags|=4),"function"!=typeof r.getSnapshotBeforeUpdate||a===t.memoizedProps&&u===t.memoizedState||(e.flags|=1024),n=!1)}return r=n,Vo(t,e),n=!!(128&e.flags),r||n?(r=e.stateNode,s=n&&"function"!=typeof s.getDerivedStateFromError?null:r.render(),e.flags|=1,null!==t&&n?(e.child=dr(e,t.child,null,i),e.child=dr(e,null,s,i)):Ro(t,e,s,i),e.memoizedState=r.state,t=e.child):t=sl(t,e,i),t}function jo(t,e,s,n){return _i(),e.flags|=256,Ro(t,e,s,n),e.child}var $o={dehydrated:null,treeContext:null,retryLane:0,hydrationErrors:null};function Xo(t){return{baseLanes:t,cachePool:qi()}}function qo(t,e,s){return t=null!==t?t.childLanes&~s:0,e&&(t|=Ch),t}function Ko(t,e,s){var i,r=e.pendingProps,a=!1,o=!!(128&e.flags);if((i=o)||(i=(null===t||null!==t.memoizedState)&&!!(2&Nr.current)),i&&(a=!0,e.flags&=-129),i=!!(32&e.flags),e.flags&=-33,null===t){if(hi){if(a?Rr(e):Or(),(t=li)?null!==(t=null!==(t=Dd(t,di))&&"&"!==t.data?t:null)&&(e.memoizedState={dehydrated:t,treeContext:null!==Jn?{id:ti,overflow:ei}:null,retryLane:536870912,hydrationErrors:null},(s=Gn(t)).return=e,e.child=s,oi=e,li=null):t=null,null===t)throw fi(e);return Ld(t)?e.lanes=32:e.lanes=536870912,null}var l=r.children;return r=r.fallback,a?(Or(),l=Qo({mode:"hidden",children:l},a=e.mode),r=Vn(r,a,s,null),l.return=e,r.return=e,l.sibling=r,e.child=l,(r=e.child).memoizedState=Xo(s),r.childLanes=qo(t,i,s),e.memoizedState=$o,No(null,r)):(Rr(e),Yo(e,l))}var h=t.memoizedState;if(null!==h&&null!==(l=h.dehydrated)){if(o)256&e.flags?(Rr(e),e.flags&=-257,e=Zo(t,e,s)):null!==e.memoizedState?(Or(),e.child=t.child,e.flags|=128,e=null):(Or(),l=r.fallback,a=e.mode,r=Qo({mode:"visible",children:r.children},a),(l=Vn(l,a,s,null)).flags|=2,r.return=e,l.return=e,r.sibling=l,e.child=r,dr(e,t.child,null,s),(r=e.child).memoizedState=Xo(s),r.childLanes=qo(t,i,s),e.memoizedState=$o,e=No(null,r));else if(Rr(e),Ld(l)){if(i=l.nextSibling&&l.nextSibling.dataset)var c=i.dgst;i=c,(r=Error(n(419))).stack="",r.digest=i,yi({value:r,source:null,stack:null}),e=Zo(t,e,s)}else if(Io||Ai(t,e,s,!1),i=0!==(s&t.childLanes),Io||i){if(null!==(i=uh)&&(0!==(r=Mt(i,s))&&r!==h.retryLane))throw h.retryLane=r,In(t,r),$h(i,t,r),Lo;Pd(l)||ic(),e=Zo(t,e,s)}else Pd(l)?(e.flags|=192,e.child=t.child,e=null):(t=h.treeContext,li=Id(l.nextSibling),oi=e,hi=!0,ci=null,di=!1,null!==t&&ai(e,t),(e=Yo(e,r.children)).flags|=4096);return e}return a?(Or(),l=r.fallback,a=e.mode,c=(h=t.child).sibling,(r=Bn(h,{mode:"hidden",children:r.children})).subtreeFlags=65011712&h.subtreeFlags,null!==c?l=Bn(c,l):(l=Vn(l,a,s,null)).flags|=2,l.return=e,r.return=e,r.sibling=l,e.child=r,No(null,r),r=e.child,null===(l=t.child.memoizedState)?l=Xo(s):(null!==(a=l.cachePool)?(h=Fi._currentValue,a=a.parent!==h?{parent:h,pool:h}:a):a=qi(),l={baseLanes:l.baseLanes|s,cachePool:a}),r.memoizedState=l,r.childLanes=qo(t,i,s),e.memoizedState=$o,No(t.child,r)):(Rr(e),t=(s=t.child).sibling,(s=Bn(s,{mode:"visible",children:r.children})).return=e,s.sibling=null,null!==t&&(null===(i=e.deletions)?(e.deletions=[t],e.flags|=16):i.push(t)),e.child=s,e.memoizedState=null,s)}function Yo(t,e){return(e=Qo({mode:"visible",children:e},t.mode)).return=t,t.child=e}function Qo(t,e){return(t=Fn(22,t,null,e)).lanes=0,t}function Zo(t,e,s){return dr(e,t.child,null,s),(t=Yo(e,e.pendingProps.children)).flags|=2,e.memoizedState=null,t}function Jo(t,e,s){t.lanes|=e;var n=t.alternate;null!==n&&(n.lanes|=e),Ci(t.return,e,s)}function tl(t,e,s,n,i,r){var a=t.memoizedState;null===a?t.memoizedState={isBackwards:e,rendering:null,renderingStartTime:0,last:n,tail:s,tailMode:i,treeForkCount:r}:(a.isBackwards=e,a.rendering=null,a.renderingStartTime=0,a.last=n,a.tail=s,a.tailMode=i,a.treeForkCount=r)}function el(t,e,s){var n=e.pendingProps,i=n.revealOrder,r=n.tail;n=n.children;var a=Nr.current,o=!!(2&a);if(o?(a=1&a|2,e.flags|=128):a&=1,z(Nr,a),Ro(t,e,n,s),n=hi?Yn:0,!o&&null!==t&&128&t.flags)t:for(t=e.child;null!==t;){if(13===t.tag)null!==t.memoizedState&&Jo(t,s,e);else if(19===t.tag)Jo(t,s,e);else if(null!==t.child){t.child.return=t,t=t.child;continue}if(t===e)break t;for(;null===t.sibling;){if(null===t.return||t.return===e)break t;t=t.return}t.sibling.return=t.return,t=t.sibling}switch(i){case"forwards":for(s=e.child,i=null;null!==s;)null!==(t=s.alternate)&&null===Br(t)&&(i=s),s=s.sibling;null===(s=i)?(i=e.child,e.child=null):(i=s.sibling,s.sibling=null),tl(e,!1,i,s,r,n);break;case"backwards":case"unstable_legacy-backwards":for(s=null,i=e.child,e.child=null;null!==i;){if(null!==(t=i.alternate)&&null===Br(t)){e.child=i;break}t=i.sibling,i.sibling=s,s=i,i=t}tl(e,!0,s,null,r,n);break;case"together":tl(e,!1,null,null,void 0,n);break;default:e.memoizedState=null}return e.child}function sl(t,e,s){if(null!==t&&(e.dependencies=t.dependencies),xh|=e.lanes,0===(s&e.childLanes)){if(null===t)return null;if(Ai(t,e,s,!1),0===(s&e.childLanes))return null}if(null!==t&&e.child!==t.child)throw Error(n(153));if(null!==e.child){for(s=Bn(t=e.child,t.pendingProps),e.child=s,s.return=e;null!==t.sibling;)t=t.sibling,(s=s.sibling=Bn(t,t.pendingProps)).return=e;s.sibling=null}return e.child}function nl(t,e){return 0!==(t.lanes&e)||!(null===(t=t.dependencies)||!Di(t))}function il(t,e,s){if(null!==t)if(t.memoizedProps!==e.pendingProps)Io=!0;else{if(!(nl(t,s)||128&e.flags))return Io=!1,function(t,e,s){switch(e.tag){case 3:$(e,e.stateNode.containerInfo),wi(0,Fi,t.memoizedState.cache),_i();break;case 27:case 5:q(e);break;case 4:$(e,e.stateNode.containerInfo);break;case 10:wi(0,e.type,e.memoizedProps.value);break;case 31:if(null!==e.memoizedState)return e.flags|=128,Mr(e),null;break;case 13:var n=e.memoizedState;if(null!==n)return null!==n.dehydrated?(Rr(e),e.flags|=128,null):0!==(s&e.child.childLanes)?Ko(t,e,s):(Rr(e),null!==(t=sl(t,e,s))?t.sibling:null);Rr(e);break;case 19:var i=!!(128&t.flags);if((n=0!==(s&e.childLanes))||(Ai(t,e,s,!1),n=0!==(s&e.childLanes)),i){if(n)return el(t,e,s);e.flags|=128}if(null!==(i=e.memoizedState)&&(i.rendering=null,i.tail=null,i.lastEffect=null),z(Nr,Nr.current),n)break;return null;case 22:return e.lanes=0,Fo(t,e,s,e.pendingProps);case 24:wi(0,Fi,t.memoizedState.cache)}return sl(t,e,s)}(t,e,s);Io=!!(131072&t.flags)}else Io=!1,hi&&1048576&e.flags&&ni(e,Yn,e.index);switch(e.lanes=0,e.tag){case 16:t:{var i=e.pendingProps;if(t=er(e.elementType),e.type=t,"function"!=typeof t){if(null!=t){var r=t.$$typeof;if(r===b){e.tag=11,e=Mo(null,e,t,i,s);break t}if(r===w){e.tag=14,e=ko(null,e,t,i,s);break t}}throw e=L(t)||t,Error(n(306,e,""))}Nn(t)?(i=So(t,i),e.tag=1,e=Wo(null,e,t,i,s)):(e.tag=0,e=Ho(null,e,t,i,s))}return e;case 0:return Ho(t,e,e.type,e.pendingProps,s);case 1:return Wo(t,e,i=e.type,r=So(i,e.pendingProps),s);case 3:t:{if($(e,e.stateNode.containerInfo),null===t)throw Error(n(387));i=e.pendingProps;var a=e.memoizedState;r=a.element,mr(t,e),xr(e,i,null,s);var o=e.memoizedState;if(i=o.cache,wi(0,Fi,i),i!==a.cache&&Ei(e,[Fi],s,!0),Sr(),i=o.element,a.isDehydrated){if(a={element:i,isDehydrated:!1,cache:o.cache},e.updateQueue.baseState=a,e.memoizedState=a,256&e.flags){e=jo(t,e,i,s);break t}if(i!==r){yi(r=$n(Error(n(424)),e)),e=jo(t,e,i,s);break t}if(9===(t=e.stateNode.containerInfo).nodeType)t=t.body;else t="HTML"===t.nodeName?t.ownerDocument.body:t;for(li=Id(t.firstChild),oi=e,hi=!0,ci=null,di=!0,s=ur(e,null,i,s),e.child=s;s;)s.flags=-3&s.flags|4096,s=s.sibling}else{if(_i(),i===r){e=sl(t,e,s);break t}Ro(t,e,i,s)}e=e.child}return e;case 26:return Vo(t,e),null===t?(s=Gd(e.type,null,e.pendingProps,null))?e.memoizedState=s:hi||(s=e.type,t=e.pendingProps,(i=pd(W.current).createElement(s))[zt]=e,i[Ut]=t,cd(i,s,t),Zt(i),e.stateNode=i):e.memoizedState=Gd(e.type,t.memoizedProps,e.pendingProps,t.memoizedState),null;case 27:return q(e),null===t&&hi&&(i=e.stateNode=Od(e.type,e.pendingProps,W.current),oi=e,di=!0,r=li,Td(e.type)?(Rd=r,li=Id(i.firstChild)):li=r),Ro(t,e,e.pendingProps.children,s),Vo(t,e),null===t&&(e.flags|=4194304),e.child;case 5:return null===t&&hi&&((r=i=li)&&(null!==(i=function(t,e,s,n){for(;1===t.nodeType;){var i=s;if(t.nodeName.toLowerCase()!==e.toLowerCase()){if(!n&&("INPUT"!==t.nodeName||"hidden"!==t.type))break}else if(n){if(!t[$t])switch(e){case"meta":if(!t.hasAttribute("itemprop"))break;return t;case"link":if("stylesheet"===(r=t.getAttribute("rel"))&&t.hasAttribute("data-precedence"))break;if(r!==i.rel||t.getAttribute("href")!==(null==i.href||""===i.href?null:i.href)||t.getAttribute("crossorigin")!==(null==i.crossOrigin?null:i.crossOrigin)||t.getAttribute("title")!==(null==i.title?null:i.title))break;return t;case"style":if(t.hasAttribute("data-precedence"))break;return t;case"script":if(((r=t.getAttribute("src"))!==(null==i.src?null:i.src)||t.getAttribute("type")!==(null==i.type?null:i.type)||t.getAttribute("crossorigin")!==(null==i.crossOrigin?null:i.crossOrigin))&&r&&t.hasAttribute("async")&&!t.hasAttribute("itemprop"))break;return t;default:return t}}else{if("input"!==e||"hidden"!==t.type)return t;var r=null==i.name?null:""+i.name;if("hidden"===i.type&&t.getAttribute("name")===r)return t}if(null===(t=Id(t.nextSibling)))break}return null}(i,e.type,e.pendingProps,di))?(e.stateNode=i,oi=e,li=Id(i.firstChild),di=!1,r=!0):r=!1),r||fi(e)),q(e),r=e.type,a=e.pendingProps,o=null!==t?t.memoizedProps:null,i=a.children,_d(r,a)?i=null:null!==o&&_d(r,o)&&(e.flags|=32),null!==e.memoizedState&&(r=Zr(t,e,ea,null,null,s),lu._currentValue=r),Vo(t,e),Ro(t,e,i,s),e.child;case 6:return null===t&&hi&&((t=s=li)&&(null!==(s=function(t,e,s){if(""===e)return null;for(;3!==t.nodeType;){if((1!==t.nodeType||"INPUT"!==t.nodeName||"hidden"!==t.type)&&!s)return null;if(null===(t=Id(t.nextSibling)))return null}return t}(s,e.pendingProps,di))?(e.stateNode=s,oi=e,li=null,t=!0):t=!1),t||fi(e)),null;case 13:return Ko(t,e,s);case 4:return $(e,e.stateNode.containerInfo),i=e.pendingProps,null===t?e.child=dr(e,null,i,s):Ro(t,e,i,s),e.child;case 11:return Mo(t,e,e.type,e.pendingProps,s);case 7:return Ro(t,e,e.pendingProps,s),e.child;case 8:case 12:return Ro(t,e,e.pendingProps.children,s),e.child;case 10:return i=e.pendingProps,wi(0,e.type,i.value),Ro(t,e,i.children,s),e.child;case 9:return r=e.type._context,i=e.pendingProps.children,Pi(e),i=i(r=Li(r)),e.flags|=1,Ro(t,e,i,s),e.child;case 14:return ko(t,e,e.type,e.pendingProps,s);case 15:return Oo(t,e,e.type,e.pendingProps,s);case 19:return el(t,e,s);case 31:return function(t,e,s){var i=e.pendingProps,r=!!(128&e.flags);if(e.flags&=-129,null===t){if(hi){if("hidden"===i.mode)return t=zo(e,i),e.lanes=536870912,No(null,t);if(Mr(e),(t=li)?null!==(t=null!==(t=Dd(t,di))&&"&"===t.data?t:null)&&(e.memoizedState={dehydrated:t,treeContext:null!==Jn?{id:ti,overflow:ei}:null,retryLane:536870912,hydrationErrors:null},(s=Gn(t)).return=e,e.child=s,oi=e,li=null):t=null,null===t)throw fi(e);return e.lanes=536870912,null}return zo(e,i)}var a=t.memoizedState;if(null!==a){var o=a.dehydrated;if(Mr(e),r)if(256&e.flags)e.flags&=-257,e=Uo(t,e,s);else{if(null===e.memoizedState)throw Error(n(558));e.child=t.child,e.flags|=128,e=null}else if(Io||Ai(t,e,s,!1),r=0!==(s&t.childLanes),Io||r){if(null!==(i=uh)&&0!==(o=Mt(i,s))&&o!==a.retryLane)throw a.retryLane=o,In(t,o),$h(i,t,o),Lo;ic(),e=Uo(t,e,s)}else t=a.treeContext,li=Id(o.nextSibling),oi=e,hi=!0,ci=null,di=!1,null!==t&&ai(e,t),(e=zo(e,i)).flags|=4096;return e}return(t=Bn(t.child,{mode:i.mode,children:i.children})).ref=e.ref,e.child=t,t.return=e,t}(t,e,s);case 22:return Fo(t,e,s,e.pendingProps);case 24:return Pi(e),i=Li(Fi),null===t?(null===(r=$i())&&(r=uh,a=Ni(),r.pooledCache=a,a.refCount++,null!==a&&(r.pooledCacheLanes|=s),r=a),e.memoizedState={parent:i,cache:r},pr(e),wi(0,Fi,r)):(0!==(t.lanes&s)&&(mr(t,e),xr(e,null,null,s),Sr()),r=t.memoizedState,a=e.memoizedState,r.parent!==i?(r={parent:i,cache:i},e.memoizedState=r,0===e.lanes&&(e.memoizedState=e.updateQueue.baseState=r),wi(0,Fi,i)):(i=a.cache,wi(0,Fi,i),i!==r.cache&&Ei(e,[Fi],s,!0))),Ro(t,e,e.pendingProps.children,s),e.child;case 29:throw e.pendingProps}throw Error(n(156,e.tag))}function rl(t){t.flags|=4}function al(t,e,s,n,i){if((e=!!(32&t.mode))&&(e=!1),e){if(t.flags|=16777216,(335544128&i)===i)if(t.stateNode.complete)t.flags|=8192;else{if(!ec())throw sr=Zi,Yi;t.flags|=8192}}else t.flags&=-16777217}function ol(t,e){if("stylesheet"!==e.type||4&e.state.loading)t.flags&=-16777217;else if(t.flags|=16777216,!su(e)){if(!ec())throw sr=Zi,Yi;t.flags|=8192}}function ll(t,e){null!==e&&(t.flags|=4),16384&t.flags&&(e=22!==t.tag?Dt():536870912,t.lanes|=e,Eh|=e)}function hl(t,e){if(!hi)switch(t.tailMode){case"hidden":e=t.tail;for(var s=null;null!==e;)null!==e.alternate&&(s=e),e=e.sibling;null===s?t.tail=null:s.sibling=null;break;case"collapsed":s=t.tail;for(var n=null;null!==s;)null!==s.alternate&&(n=s),s=s.sibling;null===n?e||null===t.tail?t.tail=null:t.tail.sibling=null:n.sibling=null}}function cl(t){var e=null!==t.alternate&&t.alternate.child===t.child,s=0,n=0;if(e)for(var i=t.child;null!==i;)s|=i.lanes|i.childLanes,n|=65011712&i.subtreeFlags,n|=65011712&i.flags,i.return=t,i=i.sibling;else for(i=t.child;null!==i;)s|=i.lanes|i.childLanes,n|=i.subtreeFlags,n|=i.flags,i.return=t,i=i.sibling;return t.subtreeFlags|=n,t.childLanes=s,e}function dl(t,e,s){var i=e.pendingProps;switch(ri(e),e.tag){case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:case 1:return cl(e),null;case 3:return s=e.stateNode,i=null,null!==t&&(i=t.memoizedState.cache),e.memoizedState.cache!==i&&(e.flags|=2048),Ti(Fi),X(),s.pendingContext&&(s.context=s.pendingContext,s.pendingContext=null),null!==t&&null!==t.child||(gi(e)?rl(e):null===t||t.memoizedState.isDehydrated&&!(256&e.flags)||(e.flags|=1024,vi())),cl(e),null;case 26:var r=e.type,a=e.memoizedState;return null===t?(rl(e),null!==a?(cl(e),ol(e,a)):(cl(e),al(e,r,0,0,s))):a?a!==t.memoizedState?(rl(e),cl(e),ol(e,a)):(cl(e),e.flags&=-16777217):((t=t.memoizedProps)!==i&&rl(e),cl(e),al(e,r,0,0,s)),null;case 27:if(K(e),s=W.current,r=e.type,null!==t&&null!=e.stateNode)t.memoizedProps!==i&&rl(e);else{if(!i){if(null===e.stateNode)throw Error(n(166));return cl(e),null}t=H.current,gi(e)?pi(e):(t=Od(r,i,s),e.stateNode=t,rl(e))}return cl(e),null;case 5:if(K(e),r=e.type,null!==t&&null!=e.stateNode)t.memoizedProps!==i&&rl(e);else{if(!i){if(null===e.stateNode)throw Error(n(166));return cl(e),null}if(a=H.current,gi(e))pi(e);else{var o=pd(W.current);switch(a){case 1:a=o.createElementNS("http://www.w3.org/2000/svg",r);break;case 2:a=o.createElementNS("http://www.w3.org/1998/Math/MathML",r);break;default:switch(r){case"svg":a=o.createElementNS("http://www.w3.org/2000/svg",r);break;case"math":a=o.createElementNS("http://www.w3.org/1998/Math/MathML",r);break;case"script":(a=o.createElement("div")).innerHTML="<script><\/script>",a=a.removeChild(a.firstChild);break;case"select":a="string"==typeof i.is?o.createElement("select",{is:i.is}):o.createElement("select"),i.multiple?a.multiple=!0:i.size&&(a.size=i.size);break;default:a="string"==typeof i.is?o.createElement(r,{is:i.is}):o.createElement(r)}}a[zt]=e,a[Ut]=i;t:for(o=e.child;null!==o;){if(5===o.tag||6===o.tag)a.appendChild(o.stateNode);else if(4!==o.tag&&27!==o.tag&&null!==o.child){o.child.return=o,o=o.child;continue}if(o===e)break t;for(;null===o.sibling;){if(null===o.return||o.return===e)break t;o=o.return}o.sibling.return=o.return,o=o.sibling}e.stateNode=a;t:switch(cd(a,r,i),r){case"button":case"input":case"select":case"textarea":i=!!i.autoFocus;break t;case"img":i=!0;break t;default:i=!1}i&&rl(e)}}return cl(e),al(e,e.type,null===t||t.memoizedProps,e.pendingProps,s),null;case 6:if(t&&null!=e.stateNode)t.memoizedProps!==i&&rl(e);else{if("string"!=typeof i&&null===e.stateNode)throw Error(n(166));if(t=W.current,gi(e)){if(t=e.stateNode,s=e.memoizedProps,i=null,null!==(r=oi))switch(r.tag){case 27:case 5:i=r.memoizedProps}t[zt]=e,(t=!!(t.nodeValue===s||null!==i&&!0===i.suppressHydrationWarning||od(t.nodeValue,s)))||fi(e,!0)}else(t=pd(t).createTextNode(i))[zt]=e,e.stateNode=t}return cl(e),null;case 31:if(s=e.memoizedState,null===t||null!==t.memoizedState){if(i=gi(e),null!==s){if(null===t){if(!i)throw Error(n(318));if(!(t=null!==(t=e.memoizedState)?t.dehydrated:null))throw Error(n(557));t[zt]=e}else _i(),!(128&e.flags)&&(e.memoizedState=null),e.flags|=4;cl(e),t=!1}else s=vi(),null!==t&&null!==t.memoizedState&&(t.memoizedState.hydrationErrors=s),t=!0;if(!t)return 256&e.flags?(Fr(e),e):(Fr(e),null);if(128&e.flags)throw Error(n(558))}return cl(e),null;case 13:if(i=e.memoizedState,null===t||null!==t.memoizedState&&null!==t.memoizedState.dehydrated){if(r=gi(e),null!==i&&null!==i.dehydrated){if(null===t){if(!r)throw Error(n(318));if(!(r=null!==(r=e.memoizedState)?r.dehydrated:null))throw Error(n(317));r[zt]=e}else _i(),!(128&e.flags)&&(e.memoizedState=null),e.flags|=4;cl(e),r=!1}else r=vi(),null!==t&&null!==t.memoizedState&&(t.memoizedState.hydrationErrors=r),r=!0;if(!r)return 256&e.flags?(Fr(e),e):(Fr(e),null)}return Fr(e),128&e.flags?(e.lanes=s,e):(s=null!==i,t=null!==t&&null!==t.memoizedState,s&&(r=null,null!==(i=e.child).alternate&&null!==i.alternate.memoizedState&&null!==i.alternate.memoizedState.cachePool&&(r=i.alternate.memoizedState.cachePool.pool),a=null,null!==i.memoizedState&&null!==i.memoizedState.cachePool&&(a=i.memoizedState.cachePool.pool),a!==r&&(i.flags|=2048)),s!==t&&s&&(e.child.flags|=8192),ll(e,e.updateQueue),cl(e),null);case 4:return X(),null===t&&Qc(e.stateNode.containerInfo),cl(e),null;case 10:return Ti(e.type),cl(e),null;case 19:if(B(Nr),null===(i=e.memoizedState))return cl(e),null;if(r=!!(128&e.flags),null===(a=i.rendering))if(r)hl(i,!1);else{if(0!==Sh||null!==t&&128&t.flags)for(t=e.child;null!==t;){if(null!==(a=Br(t))){for(e.flags|=128,hl(i,!1),t=a.updateQueue,e.updateQueue=t,ll(e,t),e.subtreeFlags=0,t=s,s=e.child;null!==s;)zn(s,t),s=s.sibling;return z(Nr,1&Nr.current|2),hi&&si(e,i.treeForkCount),e.child}t=t.sibling}null!==i.tail&&at()>Rh&&(e.flags|=128,r=!0,hl(i,!1),e.lanes=4194304)}else{if(!r)if(null!==(t=Br(a))){if(e.flags|=128,r=!0,t=t.updateQueue,e.updateQueue=t,ll(e,t),hl(i,!0),null===i.tail&&"hidden"===i.tailMode&&!a.alternate&&!hi)return cl(e),null}else 2*at()-i.renderingStartTime>Rh&&536870912!==s&&(e.flags|=128,r=!0,hl(i,!1),e.lanes=4194304);i.isBackwards?(a.sibling=e.child,e.child=a):(null!==(t=i.last)?t.sibling=a:e.child=a,i.last=a)}return null!==i.tail?(t=i.tail,i.rendering=t,i.tail=t.sibling,i.renderingStartTime=at(),t.sibling=null,s=Nr.current,z(Nr,r?1&s|2:1&s),hi&&si(e,i.treeForkCount),t):(cl(e),null);case 22:case 23:return Fr(e),Pr(),i=null!==e.memoizedState,null!==t?null!==t.memoizedState!==i&&(e.flags|=8192):i&&(e.flags|=8192),i?!!(536870912&s)&&!(128&e.flags)&&(cl(e),6&e.subtreeFlags&&(e.flags|=8192)):cl(e),null!==(s=e.updateQueue)&&ll(e,s.retryQueue),s=null,null!==t&&null!==t.memoizedState&&null!==t.memoizedState.cachePool&&(s=t.memoizedState.cachePool.pool),i=null,null!==e.memoizedState&&null!==e.memoizedState.cachePool&&(i=e.memoizedState.cachePool.pool),i!==s&&(e.flags|=2048),null!==t&&B(ji),null;case 24:return s=null,null!==t&&(s=t.memoizedState.cache),e.memoizedState.cache!==s&&(e.flags|=2048),Ti(Fi),cl(e),null;case 25:case 30:return null}throw Error(n(156,e.tag))}function ul(t,e){switch(ri(e),e.tag){case 1:return 65536&(t=e.flags)?(e.flags=-65537&t|128,e):null;case 3:return Ti(Fi),X(),65536&(t=e.flags)&&!(128&t)?(e.flags=-65537&t|128,e):null;case 26:case 27:case 5:return K(e),null;case 31:if(null!==e.memoizedState){if(Fr(e),null===e.alternate)throw Error(n(340));_i()}return 65536&(t=e.flags)?(e.flags=-65537&t|128,e):null;case 13:if(Fr(e),null!==(t=e.memoizedState)&&null!==t.dehydrated){if(null===e.alternate)throw Error(n(340));_i()}return 65536&(t=e.flags)?(e.flags=-65537&t|128,e):null;case 19:return B(Nr),null;case 4:return X(),null;case 10:return Ti(e.type),null;case 22:case 23:return Fr(e),Pr(),null!==t&&B(ji),65536&(t=e.flags)?(e.flags=-65537&t|128,e):null;case 24:return Ti(Fi),null;default:return null}}function fl(t,e){switch(ri(e),e.tag){case 3:Ti(Fi),X();break;case 26:case 27:case 5:K(e);break;case 4:X();break;case 31:null!==e.memoizedState&&Fr(e);break;case 13:Fr(e);break;case 19:B(Nr);break;case 10:Ti(e.type);break;case 22:case 23:Fr(e),Pr(),null!==t&&B(ji);break;case 24:Ti(Fi)}}function pl(t,e){try{var s=e.updateQueue,n=null!==s?s.lastEffect:null;if(null!==n){var i=n.next;s=i;do{if((s.tag&t)===t){n=void 0;var r=s.create,a=s.inst;n=r(),a.destroy=n}s=s.next}while(s!==i)}}catch(t){Sc(e,e.return,t)}}function ml(t,e,s){try{var n=e.updateQueue,i=null!==n?n.lastEffect:null;if(null!==i){var r=i.next;n=r;do{if((n.tag&t)===t){var a=n.inst,o=a.destroy;if(void 0!==o){a.destroy=void 0,i=e;var l=s,h=o;try{h()}catch(t){Sc(i,l,t)}}}n=n.next}while(n!==r)}}catch(t){Sc(e,e.return,t)}}function gl(t){var e=t.updateQueue;if(null!==e){var s=t.stateNode;try{Tr(e,s)}catch(e){Sc(t,t.return,e)}}}function _l(t,e,s){s.props=So(t.type,t.memoizedProps),s.state=t.memoizedState;try{s.componentWillUnmount()}catch(s){Sc(t,e,s)}}function vl(t,e){try{var s=t.ref;if(null!==s){switch(t.tag){case 26:case 27:case 5:var n=t.stateNode;break;default:n=t.stateNode}"function"==typeof s?t.refCleanup=s(n):s.current=n}}catch(s){Sc(t,e,s)}}function yl(t,e){var s=t.ref,n=t.refCleanup;if(null!==s)if("function"==typeof n)try{n()}catch(s){Sc(t,e,s)}finally{t.refCleanup=null,null!=(t=t.alternate)&&(t.refCleanup=null)}else if("function"==typeof s)try{s(null)}catch(s){Sc(t,e,s)}else s.current=null}function bl(t){var e=t.type,s=t.memoizedProps,n=t.stateNode;try{t:switch(e){case"button":case"input":case"select":case"textarea":s.autoFocus&&n.focus();break t;case"img":s.src?n.src=s.src:s.srcSet&&(n.srcset=s.srcSet)}}catch(e){Sc(t,t.return,e)}}function Sl(t,e,s){try{var i=t.stateNode;!function(t,e,s,i){switch(e){case"div":case"span":case"svg":case"path":case"a":case"g":case"p":case"li":break;case"input":var r=null,a=null,o=null,l=null,h=null,c=null,d=null;for(p in s){var u=s[p];if(s.hasOwnProperty(p)&&null!=u)switch(p){case"checked":case"value":break;case"defaultValue":h=u;default:i.hasOwnProperty(p)||ld(t,e,p,null,i,u)}}for(var f in i){var p=i[f];if(u=s[f],i.hasOwnProperty(f)&&(null!=p||null!=u))switch(f){case"type":a=p;break;case"name":r=p;break;case"checked":c=p;break;case"defaultChecked":d=p;break;case"value":o=p;break;case"defaultValue":l=p;break;case"children":case"dangerouslySetInnerHTML":if(null!=p)throw Error(n(137,e));break;default:p!==u&&ld(t,e,f,p,i,u)}}return void ge(t,o,l,h,c,d,a,r);case"select":for(a in p=o=l=f=null,s)if(h=s[a],s.hasOwnProperty(a)&&null!=h)switch(a){case"value":break;case"multiple":p=h;default:i.hasOwnProperty(a)||ld(t,e,a,null,i,h)}for(r in i)if(a=i[r],h=s[r],i.hasOwnProperty(r)&&(null!=a||null!=h))switch(r){case"value":f=a;break;case"defaultValue":l=a;break;case"multiple":o=a;default:a!==h&&ld(t,e,r,a,i,h)}return e=l,s=o,i=p,void(null!=f?ye(t,!!s,f,!1):!!i!=!!s&&(null!=e?ye(t,!!s,e,!0):ye(t,!!s,s?[]:"",!1)));case"textarea":for(l in p=f=null,s)if(r=s[l],s.hasOwnProperty(l)&&null!=r&&!i.hasOwnProperty(l))switch(l){case"value":case"children":break;default:ld(t,e,l,null,i,r)}for(o in i)if(r=i[o],a=s[o],i.hasOwnProperty(o)&&(null!=r||null!=a))switch(o){case"value":f=r;break;case"defaultValue":p=r;break;case"children":break;case"dangerouslySetInnerHTML":if(null!=r)throw Error(n(91));break;default:r!==a&&ld(t,e,o,r,i,a)}return void be(t,f,p);case"option":for(var m in s)if(f=s[m],s.hasOwnProperty(m)&&null!=f&&!i.hasOwnProperty(m))if("selected"===m)t.selected=!1;else ld(t,e,m,null,i,f);for(h in i)if(f=i[h],p=s[h],i.hasOwnProperty(h)&&f!==p&&(null!=f||null!=p))if("selected"===h)t.selected=f&&"function"!=typeof f&&"symbol"!=typeof f;else ld(t,e,h,f,i,p);return;case"img":case"link":case"area":case"base":case"br":case"col":case"embed":case"hr":case"keygen":case"meta":case"param":case"source":case"track":case"wbr":case"menuitem":for(var g in s)f=s[g],s.hasOwnProperty(g)&&null!=f&&!i.hasOwnProperty(g)&&ld(t,e,g,null,i,f);for(c in i)if(f=i[c],p=s[c],i.hasOwnProperty(c)&&f!==p&&(null!=f||null!=p))switch(c){case"children":case"dangerouslySetInnerHTML":if(null!=f)throw Error(n(137,e));break;default:ld(t,e,c,f,i,p)}return;default:if(Ee(e)){for(var _ in s)f=s[_],s.hasOwnProperty(_)&&void 0!==f&&!i.hasOwnProperty(_)&&hd(t,e,_,void 0,i,f);for(d in i)f=i[d],p=s[d],!i.hasOwnProperty(d)||f===p||void 0===f&&void 0===p||hd(t,e,d,f,i,p);return}}for(var v in s)f=s[v],s.hasOwnProperty(v)&&null!=f&&!i.hasOwnProperty(v)&&ld(t,e,v,null,i,f);for(u in i)f=i[u],p=s[u],!i.hasOwnProperty(u)||f===p||null==f&&null==p||ld(t,e,u,f,i,p)}(i,t.type,s,e),i[Ut]=e}catch(e){Sc(t,t.return,e)}}function xl(t){return 5===t.tag||3===t.tag||26===t.tag||27===t.tag&&Td(t.type)||4===t.tag}function wl(t){t:for(;;){for(;null===t.sibling;){if(null===t.return||xl(t.return))return null;t=t.return}for(t.sibling.return=t.return,t=t.sibling;5!==t.tag&&6!==t.tag&&18!==t.tag;){if(27===t.tag&&Td(t.type))continue t;if(2&t.flags)continue t;if(null===t.child||4===t.tag)continue t;t.child.return=t,t=t.child}if(!(2&t.flags))return t.stateNode}}function Tl(t,e,s){var n=t.tag;if(5===n||6===n)t=t.stateNode,e?(9===s.nodeType?s.body:"HTML"===s.nodeName?s.ownerDocument.body:s).insertBefore(t,e):((e=9===s.nodeType?s.body:"HTML"===s.nodeName?s.ownerDocument.body:s).appendChild(t),null!=(s=s._reactRootContainer)||null!==e.onclick||(e.onclick=Le));else if(4!==n&&(27===n&&Td(t.type)&&(s=t.stateNode,e=null),null!==(t=t.child)))for(Tl(t,e,s),t=t.sibling;null!==t;)Tl(t,e,s),t=t.sibling}function Cl(t,e,s){var n=t.tag;if(5===n||6===n)t=t.stateNode,e?s.insertBefore(t,e):s.appendChild(t);else if(4!==n&&(27===n&&Td(t.type)&&(s=t.stateNode),null!==(t=t.child)))for(Cl(t,e,s),t=t.sibling;null!==t;)Cl(t,e,s),t=t.sibling}function El(t){var e=t.stateNode,s=t.memoizedProps;try{for(var n=t.type,i=e.attributes;i.length;)e.removeAttributeNode(i[0]);cd(e,n,s),e[zt]=t,e[Ut]=s}catch(e){Sc(t,t.return,e)}}var Al=!1,Dl=!1,Pl=!1,Ll="function"==typeof WeakSet?WeakSet:Set,Il=null;function Rl(t,e,s){var n=s.flags;switch(s.tag){case 0:case 11:case 15:$l(t,s),4&n&&pl(5,s);break;case 1:if($l(t,s),4&n)if(t=s.stateNode,null===e)try{t.componentDidMount()}catch(t){Sc(s,s.return,t)}else{var i=So(s.type,e.memoizedProps);e=e.memoizedState;try{t.componentDidUpdate(i,e,t.__reactInternalSnapshotBeforeUpdate)}catch(t){Sc(s,s.return,t)}}64&n&&gl(s),512&n&&vl(s,s.return);break;case 3:if($l(t,s),64&n&&null!==(t=s.updateQueue)){if(e=null,null!==s.child)switch(s.child.tag){case 27:case 5:case 1:e=s.child.stateNode}try{Tr(t,e)}catch(t){Sc(s,s.return,t)}}break;case 27:null===e&&4&n&&El(s);case 26:case 5:$l(t,s),null===e&&4&n&&bl(s),512&n&&vl(s,s.return);break;case 12:$l(t,s);break;case 31:$l(t,s),4&n&&Bl(t,s);break;case 13:$l(t,s),4&n&&zl(t,s),64&n&&(null!==(t=s.memoizedState)&&(null!==(t=t.dehydrated)&&function(t,e){var s=t.ownerDocument;if("$~"===t.data)t._reactRetry=e;else if("$?"!==t.data||"loading"!==s.readyState)e();else{var n=function(){e(),s.removeEventListener("DOMContentLoaded",n)};s.addEventListener("DOMContentLoaded",n),t._reactRetry=n}}(t,s=Cc.bind(null,s))));break;case 22:if(!(n=null!==s.memoizedState||Al)){e=null!==e&&null!==e.memoizedState||Dl,i=Al;var r=Dl;Al=n,(Dl=e)&&!r?ql(t,s,!!(8772&s.subtreeFlags)):$l(t,s),Al=i,Dl=r}break;case 30:break;default:$l(t,s)}}function Ml(t){var e=t.alternate;null!==e&&(t.alternate=null,Ml(e)),t.child=null,t.deletions=null,t.sibling=null,5===t.tag&&(null!==(e=t.stateNode)&&Xt(e)),t.stateNode=null,t.return=null,t.dependencies=null,t.memoizedProps=null,t.memoizedState=null,t.pendingProps=null,t.stateNode=null,t.updateQueue=null}var kl=null,Ol=!1;function Fl(t,e,s){for(s=s.child;null!==s;)Nl(t,e,s),s=s.sibling}function Nl(t,e,s){if(gt&&"function"==typeof gt.onCommitFiberUnmount)try{gt.onCommitFiberUnmount(mt,s)}catch(t){}switch(s.tag){case 26:Dl||yl(s,e),Fl(t,e,s),s.memoizedState?s.memoizedState.count--:s.stateNode&&(s=s.stateNode).parentNode.removeChild(s);break;case 27:Dl||yl(s,e);var n=kl,i=Ol;Td(s.type)&&(kl=s.stateNode,Ol=!1),Fl(t,e,s),Fd(s.stateNode),kl=n,Ol=i;break;case 5:Dl||yl(s,e);case 6:if(n=kl,i=Ol,kl=null,Fl(t,e,s),Ol=i,null!==(kl=n))if(Ol)try{(9===kl.nodeType?kl.body:"HTML"===kl.nodeName?kl.ownerDocument.body:kl).removeChild(s.stateNode)}catch(t){Sc(s,e,t)}else try{kl.removeChild(s.stateNode)}catch(t){Sc(s,e,t)}break;case 18:null!==kl&&(Ol?(Cd(9===(t=kl).nodeType?t.body:"HTML"===t.nodeName?t.ownerDocument.body:t,s.stateNode),Hu(t)):Cd(kl,s.stateNode));break;case 4:n=kl,i=Ol,kl=s.stateNode.containerInfo,Ol=!0,Fl(t,e,s),kl=n,Ol=i;break;case 0:case 11:case 14:case 15:ml(2,s,e),Dl||ml(4,s,e),Fl(t,e,s);break;case 1:Dl||(yl(s,e),"function"==typeof(n=s.stateNode).componentWillUnmount&&_l(s,e,n)),Fl(t,e,s);break;case 21:Fl(t,e,s);break;case 22:Dl=(n=Dl)||null!==s.memoizedState,Fl(t,e,s),Dl=n;break;default:Fl(t,e,s)}}function Bl(t,e){if(null===e.memoizedState&&(null!==(t=e.alternate)&&null!==(t=t.memoizedState))){t=t.dehydrated;try{Hu(t)}catch(t){Sc(e,e.return,t)}}}function zl(t,e){if(null===e.memoizedState&&(null!==(t=e.alternate)&&(null!==(t=t.memoizedState)&&null!==(t=t.dehydrated))))try{Hu(t)}catch(t){Sc(e,e.return,t)}}function Ul(t,e){var s=function(t){switch(t.tag){case 31:case 13:case 19:var e=t.stateNode;return null===e&&(e=t.stateNode=new Ll),e;case 22:return null===(e=(t=t.stateNode)._retryCache)&&(e=t._retryCache=new Ll),e;default:throw Error(n(435,t.tag))}}(t);e.forEach(function(e){if(!s.has(e)){s.add(e);var n=Ec.bind(null,t,e);e.then(n,n)}})}function Vl(t,e){var s=e.deletions;if(null!==s)for(var i=0;i<s.length;i++){var r=s[i],a=t,o=e,l=o;t:for(;null!==l;){switch(l.tag){case 27:if(Td(l.type)){kl=l.stateNode,Ol=!1;break t}break;case 5:kl=l.stateNode,Ol=!1;break t;case 3:case 4:kl=l.stateNode.containerInfo,Ol=!0;break t}l=l.return}if(null===kl)throw Error(n(160));Nl(a,o,r),kl=null,Ol=!1,null!==(a=r.alternate)&&(a.return=null),r.return=null}if(13886&e.subtreeFlags)for(e=e.child;null!==e;)Gl(e,t),e=e.sibling}var Hl=null;function Gl(t,e){var s=t.alternate,i=t.flags;switch(t.tag){case 0:case 11:case 14:case 15:Vl(e,t),Wl(t),4&i&&(ml(3,t,t.return),pl(3,t),ml(5,t,t.return));break;case 1:Vl(e,t),Wl(t),512&i&&(Dl||null===s||yl(s,s.return)),64&i&&Al&&(null!==(t=t.updateQueue)&&(null!==(i=t.callbacks)&&(s=t.shared.hiddenCallbacks,t.shared.hiddenCallbacks=null===s?i:s.concat(i))));break;case 26:var r=Hl;if(Vl(e,t),Wl(t),512&i&&(Dl||null===s||yl(s,s.return)),4&i){var a=null!==s?s.memoizedState:null;if(i=t.memoizedState,null===s)if(null===i)if(null===t.stateNode){t:{i=t.type,s=t.memoizedProps,r=r.ownerDocument||r;e:switch(i){case"title":(!(a=r.getElementsByTagName("title")[0])||a[$t]||a[zt]||"http://www.w3.org/2000/svg"===a.namespaceURI||a.hasAttribute("itemprop"))&&(a=r.createElement(i),r.head.insertBefore(a,r.querySelector("head > title"))),cd(a,i,s),a[zt]=t,Zt(a),i=a;break t;case"link":var o=tu("link","href",r).get(i+(s.href||""));if(o)for(var l=0;l<o.length;l++)if((a=o[l]).getAttribute("href")===(null==s.href||""===s.href?null:s.href)&&a.getAttribute("rel")===(null==s.rel?null:s.rel)&&a.getAttribute("title")===(null==s.title?null:s.title)&&a.getAttribute("crossorigin")===(null==s.crossOrigin?null:s.crossOrigin)){o.splice(l,1);break e}cd(a=r.createElement(i),i,s),r.head.appendChild(a);break;case"meta":if(o=tu("meta","content",r).get(i+(s.content||"")))for(l=0;l<o.length;l++)if((a=o[l]).getAttribute("content")===(null==s.content?null:""+s.content)&&a.getAttribute("name")===(null==s.name?null:s.name)&&a.getAttribute("property")===(null==s.property?null:s.property)&&a.getAttribute("http-equiv")===(null==s.httpEquiv?null:s.httpEquiv)&&a.getAttribute("charset")===(null==s.charSet?null:s.charSet)){o.splice(l,1);break e}cd(a=r.createElement(i),i,s),r.head.appendChild(a);break;default:throw Error(n(468,i))}a[zt]=t,Zt(a),i=a}t.stateNode=i}else eu(r,t.type,t.stateNode);else t.stateNode=Kd(r,i,t.memoizedProps);else a!==i?(null===a?null!==s.stateNode&&(s=s.stateNode).parentNode.removeChild(s):a.count--,null===i?eu(r,t.type,t.stateNode):Kd(r,i,t.memoizedProps)):null===i&&null!==t.stateNode&&Sl(t,t.memoizedProps,s.memoizedProps)}break;case 27:Vl(e,t),Wl(t),512&i&&(Dl||null===s||yl(s,s.return)),null!==s&&4&i&&Sl(t,t.memoizedProps,s.memoizedProps);break;case 5:if(Vl(e,t),Wl(t),512&i&&(Dl||null===s||yl(s,s.return)),32&t.flags){r=t.stateNode;try{xe(r,"")}catch(e){Sc(t,t.return,e)}}4&i&&null!=t.stateNode&&Sl(t,r=t.memoizedProps,null!==s?s.memoizedProps:r),1024&i&&(Pl=!0);break;case 6:if(Vl(e,t),Wl(t),4&i){if(null===t.stateNode)throw Error(n(162));i=t.memoizedProps,s=t.stateNode;try{s.nodeValue=i}catch(e){Sc(t,t.return,e)}}break;case 3:if(Jd=null,r=Hl,Hl=zd(e.containerInfo),Vl(e,t),Hl=r,Wl(t),4&i&&null!==s&&s.memoizedState.isDehydrated)try{Hu(e.containerInfo)}catch(e){Sc(t,t.return,e)}Pl&&(Pl=!1,jl(t));break;case 4:i=Hl,Hl=zd(t.stateNode.containerInfo),Vl(e,t),Wl(t),Hl=i;break;case 12:default:Vl(e,t),Wl(t);break;case 31:case 19:Vl(e,t),Wl(t),4&i&&(null!==(i=t.updateQueue)&&(t.updateQueue=null,Ul(t,i)));break;case 13:Vl(e,t),Wl(t),8192&t.child.flags&&null!==t.memoizedState!=(null!==s&&null!==s.memoizedState)&&(Lh=at()),4&i&&(null!==(i=t.updateQueue)&&(t.updateQueue=null,Ul(t,i)));break;case 22:r=null!==t.memoizedState;var h=null!==s&&null!==s.memoizedState,c=Al,d=Dl;if(Al=c||r,Dl=d||h,Vl(e,t),Dl=d,Al=c,Wl(t),8192&i)t:for(e=t.stateNode,e._visibility=r?-2&e._visibility:1|e._visibility,r&&(null===s||h||Al||Dl||Xl(t)),s=null,e=t;;){if(5===e.tag||26===e.tag){if(null===s){h=s=e;try{if(a=h.stateNode,r)"function"==typeof(o=a.style).setProperty?o.setProperty("display","none","important"):o.display="none";else{l=h.stateNode;var u=h.memoizedProps.style,f=null!=u&&u.hasOwnProperty("display")?u.display:null;l.style.display=null==f||"boolean"==typeof f?"":(""+f).trim()}}catch(t){Sc(h,h.return,t)}}}else if(6===e.tag){if(null===s){h=e;try{h.stateNode.nodeValue=r?"":h.memoizedProps}catch(t){Sc(h,h.return,t)}}}else if(18===e.tag){if(null===s){h=e;try{var p=h.stateNode;r?Ed(p,!0):Ed(h.stateNode,!1)}catch(t){Sc(h,h.return,t)}}}else if((22!==e.tag&&23!==e.tag||null===e.memoizedState||e===t)&&null!==e.child){e.child.return=e,e=e.child;continue}if(e===t)break t;for(;null===e.sibling;){if(null===e.return||e.return===t)break t;s===e&&(s=null),e=e.return}s===e&&(s=null),e.sibling.return=e.return,e=e.sibling}4&i&&(null!==(i=t.updateQueue)&&(null!==(s=i.retryQueue)&&(i.retryQueue=null,Ul(t,s))));case 30:case 21:}}function Wl(t){var e=t.flags;if(2&e){try{for(var s,i=t.return;null!==i;){if(xl(i)){s=i;break}i=i.return}if(null==s)throw Error(n(160));switch(s.tag){case 27:var r=s.stateNode;Cl(t,wl(t),r);break;case 5:var a=s.stateNode;32&s.flags&&(xe(a,""),s.flags&=-33),Cl(t,wl(t),a);break;case 3:case 4:var o=s.stateNode.containerInfo;Tl(t,wl(t),o);break;default:throw Error(n(161))}}catch(e){Sc(t,t.return,e)}t.flags&=-3}4096&e&&(t.flags&=-4097)}function jl(t){if(1024&t.subtreeFlags)for(t=t.child;null!==t;){var e=t;jl(e),5===e.tag&&1024&e.flags&&e.stateNode.reset(),t=t.sibling}}function $l(t,e){if(8772&e.subtreeFlags)for(e=e.child;null!==e;)Rl(t,e.alternate,e),e=e.sibling}function Xl(t){for(t=t.child;null!==t;){var e=t;switch(e.tag){case 0:case 11:case 14:case 15:ml(4,e,e.return),Xl(e);break;case 1:yl(e,e.return);var s=e.stateNode;"function"==typeof s.componentWillUnmount&&_l(e,e.return,s),Xl(e);break;case 27:Fd(e.stateNode);case 26:case 5:yl(e,e.return),Xl(e);break;case 22:null===e.memoizedState&&Xl(e);break;default:Xl(e)}t=t.sibling}}function ql(t,e,s){for(s=s&&!!(8772&e.subtreeFlags),e=e.child;null!==e;){var n=e.alternate,i=t,r=e,a=r.flags;switch(r.tag){case 0:case 11:case 15:ql(i,r,s),pl(4,r);break;case 1:if(ql(i,r,s),"function"==typeof(i=(n=r).stateNode).componentDidMount)try{i.componentDidMount()}catch(t){Sc(n,n.return,t)}if(null!==(i=(n=r).updateQueue)){var o=n.stateNode;try{var l=i.shared.hiddenCallbacks;if(null!==l)for(i.shared.hiddenCallbacks=null,i=0;i<l.length;i++)wr(l[i],o)}catch(t){Sc(n,n.return,t)}}s&&64&a&&gl(r),vl(r,r.return);break;case 27:El(r);case 26:case 5:ql(i,r,s),s&&null===n&&4&a&&bl(r),vl(r,r.return);break;case 12:ql(i,r,s);break;case 31:ql(i,r,s),s&&4&a&&Bl(i,r);break;case 13:ql(i,r,s),s&&4&a&&zl(i,r);break;case 22:null===r.memoizedState&&ql(i,r,s),vl(r,r.return);break;case 30:break;default:ql(i,r,s)}e=e.sibling}}function Kl(t,e){var s=null;null!==t&&null!==t.memoizedState&&null!==t.memoizedState.cachePool&&(s=t.memoizedState.cachePool.pool),t=null,null!==e.memoizedState&&null!==e.memoizedState.cachePool&&(t=e.memoizedState.cachePool.pool),t!==s&&(null!=t&&t.refCount++,null!=s&&Bi(s))}function Yl(t,e){t=null,null!==e.alternate&&(t=e.alternate.memoizedState.cache),(e=e.memoizedState.cache)!==t&&(e.refCount++,null!=t&&Bi(t))}function Ql(t,e,s,n){if(10256&e.subtreeFlags)for(e=e.child;null!==e;)Zl(t,e,s,n),e=e.sibling}function Zl(t,e,s,n){var i=e.flags;switch(e.tag){case 0:case 11:case 15:Ql(t,e,s,n),2048&i&&pl(9,e);break;case 1:case 31:case 13:default:Ql(t,e,s,n);break;case 3:Ql(t,e,s,n),2048&i&&(t=null,null!==e.alternate&&(t=e.alternate.memoizedState.cache),(e=e.memoizedState.cache)!==t&&(e.refCount++,null!=t&&Bi(t)));break;case 12:if(2048&i){Ql(t,e,s,n),t=e.stateNode;try{var r=e.memoizedProps,a=r.id,o=r.onPostCommit;"function"==typeof o&&o(a,null===e.alternate?"mount":"update",t.passiveEffectDuration,-0)}catch(t){Sc(e,e.return,t)}}else Ql(t,e,s,n);break;case 23:break;case 22:r=e.stateNode,a=e.alternate,null!==e.memoizedState?2&r._visibility?Ql(t,e,s,n):th(t,e):2&r._visibility?Ql(t,e,s,n):(r._visibility|=2,Jl(t,e,s,n,!!(10256&e.subtreeFlags)||!1)),2048&i&&Kl(a,e);break;case 24:Ql(t,e,s,n),2048&i&&Yl(e.alternate,e)}}function Jl(t,e,s,n,i){for(i=i&&(!!(10256&e.subtreeFlags)||!1),e=e.child;null!==e;){var r=t,a=e,o=s,l=n,h=a.flags;switch(a.tag){case 0:case 11:case 15:Jl(r,a,o,l,i),pl(8,a);break;case 23:break;case 22:var c=a.stateNode;null!==a.memoizedState?2&c._visibility?Jl(r,a,o,l,i):th(r,a):(c._visibility|=2,Jl(r,a,o,l,i)),i&&2048&h&&Kl(a.alternate,a);break;case 24:Jl(r,a,o,l,i),i&&2048&h&&Yl(a.alternate,a);break;default:Jl(r,a,o,l,i)}e=e.sibling}}function th(t,e){if(10256&e.subtreeFlags)for(e=e.child;null!==e;){var s=t,n=e,i=n.flags;switch(n.tag){case 22:th(s,n),2048&i&&Kl(n.alternate,n);break;case 24:th(s,n),2048&i&&Yl(n.alternate,n);break;default:th(s,n)}e=e.sibling}}var eh=8192;function sh(t,e,s){if(t.subtreeFlags&eh)for(t=t.child;null!==t;)nh(t,e,s),t=t.sibling}function nh(t,e,s){switch(t.tag){case 26:sh(t,e,s),t.flags&eh&&null!==t.memoizedState&&function(t,e,s,n){if(!("stylesheet"!==s.type||"string"==typeof n.media&&!1===matchMedia(n.media).matches||4&s.state.loading)){if(null===s.instance){var i=Wd(n.href),r=e.querySelector(jd(i));if(r)return null!==(e=r._p)&&"object"==typeof e&&"function"==typeof e.then&&(t.count++,t=iu.bind(t),e.then(t,t)),s.state.loading|=4,s.instance=r,void Zt(r);r=e.ownerDocument||e,n=$d(n),(i=Nd.get(i))&&Qd(n,i),Zt(r=r.createElement("link"));var a=r;a._p=new Promise(function(t,e){a.onload=t,a.onerror=e}),cd(r,"link",n),s.instance=r}null===t.stylesheets&&(t.stylesheets=new Map),t.stylesheets.set(s,e),(e=s.state.preload)&&!(3&s.state.loading)&&(t.count++,s=iu.bind(t),e.addEventListener("load",s),e.addEventListener("error",s))}}(s,Hl,t.memoizedState,t.memoizedProps);break;case 5:default:sh(t,e,s);break;case 3:case 4:var n=Hl;Hl=zd(t.stateNode.containerInfo),sh(t,e,s),Hl=n;break;case 22:null===t.memoizedState&&(null!==(n=t.alternate)&&null!==n.memoizedState?(n=eh,eh=16777216,sh(t,e,s),eh=n):sh(t,e,s))}}function ih(t){var e=t.alternate;if(null!==e&&null!==(t=e.child)){e.child=null;do{e=t.sibling,t.sibling=null,t=e}while(null!==t)}}function rh(t){var e=t.deletions;if(16&t.flags){if(null!==e)for(var s=0;s<e.length;s++){var n=e[s];Il=n,lh(n,t)}ih(t)}if(10256&t.subtreeFlags)for(t=t.child;null!==t;)ah(t),t=t.sibling}function ah(t){switch(t.tag){case 0:case 11:case 15:rh(t),2048&t.flags&&ml(9,t,t.return);break;case 3:case 12:default:rh(t);break;case 22:var e=t.stateNode;null!==t.memoizedState&&2&e._visibility&&(null===t.return||13!==t.return.tag)?(e._visibility&=-3,oh(t)):rh(t)}}function oh(t){var e=t.deletions;if(16&t.flags){if(null!==e)for(var s=0;s<e.length;s++){var n=e[s];Il=n,lh(n,t)}ih(t)}for(t=t.child;null!==t;){switch((e=t).tag){case 0:case 11:case 15:ml(8,e,e.return),oh(e);break;case 22:2&(s=e.stateNode)._visibility&&(s._visibility&=-3,oh(e));break;default:oh(e)}t=t.sibling}}function lh(t,e){for(;null!==Il;){var s=Il;switch(s.tag){case 0:case 11:case 15:ml(8,s,e);break;case 23:case 22:if(null!==s.memoizedState&&null!==s.memoizedState.cachePool){var n=s.memoizedState.cachePool.pool;null!=n&&n.refCount++}break;case 24:Bi(s.memoizedState.cache)}if(null!==(n=s.child))n.return=s,Il=n;else t:for(s=t;null!==Il;){var i=(n=Il).sibling,r=n.return;if(Ml(n),n===s){Il=null;break t}if(null!==i){i.return=r,Il=i;break t}Il=r}}}var hh={getCacheForType:function(t){var e=Li(Fi),s=e.data.get(t);return void 0===s&&(s=t(),e.data.set(t,s)),s},cacheSignal:function(){return Li(Fi).controller.signal}},ch="function"==typeof WeakMap?WeakMap:Map,dh=0,uh=null,fh=null,ph=0,mh=0,gh=null,_h=!1,vh=!1,yh=!1,bh=0,Sh=0,xh=0,wh=0,Th=0,Ch=0,Eh=0,Ah=null,Dh=null,Ph=!1,Lh=0,Ih=0,Rh=1/0,Mh=null,kh=null,Oh=0,Fh=null,Nh=null,Bh=0,zh=0,Uh=null,Vh=null,Hh=0,Gh=null;function Wh(){return 2&dh&&0!==ph?ph&-ph:null!==R.T?Uc():Ft()}function jh(){if(0===Ch)if(536870912&ph&&!hi)Ch=536870912;else{var t=xt;!(3932160&(xt<<=1))&&(xt=262144),Ch=t}return null!==(t=Lr.current)&&(t.flags|=32),Ch}function $h(t,e,s){(t!==uh||2!==mh&&9!==mh)&&null===t.cancelPendingCommit||(Jh(t,0),Yh(t,ph,Ch,!1)),Lt(t,s),2&dh&&t===uh||(t===uh&&(!(2&dh)&&(wh|=s),4===Sh&&Yh(t,ph,Ch,!1)),Mc(t))}function Xh(t,e,s){if(6&dh)throw Error(n(327));for(var i=!s&&!(127&e)&&0===(e&t.expiredLanes)||Et(t,e),r=i?function(t,e){var s=dh;dh|=2;var i=sc(),r=nc();uh!==t||ph!==e?(Mh=null,Rh=at()+500,Jh(t,e)):vh=Et(t,e);t:for(;;)try{if(0!==mh&&null!==fh){e=fh;var a=gh;e:switch(mh){case 1:mh=0,gh=null,cc(t,e,a,1);break;case 2:case 9:if(Ji(a)){mh=0,gh=null,hc(e);break}e=function(){2!==mh&&9!==mh||uh!==t||(mh=7),Mc(t)},a.then(e,e);break t;case 3:mh=7;break t;case 4:mh=5;break t;case 7:Ji(a)?(mh=0,gh=null,hc(e)):(mh=0,gh=null,cc(t,e,a,7));break;case 5:var o=null;switch(fh.tag){case 26:o=fh.memoizedState;case 5:case 27:var l=fh;if(o?su(o):l.stateNode.complete){mh=0,gh=null;var h=l.sibling;if(null!==h)fh=h;else{var c=l.return;null!==c?(fh=c,dc(c)):fh=null}break e}}mh=0,gh=null,cc(t,e,a,5);break;case 6:mh=0,gh=null,cc(t,e,a,6);break;case 8:Zh(),Sh=6;break t;default:throw Error(n(462))}}oc();break}catch(e){tc(t,e)}return xi=Si=null,R.H=i,R.A=r,dh=s,null!==fh?0:(uh=null,ph=0,Dn(),Sh)}(t,e):rc(t,e,!0),a=i;;){if(0===r){vh&&!i&&Yh(t,e,0,!1);break}if(s=t.current.alternate,!a||Kh(s)){if(2===r){if(a=e,t.errorRecoveryDisabledLanes&a)var o=0;else o=0!==(o=-536870913&t.pendingLanes)?o:536870912&o?536870912:0;if(0!==o){e=o;t:{var l=t;r=Ah;var h=l.current.memoizedState.isDehydrated;if(h&&(Jh(l,o).flags|=256),2!==(o=rc(l,o,!1))){if(yh&&!h){l.errorRecoveryDisabledLanes|=a,wh|=a,r=4;break t}a=Dh,Dh=r,null!==a&&(null===Dh?Dh=a:Dh.push.apply(Dh,a))}r=o}if(a=!1,2!==r)continue}}if(1===r){Jh(t,0),Yh(t,e,0,!0);break}t:{switch(i=t,a=r){case 0:case 1:throw Error(n(345));case 4:if((4194048&e)!==e)break;case 6:Yh(i,e,Ch,!_h);break t;case 2:Dh=null;break;case 3:case 5:break;default:throw Error(n(329))}if((62914560&e)===e&&10<(r=Lh+300-at())){if(Yh(i,e,Ch,!_h),0!==Ct(i,0,!0))break t;Bh=e,i.timeoutHandle=yd(qh.bind(null,i,s,Dh,Mh,Ph,e,Ch,wh,Eh,_h,a,"Throttled",-0,0),r)}else qh(i,s,Dh,Mh,Ph,e,Ch,wh,Eh,_h,a,null,-0,0)}break}r=rc(t,e,!1),a=!1}Mc(t)}function qh(t,e,s,n,i,r,a,o,l,h,c,d,u,f){if(t.timeoutHandle=-1,8192&(d=e.subtreeFlags)||!(16785408&~d)){nh(e,r,d={stylesheets:null,count:0,imgCount:0,imgBytes:0,suspenseyImages:[],waitingForImages:!0,waitingForViewTransition:!1,unsuspend:Le});var p=(62914560&r)===r?Lh-at():(4194048&r)===r?Ih-at():0;if(p=function(t,e){return t.stylesheets&&0===t.count&&au(t,t.stylesheets),0<t.count||0<t.imgCount?function(s){var n=setTimeout(function(){if(t.stylesheets&&au(t,t.stylesheets),t.unsuspend){var e=t.unsuspend;t.unsuspend=null,e()}},6e4+e);0<t.imgBytes&&0===nu&&(nu=62500*function(){if("function"==typeof performance.getEntriesByType){for(var t=0,e=0,s=performance.getEntriesByType("resource"),n=0;n<s.length;n++){var i=s[n],r=i.transferSize,a=i.initiatorType,o=i.duration;if(r&&o&&dd(a)){for(a=0,o=i.responseEnd,n+=1;n<s.length;n++){var l=s[n],h=l.startTime;if(h>o)break;var c=l.transferSize,d=l.initiatorType;c&&dd(d)&&(a+=c*((l=l.responseEnd)<o?1:(o-h)/(l-h)))}if(--n,e+=8*(r+a)/(i.duration/1e3),10<++t)break}}if(0<t)return e/t/1e6}return navigator.connection&&"number"==typeof(t=navigator.connection.downlink)?t:5}());var i=setTimeout(function(){if(t.waitingForImages=!1,0===t.count&&(t.stylesheets&&au(t,t.stylesheets),t.unsuspend)){var e=t.unsuspend;t.unsuspend=null,e()}},(t.imgBytes>nu?50:800)+e);return t.unsuspend=s,function(){t.unsuspend=null,clearTimeout(n),clearTimeout(i)}}:null}(d,p),null!==p)return Bh=r,t.cancelPendingCommit=p(fc.bind(null,t,e,r,s,n,i,a,o,l,c,d,null,u,f)),void Yh(t,r,a,!h)}fc(t,e,r,s,n,i,a,o,l)}function Kh(t){for(var e=t;;){var s=e.tag;if((0===s||11===s||15===s)&&16384&e.flags&&(null!==(s=e.updateQueue)&&null!==(s=s.stores)))for(var n=0;n<s.length;n++){var i=s[n],r=i.getSnapshot;i=i.value;try{if(!Ks(r(),i))return!1}catch(t){return!1}}if(s=e.child,16384&e.subtreeFlags&&null!==s)s.return=e,e=s;else{if(e===t)break;for(;null===e.sibling;){if(null===e.return||e.return===t)return!0;e=e.return}e.sibling.return=e.return,e=e.sibling}}return!0}function Yh(t,e,s,n){e&=~Th,e&=~wh,t.suspendedLanes|=e,t.pingedLanes&=~e,n&&(t.warmLanes|=e),n=t.expirationTimes;for(var i=e;0<i;){var r=31-vt(i),a=1<<r;n[r]=-1,i&=~a}0!==s&&It(t,s,e)}function Qh(){return!!(6&dh)||(kc(0),!1)}function Zh(){if(null!==fh){if(0===mh)var t=fh.return;else xi=Si=null,ia(t=fh),rr=null,ar=0,t=fh;for(;null!==t;)fl(t.alternate,t),t=t.return;fh=null}}function Jh(t,e){var s=t.timeoutHandle;-1!==s&&(t.timeoutHandle=-1,bd(s)),null!==(s=t.cancelPendingCommit)&&(t.cancelPendingCommit=null,s()),Bh=0,Zh(),uh=t,fh=s=Bn(t.current,null),ph=e,mh=0,gh=null,_h=!1,vh=Et(t,e),yh=!1,Eh=Ch=Th=wh=xh=Sh=0,Dh=Ah=null,Ph=!1,8&e&&(e|=32&e);var n=t.entangledLanes;if(0!==n)for(t=t.entanglements,n&=e;0<n;){var i=31-vt(n),r=1<<i;e|=t[i],n&=~r}return bh=e,Dn(),s}function tc(t,e){Ur=null,R.H=fo,e===Ki||e===Qi?(e=nr(),mh=3):e===Yi?(e=nr(),mh=4):mh=e===Lo?8:null!==e&&"object"==typeof e&&"function"==typeof e.then?6:1,gh=e,null===fh&&(Sh=1,Co(t,$n(e,t.current)))}function ec(){var t=Lr.current;return null===t||((4194048&ph)===ph?null===Ir:!!((62914560&ph)===ph||536870912&ph)&&t===Ir)}function sc(){var t=R.H;return R.H=fo,null===t?fo:t}function nc(){var t=R.A;return R.A=hh,t}function ic(){Sh=4,_h||(4194048&ph)!==ph&&null!==Lr.current||(vh=!0),!(134217727&xh)&&!(134217727&wh)||null===uh||Yh(uh,ph,Ch,!1)}function rc(t,e,s){var n=dh;dh|=2;var i=sc(),r=nc();uh===t&&ph===e||(Mh=null,Jh(t,e)),e=!1;var a=Sh;t:for(;;)try{if(0!==mh&&null!==fh){var o=fh,l=gh;switch(mh){case 8:Zh(),a=6;break t;case 3:case 2:case 9:case 6:null===Lr.current&&(e=!0);var h=mh;if(mh=0,gh=null,cc(t,o,l,h),s&&vh){a=0;break t}break;default:h=mh,mh=0,gh=null,cc(t,o,l,h)}}ac(),a=Sh;break}catch(e){tc(t,e)}return e&&t.shellSuspendCounter++,xi=Si=null,dh=n,R.H=i,R.A=r,null===fh&&(uh=null,ph=0,Dn()),a}function ac(){for(;null!==fh;)lc(fh)}function oc(){for(;null!==fh&&!it();)lc(fh)}function lc(t){var e=il(t.alternate,t,bh);t.memoizedProps=t.pendingProps,null===e?dc(t):fh=e}function hc(t){var e=t,s=e.alternate;switch(e.tag){case 15:case 0:e=Go(s,e,e.pendingProps,e.type,void 0,ph);break;case 11:e=Go(s,e,e.pendingProps,e.type.render,e.ref,ph);break;case 5:ia(e);default:fl(s,e),e=il(s,e=fh=zn(e,bh),bh)}t.memoizedProps=t.pendingProps,null===e?dc(t):fh=e}function cc(t,e,s,i){xi=Si=null,ia(e),rr=null,ar=0;var r=e.return;try{if(function(t,e,s,i,r){if(s.flags|=32768,null!==i&&"object"==typeof i&&"function"==typeof i.then){if(null!==(e=s.alternate)&&Ai(e,s,r,!0),null!==(s=Lr.current)){switch(s.tag){case 31:case 13:return null===Ir?ic():null===s.alternate&&0===Sh&&(Sh=3),s.flags&=-257,s.flags|=65536,s.lanes=r,i===Zi?s.flags|=16384:(null===(e=s.updateQueue)?s.updateQueue=new Set([i]):e.add(i),xc(t,i,r)),!1;case 22:return s.flags|=65536,i===Zi?s.flags|=16384:(null===(e=s.updateQueue)?(e={transitions:null,markerInstances:null,retryQueue:new Set([i])},s.updateQueue=e):null===(s=e.retryQueue)?e.retryQueue=new Set([i]):s.add(i),xc(t,i,r)),!1}throw Error(n(435,s.tag))}return xc(t,i,r),ic(),!1}if(hi)return null!==(e=Lr.current)?(!(65536&e.flags)&&(e.flags|=256),e.flags|=65536,e.lanes=r,i!==ui&&yi($n(t=Error(n(422),{cause:i}),s))):(i!==ui&&yi($n(e=Error(n(423),{cause:i}),s)),(t=t.current.alternate).flags|=65536,r&=-r,t.lanes|=r,i=$n(i,s),yr(t,r=Ao(t.stateNode,i,r)),4!==Sh&&(Sh=2)),!1;var a=Error(n(520),{cause:i});if(a=$n(a,s),null===Ah?Ah=[a]:Ah.push(a),4!==Sh&&(Sh=2),null===e)return!0;i=$n(i,s),s=e;do{switch(s.tag){case 3:return s.flags|=65536,t=r&-r,s.lanes|=t,yr(s,t=Ao(s.stateNode,i,t)),!1;case 1:if(e=s.type,a=s.stateNode,!(128&s.flags||"function"!=typeof e.getDerivedStateFromError&&(null===a||"function"!=typeof a.componentDidCatch||null!==kh&&kh.has(a))))return s.flags|=65536,r&=-r,s.lanes|=r,Po(r=Do(r),t,s,i),yr(s,r),!1}s=s.return}while(null!==s);return!1}(t,r,e,s,ph))return Sh=1,Co(t,$n(s,t.current)),void(fh=null)}catch(e){if(null!==r)throw fh=r,e;return Sh=1,Co(t,$n(s,t.current)),void(fh=null)}32768&e.flags?(hi||1===i?t=!0:vh||536870912&ph?t=!1:(_h=t=!0,(2===i||9===i||3===i||6===i)&&(null!==(i=Lr.current)&&13===i.tag&&(i.flags|=16384))),uc(e,t)):dc(e)}function dc(t){var e=t;do{if(32768&e.flags)return void uc(e,_h);t=e.return;var s=dl(e.alternate,e,bh);if(null!==s)return void(fh=s);if(null!==(e=e.sibling))return void(fh=e);fh=e=t}while(null!==e);0===Sh&&(Sh=5)}function uc(t,e){do{var s=ul(t.alternate,t);if(null!==s)return s.flags&=32767,void(fh=s);if(null!==(s=t.return)&&(s.flags|=32768,s.subtreeFlags=0,s.deletions=null),!e&&null!==(t=t.sibling))return void(fh=t);fh=t=s}while(null!==t);Sh=6,fh=null}function fc(t,e,s,i,r,a,o,l,h){t.cancelPendingCommit=null;do{vc()}while(0!==Oh);if(6&dh)throw Error(n(327));if(null!==e){if(e===t.current)throw Error(n(177));if(a=e.lanes|e.childLanes,function(t,e,s,n,i,r){var a=t.pendingLanes;t.pendingLanes=s,t.suspendedLanes=0,t.pingedLanes=0,t.warmLanes=0,t.expiredLanes&=s,t.entangledLanes&=s,t.errorRecoveryDisabledLanes&=s,t.shellSuspendCounter=0;var o=t.entanglements,l=t.expirationTimes,h=t.hiddenUpdates;for(s=a&~s;0<s;){var c=31-vt(s),d=1<<c;o[c]=0,l[c]=-1;var u=h[c];if(null!==u)for(h[c]=null,c=0;c<u.length;c++){var f=u[c];null!==f&&(f.lane&=-536870913)}s&=~d}0!==n&&It(t,n,0),0!==r&&0===i&&0!==t.tag&&(t.suspendedLanes|=r&~(a&~e))}(t,s,a|=An,o,l,h),t===uh&&(fh=uh=null,ph=0),Nh=e,Fh=t,Bh=s,zh=a,Uh=r,Vh=i,10256&e.subtreeFlags||10256&e.flags?(t.callbackNode=null,t.callbackPriority=0,st(ct,function(){return yc(),null})):(t.callbackNode=null,t.callbackPriority=0),i=!!(13878&e.flags),13878&e.subtreeFlags||i){i=R.T,R.T=null,r=M.p,M.p=2,o=dh,dh|=4;try{!function(t,e){if(t=t.containerInfo,ud=_u,en(t=tn(t))){if("selectionStart"in t)var s={start:t.selectionStart,end:t.selectionEnd};else{var i=(s=(s=t.ownerDocument)&&s.defaultView||window).getSelection&&s.getSelection();if(i&&0!==i.rangeCount){s=i.anchorNode;var r=i.anchorOffset,a=i.focusNode;i=i.focusOffset;var o=0,l=-1,h=-1,c=0,d=0,u=t,f=null;t:for(;;){for(var p;u!==s||0!==r&&3!==u.nodeType||(l=o+r),u!==a||0!==i&&3!==u.nodeType||(h=o+i),3===u.nodeType&&(o+=u.nodeValue.length),null!==(p=u.firstChild);)f=u,u=p;for(;;){if(u===t)break t;if(f===s&&++c===r&&(l=o),f===a&&++d===i&&(h=o),null!==(p=u.nextSibling))break;f=(u=f).parentNode}u=p}s=-1===l||-1===h?null:{start:l,end:h}}else s=null}s=s||{start:0,end:0}}else s=null;for(fd={focusedElem:t,selectionRange:s},_u=!1,Il=e;null!==Il;)if(t=(e=Il).child,1028&e.subtreeFlags&&null!==t)t.return=e,Il=t;else for(;null!==Il;){switch(a=(e=Il).alternate,t=e.flags,e.tag){case 0:if(4&t&&null!==(t=null!==(t=e.updateQueue)?t.events:null))for(s=0;s<t.length;s++)(r=t[s]).ref.impl=r.nextImpl;break;case 11:case 15:case 5:case 26:case 27:case 6:case 4:case 17:break;case 1:if(1024&t&&null!==a){t=void 0,s=e,r=a.memoizedProps,a=a.memoizedState,i=s.stateNode;try{var m=So(s.type,r);t=i.getSnapshotBeforeUpdate(m,a),i.__reactInternalSnapshotBeforeUpdate=t}catch(t){Sc(s,s.return,t)}}break;case 3:if(1024&t)if(9===(s=(t=e.stateNode.containerInfo).nodeType))Ad(t);else if(1===s)switch(t.nodeName){case"HEAD":case"HTML":case"BODY":Ad(t);break;default:t.textContent=""}break;default:if(1024&t)throw Error(n(163))}if(null!==(t=e.sibling)){t.return=e.return,Il=t;break}Il=e.return}}(t,e)}finally{dh=o,M.p=r,R.T=i}}Oh=1,pc(),mc(),gc()}}function pc(){if(1===Oh){Oh=0;var t=Fh,e=Nh,s=!!(13878&e.flags);if(13878&e.subtreeFlags||s){s=R.T,R.T=null;var n=M.p;M.p=2;var i=dh;dh|=4;try{Gl(e,t);var r=fd,a=tn(t.containerInfo),o=r.focusedElem,l=r.selectionRange;if(a!==o&&o&&o.ownerDocument&&Js(o.ownerDocument.documentElement,o)){if(null!==l&&en(o)){var h=l.start,c=l.end;if(void 0===c&&(c=h),"selectionStart"in o)o.selectionStart=h,o.selectionEnd=Math.min(c,o.value.length);else{var d=o.ownerDocument||document,u=d&&d.defaultView||window;if(u.getSelection){var f=u.getSelection(),p=o.textContent.length,m=Math.min(l.start,p),g=void 0===l.end?m:Math.min(l.end,p);!f.extend&&m>g&&(a=g,g=m,m=a);var _=Zs(o,m),v=Zs(o,g);if(_&&v&&(1!==f.rangeCount||f.anchorNode!==_.node||f.anchorOffset!==_.offset||f.focusNode!==v.node||f.focusOffset!==v.offset)){var y=d.createRange();y.setStart(_.node,_.offset),f.removeAllRanges(),m>g?(f.addRange(y),f.extend(v.node,v.offset)):(y.setEnd(v.node,v.offset),f.addRange(y))}}}}for(d=[],f=o;f=f.parentNode;)1===f.nodeType&&d.push({element:f,left:f.scrollLeft,top:f.scrollTop});for("function"==typeof o.focus&&o.focus(),o=0;o<d.length;o++){var b=d[o];b.element.scrollLeft=b.left,b.element.scrollTop=b.top}}_u=!!ud,fd=ud=null}finally{dh=i,M.p=n,R.T=s}}t.current=e,Oh=2}}function mc(){if(2===Oh){Oh=0;var t=Fh,e=Nh,s=!!(8772&e.flags);if(8772&e.subtreeFlags||s){s=R.T,R.T=null;var n=M.p;M.p=2;var i=dh;dh|=4;try{Rl(t,e.alternate,e)}finally{dh=i,M.p=n,R.T=s}}Oh=3}}function gc(){if(4===Oh||3===Oh){Oh=0,rt();var t=Fh,e=Nh,s=Bh,n=Vh;10256&e.subtreeFlags||10256&e.flags?Oh=5:(Oh=0,Nh=Fh=null,_c(t,t.pendingLanes));var i=t.pendingLanes;if(0===i&&(kh=null),Ot(s),e=e.stateNode,gt&&"function"==typeof gt.onCommitFiberRoot)try{gt.onCommitFiberRoot(mt,e,void 0,!(128&~e.current.flags))}catch(t){}if(null!==n){e=R.T,i=M.p,M.p=2,R.T=null;try{for(var r=t.onRecoverableError,a=0;a<n.length;a++){var o=n[a];r(o.value,{componentStack:o.stack})}}finally{R.T=e,M.p=i}}3&Bh&&vc(),Mc(t),i=t.pendingLanes,261930&s&&42&i?t===Gh?Hh++:(Hh=0,Gh=t):Hh=0,kc(0)}}function _c(t,e){0===(t.pooledCacheLanes&=e)&&(null!=(e=t.pooledCache)&&(t.pooledCache=null,Bi(e)))}function vc(){return pc(),mc(),gc(),yc()}function yc(){if(5!==Oh)return!1;var t=Fh,e=zh;zh=0;var s=Ot(Bh),i=R.T,r=M.p;try{M.p=32>s?32:s,R.T=null,s=Uh,Uh=null;var a=Fh,o=Bh;if(Oh=0,Nh=Fh=null,Bh=0,6&dh)throw Error(n(331));var l=dh;if(dh|=4,ah(a.current),Zl(a,a.current,o,s),dh=l,kc(0),gt&&"function"==typeof gt.onPostCommitFiberRoot)try{gt.onPostCommitFiberRoot(mt,a)}catch(t){}return!0}finally{M.p=r,R.T=i,_c(t,e)}}function bc(t,e,s){e=$n(s,e),null!==(t=_r(t,e=Ao(t.stateNode,e,2),2))&&(Lt(t,2),Mc(t))}function Sc(t,e,s){if(3===t.tag)bc(t,t,s);else for(;null!==e;){if(3===e.tag){bc(e,t,s);break}if(1===e.tag){var n=e.stateNode;if("function"==typeof e.type.getDerivedStateFromError||"function"==typeof n.componentDidCatch&&(null===kh||!kh.has(n))){t=$n(s,t),null!==(n=_r(e,s=Do(2),2))&&(Po(s,n,e,t),Lt(n,2),Mc(n));break}}e=e.return}}function xc(t,e,s){var n=t.pingCache;if(null===n){n=t.pingCache=new ch;var i=new Set;n.set(e,i)}else void 0===(i=n.get(e))&&(i=new Set,n.set(e,i));i.has(s)||(yh=!0,i.add(s),t=wc.bind(null,t,e,s),e.then(t,t))}function wc(t,e,s){var n=t.pingCache;null!==n&&n.delete(e),t.pingedLanes|=t.suspendedLanes&s,t.warmLanes&=~s,uh===t&&(ph&s)===s&&(4===Sh||3===Sh&&(62914560&ph)===ph&&300>at()-Lh?!(2&dh)&&Jh(t,0):Th|=s,Eh===ph&&(Eh=0)),Mc(t)}function Tc(t,e){0===e&&(e=Dt()),null!==(t=In(t,e))&&(Lt(t,e),Mc(t))}function Cc(t){var e=t.memoizedState,s=0;null!==e&&(s=e.retryLane),Tc(t,s)}function Ec(t,e){var s=0;switch(t.tag){case 31:case 13:var i=t.stateNode,r=t.memoizedState;null!==r&&(s=r.retryLane);break;case 19:i=t.stateNode;break;case 22:i=t.stateNode._retryCache;break;default:throw Error(n(314))}null!==i&&i.delete(e),Tc(t,s)}var Ac=null,Dc=null,Pc=!1,Lc=!1,Ic=!1,Rc=0;function Mc(t){t!==Dc&&null===t.next&&(null===Dc?Ac=Dc=t:Dc=Dc.next=t),Lc=!0,Pc||(Pc=!0,xd(function(){6&dh?st(lt,Oc):Fc()}))}function kc(t,e){if(!Ic&&Lc){Ic=!0;do{for(var s=!1,n=Ac;null!==n;){if(0!==t){var i=n.pendingLanes;if(0===i)var r=0;else{var a=n.suspendedLanes,o=n.pingedLanes;r=(1<<31-vt(42|t)+1)-1,r=201326741&(r&=i&~(a&~o))?201326741&r|1:r?2|r:0}0!==r&&(s=!0,zc(n,r))}else r=ph,!(3&(r=Ct(n,n===uh?r:0,null!==n.cancelPendingCommit||-1!==n.timeoutHandle)))||Et(n,r)||(s=!0,zc(n,r));n=n.next}}while(s);Ic=!1}}function Oc(){Fc()}function Fc(){Lc=Pc=!1;var t=0;0!==Rc&&function(){var t=window.event;if(t&&"popstate"===t.type)return t!==vd&&(vd=t,!0);return vd=null,!1}()&&(t=Rc);for(var e=at(),s=null,n=Ac;null!==n;){var i=n.next,r=Nc(n,e);0===r?(n.next=null,null===s?Ac=i:s.next=i,null===i&&(Dc=s)):(s=n,(0!==t||3&r)&&(Lc=!0)),n=i}0!==Oh&&5!==Oh||kc(t),0!==Rc&&(Rc=0)}function Nc(t,e){for(var s=t.suspendedLanes,n=t.pingedLanes,i=t.expirationTimes,r=-62914561&t.pendingLanes;0<r;){var a=31-vt(r),o=1<<a,l=i[a];-1===l?0!==(o&s)&&0===(o&n)||(i[a]=At(o,e)):l<=e&&(t.expiredLanes|=o),r&=~o}if(s=ph,s=Ct(t,t===(e=uh)?s:0,null!==t.cancelPendingCommit||-1!==t.timeoutHandle),n=t.callbackNode,0===s||t===e&&(2===mh||9===mh)||null!==t.cancelPendingCommit)return null!==n&&null!==n&&nt(n),t.callbackNode=null,t.callbackPriority=0;if(!(3&s)||Et(t,s)){if((e=s&-s)===t.callbackPriority)return e;switch(null!==n&&nt(n),Ot(s)){case 2:case 8:s=ht;break;case 32:default:s=ct;break;case 268435456:s=ut}return n=Bc.bind(null,t),s=st(s,n),t.callbackPriority=e,t.callbackNode=s,e}return null!==n&&null!==n&&nt(n),t.callbackPriority=2,t.callbackNode=null,2}function Bc(t,e){if(0!==Oh&&5!==Oh)return t.callbackNode=null,t.callbackPriority=0,null;var s=t.callbackNode;if(vc()&&t.callbackNode!==s)return null;var n=ph;return 0===(n=Ct(t,t===uh?n:0,null!==t.cancelPendingCommit||-1!==t.timeoutHandle))?null:(Xh(t,n,e),Nc(t,at()),null!=t.callbackNode&&t.callbackNode===s?Bc.bind(null,t):null)}function zc(t,e){if(vc())return null;Xh(t,e,!0)}function Uc(){if(0===Rc){var t=Vi;0===t&&(t=St,!(261888&(St<<=1))&&(St=256)),Rc=t}return Rc}function Vc(t){return null==t||"symbol"==typeof t||"boolean"==typeof t?null:"function"==typeof t?t:Pe(""+t)}function Hc(t,e){var s=e.ownerDocument.createElement("input");return s.name=e.name,s.value=e.value,t.id&&s.setAttribute("form",t.id),e.parentNode.insertBefore(s,e),t=new FormData(t),s.parentNode.removeChild(s),t}for(var Gc=0;Gc<xn.length;Gc++){var Wc=xn[Gc];wn(Wc.toLowerCase(),"on"+(Wc[0].toUpperCase()+Wc.slice(1)))}wn(pn,"onAnimationEnd"),wn(mn,"onAnimationIteration"),wn(gn,"onAnimationStart"),wn("dblclick","onDoubleClick"),wn("focusin","onFocus"),wn("focusout","onBlur"),wn(_n,"onTransitionRun"),wn(vn,"onTransitionStart"),wn(yn,"onTransitionCancel"),wn(bn,"onTransitionEnd"),se("onMouseEnter",["mouseout","mouseover"]),se("onMouseLeave",["mouseout","mouseover"]),se("onPointerEnter",["pointerout","pointerover"]),se("onPointerLeave",["pointerout","pointerover"]),ee("onChange","change click focusin focusout input keydown keyup selectionchange".split(" ")),ee("onSelect","focusout contextmenu dragend focusin keydown keyup mousedown mouseup selectionchange".split(" ")),ee("onBeforeInput",["compositionend","keypress","textInput","paste"]),ee("onCompositionEnd","compositionend focusout keydown keypress keyup mousedown".split(" ")),ee("onCompositionStart","compositionstart focusout keydown keypress keyup mousedown".split(" ")),ee("onCompositionUpdate","compositionupdate focusout keydown keypress keyup mousedown".split(" "));var jc="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange resize seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),$c=new Set("beforetoggle cancel close invalid load scroll scrollend toggle".split(" ").concat(jc));function Xc(t,e){e=!!(4&e);for(var s=0;s<t.length;s++){var n=t[s],i=n.event;n=n.listeners;t:{var r=void 0;if(e)for(var a=n.length-1;0<=a;a--){var o=n[a],l=o.instance,h=o.currentTarget;if(o=o.listener,l!==r&&i.isPropagationStopped())break t;r=o,i.currentTarget=h;try{r(i)}catch(t){Tn(t)}i.currentTarget=null,r=l}else for(a=0;a<n.length;a++){if(l=(o=n[a]).instance,h=o.currentTarget,o=o.listener,l!==r&&i.isPropagationStopped())break t;r=o,i.currentTarget=h;try{r(i)}catch(t){Tn(t)}i.currentTarget=null,r=l}}}}function qc(t,e){var s=e[Ht];void 0===s&&(s=e[Ht]=new Set);var n=t+"__bubble";s.has(n)||(Zc(e,t,2,!1),s.add(n))}function Kc(t,e,s){var n=0;e&&(n|=4),Zc(s,t,n,e)}var Yc="_reactListening"+Math.random().toString(36).slice(2);function Qc(t){if(!t[Yc]){t[Yc]=!0,Jt.forEach(function(e){"selectionchange"!==e&&($c.has(e)||Kc(e,!1,t),Kc(e,!0,t))});var e=9===t.nodeType?t:t.ownerDocument;null===e||e[Yc]||(e[Yc]=!0,Kc("selectionchange",!1,e))}}function Zc(t,e,s,n){switch(Tu(e)){case 2:var i=vu;break;case 8:i=yu;break;default:i=bu}s=i.bind(null,e,s,t),i=void 0,!Ue||"touchstart"!==e&&"touchmove"!==e&&"wheel"!==e||(i=!0),n?void 0!==i?t.addEventListener(e,s,{capture:!0,passive:i}):t.addEventListener(e,s,!0):void 0!==i?t.addEventListener(e,s,{passive:i}):t.addEventListener(e,s,!1)}function Jc(t,e,s,n,i){var a=n;if(!(1&e||2&e||null===n))t:for(;;){if(null===n)return;var o=n.tag;if(3===o||4===o){var l=n.stateNode.containerInfo;if(l===i)break;if(4===o)for(o=n.return;null!==o;){var h=o.tag;if((3===h||4===h)&&o.stateNode.containerInfo===i)return;o=o.return}for(;null!==l;){if(null===(o=qt(l)))return;if(5===(h=o.tag)||6===h||26===h||27===h){n=a=o;continue t}l=l.parentNode}}n=n.return}Ne(function(){var n=a,i=Re(s),o=[];t:{var l=Sn.get(t);if(void 0!==l){var h=ts,c=t;switch(t){case"keypress":if(0===$e(s))break t;case"keydown":case"keyup":h=ms;break;case"focusin":c="focus",h=as;break;case"focusout":c="blur",h=as;break;case"beforeblur":case"afterblur":h=as;break;case"click":if(2===s.button)break t;case"auxclick":case"dblclick":case"mousedown":case"mousemove":case"mouseup":case"mouseout":case"mouseover":case"contextmenu":h=is;break;case"drag":case"dragend":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"dragstart":case"drop":h=rs;break;case"touchcancel":case"touchend":case"touchmove":case"touchstart":h=_s;break;case pn:case mn:case gn:h=os;break;case bn:h=vs;break;case"scroll":case"scrollend":h=ss;break;case"wheel":h=ys;break;case"copy":case"cut":case"paste":h=ls;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":case"pointerdown":case"pointermove":case"pointerout":case"pointerover":case"pointerup":h=gs;break;case"toggle":case"beforetoggle":h=bs}var d=!!(4&e),u=!d&&("scroll"===t||"scrollend"===t),f=d?null!==l?l+"Capture":null:l;d=[];for(var p,m=n;null!==m;){var g=m;if(p=g.stateNode,5!==(g=g.tag)&&26!==g&&27!==g||null===p||null===f||null!=(g=Be(m,f))&&d.push(td(m,g,p)),u)break;m=m.return}0<d.length&&(l=new h(l,c,null,s,i),o.push({event:l,listeners:d}))}}if(!(7&e)){if(h="mouseout"===t||"pointerout"===t,(!(l="mouseover"===t||"pointerover"===t)||s===Ie||!(c=s.relatedTarget||s.fromElement)||!qt(c)&&!c[Vt])&&(h||l)&&(l=i.window===i?i:(l=i.ownerDocument)?l.defaultView||l.parentWindow:window,h?(h=n,null!==(c=(c=s.relatedTarget||s.toElement)?qt(c):null)&&(u=r(c),d=c.tag,c!==u||5!==d&&27!==d&&6!==d)&&(c=null)):(h=null,c=n),h!==c)){if(d=is,g="onMouseLeave",f="onMouseEnter",m="mouse","pointerout"!==t&&"pointerover"!==t||(d=gs,g="onPointerLeave",f="onPointerEnter",m="pointer"),u=null==h?l:Yt(h),p=null==c?l:Yt(c),(l=new d(g,m+"leave",h,s,i)).target=u,l.relatedTarget=p,g=null,qt(i)===n&&((d=new d(f,m+"enter",c,s,i)).target=p,d.relatedTarget=u,g=d),u=g,h&&c)t:{for(d=sd,m=c,p=0,g=f=h;g;g=d(g))p++;g=0;for(var _=m;_;_=d(_))g++;for(;0<p-g;)f=d(f),p--;for(;0<g-p;)m=d(m),g--;for(;p--;){if(f===m||null!==m&&f===m.alternate){d=f;break t}f=d(f),m=d(m)}d=null}else d=null;null!==h&&nd(o,l,h,d,!1),null!==c&&null!==u&&nd(o,u,c,d,!0)}if("select"===(h=(l=n?Yt(n):window).nodeName&&l.nodeName.toLowerCase())||"input"===h&&"file"===l.type)var v=Bs;else if(Rs(l))if(zs)v=qs;else{v=$s;var y=js}else!(h=l.nodeName)||"input"!==h.toLowerCase()||"checkbox"!==l.type&&"radio"!==l.type?n&&Ee(n.elementType)&&(v=Bs):v=Xs;switch(v&&(v=v(t,n))?Ms(o,v,s,i):(y&&y(t,l,n),"focusout"===t&&n&&"number"===l.type&&null!=n.memoizedProps.value&&ve(l,"number",l.value)),y=n?Yt(n):window,t){case"focusin":(Rs(y)||"true"===y.contentEditable)&&(nn=y,rn=n,an=null);break;case"focusout":an=rn=nn=null;break;case"mousedown":on=!0;break;case"contextmenu":case"mouseup":case"dragend":on=!1,ln(o,s,i);break;case"selectionchange":if(sn)break;case"keydown":case"keyup":ln(o,s,i)}var b;if(xs)t:{switch(t){case"compositionstart":var S="onCompositionStart";break t;case"compositionend":S="onCompositionEnd";break t;case"compositionupdate":S="onCompositionUpdate";break t}S=void 0}else Ls?Ds(t,s)&&(S="onCompositionEnd"):"keydown"===t&&229===s.keyCode&&(S="onCompositionStart");S&&(Cs&&"ko"!==s.locale&&(Ls||"onCompositionStart"!==S?"onCompositionEnd"===S&&Ls&&(b=je()):(Ge="value"in(He=i)?He.value:He.textContent,Ls=!0)),0<(y=ed(n,S)).length&&(S=new hs(S,t,null,s,i),o.push({event:S,listeners:y}),b?S.data=b:null!==(b=Ps(s))&&(S.data=b))),(b=Ts?function(t,e){switch(t){case"compositionend":return Ps(e);case"keypress":return 32!==e.which?null:(As=!0,Es);case"textInput":return(t=e.data)===Es&&As?null:t;default:return null}}(t,s):function(t,e){if(Ls)return"compositionend"===t||!xs&&Ds(t,e)?(t=je(),We=Ge=He=null,Ls=!1,t):null;switch(t){case"paste":default:return null;case"keypress":if(!(e.ctrlKey||e.altKey||e.metaKey)||e.ctrlKey&&e.altKey){if(e.char&&1<e.char.length)return e.char;if(e.which)return String.fromCharCode(e.which)}return null;case"compositionend":return Cs&&"ko"!==e.locale?null:e.data}}(t,s))&&(0<(S=ed(n,"onBeforeInput")).length&&(y=new hs("onBeforeInput","beforeinput",null,s,i),o.push({event:y,listeners:S}),y.data=b)),function(t,e,s,n,i){if("submit"===e&&s&&s.stateNode===i){var r=Vc((i[Ut]||null).action),a=n.submitter;a&&null!==(e=(e=a[Ut]||null)?Vc(e.formAction):a.getAttribute("formAction"))&&(r=e,a=null);var o=new ts("action","action",null,n,i);t.push({event:o,listeners:[{instance:null,listener:function(){if(n.defaultPrevented){if(0!==Rc){var t=a?Hc(i,a):new FormData(i);Za(s,{pending:!0,data:t,method:i.method,action:r},null,t)}}else"function"==typeof r&&(o.preventDefault(),t=a?Hc(i,a):new FormData(i),Za(s,{pending:!0,data:t,method:i.method,action:r},r,t))},currentTarget:i}]})}}(o,t,n,s,i)}Xc(o,e)})}function td(t,e,s){return{instance:t,listener:e,currentTarget:s}}function ed(t,e){for(var s=e+"Capture",n=[];null!==t;){var i=t,r=i.stateNode;if(5!==(i=i.tag)&&26!==i&&27!==i||null===r||(null!=(i=Be(t,s))&&n.unshift(td(t,i,r)),null!=(i=Be(t,e))&&n.push(td(t,i,r))),3===t.tag)return n;t=t.return}return[]}function sd(t){if(null===t)return null;do{t=t.return}while(t&&5!==t.tag&&27!==t.tag);return t||null}function nd(t,e,s,n,i){for(var r=e._reactName,a=[];null!==s&&s!==n;){var o=s,l=o.alternate,h=o.stateNode;if(o=o.tag,null!==l&&l===n)break;5!==o&&26!==o&&27!==o||null===h||(l=h,i?null!=(h=Be(s,r))&&a.unshift(td(s,h,l)):i||null!=(h=Be(s,r))&&a.push(td(s,h,l))),s=s.return}0!==a.length&&t.push({event:e,listeners:a})}var id=/\r\n?/g,rd=/\u0000|\uFFFD/g;function ad(t){return("string"==typeof t?t:""+t).replace(id,"\n").replace(rd,"")}function od(t,e){return e=ad(e),ad(t)===e}function ld(t,e,s,i,r,a){switch(s){case"children":"string"==typeof i?"body"===e||"textarea"===e&&""===i||xe(t,i):("number"==typeof i||"bigint"==typeof i)&&"body"!==e&&xe(t,""+i);break;case"className":oe(t,"class",i);break;case"tabIndex":oe(t,"tabindex",i);break;case"dir":case"role":case"viewBox":case"width":case"height":oe(t,s,i);break;case"style":Ce(t,i,a);break;case"data":if("object"!==e){oe(t,"data",i);break}case"src":case"href":if(""===i&&("a"!==e||"href"!==s)){t.removeAttribute(s);break}if(null==i||"function"==typeof i||"symbol"==typeof i||"boolean"==typeof i){t.removeAttribute(s);break}i=Pe(""+i),t.setAttribute(s,i);break;case"action":case"formAction":if("function"==typeof i){t.setAttribute(s,"javascript:throw new Error('A React form was unexpectedly submitted. If you called form.submit() manually, consider using form.requestSubmit() instead. If you\\'re trying to use event.stopPropagation() in a submit event handler, consider also calling event.preventDefault().')");break}if("function"==typeof a&&("formAction"===s?("input"!==e&&ld(t,e,"name",r.name,r,null),ld(t,e,"formEncType",r.formEncType,r,null),ld(t,e,"formMethod",r.formMethod,r,null),ld(t,e,"formTarget",r.formTarget,r,null)):(ld(t,e,"encType",r.encType,r,null),ld(t,e,"method",r.method,r,null),ld(t,e,"target",r.target,r,null))),null==i||"symbol"==typeof i||"boolean"==typeof i){t.removeAttribute(s);break}i=Pe(""+i),t.setAttribute(s,i);break;case"onClick":null!=i&&(t.onclick=Le);break;case"onScroll":null!=i&&qc("scroll",t);break;case"onScrollEnd":null!=i&&qc("scrollend",t);break;case"dangerouslySetInnerHTML":if(null!=i){if("object"!=typeof i||!("__html"in i))throw Error(n(61));if(null!=(s=i.__html)){if(null!=r.children)throw Error(n(60));t.innerHTML=s}}break;case"multiple":t.multiple=i&&"function"!=typeof i&&"symbol"!=typeof i;break;case"muted":t.muted=i&&"function"!=typeof i&&"symbol"!=typeof i;break;case"suppressContentEditableWarning":case"suppressHydrationWarning":case"defaultValue":case"defaultChecked":case"innerHTML":case"ref":case"autoFocus":break;case"xlinkHref":if(null==i||"function"==typeof i||"boolean"==typeof i||"symbol"==typeof i){t.removeAttribute("xlink:href");break}s=Pe(""+i),t.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",s);break;case"contentEditable":case"spellCheck":case"draggable":case"value":case"autoReverse":case"externalResourcesRequired":case"focusable":case"preserveAlpha":null!=i&&"function"!=typeof i&&"symbol"!=typeof i?t.setAttribute(s,""+i):t.removeAttribute(s);break;case"inert":case"allowFullScreen":case"async":case"autoPlay":case"controls":case"default":case"defer":case"disabled":case"disablePictureInPicture":case"disableRemotePlayback":case"formNoValidate":case"hidden":case"loop":case"noModule":case"noValidate":case"open":case"playsInline":case"readOnly":case"required":case"reversed":case"scoped":case"seamless":case"itemScope":i&&"function"!=typeof i&&"symbol"!=typeof i?t.setAttribute(s,""):t.removeAttribute(s);break;case"capture":case"download":!0===i?t.setAttribute(s,""):!1!==i&&null!=i&&"function"!=typeof i&&"symbol"!=typeof i?t.setAttribute(s,i):t.removeAttribute(s);break;case"cols":case"rows":case"size":case"span":null!=i&&"function"!=typeof i&&"symbol"!=typeof i&&!isNaN(i)&&1<=i?t.setAttribute(s,i):t.removeAttribute(s);break;case"rowSpan":case"start":null==i||"function"==typeof i||"symbol"==typeof i||isNaN(i)?t.removeAttribute(s):t.setAttribute(s,i);break;case"popover":qc("beforetoggle",t),qc("toggle",t),ae(t,"popover",i);break;case"xlinkActuate":le(t,"http://www.w3.org/1999/xlink","xlink:actuate",i);break;case"xlinkArcrole":le(t,"http://www.w3.org/1999/xlink","xlink:arcrole",i);break;case"xlinkRole":le(t,"http://www.w3.org/1999/xlink","xlink:role",i);break;case"xlinkShow":le(t,"http://www.w3.org/1999/xlink","xlink:show",i);break;case"xlinkTitle":le(t,"http://www.w3.org/1999/xlink","xlink:title",i);break;case"xlinkType":le(t,"http://www.w3.org/1999/xlink","xlink:type",i);break;case"xmlBase":le(t,"http://www.w3.org/XML/1998/namespace","xml:base",i);break;case"xmlLang":le(t,"http://www.w3.org/XML/1998/namespace","xml:lang",i);break;case"xmlSpace":le(t,"http://www.w3.org/XML/1998/namespace","xml:space",i);break;case"is":ae(t,"is",i);break;case"innerText":case"textContent":break;default:(!(2<s.length)||"o"!==s[0]&&"O"!==s[0]||"n"!==s[1]&&"N"!==s[1])&&ae(t,s=Ae.get(s)||s,i)}}function hd(t,e,s,i,r,a){switch(s){case"style":Ce(t,i,a);break;case"dangerouslySetInnerHTML":if(null!=i){if("object"!=typeof i||!("__html"in i))throw Error(n(61));if(null!=(s=i.__html)){if(null!=r.children)throw Error(n(60));t.innerHTML=s}}break;case"children":"string"==typeof i?xe(t,i):("number"==typeof i||"bigint"==typeof i)&&xe(t,""+i);break;case"onScroll":null!=i&&qc("scroll",t);break;case"onScrollEnd":null!=i&&qc("scrollend",t);break;case"onClick":null!=i&&(t.onclick=Le);break;case"suppressContentEditableWarning":case"suppressHydrationWarning":case"innerHTML":case"ref":case"innerText":case"textContent":break;default:te.hasOwnProperty(s)||("o"!==s[0]||"n"!==s[1]||(r=s.endsWith("Capture"),e=s.slice(2,r?s.length-7:void 0),"function"==typeof(a=null!=(a=t[Ut]||null)?a[s]:null)&&t.removeEventListener(e,a,r),"function"!=typeof i)?s in t?t[s]=i:!0===i?t.setAttribute(s,""):ae(t,s,i):("function"!=typeof a&&null!==a&&(s in t?t[s]=null:t.hasAttribute(s)&&t.removeAttribute(s)),t.addEventListener(e,i,r)))}}function cd(t,e,s){switch(e){case"div":case"span":case"svg":case"path":case"a":case"g":case"p":case"li":break;case"img":qc("error",t),qc("load",t);var i,r=!1,a=!1;for(i in s)if(s.hasOwnProperty(i)){var o=s[i];if(null!=o)switch(i){case"src":r=!0;break;case"srcSet":a=!0;break;case"children":case"dangerouslySetInnerHTML":throw Error(n(137,e));default:ld(t,e,i,o,s,null)}}return a&&ld(t,e,"srcSet",s.srcSet,s,null),void(r&&ld(t,e,"src",s.src,s,null));case"input":qc("invalid",t);var l=i=o=a=null,h=null,c=null;for(r in s)if(s.hasOwnProperty(r)){var d=s[r];if(null!=d)switch(r){case"name":a=d;break;case"type":o=d;break;case"checked":h=d;break;case"defaultChecked":c=d;break;case"value":i=d;break;case"defaultValue":l=d;break;case"children":case"dangerouslySetInnerHTML":if(null!=d)throw Error(n(137,e));break;default:ld(t,e,r,d,s,null)}}return void _e(t,i,l,h,c,o,a,!1);case"select":for(a in qc("invalid",t),r=o=i=null,s)if(s.hasOwnProperty(a)&&null!=(l=s[a]))switch(a){case"value":i=l;break;case"defaultValue":o=l;break;case"multiple":r=l;default:ld(t,e,a,l,s,null)}return e=i,s=o,t.multiple=!!r,void(null!=e?ye(t,!!r,e,!1):null!=s&&ye(t,!!r,s,!0));case"textarea":for(o in qc("invalid",t),i=a=r=null,s)if(s.hasOwnProperty(o)&&null!=(l=s[o]))switch(o){case"value":r=l;break;case"defaultValue":a=l;break;case"children":i=l;break;case"dangerouslySetInnerHTML":if(null!=l)throw Error(n(91));break;default:ld(t,e,o,l,s,null)}return void Se(t,r,a,i);case"option":for(h in s)if(s.hasOwnProperty(h)&&null!=(r=s[h]))if("selected"===h)t.selected=r&&"function"!=typeof r&&"symbol"!=typeof r;else ld(t,e,h,r,s,null);return;case"dialog":qc("beforetoggle",t),qc("toggle",t),qc("cancel",t),qc("close",t);break;case"iframe":case"object":qc("load",t);break;case"video":case"audio":for(r=0;r<jc.length;r++)qc(jc[r],t);break;case"image":qc("error",t),qc("load",t);break;case"details":qc("toggle",t);break;case"embed":case"source":case"link":qc("error",t),qc("load",t);case"area":case"base":case"br":case"col":case"hr":case"keygen":case"meta":case"param":case"track":case"wbr":case"menuitem":for(c in s)if(s.hasOwnProperty(c)&&null!=(r=s[c]))switch(c){case"children":case"dangerouslySetInnerHTML":throw Error(n(137,e));default:ld(t,e,c,r,s,null)}return;default:if(Ee(e)){for(d in s)s.hasOwnProperty(d)&&(void 0!==(r=s[d])&&hd(t,e,d,r,s,void 0));return}}for(l in s)s.hasOwnProperty(l)&&(null!=(r=s[l])&&ld(t,e,l,r,s,null))}function dd(t){switch(t){case"css":case"script":case"font":case"img":case"image":case"input":case"link":return!0;default:return!1}}var ud=null,fd=null;function pd(t){return 9===t.nodeType?t:t.ownerDocument}function md(t){switch(t){case"http://www.w3.org/2000/svg":return 1;case"http://www.w3.org/1998/Math/MathML":return 2;default:return 0}}function gd(t,e){if(0===t)switch(e){case"svg":return 1;case"math":return 2;default:return 0}return 1===t&&"foreignObject"===e?0:t}function _d(t,e){return"textarea"===t||"noscript"===t||"string"==typeof e.children||"number"==typeof e.children||"bigint"==typeof e.children||"object"==typeof e.dangerouslySetInnerHTML&&null!==e.dangerouslySetInnerHTML&&null!=e.dangerouslySetInnerHTML.__html}var vd=null;var yd="function"==typeof setTimeout?setTimeout:void 0,bd="function"==typeof clearTimeout?clearTimeout:void 0,Sd="function"==typeof Promise?Promise:void 0,xd="function"==typeof queueMicrotask?queueMicrotask:void 0!==Sd?function(t){return Sd.resolve(null).then(t).catch(wd)}:yd;function wd(t){setTimeout(function(){throw t})}function Td(t){return"head"===t}function Cd(t,e){var s=e,n=0;do{var i=s.nextSibling;if(t.removeChild(s),i&&8===i.nodeType)if("/$"===(s=i.data)||"/&"===s){if(0===n)return t.removeChild(i),void Hu(e);n--}else if("$"===s||"$?"===s||"$~"===s||"$!"===s||"&"===s)n++;else if("html"===s)Fd(t.ownerDocument.documentElement);else if("head"===s){Fd(s=t.ownerDocument.head);for(var r=s.firstChild;r;){var a=r.nextSibling,o=r.nodeName;r[$t]||"SCRIPT"===o||"STYLE"===o||"LINK"===o&&"stylesheet"===r.rel.toLowerCase()||s.removeChild(r),r=a}}else"body"===s&&Fd(t.ownerDocument.body);s=i}while(s);Hu(e)}function Ed(t,e){var s=t;t=0;do{var n=s.nextSibling;if(1===s.nodeType?e?(s._stashedDisplay=s.style.display,s.style.display="none"):(s.style.display=s._stashedDisplay||"",""===s.getAttribute("style")&&s.removeAttribute("style")):3===s.nodeType&&(e?(s._stashedText=s.nodeValue,s.nodeValue=""):s.nodeValue=s._stashedText||""),n&&8===n.nodeType)if("/$"===(s=n.data)){if(0===t)break;t--}else"$"!==s&&"$?"!==s&&"$~"!==s&&"$!"!==s||t++;s=n}while(s)}function Ad(t){var e=t.firstChild;for(e&&10===e.nodeType&&(e=e.nextSibling);e;){var s=e;switch(e=e.nextSibling,s.nodeName){case"HTML":case"HEAD":case"BODY":Ad(s),Xt(s);continue;case"SCRIPT":case"STYLE":continue;case"LINK":if("stylesheet"===s.rel.toLowerCase())continue}t.removeChild(s)}}function Dd(t,e){for(;8!==t.nodeType;){if((1!==t.nodeType||"INPUT"!==t.nodeName||"hidden"!==t.type)&&!e)return null;if(null===(t=Id(t.nextSibling)))return null}return t}function Pd(t){return"$?"===t.data||"$~"===t.data}function Ld(t){return"$!"===t.data||"$?"===t.data&&"loading"!==t.ownerDocument.readyState}function Id(t){for(;null!=t;t=t.nextSibling){var e=t.nodeType;if(1===e||3===e)break;if(8===e){if("$"===(e=t.data)||"$!"===e||"$?"===e||"$~"===e||"&"===e||"F!"===e||"F"===e)break;if("/$"===e||"/&"===e)return null}}return t}var Rd=null;function Md(t){t=t.nextSibling;for(var e=0;t;){if(8===t.nodeType){var s=t.data;if("/$"===s||"/&"===s){if(0===e)return Id(t.nextSibling);e--}else"$"!==s&&"$!"!==s&&"$?"!==s&&"$~"!==s&&"&"!==s||e++}t=t.nextSibling}return null}function kd(t){t=t.previousSibling;for(var e=0;t;){if(8===t.nodeType){var s=t.data;if("$"===s||"$!"===s||"$?"===s||"$~"===s||"&"===s){if(0===e)return t;e--}else"/$"!==s&&"/&"!==s||e++}t=t.previousSibling}return null}function Od(t,e,s){switch(e=pd(s),t){case"html":if(!(t=e.documentElement))throw Error(n(452));return t;case"head":if(!(t=e.head))throw Error(n(453));return t;case"body":if(!(t=e.body))throw Error(n(454));return t;default:throw Error(n(451))}}function Fd(t){for(var e=t.attributes;e.length;)t.removeAttributeNode(e[0]);Xt(t)}var Nd=new Map,Bd=new Set;function zd(t){return"function"==typeof t.getRootNode?t.getRootNode():9===t.nodeType?t:t.ownerDocument}var Ud=M.d;M.d={f:function(){var t=Ud.f(),e=Qh();return t||e},r:function(t){var e=Kt(t);null!==e&&5===e.tag&&"form"===e.type?to(e):Ud.r(t)},D:function(t){Ud.D(t),Hd("dns-prefetch",t,null)},C:function(t,e){Ud.C(t,e),Hd("preconnect",t,e)},L:function(t,e,s){Ud.L(t,e,s);var n=Vd;if(n&&t&&e){var i='link[rel="preload"][as="'+me(e)+'"]';"image"===e&&s&&s.imageSrcSet?(i+='[imagesrcset="'+me(s.imageSrcSet)+'"]',"string"==typeof s.imageSizes&&(i+='[imagesizes="'+me(s.imageSizes)+'"]')):i+='[href="'+me(t)+'"]';var r=i;switch(e){case"style":r=Wd(t);break;case"script":r=Xd(t)}Nd.has(r)||(t=d({rel:"preload",href:"image"===e&&s&&s.imageSrcSet?void 0:t,as:e},s),Nd.set(r,t),null!==n.querySelector(i)||"style"===e&&n.querySelector(jd(r))||"script"===e&&n.querySelector(qd(r))||(cd(e=n.createElement("link"),"link",t),Zt(e),n.head.appendChild(e)))}},m:function(t,e){Ud.m(t,e);var s=Vd;if(s&&t){var n=e&&"string"==typeof e.as?e.as:"script",i='link[rel="modulepreload"][as="'+me(n)+'"][href="'+me(t)+'"]',r=i;switch(n){case"audioworklet":case"paintworklet":case"serviceworker":case"sharedworker":case"worker":case"script":r=Xd(t)}if(!Nd.has(r)&&(t=d({rel:"modulepreload",href:t},e),Nd.set(r,t),null===s.querySelector(i))){switch(n){case"audioworklet":case"paintworklet":case"serviceworker":case"sharedworker":case"worker":case"script":if(s.querySelector(qd(r)))return}cd(n=s.createElement("link"),"link",t),Zt(n),s.head.appendChild(n)}}},X:function(t,e){Ud.X(t,e);var s=Vd;if(s&&t){var n=Qt(s).hoistableScripts,i=Xd(t),r=n.get(i);r||((r=s.querySelector(qd(i)))||(t=d({src:t,async:!0},e),(e=Nd.get(i))&&Zd(t,e),Zt(r=s.createElement("script")),cd(r,"link",t),s.head.appendChild(r)),r={type:"script",instance:r,count:1,state:null},n.set(i,r))}},S:function(t,e,s){Ud.S(t,e,s);var n=Vd;if(n&&t){var i=Qt(n).hoistableStyles,r=Wd(t);e=e||"default";var a=i.get(r);if(!a){var o={loading:0,preload:null};if(a=n.querySelector(jd(r)))o.loading=5;else{t=d({rel:"stylesheet",href:t,"data-precedence":e},s),(s=Nd.get(r))&&Qd(t,s);var l=a=n.createElement("link");Zt(l),cd(l,"link",t),l._p=new Promise(function(t,e){l.onload=t,l.onerror=e}),l.addEventListener("load",function(){o.loading|=1}),l.addEventListener("error",function(){o.loading|=2}),o.loading|=4,Yd(a,e,n)}a={type:"stylesheet",instance:a,count:1,state:o},i.set(r,a)}}},M:function(t,e){Ud.M(t,e);var s=Vd;if(s&&t){var n=Qt(s).hoistableScripts,i=Xd(t),r=n.get(i);r||((r=s.querySelector(qd(i)))||(t=d({src:t,async:!0,type:"module"},e),(e=Nd.get(i))&&Zd(t,e),Zt(r=s.createElement("script")),cd(r,"link",t),s.head.appendChild(r)),r={type:"script",instance:r,count:1,state:null},n.set(i,r))}}};var Vd="undefined"==typeof document?null:document;function Hd(t,e,s){var n=Vd;if(n&&"string"==typeof e&&e){var i=me(e);i='link[rel="'+t+'"][href="'+i+'"]',"string"==typeof s&&(i+='[crossorigin="'+s+'"]'),Bd.has(i)||(Bd.add(i),t={rel:t,crossOrigin:s,href:e},null===n.querySelector(i)&&(cd(e=n.createElement("link"),"link",t),Zt(e),n.head.appendChild(e)))}}function Gd(t,e,s,i){var r,a,o,l,h=(h=W.current)?zd(h):null;if(!h)throw Error(n(446));switch(t){case"meta":case"title":return null;case"style":return"string"==typeof s.precedence&&"string"==typeof s.href?(e=Wd(s.href),(i=(s=Qt(h).hoistableStyles).get(e))||(i={type:"style",instance:null,count:0,state:null},s.set(e,i)),i):{type:"void",instance:null,count:0,state:null};case"link":if("stylesheet"===s.rel&&"string"==typeof s.href&&"string"==typeof s.precedence){t=Wd(s.href);var c=Qt(h).hoistableStyles,d=c.get(t);if(d||(h=h.ownerDocument||h,d={type:"stylesheet",instance:null,count:0,state:{loading:0,preload:null}},c.set(t,d),(c=h.querySelector(jd(t)))&&!c._p&&(d.instance=c,d.state.loading=5),Nd.has(t)||(s={rel:"preload",as:"style",href:s.href,crossOrigin:s.crossOrigin,integrity:s.integrity,media:s.media,hrefLang:s.hrefLang,referrerPolicy:s.referrerPolicy},Nd.set(t,s),c||(r=h,a=t,o=s,l=d.state,r.querySelector('link[rel="preload"][as="style"]['+a+"]")?l.loading=1:(a=r.createElement("link"),l.preload=a,a.addEventListener("load",function(){return l.loading|=1}),a.addEventListener("error",function(){return l.loading|=2}),cd(a,"link",o),Zt(a),r.head.appendChild(a))))),e&&null===i)throw Error(n(528,""));return d}if(e&&null!==i)throw Error(n(529,""));return null;case"script":return e=s.async,"string"==typeof(s=s.src)&&e&&"function"!=typeof e&&"symbol"!=typeof e?(e=Xd(s),(i=(s=Qt(h).hoistableScripts).get(e))||(i={type:"script",instance:null,count:0,state:null},s.set(e,i)),i):{type:"void",instance:null,count:0,state:null};default:throw Error(n(444,t))}}function Wd(t){return'href="'+me(t)+'"'}function jd(t){return'link[rel="stylesheet"]['+t+"]"}function $d(t){return d({},t,{"data-precedence":t.precedence,precedence:null})}function Xd(t){return'[src="'+me(t)+'"]'}function qd(t){return"script[async]"+t}function Kd(t,e,s){if(e.count++,null===e.instance)switch(e.type){case"style":var i=t.querySelector('style[data-href~="'+me(s.href)+'"]');if(i)return e.instance=i,Zt(i),i;var r=d({},s,{"data-href":s.href,"data-precedence":s.precedence,href:null,precedence:null});return Zt(i=(t.ownerDocument||t).createElement("style")),cd(i,"style",r),Yd(i,s.precedence,t),e.instance=i;case"stylesheet":r=Wd(s.href);var a=t.querySelector(jd(r));if(a)return e.state.loading|=4,e.instance=a,Zt(a),a;i=$d(s),(r=Nd.get(r))&&Qd(i,r),Zt(a=(t.ownerDocument||t).createElement("link"));var o=a;return o._p=new Promise(function(t,e){o.onload=t,o.onerror=e}),cd(a,"link",i),e.state.loading|=4,Yd(a,s.precedence,t),e.instance=a;case"script":return a=Xd(s.src),(r=t.querySelector(qd(a)))?(e.instance=r,Zt(r),r):(i=s,(r=Nd.get(a))&&Zd(i=d({},s),r),Zt(r=(t=t.ownerDocument||t).createElement("script")),cd(r,"link",i),t.head.appendChild(r),e.instance=r);case"void":return null;default:throw Error(n(443,e.type))}else"stylesheet"===e.type&&!(4&e.state.loading)&&(i=e.instance,e.state.loading|=4,Yd(i,s.precedence,t));return e.instance}function Yd(t,e,s){for(var n=s.querySelectorAll('link[rel="stylesheet"][data-precedence],style[data-precedence]'),i=n.length?n[n.length-1]:null,r=i,a=0;a<n.length;a++){var o=n[a];if(o.dataset.precedence===e)r=o;else if(r!==i)break}r?r.parentNode.insertBefore(t,r.nextSibling):(e=9===s.nodeType?s.head:s).insertBefore(t,e.firstChild)}function Qd(t,e){null==t.crossOrigin&&(t.crossOrigin=e.crossOrigin),null==t.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),null==t.title&&(t.title=e.title)}function Zd(t,e){null==t.crossOrigin&&(t.crossOrigin=e.crossOrigin),null==t.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),null==t.integrity&&(t.integrity=e.integrity)}var Jd=null;function tu(t,e,s){if(null===Jd){var n=new Map,i=Jd=new Map;i.set(s,n)}else(n=(i=Jd).get(s))||(n=new Map,i.set(s,n));if(n.has(t))return n;for(n.set(t,null),s=s.getElementsByTagName(t),i=0;i<s.length;i++){var r=s[i];if(!(r[$t]||r[zt]||"link"===t&&"stylesheet"===r.getAttribute("rel"))&&"http://www.w3.org/2000/svg"!==r.namespaceURI){var a=r.getAttribute(e)||"";a=t+a;var o=n.get(a);o?o.push(r):n.set(a,[r])}}return n}function eu(t,e,s){(t=t.ownerDocument||t).head.insertBefore(s,"title"===e?t.querySelector("head > title"):null)}function su(t){return!!("stylesheet"!==t.type||3&t.state.loading)}var nu=0;function iu(){if(this.count--,0===this.count&&(0===this.imgCount||!this.waitingForImages))if(this.stylesheets)au(this,this.stylesheets);else if(this.unsuspend){var t=this.unsuspend;this.unsuspend=null,t()}}var ru=null;function au(t,e){t.stylesheets=null,null!==t.unsuspend&&(t.count++,ru=new Map,e.forEach(ou,t),ru=null,iu.call(t))}function ou(t,e){if(!(4&e.state.loading)){var s=ru.get(t);if(s)var n=s.get(null);else{s=new Map,ru.set(t,s);for(var i=t.querySelectorAll("link[data-precedence],style[data-precedence]"),r=0;r<i.length;r++){var a=i[r];"LINK"!==a.nodeName&&"not all"===a.getAttribute("media")||(s.set(a.dataset.precedence,a),n=a)}n&&s.set(null,n)}a=(i=e.instance).getAttribute("data-precedence"),(r=s.get(a)||n)===n&&s.set(null,i),s.set(a,i),this.count++,n=iu.bind(this),i.addEventListener("load",n),i.addEventListener("error",n),r?r.parentNode.insertBefore(i,r.nextSibling):(t=9===t.nodeType?t.head:t).insertBefore(i,t.firstChild),e.state.loading|=4}}var lu={$$typeof:y,Provider:null,Consumer:null,_currentValue:k,_currentValue2:k,_threadCount:0};function hu(t,e,s,n,i,r,a,o,l){this.tag=1,this.containerInfo=t,this.pingCache=this.current=this.pendingChildren=null,this.timeoutHandle=-1,this.callbackNode=this.next=this.pendingContext=this.context=this.cancelPendingCommit=null,this.callbackPriority=0,this.expirationTimes=Pt(-1),this.entangledLanes=this.shellSuspendCounter=this.errorRecoveryDisabledLanes=this.expiredLanes=this.warmLanes=this.pingedLanes=this.suspendedLanes=this.pendingLanes=0,this.entanglements=Pt(0),this.hiddenUpdates=Pt(null),this.identifierPrefix=n,this.onUncaughtError=i,this.onCaughtError=r,this.onRecoverableError=a,this.pooledCache=null,this.pooledCacheLanes=0,this.formState=l,this.incompleteTransitions=new Map}function cu(t,e,s,n,i,r,a,o,l,h,c,d){return t=new hu(t,e,s,a,l,h,c,d,o),e=1,!0===r&&(e|=24),r=Fn(3,null,null,e),t.current=r,r.stateNode=t,(e=Ni()).refCount++,t.pooledCache=e,e.refCount++,r.memoizedState={element:n,isDehydrated:s,cache:e},pr(r),t}function du(t){return t?t=kn:kn}function uu(t,e,s,n,i,r){i=du(i),null===n.context?n.context=i:n.pendingContext=i,(n=gr(e)).payload={element:s},null!==(r=void 0===r?null:r)&&(n.callback=r),null!==(s=_r(t,n,e))&&($h(s,0,e),vr(s,t,e))}function fu(t,e){if(null!==(t=t.memoizedState)&&null!==t.dehydrated){var s=t.retryLane;t.retryLane=0!==s&&s<e?s:e}}function pu(t,e){fu(t,e),(t=t.alternate)&&fu(t,e)}function mu(t){if(13===t.tag||31===t.tag){var e=In(t,67108864);null!==e&&$h(e,0,67108864),pu(t,67108864)}}function gu(t){if(13===t.tag||31===t.tag){var e=Wh(),s=In(t,e=kt(e));null!==s&&$h(s,0,e),pu(t,e)}}var _u=!0;function vu(t,e,s,n){var i=R.T;R.T=null;var r=M.p;try{M.p=2,bu(t,e,s,n)}finally{M.p=r,R.T=i}}function yu(t,e,s,n){var i=R.T;R.T=null;var r=M.p;try{M.p=8,bu(t,e,s,n)}finally{M.p=r,R.T=i}}function bu(t,e,s,n){if(_u){var i=Su(n);if(null===i)Jc(t,e,n,xu,s),Mu(t,n);else if(function(t,e,s,n,i){switch(e){case"focusin":return Eu=ku(Eu,t,e,s,n,i),!0;case"dragenter":return Au=ku(Au,t,e,s,n,i),!0;case"mouseover":return Du=ku(Du,t,e,s,n,i),!0;case"pointerover":var r=i.pointerId;return Pu.set(r,ku(Pu.get(r)||null,t,e,s,n,i)),!0;case"gotpointercapture":return r=i.pointerId,Lu.set(r,ku(Lu.get(r)||null,t,e,s,n,i)),!0}return!1}(i,t,e,s,n))n.stopPropagation();else if(Mu(t,n),4&e&&-1<Ru.indexOf(t)){for(;null!==i;){var r=Kt(i);if(null!==r)switch(r.tag){case 3:if((r=r.stateNode).current.memoizedState.isDehydrated){var a=Tt(r.pendingLanes);if(0!==a){var o=r;for(o.pendingLanes|=2,o.entangledLanes|=2;a;){var l=1<<31-vt(a);o.entanglements[1]|=l,a&=~l}Mc(r),!(6&dh)&&(Rh=at()+500,kc(0))}}break;case 31:case 13:null!==(o=In(r,2))&&$h(o,0,2),Qh(),pu(r,2)}if(null===(r=Su(n))&&Jc(t,e,n,xu,s),r===i)break;i=r}null!==i&&n.stopPropagation()}else Jc(t,e,n,null,s)}}function Su(t){return wu(t=Re(t))}var xu=null;function wu(t){if(xu=null,null!==(t=qt(t))){var e=r(t);if(null===e)t=null;else{var s=e.tag;if(13===s){if(null!==(t=a(e)))return t;t=null}else if(31===s){if(null!==(t=o(e)))return t;t=null}else if(3===s){if(e.stateNode.current.memoizedState.isDehydrated)return 3===e.tag?e.stateNode.containerInfo:null;t=null}else e!==t&&(t=null)}}return xu=t,null}function Tu(t){switch(t){case"beforetoggle":case"cancel":case"click":case"close":case"contextmenu":case"copy":case"cut":case"auxclick":case"dblclick":case"dragend":case"dragstart":case"drop":case"focusin":case"focusout":case"input":case"invalid":case"keydown":case"keypress":case"keyup":case"mousedown":case"mouseup":case"paste":case"pause":case"play":case"pointercancel":case"pointerdown":case"pointerup":case"ratechange":case"reset":case"resize":case"seeked":case"submit":case"toggle":case"touchcancel":case"touchend":case"touchstart":case"volumechange":case"change":case"selectionchange":case"textInput":case"compositionstart":case"compositionend":case"compositionupdate":case"beforeblur":case"afterblur":case"beforeinput":case"blur":case"fullscreenchange":case"focus":case"hashchange":case"popstate":case"select":case"selectstart":return 2;case"drag":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"mousemove":case"mouseout":case"mouseover":case"pointermove":case"pointerout":case"pointerover":case"scroll":case"touchmove":case"wheel":case"mouseenter":case"mouseleave":case"pointerenter":case"pointerleave":return 8;case"message":switch(ot()){case lt:return 2;case ht:return 8;case ct:case dt:return 32;case ut:return 268435456;default:return 32}default:return 32}}var Cu=!1,Eu=null,Au=null,Du=null,Pu=new Map,Lu=new Map,Iu=[],Ru="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput copy cut paste click change contextmenu reset".split(" ");function Mu(t,e){switch(t){case"focusin":case"focusout":Eu=null;break;case"dragenter":case"dragleave":Au=null;break;case"mouseover":case"mouseout":Du=null;break;case"pointerover":case"pointerout":Pu.delete(e.pointerId);break;case"gotpointercapture":case"lostpointercapture":Lu.delete(e.pointerId)}}function ku(t,e,s,n,i,r){return null===t||t.nativeEvent!==r?(t={blockedOn:e,domEventName:s,eventSystemFlags:n,nativeEvent:r,targetContainers:[i]},null!==e&&(null!==(e=Kt(e))&&mu(e)),t):(t.eventSystemFlags|=n,e=t.targetContainers,null!==i&&-1===e.indexOf(i)&&e.push(i),t)}function Ou(t){var e=qt(t.target);if(null!==e){var s=r(e);if(null!==s)if(13===(e=s.tag)){if(null!==(e=a(s)))return t.blockedOn=e,void Nt(t.priority,function(){gu(s)})}else if(31===e){if(null!==(e=o(s)))return t.blockedOn=e,void Nt(t.priority,function(){gu(s)})}else if(3===e&&s.stateNode.current.memoizedState.isDehydrated)return void(t.blockedOn=3===s.tag?s.stateNode.containerInfo:null)}t.blockedOn=null}function Fu(t){if(null!==t.blockedOn)return!1;for(var e=t.targetContainers;0<e.length;){var s=Su(t.nativeEvent);if(null!==s)return null!==(e=Kt(s))&&mu(e),t.blockedOn=s,!1;var n=new(s=t.nativeEvent).constructor(s.type,s);Ie=n,s.target.dispatchEvent(n),Ie=null,e.shift()}return!0}function Nu(t,e,s){Fu(t)&&s.delete(e)}function Bu(){Cu=!1,null!==Eu&&Fu(Eu)&&(Eu=null),null!==Au&&Fu(Au)&&(Au=null),null!==Du&&Fu(Du)&&(Du=null),Pu.forEach(Nu),Lu.forEach(Nu)}function zu(e,s){e.blockedOn===s&&(e.blockedOn=null,Cu||(Cu=!0,t.unstable_scheduleCallback(t.unstable_NormalPriority,Bu)))}var Uu=null;function Vu(e){Uu!==e&&(Uu=e,t.unstable_scheduleCallback(t.unstable_NormalPriority,function(){Uu===e&&(Uu=null);for(var t=0;t<e.length;t+=3){var s=e[t],n=e[t+1],i=e[t+2];if("function"!=typeof n){if(null===wu(n||s))continue;break}var r=Kt(s);null!==r&&(e.splice(t,3),t-=3,Za(r,{pending:!0,data:i,method:s.method,action:n},n,i))}}))}function Hu(t){function e(e){return zu(e,t)}null!==Eu&&zu(Eu,t),null!==Au&&zu(Au,t),null!==Du&&zu(Du,t),Pu.forEach(e),Lu.forEach(e);for(var s=0;s<Iu.length;s++){var n=Iu[s];n.blockedOn===t&&(n.blockedOn=null)}for(;0<Iu.length&&null===(s=Iu[0]).blockedOn;)Ou(s),null===s.blockedOn&&Iu.shift();if(null!=(s=(t.ownerDocument||t).$$reactFormReplay))for(n=0;n<s.length;n+=3){var i=s[n],r=s[n+1],a=i[Ut]||null;if("function"==typeof r)a||Vu(s);else if(a){var o=null;if(r&&r.hasAttribute("formAction")){if(i=r,a=r[Ut]||null)o=a.formAction;else if(null!==wu(i))continue}else o=a.action;"function"==typeof o?s[n+1]=o:(s.splice(n,3),n-=3),Vu(s)}}}function Gu(){function t(t){t.canIntercept&&"react-transition"===t.info&&t.intercept({handler:function(){return new Promise(function(t){return i=t})},focusReset:"manual",scroll:"manual"})}function e(){null!==i&&(i(),i=null),n||setTimeout(s,20)}function s(){if(!n&&!navigation.transition){var t=navigation.currentEntry;t&&null!=t.url&&navigation.navigate(t.url,{state:t.getState(),info:"react-transition",history:"replace"})}}if("object"==typeof navigation){var n=!1,i=null;return navigation.addEventListener("navigate",t),navigation.addEventListener("navigatesuccess",e),navigation.addEventListener("navigateerror",e),setTimeout(s,100),function(){n=!0,navigation.removeEventListener("navigate",t),navigation.removeEventListener("navigatesuccess",e),navigation.removeEventListener("navigateerror",e),null!==i&&(i(),i=null)}}}function Wu(t){this._internalRoot=t}function ju(t){this._internalRoot=t}ju.prototype.render=Wu.prototype.render=function(t){var e=this._internalRoot;if(null===e)throw Error(n(409));uu(e.current,Wh(),t,e,null,null)},ju.prototype.unmount=Wu.prototype.unmount=function(){var t=this._internalRoot;if(null!==t){this._internalRoot=null;var e=t.containerInfo;uu(t.current,2,null,t,null,null),Qh(),e[Vt]=null}},ju.prototype.unstable_scheduleHydration=function(t){if(t){var e=Ft();t={blockedOn:null,target:t,priority:e};for(var s=0;s<Iu.length&&0!==e&&e<Iu[s].priority;s++);Iu.splice(s,0,t),0===s&&Ou(t)}};var $u=e.version;if("19.2.3"!==$u)throw Error(n(527,$u,"19.2.3"));M.findDOMNode=function(t){var e=t._reactInternals;if(void 0===e){if("function"==typeof t.render)throw Error(n(188));throw t=Object.keys(t).join(","),Error(n(268,t))}return t=function(t){var e=t.alternate;if(!e){if(null===(e=r(t)))throw Error(n(188));return e!==t?null:t}for(var s=t,i=e;;){var a=s.return;if(null===a)break;var o=a.alternate;if(null===o){if(null!==(i=a.return)){s=i;continue}break}if(a.child===o.child){for(o=a.child;o;){if(o===s)return l(a),t;if(o===i)return l(a),e;o=o.sibling}throw Error(n(188))}if(s.return!==i.return)s=a,i=o;else{for(var h=!1,c=a.child;c;){if(c===s){h=!0,s=a,i=o;break}if(c===i){h=!0,i=a,s=o;break}c=c.sibling}if(!h){for(c=o.child;c;){if(c===s){h=!0,s=o,i=a;break}if(c===i){h=!0,i=o,s=a;break}c=c.sibling}if(!h)throw Error(n(189))}}if(s.alternate!==i)throw Error(n(190))}if(3!==s.tag)throw Error(n(188));return s.stateNode.current===s?t:e}(e),t=null===(t=null!==t?h(t):null)?null:t.stateNode};var Xu={bundleType:0,version:"19.2.3",rendererPackageName:"react-dom",currentDispatcherRef:R,reconcilerVersion:"19.2.3"};if("undefined"!=typeof __REACT_DEVTOOLS_GLOBAL_HOOK__){var qu=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(!qu.isDisabled&&qu.supportsFiber)try{mt=qu.inject(Xu),gt=qu}catch(t){}}return mT.createRoot=function(t,e){if(!i(t))throw Error(n(299));var s=!1,r="",a=xo,o=wo,l=To;return null!=e&&(!0===e.unstable_strictMode&&(s=!0),void 0!==e.identifierPrefix&&(r=e.identifierPrefix),void 0!==e.onUncaughtError&&(a=e.onUncaughtError),void 0!==e.onCaughtError&&(o=e.onCaughtError),void 0!==e.onRecoverableError&&(l=e.onRecoverableError)),e=cu(t,1,!1,null,0,s,r,null,a,o,l,Gu),t[Vt]=e.current,Qc(t),new Wu(e)},mT.hydrateRoot=function(t,e,s){if(!i(t))throw Error(n(299));var r=!1,a="",o=xo,l=wo,h=To,c=null;return null!=s&&(!0===s.unstable_strictMode&&(r=!0),void 0!==s.identifierPrefix&&(a=s.identifierPrefix),void 0!==s.onUncaughtError&&(o=s.onUncaughtError),void 0!==s.onCaughtError&&(l=s.onCaughtError),void 0!==s.onRecoverableError&&(h=s.onRecoverableError),void 0!==s.formState&&(c=s.formState)),(e=cu(t,1,!0,e,0,r,a,c,o,l,h,Gu)).context=du(null),s=e.current,(a=gr(r=kt(r=Wh()))).callback=null,_r(s,a,r),s=r,e.current.lanes=s,Lt(e,s),Mc(e),t[Vt]=e.current,Qc(t),new ju(e)},mT.version="19.2.3",mT}function ST(){if(uT)return pT.exports;return uT=1,function t(){if("undefined"!=typeof __REACT_DEVTOOLS_GLOBAL_HOOK__&&"function"==typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE)try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(t)}catch(t){console.error(t)}}(),pT.exports=bT(),pT.exports}var xT=ST();const wT=t=>u.createElement(jt,{class:"pcui-error",title:"Error",hidden:!t.observerData.ui.error,text:t.observerData.ui.error,icon:"E218"}),TT=(t,e,s=2)=>{let n,i;const r=t=>{n=t.pageX,i=t.pageY};t.addEventListener("mousedown",r);const a=t=>{const r=Math.abs(t.pageX-n),a=Math.abs(t.pageY-i);r<s&&a<s&&e(t)};return t.addEventListener("mouseup",a),()=>{t.removeEventListener("mousedown",r),t.removeEventListener("mouseup",a)}},CT=(t,e)=>{const s=(t,e)=>{for(const s of e){if(!t.hasOwnProperty(s))return null;t=t[s]}return t},n={};for(const i of e){const e=i.split("."),r=s(t,e);let a=n;for(let t=0;t<e.length;++t){const s=e[t];t<e.length-1?(a.hasOwnProperty(s)||(a[s]={}),a=a[s]):a[s]=r}}return n},ET=t=>u.createElement(vt,{class:"panel-option"},u.createElement($t,{class:"panel-label",text:t.label}),u.createElement($t,{class:"panel-value",text:String(t.value)})),AT=t=>u.createElement(vt,{class:"panel-option",enabled:t.enabled??!0},u.createElement($t,{class:"panel-label",text:t.label}),u.createElement(De,{class:"panel-value",dimensions:t.dimensions,value:t.value,precision:7})),DT=t=>u.createElement(vt,{class:"panel-option",enabled:t.enabled??!0},u.createElement($t,{class:"panel-label",text:t.label}),u.createElement(rt,{class:"panel-value-boolean",type:"toggle",value:t.value,onChange:e=>t.setProperty(e)})),PT=t=>u.createElement(vt,{class:"panel-option"},u.createElement($t,{class:"panel-label",text:t.label}),u.createElement(vt,{class:"panel-value"},u.createElement(rt,{type:"toggle",value:t.booleanValue,onChange:e=>t.setBooleanProperty(e)}),u.createElement(_t,{class:"panel-value-toggle-color",value:t.colorValue,onChange:e=>t.setColorProperty(e)}))),LT=t=>u.createElement(vt,{class:"panel-option",enabled:t.enabled??!0},u.createElement($t,{class:"panel-label",text:t.label}),u.createElement(ne,{class:"panel-value",min:t.min,max:t.max,sliderMin:t.min,sliderMax:t.max,precision:t.precision,step:t.step??.01,onChange:e=>{t.setProperty(e)},value:t.value})),IT=t=>u.createElement(vt,{class:"panel-option",enabled:t.enabled??!0},u.createElement($t,{class:"panel-label",text:t.label}),u.createElement(Xt,{class:"panel-value",min:t.min,max:t.max,onChange:e=>{t.setProperty(e)},value:t.value})),RT=t=>u.createElement(vt,{class:"panel-option",hidden:t.hidden,enabled:t.enabled??!0},u.createElement($t,{class:"panel-label",text:t.label}),u.createElement(_t,{class:"panel-value",value:t.value,onChange:e=>t.setProperty(e)})),MT=t=>u.createElement(vt,{class:"panel-option",enabled:t.enabled??!0},u.createElement($t,{class:"morph-label",flexGrow:"1",flexShrink:"1",text:t.label?t.label:t.name.substring(0,1).toUpperCase()+t.name.substring(1,t.name.length),flex:!0}),u.createElement(ne,{class:"morph-value",flexGrow:"0",flexShrink:"0",min:t.min,max:t.max,sliderMin:t.min,sliderMax:t.max,precision:t.precision,step:.01,onChange:e=>{t.setProperty(e)},value:t.value})),kT=t=>u.createElement(vt,{class:"panel-option",enabled:t.enabled??!0},u.createElement($t,{class:"panel-label",text:t.label}),u.createElement(Kt,{class:"panel-value",type:t.type,options:t.options,value:t.value,onChange:e=>{t.setProperty(e)}})),OT=t=>u.createElement(Kt,{id:t.id,class:t.class,width:t.width,type:t.type,options:t.options,enabled:t.enabled??!0,value:t.value,onChange:e=>{t.setProperty(e)}}),FT=t=>u.createElement(ne,{id:t.id,class:t.class,width:t.width,min:t.min,max:t.max,sliderMin:t.min,sliderMax:t.max,precision:t.precision,step:.01,enabled:t.enabled??!0,value:t.value,onChange:e=>{t.setProperty(e)}});var NT=Object.defineProperty,BT=(t,e,s)=>((t,e,s)=>e in t?NT(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s)(t,"symbol"!=typeof e?e+"":e,s),zT=new Map,UT=new WeakMap,VT=0;function HT(t){return Object.keys(t).sort().filter(e=>void 0!==t[e]).map(e=>{return`${e}_${"root"===e?(s=t.root,s?(UT.has(s)||(VT+=1,UT.set(s,VT.toString())),UT.get(s)):"0"):t[e]}`;var s}).toString()}function GT(t,e,s={},n=undefined){if(void 0===window.IntersectionObserver&&void 0!==n){const i=t.getBoundingClientRect();return e(n,{isIntersecting:n,target:t,intersectionRatio:"number"==typeof s.threshold?s.threshold:0,time:0,boundingClientRect:i,intersectionRect:i,rootBounds:i}),()=>{}}const{id:i,observer:r,elements:a}=function(t){const e=HT(t);let s=zT.get(e);if(!s){const n=new Map;let i;const r=new IntersectionObserver(e=>{e.forEach(e=>{var s;const r=e.isIntersecting&&i.some(t=>e.intersectionRatio>=t);t.trackVisibility&&void 0===e.isVisible&&(e.isVisible=r),null==(s=n.get(e.target))||s.forEach(t=>{t(r,e)})})},t);i=r.thresholds||(Array.isArray(t.threshold)?t.threshold:[t.threshold||0]),s={id:e,observer:r,elements:n},zT.set(e,s)}return s}(s),o=a.get(t)||[];return a.has(t)||a.set(t,o),o.push(e),r.observe(t),function(){o.splice(o.indexOf(e),1),0===o.length&&(a.delete(t),r.unobserve(t)),0===a.size&&(r.disconnect(),zT.delete(i))}}var WT=class extends d.Component{constructor(t){super(t),BT(this,"node",null),BT(this,"_unobserveCb",null),BT(this,"lastInView"),BT(this,"handleNode",t=>{this.node&&(this.unobserve(),t||this.props.triggerOnce||this.props.skip||(this.setState({inView:!!this.props.initialInView,entry:void 0}),this.lastInView=this.props.initialInView)),this.node=t||null,this.observeNode()}),BT(this,"handleChange",(t,e)=>{const s=this.lastInView;this.lastInView=t,(void 0!==s||t)&&(t&&this.props.triggerOnce&&this.unobserve(),function(t){return"function"!=typeof t.children}(this.props)||this.setState({inView:t,entry:e}),this.props.onChange&&this.props.onChange(t,e))}),this.state={inView:!!t.initialInView,entry:void 0},this.lastInView=t.initialInView}componentDidMount(){this.unobserve(),this.observeNode()}componentDidUpdate(t){t.rootMargin===this.props.rootMargin&&t.root===this.props.root&&t.threshold===this.props.threshold&&t.skip===this.props.skip&&t.trackVisibility===this.props.trackVisibility&&t.delay===this.props.delay||(this.unobserve(),this.observeNode())}componentWillUnmount(){this.unobserve()}observeNode(){if(!this.node||this.props.skip)return;const{threshold:t,root:e,rootMargin:s,trackVisibility:n,delay:i,fallbackInView:r}=this.props;void 0===this.lastInView&&(this.lastInView=this.props.initialInView),this._unobserveCb=GT(this.node,this.handleChange,{threshold:t,root:e,rootMargin:s,trackVisibility:n,delay:i},r)}unobserve(){this._unobserveCb&&(this._unobserveCb(),this._unobserveCb=null)}render(){const{children:t}=this.props;if("function"==typeof t){const{inView:e,entry:s}=this.state;return t({inView:e,entry:s,ref:this.handleNode})}const{as:e,triggerOnce:s,threshold:n,root:i,rootMargin:r,onChange:a,skip:o,trackVisibility:l,delay:h,initialInView:c,fallbackInView:u,...f}=this.props;return d.createElement(e||"div",{ref:this.handleNode,...f},t)}};class jT extends u.Component{shouldComponentUpdate(t){return JSON.stringify(t.morphs)!==JSON.stringify(this.props.morphs)}render(){const t=this.props.morphs;return t?u.createElement(qt,{headerText:"MORPH TARGETS",class:"scene-morph-panel",collapsible:!1},Object.keys(t).map(e=>{const s=t[e];return u.createElement("div",{key:`${e}.${s.name}`},u.createElement(qt,{headerText:s.name,collapsible:!0,class:"morph-target-panel"},Object.keys(s.targets).map(t=>{const n=s.targets[t];return u.createElement("div",{key:t},u.createElement(WT,{rootMargin:"750px 0px"},({inView:s,ref:i})=>u.createElement("div",{ref:i},s?u.createElement(MT,{name:`${n.name}`,precision:2,min:0,max:1,value:n.weight,setProperty:s=>this.props.setProperty(`morphs.${e}.targets.${t}.weight`,s)}):u.createElement("div",{style:{width:30,height:30}}))))})))})):null}}const $T=()=>{const t=document.getElementById("panel-left");t&&t.classList.toggle("collapsed")};let XT;const qT=t=>{const e=["Bytes","KB","MB","GB","TB"];if(0===t)return"n/a";const s=Math.min(Math.floor(Math.log(t)/Math.log(1024)),e.length-1);return 0===s?`${t} ${e[s]}`:`${(t/1024**s).toFixed(1)} ${e[s]}`};class KT extends u.Component{shouldComponentUpdate(t){return JSON.stringify(t.sceneData.filenames)!==JSON.stringify(this.props.sceneData.filenames)||t.sceneData.loadTime!==this.props.sceneData.loadTime||t.sceneData.meshCount!==this.props.sceneData.meshCount||t.sceneData.vertexCount!==this.props.sceneData.vertexCount||t.sceneData.primitiveCount!==this.props.sceneData.primitiveCount||t.sceneData.materialCount!==this.props.sceneData.materialCount||t.sceneData.textureVRAM!==this.props.sceneData.textureVRAM||t.sceneData.meshVRAM!==this.props.sceneData.meshVRAM||t.sceneData.bounds!==this.props.sceneData.bounds||t.sceneData.variant.selected!==this.props.sceneData.variant.selected||t.sceneData.variants.list!==this.props.sceneData.variants.list}render(){const t=this.props.sceneData,e=JSON.parse(t.variants.list).map(t=>({v:t,t:t}));return u.createElement(qt,{headerText:"SCENE",id:"scene-panel",flexShrink:"0",flexGrow:"0",collapsible:!1},u.createElement(ET,{label:"Filename",value:t.filenames.join(", ")}),u.createElement(ET,{label:"Meshes",value:t.meshCount}),u.createElement(ET,{label:"Materials",value:t.materialCount}),u.createElement(ET,{label:"Textures",value:t.textureCount}),u.createElement(ET,{label:"Primitives",value:t.primitiveCount}),u.createElement(ET,{label:"Verts",value:t.vertexCount}),u.createElement(ET,{label:"Mesh VRAM",value:qT(t.meshVRAM)}),u.createElement(ET,{label:"Texture VRAM",value:qT(t.textureVRAM)}),u.createElement(ET,{label:"Load time",value:t.loadTime}),u.createElement(AT,{label:"Bounds",dimensions:3,value:t.bounds,enabled:!1}),u.createElement(kT,{label:"Variant",type:"string",options:e,value:t.variant.selected,setProperty:t=>{this.props.setProperty("scene.variant.selected",t)},enabled:e.length>0}))}}class YT extends u.Component{shouldComponentUpdate(t){return t.sceneData.nodes!==this.props.sceneData.nodes}render(){const t=this.props.sceneData,e=JSON.parse(t.nodes),s=t=>t.map(t=>u.createElement(Ee,{text:`${t.name}`,key:t.path,onSelect:e=>{this.props.setProperty("scene.selectedNode.path",t.path);const s=TT(document.body,()=>{e.selected=!1,s()},4)},onDeselect:()=>this.props.setProperty("scene.selectedNode.path","")},s(t.children)));return u.createElement(qt,{headerText:"HIERARCHY",class:"scene-hierarchy-panel",enabled:e.length>0,collapsible:!1},e.length>0&&u.createElement(Ce,{allowReordering:!1,allowDrag:!1},s(e)))}}class QT extends u.Component{shouldComponentUpdate(t){return JSON.stringify(t.observerData.runtime)!==JSON.stringify(this.props.observerData.runtime)||t.observerData.enableWebGPU!==this.props.observerData.enableWebGPU}render(){const t=this.props.observerData.runtime;return u.createElement(qt,{headerText:"DEVICE",id:"device-panel",collapsible:!1},u.createElement(DT,{label:"Use WebGPU",value:this.props.observerData.enableWebGPU,enabled:void 0!==navigator.gpu,setProperty:t=>this.props.setProperty("enableWebGPU",t)}),u.createElement(ET,{label:"Active Device",value:"webgpu"===t.activeDeviceType?"webgpu (beta)":t.activeDeviceType}),u.createElement(ET,{label:"Viewport",value:`${t.viewportWidth} x ${t.viewportHeight}`}))}}class ZT extends u.Component{isMobile;constructor(t){super(t),this.isMobile=/Android|webOS|iPhone|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}shouldComponentUpdate(t){return JSON.stringify(t.observerData.scene)!==JSON.stringify(this.props.observerData.scene)||JSON.stringify(t.observerData.runtime)!==JSON.stringify(this.props.observerData.runtime)}componentDidMount(){document.getElementById("panel-toggle").addEventListener("click",()=>{$T()}),document.getElementById("title").addEventListener("click",()=>{$T()}),setTimeout(()=>$T())}componentDidUpdate(t){this.isMobile||this.props.observerData.ui.fullscreen||"[]"===this.props.observerData.scene.nodes||"[]"!==t.observerData.scene.nodes||(XT||(XT=document.getElementById("panel-left")),XT&&XT.classList.contains("collapsed")&&XT.classList.remove("collapsed"))}render(){const t=this.props.observerData.scene,e=this.props.observerData.morphs;return u.createElement(vt,{id:"scene-container",flex:!0},u.createElement(KT,{sceneData:t,setProperty:this.props.setProperty}),u.createElement("div",{id:"scene-scrolly-bits"},u.createElement(YT,{sceneData:t,setProperty:this.props.setProperty}),u.createElement(jT,{progress:this.props.observerData.animation.progress,morphs:e,setProperty:this.props.setProperty})),u.createElement(QT,{observerData:this.props.observerData,setProperty:this.props.setProperty}))}}var JT="5.7.0";const tC=t=>{const[e,s]=d.useState(!1),n=d.useRef(null);return u.createElement("div",{id:"load-controls"},u.createElement(vt,{class:"load-button-panel",enabled:!0,flex:!0},u.createElement("div",{className:"header"},u.createElement("img",{src:"static/playcanvas-logo.png"}),u.createElement("div",null,u.createElement($t,{text:`MODEL VIEWER v${JT}`})),u.createElement(at,{onClick:()=>{window.open("https://github.com/playcanvas/model-viewer","_blank").focus()},icon:"E259"})),u.createElement("input",{type:"file",id:"file",accept:".glb,.gltf,.ply",multiple:!0,onChange:t=>{const e=window.viewer,s=t.target.files;if(e&&s.length){const t=[];for(let e=0;e<s.length;++e){const n=s[e];t.push({url:URL.createObjectURL(n),filename:n.name})}e.loadFiles(t)}},ref:n,style:{display:"none"}}),u.createElement("div",{id:"drag-drop",onClick:()=>{n.current.click()}},u.createElement(at,{id:"drag-drop-search-icon",icon:"E129"}),u.createElement($t,{class:"desktop",text:"Drag & drop .glb, .gltf, or .ply files, or click to open files"}),u.createElement($t,{class:"mobile",text:"Click to open files"})),u.createElement($t,{id:"or-text",text:"OR",class:"centered-label"}),u.createElement(ae,{class:"secondary",id:"glb-url-input",placeholder:"Enter .glb, .gltf, or .ply URL",keyChange:!0,onValidate:t=>{const e=(t=>{try{return new URL(t),!0}catch{return!1}})(t);return s(e),e}}),u.createElement(at,{class:"secondary",id:"glb-url-button",text:"LOAD MODEL FROM URL",onClick:()=>{const t=window.viewer,e=document.getElementById("glb-url-input").ui.value,s=new URL(e).pathname.split("/").pop(),n=!!s.split(".").splice(1).pop();t.loadFiles([{url:e,filename:s+(n?"":".glb")}])},enabled:e})))};class eC extends u.Component{shouldComponentUpdate(t){return t.animationData.list!==this.props.animationData.list||t.animationData.playing!==this.props.animationData.playing||t.animationData.selectedTrack!==this.props.animationData.selectedTrack}render(){const t=this.props,e=JSON.parse(t.animationData.list).map(t=>({v:t,t:t}));return u.createElement(OT,{id:"anim-track-select",width:160,type:"string",options:e,setProperty:e=>t.setProperty("animation.selectedTrack",e),value:t.animationData.selectedTrack})}}class sC extends u.Component{shouldComponentUpdate(t){return t.animationData.speed!==this.props.animationData.speed}render(){const t=this.props;return u.createElement(OT,{id:"anim-speed-select",width:60,type:"string",setProperty:e=>t.setProperty("animation.speed",e),value:t.animationData.speed,options:[{v:"0.25",t:"0.25x"},{v:"0.5",t:"0.5x"},{v:"1",t:"1x"},{v:"1.5",t:"1.5x"},{v:"2",t:"2x"}]})}}class nC extends u.Component{animationState;shouldComponentUpdate(t){return JSON.stringify(t.animationData)!==JSON.stringify(this.props.animationData)}componentDidUpdate(){this.animationState=this.props.animationData}render(){const t=this.props;return JSON.parse(t.animationData.list).length>0?u.createElement("div",{className:"animation-controls-panel-parent"},u.createElement(at,{class:"anim-control-button",width:30,height:30,icon:t.animationData.playing?"E376":"E286",text:"",onClick:()=>{t.setProperty("animation.playing",!this.animationState.playing)}}),u.createElement(eC,{animationData:this.props.animationData,setProperty:this.props.setProperty}),u.createElement(FT,{id:"anim-scrub-slider",width:240,precision:2,min:0,max:1,setProperty:e=>{const s=this.animationState;s.playing=!1,s.progress=e,t.setProperty("animation",s)},value:t.animationData.progress}),u.createElement(sC,{animationData:this.props.animationData,setProperty:this.props.setProperty})):u.createElement("div",null)}}var iC,rC={exports:{}};function aC(){return iC||(iC=1,rC.exports=function(){var t=function(){},e=Object.prototype.hasOwnProperty,s=Array.prototype.slice;function n(e,s){var n;return"function"==typeof Object.create?n=Object.create(e):(t.prototype=e,n=new t,t.prototype=null),s&&r(!0,n,s),n}function i(t,e,s,i){var a=this;return"string"!=typeof t&&(i=s,s=e,e=t,t=null),"function"!=typeof e&&(i=s,s=e,e=function(){return a.apply(this,arguments)}),r(!1,e,a,i),e.prototype=n(a.prototype,s),e.prototype.constructor=e,e.class_=t||a.class_,e.super_=a,e}function r(t,n,i){for(var r,a,o=0,l=(i=s.call(arguments,2)).length;o<l;o++)for(r in a=i[o])t&&!e.call(a,r)||(n[r]=a[r])}var a=i;function o(){}o.class_="Nevis",o.super_=Object,o.extend=a;var l=o,h=l.extend(function(t,e,s){this.qrious=t,this.element=e,this.element.qrious=t,this.enabled=Boolean(s)},{draw:function(t){},getElement:function(){return this.enabled||(this.enabled=!0,this.render()),this.element},getModuleSize:function(t){var e=this.qrious,s=e.padding||0,n=Math.floor((e.size-2*s)/t.width);return Math.max(1,n)},getOffset:function(t){var e=this.qrious,s=e.padding;if(null!=s)return s;var n=this.getModuleSize(t),i=Math.floor((e.size-n*t.width)/2);return Math.max(0,i)},render:function(t){this.enabled&&(this.resize(),this.reset(),this.draw(t))},reset:function(){},resize:function(){}}),c=h,d=c.extend({draw:function(t){var e,s,n=this.qrious,i=this.getModuleSize(t),r=this.getOffset(t),a=this.element.getContext("2d");for(a.fillStyle=n.foreground,a.globalAlpha=n.foregroundAlpha,e=0;e<t.width;e++)for(s=0;s<t.width;s++)t.buffer[s*t.width+e]&&a.fillRect(i*e+r,i*s+r,i,i)},reset:function(){var t=this.qrious,e=this.element.getContext("2d"),s=t.size;e.lineWidth=1,e.clearRect(0,0,s,s),e.fillStyle=t.background,e.globalAlpha=t.backgroundAlpha,e.fillRect(0,0,s,s)},resize:function(){var t=this.element;t.width=t.height=this.qrious.size}}),u=d,f=l.extend(null,{BLOCK:[0,11,15,19,23,27,31,16,18,20,22,24,26,28,20,22,24,24,26,28,28,22,24,24,26,26,28,28,24,24,26,26,26,28,28,24,26,26,26,28,28]}),p=l.extend(null,{BLOCKS:[1,0,19,7,1,0,16,10,1,0,13,13,1,0,9,17,1,0,34,10,1,0,28,16,1,0,22,22,1,0,16,28,1,0,55,15,1,0,44,26,2,0,17,18,2,0,13,22,1,0,80,20,2,0,32,18,2,0,24,26,4,0,9,16,1,0,108,26,2,0,43,24,2,2,15,18,2,2,11,22,2,0,68,18,4,0,27,16,4,0,19,24,4,0,15,28,2,0,78,20,4,0,31,18,2,4,14,18,4,1,13,26,2,0,97,24,2,2,38,22,4,2,18,22,4,2,14,26,2,0,116,30,3,2,36,22,4,4,16,20,4,4,12,24,2,2,68,18,4,1,43,26,6,2,19,24,6,2,15,28,4,0,81,20,1,4,50,30,4,4,22,28,3,8,12,24,2,2,92,24,6,2,36,22,4,6,20,26,7,4,14,28,4,0,107,26,8,1,37,22,8,4,20,24,12,4,11,22,3,1,115,30,4,5,40,24,11,5,16,20,11,5,12,24,5,1,87,22,5,5,41,24,5,7,24,30,11,7,12,24,5,1,98,24,7,3,45,28,15,2,19,24,3,13,15,30,1,5,107,28,10,1,46,28,1,15,22,28,2,17,14,28,5,1,120,30,9,4,43,26,17,1,22,28,2,19,14,28,3,4,113,28,3,11,44,26,17,4,21,26,9,16,13,26,3,5,107,28,3,13,41,26,15,5,24,30,15,10,15,28,4,4,116,28,17,0,42,26,17,6,22,28,19,6,16,30,2,7,111,28,17,0,46,28,7,16,24,30,34,0,13,24,4,5,121,30,4,14,47,28,11,14,24,30,16,14,15,30,6,4,117,30,6,14,45,28,11,16,24,30,30,2,16,30,8,4,106,26,8,13,47,28,7,22,24,30,22,13,15,30,10,2,114,28,19,4,46,28,28,6,22,28,33,4,16,30,8,4,122,30,22,3,45,28,8,26,23,30,12,28,15,30,3,10,117,30,3,23,45,28,4,31,24,30,11,31,15,30,7,7,116,30,21,7,45,28,1,37,23,30,19,26,15,30,5,10,115,30,19,10,47,28,15,25,24,30,23,25,15,30,13,3,115,30,2,29,46,28,42,1,24,30,23,28,15,30,17,0,115,30,10,23,46,28,10,35,24,30,19,35,15,30,17,1,115,30,14,21,46,28,29,19,24,30,11,46,15,30,13,6,115,30,14,23,46,28,44,7,24,30,59,1,16,30,12,7,121,30,12,26,47,28,39,14,24,30,22,41,15,30,6,14,121,30,6,34,47,28,46,10,24,30,2,64,15,30,17,4,122,30,29,14,46,28,49,10,24,30,24,46,15,30,4,18,122,30,13,32,46,28,48,14,24,30,42,32,15,30,20,4,117,30,40,7,47,28,43,22,24,30,10,67,15,30,19,6,118,30,18,31,47,28,34,34,24,30,20,61,15,30],FINAL_FORMAT:[30660,29427,32170,30877,26159,25368,27713,26998,21522,20773,24188,23371,17913,16590,20375,19104,13663,12392,16177,14854,9396,8579,11994,11245,5769,5054,7399,6608,1890,597,3340,2107],LEVELS:{L:1,M:2,Q:3,H:4}}),m=l.extend(null,{EXPONENT:[1,2,4,8,16,32,64,128,29,58,116,232,205,135,19,38,76,152,45,90,180,117,234,201,143,3,6,12,24,48,96,192,157,39,78,156,37,74,148,53,106,212,181,119,238,193,159,35,70,140,5,10,20,40,80,160,93,186,105,210,185,111,222,161,95,190,97,194,153,47,94,188,101,202,137,15,30,60,120,240,253,231,211,187,107,214,177,127,254,225,223,163,91,182,113,226,217,175,67,134,17,34,68,136,13,26,52,104,208,189,103,206,129,31,62,124,248,237,199,147,59,118,236,197,151,51,102,204,133,23,46,92,184,109,218,169,79,158,33,66,132,21,42,84,168,77,154,41,82,164,85,170,73,146,57,114,228,213,183,115,230,209,191,99,198,145,63,126,252,229,215,179,123,246,241,255,227,219,171,75,150,49,98,196,149,55,110,220,165,87,174,65,130,25,50,100,200,141,7,14,28,56,112,224,221,167,83,166,81,162,89,178,121,242,249,239,195,155,43,86,172,69,138,9,18,36,72,144,61,122,244,245,247,243,251,235,203,139,11,22,44,88,176,125,250,233,207,131,27,54,108,216,173,71,142,0],LOG:[255,0,1,25,2,50,26,198,3,223,51,238,27,104,199,75,4,100,224,14,52,141,239,129,28,193,105,248,200,8,76,113,5,138,101,47,225,36,15,33,53,147,142,218,240,18,130,69,29,181,194,125,106,39,249,185,201,154,9,120,77,228,114,166,6,191,139,98,102,221,48,253,226,152,37,179,16,145,34,136,54,208,148,206,143,150,219,189,241,210,19,92,131,56,70,64,30,66,182,163,195,72,126,110,107,58,40,84,250,133,186,61,202,94,155,159,10,21,121,43,78,212,229,172,115,243,167,87,7,112,192,247,140,128,99,13,103,74,222,237,49,197,254,24,227,165,153,119,38,184,180,124,17,68,146,217,35,32,137,46,55,63,209,91,149,188,207,205,144,135,151,178,220,252,190,97,242,86,211,171,20,42,93,158,132,60,57,83,71,109,65,162,31,45,67,216,183,123,164,118,196,23,73,236,127,12,111,246,108,161,59,82,41,157,85,170,251,96,134,177,187,204,62,90,203,89,95,176,156,169,160,81,11,245,22,235,122,117,44,215,79,174,213,233,230,231,173,232,116,214,244,234,168,80,88,175]}),g=l.extend(null,{BLOCK:[3220,1468,2713,1235,3062,1890,2119,1549,2344,2936,1117,2583,1330,2470,1667,2249,2028,3780,481,4011,142,3098,831,3445,592,2517,1776,2234,1951,2827,1070,2660,1345,3177]}),_=g,v=l.extend(function(t){var e,s,n,i,r,a=t.value.length;for(this._badness=[],this._level=p.LEVELS[t.level],this._polynomial=[],this._value=t.value,this._version=0,this._stringBuffer=[];this._version<40&&(this._version++,n=4*(this._level-1)+16*(this._version-1),i=p.BLOCKS[n++],r=p.BLOCKS[n++],e=p.BLOCKS[n++],s=p.BLOCKS[n],!(a<=(n=e*(i+r)+r-3+(this._version<=9)))););this._dataBlock=e,this._eccBlock=s,this._neccBlock1=i,this._neccBlock2=r;var o=this.width=17+4*this._version;this.buffer=v._createArray(o*o),this._ecc=v._createArray(e+(e+s)*(i+r)+r),this._mask=v._createArray((o*(o+1)+1)/2),this._insertFinders(),this._insertAlignments(),this.buffer[8+o*(o-8)]=1,this._insertTimingGap(),this._reverseMask(),this._insertTimingRowAndColumn(),this._insertVersion(),this._syncMask(),this._convertBitStream(a),this._calculatePolynomial(),this._appendEccToData(),this._interleaveBlocks(),this._pack(),this._finish()},{_addAlignment:function(t,e){var s,n=this.buffer,i=this.width;for(n[t+i*e]=1,s=-2;s<2;s++)n[t+s+i*(e-2)]=1,n[t-2+i*(e+s+1)]=1,n[t+2+i*(e+s)]=1,n[t+s+1+i*(e+2)]=1;for(s=0;s<2;s++)this._setMask(t-1,e+s),this._setMask(t+1,e-s),this._setMask(t-s,e-1),this._setMask(t+s,e+1)},_appendData:function(t,e,s,n){var i,r,a,o=this._polynomial,l=this._stringBuffer;for(r=0;r<n;r++)l[s+r]=0;for(r=0;r<e;r++){if(255!==(i=m.LOG[l[t+r]^l[s]]))for(a=1;a<n;a++)l[s+a-1]=l[s+a]^m.EXPONENT[v._modN(i+o[n-a])];else for(a=s;a<s+n;a++)l[a]=l[a+1];l[s+n-1]=255===i?0:m.EXPONENT[v._modN(i+o[0])]}},_appendEccToData:function(){var t,e=0,s=this._dataBlock,n=this._calculateMaxLength(),i=this._eccBlock;for(t=0;t<this._neccBlock1;t++)this._appendData(e,s,n,i),e+=s,n+=i;for(t=0;t<this._neccBlock2;t++)this._appendData(e,s+1,n,i),e+=s+1,n+=i},_applyMask:function(t){var e,s,n,i,r=this.buffer,a=this.width;switch(t){case 0:for(i=0;i<a;i++)for(n=0;n<a;n++)n+i&1||this._isMasked(n,i)||(r[n+i*a]^=1);break;case 1:for(i=0;i<a;i++)for(n=0;n<a;n++)1&i||this._isMasked(n,i)||(r[n+i*a]^=1);break;case 2:for(i=0;i<a;i++)for(e=0,n=0;n<a;n++,e++)3===e&&(e=0),e||this._isMasked(n,i)||(r[n+i*a]^=1);break;case 3:for(s=0,i=0;i<a;i++,s++)for(3===s&&(s=0),e=s,n=0;n<a;n++,e++)3===e&&(e=0),e||this._isMasked(n,i)||(r[n+i*a]^=1);break;case 4:for(i=0;i<a;i++)for(e=0,s=i>>1&1,n=0;n<a;n++,e++)3===e&&(e=0,s=!s),s||this._isMasked(n,i)||(r[n+i*a]^=1);break;case 5:for(s=0,i=0;i<a;i++,s++)for(3===s&&(s=0),e=0,n=0;n<a;n++,e++)3===e&&(e=0),(n&i&1)+!(!e|!s)||this._isMasked(n,i)||(r[n+i*a]^=1);break;case 6:for(s=0,i=0;i<a;i++,s++)for(3===s&&(s=0),e=0,n=0;n<a;n++,e++)3===e&&(e=0),(n&i&1)+(e&&e===s)&1||this._isMasked(n,i)||(r[n+i*a]^=1);break;case 7:for(s=0,i=0;i<a;i++,s++)for(3===s&&(s=0),e=0,n=0;n<a;n++,e++)3===e&&(e=0),(e&&e===s)+(n+i&1)&1||this._isMasked(n,i)||(r[n+i*a]^=1)}},_calculateMaxLength:function(){return this._dataBlock*(this._neccBlock1+this._neccBlock2)+this._neccBlock2},_calculatePolynomial:function(){var t,e,s=this._eccBlock,n=this._polynomial;for(n[0]=1,t=0;t<s;t++){for(n[t+1]=1,e=t;e>0;e--)n[e]=n[e]?n[e-1]^m.EXPONENT[v._modN(m.LOG[n[e]]+t)]:n[e-1];n[0]=m.EXPONENT[v._modN(m.LOG[n[0]]+t)]}for(t=0;t<=s;t++)n[t]=m.LOG[n[t]]},_checkBadness:function(){var t,e,s,n,i,r=0,a=this._badness,o=this.buffer,l=this.width;for(i=0;i<l-1;i++)for(n=0;n<l-1;n++)(o[n+l*i]&&o[n+1+l*i]&&o[n+l*(i+1)]&&o[n+1+l*(i+1)]||!(o[n+l*i]||o[n+1+l*i]||o[n+l*(i+1)]||o[n+1+l*(i+1)]))&&(r+=v.N2);var h=0;for(i=0;i<l;i++){for(s=0,a[0]=0,t=0,n=0;n<l;n++)t===(e=o[n+l*i])?a[s]++:a[++s]=1,h+=(t=e)?1:-1;r+=this._getBadness(s)}h<0&&(h=-h);var c=0,d=h;for(d+=d<<2,d<<=1;d>l*l;)d-=l*l,c++;for(r+=c*v.N4,n=0;n<l;n++){for(s=0,a[0]=0,t=0,i=0;i<l;i++)t===(e=o[n+l*i])?a[s]++:a[++s]=1,t=e;r+=this._getBadness(s)}return r},_convertBitStream:function(t){var e,s,n=this._ecc,i=this._version;for(s=0;s<t;s++)n[s]=this._value.charCodeAt(s);var r=this._stringBuffer=n.slice(),a=this._calculateMaxLength();t>=a-2&&(t=a-2,i>9&&t--);var o=t;if(i>9){for(r[o+2]=0,r[o+3]=0;o--;)e=r[o],r[o+3]|=255&e<<4,r[o+2]=e>>4;r[2]|=255&t<<4,r[1]=t>>4,r[0]=64|t>>12}else{for(r[o+1]=0,r[o+2]=0;o--;)e=r[o],r[o+2]|=255&e<<4,r[o+1]=e>>4;r[1]|=255&t<<4,r[0]=64|t>>4}for(o=t+3-(i<10);o<a;)r[o++]=236,r[o++]=17},_getBadness:function(t){var e,s=0,n=this._badness;for(e=0;e<=t;e++)n[e]>=5&&(s+=v.N1+n[e]-5);for(e=3;e<t-1;e+=2)n[e-2]===n[e+2]&&n[e+2]===n[e-1]&&n[e-1]===n[e+1]&&3*n[e-1]===n[e]&&(0===n[e-3]||e+3>t||3*n[e-3]>=4*n[e]||3*n[e+3]>=4*n[e])&&(s+=v.N3);return s},_finish:function(){var t,e;this._stringBuffer=this.buffer.slice();var s=0,n=3e4;for(e=0;e<8&&(this._applyMask(e),(t=this._checkBadness())<n&&(n=t,s=e),7!==s);e++)this.buffer=this._stringBuffer.slice();s!==e&&this._applyMask(s),n=p.FINAL_FORMAT[s+(this._level-1<<3)];var i=this.buffer,r=this.width;for(e=0;e<8;e++,n>>=1)1&n&&(i[r-1-e+8*r]=1,e<6?i[8+r*e]=1:i[8+r*(e+1)]=1);for(e=0;e<7;e++,n>>=1)1&n&&(i[8+r*(r-7+e)]=1,e?i[6-e+8*r]=1:i[7+8*r]=1)},_interleaveBlocks:function(){var t,e,s=this._dataBlock,n=this._ecc,i=this._eccBlock,r=0,a=this._calculateMaxLength(),o=this._neccBlock1,l=this._neccBlock2,h=this._stringBuffer;for(t=0;t<s;t++){for(e=0;e<o;e++)n[r++]=h[t+e*s];for(e=0;e<l;e++)n[r++]=h[o*s+t+e*(s+1)]}for(e=0;e<l;e++)n[r++]=h[o*s+t+e*(s+1)];for(t=0;t<i;t++)for(e=0;e<o+l;e++)n[r++]=h[a+t+e*i];this._stringBuffer=n},_insertAlignments:function(){var t,e,s,n=this._version,i=this.width;if(n>1)for(t=f.BLOCK[n],s=i-7;;){for(e=i-7;e>t-3&&(this._addAlignment(e,s),!(e<t));)e-=t;if(s<=t+9)break;s-=t,this._addAlignment(6,s),this._addAlignment(s,6)}},_insertFinders:function(){var t,e,s,n,i=this.buffer,r=this.width;for(t=0;t<3;t++){for(e=0,n=0,1===t&&(e=r-7),2===t&&(n=r-7),i[n+3+r*(e+3)]=1,s=0;s<6;s++)i[n+s+r*e]=1,i[n+r*(e+s+1)]=1,i[n+6+r*(e+s)]=1,i[n+s+1+r*(e+6)]=1;for(s=1;s<5;s++)this._setMask(n+s,e+1),this._setMask(n+1,e+s+1),this._setMask(n+5,e+s),this._setMask(n+s+1,e+5);for(s=2;s<4;s++)i[n+s+r*(e+2)]=1,i[n+2+r*(e+s+1)]=1,i[n+4+r*(e+s)]=1,i[n+s+1+r*(e+4)]=1}},_insertTimingGap:function(){var t,e,s=this.width;for(e=0;e<7;e++)this._setMask(7,e),this._setMask(s-8,e),this._setMask(7,e+s-7);for(t=0;t<8;t++)this._setMask(t,7),this._setMask(t+s-8,7),this._setMask(t,s-8)},_insertTimingRowAndColumn:function(){var t,e=this.buffer,s=this.width;for(t=0;t<s-14;t++)1&t?(this._setMask(8+t,6),this._setMask(6,8+t)):(e[8+t+6*s]=1,e[6+s*(8+t)]=1)},_insertVersion:function(){var t,e,s,n,i=this.buffer,r=this._version,a=this.width;if(r>6)for(t=_.BLOCK[r-7],e=17,s=0;s<6;s++)for(n=0;n<3;n++,e--)1&(e>11?r>>e-12:t>>e)?(i[5-s+a*(2-n+a-11)]=1,i[2-n+a-11+a*(5-s)]=1):(this._setMask(5-s,2-n+a-11),this._setMask(2-n+a-11,5-s))},_isMasked:function(t,e){var s=v._getMaskBit(t,e);return 1===this._mask[s]},_pack:function(){var t,e,s,n=1,i=1,r=this.width,a=r-1,o=r-1,l=(this._dataBlock+this._eccBlock)*(this._neccBlock1+this._neccBlock2)+this._neccBlock2;for(e=0;e<l;e++)for(t=this._stringBuffer[e],s=0;s<8;s++,t<<=1){128&t&&(this.buffer[a+r*o]=1);do{i?a--:(a++,n?0!==o?o--:(n=!n,6==(a-=2)&&(a--,o=9)):o!==r-1?o++:(n=!n,6==(a-=2)&&(a--,o-=8))),i=!i}while(this._isMasked(a,o))}},_reverseMask:function(){var t,e,s=this.width;for(t=0;t<9;t++)this._setMask(t,8);for(t=0;t<8;t++)this._setMask(t+s-8,8),this._setMask(8,t);for(e=0;e<7;e++)this._setMask(8,e+s-7)},_setMask:function(t,e){var s=v._getMaskBit(t,e);this._mask[s]=1},_syncMask:function(){var t,e,s=this.width;for(e=0;e<s;e++)for(t=0;t<=e;t++)this.buffer[t+s*e]&&this._setMask(t,e)}},{_createArray:function(t){var e,s=[];for(e=0;e<t;e++)s[e]=0;return s},_getMaskBit:function(t,e){var s;return t>e&&(s=t,t=e,e=s),s=e,s+=e*e,s>>=1,s+=t},_modN:function(t){for(;t>=255;)t=((t-=255)>>8)+(255&t);return t},N1:3,N2:3,N3:40,N4:10}),y=v,b=c.extend({draw:function(){this.element.src=this.qrious.toDataURL()},reset:function(){this.element.src=""},resize:function(){var t=this.element;t.width=t.height=this.qrious.size}}),S=l.extend(function(t,e,s,n){this.name=t,this.modifiable=Boolean(e),this.defaultValue=s,this._valueTransformer=n},{transform:function(t){var e=this._valueTransformer;return"function"==typeof e?e(t,this):t}}),x=l.extend(null,{abs:function(t){return null!=t?Math.abs(t):null},hasOwn:function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},noop:function(){},toUpperCase:function(t){return null!=t?t.toUpperCase():null}}),w=l.extend(function(t){this.options={},t.forEach(function(t){this.options[t.name]=t},this)},{exists:function(t){return null!=this.options[t]},get:function(t,e){return w._get(this.options[t],e)},getAll:function(t){var e,s=this.options,n={};for(e in s)x.hasOwn(s,e)&&(n[e]=w._get(s[e],t));return n},init:function(t,e,s){var n,i;for(n in"function"!=typeof s&&(s=x.noop),this.options)x.hasOwn(this.options,n)&&(i=this.options[n],w._set(i,i.defaultValue,e),w._createAccessor(i,e,s));this._setAll(t,e,!0)},set:function(t,e,s){return this._set(t,e,s)},setAll:function(t,e){return this._setAll(t,e)},_set:function(t,e,s,n){var i=this.options[t];if(!i)throw new Error("Invalid option: "+t);if(!i.modifiable&&!n)throw new Error("Option cannot be modified: "+t);return w._set(i,e,s)},_setAll:function(t,e,s){if(!t)return!1;var n,i=!1;for(n in t)x.hasOwn(t,n)&&this._set(n,t[n],e,s)&&(i=!0);return i}},{_createAccessor:function(t,e,s){var n={get:function(){return w._get(t,e)}};t.modifiable&&(n.set=function(n){w._set(t,n,e)&&s(n,t)}),Object.defineProperty(e,t.name,n)},_get:function(t,e){return e["_"+t.name]},_set:function(t,e,s){var n="_"+t.name,i=s[n],r=t.transform(null!=e?e:t.defaultValue);return s[n]=r,r!==i}}),T=w,C=l.extend(function(){this._services={}},{getService:function(t){var e=this._services[t];if(!e)throw new Error("Service is not being managed with name: "+t);return e},setService:function(t,e){if(this._services[t])throw new Error("Service is already managed with name: "+t);e&&(this._services[t]=e)}}),E=new T([new S("background",!0,"white"),new S("backgroundAlpha",!0,1,x.abs),new S("element"),new S("foreground",!0,"black"),new S("foregroundAlpha",!0,1,x.abs),new S("level",!0,"L",x.toUpperCase),new S("mime",!0,"image/png"),new S("padding",!0,null,x.abs),new S("size",!0,100,x.abs),new S("value",!0,"")]),A=new C,D=l.extend(function(t){E.init(t,this,this.update.bind(this));var e=E.get("element",this),s=A.getService("element"),n=e&&s.isCanvas(e)?e:s.createCanvas(),i=e&&s.isImage(e)?e:s.createImage();this._canvasRenderer=new u(this,n,!0),this._imageRenderer=new b(this,i,i===e),this.update()},{get:function(){return E.getAll(this)},set:function(t){E.setAll(t,this)&&this.update()},toDataURL:function(t){return this.canvas.toDataURL(t||this.mime)},update:function(){var t=new y({level:this.level,value:this.value});this._canvasRenderer.render(t),this._imageRenderer.render(t)}},{use:function(t){A.setService(t.getName(),t)}});Object.defineProperties(D.prototype,{canvas:{get:function(){return this._canvasRenderer.getElement()}},image:{get:function(){return this._imageRenderer.getElement()}}});var P=D,L=P,I=l.extend({getName:function(){}}).extend({createCanvas:function(){},createImage:function(){},getName:function(){return"element"},isCanvas:function(t){},isImage:function(t){}}).extend({createCanvas:function(){return document.createElement("canvas")},createImage:function(){return document.createElement("img")},isCanvas:function(t){return t instanceof HTMLCanvasElement},isImage:function(t){return t instanceof HTMLImageElement}});return L.use(new I),L}()),rC.exports}var oC=i(aC());const lC=t=>[t.r,t.g,t.b,1],hC=t=>({r:t[0],g:t[1],b:t[2]});class cC extends u.Component{shouldComponentUpdate(t){const e=["ui","debug","animation.playing"],s=CT(t.observerData,e),n=CT(this.props.observerData,e);return JSON.stringify(s)!==JSON.stringify(n)}render(){const t=this.props;return u.createElement("div",{className:"popup-panel-parent"},u.createElement(vt,{class:"popup-panel",flex:!0,hidden:"camera"!==t.observerData.ui.active},u.createElement($t,{text:"Camera",class:"popup-panel-heading"}),u.createElement(LT,{label:"Fov",precision:0,min:35,max:150,value:t.observerData.camera.fov,setProperty:e=>t.setProperty("camera.fov",e)}),u.createElement(kT,{label:"Tonemap",type:"string",options:["None","Linear","Neutral","Filmic","Hejl","ACES","ACES2"].map(t=>({v:t,t:t})),value:t.observerData.camera.tonemapping,setProperty:e=>t.setProperty("camera.tonemapping",e)}),u.createElement(kT,{label:"Pixel Scale",value:t.observerData.camera.pixelScale,type:"number",options:[1,2,4,8,16].map(t=>({v:t,t:Number(t).toString()})),setProperty:e=>t.setProperty("camera.pixelScale",e)}),u.createElement(DT,{label:"Multisample",value:t.observerData.camera.multisample,enabled:t.observerData.camera.multisampleSupported,setProperty:e=>t.setProperty("camera.multisample",e)}),u.createElement(DT,{label:"High Quality",value:t.observerData.camera.hq,enabled:!t.observerData.animation.playing&&!t.observerData.debug.stats,setProperty:e=>t.setProperty("camera.hq",e)})))}}class dC extends u.Component{shouldComponentUpdate(t){return JSON.stringify(t.skyboxData)!==JSON.stringify(this.props.skyboxData)||JSON.stringify(t.uiData)!==JSON.stringify(this.props.uiData)}render(){const t=this.props;return u.createElement("div",{className:"popup-panel-parent"},u.createElement(vt,{class:"popup-panel",flex:!0,hidden:"skybox"!==t.uiData.active},u.createElement($t,{text:"Sky",class:"popup-panel-heading"}),u.createElement(kT,{label:"Environment",type:"string",options:JSON.parse(t.skyboxData.options),value:t.skyboxData.value,setProperty:e=>t.setProperty("skybox.value",e)}),u.createElement(LT,{label:"Exposure",value:t.skyboxData.exposure,setProperty:e=>t.setProperty("skybox.exposure",e),precision:2,min:-6,max:6,enabled:"None"!==t.skyboxData.value}),u.createElement(LT,{label:"Rotation",precision:0,min:-180,max:180,value:t.skyboxData.rotation,setProperty:e=>t.setProperty("skybox.rotation",e),enabled:"None"!==t.skyboxData.value}),u.createElement(kT,{label:"Background",type:"string",options:["Solid Color","Infinite Sphere","Projective Dome","Projective Box"].map(t=>({v:t,t:t})),value:t.skyboxData.background,setProperty:e=>t.setProperty("skybox.background",e),enabled:"None"!==t.skyboxData.value}),u.createElement(RT,{label:"Background Color",value:lC(t.skyboxData.backgroundColor),setProperty:e=>t.setProperty("skybox.backgroundColor",hC(e)),enabled:"None"===t.skyboxData.value||"Solid Color"===t.skyboxData.background}),u.createElement(LT,{label:"Blur",value:t.skyboxData.blur,setProperty:e=>t.setProperty("skybox.blur",e),enabled:"None"!==t.skyboxData.value&&"Infinite Sphere"===t.skyboxData.background,min:0,max:5,precision:0,step:1}),u.createElement(IT,{label:"Scale",value:t.skyboxData.domeProjection.domeRadius,setProperty:e=>t.setProperty("skybox.domeProjection.domeRadius",e),min:0,max:1e3,enabled:"None"!==t.skyboxData.value&&-1!==["Projective Dome","Projective Box"].indexOf(t.skyboxData.background)}),u.createElement(LT,{label:"Tripod Offset",value:t.skyboxData.domeProjection.tripodOffset,setProperty:e=>t.setProperty("skybox.domeProjection.tripodOffset",e),min:0,max:1,precision:2,enabled:"None"!==t.skyboxData.value&&-1!==["Projective Dome","Projective Box"].indexOf(t.skyboxData.background)})))}}class uC extends u.Component{shouldComponentUpdate(t){return JSON.stringify(t.lightData)!==JSON.stringify(this.props.lightData)||JSON.stringify(t.uiData)!==JSON.stringify(this.props.uiData)}render(){const t=this.props;return u.createElement("div",{className:"popup-panel-parent"},u.createElement(vt,{class:"popup-panel",flex:!0,hidden:"light"!==t.uiData.active},u.createElement($t,{text:"Light",class:"popup-panel-heading"}),u.createElement(DT,{label:"Enabled",value:t.lightData.enabled,setProperty:e=>t.setProperty("light.enabled",e)}),u.createElement(DT,{label:"Follow Camera",value:t.lightData.follow,setProperty:e=>t.setProperty("light.follow",e)}),u.createElement(RT,{label:"Color",value:lC(t.lightData.color),setProperty:e=>t.setProperty("light.color",hC(e))}),u.createElement(LT,{label:"Intensity",precision:2,min:0,max:6,value:t.lightData.intensity,setProperty:e=>t.setProperty("light.intensity",e)}),u.createElement(DT,{label:"Cast Shadow",value:t.lightData.shadow,setProperty:e=>t.setProperty("light.shadow",e)}),u.createElement(DT,{label:"Shadow Catcher",value:t.shadowCatcherData.enabled,setProperty:e=>t.setProperty("shadowCatcher.enabled",e)}),u.createElement(LT,{label:"Catcher Intensity",precision:2,min:0,max:1,value:t.shadowCatcherData.intensity,setProperty:e=>t.setProperty("shadowCatcher.intensity",e)})))}}class fC extends u.Component{shouldComponentUpdate(t){return JSON.stringify(t.debugData)!==JSON.stringify(this.props.debugData)||JSON.stringify(t.uiData)!==JSON.stringify(this.props.uiData)}render(){const t=this.props;return u.createElement("div",{className:"popup-panel-parent"},u.createElement(vt,{class:"popup-panel",flex:!0,hidden:"debug"!==t.uiData.active},u.createElement($t,{text:"Debug",class:"popup-panel-heading"}),u.createElement(kT,{label:"Render Mode",type:"string",options:[{t:"Default",v:"default"},{t:"Lighting",v:"lighting"},{t:"Albedo",v:"albedo"},{t:"Emissive",v:"emission"},{t:"WorldNormal",v:"world_normal"},{t:"Metalness",v:"metalness"},{t:"Gloss",v:"gloss"},{t:"Ao",v:"ao"},{t:"Specularity",v:"specularity"},{t:"Opacity",v:"opacity"},{t:"Uv0",v:"uv0"}],value:t.debugData.renderMode,setProperty:e=>t.setProperty("debug.renderMode",e)}),u.createElement(PT,{label:"Wireframe",booleanValue:t.debugData.wireframe,setBooleanProperty:e=>t.setProperty("debug.wireframe",e),colorValue:lC(t.debugData.wireframeColor),setColorProperty:e=>t.setProperty("debug.wireframeColor",hC(e))}),u.createElement(DT,{label:"Grid",value:t.debugData.grid,setProperty:e=>t.setProperty("debug.grid",e)}),u.createElement(DT,{label:"Axes",value:t.debugData.axes,setProperty:e=>t.setProperty("debug.axes",e)}),u.createElement(DT,{label:"Skeleton",value:t.debugData.skeleton,setProperty:e=>t.setProperty("debug.skeleton",e)}),u.createElement(DT,{label:"Bounds",value:t.debugData.bounds,setProperty:e=>t.setProperty("debug.bounds",e)}),u.createElement(LT,{label:"Normals",precision:2,min:0,max:1,setProperty:e=>t.setProperty("debug.normals",e),value:t.debugData.normals}),u.createElement(DT,{label:"Stats",value:t.debugData.stats,setProperty:e=>t.setProperty("debug.stats",e)})))}}class pC extends u.Component{isMobile;get shareUrl(){return`${location.origin}${location.pathname}?${this.props.sceneData.urls.map(t=>`load=${t}`).join("&")}`}constructor(t){super(t),this.isMobile=/Android|webOS|iPhone|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}shouldComponentUpdate(t){return JSON.stringify(t.sceneData)!==JSON.stringify(this.props.sceneData)||JSON.stringify(t.uiData)!==JSON.stringify(this.props.uiData)}get hasQRCode(){return this.props.sceneData.urls.length>0&&!this.isMobile}updateQRCode(){const t=document.getElementById("share-qr");new oC({element:t,value:this.shareUrl,size:t.getBoundingClientRect().width*window.devicePixelRatio})}componentDidMount(){this.hasQRCode&&this.updateQRCode()}componentDidUpdate(){this.hasQRCode&&this.updateQRCode()}render(){const t=this.props;return u.createElement("div",{className:"popup-panel-parent"},u.createElement(vt,{id:"view-panel",class:"popup-panel",flex:!0,hidden:"view"!==t.uiData.active},this.hasQRCode?u.createElement(u.Fragment,null,u.createElement($t,{text:"View and share on mobile with QR code"}),u.createElement("div",{id:"qr-wrapper"},u.createElement("canvas",{id:"share-qr"})),u.createElement($t,{text:"View and share on mobile with URL"}),u.createElement("div",{id:"share-url-wrapper"},u.createElement(ae,{class:"secondary",value:this.shareUrl,enabled:!1}),u.createElement(at,{id:"copy-button",icon:"E126",onClick:()=>{navigator.clipboard&&window.isSecureContext&&navigator.clipboard.writeText(this.shareUrl)}}))):null,u.createElement(at,{class:"secondary",text:"TAKE A SNAPSHOT AS PNG",onClick:()=>{window.viewer&&window.viewer.downloadPngScreenshot()}})))}}const mC=t=>u.createElement(u.Fragment,null,u.createElement(cC,{setProperty:t.setProperty,observerData:t.observerData}),u.createElement(dC,{setProperty:t.setProperty,skyboxData:t.observerData.skybox,uiData:t.observerData.ui}),u.createElement(uC,{setProperty:t.setProperty,lightData:t.observerData.light,uiData:t.observerData.ui,shadowCatcherData:t.observerData.shadowCatcher}),u.createElement(fC,{setProperty:t.setProperty,debugData:t.observerData.debug,uiData:t.observerData.ui}),u.createElement(pC,{setProperty:t.setProperty,sceneData:t.observerData.scene,uiData:t.observerData.ui,runtimeData:t.observerData.runtime}));class gC extends u.Component{popupPanelElement;render(){let t;const e=e=>{this.props.setProperty("ui.active",this.props.observerData.ui.active===e?null:e),this.popupPanelElement||(this.popupPanelElement=document.getElementById("popup")),setTimeout(()=>{t&&t();t=TT(document.body,e=>{this.popupPanelElement.contains(e.target)||(this.props.setProperty("ui.active",null),t(),t=null)},4)})},s=t=>this.props.observerData.ui.active===t?["popup-button","selected"]:["popup-button"];return u.createElement("div",{id:"popup-buttons-parent"},u.createElement(nC,{animationData:this.props.observerData.animation,setProperty:this.props.setProperty}),u.createElement(at,{class:s("camera"),icon:"E212",width:40,height:40,onClick:()=>e("camera")}),u.createElement(at,{class:s("skybox"),icon:"E200",width:40,height:40,onClick:()=>e("skybox")}),u.createElement(at,{class:s("light"),icon:"E194",width:40,height:40,onClick:()=>e("light")}),u.createElement(at,{class:s("debug"),icon:"E134",width:40,height:40,onClick:()=>e("debug")}),u.createElement(at,{class:s("view"),icon:"E301",width:40,height:40,onClick:()=>e("view")}))}}class _C extends u.Component{link;usdzExporter;get hasArSupport(){return this.props.observerData.runtime.xrSupported||this.usdzExporter}constructor(t){super(t),this.link=document.getElementById("ar-link"),(this.link.relList.supports("ar")||Boolean(window.webkit?.messageHandlers)&&Boolean(/CriOS\/|EdgiOS\/|FxiOS\/|GSA\/|DuckDuckGo\//.test(navigator.userAgent)))&&(this.usdzExporter=new gw)}render(){return u.createElement("div",{id:"popup",className:"[]"===this.props.observerData.scene.nodes?"empty":null},u.createElement(mC,{observerData:this.props.observerData,setProperty:this.props.setProperty}),u.createElement(gC,{observerData:this.props.observerData,setProperty:this.props.setProperty}),u.createElement(at,{class:"popup-button",id:"launch-ar-button",icon:"E189",hidden:!this.hasArSupport||"[]"===this.props.observerData.scene.nodes,width:40,height:40,onClick:()=>{if(this.usdzExporter){const t=window.viewer.app.root.findByName("sceneRoot");this.usdzExporter.build(t).then(t=>{const e=new Blob([t],{type:"application/octet-stream"});this.link.href=URL.createObjectURL(e),this.link.click()}).catch(console.error)}else window.viewer&&window.viewer.xrMode.start()}}),u.createElement("div",{id:"floating-top-parent"},u.createElement(at,{class:"popup-button",id:"fullscreen-button",icon:"E127",width:40,height:40,onClick:()=>{document.getElementById("panel-left").classList.toggle("collapsed")}})),u.createElement("div",{id:"floating-bottom-parent"},u.createElement(at,{class:["popup-button","camera-mode-button",this.props.observerData.camera.mode],id:"camera-mode-button",width:40,height:40,onClick:()=>{const t="orbit"===this.props.observerData.camera.mode?"fly":"orbit";this.props.setProperty("camera.mode",t)}})))}}class vC extends u.Component{shouldComponentUpdate(t){return t.sceneData.nodes!==this.props.sceneData.nodes||t.sceneData.selectedNode.path!==this.props.sceneData.selectedNode.path||t.sceneData.selectedNode.name!==this.props.sceneData.selectedNode.name||t.sceneData.selectedNode.position!==this.props.sceneData.selectedNode.position||t.sceneData.selectedNode.rotation!==this.props.sceneData.selectedNode.rotation||t.sceneData.selectedNode.scale!==this.props.sceneData.selectedNode.scale}render(){const t=this.props.sceneData,e="[]"!==t.nodes,s=t.selectedNode.path;return e&&s?u.createElement("div",{className:"selected-node-panel-parent"},u.createElement(vt,{class:"selected-node-panel",flex:!0},u.createElement(ET,{label:"Name",value:t.selectedNode.name}),u.createElement(AT,{label:"Position",dimensions:3,value:t.selectedNode.position,enabled:!1}),u.createElement(AT,{label:"Rotation",dimensions:3,value:t.selectedNode.rotation,enabled:!1}),u.createElement(AT,{label:"Scale",dimensions:3,value:t.selectedNode.scale,enabled:!1}))):null}}let yC=class extends u.Component{state=null;canvasRef;constructor(t){super(t),this.canvasRef=u.createRef(),this.state=this._retrieveState(),t.observer.on("*:set",()=>{this.setState(this._retrieveState())})}_retrieveState=()=>{const t={};return this.props.observer._keys.forEach(e=>{t[e]=this.props.observer.get(e)}),t};_setStateProperty=(t,e)=>{this.props.observer.set(t,e)};render(){return u.createElement("div",{id:"application-container"},u.createElement(vt,{id:"panel-left",flex:!0,resizable:"right",resizeMin:220,resizeMax:800},u.createElement("div",{className:"header",style:{display:"none"}},u.createElement("div",{id:"title"},u.createElement("img",{src:"static/playcanvas-logo.png"}),u.createElement("div",null,`MODEL VIEWER v${JT}`))),u.createElement("div",{id:"panel-toggle"},u.createElement("img",{src:"static/playcanvas-logo.png"})),u.createElement(ZT,{observerData:this.state,setProperty:this._setStateProperty})),u.createElement("div",{id:"canvas-wrapper"},u.createElement("canvas",{id:"application-canvas",ref:this.canvasRef}),u.createElement(tC,{setProperty:this._setStateProperty}),u.createElement(vC,{sceneData:this.state.scene}),u.createElement(_C,{observerData:this.state,setProperty:this._setStateProperty}),u.createElement(wT,{observerData:this.state}),u.createElement(re,{id:"spinner",size:30,hidden:!0})))}};class bC extends ag{constructor(t,e){super(t);const s=new lg;s.graphicsDevice=e.graphicsDevice,this.addComponentSystems(s),this.addResourceHandles(s),s.elementInput=e.elementInput,s.keyboard=e.keyboard,s.mouse=e.mouse,s.touch=e.touch,s.gamepads=e.gamepads,s.scriptPrefix=e.scriptPrefix,s.assetPrefix=e.assetPrefix,s.scriptsOrder=e.scriptsOrder,s.lightmapper=Sg,s.xr=QS,this.init(s)}addComponentSystems(t){t.componentSystems=[u_,E_,Y_,tv,ly,gv]}addResourceHandles(t){t.resourceHandlers=[fy,hb,cb,aS,mb,db,pb,kb]}}const SC=new rs,xC=new rs,wC=new yw,TC=new Sw({move:[0,0,0],rotate:[0,0,0]}),CC=(t,e,s)=>{const n=Math.sqrt(t[0]*t[0]+t[1]*t[1]);if(n<e)return void t.fill(0);const i=(n-e)/(s-e);t[0]*=i/n,t[1]*=i/n},EC=(t,e,s,n,i=new rs)=>{const{system:r,fov:a,aspectRatio:o,horizontalFov:l,projection:h,orthoHeight:c}=t,{width:d,height:u}=r.app.graphicsDevice.clientRect;i.set(-e/d*2,s/u*2,0);const f=xC.set(0,0,0);if(0===h){const t=n*Math.tan(.5*a*Qe.DEG_TO_RAD);l?f.set(t,t/o,0):f.set(t*o,t,0)}else f.set(c*o,c,0);return i.mul(f),i};class CameraControls{_app;_camera;_observer;_zoomRange=new os;_desktopInput=new Nw;_orbitMobileInput=new Rw;_flyMobileInput=new Lw;_gamepadInput=new Uw;_flyController=new qw;_orbitController=new Jw;_controller;_pose=new yw;_mode;_state={axis:new rs,mouse:[0,0,0],shift:0,ctrl:0,touches:0};moveSpeed=1;orbitSpeed=18;pinchSpeed=.4;wheelSpeed=.06;gamepadDeadZone=new os(.3,.6);constructor(t,e,s){this._app=t,this._camera=e,this._observer=s,this._orbitController.zoomRange=new os(0,1/0),this._orbitController.pitchRange=new os(-90,90),this._orbitController.rotateDamping=.97,this._orbitController.moveDamping=.97,this._orbitController.zoomDamping=.97,this._flyController.pitchRange=new os(-90,90),this._flyController.rotateDamping=.97,this._flyController.moveDamping=.97,this._desktopInput.attach(this._app.graphicsDevice.canvas),this._orbitMobileInput.attach(this._app.graphicsDevice.canvas),this._flyMobileInput.attach(this._app.graphicsDevice.canvas),this._gamepadInput.attach(this._app.graphicsDevice.canvas),this._pose.look(this._camera.entity.getPosition(),rs.ZERO),this.mode="orbit"}set zoomRange(t){this._zoomRange.x=t.x,this._zoomRange.y=t.y<=t.x?1/0:t.y,this._orbitController.zoomRange=this._zoomRange}get zoomRange(){return this._zoomRange}set mode(t){if(this._mode!==t){switch(this._mode=t,this._controller&&this._controller.detach(),this._mode){case"orbit":this._controller=this._orbitController;break;case"fly":this._controller=this._flyController}this._controller.attach(this._pose,!1),this._observer.set("camera.mode",this._mode)}}get mode(){return this._mode}reset(t,e){this.mode="orbit",this._controller.attach(wC.look(e,t))}update(t){const{keyCode:e}=Nw,{key:s,button:n,mouse:i,wheel:r}=this._desktopInput.read(),{touch:a,pinch:o,count:l}=this._orbitMobileInput.read(),{leftInput:h,rightInput:c}=this._flyMobileInput.read(),{leftStick:d,rightStick:u}=this._gamepadInput.read();CC(d,this.gamepadDeadZone.x,this.gamepadDeadZone.y),CC(u,this.gamepadDeadZone.x,this.gamepadDeadZone.y),this._state.axis.add(SC.set(s[e.D]-s[e.A]+(s[e.RIGHT]-s[e.LEFT]),s[e.E]-s[e.Q],s[e.W]-s[e.S]+(s[e.UP]-s[e.DOWN])));for(let t=0;t<this._state.mouse.length;t++)this._state.mouse[t]+=n[t];this._state.shift+=s[e.SHIFT],this._state.ctrl+=s[e.CTRL],this._state.touches+=l[0],"fly"!==this._mode&&this._state.axis.length()>0&&(this.mode="fly");const f=+("orbit"===this._mode),p=+("fly"===this._mode),m=+(this._state.touches>1),g=this._state.mouse[2]||+(-1===n[2])||m,_=this._pose.distance,{deltas:v}=TC,y=SC.set(0,0,0),b=this._state.axis.clone().normalize();y.add(b.mulScalar(p*this.moveSpeed*(this._state.shift?2:this._state.ctrl?.5:1)*t));const S=EC(this._camera,i[0],i[1],_);y.add(S.mulScalar(g));const x=new rs(0,0,-r[0]);y.add(x.mulScalar(this.wheelSpeed*t)),v.move.append([y.x,y.y,f?-y.z:y.z]),y.set(0,0,0);const w=new rs(i[0],i[1],0);y.add(w.mulScalar((1-g)*this.orbitSpeed*t)),v.rotate.append([y.x,y.y,y.z]),y.set(0,0,0);const T=EC(this._camera,a[0],a[1],_);y.add(T.mulScalar(f*g));const C=new rs(h[0],0,-h[1]);y.add(C.mulScalar(p*this.moveSpeed*t));const E=new rs(0,0,o[0]);y.add(E.mulScalar(f*m*this.pinchSpeed*t)),v.move.append([y.x,y.y,y.z]),y.set(0,0,0);const A=new rs(a[0],a[1],0);y.add(A.mulScalar(f*(1-g)*this.orbitSpeed*t));const D=new rs(c[0],c[1],0);y.add(D.mulScalar(p*this.orbitSpeed*t)),v.rotate.append([y.x,y.y,y.z]),y.set(0,0,0);const P=new rs(d[0],0,-d[1]);y.add(P.mulScalar(this.moveSpeed*t)),v.move.append([y.x,y.y,y.z]),y.set(0,0,0);const L=new rs(u[0],u[1],0);y.add(L.mulScalar(this.orbitSpeed*t)),v.rotate.append([y.x,y.y,y.z]),this._app.xr?.active?TC.read():(this._pose.copy(this._controller.update(TC,t)),this._camera.entity.setPosition(this._pose.position),this._camera.entity.setEulerAngles(this._pose.angles))}destroy(){this._desktopInput.destroy(),this._orbitMobileInput.destroy(),this._flyMobileInput.destroy(),this._gamepadInput.destroy(),this._flyController.destroy(),this._orbitController.destroy()}}let AC=null,DC=null;const PC=new rs,LC=new rs,IC=new rs,RC=new rs(0,1,0),MC=new ps,kC=[[[0,0,0],[-.5,0,.3]],[[0,0,0],[.5,0,.3]],[[0,0,0],[0,-.5,.3]],[[0,0,0],[0,.5,.3]],[[0,0,1],[-.5,0,.3]],[[0,0,1],[.5,0,.3]],[[0,0,1],[0,-.5,.3]],[[0,0,1],[0,.5,.3]],[[0,-.5,.3],[.5,0,.3]],[[.5,0,.3],[0,.5,.3]],[[0,.5,.3],[-.5,0,.3]],[[-.5,0,.3],[0,-.5,.3]]];class OC{app;mesh;meshInstances;vertexFormat;vertexCursor;vertexData;colorData;depthState=new Ai;constructor(t,e,s=!0){const n=t.graphicsDevice;if(!AC){DC=new Ru({enabled:!0,name:"Debug Layer Behind",opaqueSortMode:0,transparentSortMode:0,passThrough:!0,overrideClear:!0}),AC=new Ru({enabled:!0,name:"Debug Layer",opaqueSortMode:0,transparentSortMode:0,passThrough:!0,overrideClear:!0});const s=t.scene.layers,n=s.getLayerByName("World"),i=s.getTransparentIndex(n);s.insert(DC,i),s.insert(AC,i+1),e.camera.layers=e.camera.layers.concat([DC.id,AC.id])}const i=new Ui(n,[{semantic:Ys,components:3,type:6},{semantic:en,components:4,type:1,normalize:!0}]),r=new tc(n);r.vertexBuffer=new ki(n,i,8192,{usage:1}),r.primitive[0].type=1,r.primitive[0].base=0,r.primitive[0].indexed=!1,r.primitive[0].count=0;const a={uniqueName:"debug-lines",attributes:{vertex_position:Ys,vertex_color:en},vertexGLSL:"\nattribute vec3 vertex_position;\nattribute vec4 vertex_color;\n\nvarying vec2 zw;\nvarying vec4 vColor;\n\nuniform mat4 matrix_model;\nuniform mat4 matrix_viewProjection;\n\nvoid main(void) {\n    vColor = vertex_color;\n\n    gl_Position = matrix_viewProjection * matrix_model * vec4(vertex_position, 1.0);\n\n    // store z/w for later use in fragment shader\n    zw = gl_Position.zw;\n\n    // disable depth clipping\n    gl_Position.z = 0.0;\n}",fragmentGLSL:"\nprecision highp float;\n\nvarying vec2 zw;\nvarying vec4 vColor;\nuniform vec4 uColor;\n\nvoid main(void) {\n    gl_FragColor = vColor * uColor;\n\n    // clamp depth in Z to [0, 1] range\n    gl_FragDepth = max(0.0, min(1.0, (zw.x / zw.y + 1.0) * 0.5));\n}",vertexWGSL:"\nattribute vertex_position: vec3f;\nattribute vertex_color: vec4f;\n\nvarying zw: vec2f;\nvarying vColor: vec4f;\n\nuniform matrix_model: mat4x4f;\nuniform matrix_viewProjection: mat4x4f;\n\n@vertex\nfn vertexMain(input: VertexInput) -> VertexOutput {\n    var output: VertexOutput;\n\n    output.vColor = vertex_color;\n    output.position = uniform.matrix_viewProjection * uniform.matrix_model * vec4(vertex_position, 1.0);\n\n    // store z/w for later use in fragment shader\n    output.zw = output.position.zw;\n\n    // disable depth clipping\n    output.position.z = 0.0;\n\n    return output;\n}\n",fragmentWGSL:"\nvarying zw: vec2f;\nvarying vColor: vec4f;\n\nuniform uColor: vec4f;\n\n@fragment\nfn fragmentMain(input: FragmentInput) -> FragmentOutput {\n    var output: FragmentOutput;\n\n    output.color = input.vColor * uniform.uColor;\n\n    // clamp depth in Z to [0, 1] range\n    output.fragDepth = max(0.0, min(1.0, (zw.x / zw.y + 1.0) * 0.5));\n\n    return output;\n}\n"},o=new Ju(a);o.setParameter("uColor",[1,1,1,.7]),o.blendType=2,o.update();const l=new fc(r,o,new Hc);if(l.cull=!1,l.visible=!1,AC.addMeshInstances([l],!0),this.meshInstances=[l],s){const t=new Ju(a);t.setParameter("uColor",[.5,.5,.5,.5]),t.blendType=2,t.depthState.func=4,t.depthState.write=!1,t.update();const e=new fc(r,t,new Hc);e.cull=!1,e.visible=!1,DC.addMeshInstances([e],!0),this.meshInstances.push(e)}this.app=t,this.mesh=r,this.vertexFormat=i,this.vertexCursor=0,this.vertexData=new Float32Array(this.mesh.vertexBuffer.lock()),this.colorData=new Uint32Array(this.mesh.vertexBuffer.lock())}static matrixMad(t,e,s){if(s>0)for(let n=0;n<16;++n)t.data[n]+=e.data[n]*s}clear(){this.vertexCursor=0}box(t,e){this.line(new rs(t.x,t.y,t.z),new rs(e.x,t.y,t.z)),this.line(new rs(e.x,t.y,t.z),new rs(e.x,t.y,e.z)),this.line(new rs(e.x,t.y,e.z),new rs(t.x,t.y,e.z)),this.line(new rs(t.x,t.y,e.z),new rs(t.x,t.y,t.z)),this.line(new rs(t.x,e.y,t.z),new rs(e.x,e.y,t.z)),this.line(new rs(e.x,e.y,t.z),new rs(e.x,e.y,e.z)),this.line(new rs(e.x,e.y,e.z),new rs(t.x,e.y,e.z)),this.line(new rs(t.x,e.y,e.z),new rs(t.x,e.y,t.z)),this.line(new rs(t.x,t.y,t.z),new rs(t.x,e.y,t.z)),this.line(new rs(e.x,t.y,t.z),new rs(e.x,e.y,t.z)),this.line(new rs(e.x,t.y,e.z),new rs(e.x,e.y,e.z)),this.line(new rs(t.x,t.y,e.z),new rs(t.x,e.y,e.z))}line(t,e,s=4294967295){if(this.vertexCursor>=this.vertexData.length/8){const t=this.mesh.vertexBuffer,e=2*t.lock().byteLength,s=new ArrayBuffer(e);this.mesh.vertexBuffer=new ki(this.app.graphicsDevice,t.getFormat(),2*t.getNumVertices(),{usage:1,data:s}),this.vertexData=new Float32Array(s),this.colorData=new Uint32Array(s),this.colorData.set(new Uint32Array(t.lock()))}const n=this.vertexCursor,i=this.vertexData,r=this.colorData;i[8*n+0]=t.x,i[8*n+1]=t.y,i[8*n+2]=t.z,r[8*n+3]=s,i[8*n+4]=e.x,i[8*n+5]=e.y,i[8*n+6]=e.z,r[8*n+7]=s,this.vertexCursor++}generateNormals(t,e,s,n){const i=new Yo(t),r=i.element[Ys],a=i.element[Qs],o=i.element[tn],l=i.element[Js];if(!r||!a)return;const h=t.getNumVertices(),c=new rs,d=new rs,u=new ps;for(let t=0;t<h;++t){if(c.set(r.get(0),r.get(1),r.get(2)),d.set(a.get(0),a.get(1),a.get(2)),o&&l&&n){u.copy(ps.ZERO);for(let t=0;t<4;++t)OC.matrixMad(u,n[o.get(t)],l.get(t));u.mul2(e,u),u.transformPoint(c,c),u.transformVector(d,d)}else e.transformPoint(c,c),e.transformVector(d,d);d.normalize().mulScalar(s).add(c),this.line(c,d),i.next()}}bone(t,e,s=4294967295){MC.setLookAt(t,e,RC),PC.sub2(e,t);const n=PC.length(),i=(t,e)=>{PC.set(e[0]*n*.3,e[1]*n*.3,e[2]*-n),MC.transformPoint(PC,t)};kC.forEach(t=>{i(LC,t[0]),i(IC,t[1]),this.line(LC,IC,s)})}axis(t,e=1){t.getTranslation(PC),t.getScale(IC),IC.set(e/IC.x,e/IC.y,e/IC.z),t.getX(LC).mul(IC).add(PC),this.line(PC,LC,4278190335),t.getY(LC).mul(IC).add(PC),this.line(PC,LC,4278255360),t.getZ(LC).mul(IC).add(PC),this.line(PC,LC,4294901760)}generateSkeleton(t,e,s,n){const i=(r,a)=>{if(r.enabled){a||=r===n;for(let t=0;t<r.children.length;++t){const s=r.children[t];e&&this.bone(r.getPosition(),s.getPosition(),a?4294967040:4294967295),i(s,a)}if(s){const e=t.parent;e&&(PC.sub2(r.getPosition(),e.getPosition()),this.axis(r.getWorldTransform(),.05*PC.length()))}}};i(t,!1)}update(){0===this.vertexCursor?this.meshInstances.forEach(t=>{t.visible=!1}):(this.meshInstances.forEach(t=>{t.visible=!0}),this.mesh.vertexBuffer.unlock(),this.mesh.primitive[0].count=2*this.vertexCursor,this.vertexCursor=0)}}const FC=t=>{const e=[],s=[];return t.forEach(t=>{t.isFile?s.push(t):t.isDirectory&&e.push(new Promise(e=>{const s=t.createReader(),n=[],i=()=>{s.readEntries(t=>{t.length>0?(n.push(FC(t)),i()):Promise.all(n).then(t=>{e(t.flat())})})};i()}))}),Promise.all(e).then(t=>s.concat(...t))},NC=(t,e)=>{t.addEventListener("dragstart",t=>{t.preventDefault(),t.stopPropagation(),t.dataTransfer.effectAllowed="all"},!1),t.addEventListener("dragover",t=>{t.preventDefault(),t.stopPropagation(),t.dataTransfer.effectAllowed="all"},!1),t.addEventListener("drop",t=>{t.preventDefault();const s=Array.from(t.dataTransfer.items).map(t=>t.webkitGetAsEntry());FC(s).then(t=>Promise.all(t.map(t=>new Promise(e=>{t.file(s=>{e({url:URL.createObjectURL(s),filename:t.fullPath.substring(1)})})})))).then(s=>{s.length>1&&(t=>{const e=t=>{const e=t.split(Me.delimiter);return[e[0],e.slice(1).join(Me.delimiter)]};for(;;){const s=e(t[0].filename);if(0===s[1].length)return;for(let n=1;n<t.length;++n){const i=e(t[n].filename);if(s[0]!==i[0])return}for(let s=0;s<t.length;++s)t[s].filename=e(t[s].filename)[1]}})(s),e(s,!t.shiftKey)})},!1)},BC=t=>(t=>t.textureHalfFloatRenderable)(t)?Ls:(t=>t.textureFloatRenderable)(t)?Is:7,zC=(t,e)=>1/(Math.sqrt(2*Math.PI)*e)*Math.exp(-t*t/(2*e*e)),UC=new Ti(!0,0,11,12),VC=new Ti(!1);class HC extends Gf{events=new Ve;execute(){this.events.fire("execute"),super.execute()}}const GC=(t,e)=>{for(const s in e)t.resolve(s).setValue(e[s])};class WC{device;camera;textureBias;shader=null;accumTexture=null;accumRenderTarget=null;updateRenderPass;finalRenderPass;sampleArray=[];sampleId=0;sampleAccum=0;enabled=!0;blend=1;constructor(t,e,s){this.device=t,this.camera=e,this.samples=s||WC.generateSamples(5,!1,2,0);this.camera.system.app.scene.on(wh,e=>{if(e!==this.camera)return;const s=this.camera.camera,n=s.projectionMatrix;if(this.enabled&&this.accumTexture){const e=this.sampleArray[this.sampleId];n.data[8]=e.x/this.accumTexture.width,n.data[9]=e.y/this.accumTexture.height,GC(t.scope,{textureBias:0===this.sampleId?0:this.textureBias})}else n.data[8]=0,n.data[9]=0,GC(t.scope,{textureBias:0});s._viewProjMatDirty=!0}),this.camera.system.app.scene.on(Th,t=>{if(t!==this.camera)return;const s=e.projectionMatrix;s.data[8]=0,s.data[9]=0}),this.shader=zh.createShader(t,{uniqueName:"multiframe-shader",attributes:{vertex_position:Ys},vertexGLSL:"\n    attribute vec2 vertex_position;\n    varying vec2 texcoord;\n    uniform vec4 texcoordMod;\n    void main(void) {\n        gl_Position = vec4(vertex_position, 0.5, 1.0);\n        texcoord = (vertex_position.xy * 0.5 + 0.5) * texcoordMod.xy + texcoordMod.zw;\n    }\n",fragmentGLSL:"\n    varying vec2 texcoord;\n    uniform sampler2D multiframeTex;\n    uniform float power;\n    void main(void) {\n        vec4 t = texture2D(multiframeTex, texcoord);\n        gl_FragColor = pow(t, vec4(power));\n    }\n",vertexWGSL:"\n    attribute vertex_position: vec2f;\n\n    varying texcoord: vec2f;\n\n    uniform texcoordMod: vec4f;\n\n    @vertex\n    fn vertexMain(input: VertexInput) -> VertexOutput {\n        var output: VertexOutput;\n\n        output.position = vec4f(vertex_position, 0.5, 1.0);\n        output.texcoord = (vertex_position.xy * 0.5 + 0.5) * uniform.texcoordMod.xy + uniform.texcoordMod.zw;\n\n        return output;\n    }\n",fragmentWGSL:"\n    varying texcoord: vec2f;\n\n    var multiframeTex: texture_2d<f32>;\n    var multiframeSampler: sampler;\n\n    uniform power: f32;\n\n    @fragment\n    fn fragmentMain(input: FragmentInput) -> FragmentOutput {\n        var output: FragmentOutput;\n\n        let t: vec4f = textureSample(multiframeTex, multiframeSampler, input.texcoord);\n        output.color = pow(t, vec4f(uniform.power));\n\n        return output;\n    }\n"}),this.accumTexture=new pi(t,{name:"multiframe-texture",width:t.width,height:t.height,format:BC(t),mipmaps:!1,minFilter:0,magFilter:0}),this.accumRenderTarget=new ji({name:"multiframe-target",colorBuffer:this.accumTexture,depth:!1}),this.updateRenderPass=new HC(t),this.updateRenderPass.init(this.accumRenderTarget,{}),this.updateRenderPass.shader=this.shader,this.updateRenderPass.blendState=UC,this.updateRenderPass.events.on("execute",()=>{const e=this.sampleArray[this.sampleId++].z,s=e/(this.sampleAccum+e);this.sampleAccum+=e,t.setBlendColor(s,s,s,s),GC(t.scope,{texcoordMod:[1,1,0,0],multiframeTex:this.sourceTex,power:2.2})}),this.finalRenderPass=new HC(t),this.finalRenderPass.init(null,{}),this.finalRenderPass.shader=this.shader,this.finalRenderPass.events.on("execute",()=>{const e=this.enabled&&this.sampleId>0;1!==this.blend?(t.setBlendColor(this.blend,this.blend,this.blend,this.blend),this.finalRenderPass.blendState=UC):this.finalRenderPass.blendState=VC,GC(t.scope,{texcoordMod:!e&&t.isWebGPU?[1,-1,0,1]:[1,1,0,0],multiframeTex:e?this.accumTexture:this.sourceTex,power:e?1/2.2:1})});const n=()=>{this.destroy()};t.once("destroy",n),t.on("devicelost",n)}get sourceTex(){return this.camera.renderTarget.colorBuffer}set samples(t){this.sampleArray=t,this.textureBias=-Math.log2(Math.sqrt(t.length)),this.sampleId=0}get samples(){return this.sampleArray}static generateSamples(t,e=!1,s=1,n=0){const i=[],r=Math.ceil(3*n)+1,a=.5*s;let o,l,h,c=0;for(let s=0;s<t;++s)for(let d=0;d<t;++d)e?(o=(s+Math.random())/t*2-1,l=(d+Math.random())/t*2-1):(o=s/(t-1)*2-1,l=d/(t-1)*2-1),h=n<=0?1:zC(o*r,n)*zC(l*r,n),c+=h,i.push(new rs(o*a,l*a,h));return i.forEach(t=>{t.z/=c}),i.sort((t,e)=>{const s=t.length(),n=e.length();return s<n?-1:n<s?1:0}),i}destroy(){this.accumRenderTarget&&(this.accumRenderTarget.destroy(),this.accumRenderTarget=null),this.accumTexture&&(this.accumTexture.destroy(),this.accumTexture=null)}moved(){this.sampleId=0,this.sampleAccum=0}update(){if(!this.enabled)return this.finalRenderPass.render(),!1;const t=this.sampleArray.length,{sourceTex:e}=this;return this.accumRenderTarget.resize(e.width,e.height),this.enabled&&this.sampleId<t&&this.updateRenderPass.render(),this.finalRenderPass.render(),this.sampleId<t}}const jC=new Float32Array(1),$C=new Uint8Array(jC.buffer),XC=new ls(2,2,2,1),qC=new ls(1,1,1,0);class KC{app;camera;picker;constructor(t,e){this.app=t,this.camera=e,this.picker=null}async pick(t,e){const{app:s,camera:n}=this,{graphicsDevice:i}=s,{canvas:r}=i,a=r.clientWidth,o=r.clientHeight;e=i.isWebGL2?o-e-1:e,this.picker||(this.picker=new rx(this.app,a,o));const{picker:l}=this;l.resize(a,o),l.prepare(n.camera,s.scene,[s.scene.layers.getLayerByName("World")]);const h=await l.renderTarget.colorBuffer.read(t,e,1,1,{renderTarget:l.renderTarget,immediate:!0});for(let t=0;t<4;++t)$C[t]=h[t];const c=jC[0];if(!isFinite(c))return null;const d=new ls(t/a,e/o,c,1).mul(XC).sub(qC);i.isWebGL2||(d.y*=-1),n.camera.projectionMatrix.clone().invert().transformVec4(d,d),d.mulScalar(1/d.w);const u=new rs(d.x,d.y,d.z);return n.getWorldTransform().transformPoint(u,u),u}}class YC{static WORKER_STR=function(){(()=>{let t=null;self.onmessage=async e=>{const s=e.data;if(s&&"init"===s.type)return self.__baseHref=s.baseHref,void(t=new Promise(t=>{const e=self.__baseHref;self.importScripts(`${e}static/lib/lodepng/lodepng.js`),t(self.lodepng({locateFile:()=>`${e}static/lib/lodepng/lodepng.wasm`}))}));if(!t)return;const n=((t,e,s,n)=>{const i=t._malloc(4),r=t._malloc(4),a=t._malloc(s*n*4);for(let i=0;i<n;++i){let r=i*s,o=a/4+(n-1-i)*s;for(let n=0;n<s;++n)t.HEAPU32[o++]=e[r++]}t._lodepng_encode32(i,r,a,s,n);const o=t.HEAPU8.slice(t.HEAPU32[i/4],t.HEAPU32[i/4]+t.HEAPU32[r/4]);return t._free(i),t._free(r),t._free(a),o})(await t,s.words,s.width,s.height);self.postMessage({result:n},void 0,[n.buffer])}})()}.toString();worker;receiveCallback;constructor(){let t=null;const e=new Blob([`(${YC.WORKER_STR})()\n\n`],{type:"application/javascript"});this.worker=new Worker(URL.createObjectURL(e)),this.worker.addEventListener("message",e=>{t(e)});const s=new URL(window.location.href),n=s.origin+s.pathname;this.worker.postMessage({type:"init",baseHref:n}),this.receiveCallback=e=>{t=s=>{e(s.data.result),t=null}}}_downloadFile(t,e){const s=new Blob([e],{type:"octet/stream"}),n=window.URL.createObjectURL(s),i=document.createElement("a");i.download=t,i.href=n,i.click(),window.URL.revokeObjectURL(n)}async export(t,e,s,n){this.worker.postMessage({type:"encode",words:e,width:s,height:n},[e.buffer]),this._downloadFile(t,await new Promise(this.receiveCallback))}}class QC{layer;material;plane;light;sceneRoot;camera;constructor(t,e,s,n){this.layer=new Ru({name:"Shadow Layer"});const i=t.scene.layers,r=i.getLayerByName("World"),a=i.getTransparentIndex(r);i.insert(this.layer,a+1),this.material=new hp,this.material.blendType=4,this.material.shadowCatcher=!0,this.material.useSkybox=!1,this.material.depthWrite=!1,this.material.diffuse.set(0,0,0),this.material.specular.set(0,0,0),this.material.shaderChunks.glsl.set("litUserMainEndPS","\n    gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0 - gl_FragColor.r);\n"),this.material.shaderChunks.wgsl.set("litUserMainEndPS","\n    output.color = vec4f(0.0, 0.0, 0.0, 1.0 - output.color.r);\n"),this.material.update(),this.plane=new Jm("ShadowPlane"),this.plane.addComponent("render",{type:"plane",castShadows:!1,material:this.material}),this.light=new Jm("ShadowLight"),this.light.addComponent("light",{type:"directional",castShadows:!0,normalOffsetBias:0,shadowBias:0,shadowResolution:1024,shadowType:2,shadowUpdateMode:2,vsmBlurSize:64,enabled:!0,shadowIntensity:.4}),s.addChild(this.plane),s.addChild(this.light),this.plane.render.layers=[this.layer.id],this.light.light.layers=[this.layer.id],e.layers=e.layers.concat([this.layer.id]),this.sceneRoot=n,this.camera=e}onEntityAdded(t){t.findComponents("render").forEach(t=>{this.layer.shadowCasters=this.layer.shadowCasters.concat(t.meshInstances)})}onEntityRemoved(t){t.findComponents("render").forEach(t=>{this.layer.shadowCasters=this.layer.shadowCasters.filter(e=>-1===t.meshInstances.indexOf(e))})}onUpdate(t){const e=t,s=e.center,n=Math.sqrt(e.halfExtents.x*e.halfExtents.x+e.halfExtents.z*e.halfExtents.z);this.plane.setLocalScale(4*n,1,4*n),this.plane.setPosition(s.x,e.getMin().y,s.z),this.light.light.shadowDistance=this.camera.camera._farClip}set enabled(t){this.layer.enabled=t,this.light.enabled=t}get enabled(){return this.layer.enabled}set intensity(t){this.light.light.shadowIntensity=t}get intensity(){return this.light.light.shadowIntensity}}var ZC=new Image;ZC.src="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' xmlns:svg='http://www.w3.org/2000/svg' width='1010' height='1000' version='1.1' style='background-color:rgba(32%2c32%2c32%2c.4)'%3e%3cg class='layer'%3e%3cpath id='svg_1' fill='white' d='m363%2c300l126%2c126l-58%2c58l-126%2c-126l-126%2c126l-58%2c-58l126%2c-126l-126%2c-126l58%2c-58l126%2c126l126%2c-126l58%2c58l-126%2c126z' transform='translate(205%2c 200)'/%3e%3c/g%3e%3c/svg%3e";var JC=new Image;JC.src="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' xmlns:svg='http://www.w3.org/2000/svg' width='1010' height='1000' version='1.1' style='background-color:rgba(32%2c32%2c32%2c.4)'%3e%3cg class='layer'%3e%3cpath id='svg_1' fill='white' d='m402.87%2c60.55l-15.2%2c28.51l-83.62%2c-47.51l-81.72%2c47.51l-15.2%2c-28.51l96.92%2c-58.91l98.82%2c58.91zm-239.45%2c62.71l-64.61%2c38.01l58.91%2c34.21l-19%2c26.61l-57.01%2c-30.41l0%2c72.21l-34.21%2c0l0%2c-110.22l98.82%2c-58.91l17.1%2c28.51zm399.08%2c140.63l-34.21%2c0l0%2c-72.21l-55.11%2c30.41l-19%2c-26.61l58.91%2c-34.21l-66.51%2c-38.01l17.1%2c-28.51l98.82%2c58.91l0%2c110.22zm-271.75%2c43.71l-72.21%2c-41.81l13.3%2c-26.61l74.11%2c41.81l74.11%2c-41.81l15.2%2c26.61l-72.21%2c41.81l0%2c81.72l-32.31%2c0l0%2c-81.72zm-127.32%2c171.03l-17.1%2c28.51l-98.82%2c-58.91l0%2c-112.12l34.21%2c0l0%2c93.12l81.72%2c49.41zm399.08%2c-142.53l0%2c112.12l-98.82%2c58.91l-17.1%2c-28.51l81.72%2c-49.41l0%2c-93.12l34.21%2c0zm-159.63%2c203.34l-98.82%2c58.91l-96.92%2c-58.91l15.2%2c-28.51l68.41%2c39.91l0%2c-70.31l32.31%2c0l0%2c68.41l64.61%2c-38.01l15.2%2c28.51z' transform='translate(205%2c 200)'/%3e%3c/g%3e%3c/svg%3e";const tE=new rs,eE=new rs,sE=new rs,nE=new rs,iE=new ps,rE=(t,e)=>(t%e+e)%e;class aE{value;source;target;timer=0;transitionTime=0;constructor(t){this.value=t,this.source={...t},this.target={...t}}goto(t,e=.25){0===e&&aE.copy(this.value,t),aE.copy(this.source,this.value),aE.copy(this.target,t),this.timer=0,this.transitionTime=e}update(t){this.timer<this.transitionTime?(this.timer=Math.min(this.timer+t,this.transitionTime),aE.lerp(this.value,this.source,this.target,aE.quintic(this.timer/this.transitionTime))):aE.copy(this.value,this.target)}static quintic(t){return Math.pow(t-1,5)+1}static copy(t,e){Object.keys(t).forEach(s=>{t[s]=e[s]})}static lerp(t,e,s,n){Object.keys(t).forEach(i=>{t[i]=e[i]+n*(s[i]-e[i])})}}class oE{options;dom;events=new Ve;active=!1;rotating=!1;constructor(t){this.options=t;const e=t.xr;e.domOverlay.root=this._createRotateInput(),this.options.showUI&&this._createUI(),this._createModelHandler();e.on(`available: ${oS}`,t=>{this.events.fire("xr:available",t)}),e.on("start",()=>{var t;this.active=!0,this.events.fire("xr:started"),t=t=>{this.events.fire("xr:initial-place",t),navigator?.vibrate(10),e.hitTest.start({profile:"generic-touchscreen",entityTypes:[hS,cS,dS],callback:(t,e)=>{t?console.log(t):e.on("result",t=>{this.rotating||this.events.fire("xr:place",t)})}})},e.hitTest.start({spaceType:lS,entityTypes:[hS,cS,dS],callback:(e,s)=>{e?console.log(e):s.on("result",e=>{t(e),s.remove()})}})}),e.on("end",()=>{this.active=!1,this.events.fire("xr:ended")})}get available(){return this.options.xr.isAvailable(oS)}_createRotateInput(){const t=new Map;let e=0,s=0;const n=t=>{t.preventDefault(),t.stopPropagation()},i=e=>{n(e),t.set(e.pointerId,{start:{x:e.clientX,y:e.clientY},previous:{x:e.clientX,y:e.clientY},current:{x:e.clientX,y:e.clientY}}),this.rotating?1===t.size&&(this.rotating=!1):this.rotating=t.size>1},r=i=>{n(i);const r=t.get(i.pointerId);if(r&&(r.previous.x=r.current.x,r.previous.y=r.current.y,r.current.x=i.clientX,r.current.y=i.clientY),2===t.size){const n=Array.from(t.keys()),i=t.get(n[0]),r=t.get(n[1]),a=Math.atan2(r.start.y-i.start.y,r.start.x-i.start.x),o=Math.atan2(r.current.y-i.current.y,r.current.x-i.current.x);s=o-a,this.events.fire("xr:rotate",-180*(e+s)/Math.PI)}},a=i=>{n(i),2===t.size&&(e+=s),t.delete(i.pointerId)},o=document.createElement("div");return o.style.position="fixed",o.style.top="0",o.style.left="0",o.style.width="100%",o.style.height="100%",o.style.touchAction="none",o.style.display="none",document.body.appendChild(o),this.events.on("xr:started",()=>{o.style.display="block",o.addEventListener("pointerdown",i),o.addEventListener("pointermove",r),o.addEventListener("pointerup",a)}),this.events.on("xr:ended",()=>{o.style.display="none",o.removeEventListener("pointerdown",i),o.removeEventListener("pointermove",r),o.removeEventListener("pointerup",a)}),o}_createUI(){const t=document.createElement("img");t.src=this.options.startArImgSrc,t.style.position="fixed",t.style.right="20px",t.style.top="20px",t.style.width="36px",t.style.height="36px",t.style.opacity="100%",t.style.display="none",document.body.appendChild(t);let e=!0;this.events.on("xr:available",e=>{t.style.display=e?"block":"none"}),this.events.on("xr:started",()=>{e=!0,t.src=this.options.stopArImgSrc,this.options.xr.domOverlay.root.appendChild(t)}),this.events.on("xr:ended",()=>{e=!0,t.src=this.options.startArImgSrc,document.body.appendChild(t)}),t.addEventListener("click",()=>{e&&(e=!1,this.active?this.end():this.start())})}_createModelHandler(){const t=this.options.xr,e=this.events,s=new aE({x:0,y:0,z:0}),n=new aE({x:0,y:0,z:0}),i=new aE({scale:1}),r=.25;let a=!0;const o=new rs,l=new Ss;let h;const c=()=>{if(h.length){l.copy(h[0].aabb);for(let t=1;t<h.length;++t)l.add(h[t].aabb)}};e.on("xr:start",()=>{a=!0,h=this.options.content.findComponents("render").map(t=>t.meshInstances).flat().concat(this.options.content.findComponents("gsplat").map(t=>t.instance.meshInstance)),c();const t=l.halfExtents;o.set(0,-t.y,4*-t.length())}),e.on("xr:initial-place",e=>{iE.copy(t.camera.camera.viewMatrix).invert(),iE.transformPoint(o,tE),iE.getEulerAngles(eE),s.goto({x:tE.x,y:tE.y,z:tE.z},0),n.goto({x:eE.x,y:eE.y,z:eE.z},0),i.goto({scale:.55},0),n.goto({x:0,y:0,z:0},r),s.goto({x:e.x,y:e.y,z:e.z},r),a=!1}),e.on("xr:place",t=>{s.goto({x:t.x,y:t.y,z:t.z},r)}),e.on("xr:rotate",t=>{t=rE(t,360),n.goto({x:0,y:t,z:0},r),n.source.y=t-180+rE(n.source.y-t+180,360)}),e.on("xr:ended",()=>{this.options.content.setLocalPosition(0,0,0),this.options.content.setLocalEulerAngles(0,0,0)}),t.app.on("frameupdate",t=>{const e=t/1e3;s.update(e),n.update(e),i.update(e)}),t.on("update",()=>{const t=this.options.xr;if(!t.views.list.length)return;iE.copy(t.camera.camera.viewMatrix).invert();const e=this.options.content;a?(iE.transformPoint(o,tE),iE.getEulerAngles(eE),e.setLocalPosition(tE.x,tE.y,tE.z),e.setLocalEulerAngles(eE.x,eE.y,eE.z),e.setLocalScale(1,1,1)):(e.setLocalPosition(s.value.x,s.value.y,s.value.z),e.setLocalEulerAngles(n.value.x,n.value.y,n.value.z),e.setLocalScale(i.value.scale,i.value.scale,i.value.scale)),c();const r=l.center,h=l.halfExtents.length();iE.getZ(nE),iE.getTranslation(sE),tE.sub2(r,sE);const d=-tE.dot(nE),u=d+h,f=Math.max(1e-4,d<h?u/1024:d-h);t._setClipPlanes(f/1.5,1.5*u),this.events.fire("xr:update")})}start(){this.available&&!this.active&&(this.events.fire("xr:start"),this.options.xr.start(this.options.camera.camera,oS,"local",{callback:t=>{t&&console.log(t)}}))}end(){this.options.xr.end()}}var lE=function(){var t=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]),e=new Uint8Array([32,0,65,2,1,106,34,33,3,128,11,4,13,64,6,253,10,7,15,116,127,5,8,12,40,16,19,54,20,9,27,255,113,17,42,67,24,23,146,148,18,14,22,45,70,69,56,114,101,21,25,63,75,136,108,28,118,29,73,115]);if("object"!=typeof WebAssembly)return{supported:!1};var s,n=WebAssembly.validate(t)?"b9H79TebbbeKl9Gbb9Gvuuuuueu9Giuuub9Geueuikqbbebeedddilve9Weeeviebeoweuec:q;Aekr;leDo9TW9T9VV95dbH9F9F939H79T9F9J9H229F9Jt9VV7bb8A9TW79O9V9Wt9F9KW9J9V9KW9wWVtW949c919M9MWVbdY9TW79O9V9Wt9F9KW9J9V9KW69U9KW949c919M9MWVblE9TW79O9V9Wt9F9KW9J9V9KW69U9KW949tWG91W9U9JWbvL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9p9JtboK9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9r919HtbrL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWVT949Wbwl79IV9RbDq;t9tqlbzik9:evu8Jjjjjbcz9Rhbcbheincbhdcbhiinabcwfadfaicjuaead4ceGglE86bbaialfhiadcefgdcw9hmbkaec:q:yjjbfai86bbaecitc:q1jjbfab8Piw83ibaecefgecjd9hmbkk;h8JlHud97euo978Jjjjjbcj;kb9Rgv8Kjjjjbc9:hodnadcefal0mbcuhoaiRbbc:Ge9hmbavaialfgrad9Rad;8qbbcj;abad9UhoaicefhldnadTmbaoc;WFbGgocjdaocjd6EhwcbhDinaDae9pmeawaeaD9RaDawfae6Egqcsfgoc9WGgkci2hxakcethmaocl4cifcd4hPabaDad2fhscbhzdnincehHalhOcbhAdninaraO9RaP6miavcj;cbfaAak2fhCaOaPfhlcbhidnakc;ab6mbaral9Rc;Gb6mbcbhoinaCaofhidndndndndnaOaoco4fRbbgXciGPlbedibkaipxbbbbbbbbbbbbbbbbpklbxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaialpbbbpklbalczfhlkdndndndndnaXcd4ciGPlbedibkaipxbbbbbbbbbbbbbbbbpklzxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklzalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklzalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaialpbbbpklzalczfhlkdndndndndnaXcl4ciGPlbedibkaipxbbbbbbbbbbbbbbbbpklaxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklaalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklaalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaialpbbbpklaalczfhlkdndndndndnaXco4Plbedibkaipxbbbbbbbbbbbbbbbbpkl8WxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibaXc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spkl8WalclfaYpQbfaXc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibaXc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spkl8WalcwfaYpQbfaXc:q:yjjbfRbbfhlxekaialpbbbpkl8Walczfhlkaoc;abfhiaocjefak0meaihoaral9Rc;Fb0mbkkdndnaiak9pmbaici4hoinaral9RcK6mdaCaifhXdndndndndnaOaico4fRbbaocoG4ciGPlbedibkaXpxbbbbbbbbbbbbbbbbpklbxikaXalpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaXalpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaXalpbbbpklbalczfhlkaocdfhoaiczfgiak6mbkkalTmbaAci6hHalhOaAcefgohAaoclSmdxekkcbhlaHceGmdkdnakTmbavcjdfazfhiavazfpbdbhYcbhXinaiavcj;cbfaXfgopblbgLcep9TaLpxeeeeeeeeeeeeeeeegQp9op9Hp9rgLaoakfpblbg8Acep9Ta8AaQp9op9Hp9rg8ApmbzeHdOiAlCvXoQrLgEaoamfpblbg3cep9Ta3aQp9op9Hp9rg3aoaxfpblbg5cep9Ta5aQp9op9Hp9rg5pmbzeHdOiAlCvXoQrLg8EpmbezHdiOAlvCXorQLgQaQpmbedibedibedibediaYp9UgYp9AdbbaiadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfgoaYaEa8EpmwDKYqk8AExm35Ps8E8FgQaQpmbedibedibedibedip9UgYp9AdbbaoadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfgoaYaLa8ApmwKDYq8AkEx3m5P8Es8FgLa3a5pmwKDYq8AkEx3m5P8Es8Fg8ApmbezHdiOAlvCXorQLgQaQpmbedibedibedibedip9UgYp9AdbbaoadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfgoaYaLa8ApmwDKYqk8AExm35Ps8E8FgQaQpmbedibedibedibedip9UgYp9AdbbaoadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfhiaXczfgXak6mbkkazclfgzad6mbkasavcjdfaqad2;8qbbavavcjdfaqcufad2fad;8qbbaqaDfhDc9:hoalmexikkc9:hoxekcbc99aral9Radcaadca0ESEhokavcj;kbf8Kjjjjbaokwbz:bjjjbk;uzeHu8Jjjjjbc;ae9Rgv8Kjjjjbc9:hodnaeci9UgrcHfal0mbcuhoaiRbbgwc;WeGc;Ge9hmbawcsGgDce0mbavc;abfcFecje;8kbavcUf9cu83ibavc8Wf9cu83ibavcyf9cu83ibavcaf9cu83ibavcKf9cu83ibavczf9cu83ibav9cu83iwav9cu83ibaialfc9WfhqaicefgwarfhodnaeTmbcmcsaDceSEhkcbhxcbhmcbhDcbhicbhlindnaoaq9nmbc9:hoxikdndnawRbbgrc;Ve0mbavc;abfalarcl4cu7fcsGcitfgPydlhsaPydbhzdnarcsGgPak9pmbavaiarcu7fcsGcdtfydbaxaPEhraPThPdndnadcd9hmbabaDcetfgHaz87ebaHcdfas87ebaHclfar87ebxekabaDcdtfgHazBdbaHclfasBdbaHcwfarBdbkaxaPfhxavc;abfalcitfgHarBdbaHasBdlavaicdtfarBdbavc;abfalcefcsGglcitfgHazBdbaHarBdlaiaPfhialcefhlxdkdndnaPcsSmbamaPfaPc987fcefhmxekaocefhrao8SbbgPcFeGhHdndnaPcu9mmbarhoxekaocvfhoaHcFbGhHcrhPdninar8SbbgOcFbGaPtaHVhHaOcu9kmearcefhraPcrfgPc8J9hmbxdkkarcefhokaHce4cbaHceG9R7amfhmkdndnadcd9hmbabaDcetfgraz87ebarcdfas87ebarclfam87ebxekabaDcdtfgrazBdbarclfasBdbarcwfamBdbkavc;abfalcitfgramBdbarasBdlavaicdtfamBdbavc;abfalcefcsGglcitfgrazBdbaramBdlaicefhialcefhlxekdnarcpe0mbaxcefgOavaiaqarcsGfRbbgPcl49RcsGcdtfydbaPcz6gHEhravaiaP9RcsGcdtfydbaOaHfgsaPcsGgOEhPaOThOdndnadcd9hmbabaDcetfgzax87ebazcdfar87ebazclfaP87ebxekabaDcdtfgzaxBdbazclfarBdbazcwfaPBdbkavaicdtfaxBdbavc;abfalcitfgzarBdbazaxBdlavaicefgicsGcdtfarBdbavc;abfalcefcsGcitfgzaPBdbazarBdlavaiaHfcsGgicdtfaPBdbavc;abfalcdfcsGglcitfgraxBdbaraPBdlalcefhlaiaOfhiasaOfhxxekaxcbaoRbbgzEgAarc;:eSgrfhsazcsGhCazcl4hXdndnazcs0mbascefhOxekashOavaiaX9RcsGcdtfydbhskdndnaCmbaOcefhxxekaOhxavaiaz9RcsGcdtfydbhOkdndnarTmbaocefhrxekaocdfhrao8SbegHcFeGhPdnaHcu9kmbaocofhAaPcFbGhPcrhodninar8SbbgHcFbGaotaPVhPaHcu9kmearcefhraocrfgoc8J9hmbkaAhrxekarcefhrkaPce4cbaPceG9R7amfgmhAkdndnaXcsSmbarhPxekarcefhPar8SbbgocFeGhHdnaocu9kmbarcvfhsaHcFbGhHcrhodninaP8SbbgrcFbGaotaHVhHarcu9kmeaPcefhPaocrfgoc8J9hmbkashPxekaPcefhPkaHce4cbaHceG9R7amfgmhskdndnaCcsSmbaPhoxekaPcefhoaP8SbbgrcFeGhHdnarcu9kmbaPcvfhOaHcFbGhHcrhrdninao8SbbgPcFbGartaHVhHaPcu9kmeaocefhoarcrfgrc8J9hmbkaOhoxekaocefhokaHce4cbaHceG9R7amfgmhOkdndnadcd9hmbabaDcetfgraA87ebarcdfas87ebarclfaO87ebxekabaDcdtfgraABdbarclfasBdbarcwfaOBdbkavc;abfalcitfgrasBdbaraABdlavaicdtfaABdbavc;abfalcefcsGcitfgraOBdbarasBdlavaicefgicsGcdtfasBdbavc;abfalcdfcsGcitfgraABdbaraOBdlavaiazcz6aXcsSVfgicsGcdtfaOBdbaiaCTaCcsSVfhialcifhlkawcefhwalcsGhlaicsGhiaDcifgDae6mbkkcbc99aoaqSEhokavc;aef8Kjjjjbaok:llevu8Jjjjjbcz9Rhvc9:hodnaecvfal0mbcuhoaiRbbc;:eGc;qe9hmbav9cb83iwaicefhraialfc98fhwdnaeTmbdnadcdSmbcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcdtfaicd4cbaice4ceG9R7avcwfaiceGcdtVgoydbfglBdbaoalBdbaDcefgDae9hmbxdkkcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcetfaicd4cbaice4ceG9R7avcwfaiceGcdtVgoydbfgl87ebaoalBdbaDcefgDae9hmbkkcbc99arawSEhokaok:EPliuo97eue978Jjjjjbca9Rhidndnadcl9hmbdnaec98GglTmbcbhvabhdinadadpbbbgocKp:RecKp:Sep;6egraocwp:RecKp:Sep;6earp;Geaoczp:RecKp:Sep;6egwp;Gep;Kep;LegDpxbbbbbbbbbbbbbbbbp:2egqarpxbbbjbbbjbbbjbbbjgkp9op9rp;Kegrpxbb;:9cbb;:9cbb;:9cbb;:9cararp;MeaDaDp;Meawaqawakp9op9rp;Kegrarp;Mep;Kep;Kep;Jep;Negwp;Mepxbbn0bbn0bbn0bbn0gqp;KepxFbbbFbbbFbbbFbbbp9oaopxbbbFbbbFbbbFbbbFp9op9qarawp;Meaqp;Kecwp:RepxbFbbbFbbbFbbbFbbp9op9qaDawp;Meaqp;Keczp:RepxbbFbbbFbbbFbbbFbp9op9qpkbbadczfhdavclfgval6mbkkalae9pmeaiaeciGgvcdtgdVcbczad9R;8kbaiabalcdtfglad;8qbbdnavTmbaiaipblbgocKp:RecKp:Sep;6egraocwp:RecKp:Sep;6earp;Geaoczp:RecKp:Sep;6egwp;Gep;Kep;LegDpxbbbbbbbbbbbbbbbbp:2egqarpxbbbjbbbjbbbjbbbjgkp9op9rp;Kegrpxbb;:9cbb;:9cbb;:9cbb;:9cararp;MeaDaDp;Meawaqawakp9op9rp;Kegrarp;Mep;Kep;Kep;Jep;Negwp;Mepxbbn0bbn0bbn0bbn0gqp;KepxFbbbFbbbFbbbFbbbp9oaopxbbbFbbbFbbbFbbbFp9op9qarawp;Meaqp;Kecwp:RepxbFbbbFbbbFbbbFbbp9op9qaDawp;Meaqp;Keczp:RepxbbFbbbFbbbFbbbFbp9op9qpklbkalaiad;8qbbskdnaec98GgxTmbcbhvabhdinadczfglalpbbbgopxbbbbbbFFbbbbbbFFgkp9oadpbbbgDaopmlvorxmPsCXQL358E8FpxFubbFubbFubbFubbp9op;6eaDaopmbediwDqkzHOAKY8AEgoczp:Sep;6egrp;Geaoczp:Reczp:Sep;6egwp;Gep;Kep;Legopxb;:FSb;:FSb;:FSb;:FSawaopxbbbbbbbbbbbbbbbbp:2egqawpxbbbjbbbjbbbjbbbjgmp9op9rp;Kegwawp;Meaoaop;Mearaqaramp9op9rp;Kegoaop;Mep;Kep;Kep;Jep;Negrp;Mepxbbn0bbn0bbn0bbn0gqp;Keczp:Reawarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9op9qgwaoarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9ogopmwDKYqk8AExm35Ps8E8Fp9qpkbbadaDakp9oawaopmbezHdiOAlvCXorQLp9qpkbbadcafhdavclfgvax6mbkkaxae9pmbaiaeciGgvcitgdfcbcaad9R;8kbaiabaxcitfglad;8qbbdnavTmbaiaipblzgopxbbbbbbFFbbbbbbFFgkp9oaipblbgDaopmlvorxmPsCXQL358E8FpxFubbFubbFubbFubbp9op;6eaDaopmbediwDqkzHOAKY8AEgoczp:Sep;6egrp;Geaoczp:Reczp:Sep;6egwp;Gep;Kep;Legopxb;:FSb;:FSb;:FSb;:FSawaopxbbbbbbbbbbbbbbbbp:2egqawpxbbbjbbbjbbbjbbbjgmp9op9rp;Kegwawp;Meaoaop;Mearaqaramp9op9rp;Kegoaop;Mep;Kep;Kep;Jep;Negrp;Mepxbbn0bbn0bbn0bbn0gqp;Keczp:Reawarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9op9qgwaoarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9ogopmwDKYqk8AExm35Ps8E8Fp9qpklzaiaDakp9oawaopmbezHdiOAlvCXorQLp9qpklbkalaiad;8qbbkk;4wllue97euv978Jjjjjbc8W9Rhidnaec98GglTmbcbhvabhoinaiaopbbbgraoczfgwpbbbgDpmlvorxmPsCXQL358E8Fgqczp:Segkclp:RepklbaopxbbjZbbjZbbjZbbjZpx;Zl81Z;Zl81Z;Zl81Z;Zl81Zakpxibbbibbbibbbibbbp9qp;6ep;NegkaraDpmbediwDqkzHOAKY8AEgrczp:Reczp:Sep;6ep;MegDaDp;Meakarczp:Sep;6ep;Megxaxp;Meakaqczp:Reczp:Sep;6ep;Megqaqp;Mep;Kep;Kep;Lepxbbbbbbbbbbbbbbbbp:4ep;Jepxb;:FSb;:FSb;:FSb;:FSgkp;Mepxbbn0bbn0bbn0bbn0grp;KepxFFbbFFbbFFbbFFbbgmp9oaxakp;Mearp;Keczp:Rep9qgxaqakp;Mearp;Keczp:ReaDakp;Mearp;Keamp9op9qgkpmbezHdiOAlvCXorQLgrp5baipblbpEb:T:j83ibaocwfarp5eaipblbpEe:T:j83ibawaxakpmwDKYqk8AExm35Ps8E8Fgkp5baipblbpEd:T:j83ibaocKfakp5eaipblbpEi:T:j83ibaocafhoavclfgval6mbkkdnalae9pmbaiaeciGgvcitgofcbcaao9R;8kbaiabalcitfgwao;8qbbdnavTmbaiaipblbgraipblzgDpmlvorxmPsCXQL358E8Fgqczp:Segkclp:RepklaaipxbbjZbbjZbbjZbbjZpx;Zl81Z;Zl81Z;Zl81Z;Zl81Zakpxibbbibbbibbbibbbp9qp;6ep;NegkaraDpmbediwDqkzHOAKY8AEgrczp:Reczp:Sep;6ep;MegDaDp;Meakarczp:Sep;6ep;Megxaxp;Meakaqczp:Reczp:Sep;6ep;Megqaqp;Mep;Kep;Kep;Lepxbbbbbbbbbbbbbbbbp:4ep;Jepxb;:FSb;:FSb;:FSb;:FSgkp;Mepxbbn0bbn0bbn0bbn0grp;KepxFFbbFFbbFFbbFFbbgmp9oaxakp;Mearp;Keczp:Rep9qgxaqakp;Mearp;Keczp:ReaDakp;Mearp;Keamp9op9qgkpmbezHdiOAlvCXorQLgrp5baipblapEb:T:j83ibaiarp5eaipblapEe:T:j83iwaiaxakpmwDKYqk8AExm35Ps8E8Fgkp5baipblapEd:T:j83izaiakp5eaipblapEi:T:j83iKkawaiao;8qbbkk:Pddiue978Jjjjjbc;ab9Rhidnadcd4ae2glc98GgvTmbcbhdabheinaeaepbbbgocwp:Recwp:Sep;6eaocep:SepxbbjZbbjZbbjZbbjZp:UepxbbjFbbjFbbjFbbjFp9op;Mepkbbaeczfheadclfgdav6mbkkdnaval9pmbaialciGgdcdtgeVcbc;abae9R;8kbaiabavcdtfgvae;8qbbdnadTmbaiaipblbgocwp:Recwp:Sep;6eaocep:SepxbbjZbbjZbbjZbbjZp:UepxbbjFbbjFbbjFbbjFp9op;Mepklbkavaiae;8qbbkk9teiucbcbydj1jjbgeabcifc98GfgbBdj1jjbdndnabZbcztgd9nmbcuhiabad9RcFFifcz4nbcuSmekaehikaikkkebcjwklz9Tbb":"b9H79Tebbbe8Fv9Gbb9Gvuuuuueu9Giuuub9Geueu9Giuuueuikqbeeedddillviebeoweuec:q;iekr;leDo9TW9T9VV95dbH9F9F939H79T9F9J9H229F9Jt9VV7bb8A9TW79O9V9Wt9F9KW9J9V9KW9wWVtW949c919M9MWVbeY9TW79O9V9Wt9F9KW9J9V9KW69U9KW949c919M9MWVbdE9TW79O9V9Wt9F9KW9J9V9KW69U9KW949tWG91W9U9JWbiL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9p9JtblK9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9r919HtbvL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWVT949Wbol79IV9Rbrq:P8Yqdbk;3sezu8Jjjjjbcj;eb9Rgv8Kjjjjbc9:hodnadcefal0mbcuhoaiRbbc:Ge9hmbavaialfgrad9Radz1jjjbhwcj;abad9UhoaicefhldnadTmbaoc;WFbGgocjdaocjd6EhDcbhqinaqae9pmeaDaeaq9RaqaDfae6Egkcsfgocl4cifcd4hxdndndndnaoc9WGgmTmbcbhPcehsawcjdfhzalhHinaraH9Rax6midnaraHaxfgl9RcK6mbczhoinawcj;cbfaogifgoc9WfhOdndndndndnaHaic9WfgAco4fRbbaAci4coG4ciGPlbedibkaO9cb83ibaOcwf9cb83ibxikaOalRblalRbbgAco4gCaCciSgCE86bbaocGfalclfaCfgORbbaAcl4ciGgCaCciSgCE86bbaocVfaOaCfgORbbaAcd4ciGgCaCciSgCE86bbaoc7faOaCfgORbbaAciGgAaAciSgAE86bbaoctfaOaAfgARbbalRbegOco4gCaCciSgCE86bbaoc91faAaCfgARbbaOcl4ciGgCaCciSgCE86bbaoc4faAaCfgARbbaOcd4ciGgCaCciSgCE86bbaoc93faAaCfgARbbaOciGgOaOciSgOE86bbaoc94faAaOfgARbbalRbdgOco4gCaCciSgCE86bbaoc95faAaCfgARbbaOcl4ciGgCaCciSgCE86bbaoc96faAaCfgARbbaOcd4ciGgCaCciSgCE86bbaoc97faAaCfgARbbaOciGgOaOciSgOE86bbaoc98faAaOfgORbbalRbiglco4gAaAciSgAE86bbaoc99faOaAfgORbbalcl4ciGgAaAciSgAE86bbaoc9:faOaAfgORbbalcd4ciGgAaAciSgAE86bbaocufaOaAfgoRbbalciGglalciSglE86bbaoalfhlxdkaOalRbwalRbbgAcl4gCaCcsSgCE86bbaocGfalcwfaCfgORbbaAcsGgAaAcsSgAE86bbaocVfaOaAfgORbbalRbegAcl4gCaCcsSgCE86bbaoc7faOaCfgORbbaAcsGgAaAcsSgAE86bbaoctfaOaAfgORbbalRbdgAcl4gCaCcsSgCE86bbaoc91faOaCfgORbbaAcsGgAaAcsSgAE86bbaoc4faOaAfgORbbalRbigAcl4gCaCcsSgCE86bbaoc93faOaCfgORbbaAcsGgAaAcsSgAE86bbaoc94faOaAfgORbbalRblgAcl4gCaCcsSgCE86bbaoc95faOaCfgORbbaAcsGgAaAcsSgAE86bbaoc96faOaAfgORbbalRbvgAcl4gCaCcsSgCE86bbaoc97faOaCfgORbbaAcsGgAaAcsSgAE86bbaoc98faOaAfgORbbalRbogAcl4gCaCcsSgCE86bbaoc99faOaCfgORbbaAcsGgAaAcsSgAE86bbaoc9:faOaAfgORbbalRbrglcl4gAaAcsSgAE86bbaocufaOaAfgoRbbalcsGglalcsSglE86bbaoalfhlxekaOal8Pbb83bbaOcwfalcwf8Pbb83bbalczfhlkdnaiam9pmbaiczfhoaral9RcL0mekkaiam6mialTmidnakTmbawaPfRbbhOcbhoazhiinaiawcj;cbfaofRbbgAce4cbaAceG9R7aOfgO86bbaiadfhiaocefgoak9hmbkkazcefhzaPcefgPad6hsalhHaPad9hmexvkkcbhlasceGmdxikalaxad2fhCdnakTmbcbhHcehsawcjdfhminaral9Rax6mialTmdalaxfhlawaHfRbbhOcbhoamhiinaiawcj;cbfaofRbbgAce4cbaAceG9R7aOfgO86bbaiadfhiaocefgoak9hmbkamcefhmaHcefgHad6hsaHad9hmbkaChlxikcbhocehsinaral9Rax6mdalTmealaxfhlaocefgoad6hsadao9hmbkaChlxdkcbhlasceGTmekc9:hoxikabaqad2fawcjdfakad2z1jjjb8Aawawcjdfakcufad2fadz1jjjb8Aakaqfhqalmbkc9:hoxekcbc99aral9Radcaadca0ESEhokavcj;ebf8Kjjjjbaok;yzeHu8Jjjjjbc;ae9Rgv8Kjjjjbc9:hodnaeci9UgrcHfal0mbcuhoaiRbbgwc;WeGc;Ge9hmbawcsGgDce0mbavc;abfcFecjez:jjjjb8AavcUf9cu83ibavc8Wf9cu83ibavcyf9cu83ibavcaf9cu83ibavcKf9cu83ibavczf9cu83ibav9cu83iwav9cu83ibaialfc9WfhqaicefgwarfhodnaeTmbcmcsaDceSEhkcbhxcbhmcbhDcbhicbhlindnaoaq9nmbc9:hoxikdndnawRbbgrc;Ve0mbavc;abfalarcl4cu7fcsGcitfgPydlhsaPydbhzdnarcsGgPak9pmbavaiarcu7fcsGcdtfydbaxaPEhraPThPdndnadcd9hmbabaDcetfgHaz87ebaHcdfas87ebaHclfar87ebxekabaDcdtfgHazBdbaHclfasBdbaHcwfarBdbkaxaPfhxavc;abfalcitfgHarBdbaHasBdlavaicdtfarBdbavc;abfalcefcsGglcitfgHazBdbaHarBdlaiaPfhialcefhlxdkdndnaPcsSmbamaPfaPc987fcefhmxekaocefhrao8SbbgPcFeGhHdndnaPcu9mmbarhoxekaocvfhoaHcFbGhHcrhPdninar8SbbgOcFbGaPtaHVhHaOcu9kmearcefhraPcrfgPc8J9hmbxdkkarcefhokaHce4cbaHceG9R7amfhmkdndnadcd9hmbabaDcetfgraz87ebarcdfas87ebarclfam87ebxekabaDcdtfgrazBdbarclfasBdbarcwfamBdbkavc;abfalcitfgramBdbarasBdlavaicdtfamBdbavc;abfalcefcsGglcitfgrazBdbaramBdlaicefhialcefhlxekdnarcpe0mbaxcefgOavaiaqarcsGfRbbgPcl49RcsGcdtfydbaPcz6gHEhravaiaP9RcsGcdtfydbaOaHfgsaPcsGgOEhPaOThOdndnadcd9hmbabaDcetfgzax87ebazcdfar87ebazclfaP87ebxekabaDcdtfgzaxBdbazclfarBdbazcwfaPBdbkavaicdtfaxBdbavc;abfalcitfgzarBdbazaxBdlavaicefgicsGcdtfarBdbavc;abfalcefcsGcitfgzaPBdbazarBdlavaiaHfcsGgicdtfaPBdbavc;abfalcdfcsGglcitfgraxBdbaraPBdlalcefhlaiaOfhiasaOfhxxekaxcbaoRbbgzEgAarc;:eSgrfhsazcsGhCazcl4hXdndnazcs0mbascefhOxekashOavaiaX9RcsGcdtfydbhskdndnaCmbaOcefhxxekaOhxavaiaz9RcsGcdtfydbhOkdndnarTmbaocefhrxekaocdfhrao8SbegHcFeGhPdnaHcu9kmbaocofhAaPcFbGhPcrhodninar8SbbgHcFbGaotaPVhPaHcu9kmearcefhraocrfgoc8J9hmbkaAhrxekarcefhrkaPce4cbaPceG9R7amfgmhAkdndnaXcsSmbarhPxekarcefhPar8SbbgocFeGhHdnaocu9kmbarcvfhsaHcFbGhHcrhodninaP8SbbgrcFbGaotaHVhHarcu9kmeaPcefhPaocrfgoc8J9hmbkashPxekaPcefhPkaHce4cbaHceG9R7amfgmhskdndnaCcsSmbaPhoxekaPcefhoaP8SbbgrcFeGhHdnarcu9kmbaPcvfhOaHcFbGhHcrhrdninao8SbbgPcFbGartaHVhHaPcu9kmeaocefhoarcrfgrc8J9hmbkaOhoxekaocefhokaHce4cbaHceG9R7amfgmhOkdndnadcd9hmbabaDcetfgraA87ebarcdfas87ebarclfaO87ebxekabaDcdtfgraABdbarclfasBdbarcwfaOBdbkavc;abfalcitfgrasBdbaraABdlavaicdtfaABdbavc;abfalcefcsGcitfgraOBdbarasBdlavaicefgicsGcdtfasBdbavc;abfalcdfcsGcitfgraABdbaraOBdlavaiazcz6aXcsSVfgicsGcdtfaOBdbaiaCTaCcsSVfhialcifhlkawcefhwalcsGhlaicsGhiaDcifgDae6mbkkcbc99aoaqSEhokavc;aef8Kjjjjbaok:llevu8Jjjjjbcz9Rhvc9:hodnaecvfal0mbcuhoaiRbbc;:eGc;qe9hmbav9cb83iwaicefhraialfc98fhwdnaeTmbdnadcdSmbcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcdtfaicd4cbaice4ceG9R7avcwfaiceGcdtVgoydbfglBdbaoalBdbaDcefgDae9hmbxdkkcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcetfaicd4cbaice4ceG9R7avcwfaiceGcdtVgoydbfgl87ebaoalBdbaDcefgDae9hmbkkcbc99arawSEhokaok:Lvoeue99dud99eud99dndnadcl9hmbaeTmeindndnabcdfgd8Sbb:Yab8Sbbgi:Ygl:l:tabcefgv8Sbbgo:Ygr:l:tgwJbb;:9cawawNJbbbbawawJbbbb9GgDEgq:mgkaqaicb9iEalMgwawNakaqaocb9iEarMgqaqNMM:r:vglNJbbbZJbbb:;aDEMgr:lJbbb9p9DTmbar:Ohixekcjjjj94hikadai86bbdndnaqalNJbbbZJbbb:;aqJbbbb9GEMgq:lJbbb9p9DTmbaq:Ohdxekcjjjj94hdkavad86bbdndnawalNJbbbZJbbb:;awJbbbb9GEMgw:lJbbb9p9DTmbaw:Ohdxekcjjjj94hdkabad86bbabclfhbaecufgembxdkkaeTmbindndnabclfgd8Ueb:Yab8Uebgi:Ygl:l:tabcdfgv8Uebgo:Ygr:l:tgwJb;:FSawawNJbbbbawawJbbbb9GgDEgq:mgkaqaicb9iEalMgwawNakaqaocb9iEarMgqaqNMM:r:vglNJbbbZJbbb:;aDEMgr:lJbbb9p9DTmbar:Ohixekcjjjj94hikadai87ebdndnaqalNJbbbZJbbb:;aqJbbbb9GEMgq:lJbbb9p9DTmbaq:Ohdxekcjjjj94hdkavad87ebdndnawalNJbbbZJbbb:;awJbbbb9GEMgw:lJbbb9p9DTmbaw:Ohdxekcjjjj94hdkabad87ebabcwfhbaecufgembkkk;siliui99iue99dnaeTmbcbhiabhlindndnJ;Zl81Zalcof8UebgvciV:Y:vgoal8Ueb:YNgrJb;:FSNJbbbZJbbb:;arJbbbb9GEMgw:lJbbb9p9DTmbaw:OhDxekcjjjj94hDkalclf8Uebhqalcdf8UebhkabavcefciGaiVcetfaD87ebdndnaoak:YNgwJb;:FSNJbbbZJbbb:;awJbbbb9GEMgx:lJbbb9p9DTmbax:Ohkxekcjjjj94hkkabavcdfciGaiVcetfak87ebdndnaoaq:YNgoJb;:FSNJbbbZJbbb:;aoJbbbb9GEMgx:lJbbb9p9DTmbax:Ohqxekcjjjj94hqkabavcufciGaiVcetfaq87ebdndnJbbjZararN:tawawN:taoaoN:tgrJbbbbarJbbbb9GE:rJb;:FSNJbbbZMgr:lJbbb9p9DTmbar:Ohqxekcjjjj94hqkabavciGaiVcetfaq87ebalcwfhlaiclfhiaecufgembkkk9mbdnadcd4ae2geTmbinababydbgdcwtcw91:Yadce91cjjj;8ifcjjj98G::NUdbabclfhbaecufgembkkk9teiucbcbydj1jjbgeabcifc98GfgbBdj1jjbdndnabZbcztgd9nmbcuhiabad9RcFFifcz4nbcuSmekaehikaik;LeeeudndnaeabVciGTmbabhixekdndnadcz9pmbabhixekabhiinaiaeydbBdbaiclfaeclfydbBdbaicwfaecwfydbBdbaicxfaecxfydbBdbaiczfhiaeczfheadc9Wfgdcs0mbkkadcl6mbinaiaeydbBdbaeclfheaiclfhiadc98fgdci0mbkkdnadTmbinaiaeRbb86bbaicefhiaecefheadcufgdmbkkabk;aeedudndnabciGTmbabhixekaecFeGc:b:c:ew2hldndnadcz9pmbabhixekabhiinaialBdbaicxfalBdbaicwfalBdbaiclfalBdbaiczfhiadc9Wfgdcs0mbkkadcl6mbinaialBdbaiclfhiadc98fgdci0mbkkdnadTmbinaiae86bbaicefhiadcufgdmbkkabkkkebcjwklz9Kbb",i=WebAssembly.instantiate(r(n),{}).then(function(t){(s=t.instance).exports.__wasm_call_ctors()});function r(t){for(var s=new Uint8Array(t.length),n=0;n<t.length;++n){var i=t.charCodeAt(n);s[n]=i>96?i-97:i>64?i-39:i+4}var r=0;for(n=0;n<t.length;++n)s[r++]=s[n]<60?e[s[n]]:64*(s[n]-60)+s[++n];return s.buffer.slice(0,r)}function a(t,e,n,i,r,a){var o=s.exports.sbrk,l=n+3&-4,h=o(l*i),c=o(r.length),d=new Uint8Array(s.exports.memory.buffer);d.set(r,c);var u=t(h,n,i,c,r.length);if(0==u&&a&&a(h,l,i),e.set(d.subarray(h,h+n*i)),o(h-o(0)),0!=u)throw new Error("Malformed buffer data: "+u)}var o={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},l={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"},h=[],c=0;function d(t){var e={object:new Worker(t),pending:0,requests:{}};return e.object.onmessage=function(t){var s=t.data;e.pending-=s.count,e.requests[s.id][s.action](s.value),delete e.requests[s.id]},e}function u(t){for(var e="var instance; var ready = WebAssembly.instantiate(new Uint8Array(["+new Uint8Array(r(n))+"]), {}).then(function(result) { instance = result.instance; instance.exports.__wasm_call_ctors(); });self.onmessage = workerProcess;"+a.toString()+f.toString(),s=new Blob([e],{type:"text/javascript"}),i=URL.createObjectURL(s),o=0;o<t;++o)h[o]=d(i);URL.revokeObjectURL(i)}function f(t){i.then(function(){var e=t.data;try{var n=new Uint8Array(e.count*e.size);a(s.exports[e.mode],n,e.count,e.size,e.source,s.exports[e.filter]),self.postMessage({id:e.id,count:e.count,action:"resolve",value:n},[n.buffer])}catch(t){self.postMessage({id:e.id,count:e.count,action:"reject",value:t})}})}return{ready:i,supported:!0,useWorkers:function(t){u(t)},decodeVertexBuffer:function(t,e,n,i,r){a(s.exports.meshopt_decodeVertexBuffer,t,e,n,i,s.exports[o[r]])},decodeIndexBuffer:function(t,e,n,i){a(s.exports.meshopt_decodeIndexBuffer,t,e,n,i)},decodeIndexSequence:function(t,e,n,i){a(s.exports.meshopt_decodeIndexSequence,t,e,n,i)},decodeGltfBuffer:function(t,e,n,i,r,h){a(s.exports[l[r]],t,e,n,i,s.exports[o[h]])},decodeGltfBufferAsync:function(t,e,n,r,d){return h.length>0?function(t,e,s,n,i){for(var r=h[0],a=1;a<h.length;++a)h[a].pending<r.pending&&(r=h[a]);return new Promise(function(a,o){var l=new Uint8Array(s),h=c++;r.pending+=t,r.requests[h]={resolve:a,reject:o},r.object.postMessage({id:h,count:t,size:e,source:l,mode:n,filter:i},[l.buffer])})}(t,e,n,l[r],o[d]):i.then(function(){var i=new Uint8Array(t*e);return a(s.exports[l[r]],i,t,e,n,s.exports[o[d]]),i})}}}();const hE=["gltf","glb","vox"],cE=new Ss(new rs(0,1,0),new rs(1,1,1)),dE=new rs,uE=new Ss;class fE{canvas;app;skyboxUrls;controlEventKeys=null;pngExporter=null;prevCameraMat;camera;initialCameraPosition;initialCameraFocus;light;sceneRoot;debugRoot;entities;entityAssets;assets;meshInstances;wireframeMeshInstances;wireframeMaterial;animTracks;animationMap;firstFrame;skyboxLoaded;animSpeed;animTransition;animLoops;showWireframe;showBounds;showSkeleton;showAxes;showGrid;normalLength;dirtyWireframe;dirtyBounds;dirtySkeleton;dirtyGrid;dirtyNormals;sceneBounds;dynamicSceneBounds;debugBounds;debugSkeleton;debugGrid;debugNormals;miniStats;observer;suppressAnimationProgressUpdate;selectedNode;multiframe;multiframeBusy=!1;picker=null;cursorWorld=new rs;loadTimestamp=null;shadowCatcher=null;xrMode;canvasResize=!0;cameraControls;constructor(t,e,s,n){this.canvas=t;const i=new bC(t,{mouse:new il(t),touch:new ol(t),keyboard:new el(window),graphicsDevice:e});this.app=i,this.skyboxUrls=n,Fh.get(this.app.graphicsDevice,"glsl").set("pickPS","\nvec4 packFloat(float depth) {\n    uvec4 u = (uvec4(floatBitsToUint(depth)) >> uvec4(0u, 8u, 16u, 24u)) & 0xffu;\n    return vec4(u) / 255.0;\n}\nvec4 getPickOutput() {\n    return packFloat(gl_FragCoord.z);\n}\n"),Fh.get(this.app.graphicsDevice,"wgsl").set("pickPS","\n    fn packFloat(depth: f32) -> vec4f {\n        let u: vec4<u32> = (vec4<u32>(bitcast<u32>(depth)) >> vec4<u32>(0u, 8u, 16u, 24u)) & vec4<u32>(0xffu);\n        return vec4f(u) / 255.0;\n    }\n\n    fn getPickOutput() -> vec4f {\n        return packFloat(pcPosition.z);\n    }\n"),this.app.scene.clusteredLightingEnabled=!1;const r=i.mouse._moveHandler;i.mouse.detach(),i.mouse._moveHandler=e=>{e.target===t&&r(e)},i.mouse.attach(t);const a=i.touch._moveHandler;i.touch.detach(),i.touch._moveHandler=e=>{e.target===t&&a(e)},i.touch.attach(t);const o=i.graphicsDevice.maxSamples>1;s.set("camera.multisampleSupported",o),s.set("camera.multisample",o&&s.get("camera.multisample")),NC(document.getElementById("app"),(t,e)=>{this.loadFiles(t,e)}),new ResizeObserver(()=>{this.xrMode&&!this.xrMode.active&&(this.canvasResize=!0,this.renderNextFrame())}).observe(window.document.getElementById("canvas-wrapper"));const l=i.scene.layers.getLayerById(1);i.scene.layers.remove(l),i.scene.layers.insertOpaque(l,2);const h=new Jm("Camera");h.setPosition(0,1,10),this.app.root.addChild(h),h.addComponent("camera",{fov:75,frustumCulling:!0,clearColor:new Ze(0,0,0,0)}),this.cameraControls=new CameraControls(i,h.camera,s),this.cameraControls.zoomRange=new os(.01,1/0),h.camera.requestSceneColorMap(!0),i.keyboard.on("keydown",t=>{switch(t.key){case 70:this.focus(!1);break;case 82:this.cameraControls.reset(rs.ZERO,new rs(2,2,2))}});const c=new Jm;c.addComponent("light",{type:"directional",shadowBias:.2,shadowResolution:2048}),i.root.addChild(c),i.autoRender=!1,this.prevCameraMat=new ps,i.on("update",this.update,this),i.on("framerender",this.onFrameRender,this),i.on("prerender",this.onPrerender,this),i.on("postrender",this.onPostrender,this),i.on("frameend",this.onFrameend,this);const d=new Jm("sceneRoot",i);i.root.addChild(d);const u=new Jm("debugRoot",i);i.root.addChild(u),this.camera=h,this.initialCameraPosition=null,this.initialCameraFocus=null,this.light=c,this.sceneRoot=d,this.debugRoot=u,this.entities=[],this.entityAssets=[],this.assets=[],this.meshInstances=[],this.wireframeMeshInstances=[];const f=new hp;f.blendState=new Ti(!0,0,1,0,0,0,1),f.useLighting=!1,f.useSkybox=!1,f.ambient=new Ze(0,0,0),f.diffuse=new Ze(0,0,0),f.specular=new Ze(0,0,0),f.emissive=new Ze(1,1,1),f.update(),this.wireframeMaterial=f,this.animTracks=[],this.animationMap={},this.firstFrame=!1,this.skyboxLoaded=!1,this.animSpeed=s.get("animation.speed"),this.animTransition=s.get("animation.transition"),this.animLoops=s.get("animation.loops"),this.showWireframe=s.get("debug.wireframe"),this.showBounds=s.get("debug.bounds"),this.showSkeleton=s.get("debug.skeleton"),this.showAxes=s.get("debug.axes"),this.normalLength=s.get("debug.normals"),this.setTonemapping(s.get("camera.tonemapping")),this.setBackgroundColor(s.get("skybox.backgroundColor")),this.setLightColor(s.get("light.color")),this.setWireframeColor(s.get("debug.wireframeColor")),this.dirtyWireframe=!1,this.dirtyBounds=!1,this.dirtySkeleton=!1,this.dirtyGrid=!1,this.dirtyNormals=!1,this.sceneBounds=new Ss,this.dynamicSceneBounds=new Ss,this.debugBounds=new OC(i,h),this.debugSkeleton=new OC(i,h),this.debugGrid=new OC(i,h,!1),this.debugNormals=new OC(i,h,!1),this.miniStats=new bx(i),this.miniStats.enabled=s.get("debug.stats"),this.observer=s;const p=this.app.graphicsDevice;p.on("devicerestored",()=>{this.renderNextFrame()}),this.multiframe=new WC(p,this.camera.camera),this.shadowCatcher=new QC(i,this.camera.camera,this.debugRoot,this.sceneRoot),this.initXrMode(),this.bindControlEvents(),this.reloadSettings(),this.picker=new KC(i,h),this.cursorWorld=new rs,t.addEventListener("dblclick",async t=>{const e=await this.picker.pick(t.offsetX,t.offsetY);e&&this.cameraControls.reset(e,this.camera.getPosition())}),this.app.scene.layers.getLayerByName("World").transparentSortMode=3,i.start()}initXrMode(){const t=this.app.xr;this.xrMode=new oE({xr:t,camera:this.camera,content:this.sceneRoot,showUI:!0,startArImgSrc:JC.src,stopArImgSrc:ZC.src});const e=this.xrMode.events;e.on("xr:started",()=>{this.setShadowCatcherEnabled(!0),this.setShadowCatcherIntensity(.4),this.setDebugGrid(!1),this.setDebugBounds(!1),this.setLightEnabled(!0),this.setLightShadow(!0),this.setLightFollow(!1),this.setCenterScene(!0),this.setSkyboxBackground("None"),this.setSkyboxExposure(0),this.setBackgroundColor(Ze.BLACK),this.app.scene.layers.getLayerById(2).enabled=!1,this.multiframe.blend=.5}),e.on("xr:initial-place",()=>{this.multiframe.blend=1}),e.on("xr:ended",()=>{this.reloadSettings(),this.setBackgroundColor(this.observer.get("skybox.backgroundColor")),this.multiframe.blend=1})}getSelectedMeshInstances(){return this.selectedNode?this.collectMeshInstances(this.selectedNode):this.meshInstances}collectMeshInstances(t){const e=[];if(t){const s=t.findComponents("render");for(let t=0;t<s.length;t++){const n=s[t];if(n.meshInstances)for(let t=0;t<n.meshInstances.length;t++){const s=n.meshInstances[t];e.push(s)}}const n=t.findComponents("gsplat");for(let t=0;t<n.length;t++){const s=n[t];s.instance&&e.push(s.instance.meshInstance)}}return e}static calcMeshBoundingBox(t,e){if(e.length>0){t.copy(e[0].aabb);for(let s=1;s<e.length;++s)t.add(e[s].aabb)}}static calcHierBoundingBox(t,e){const s=e.getPosition();let n=s.x,i=s.y,r=s.z,a=s.x,o=s.y,l=s.z;const h=t=>{const e=t.getPosition();n=Math.min(n,e.x),i=Math.min(i,e.y),r=Math.min(r,e.z),a=Math.max(a,e.x),o=Math.max(o,e.y),l=Math.max(l,e.z);for(let e=0;e<t.children.length;++e)h(t.children[e])};h(e),t.setMinMax(new rs(n,i,r),new rs(a,o,l))}bindControlEvents(){const t={"camera.fov":this.setFov.bind(this),"camera.tonemapping":this.setTonemapping.bind(this),"camera.pixelScale":()=>{this.canvasResize=!0,this.renderNextFrame()},"camera.multisample":()=>{this.destroyRenderTargets(),this.renderNextFrame()},"camera.hq":t=>{this.multiframe.enabled=t,this.renderNextFrame()},"camera.mode":t=>{this.cameraControls.mode=t},"skybox.value":t=>{if(this.skyboxUrls.has(t)){const e=this.skyboxUrls.get(t);this.loadFiles([{url:e,filename:e}])}else"None"===t?this.clearSkybox():this.loadFiles([{url:t,filename:t}])},"skybox.blur":this.setSkyboxBlur.bind(this),"skybox.exposure":this.setSkyboxExposure.bind(this),"skybox.rotation":this.setSkyboxRotation.bind(this),"skybox.background":this.setSkyboxBackground.bind(this),"skybox.backgroundColor":this.setBackgroundColor.bind(this),"skybox.domeProjection.domeRadius":this.setSkyboxDomeRadius.bind(this),"skybox.domeProjection.tripodOffset":this.setSkyboxTripodOffset.bind(this),"light.enabled":this.setLightEnabled.bind(this),"light.intensity":this.setLightIntensity.bind(this),"light.color":this.setLightColor.bind(this),"light.follow":this.setLightFollow.bind(this),"light.shadow":this.setLightShadow.bind(this),"shadowCatcher.enabled":this.setShadowCatcherEnabled.bind(this),"shadowCatcher.intensity":this.setShadowCatcherIntensity.bind(this),"debug.stats":this.setDebugStats.bind(this),"debug.wireframe":this.setDebugWireframe.bind(this),"debug.wireframeColor":this.setWireframeColor.bind(this),"debug.bounds":this.setDebugBounds.bind(this),"debug.skeleton":this.setDebugSkeleton.bind(this),"debug.axes":this.setDebugAxes.bind(this),"debug.grid":this.setDebugGrid.bind(this),"debug.normals":this.setNormalLength.bind(this),"debug.renderMode":this.setRenderMode.bind(this),"animation.playing":t=>{t?this.play():this.stop()},"animation.selectedTrack":this.setSelectedTrack.bind(this),"animation.speed":this.setSpeed.bind(this),"animation.transition":this.setTransition.bind(this),"animation.loops":this.setLoops.bind(this),"animation.progress":this.setAnimationProgress.bind(this),"scene.selectedNode.path":this.setSelectedNode.bind(this),"scene.variant.selected":this.setSelectedVariant.bind(this),centerScene:this.setCenterScene.bind(this)};this.controlEventKeys=Object.keys(t),this.controlEventKeys.forEach(e=>{this.observer.on(`${e}:set`,t[e])})}reloadSettings(){this.controlEventKeys.forEach(t=>{this.observer.set(t,this.observer.get(t),!1,!1,!0)})}clearSkybox(){this.app.scene.envAtlas=null,this.app.scene.setSkybox(null),this.renderNextFrame(),this.skyboxLoaded=!1}initSkybox(t){const e=zf.generateSkyboxCubemap(t),s=zf.generateLightingSource(t),n=zf.generateAtlas(s,{});s.destroy(),this.app.scene.envAtlas=n,this.app.scene.skybox=e,this.renderNextFrame()}loadSkybox(t){const e=this.app;if(6!==t.length){const s=new Fm("skybox_equi","texture",{url:t[0].url,filename:t[0].filename});s.ready(()=>{const t=s.resource;t.type===yn&&7===t.format&&(t.type=bn),this.initSkybox(t),s.unload(),e.assets.remove(s)}),e.assets.add(s),e.assets.load(s)}else{const s=[["posx","negx","posy","negy","posz","negz"],["px","nx","py","ny","pz","nz"],["right","left","up","down","front","back"],["right","left","top","bottom","forward","backward"],["0","1","2","3","4","5"]],n=t=>{const e=t.toLowerCase();for(let t=0;t<s.length;++t){const n=s[t];for(let t=0;t<n.length;++t)if(-1!==e.indexOf(`${n[t]}.`))return t}return 0},i=(t,e)=>{const s=n(t.filename),i=n(e.filename);return s<i?-1:i<s?1:0};t.sort(i);const r=t.map((t,s)=>{const n=new Fm(`skybox_face${s}`,"texture",t);return e.assets.add(n),e.assets.load(n),n}),a=new Fm("skybox_cubemap","cubemap",null,{textures:r.map(t=>t.id)});a.loadFaces=!0,a.on("load",()=>{this.initSkybox(a.resource)}),e.assets.add(a),e.assets.load(a)}this.skyboxLoaded=!0}getCanvasSize(){const t=this.canvas.getBoundingClientRect();return{width:t.width,height:t.height}}calcFocalPoint(t){const e=new rs;if(this.initialCameraFocus)e.copy(this.initialCameraFocus),this.initialCameraFocus=null;else{const s=this.entityAssets[0],n=s?.asset?.resource?.gsplatData;n?(n.calcFocalPoint(e,()=>!0),s.entity.getWorldTransform().transformPoint(e,e)):e.copy(t.center)}return e}calcZoom(t){const e=this.camera.camera;return Math.tan(37.5*Qe.DEG_TO_RAD)/Math.tan(.5*e.fov*Qe.DEG_TO_RAD)*(1/e.aspectRatio)*t+t}focus(t){this.calcSceneBounds(uE,this.selectedNode);const e=uE.halfExtents.length();this.cameraControls.moveSpeed=2.5*e,this.cameraControls.zoomRange=new os(.01,10*e);const s=this.calcFocalPoint(uE),n=this.calcZoom(e);if(this.initialCameraPosition){const t=this.initialCameraPosition.clone();return this.initialCameraPosition=null,void this.cameraControls.reset(s,t)}const i=(t?rs.FORWARD:this.camera.forward).clone().mulScalar(-n).add(s);this.cameraControls.reset(s,i)}destroyRenderTargets(){const t=this.camera.camera.renderTarget;t&&(t.colorBuffer?.destroy(),t.depthBuffer?.destroy(),t.destroy(),this.camera.camera.renderTarget=null)}rebuildRenderTargets(){const t=this.app.graphicsDevice,e=t.width,s=t.height,n=this.camera.camera.renderTarget;if(n&&n.width===e&&n.height===s)return;this.destroyRenderTargets();const i=(e,s,n)=>new pi(t,{name:"viewer-rt-texture",width:e,height:s,format:n,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1}),r=t.maxSamples,a=i(e,s,7),o=i(e,s,Ms),l=new ji({name:"viewer-rt",colorBuffer:a,depthBuffer:o,flipY:!1,samples:this.observer.get("camera.multisample")?r:1,autoResolve:!1});this.camera.camera.renderTarget=l}resetScene(){const t=this.app;this.entities.forEach(t=>{this.sceneRoot.removeChild(t),this.shadowCatcher.onEntityRemoved(t),t.destroy()}),this.entities=[],this.assets.forEach(e=>{t.assets.remove(e),e.unload()}),this.assets=[],this.meshInstances=[],this.resetWireframeMeshes(),this.animTracks=[],this.animationMap={}}updateSceneStats(){let t=0,e=0,s=0,n=0,i=0,r=0,a=0,o=[];this.assets.forEach(l=>{if("gsplat"===l.type){const e=l.resource;e instanceof qp&&(t++,i++,n+=e.gsplatData.numSplats,s+=4*e.gsplatData.numSplats)}else{const h=l.resource;o=o.concat(h.getMaterialVariants()??[]),h.renders.forEach(i=>{const r=i.resource;t+=r.meshes.length,r.meshes.forEach(t=>{s+=t.vertexBuffer.getNumVertices();const i=t.primitive[0];switch(i.type){case 0:case 2:n+=i.count;break;case 1:n+=i.count/2;break;case 3:n+=i.count-1;break;case 4:n+=i.count/3;break;case 5:case 6:n+=i.count-2}e+=t.vertexBuffer.numBytes+(t.indexBuffer?.[0]?.numBytes??0)})}),i+=h.materials.length??0,r+=h.textures.length??0,(h.textures??[]).forEach(t=>{a+=t.resource.gpuSize})}});const l=function(t){return t.children.map(t=>({name:t.name,path:t.path,children:l(t)}))},h=this.entities.map(t=>({name:t.name,path:t.path,children:l(t)}));this.observer.set("scene.nodes",JSON.stringify(h)),this.observer.set("scene.meshCount",t),this.observer.set("scene.materialCount",i),this.observer.set("scene.textureCount",r),this.observer.set("scene.vertexCount",s),this.observer.set("scene.primitiveCount",n),this.observer.set("scene.textureVRAM",a),this.observer.set("scene.meshVRAM",e),this.observer.set("scene.variants.list",JSON.stringify(o)),this.observer.set("scene.variant.selected",o[0])}downloadPngScreenshot(){this.pngExporter||(this.pngExporter=new YC);const t=this.observer.get("scene.filenames");let e="model-viewer";if(t&&t.length>0){const s=t[0].replace(/\.[^/.]+$/,"");s&&(e=s)}this.renderNextFrame(),this.app.once("postrender",()=>{const t=this.camera.camera.renderTarget.colorBuffer;t.read(0,0,t.width,t.height).then(s=>{this.pngExporter.export(`${e}.png`,new Uint32Array(s.buffer.slice(0)),t.width,t.height)}).catch(t=>{console.error("Failed to capture PNG screenshot from render target:",t)})})}fitCameraClipPlanes(){if(this.xrMode?.active)return;const t=this.camera.getWorldTransform(),e=t.getTranslation(),s=t.getZ(),n=this.dynamicSceneBounds,i=n.center,r=2*n.halfExtents.length();dE.sub2(i,e);const a=-dE.dot(s),o=a+r,l=Math.max(.001,a<r?o/1024:a-r);this.camera.camera.nearClip=l,this.camera.camera.farClip=o,this.light.light.shadowDistance=o,this.light.light.normalOffsetBias=o/1024}loadGltf(t,e){return new Promise((s,n)=>{const i=new Fm(t.filename,"container",t,null,{bufferView:{processAsync:(t,e,s)=>{if(t.extensions&&t.extensions.EXT_meshopt_compression){const n=t.extensions.EXT_meshopt_compression;Promise.all([lE.ready,e[n.buffer]]).then(t=>{const e=t[1],i=n.byteOffset||0,r=n.byteLength||0,a=n.count,o=n.byteStride,l=new Uint8Array(a*o),h=new Uint8Array(e.buffer,e.byteOffset+i,r);lE.decodeGltfBuffer(l,a,o,h,n.mode,n.filter),s(null,l)})}else s(null,null)}},image:{processAsync:(t,s)=>{const n=e.find(e=>e.filename===decodeURIComponent(Me.normalize(t.uri||"")));if(n){const t=new Fm(n.filename,"texture",{url:n.url,filename:n.filename});t.on("load",()=>{s(null,t)}),this.app.assets.add(t),this.app.assets.load(t)}else s(null,null)}},texture:{postprocess:(t,e)=>{const s=e.resource;0!==s.minFilter&&0!==s.magFilter&&(s.anisotropy=this.app.graphicsDevice.maxAnisotropy)}},buffer:{processAsync:(t,s)=>{const n=e.find(e=>e.filename===decodeURIComponent(Me.normalize(t.uri||"")));if(n){const t=new Fm(n.filename,"binary",{url:n.url,filename:n.filename});t.on("load",()=>{s(null,new Uint8Array(t.resource))}),this.app.assets.add(t),this.app.assets.load(t)}else s(null,null)}}});i.on("load",()=>s(i)),i.on("error",t=>n(t)),this.app.assets.add(i),this.app.assets.load(i)})}loadPly(t,e){const s={};return e.forEach(t=>{s[t.filename]=t.url}),new Promise((e,n)=>{const i=new Fm(t.filename,"gsplat",t,null,{mapUrl:t=>s[t]});i.on("load",()=>e(i)),i.on("error",t=>n(t)),this.app.assets.add(i),this.app.assets.load(i)})}isModelFilename(t){const e=t.split("?")[0].split("/").pop().split(".");return 1===e.length||hE.includes(e.pop().toLowerCase())}isGSplatFilename(t){const e=t.split("?")[0].split("/").pop().split(".");return e.length>0&&["ply","json","sog"].includes(e.pop().toLowerCase())}loadFiles(t,e=!1){Array.isArray(t)||(t=[t]);const s=t.reduce((t,e)=>t||this.isModelFilename(e.filename)||this.isGSplatFilename(e.filename),!1);if(s){e&&this.resetScene();const s=Date.now();this.observer.set("ui.spinner",!0),this.observer.set("ui.error",null),this.clearCta();const n=t.map(e=>this.isModelFilename(e.filename)?this.loadGltf(e,t):this.isGSplatFilename(e.filename)?this.loadPly(e,t):null);Promise.all(n).then(n=>{this.loadTimestamp=s,n.forEach(t=>{t&&this.addToScene(t)}),this.postSceneLoad();const i=t.map(t=>t.url),r=t.map(t=>t.filename.split("/").pop());e?(this.observer.set("scene.urls",i),this.observer.set("scene.filenames",r)):(this.observer.set("scene.urls",this.observer.get("scene.urls").concat(i)),this.observer.set("scene.filenames",this.observer.get("scene.filenames").concat(r)))}).catch(t=>{console.log(t),this.observer.set("ui.error",t?.toString()||t)}).finally(()=>{this.observer.set("ui.spinner",!1)})}else this.loadSkybox(t);return s}setSelectedTrack(t){if("ALL_TRACKS"!==t){const e=this.animationMap[t];this.entities.forEach(t=>{t.anim?.baseLayer?.transition(e)})}}play(){this.entities.forEach(t=>{t.anim&&(t.anim.playing=!0,t.anim.baseLayer?.play())})}stop(){this.entities.forEach(t=>{t.anim&&(t.anim.playing=!1,t.anim.baseLayer?.pause())})}setSpeed(t){this.animSpeed=t,this.entities.forEach(e=>{const s=e.anim;s&&(s.speed=t)})}setTransition(t){this.animTransition=t,this.animTracks.length>0&&this.rebuildAnimTracks()}setLoops(t){this.animLoops=t,this.animTracks.length>0&&this.rebuildAnimTracks()}setAnimationProgress(t){this.suppressAnimationProgressUpdate||(this.entities.forEach(e=>{const s=e.anim,n=s?.baseLayer;n&&(this.play(),n.activeStateCurrentTime=n.activeStateDuration*t,s.update(0),s.playing=!1)}),this.renderNextFrame())}setSelectedNode(t){const e=this.app.root.findByPath(t);e&&this.observer.set("scene.selectedNode",{name:e.name,path:t,position:e.getLocalPosition().toString(),rotation:e.getLocalEulerAngles().toString(),scale:e.getLocalScale().toString()}),this.selectedNode=e,this.dirtyWireframe=!0,this.dirtyBounds=!0,this.dirtySkeleton=!0,this.renderNextFrame()}setSelectedVariant(t){t&&(this.entityAssets.forEach(e=>{const s=e.asset.resource;-1!==s.getMaterialVariants().indexOf(t)&&s.applyMaterialVariant(e.entity,t)}),this.renderNextFrame())}setCenterScene(t){this.sceneRoot.setLocalPosition(0,0,0),this.calcSceneBounds(this.sceneBounds),t&&this.sceneRoot.setLocalPosition(-this.sceneBounds.center.x,-this.sceneBounds.getMin().y,-this.sceneBounds.center.z),this.dirtyBounds=!0,this.renderNextFrame()}setDebugStats(t){this.miniStats.enabled=t,this.renderNextFrame()}setDebugWireframe(t){this.showWireframe=t,this.dirtyWireframe=!0,this.renderNextFrame()}setWireframeColor(t){this.wireframeMaterial.emissive=new Ze(t.r,t.g,t.b),this.wireframeMaterial.update(),this.renderNextFrame()}setDebugBounds(t){this.showBounds=t,this.dirtyBounds=!0,this.renderNextFrame()}setDebugSkeleton(t){this.showSkeleton=t,this.dirtySkeleton=!0,this.renderNextFrame()}setDebugAxes(t){this.showAxes=t,this.dirtySkeleton=!0,this.renderNextFrame()}setDebugGrid(t){this.showGrid=t,this.dirtyGrid=!0,this.renderNextFrame()}setNormalLength(t){this.normalLength=t,this.dirtyNormals=!0,this.renderNextFrame()}setFov(t){this.camera.camera.fov=t,this.renderNextFrame()}setRenderMode(t){this.camera.camera.setShaderPass("default"!==t?`debug_${t}`:"forward"),this.renderNextFrame()}setLightEnabled(t){this.light.enabled=t,this.renderNextFrame()}setLightIntensity(t){this.light.light.intensity=t,this.renderNextFrame()}setLightColor(t){this.light.light.color=new Ze(t.r,t.g,t.b),this.renderNextFrame()}setLightFollow(t){this.light.reparent(t?this.camera:this.app.root),t?this.light.setLocalEulerAngles(90,0,0):this.light.setLocalEulerAngles(45,30,0),this.renderNextFrame()}setLightShadow(t){this.light.light.castShadows=t,this.renderNextFrame()}setShadowCatcherEnabled(t){this.shadowCatcher.enabled=t,this.renderNextFrame()}setShadowCatcherIntensity(t){this.shadowCatcher.intensity=t,this.renderNextFrame()}setSkyboxExposure(t){this.app.scene.skyboxIntensity=Math.pow(2,t),this.renderNextFrame()}setSkyboxRotation(t){const e=new ms;e.setFromEulerAngles(0,t,0),this.app.scene.skyboxRotation=e,this.renderNextFrame()}setSkyboxBackground(t){const{scene:e}=this.app;switch(this.app.scene.layers.getLayerById(2).enabled="Solid Color"!==t,t){case"Solid Color":break;case"Infinite Sphere":e.sky.type=gh;break;case"Projective Dome":e.sky.type=_h;break;case"Projective Box":e.sky.type="box"}this.app.scene.skyboxMip="Infinite Sphere"===t?this.observer.get("skybox.blur"):0,this.renderNextFrame()}setSkyboxBlur(t){this.app.scene.skyboxMip="Infinite Sphere"===this.observer.get("skybox.background")?t:0,this.renderNextFrame()}setSkyboxDomeRadius(t){const e=(this.sceneBounds?.halfExtents.length()??1)*t;this.app.scene.sky.node.setLocalScale(e,e,e),this.renderNextFrame()}setSkyboxTripodOffset(t){this.app.scene.sky.center=new rs(0,t,0),this.renderNextFrame()}setTonemapping(t){const e={None:6,Linear:0,Neutral:5,Filmic:1,Hejl:2,ACES:3,ACES2:4};this.camera.camera.toneMapping=e.hasOwnProperty(t)?e[t]:3,this.renderNextFrame()}setBackgroundColor(t){const e=t=>Math.max(0,Math.min(255,Math.floor(255*t)));document.getElementById("canvas-wrapper").style.backgroundColor=`rgb(${e(t.r)}, ${e(t.g)}, ${e(t.b)})`}update(t){this.xrMode?.active||this.cameraControls.update(t);const e=this.camera.getWorldTransform();((t,e)=>{let s=0;for(let n=0;n<16;++n)s=Math.max(s,Math.abs(t.data[n]-e.data[n]));return s})(e,this.prevCameraMat)>1e-4&&(this.prevCameraMat.copy(e),this.renderNextFrame()),this.xrMode?.active&&this.renderNextFrame();let s=!1;for(let t=0;t<this.entities.length;++t){const e=this.entities[t].anim;if(e&&e.baseLayer&&e.baseLayer.playing){s=!0;break}}s&&(this.dirtyBounds=!0,this.dirtySkeleton=!0,this.dirtyNormals=!0,this.renderNextFrame(),this.observer.emit("animationUpdate")),this.miniStats.enabled&&this.renderNextFrame()}renderNextFrame(){this.app.renderNextFrame=!0,this.multiframe&&this.multiframe.moved()}clearCta(){document.querySelector("#panel-left").classList.add("no-cta"),document.querySelector("#application-canvas").classList.add("no-cta"),document.querySelector(".load-button-panel").classList.add("hide")}addToScene(t){const e=t.resource,s=e.renders&&e.renders.length>0,n=e.animations&&e.animations.length>0,i=0===this.entities.length?null:this.entities[this.entities.length-1];let r;if(!s&&i&&i.findComponent("render"))r=i;else{if("container"===t.type)r=e.instantiateRenderEntity();else{const e=(t.file?.filename??"").endsWith("lod-meta.json");r=new Jm,r.setEulerAngles(0,0,180),r.addComponent("gsplat",{unified:e,asset:t}),e||r.gsplat.instance.sorter.on("updated",()=>{this.renderNextFrame()})}this.entities.push(r),this.entityAssets.push({entity:r,asset:t}),this.sceneRoot.addChild(r),this.shadowCatcher.onEntityAdded(r)}n&&e.animations.forEach(t=>{this.animTracks.push(t.resource)}),this.assets.push(t)}postSceneLoad(){this.meshInstances=this.entities.map(t=>this.collectMeshInstances(t)).flat(),0===this.meshInstances.length&&this.observer.set("debug.skeleton",!0),this.updateSceneStats(),this.animTracks.length>0&&this.rebuildAnimTracks();const t={},e={};this.meshInstances.forEach((s,n)=>{if(s.morphInstance){const i=s.morphInstance;e[n]=i;const r=s&&s.node&&s.node.name||`Mesh ${n}`;t[n]={name:r,targets:{}},i.morph.targets.forEach((s,i)=>{t[n].targets[i]={name:s.name,targetIndex:i},this.observer.on(`morphs.${n}.targets.${i}.weight:set`,t=>{e[n].setWeight(i,t),this.dirtyNormals=!0,this.renderNextFrame()})})}}),this.observer.suspendEvents=!0,this.observer.set("morphs",t),this.observer.suspendEvents=!1;const s=this.observer;s.on("animationUpdate",()=>{for(let t=0;t<this.entities.length;++t){const e=this.entities[t];if(e&&e.anim){const t=e.anim.baseLayer,n=t.activeStateCurrentTime/t.activeStateDuration;this.suppressAnimationProgressUpdate=!0,s.set("animation.progress",1===n?n:n%1),this.suppressAnimationProgressUpdate=!1;break}}}),this.dirtyWireframe=this.dirtyBounds=this.dirtySkeleton=this.dirtyGrid=this.dirtyNormals=!0,this.renderNextFrame(),this.firstFrame=!0}initSceneBounds(){this.setCenterScene(this.observer.get("centerScene")),this.setSkyboxDomeRadius(this.observer.get("skybox.domeProjection.domeRadius")),this.focus(!0),this.fitCameraClipPlanes()}rebuildAnimTracks(){this.animationMap={};const t=new Map;this.animTracks.forEach(e=>{t.set(e.name,(t.get(e.name)??0)+1)});const e=new Map,s=this.animTracks.map(s=>{const n=s.name;if(t.get(n)>1){const t=e.get(n)??0;return e.set(n,t+1),`${n} (${t+1})`}return n});this.entities.forEach(t=>{t.anim?t.anim.removeStateGraph():(t.addComponent("anim",{activate:!0,speed:this.animSpeed}),t.anim.rootBone=t),this.animTracks.forEach((e,n)=>{e.events=new Vg([{name:"transition",time:e.duration,nextTrack:`track_${n===this.animTracks.length-1?0:n+1}`}]);const i=`track_${n}`;t.anim.assignAnimation(i,e),this.animationMap[s[n]]=i}),t.anim.on("transition",e=>{"ALL_TRACKS"===this.observer.get("animation.selectedTrack")&&t.anim.baseLayer.activeStateProgress>=this.animLoops&&t.anim.baseLayer.transition(e.nextTrack,this.animTransition)})});const n=this.observer.get("animation"),i=Object.keys(this.animationMap);n.list=JSON.stringify(i),n.selectedTrack=i[0],n.playing=!0,this.observer.set("animation",n)}calcSceneBounds(t,e=null){const s=e?[e]:this.entities;let n=!0;const i=s.map(t=>t.findComponents("render")).flat().map(t=>t.meshInstances).flat();if(i.length)for(let e=0;e<i.length;++e)n?(t.copy(i[e].aabb),n=!1):t.add(i[e].aabb);const r=s.map(t=>t.findComponents("gsplat")).flat().filter(t=>!!t.customAabb);if(r.length)for(let e=0;e<r.length;++e)uE.setFromTransformedAabb(r[e].customAabb,r[e].entity.getWorldTransform()),n?(t.copy(uE),n=!1):t.add(uE);n&&t.copy(cE)}resetWireframeMeshes(){this.app.scene.layers.getLayerByName("World").removeMeshInstances(this.wireframeMeshInstances),this.wireframeMeshInstances.forEach(t=>{t.clearShaders()}),this.wireframeMeshInstances=[]}buildWireframeMeshes(){this.wireframeMeshInstances=this.getSelectedMeshInstances().map(t=>{const e=new fc(t.mesh,this.wireframeMaterial,t.node);return e.renderStyle=1,e.skinInstance=t.skinInstance,e.morphInstance=t.morphInstance,e}),this.app.scene.layers.getLayerByName("World").addMeshInstances(this.wireframeMeshInstances)}onFrameRender(){if(this.canvasResize){const{width:t,height:e}=this.getCanvasSize(),s=this.observer.get("camera.pixelScale"),n=Math.floor(t*window.devicePixelRatio/s),i=Math.floor(e*window.devicePixelRatio/s);this.app.graphicsDevice.setResolution(n,i),this.observer.set("runtime.viewportWidth",n),this.observer.set("runtime.viewportHeight",i),this.canvasResize=!1}this.rebuildRenderTargets()}onPrerender(){if(!this.firstFrame){if(this.dirtyWireframe&&(this.dirtyWireframe=!1,this.resetWireframeMeshes(),this.showWireframe&&this.buildWireframeMeshes(),this.getSelectedMeshInstances().forEach(t=>{t.material.depthBias=this.showWireframe?-1:0,t.material.slopeDepthBias=this.showWireframe?1:0})),this.dirtyBounds||this.xrMode?.active){this.dirtyBounds=!1,this.calcSceneBounds(this.dynamicSceneBounds),this.debugBounds.clear(),this.showBounds&&(this.calcSceneBounds(uE,this.selectedNode),this.debugBounds.box(uE.getMin(),uE.getMax())),this.debugBounds.update();const t=new rs(2*this.dynamicSceneBounds.halfExtents.x,2*this.dynamicSceneBounds.halfExtents.y,2*this.dynamicSceneBounds.halfExtents.z);this.observer.set("scene.bounds",t.toString())}if(this.dirtyNormals){if(this.dirtyNormals=!1,this.debugNormals.clear(),this.normalLength>0)for(let t=0;t<this.meshInstances.length;++t){const e=this.meshInstances[t],s=e.morphInstance?e.morphInstance._vertexBuffer:e.mesh.vertexBuffer;if(s){const t=e.skinInstance?e.skinInstance.matrices:null;t&&e.skinInstance.updateMatrices(e.node),this.debugNormals.generateNormals(s,e.node.getWorldTransform(),this.normalLength,t)}}this.debugNormals.update()}if(this.dirtySkeleton&&(this.dirtySkeleton=!1,this.debugSkeleton.clear(),(this.showSkeleton||this.showAxes)&&this.entities.forEach(t=>{(0===this.meshInstances.length||t.findComponent("render"))&&this.debugSkeleton.generateSkeleton(t,this.showSkeleton,this.showAxes,this.selectedNode)}),this.debugSkeleton.update()),this.sceneBounds&&this.dirtyGrid){if(this.dirtyGrid=!1,this.debugGrid.clear(),this.showGrid){const t=Math.pow(10,Math.floor(Math.log10(this.sceneBounds.halfExtents.length()))),e=new rs(0,0,0),s=new rs(0,0,0),n=0,i=10,r=i*t;for(let a=-i;a<i+1;++a){const i=a*t;e.set(-r,n,i),s.set(r,n,i),this.debugGrid.line(e,s,0===i?2147483648:2164260863),e.set(i,n,-r),s.set(i,n,r),this.debugGrid.line(e,s,0===i?2147483648:2164260863)}}this.debugGrid.update()}this.fitCameraClipPlanes(),this.shadowCatcher.onUpdate(this.dynamicSceneBounds)}}onPostrender(){this.firstFrame&&(this.firstFrame=!1,this.initSceneBounds());const t=this.camera.camera.renderTarget;t.samples>1&&t.resolve(),this.multiframeBusy=this.multiframe.update()}onFrameend(){null!==this.loadTimestamp&&(this.observer.set("scene.loadTime",Date.now()-this.loadTimestamp+"ms"),this.loadTimestamp=null),this.multiframeBusy&&(this.app.renderNextFrame=!0)}}class pE{constructor(t){if(t.graphicsDevice.isWebGPU)return void console.log("WebGPU is already created, skipping dummy WebGPU creation");if(!navigator.gpu)return void console.log("WebGPU is not supported, skipping dummy WebGPU creation");const e=document.createElement("canvas");e.width=20,e.height=20,e.style.position="absolute",e.style.top="20px",e.style.left="20px",document.body.appendChild(e),(async()=>{const s=await navigator.gpu.requestAdapter(),n=await s.requestDevice();console.log("Created WebGPU device used for profiling");const i=e.getContext("webgpu");i.configure({device:n,format:"bgra8unorm"}),t.on("frameend",()=>{const t=i.getCurrentTexture().createView(),e=n.createCommandEncoder(),s={colorAttachments:[{view:t,clearValue:{r:1,g:0,b:0,a:1},loadOp:"clear",storeOp:"store"}]};e.beginRenderPass(s).end(),n.queue.submit([e.finish()])})})()}}const mE=[{label:"Abandoned Tank Farm",url:"./skybox/abandoned_tank_farm_01_2k.hdr"},{label:"Adam's Place Bridge",url:"./skybox/adams_place_bridge_2k.hdr"},{label:"Artist Workshop",url:"./skybox/artist_workshop_2k.hdr"},{label:"Ballroom",url:"./skybox/ballroom_2k.hdr"},{label:"Circus Arena",url:"./skybox/circus_arena_2k.hdr"},{label:"Colorful Studio",url:"./skybox/colorful_studio.hdr"},{label:"Golf Course Sunrise",url:"./skybox/golf_course_sunrise_2k.hdr"},{label:"Helipad",url:"./skybox/Helipad_equi.png"},{label:"Kloppenheim",url:"./skybox/kloppenheim_02_2k.hdr"},{label:"Lebombo",url:"./skybox/lebombo_2k.hdr"},{label:"Outdoor Umbrellas",url:"./skybox/outdoor_umbrellas_2k.hdr"},{label:"Paul Lobe Haus",url:"./skybox/paul_lobe_haus_2k.hdr"},{label:"Reinforced Concrete",url:"./skybox/reinforced_concrete_01_2k.hdr"},{label:"Rural Asphalt Road",url:"./skybox/rural_asphalt_road_2k.hdr"},{label:"Spruit Sunrise",url:"./skybox/spruit_sunrise_2k.hdr"},{label:"Studio Small",url:"./skybox/studio_small_03_2k.hdr"},{label:"Venice Sunset",url:"./skybox/venice_sunset_1k.hdr"},{label:"Vignaioli Night",url:"./skybox/vignaioli_night_2k.hdr"},{label:"Wooden Motel",url:"./skybox/wooden_motel_2k.hdr"}],gE={ui:{fullscreen:!1,active:null,spinner:!1,error:null},camera:{fov:40,tonemapping:"Linear",pixelScale:1,multisampleSupported:!0,multisample:!0,hq:!0,mode:"orbit"},skybox:{value:"Paul Lobe Haus",options:JSON.stringify(["None"].concat(mE.map(t=>t.label)).map(t=>({v:t,t:t}))),exposure:0,rotation:0,background:"Infinite Sphere",backgroundColor:{r:.4,g:.45,b:.5},blur:1,domeProjection:{domeRadius:20,tripodOffset:.1}},light:{enabled:!1,color:{r:1,g:1,b:1},intensity:1,follow:!1,shadow:!1},shadowCatcher:{enabled:!1,intensity:.4},debug:{renderMode:"default",stats:!1,wireframe:!1,wireframeColor:{r:0,g:0,b:0},bounds:!1,skeleton:!1,axes:!1,grid:!0,normals:0},animation:{playing:!1,speed:1,transition:.1,loops:1,list:"[]",progress:0,selectedTrack:"ALL_TRACKS"},scene:{urls:[],filenames:[],nodes:"[]",selectedNode:{path:"",name:null,position:{0:0,1:0,2:0},rotation:{0:0,1:0,2:0,3:0},scale:{0:0,1:0,2:0}},meshCount:null,materialCount:null,textureCount:null,vertexCount:null,primitiveCount:null,textureVRAM:null,meshVRAM:null,bounds:null,variant:{selected:0},variants:{list:"[]"},loadTime:null},runtime:{activeDeviceType:"",viewportWidth:0,viewportHeight:0,xrSupported:!1,xrActive:!1},morphs:null,enableWebGPU:!1,centerScene:!1};console.log(`Model Viewer v${JT} | PCUI v5.4.1 (88fadb0) | PlayCanvas Engine v${Pe} (${Le})`);(()=>{const t=new n(gE),e=new URL(window.location.href);sT(),Gb({glueUrl:"static/lib/basis/basis.wasm.js",wasmUrl:"static/lib/basis/basis.wasm.wasm",fallbackUrl:"static/lib/basis/basis.js",lazyInit:!0}),Ge.setConfig("DracoDecoderModule",{glueUrl:"static/lib/draco/draco.wasm.js",wasmUrl:"static/lib/draco/draco.wasm.wasm",fallbackUrl:"static/lib/draco/draco.js"});const s=new Map(mE.map(t=>[t.label,`static/${t.url}`]));t.on("ui.spinner:set",t=>{const e=document.getElementById("spinner");t?e.classList.remove("pcui-hidden"):e.classList.add("pcui-hidden")}),e.searchParams.has("default")||(((t,e,s)=>{const n=["skybox.options","debug.renderMode"],i=(e,r)=>{-1===n.indexOf(e)&&("object"==typeof r?Object.keys(r).forEach(t=>{i(e?`${e}.${t}`:t,r[t])}):("skybox.value"!==e||"None"===r||s.has(r))&&t.set(e,r))},r=window.localStorage.getItem(`model-viewer-${e}`);if(r)try{i("",JSON.parse(r))}catch{}})(t,"uistate",s),t.on("*:set",()=>{((t,e)=>{const s=t.json();window.localStorage.setItem(`model-viewer-${e}`,JSON.stringify({camera:s.camera,skybox:s.skybox,light:s.light,debug:s.debug,shadowCatcher:s.shadowCatcher,enableWebGPU:s.enableWebGPU}))})(t,"uistate")})),(t=>{const e=xT.createRoot(document.getElementById("app"));e.render(u.createElement(yC,{observer:t})),fT.flushSync(()=>{e.render(u.createElement(yC,{observer:t}))})})(t);const i=document.getElementById("application-canvas");(function(t,e={}){const s=e.deviceTypes??[];s.includes(jn)||s.push(jn),s.includes(Xn)||s.push(Xn),ze.browser&&navigator.xr&&(e.xrCompatible??=!0);const n=[];for(let i=0;i<s.length;i++){const r=s[i];r===$n&&window?.navigator?.gpu&&n.push(()=>new no(t,e).initWebGpu(e.glslangUrl,e.twgslUrl)),r===jn&&n.push(()=>new wo(t,e)),r===Xn&&n.push(()=>new Lo(t,e))}return new Promise((t,e)=>{let s=0;const i=()=>{s>=n.length?e(new Error("Failed to create a graphics device")):Promise.resolve(n[s++]()).then(e=>{e?t(e):i()}).catch(t=>{console.log(t),i()})};i()})})(i,{deviceTypes:e.searchParams.has("webgpu")||t.get("enableWebGPU")?["webgpu"]:[],antialias:!1,depth:!1,stencil:!1,xrCompatible:!0,powerPreference:"high-performance"}).then(n=>{t.set("runtime.activeDeviceType",n.deviceType);const r=new fE(i,n,t,s);window.viewer=r;const a=[],o=[];"launchQueue"in window&&window.launchQueue.setConsumer(t=>{for(const e of t.files)o.push(e.getFile().then(t=>{a.push({url:URL.createObjectURL(t),filename:t.name})}))});for(const[s,n]of e.searchParams)switch(s){case"load":case"assetUrl":{const t=decodeURIComponent(n);a.push({url:t,filename:t});break}case"cameraPosition":{const t=n.split(",").map(Number);3===t.length&&(r.initialCameraPosition=new rs(t));break}case"cameraFocus":{const t=n.split(",").map(Number);3===t.length&&(r.initialCameraFocus=new rs(t));break}case"dummyWebGPU":new pE(r.app);break;default:if(t.has(s))switch(typeof t.get(s)){case"boolean":t.set(s,"true"===n.toLowerCase());break;case"number":t.set(s,Number(n));break;default:t.set(s,decodeURIComponent(n))}}Promise.all(o).then(()=>{a.length>0&&r.loadFiles(a)})})})();
//# sourceMappingURL=index.js.map
